cscope 15 $HOME/gem5/gem5/src/mem               0001100698
	@abstract_mem.cc

45 
	~<veùÜ
>

47 
	~"ıu/ba£.hh
"

48 
	~"ıu/th»ad_cÚ‹xt.hh
"

49 
	~"debug/LLSC.hh
"

50 
	~"debug/MemÜyAcûss.hh
"

51 
	~"mem/ab¡¿ù_mem.hh
"

52 
	~"mem/·ck‘_acûss.hh
"

53 
	~"sim/sy¡em.hh
"

55 
usšg
 
Çme¥aû
 
	g¡d
;

57 
	gAb¡¿ùMemÜy
::
	$Ab¡¿ùMemÜy
(cÚ¡ 
P¬ams
 *
p
) :

58 
	`MemObjeù
(
p
), 
	`¿nge
(
	`·¿ms
()->
¿nge
), 
	`pmemAddr
(
NULL
),

59 
	`cÚfTabËR•Ü‹d
(
p
->
cÚf_bË_»pÜ‹d
), 
	`šAddrM­
Õ->
š_addr_m­
),

60 
	`kvmM­
(
p
->
kvm_m­
), 
	$_sy¡em
(
NULL
)

62 
	}
}

65 
	gAb¡¿ùMemÜy
::
	$š™
()

67 
	`as£¹
(
	`sy¡em
());

69 ià(
	`size
(è% 
_sy¡em
->
	`g‘PageBy‹s
() != 0)

70 
	`·nic
("Memory Size‚ot divisible by…age size\n");

71 
	}
}

74 
	gAb¡¿ùMemÜy
::
	$£tBackšgStÜe
(
ušt8_t
* 
pmem_addr
)

76 
pmemAddr
 = 
pmem_addr
;

77 
	}
}

80 
	gAb¡¿ùMemÜy
::
	$»gSts
()

82 
MemObjeù
::
	`»gSts
();

84 
usšg
 
Çme¥aû
 
Sts
;

86 
	`as£¹
(
	`sy¡em
());

88 
by‹sR—d


89 .
	`š™
(
	`sy¡em
()->
	`maxMa¡”s
())

90 .
	`Çme
(name() + ".bytes_read")

91 .
	`desc
("Number of bytes„ead fromhis memory")

92 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

94 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

95 
by‹sR—d
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

97 
by‹sIn¡R—d


98 .
	`š™
(
	`sy¡em
()->
	`maxMa¡”s
())

99 .
	`Çme
(name() + ".bytes_inst_read")

100 .
	`desc
("Number of instructions bytes„ead fromhis memory")

101 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

103 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

104 
by‹sIn¡R—d
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

106 
by‹sWr™‹n


107 .
	`š™
(
	`sy¡em
()->
	`maxMa¡”s
())

108 .
	`Çme
(name() + ".bytes_written")

109 .
	`desc
("Number of bytes writtenohis memory")

110 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

112 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

113 
by‹sWr™‹n
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

115 
numR—ds


116 .
	`š™
(
	`sy¡em
()->
	`maxMa¡”s
())

117 .
	`Çme
(name() + ".num_reads")

118 .
	`desc
("Number of„ead„equests„espondedo byhis memory")

119 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

121 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

122 
numR—ds
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

124 
numWr™es


125 .
	`š™
(
	`sy¡em
()->
	`maxMa¡”s
())

126 .
	`Çme
(name() + ".num_writes")

127 .
	`desc
("Number of write„equests„espondedo byhis memory")

128 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

130 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

131 
numWr™es
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

133 
numOth”


134 .
	`š™
(
	`sy¡em
()->
	`maxMa¡”s
())

135 .
	`Çme
(name() + ".num_other")

136 .
	`desc
("Number of other„equests„espondedo byhis memory")

137 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

139 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

140 
numOth”
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

142 
bwR—d


143 .
	`Çme
(name() + ".bw_read")

144 .
	`desc
("Total„ead bandwidth fromhis memory (bytes/s)")

145 .
	`´ecisiÚ
(0)

146 .
	`´”eq
(
by‹sR—d
)

147 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

149 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

150 
bwR—d
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

153 
bwIn¡R—d


154 .
	`Çme
(name() + ".bw_inst_read")

155 .
	`desc
("Instruction„ead bandwidth fromhis memory (bytes/s)")

156 .
	`´ecisiÚ
(0)

157 .
	`´”eq
(
by‹sIn¡R—d
)

158 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

160 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

161 
bwIn¡R—d
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

163 
bwWr™e


164 .
	`Çme
(name() + ".bw_write")

165 .
	`desc
("Write bandwidth fromhis memory (bytes/s)")

166 .
	`´ecisiÚ
(0)

167 .
	`´”eq
(
by‹sWr™‹n
)

168 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

170 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

171 
bwWr™e
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

173 
bwTÙ®


174 .
	`Çme
(name() + ".bw_total")

175 .
	`desc
("Total bandwidtho/fromhis memory (bytes/s)")

176 .
	`´ecisiÚ
(0)

177 .
	`´”eq
(
bwTÙ®
)

178 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

180 
i
 = 0; i < 
	`sy¡em
()->
	`maxMa¡”s
(); i++) {

181 
bwTÙ®
.
	`subÇme
(
i
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(i));

183 
bwR—d
 = 
by‹sR—d
 / 
simSecÚds
;

184 
bwIn¡R—d
 = 
by‹sIn¡R—d
 / 
simSecÚds
;

185 
bwWr™e
 = 
by‹sWr™‹n
 / 
simSecÚds
;

186 
bwTÙ®
 = (
by‹sR—d
 + 
by‹sWr™‹n
è/ 
simSecÚds
;

187 
	}
}

189 
AddrRªge


190 
	gAb¡¿ùMemÜy
::
	$g‘AddrRªge
() const

192  
¿nge
;

193 
	}
}

198 
	gAb¡¿ùMemÜy
::
	$ŒackLßdLocked
(
Pack‘PŒ
 
pkt
)

200 
Reque¡
 *
»q
 = 
pkt
->req;

201 
Addr
 
·ddr
 = 
LockedAddr
::
	`mask
(
»q
->
	`g‘Paddr
());

206 
li¡
<
LockedAddr
>::
™”©Ü
 
i
;

208 
i
 = 
lockedAddrLi¡
.
	`begš
(); i !ğlockedAddrLi¡.
	`’d
(); ++i) {

209 ià(
i
->
	`m©chesCÚ‹xt
(
»q
)) {

210 
	`DPRINTF
(
LLSC
, "Modifying†ock„ecord: context %d‡ddr %#x\n",

211 
»q
->
	`cÚ‹xtId
(), 
·ddr
);

212 
i
->
addr
 = 
·ddr
;

218 
	`DPRINTF
(
LLSC
, "Adding†ock„ecord: context %d‡ddr %#x\n",

219 
»q
->
	`cÚ‹xtId
(), 
·ddr
);

220 
lockedAddrLi¡
.
	`push_äÚt
(
	`LockedAddr
(
»q
));

221 
	}
}

228 
boŞ


229 
	gAb¡¿ùMemÜy
::
	$checkLockedAddrLi¡
(
Pack‘PŒ
 
pkt
)

231 
Reque¡
 *
»q
 = 
pkt
->req;

232 
Addr
 
·ddr
 = 
LockedAddr
::
	`mask
(
»q
->
	`g‘Paddr
());

233 
boŞ
 
isLLSC
 = 
pkt
->
	`isLLSC
();

238 
boŞ
 
®lowStÜe
 = !
isLLSC
;

245 
li¡
<
LockedAddr
>::
™”©Ü
 
i
 = 
lockedAddrLi¡
.
	`begš
();

247 ià(
isLLSC
) {

248 
i
 !ğ
lockedAddrLi¡
.
	`’d
()) {

249 ià(
i
->
addr
 =ğ
·ddr
 && i->
	`m©chesCÚ‹xt
(
»q
)) {

252 
	`DPRINTF
(
LLSC
, "StCond success: context %d‡ddr %#x\n",

253 
»q
->
	`cÚ‹xtId
(), 
·ddr
);

254 
®lowStÜe
 = 
Œue
;

260 
i
++;

262 
»q
->
	`£tExŒaD©a
(
®lowStÜe
 ? 1 : 0);

265 ià(
®lowStÜe
) {

269 
i
 = 
lockedAddrLi¡
.
	`begš
();

270 
i
 !ğ
lockedAddrLi¡
.
	`’d
()) {

271 ià(
i
->
addr
 =ğ
·ddr
) {

272 
	`DPRINTF
(
LLSC
, "Erasing†ock„ecord: context %d‡ddr %#x\n",

273 
i
->
cÚ‹xtId
, 
·ddr
);

279 
Th»adCÚ‹xt
* 
ùx
 = 
	`sy¡em
()->
	`g‘Th»adCÚ‹xt
(
i
->
cÚ‹xtId
);

280 
ùx
->
	`g‘CpuPŒ
()->
	`wakeup
(ùx->
	`th»adId
());

281 
i
 = 
lockedAddrLi¡
.
	`”a£
(i);

283 
i
++;

288  
®lowStÜe
;

289 
	}
}

292 #ià
TRACING_ON


294 
	#CASE
(
A
, 
T
) \

295 (
T
): \

296 
	`DPRINTF
(
MemÜyAcûss
,"%s from %s of size %i on‡ddress 0x%x data " \

297 "0x%x %c\n", 
A
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(
pkt
->
»q
->
	`ma¡”Id
()),\

298 
pkt
->
	`g‘Size
(),…kt->
	`g‘Addr
(),…kt->
g‘
<
T
>(), \

299 
pkt
->
»q
->
	`isUnÿch—bË
() ? 'U' : 'C'); \

300 

	)

303 
	#TRACE_PACKET
(
A
) \

305 
pkt
->
	`g‘Size
()) { \

306 
	`CASE
(
A
, 
ušt64_t
); \

307 
	`CASE
(
A
, 
ušt32_t
); \

308 
	`CASE
(
A
, 
ušt16_t
); \

309 
	`CASE
(
A
, 
ušt8_t
); \

311 
	`DPRINTF
(
MemÜyAcûss
, "%s from %s of size %i on‡ddress 0x%x %c\n",\

312 
A
, 
	`sy¡em
()->
	`g‘Ma¡”Name
(
pkt
->
»q
->
	`ma¡”Id
()), \

313 
pkt
->
	`g‘Size
(),…kt->
	`g‘Addr
(), \

314 
pkt
->
»q
->
	`isUnÿch—bË
() ? 'U' : 'C'); \

315 
	`DDUMP
(
MemÜyAcûss
, 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(),…kt->
	`g‘Size
()); \

317 } 0)

	)

321 
	#TRACE_PACKET
(
A
)

	)

326 
	gAb¡¿ùMemÜy
::
	$acûss
(
Pack‘PŒ
 
pkt
)

328 ià(
pkt
->
	`ÿcheRe¥Údšg
()) {

329 
	`DPRINTF
(
MemÜyAcûss
, "Cache„espondingo %#llx:‚ot„esponding\n",

330 
pkt
->
	`g‘Addr
());

334 ià(
pkt
->
cmd
 =ğ
MemCmd
::
CËªEviù
 ||…kt->cmd =ğMemCmd::
Wr™ebackCËª
) {

335 
	`DPRINTF
(
MemÜyAcûss
, "CleanEvict on 0x%x:‚ot„esponding\n",

336 
pkt
->
	`g‘Addr
());

340 
	`as£¹
(
	`AddrRªge
(
pkt
->
	`g‘Addr
(),

341 
pkt
->
	`g‘Addr
(è+ (pkt->
	`g‘Size
(è- 1)).
	`isSub£t
(
¿nge
));

343 
ušt8_t
 *
ho¡Addr
 = 
pmemAddr
 + 
pkt
->
	`g‘Addr
(è- 
¿nge
.
	`¡¬t
();

345 ià(
pkt
->
cmd
 =ğ
MemCmd
::
Sw­Req
) {

346 ià(
pkt
->
	`isAtomicOp
()) {

347 ià(
pmemAddr
) {

348 
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(), 
ho¡Addr
,…kt->
	`g‘Size
());

349 (*(
pkt
->
	`g‘AtomicOp
()))(
ho¡Addr
);

352 
¡d
::
veùÜ
<
ušt8_t
> 
	`ov”wr™e_v®
(
pkt
->
	`g‘Size
());

353 
ušt64_t
 
cÚd™iÚ_v®64
;

354 
ušt32_t
 
cÚd™iÚ_v®32
;

356 ià(!
pmemAddr
)

357 
	`·nic
("Swap only works ifhere is„eal memory (i.e.‚ull=False)");

359 
boŞ
 
ov”wr™e_mem
 = 
Œue
;

362 
¡d
::
	`memıy
(&
ov”wr™e_v®
[0], 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(),

363 
pkt
->
	`g‘Size
());

364 
¡d
::
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(), 
ho¡Addr
,…kt->
	`g‘Size
());

366 ià(
pkt
->
»q
->
	`isCÚdSw­
()) {

367 ià(
pkt
->
	`g‘Size
(è=ğ(
ušt64_t
)) {

368 
cÚd™iÚ_v®64
 = 
pkt
->
»q
->
	`g‘ExŒaD©a
();

369 
ov”wr™e_mem
 = !
¡d
::
	`memcmp
(&
cÚd™iÚ_v®64
, 
ho¡Addr
,

370 (
ušt64_t
));

371 } ià(
pkt
->
	`g‘Size
(è=ğ(
ušt32_t
)) {

372 
cÚd™iÚ_v®32
 = (
ušt32_t
)
pkt
->
»q
->
	`g‘ExŒaD©a
();

373 
ov”wr™e_mem
 = !
¡d
::
	`memcmp
(&
cÚd™iÚ_v®32
, 
ho¡Addr
,

374 (
ušt32_t
));

376 
	`·nic
("Invalid size for conditional„ead/write\n");

379 ià(
ov”wr™e_mem
)

380 
¡d
::
	`memıy
(
ho¡Addr
, &
ov”wr™e_v®
[0], 
pkt
->
	`g‘Size
());

382 
	`as£¹
(!
pkt
->
»q
->
	`isIn¡F‘ch
());

383 
	`TRACE_PACKET
("Read/Write");

384 
numOth”
[
pkt
->
»q
->
	`ma¡”Id
()]++;

386 } ià(
pkt
->
	`isR—d
()) {

387 
	`as£¹
(!
pkt
->
	`isWr™e
());

388 ià(
pkt
->
	`isLLSC
()) {

389 
	`ŒackLßdLocked
(
pkt
);

391 ià(
pmemAddr
)

392 
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(), 
ho¡Addr
,…kt->
	`g‘Size
());

393 
	`TRACE_PACKET
(
pkt
->
»q
->
	`isIn¡F‘ch
() ? "IFetch" : "Read");

394 
numR—ds
[
pkt
->
»q
->
	`ma¡”Id
()]++;

395 
by‹sR—d
[
pkt
->
»q
->
	`ma¡”Id
()] +ğpkt->
	`g‘Size
();

396 ià(
pkt
->
»q
->
	`isIn¡F‘ch
())

397 
by‹sIn¡R—d
[
pkt
->
»q
->
	`ma¡”Id
()] +ğpkt->
	`g‘Size
();

398 } ià(
pkt
->
	`isInv®id©e
()) {

405 } ià(
pkt
->
	`isWr™e
()) {

406 ià(
	`wr™eOK
(
pkt
)) {

407 ià(
pmemAddr
) {

408 
	`memıy
(
ho¡Addr
, 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(),…kt->
	`g‘Size
());

409 
	`DPRINTF
(
MemÜyAcûss
, "%s wrote %i byteso‡ddress %x\n",

410 
__func__
, 
pkt
->
	`g‘Size
(),…kt->
	`g‘Addr
());

412 
	`as£¹
(!
pkt
->
»q
->
	`isIn¡F‘ch
());

413 
	`TRACE_PACKET
("Write");

414 
numWr™es
[
pkt
->
»q
->
	`ma¡”Id
()]++;

415 
by‹sWr™‹n
[
pkt
->
»q
->
	`ma¡”Id
()] +ğpkt->
	`g‘Size
();

418 
	`·nic
("unimplemented");

421 ià(
pkt
->
	`ÃedsRe¥Ú£
()) {

422 
pkt
->
	`makeRe¥Ú£
();

424 
	}
}

427 
	gAb¡¿ùMemÜy
::
	$funùiÚ®Acûss
(
Pack‘PŒ
 
pkt
)

429 
	`as£¹
(
	`AddrRªge
(
pkt
->
	`g‘Addr
(),

430 
pkt
->
	`g‘Addr
(è+…kt->
	`g‘Size
(è- 1).
	`isSub£t
(
¿nge
));

432 
ušt8_t
 *
ho¡Addr
 = 
pmemAddr
 + 
pkt
->
	`g‘Addr
(è- 
¿nge
.
	`¡¬t
();

434 ià(
pkt
->
	`isR—d
()) {

435 ià(
pmemAddr
)

436 
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(), 
ho¡Addr
,…kt->
	`g‘Size
());

437 
	`TRACE_PACKET
("Read");

438 
pkt
->
	`makeRe¥Ú£
();

439 } ià(
pkt
->
	`isWr™e
()) {

440 ià(
pmemAddr
)

441 
	`memıy
(
ho¡Addr
, 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(),…kt->
	`g‘Size
());

442 
	`TRACE_PACKET
("Write");

443 
pkt
->
	`makeRe¥Ú£
();

444 } ià(
pkt
->
	`isPršt
()) {

445 
Pack‘
::
PrštReqS‹
 *
´s
 =

446 
dyÇmic_ÿ¡
<
Pack‘
::
PrštReqS‹
*>(
pkt
->
£nd”S‹
);

447 
	`as£¹
(
´s
);

450 
´s
->
	`´štLab–s
();

452 
	`cırštf
(
´s
->
os
, "%s%#x\n",…rs->
	`curP»fix
(), *
ho¡Addr
);

454 
	`·nic
("AbstractMemory: unimplemented functional command %s",

455 
pkt
->
	`cmdSŒšg
());

457 
	}
}

	@abstract_mem.hh

49 #iâdeà
__ABSTRACT_MEMORY_HH__


50 
	#__ABSTRACT_MEMORY_HH__


	)

52 
	~"mem/mem_objeù.hh
"

53 
	~"·¿ms/Ab¡¿ùMemÜy.hh
"

54 
	~"sim/¡©s.hh
"

57 
şass
 
	gSy¡em
;

63 şas 
	cLockedAddr
 {

65 
	m´iv©e
:

69 cÚ¡ 
Addr
 
Addr_Mask
 = 0xf;

71 
	mpublic
:

74 
Addr
 
addr
;

77 cÚ¡ 
CÚ‹xtID
 
	mcÚ‹xtId
;

79 
Addr
 
	$mask
(
Addr
 
·ddr
è{  (·dd¸& ~
Addr_Mask
); }

82 
boŞ
 
	$m©chesCÚ‹xt
(
Reque¡
 *
»q
) const

84  (
cÚ‹xtId
 =ğ
»q
->
	`cÚ‹xtId
());

85 
	}
}

87 
	$LockedAddr
(
Reque¡
 *
»q
è: 
	`addr
(
	`mask
Ôeq->
	`g‘Paddr
())),

88 
	`cÚ‹xtId
(
»q
->
	$cÚ‹xtId
())

89 {
	}
}

92 
	$LockedAddr
(
Addr
 
_addr
, 
_cid
è: 
	`addr
(_addr), 
	$cÚ‹xtId
(
_cid
)

93 {
	}
}

103 şas 
	cAb¡¿ùMemÜy
 : 
public
 
MemObjeù


105 
´Ùeùed
:

108 
AddrRªge
 
¿nge
;

111 
ušt8_t
* 
	mpmemAddr
;

114 cÚ¡ 
boŞ
 
	mcÚfTabËR•Ü‹d
;

117 cÚ¡ 
boŞ
 
	mšAddrM­
;

120 cÚ¡ 
boŞ
 
	mkvmM­
;

122 
	m¡d
::
li¡
<
LockedAddr
> 
lockedAddrLi¡
;

128 
boŞ
 
checkLockedAddrLi¡
(
Pack‘PŒ
 
pkt
);

133 
ŒackLßdLocked
(
Pack‘PŒ
 
pkt
);

142 
boŞ
 
	$wr™eOK
(
Pack‘PŒ
 
pkt
) {

143 
Reque¡
 *
»q
 = 
pkt
->req;

144 ià(
lockedAddrLi¡
.
	`em±y
()) {

146 
boŞ
 
isLLSC
 = 
pkt
->
	`isLLSC
();

147 ià(
isLLSC
) {

148 
»q
->
	`£tExŒaD©a
(0);

150  !
isLLSC
;

153  
	`checkLockedAddrLi¡
(
pkt
);

158 
Sts
::
VeùÜ
 
by‹sR—d
;

160 
Sts
::
VeùÜ
 
by‹sIn¡R—d
;

162 
Sts
::
VeùÜ
 
by‹sWr™‹n
;

164 
Sts
::
VeùÜ
 
numR—ds
;

166 
Sts
::
VeùÜ
 
numWr™es
;

168 
Sts
::
VeùÜ
 
numOth”
;

170 
Sts
::
FÜmuÏ
 
bwR—d
;

172 
Sts
::
FÜmuÏ
 
bwIn¡R—d
;

174 
Sts
::
FÜmuÏ
 
bwWr™e
;

176 
Sts
::
FÜmuÏ
 
bwTÙ®
;

182 
Sy¡em
 *
_sy¡em
;

185 
´iv©e
:

188 
	`Ab¡¿ùMemÜy
(cÚ¡ 
Ab¡¿ùMemÜy
&);

191 
Ab¡¿ùMemÜy
& 
İ”©Ü
=(const AbstractMemory&);

193 
public
:

195 
Ab¡¿ùMemÜyP¬ams
 
	tP¬ams
;

197 
	`Ab¡¿ùMemÜy
(cÚ¡ 
P¬ams
* 
p
);

198 
vœtu®
 ~
	$Ab¡¿ùMemÜy
(è{
	}
}

203 
	$š™
(è
ov”ride
;

211 
boŞ
 
	$isNuÎ
(ècÚ¡ {  
	`·¿ms
()->
nuÎ
; 
	}
}

219 
£tBackšgStÜe
(
ušt8_t
* 
pmem_addr
);

224 cÚ¡ 
	g¡d
::
li¡
<
LockedAddr
>& 
	$g‘LockedAddrLi¡
() const

225 {  
lockedAddrLi¡
; 
	}
}

230 
	$addLockedAddr
(
LockedAddr
 
addr
è{ 
lockedAddrLi¡
.
	`push_back
×ddr); 
	}
}

235 
Sy¡em
* 
	$sy¡em
(ècÚ¡ {  
_sy¡em
; 
	}
}

243 
	$sy¡em
(
Sy¡em
 *
sys
è{ 
_sy¡em
 = sys; 
	}
}

245 cÚ¡ 
P¬ams
 *

246 
	$·¿ms
() const

248  
dyÇmic_ÿ¡
<cÚ¡ 
P¬ams
 *>(
_·¿ms
);

249 
	}
}

256 
AddrRªge
 
	$g‘AddrRªge
() const;

263 
ušt64_t
 
	$size
(ècÚ¡ {  
¿nge
.
	`size
(); 
	}
}

270 
Addr
 
	$¡¬t
(ècÚ¡ {  
¿nge
.
	`¡¬t
(); 
	}
}

278 
boŞ
 
	$isCÚfR•Ü‹d
(ècÚ¡ {  
cÚfTabËR•Ü‹d
; 
	}
}

286 
boŞ
 
	$isInAddrM­
(ècÚ¡ {  
šAddrM­
; 
	}
}

294 
boŞ
 
	$isKvmM­
(ècÚ¡ {  
kvmM­
; 
	}
}

303 
acûss
(
Pack‘PŒ
 
pkt
);

313 
funùiÚ®Acûss
(
Pack‘PŒ
 
pkt
);

318 
	$»gSts
(è
ov”ride
;

320 
	}
};

	@addr_mapper.cc

40 
	~"mem/addr_m­³r.hh
"

42 
	gAddrM­³r
::
	$AddrM­³r
(cÚ¡ 
AddrM­³rP¬ams
* 
p
)

43 : 
	`MemObjeù
(
p
),

44 
	`ma¡”PÜt
(
	`Çme
(è+ "-ma¡”", *
this
),

45 
	`¦avePÜt
(
	`Çme
(è+ "-¦ave", *
this
)

47 
	}
}

50 
	gAddrM­³r
::
	$š™
()

52 ià(!
¦avePÜt
.
	`isCÚÃùed
(è|| !
ma¡”PÜt
.isConnected())

53 
	`çl
("Address mapper is‚ot connected on both sides.\n");

54 
	}
}

56 
	gBa£Ma¡”PÜt
&

57 
	gAddrM­³r
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
, 
PÜtID
 
idx
)

59 ià(
if_Çme
 == "master") {

60  
ma¡”PÜt
;

62  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

64 
	}
}

66 
	gBa£SÏvePÜt
&

67 
	gAddrM­³r
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
, 
PÜtID
 
idx
)

69 ià(
if_Çme
 == "slave") {

70  
¦avePÜt
;

72  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

74 
	}
}

77 
	gAddrM­³r
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

79 
Addr
 
Üig_addr
 = 
pkt
->
	`g‘Addr
();

80 
pkt
->
	`£tAddr
(
	`»m­Addr
(
Üig_addr
));

81 
ma¡”PÜt
.
	`£ndFunùiÚ®
(
pkt
);

82 
pkt
->
	`£tAddr
(
Üig_addr
);

83 
	}
}

86 
	gAddrM­³r
::
	$»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

88 
Addr
 
Üig_addr
 = 
pkt
->
	`g‘Addr
();

89 
pkt
->
	`£tAddr
(
	`»m­Addr
(
Üig_addr
));

90 
¦avePÜt
.
	`£ndFunùiÚ®Snoİ
(
pkt
);

91 
pkt
->
	`£tAddr
(
Üig_addr
);

92 
	}
}

94 
Tick


95 
	gAddrM­³r
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

97 
Addr
 
Üig_addr
 = 
pkt
->
	`g‘Addr
();

98 
pkt
->
	`£tAddr
(
	`»m­Addr
(
Üig_addr
));

99 
Tick
 
»t_tick
 = 
ma¡”PÜt
.
	`£ndAtomic
(
pkt
);

100 
pkt
->
	`£tAddr
(
Üig_addr
);

101  
»t_tick
;

102 
	}
}

104 
Tick


105 
	gAddrM­³r
::
	$»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

107 
Addr
 
Üig_addr
 = 
pkt
->
	`g‘Addr
();

108 
pkt
->
	`£tAddr
(
	`»m­Addr
(
Üig_addr
));

109 
Tick
 
»t_tick
 = 
¦avePÜt
.
	`£ndAtomicSnoİ
(
pkt
);

110 
pkt
->
	`£tAddr
(
Üig_addr
);

111  
»t_tick
;

112 
	}
}

114 
boŞ


115 
	gAddrM­³r
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

117 
Addr
 
Üig_addr
 = 
pkt
->
	`g‘Addr
();

118 
boŞ
 
ÃedsRe¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

119 
boŞ
 
ÿcheRe¥Údšg
 = 
pkt
->
	`ÿcheRe¥Údšg
();

121 ià(
ÃedsRe¥Ú£
 && !
ÿcheRe¥Údšg
) {

122 
pkt
->
	`pushS’d”S‹
(
Ãw
 
	`AddrM­³rS’d”S‹
(
Üig_addr
));

125 
pkt
->
	`£tAddr
(
	`»m­Addr
(
Üig_addr
));

128 
boŞ
 
sucûssful
 = 
ma¡”PÜt
.
	`£ndTimšgReq
(
pkt
);

131 ià(!
sucûssful
) {

132 
pkt
->
	`£tAddr
(
Üig_addr
);

134 ià(
ÃedsRe¥Ú£
) {

135 
d–‘e
 
pkt
->
	`pİS’d”S‹
();

139  
sucûssful
;

140 
	}
}

142 
boŞ


143 
	gAddrM­³r
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

145 
AddrM­³rS’d”S‹
* 
»ûivedS‹
 =

146 
dyÇmic_ÿ¡
<
AddrM­³rS’d”S‹
*>(
pkt
->
£nd”S‹
);

149 ià(
»ûivedS‹
 =ğ
NULL
)

150 
	`·nic
("AddrMapper %s got‡„esponse without sender state\n",

151 
	`Çme
());

153 
Addr
 
»m­³d_addr
 = 
pkt
->
	`g‘Addr
();

156 
pkt
->
£nd”S‹
 = 
»ûivedS‹
->
´edeûssÜ
;

157 
pkt
->
	`£tAddr
(
»ûivedS‹
->
ÜigAddr
);

160 
boŞ
 
sucûssful
 = 
¦avePÜt
.
	`£ndTimšgRe¥
(
pkt
);

164 ià(
sucûssful
) {

165 
d–‘e
 
»ûivedS‹
;

169 
pkt
->
£nd”S‹
 = 
»ûivedS‹
;

170 
pkt
->
	`£tAddr
(
»m­³d_addr
);

172  
sucûssful
;

173 
	}
}

176 
	gAddrM­³r
::
	$»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

178 
¦avePÜt
.
	`£ndTimšgSnoİReq
(
pkt
);

179 
	}
}

181 
boŞ


182 
	gAddrM­³r
::
	$»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

184  
ma¡”PÜt
.
	`£ndTimšgSnoİRe¥
(
pkt
);

185 
	}
}

187 
boŞ


188 
	gAddrM­³r
::
	$isSnoİšg
() const

190 ià(
¦avePÜt
.
	`isSnoİšg
())

191 
	`çl
("AddrMapper doesn't support„emapping of snooping„equests\n");

192  
çl£
;

193 
	}
}

196 
	gAddrM­³r
::
	$»cvReqR‘ry
()

198 
¦avePÜt
.
	`£ndR‘ryReq
();

199 
	}
}

202 
	gAddrM­³r
::
	$»cvRe¥R‘ry
()

204 
ma¡”PÜt
.
	`£ndR‘ryRe¥
();

205 
	}
}

208 
	gAddrM­³r
::
	$»cvRªgeChªge
()

210 
¦avePÜt
.
	`£ndRªgeChªge
();

211 
	}
}

213 
	gRªgeAddrM­³r
::
	$RªgeAddrM­³r
(cÚ¡ 
RªgeAddrM­³rP¬ams
* 
p
) :

214 
	`AddrM­³r
(
p
),

215 
	`Üigš®Rªges
(
p
->
Üigš®_¿nges
),

216 
	`»m­³dRªges
(
p
->
»m­³d_¿nges
)

218 ià(
Üigš®Rªges
.
	`size
(è!ğ
»m­³dRªges
.size())

219 
	`çl
("AddrMapper: original‡nd shadowed„ange†ist must "

222 
size_t
 
x
 = 0; x < 
Üigš®Rªges
.
	`size
(); x++) {

223 ià(
Üigš®Rªges
[
x
].
	`size
(è!ğ
»m­³dRªges
[x].size())

224 
	`çl
("AddrMapper: original‡nd shadowed„ange†istƒlements"

227 
	}
}

229 
RªgeAddrM­³r
*

230 
	gRªgeAddrM­³rP¬ams
::
	$ü—‹
()

232  
Ãw
 
	`RªgeAddrM­³r
(
this
);

233 
	}
}

235 
Addr


236 
	gRªgeAddrM­³r
::
	$»m­Addr
(
Addr
 
addr
) const

238 
i
 = 0; i < 
Üigš®Rªges
.
	`size
(); ++i) {

239 ià(
Üigš®Rªges
[
i
].
	`cÚšs
(
addr
)) {

240 
Addr
 
off£t
 = 
addr
 - 
Üigš®Rªges
[
i
].
	`¡¬t
();

241  
off£t
 + 
»m­³dRªges
[
i
].
	`¡¬t
();

245  
addr
;

246 
	}
}

248 
AddrRªgeLi¡


249 
	gRªgeAddrM­³r
::
	$g‘AddrRªges
() const

252 
AddrRªgeLi¡
 
	`¿nges
(
Üigš®Rªges
.
	`begš
(), origš®Rªges.
	`’d
());

253  
¿nges
;

254 
	}
}

	@addr_mapper.hh

40 #iâdeà
__MEM_ADDR_MAPPER_HH__


41 
	#__MEM_ADDR_MAPPER_HH__


	)

43 
	~"mem/mem_objeù.hh
"

44 
	~"·¿ms/AddrM­³r.hh
"

45 
	~"·¿ms/RªgeAddrM­³r.hh
"

56 şas 
	cAddrM­³r
 : 
public
 
MemObjeù


59 
public
:

61 
AddrM­³r
(cÚ¡ 
AddrM­³rP¬ams
* 
·¿ms
);

63 
	mvœtu®
 ~
	$AddrM­³r
() { }

65 
vœtu®
 
Ba£Ma¡”PÜt
& 
	`g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

66 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

68 
vœtu®
 
Ba£SÏvePÜt
& 
	`g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

69 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

71 
vœtu®
 
	`š™
();

73 
´Ùeùed
:

82 
vœtu®
 
Addr
 
	$»m­Addr
(
Addr
 
addr
) const = 0;

84 şas 
	cAddrM­³rS’d”S‹
 : 
public
 
Pack‘
::
S’d”S‹


87 
public
:

94 
	`AddrM­³rS’d”S‹
(
Addr
 
_ÜigAddr
è: 
	`ÜigAddr
(_origAddr)

98 ~
	`AddrM­³rS’d”S‹
() { }

101 
Addr
 
ÜigAddr
;

103 
	}
};

105 şas 
	cM­³rMa¡”PÜt
 : 
public
 
Ma¡”PÜt


108 
public
:

110 
M­³rMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
AddrM­³r
& 
_m­³r
)

111 : 
Ma¡”PÜt
(
_Çme
, &
_m­³r
), 
m­³r
(_mapper)

114 
	g´Ùeùed
:

116 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

118 
m­³r
.
»cvFunùiÚ®Snoİ
(
pkt
);

121 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

123  
	gm­³r
.
»cvAtomicSnoİ
(
pkt
);

126 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

128  
	gm­³r
.
»cvTimšgRe¥
(
pkt
);

131 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

133 
	gm­³r
.
»cvTimšgSnoİReq
(
pkt
);

136 
»cvRªgeChªge
()

138 
	gm­³r
.
»cvRªgeChªge
();

141 
boŞ
 
isSnoİšg
() const

143  
	gm­³r
.
isSnoİšg
();

146 
»cvReqR‘ry
()

148 
	gm­³r
.
»cvReqR‘ry
();

151 
	g´iv©e
:

153 
AddrM­³r
& 
m­³r
;

158 
M­³rMa¡”PÜt
 
	gma¡”PÜt
;

160 şas 
	cM­³rSÏvePÜt
 : 
public
 
SÏvePÜt


163 
public
:

165 
M­³rSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
AddrM­³r
& 
_m­³r
)

166 : 
SÏvePÜt
(
_Çme
, &
_m­³r
), 
m­³r
(_mapper)

169 
	g´Ùeùed
:

171 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

173 
m­³r
.
»cvFunùiÚ®
(
pkt
);

176 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
)

178  
	gm­³r
.
»cvAtomic
(
pkt
);

181 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

183  
	gm­³r
.
»cvTimšgReq
(
pkt
);

186 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

188  
	gm­³r
.
»cvTimšgSnoİRe¥
(
pkt
);

191 
AddrRªgeLi¡
 
g‘AddrRªges
() const

193  
	gm­³r
.
g‘AddrRªges
();

196 
»cvRe¥R‘ry
()

198 
	gm­³r
.
»cvRe¥R‘ry
();

201 
	g´iv©e
:

203 
AddrM­³r
& 
m­³r
;

208 
M­³rSÏvePÜt
 
	g¦avePÜt
;

210 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

212 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
);

214 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

216 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
);

218 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

220 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

222 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
);

224 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
);

226 
vœtu®
 
AddrRªgeLi¡
 
	$g‘AddrRªges
() const = 0;

228 
boŞ
 
	$isSnoİšg
() const;

230 
	`»cvReqR‘ry
();

232 
	`»cvRe¥R‘ry
();

234 
	`»cvRªgeChªge
();

235 
	}
};

243 şas 
	cRªgeAddrM­³r
 : 
public
 
AddrM­³r


246 
public
:

248 
RªgeAddrM­³r
(cÚ¡ 
RªgeAddrM­³rP¬ams
* 
p
);

250 ~
	$RªgeAddrM­³r
() { }

252 
AddrRªgeLi¡
 
	$g‘AddrRªges
() const;

254 
´Ùeùed
:

261 
¡d
::
veùÜ
<
AddrRªge
> 
Üigš®Rªges
;

267 
¡d
::
veùÜ
<
AddrRªge
> 
»m­³dRªges
;

269 
Addr
 
	$»m­Addr
(
Addr
 
addr
) const;

271 
	}
};

	@bridge.cc

51 
	~"ba£/Œaû.hh
"

52 
	~"debug/Bridge.hh
"

53 
	~"mem/bridge.hh
"

54 
	~"·¿ms/Bridge.hh
"

56 
	gBridge
::
BridgeSÏvePÜt
::BridgeSÏvePÜt(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
,

57 
Bridge
& 
_bridge
,

58 
BridgeMa¡”PÜt
& 
_ma¡”PÜt
,

59 
Cyşes
 
_d–ay
, 
_»¥_lim™
,

60 
¡d
::
veùÜ
<
AddrRªge
> 
_¿nges
)

61 : 
SÏvePÜt
(
_Çme
, &
_bridge
), 
bridge
(_bridge), 
ma¡”PÜt
(
_ma¡”PÜt
),

62 
d–ay
(
_d–ay
), 
¿nges
(
_¿nges
.
begš
(), _¿nges.
’d
()),

63 
out¡ªdšgRe¥Ú£s
(0), 
»ŒyReq
(
çl£
),

64 
»¥QueueLim™
(
_»¥_lim™
), 
	$£ndEv’t
(*
this
)

66 
	}
}

68 
	gBridge
::
BridgeMa¡”PÜt
::
	$BridgeMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
,

69 
Bridge
& 
_bridge
,

70 
BridgeSÏvePÜt
& 
_¦avePÜt
,

71 
Cyşes
 
_d–ay
, 
_»q_lim™
)

72 : 
	`Ma¡”PÜt
(
_Çme
, &
_bridge
), 
	`bridge
(_bridge), 
	`¦avePÜt
(
_¦avePÜt
),

73 
	`d–ay
(
_d–ay
), 
	`»qQueueLim™
(
_»q_lim™
), 
	$£ndEv’t
(*
this
)

75 
	}
}

77 
	gBridge
::
	$Bridge
(
P¬ams
 *
p
)

78 : 
	`MemObjeù
(
p
),

79 
	`¦avePÜt
(
p
->
Çme
 + ".¦ave", *
this
, 
ma¡”PÜt
,

80 
	`ticksToCyşes
(
p
->
d–ay
),…->
»¥_size
,…->
¿nges
),

81 
	`ma¡”PÜt
(
p
->
Çme
 + ".ma¡”", *
this
, 
¦avePÜt
,

82 
	`ticksToCyşes
(
p
->
d–ay
),…->
»q_size
)

84 
	}
}

86 
	gBa£Ma¡”PÜt
&

87 
	gBridge
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

89 ià(
if_Çme
 == "master")

90  
ma¡”PÜt
;

93  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

94 
	}
}

96 
	gBa£SÏvePÜt
&

97 
	gBridge
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

99 ià(
if_Çme
 == "slave")

100  
¦avePÜt
;

103  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

104 
	}
}

107 
	gBridge
::
	$š™
()

110 ià(!
¦avePÜt
.
	`isCÚÃùed
(è|| !
ma¡”PÜt
.isConnected())

111 
	`çl
("Both…orts of‡ bridge must be connected.\n");

114 
¦avePÜt
.
	`£ndRªgeChªge
();

115 
	}
}

117 
boŞ


118 
	gBridge
::
BridgeSÏvePÜt
::
	$»¥QueueFuÎ
() const

120  
out¡ªdšgRe¥Ú£s
 =ğ
»¥QueueLim™
;

121 
	}
}

123 
boŞ


124 
	gBridge
::
BridgeMa¡”PÜt
::
	$»qQueueFuÎ
() const

126  
Œªsm™Li¡
.
	`size
(è=ğ
»qQueueLim™
;

127 
	}
}

129 
boŞ


130 
	gBridge
::
BridgeMa¡”PÜt
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

134 
	`DPRINTF
(
Bridge
, "recvTimingResp: %s‡ddr 0x%x\n",

135 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

137 
	`DPRINTF
(
Bridge
, "Reque¡ queusize: %d\n", 
Œªsm™Li¡
.
	`size
());

142 
Tick
 
»ûive_d–ay
 = 
pkt
->
h—d”D–ay
 +…kt->
·ylßdD–ay
;

143 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

145 
¦avePÜt
.
	`schedTimšgRe¥
(
pkt
, 
bridge
.
	`şockEdge
(
d–ay
) +

146 
»ûive_d–ay
);

148  
Œue
;

149 
	}
}

151 
boŞ


152 
	gBridge
::
BridgeSÏvePÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

154 
	`DPRINTF
(
Bridge
, "recvTimingReq: %s‡ddr 0x%x\n",

155 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

157 
	`·nic_if
(
pkt
->
	`ÿcheRe¥Údšg
(), "Should‚ot see…ackets where cache "

163 ià(
»ŒyReq
)

164  
çl£
;

166 
	`DPRINTF
(
Bridge
, "Response queue size: %d outresp: %d\n",

167 
Œªsm™Li¡
.
	`size
(), 
out¡ªdšgRe¥Ú£s
);

170 ià(
ma¡”PÜt
.
	`»qQueueFuÎ
()) {

171 
	`DPRINTF
(
Bridge
, "Request queue full\n");

172 
»ŒyReq
 = 
Œue
;

175 
boŞ
 
ex³ùs_»¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

176 ià(
ex³ùs_»¥Ú£
) {

177 ià(
	`»¥QueueFuÎ
()) {

178 
	`DPRINTF
(
Bridge
, "Response queue full\n");

179 
»ŒyReq
 = 
Œue
;

182 
	`DPRINTF
(
Bridge
, "Reserving space for„esponse\n");

183 
	`as£¹
(
out¡ªdšgRe¥Ú£s
 !ğ
»¥QueueLim™
);

184 ++
out¡ªdšgRe¥Ú£s
;

191 ià(!
»ŒyReq
) {

196 
Tick
 
»ûive_d–ay
 = 
pkt
->
h—d”D–ay
 +…kt->
·ylßdD–ay
;

197 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

199 
ma¡”PÜt
.
	`schedTimšgReq
(
pkt
, 
bridge
.
	`şockEdge
(
d–ay
) +

200 
»ûive_d–ay
);

208  !
»ŒyReq
;

209 
	}
}

212 
	gBridge
::
BridgeSÏvePÜt
::
	$»ŒySÎedReq
()

214 ià(
»ŒyReq
) {

215 
	`DPRINTF
(
Bridge
, "Request waiting for„etry,‚ow„etrying\n");

216 
»ŒyReq
 = 
çl£
;

217 
	`£ndR‘ryReq
();

219 
	}
}

222 
	gBridge
::
BridgeMa¡”PÜt
::
	$schedTimšgReq
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
)

228 ià(
Œªsm™Li¡
.
	`em±y
()) {

229 
bridge
.
	`scheduË
(
£ndEv’t
, 
wh’
);

232 
	`as£¹
(
Œªsm™Li¡
.
	`size
(è!ğ
»qQueueLim™
);

234 
Œªsm™Li¡
.
	`em¶aû_back
(
pkt
, 
wh’
);

235 
	}
}

239 
	gBridge
::
BridgeSÏvePÜt
::
	$schedTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
)

245 ià(
Œªsm™Li¡
.
	`em±y
()) {

246 
bridge
.
	`scheduË
(
£ndEv’t
, 
wh’
);

249 
Œªsm™Li¡
.
	`em¶aû_back
(
pkt
, 
wh’
);

250 
	}
}

253 
	gBridge
::
BridgeMa¡”PÜt
::
	$ŒyS’dTimšg
()

255 
	`as£¹
(!
Œªsm™Li¡
.
	`em±y
());

257 
Deã¼edPack‘
 
»q
 = 
Œªsm™Li¡
.
	`äÚt
();

259 
	`as£¹
(
»q
.
tick
 <ğ
	`curTick
());

261 
Pack‘PŒ
 
pkt
 = 
»q
.pkt;

263 
	`DPRINTF
(
Bridge
, "trySend„equest‡ddr 0x%x, queue size %d\n",

264 
pkt
->
	`g‘Addr
(), 
Œªsm™Li¡
.
	`size
());

266 ià(
	`£ndTimšgReq
(
pkt
)) {

268 
Œªsm™Li¡
.
	`pİ_äÚt
();

269 
	`DPRINTF
(
Bridge
, "trySend„equest successful\n");

272 ià(!
Œªsm™Li¡
.
	`em±y
()) {

273 
Deã¼edPack‘
 
Ãxt_»q
 = 
Œªsm™Li¡
.
	`äÚt
();

274 
	`DPRINTF
(
Bridge
, "Scheduling‚ext send\n");

275 
bridge
.
	`scheduË
(
£ndEv’t
, 
¡d
::
	`max
(
Ãxt_»q
.
tick
,

276 
bridge
.
	`şockEdge
()));

283 
¦avePÜt
.
	`»ŒySÎedReq
();

288 
	}
}

291 
	gBridge
::
BridgeSÏvePÜt
::
	$ŒyS’dTimšg
()

293 
	`as£¹
(!
Œªsm™Li¡
.
	`em±y
());

295 
Deã¼edPack‘
 
»¥
 = 
Œªsm™Li¡
.
	`äÚt
();

297 
	`as£¹
(
»¥
.
tick
 <ğ
	`curTick
());

299 
Pack‘PŒ
 
pkt
 = 
»¥
.pkt;

301 
	`DPRINTF
(
Bridge
, "trySend„esponse‡ddr 0x%x, outstanding %d\n",

302 
pkt
->
	`g‘Addr
(), 
out¡ªdšgRe¥Ú£s
);

304 ià(
	`£ndTimšgRe¥
(
pkt
)) {

306 
Œªsm™Li¡
.
	`pİ_äÚt
();

307 
	`DPRINTF
(
Bridge
, "trySend„esponse successful\n");

309 
	`as£¹
(
out¡ªdšgRe¥Ú£s
 != 0);

310 --
out¡ªdšgRe¥Ú£s
;

313 ià(!
Œªsm™Li¡
.
	`em±y
()) {

314 
Deã¼edPack‘
 
Ãxt_»¥
 = 
Œªsm™Li¡
.
	`äÚt
();

315 
	`DPRINTF
(
Bridge
, "Scheduling‚ext send\n");

316 
bridge
.
	`scheduË
(
£ndEv’t
, 
¡d
::
	`max
(
Ãxt_»¥
.
tick
,

317 
bridge
.
	`şockEdge
()));

323 ià(!
ma¡”PÜt
.
	`»qQueueFuÎ
(è&& 
»ŒyReq
) {

324 
	`DPRINTF
(
Bridge
, "Request waiting for„etry,‚ow„etrying\n");

325 
»ŒyReq
 = 
çl£
;

326 
	`£ndR‘ryReq
();

332 
	}
}

335 
	gBridge
::
BridgeMa¡”PÜt
::
	$»cvReqR‘ry
()

337 
	`ŒyS’dTimšg
();

338 
	}
}

341 
	gBridge
::
BridgeSÏvePÜt
::
	$»cvRe¥R‘ry
()

343 
	`ŒyS’dTimšg
();

344 
	}
}

346 
Tick


347 
	gBridge
::
BridgeSÏvePÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

349 
	`·nic_if
(
pkt
->
	`ÿcheRe¥Údšg
(), "Should‚ot see…ackets where cache "

352  
d–ay
 * 
bridge
.
	`şockP”iod
(è+ 
ma¡”PÜt
.
	`£ndAtomic
(
pkt
);

353 
	}
}

356 
	gBridge
::
BridgeSÏvePÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

358 
pkt
->
	`pushLab–
(
	`Çme
());

361 autØ
i
 = 
Œªsm™Li¡
.
	`begš
(); i !ğŒªsm™Li¡.
	`’d
(); ++i) {

362 ià(
pkt
->
	`checkFunùiÚ®
((*
i
).pkt)) {

363 
pkt
->
	`makeRe¥Ú£
();

369 ià(
ma¡”PÜt
.
	`checkFunùiÚ®
(
pkt
)) {

373 
pkt
->
	`pİLab–
();

376 
ma¡”PÜt
.
	`£ndFunùiÚ®
(
pkt
);

377 
	}
}

379 
boŞ


380 
	gBridge
::
BridgeMa¡”PÜt
::
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

382 
boŞ
 
found
 = 
çl£
;

383 autØ
i
 = 
Œªsm™Li¡
.
	`begš
();

385 
i
 !ğ
Œªsm™Li¡
.
	`’d
(è&& !
found
) {

386 ià(
pkt
->
	`checkFunùiÚ®
((*
i
).pkt)) {

387 
pkt
->
	`makeRe¥Ú£
();

388 
found
 = 
Œue
;

390 ++
i
;

393  
found
;

394 
	}
}

396 
AddrRªgeLi¡


397 
	gBridge
::
BridgeSÏvePÜt
::
	$g‘AddrRªges
() const

399  
¿nges
;

400 
	}
}

402 
Bridge
 *

403 
	gBridgeP¬ams
::
	$ü—‹
()

405  
Ãw
 
	`Bridge
(
this
);

406 
	}
}

	@bridge.hh

51 #iâdeà
__MEM_BRIDGE_HH__


52 
	#__MEM_BRIDGE_HH__


	)

54 
	~<deque
>

56 
	~"ba£/ty³s.hh
"

57 
	~"mem/mem_objeù.hh
"

58 
	~"·¿ms/Bridge.hh
"

73 şas 
	cBridge
 : 
public
 
MemObjeù


75 
´Ùeùed
:

81 şas 
	cDeã¼edPack‘


84 
public
:

86 cÚ¡ 
Tick
 
tick
;

87 cÚ¡ 
Pack‘PŒ
 
	mpkt
;

89 
Deã¼edPack‘
(
Pack‘PŒ
 
_pkt
, 
Tick
 
_tick
è: 
tick
(_tick), 
pkt
(_pkt)

94 
şass
 
	gBridgeMa¡”PÜt
;

102 şas 
	cBridgeSÏvePÜt
 : 
public
 
SÏvePÜt


105 
´iv©e
:

108 
Bridge
& 
bridge
;

113 
	gBridgeMa¡”PÜt
& 
	gma¡”PÜt
;

116 cÚ¡ 
Cyşes
 
	gd–ay
;

119 cÚ¡ 
AddrRªgeLi¡
 
	g¿nges
;

127 
	g¡d
::
deque
<
Deã¼edPack‘
> 
Œªsm™Li¡
;

130 
	gout¡ªdšgRe¥Ú£s
;

133 
boŞ
 
	g»ŒyReq
;

136 
	g»¥QueueLim™
;

142 
	g¡d
::
unique_±r
<
Pack‘
> 
³ndšgD–‘e
;

149 
boŞ
 
»¥QueueFuÎ
() const;

156 
ŒyS’dTimšg
();

159 
	gEv’tW¿µ”
<
	gBridgeSÏvePÜt
,

160 &
	gBridgeSÏvePÜt
::
ŒyS’dTimšg
> 
£ndEv’t
;

162 
	gpublic
:

174 
BridgeSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
Bridge
& 
_bridge
,

175 
BridgeMa¡”PÜt
& 
_ma¡”PÜt
, 
Cyşes
 
_d–ay
,

176 
_»¥_lim™
, 
¡d
::
veùÜ
<
AddrRªge
> 
_¿nges
);

185 
schedTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
);

192 
»ŒySÎedReq
();

194 
	g´Ùeùed
:

198 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

202 
»cvRe¥R‘ry
();

206 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

210 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

214 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

223 şas 
	cBridgeMa¡”PÜt
 : 
public
 
Ma¡”PÜt


226 
´iv©e
:

229 
Bridge
& 
bridge
;

234 
	gBridgeSÏvePÜt
& 
	g¦avePÜt
;

237 cÚ¡ 
Cyşes
 
	gd–ay
;

245 
	g¡d
::
deque
<
Deã¼edPack‘
> 
Œªsm™Li¡
;

248 cÚ¡ 
	g»qQueueLim™
;

255 
ŒyS’dTimšg
();

258 
	gEv’tW¿µ”
<
	gBridgeMa¡”PÜt
,

259 &
	gBridgeMa¡”PÜt
::
ŒyS’dTimšg
> 
£ndEv’t
;

261 
	gpublic
:

272 
BridgeMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
Bridge
& 
_bridge
,

273 
BridgeSÏvePÜt
& 
_¦avePÜt
, 
Cyşes
 
_d–ay
,

274 
_»q_lim™
);

281 
boŞ
 
»qQueueFuÎ
() const;

290 
schedTimšgReq
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
);

300 
boŞ
 
checkFunùiÚ®
(
Pack‘PŒ
 
pkt
);

302 
	g´Ùeùed
:

306 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

310 
»cvReqR‘ry
();

314 
BridgeSÏvePÜt
 
	g¦avePÜt
;

317 
BridgeMa¡”PÜt
 
	gma¡”PÜt
;

319 
	gpublic
:

321 
vœtu®
 
Ba£Ma¡”PÜt
& 
g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

322 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

323 
vœtu®
 
	gBa£SÏvePÜt
& 
g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

324 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

326 
vœtu®
 
š™
();

328 
BridgeP¬ams
 
	tP¬ams
;

330 
Bridge
(
P¬ams
 *
p
);

	@cache/base.cc

48 
	~"mem/ÿche/ba£.hh
"

50 
	~"debug/Cache.hh
"

51 
	~"debug/D¿š.hh
"

52 
	~"mem/ÿche/ÿche.hh
"

53 
	~"mem/ÿche/mshr.hh
"

54 
	~"mem/ÿche/gs/ç_Ìu.hh
"

55 
	~"mem/ÿche/gs/Ìu.hh
"

56 
	~"mem/ÿche/gs/¿ndom_»¶.hh
"

57 
	~"sim/fuÎ_sy¡em.hh
"

59 
usšg
 
Çme¥aû
 
	g¡d
;

61 
	gBa£Cache
::
CacheSÏvePÜt
::
	$CacheSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

62 
Ba£Cache
 *
_ÿche
,

63 cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
)

64 : 
	`QueuedSÏvePÜt
(
_Çme
, 
_ÿche
, 
queue
), 
	`queue
(*_ÿche, *
this
, 
_Ïb–
),

65 
	`blocked
(
çl£
), 
	`mu¡S’dR‘ry
(çl£), 
	$£ndR‘ryEv’t
(
this
)

67 
	}
}

69 
	gBa£Cache
::
	$Ba£Cache
(cÚ¡ 
Ba£CacheP¬ams
 *
p
, 
blk_size
)

70 : 
	`MemObjeù
(
p
),

71 
	`ıuSidePÜt
(
nuÎ±r
), 
	`memSidePÜt
(nullptr),

72 
	`mshrQueue
("MSHRs", 
p
->
mshrs
, 0,…->
demªd_mshr_»£rve
),

73 
	`wr™eBufãr
("wr™bufãr", 
p
->
wr™e_bufãrs
,…->
mshrs
),

74 
	`blkSize
(
blk_size
),

75 
	`lookupL©’cy
(
p
->
h™_Ï‹ncy
),

76 
	`fÜw¬dL©’cy
(
p
->
h™_Ï‹ncy
),

77 
	`flL©’cy
(
p
->
»¥Ú£_Ï‹ncy
),

78 
	`»¥Ú£L©’cy
(
p
->
»¥Ú£_Ï‹ncy
),

79 
	`numT¬g‘
(
p
->
tgts_³r_mshr
),

80 
	`fÜw¬dSnoİs
(
Œue
),

81 
	`isR—dOÆy
(
p
->
is_»ad_Úly
),

82 
	`blocked
(0),

83 
	`Üd”
(0),

84 
	`noT¬g‘MSHR
(
nuÎ±r
),

85 
	`missCouÁ
(
p
->
max_miss_couÁ
),

86 
	`addrRªges
(
p
->
addr_¿nges
.
	`begš
(),…->addr_¿nges.
	`’d
()),

87 
	`sy¡em
(
p
->
sy¡em
)

97 
	}
}

100 
	gBa£Cache
::
CacheSÏvePÜt
::
	$£tBlocked
()

102 
	`as£¹
(!
blocked
);

103 
	`DPRINTF
(
CachePÜt
, "Port is blocking‚ew„equests\n");

104 
blocked
 = 
Œue
;

107 ià(
£ndR‘ryEv’t
.
	`scheduËd
()) {

108 
owÃr
.
	`descheduË
(
£ndR‘ryEv’t
);

109 
	`DPRINTF
(
CachePÜt
, "Port descheduled„etry\n");

110 
mu¡S’dR‘ry
 = 
Œue
;

112 
	}
}

115 
	gBa£Cache
::
CacheSÏvePÜt
::
	$ş—rBlocked
()

117 
	`as£¹
(
blocked
);

118 
	`DPRINTF
(
CachePÜt
, "Port is‡ccepting‚ew„equests\n");

119 
blocked
 = 
çl£
;

120 ià(
mu¡S’dR‘ry
) {

122 
owÃr
.
	`scheduË
(
£ndR‘ryEv’t
, 
	`curTick
() + 1);

124 
	}
}

127 
	gBa£Cache
::
CacheSÏvePÜt
::
	$´oûssS’dR‘ry
()

129 
	`DPRINTF
(
CachePÜt
, "Port is sending„etry\n");

132 
mu¡S’dR‘ry
 = 
çl£
;

133 
	`£ndR‘ryReq
();

134 
	}
}

137 
	gBa£Cache
::
	$š™
()

139 ià(!
ıuSidePÜt
->
	`isCÚÃùed
(è|| !
memSidePÜt
->isConnected())

140 
	`çl
("CachpÜt Ú % ¬nÙ cÚÃùed\n", 
	`Çme
());

141 
ıuSidePÜt
->
	`£ndRªgeChªge
();

142 
fÜw¬dSnoİs
 = 
ıuSidePÜt
->
	`isSnoİšg
();

143 
	}
}

145 
	gBa£Ma¡”PÜt
 &

146 
	gBa£Cache
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

148 ià(
if_Çme
 == "mem_side") {

149  *
memSidePÜt
;

151  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

153 
	}
}

155 
	gBa£SÏvePÜt
 &

156 
	gBa£Cache
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

158 ià(
if_Çme
 == "cpu_side") {

159  *
ıuSidePÜt
;

161  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

163 
	}
}

165 
boŞ


166 
	gBa£Cache
::
	$šRªge
(
Addr
 
addr
) const

168 cÚ¡‡uto& 
r
 : 
addrRªges
) {

169 ià(
r
.
	`cÚšs
(
addr
)) {

170  
Œue
;

173  
çl£
;

174 
	}
}

177 
	gBa£Cache
::
	$»gSts
()

179 
MemObjeù
::
	`»gSts
();

181 
usšg
 
Çme¥aû
 
Sts
;

184 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

185 
MemCmd
 
	`cmd
(
acûss_idx
);

186 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

188 
h™s
[
acûss_idx
]

189 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

190 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_hits")

191 .
	`desc
("numb” oà" + 
c¡r
 + " hits")

192 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

194 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

195 
h™s
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

202 
	#SUM_DEMAND
(
s
) \

203 (
s
[
MemCmd
::
R—dReq
] + s[MemCmd::
Wr™eReq
] + s[MemCmd::
Wr™eLšeReq
] + \

204 
s
[
MemCmd
::
R—dExReq
] + s[MemCmd::
R—dCËªReq
] + s[MemCmd::
R—dSh¬edReq
])

	)

207 
	#SUM_NON_DEMAND
(
s
) \

208 (
s
[
MemCmd
::
SoáPFReq
] + s[MemCmd::
H¬dPFReq
])

	)

210 
demªdH™s


211 .
	`Çme
(name() + ".demand_hits")

212 .
	`desc
("number of demand (read+write) hits")

213 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

215 
demªdH™s
 = 
	`SUM_DEMAND
(
h™s
);

216 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

217 
demªdH™s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

220 
ov”®lH™s


221 .
	`Çme
(name() + ".overall_hits")

222 .
	`desc
("number of overall hits")

223 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

225 
ov”®lH™s
 = 
demªdH™s
 + 
	`SUM_NON_DEMAND
(
h™s
);

226 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

227 
ov”®lH™s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

231 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

232 
MemCmd
 
	`cmd
(
acûss_idx
);

233 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

235 
mis£s
[
acûss_idx
]

236 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

237 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_misses")

238 .
	`desc
("numb” oà" + 
c¡r
 + " misses")

239 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

241 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

242 
mis£s
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

246 
demªdMis£s


247 .
	`Çme
(name() + ".demand_misses")

248 .
	`desc
("number of demand (read+write) misses")

249 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

251 
demªdMis£s
 = 
	`SUM_DEMAND
(
mis£s
);

252 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

253 
demªdMis£s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

256 
ov”®lMis£s


257 .
	`Çme
(name() + ".overall_misses")

258 .
	`desc
("number of overall misses")

259 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

261 
ov”®lMis£s
 = 
demªdMis£s
 + 
	`SUM_NON_DEMAND
(
mis£s
);

262 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

263 
ov”®lMis£s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

267 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

268 
MemCmd
 
	`cmd
(
acûss_idx
);

269 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

271 
missL©’cy
[
acûss_idx
]

272 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

273 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_miss_latency")

274 .
	`desc
("numb” oà" + 
c¡r
 + " miss cycles")

275 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

277 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

278 
missL©’cy
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

282 
demªdMissL©’cy


283 .
	`Çme
(name() + ".demand_miss_latency")

284 .
	`desc
("number of demand (read+write) miss cycles")

285 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

287 
demªdMissL©’cy
 = 
	`SUM_DEMAND
(
missL©’cy
);

288 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

289 
demªdMissL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

292 
ov”®lMissL©’cy


293 .
	`Çme
(name() + ".overall_miss_latency")

294 .
	`desc
("number of overall miss cycles")

295 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

297 
ov”®lMissL©’cy
 = 
demªdMissL©’cy
 + 
	`SUM_NON_DEMAND
(
missL©’cy
);

298 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

299 
ov”®lMissL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

303 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

304 
MemCmd
 
	`cmd
(
acûss_idx
);

305 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

307 
acûs£s
[
acûss_idx
]

308 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_accesses")

309 .
	`desc
("numb” oà" + 
c¡r
 + "‡ccesses(hits+misses)")

310 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

312 
acûs£s
[
acûss_idx
] = 
h™s
[acûss_idx] + 
mis£s
[access_idx];

314 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

315 
acûs£s
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

319 
demªdAcûs£s


320 .
	`Çme
(name() + ".demand_accesses")

321 .
	`desc
("number of demand (read+write)‡ccesses")

322 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

324 
demªdAcûs£s
 = 
demªdH™s
 + 
demªdMis£s
;

325 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

326 
demªdAcûs£s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

329 
ov”®lAcûs£s


330 .
	`Çme
(name() + ".overall_accesses")

331 .
	`desc
("number of overall (read+write)‡ccesses")

332 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

334 
ov”®lAcûs£s
 = 
ov”®lH™s
 + 
ov”®lMis£s
;

335 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

336 
ov”®lAcûs£s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

340 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

341 
MemCmd
 
	`cmd
(
acûss_idx
);

342 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

344 
missR©e
[
acûss_idx
]

345 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_miss_rate")

346 .
	`desc
("mis ¿‹ fÜ " + 
c¡r
 + "‡ccesses")

347 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

349 
missR©e
[
acûss_idx
] = 
mis£s
[acûss_idx] / 
acûs£s
[access_idx];

351 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

352 
missR©e
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

356 
demªdMissR©e


357 .
	`Çme
(name() + ".demand_miss_rate")

358 .
	`desc
("miss„ate for demand‡ccesses")

359 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

361 
demªdMissR©e
 = 
demªdMis£s
 / 
demªdAcûs£s
;

362 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

363 
demªdMissR©e
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

366 
ov”®lMissR©e


367 .
	`Çme
(name() + ".overall_miss_rate")

368 .
	`desc
("miss„ate for overall‡ccesses")

369 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

371 
ov”®lMissR©e
 = 
ov”®lMis£s
 / 
ov”®lAcûs£s
;

372 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

373 
ov”®lMissR©e
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

377 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

378 
MemCmd
 
	`cmd
(
acûss_idx
);

379 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

381 
avgMissL©’cy
[
acûss_idx
]

382 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_avg_miss_latency")

383 .
	`desc
("av”ag" + 
c¡r
 + " miss†atency")

384 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

386 
avgMissL©’cy
[
acûss_idx
] =

387 
missL©’cy
[
acûss_idx
] / 
mis£s
[access_idx];

389 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

390 
avgMissL©’cy
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

394 
demªdAvgMissL©’cy


395 .
	`Çme
(name() + ".demand_avg_miss_latency")

396 .
	`desc
("average overall miss†atency")

397 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

399 
demªdAvgMissL©’cy
 = 
demªdMissL©’cy
 / 
demªdMis£s
;

400 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

401 
demªdAvgMissL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

404 
ov”®lAvgMissL©’cy


405 .
	`Çme
(name() + ".overall_avg_miss_latency")

406 .
	`desc
("average overall miss†atency")

407 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

409 
ov”®lAvgMissL©’cy
 = 
ov”®lMissL©’cy
 / 
ov”®lMis£s
;

410 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

411 
ov”®lAvgMissL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

414 
blocked_cyşes
.
	`š™
(
NUM_BLOCKED_CAUSES
);

415 
blocked_cyşes


416 .
	`Çme
(name() + ".blocked_cycles")

417 .
	`desc
("number of cycles‡ccess was blocked")

418 .
	`subÇme
(
Blocked_NoMSHRs
, "no_mshrs")

419 .
	`subÇme
(
Blocked_NoT¬g‘s
, "no_targets")

423 
blocked_ÿu£s
.
	`š™
(
NUM_BLOCKED_CAUSES
);

424 
blocked_ÿu£s


425 .
	`Çme
(name() + ".blocked")

426 .
	`desc
("number of cycles‡ccess was blocked")

427 .
	`subÇme
(
Blocked_NoMSHRs
, "no_mshrs")

428 .
	`subÇme
(
Blocked_NoT¬g‘s
, "no_targets")

431 
avg_blocked


432 .
	`Çme
(name() + ".avg_blocked_cycles")

433 .
	`desc
("average‚umber of cyclesƒach‡ccess was blocked")

434 .
	`subÇme
(
Blocked_NoMSHRs
, "no_mshrs")

435 .
	`subÇme
(
Blocked_NoT¬g‘s
, "no_targets")

438 
avg_blocked
 = 
blocked_cyşes
 / 
blocked_ÿu£s
;

440 
unu£dP»ãtches


441 .
	`Çme
(name() + ".unused_prefetches")

442 .
	`desc
("number of HardPF blocksƒvicted w/o„eference")

443 .
	`æags
(
noz”o
)

446 
wr™ebacks


447 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

448 .
	`Çme
(name() + ".writebacks")

449 .
	`desc
("number of writebacks")

450 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

452 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

453 
wr™ebacks
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

458 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

459 
MemCmd
 
	`cmd
(
acûss_idx
);

460 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

462 
mshr_h™s
[
acûss_idx
]

463 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

464 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_mshr_hits")

465 .
	`desc
("numb” oà" + 
c¡r
 + " MSHR hits")

466 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

468 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

469 
mshr_h™s
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

473 
demªdMshrH™s


474 .
	`Çme
(name() + ".demand_mshr_hits")

475 .
	`desc
("number of demand (read+write) MSHR hits")

476 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

478 
demªdMshrH™s
 = 
	`SUM_DEMAND
(
mshr_h™s
);

479 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

480 
demªdMshrH™s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

483 
ov”®lMshrH™s


484 .
	`Çme
(name() + ".overall_mshr_hits")

485 .
	`desc
("number of overall MSHR hits")

486 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

488 
ov”®lMshrH™s
 = 
demªdMshrH™s
 + 
	`SUM_NON_DEMAND
(
mshr_h™s
);

489 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

490 
ov”®lMshrH™s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

494 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

495 
MemCmd
 
	`cmd
(
acûss_idx
);

496 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

498 
mshr_mis£s
[
acûss_idx
]

499 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

500 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_mshr_misses")

501 .
	`desc
("numb” oà" + 
c¡r
 + " MSHR misses")

502 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

504 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

505 
mshr_mis£s
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

509 
demªdMshrMis£s


510 .
	`Çme
(name() + ".demand_mshr_misses")

511 .
	`desc
("number of demand (read+write) MSHR misses")

512 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

514 
demªdMshrMis£s
 = 
	`SUM_DEMAND
(
mshr_mis£s
);

515 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

516 
demªdMshrMis£s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

519 
ov”®lMshrMis£s


520 .
	`Çme
(name() + ".overall_mshr_misses")

521 .
	`desc
("number of overall MSHR misses")

522 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

524 
ov”®lMshrMis£s
 = 
demªdMshrMis£s
 + 
	`SUM_NON_DEMAND
(
mshr_mis£s
);

525 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

526 
ov”®lMshrMis£s
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

530 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

531 
MemCmd
 
	`cmd
(
acûss_idx
);

532 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

534 
mshr_miss_Ï‹ncy
[
acûss_idx
]

535 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

536 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_mshr_miss_latency")

537 .
	`desc
("numb” oà" + 
c¡r
 + " MSHR miss cycles")

538 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

540 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

541 
mshr_miss_Ï‹ncy
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

545 
demªdMshrMissL©’cy


546 .
	`Çme
(name() + ".demand_mshr_miss_latency")

547 .
	`desc
("number of demand (read+write) MSHR miss cycles")

548 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

550 
demªdMshrMissL©’cy
 = 
	`SUM_DEMAND
(
mshr_miss_Ï‹ncy
);

551 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

552 
demªdMshrMissL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

555 
ov”®lMshrMissL©’cy


556 .
	`Çme
(name() + ".overall_mshr_miss_latency")

557 .
	`desc
("number of overall MSHR miss cycles")

558 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

560 
ov”®lMshrMissL©’cy
 =

561 
demªdMshrMissL©’cy
 + 
	`SUM_NON_DEMAND
(
mshr_miss_Ï‹ncy
);

562 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

563 
ov”®lMshrMissL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

567 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

568 
MemCmd
 
	`cmd
(
acûss_idx
);

569 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

571 
mshr_unÿch—bË
[
acûss_idx
]

572 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

573 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_mshr_uncacheable")

574 .
	`desc
("numb” oà" + 
c¡r
 + " MSHR uncacheable")

575 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

577 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

578 
mshr_unÿch—bË
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

582 
ov”®lMshrUnÿch—bË


583 .
	`Çme
(name() + ".overall_mshr_uncacheable_misses")

584 .
	`desc
("number of overall MSHR uncacheable misses")

585 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

587 
ov”®lMshrUnÿch—bË
 =

588 
	`SUM_DEMAND
(
mshr_unÿch—bË
è+ 
	`SUM_NON_DEMAND
(mshr_uncacheable);

589 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

590 
ov”®lMshrUnÿch—bË
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

594 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

595 
MemCmd
 
	`cmd
(
acûss_idx
);

596 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

598 
mshr_unÿch—bË_Ït
[
acûss_idx
]

599 .
	`š™
(
sy¡em
->
	`maxMa¡”s
())

600 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_mshr_uncacheable_latency")

601 .
	`desc
("numb” oà" + 
c¡r
 + " MSHR uncacheable cycles")

602 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

604 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

605 
mshr_unÿch—bË_Ït
[
acûss_idx
].
	`subÇme
(

606 
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

610 
ov”®lMshrUnÿch—bËL©’cy


611 .
	`Çme
(name() + ".overall_mshr_uncacheable_latency")

612 .
	`desc
("number of overall MSHR uncacheable cycles")

613 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

615 
ov”®lMshrUnÿch—bËL©’cy
 =

616 
	`SUM_DEMAND
(
mshr_unÿch—bË_Ït
) +

617 
	`SUM_NON_DEMAND
(
mshr_unÿch—bË_Ït
);

618 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

619 
ov”®lMshrUnÿch—bËL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

624 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

625 
MemCmd
 
	`cmd
(
acûss_idx
);

626 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

628 
mshrAcûs£s
[
acûss_idx
]

629 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_mshr_accesses")

630 .
	`desc
("numb” oà" + 
c¡r
 + " mshr‡ccesses(hits+misses)")

631 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

633 
mshrAcûs£s
[
acûss_idx
] =

634 
mshr_h™s
[
acûss_idx
] + 
mshr_mis£s
[access_idx]

635 + 
mshr_unÿch—bË
[
acûss_idx
];

638 
demªdMshrAcûs£s


639 .
	`Çme
(name() + ".demand_mshr_accesses")

640 .
	`desc
("number of demand (read+write) mshr‡ccesses")

641 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

643 
demªdMshrAcûs£s
 = 
demªdMshrH™s
 + 
demªdMshrMis£s
;

645 
ov”®lMshrAcûs£s


646 .
	`Çme
(name() + ".overall_mshr_accesses")

647 .
	`desc
("number of overall (read+write) mshr‡ccesses")

648 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

650 
ov”®lMshrAcûs£s
 = 
ov”®lMshrH™s
 + 
ov”®lMshrMis£s


651 + 
ov”®lMshrUnÿch—bË
;

655 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

656 
MemCmd
 
	`cmd
(
acûss_idx
);

657 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

659 
mshrMissR©e
[
acûss_idx
]

660 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_mshr_miss_rate")

661 .
	`desc
("msh¸mis ¿‹ fÜ " + 
c¡r
 + "‡ccesses")

662 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

664 
mshrMissR©e
[
acûss_idx
] =

665 
mshr_mis£s
[
acûss_idx
] / 
acûs£s
[access_idx];

667 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

668 
mshrMissR©e
[
acûss_idx
].
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

672 
demªdMshrMissR©e


673 .
	`Çme
(name() + ".demand_mshr_miss_rate")

674 .
	`desc
("mshr miss„ate for demand‡ccesses")

675 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

677 
demªdMshrMissR©e
 = 
demªdMshrMis£s
 / 
demªdAcûs£s
;

678 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

679 
demªdMshrMissR©e
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

682 
ov”®lMshrMissR©e


683 .
	`Çme
(name() + ".overall_mshr_miss_rate")

684 .
	`desc
("mshr miss„ate for overall‡ccesses")

685 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

687 
ov”®lMshrMissR©e
 = 
ov”®lMshrMis£s
 / 
ov”®lAcûs£s
;

688 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

689 
ov”®lMshrMissR©e
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

693 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

694 
MemCmd
 
	`cmd
(
acûss_idx
);

695 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

697 
avgMshrMissL©’cy
[
acûss_idx
]

698 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_avg_mshr_miss_latency")

699 .
	`desc
("av”ag" + 
c¡r
 + " mshr miss†atency")

700 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

702 
avgMshrMissL©’cy
[
acûss_idx
] =

703 
mshr_miss_Ï‹ncy
[
acûss_idx
] / 
mshr_mis£s
[access_idx];

705 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

706 
avgMshrMissL©’cy
[
acûss_idx
].
	`subÇme
(

707 
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

711 
demªdAvgMshrMissL©’cy


712 .
	`Çme
(name() + ".demand_avg_mshr_miss_latency")

713 .
	`desc
("average overall mshr miss†atency")

714 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

716 
demªdAvgMshrMissL©’cy
 = 
demªdMshrMissL©’cy
 / 
demªdMshrMis£s
;

717 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

718 
demªdAvgMshrMissL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

721 
ov”®lAvgMshrMissL©’cy


722 .
	`Çme
(name() + ".overall_avg_mshr_miss_latency")

723 .
	`desc
("average overall mshr miss†atency")

724 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

726 
ov”®lAvgMshrMissL©’cy
 = 
ov”®lMshrMissL©’cy
 / 
ov”®lMshrMis£s
;

727 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

728 
ov”®lAvgMshrMissL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

732 
acûss_idx
 = 0;‡cûss_idx < 
MemCmd
::
NUM_MEM_CMDS
; ++access_idx) {

733 
MemCmd
 
	`cmd
(
acûss_idx
);

734 cÚ¡ 
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

736 
avgMshrUnÿch—bËL©’cy
[
acûss_idx
]

737 .
	`Çme
Òame(è+ "." + 
c¡r
 + "_avg_mshr_uncacheable_latency")

738 .
	`desc
("av”ag" + 
c¡r
 + " mshr uncacheable†atency")

739 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

741 
avgMshrUnÿch—bËL©’cy
[
acûss_idx
] =

742 
mshr_unÿch—bË_Ït
[
acûss_idx
] / 
mshr_unÿch—bË
[access_idx];

744 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

745 
avgMshrUnÿch—bËL©’cy
[
acûss_idx
].
	`subÇme
(

746 
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

750 
ov”®lAvgMshrUnÿch—bËL©’cy


751 .
	`Çme
(name() + ".overall_avg_mshr_uncacheable_latency")

752 .
	`desc
("average overall mshr uncacheable†atency")

753 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
)

755 
ov”®lAvgMshrUnÿch—bËL©’cy
 =

756 
ov”®lMshrUnÿch—bËL©’cy
 / 
ov”®lMshrUnÿch—bË
;

757 
i
 = 0; i < 
sy¡em
->
	`maxMa¡”s
(); i++) {

758 
ov”®lAvgMshrUnÿch—bËL©’cy
.
	`subÇme
(
i
, 
sy¡em
->
	`g‘Ma¡”Name
(i));

761 
	}
}

	@cache/base.hh

50 #iâdeà
__MEM_CACHE_BASE_HH__


51 
	#__MEM_CACHE_BASE_HH__


	)

53 
	~<®gÜ™hm
>

54 
	~<li¡
>

55 
	~<¡ršg
>

56 
	~<veùÜ
>

58 
	~"ba£/misc.hh
"

59 
	~"ba£/¡©i¡ics.hh
"

60 
	~"ba£/Œaû.hh
"

61 
	~"ba£/ty³s.hh
"

62 
	~"debug/Cache.hh
"

63 
	~"debug/CachePÜt.hh
"

64 
	~"mem/ÿche/mshr_queue.hh
"

65 
	~"mem/ÿche/wr™e_queue.hh
"

66 
	~"mem/mem_objeù.hh
"

67 
	~"mem/·ck‘.hh
"

68 
	~"mem/qpÜt.hh
"

69 
	~"mem/»que¡.hh
"

70 
	~"·¿ms/Ba£Cache.hh
"

71 
	~"sim/ev’tq.hh
"

72 
	~"sim/fuÎ_sy¡em.hh
"

73 
	~"sim/sim_ex™.hh
"

74 
	~"sim/sy¡em.hh
"

79 şas 
	cBa£Cache
 : 
public
 
MemObjeù


81 
´Ùeùed
:

85 
	eMSHRQueueIndex
 {

86 
MSHRQueue_MSHRs
,

87 
	mMSHRQueue_Wr™eBufãr


90 
	gpublic
:

94 
	eBlockedCau£
 {

95 
Blocked_NoMSHRs
 = 
MSHRQueue_MSHRs
,

96 
	gBlocked_NoWBBufãrs
 = 
MSHRQueue_Wr™eBufãr
,

97 
	gBlocked_NoT¬g‘s
,

98 
	gNUM_BLOCKED_CAUSES


101 
	g´Ùeùed
:

112 şas 
	cCacheMa¡”PÜt
 : 
public
 
QueuedMa¡”PÜt


115 
public
:

121 
schedS’dEv’t
(
Tick
 
time
)

123 
DPRINTF
(
CachePÜt
, "Schedulšg s’dƒv’ˆ© %Îu\n", 
time
);

124 
	g»qQueue
.
schedS’dEv’t
(
time
);

127 
	g´Ùeùed
:

129 
CacheMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
Ba£Cache
 *
_ÿche
,

130 
ReqPack‘Queue
 &
_»qQueue
,

131 
SnoİRe¥Pack‘Queue
 &
_¢oİRe¥Queue
) :

132 
QueuedMa¡”PÜt
(
_Çme
, 
_ÿche
, 
_»qQueue
, 
_¢oİRe¥Queue
)

140 
vœtu®
 
boŞ
 
isSnoİšg
(ècÚ¡ {  
	gŒue
; }

151 şas 
	cCacheSÏvePÜt
 : 
public
 
QueuedSÏvePÜt


154 
public
:

157 
£tBlocked
();

160 
ş—rBlocked
();

162 
boŞ
 
isBlocked
(ècÚ¡ {  
	gblocked
; }

164 
	g´Ùeùed
:

166 
CacheSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
Ba£Cache
 *
_ÿche
,

167 cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
);

170 
Re¥Pack‘Queue
 
	gqueue
;

172 
boŞ
 
	gblocked
;

174 
boŞ
 
	gmu¡S’dR‘ry
;

176 
	g´iv©e
:

178 
´oûssS’dR‘ry
();

180 
	gEv’tW¿µ”
<
	gCacheSÏvePÜt
,

181 &
	gCacheSÏvePÜt
::
´oûssS’dR‘ry
> 
£ndR‘ryEv’t
;

185 
CacheSÏvePÜt
 *
	gıuSidePÜt
;

186 
CacheMa¡”PÜt
 *
	gmemSidePÜt
;

188 
	g´Ùeùed
:

191 
MSHRQueue
 
mshrQueue
;

194 
Wr™eQueue
 
	gwr™eBufãr
;

200 
	$m¬kInS”viû
(
MSHR
 *
mshr
, 
boŞ
 
³ndšg_modif›d_»¥
)

202 
boŞ
 
wasFuÎ
 = 
mshrQueue
.
	`isFuÎ
();

203 
mshrQueue
.
	`m¬kInS”viû
(
mshr
, 
³ndšg_modif›d_»¥
);

205 ià(
wasFuÎ
 && !
mshrQueue
.
	`isFuÎ
()) {

206 
	`ş—rBlocked
(
Blocked_NoMSHRs
);

208 
	}
}

210 
	$m¬kInS”viû
(
Wr™eQueueEÁry
 *
’Œy
)

212 
boŞ
 
wasFuÎ
 = 
wr™eBufãr
.
	`isFuÎ
();

213 
wr™eBufãr
.
	`m¬kInS”viû
(
’Œy
);

215 ià(
wasFuÎ
 && !
wr™eBufãr
.
	`isFuÎ
()) {

216 
	`ş—rBlocked
(
Blocked_NoWBBufãrs
);

218 
	}
}

227 
vœtu®
 
boŞ
 
	$®locOnFl
(
MemCmd
 
cmd
) const = 0;

232 
vœtu®
 
	`memWr™eback
() = 0;

240 
vœtu®
 
	`memInv®id©e
() = 0;

246 
vœtu®
 
boŞ
 
	$isDœty
() const = 0;

256 
boŞ
 
	$šRªge
(
Addr
 
addr
) const;

259 cÚ¡ 
blkSize
;

265 cÚ¡ 
Cyşes
 
lookupL©’cy
;

272 cÚ¡ 
Cyşes
 
fÜw¬dL©’cy
;

275 cÚ¡ 
Cyşes
 
flL©’cy
;

282 cÚ¡ 
Cyşes
 
»¥Ú£L©’cy
;

285 cÚ¡ 
numT¬g‘
;

288 
boŞ
 
fÜw¬dSnoİs
;

296 cÚ¡ 
boŞ
 
isR—dOÆy
;

302 
ušt8_t
 
blocked
;

305 
ušt64_t
 
Üd”
;

308 
Cyşes
 
blockedCyşe
;

311 
MSHR
 *
noT¬g‘MSHR
;

314 
CouÁ”
 
missCouÁ
;

319 cÚ¡ 
AddrRªgeLi¡
 
addrRªges
;

321 
public
:

323 
Sy¡em
 *
sy¡em
;

333 
Sts
::
VeùÜ
 
h™s
[
MemCmd
::
NUM_MEM_CMDS
];

335 
Sts
::
FÜmuÏ
 
demªdH™s
;

337 
Sts
::
FÜmuÏ
 
ov”®lH™s
;

341 
Sts
::
VeùÜ
 
mis£s
[
MemCmd
::
NUM_MEM_CMDS
];

343 
Sts
::
FÜmuÏ
 
demªdMis£s
;

345 
Sts
::
FÜmuÏ
 
ov”®lMis£s
;

351 
Sts
::
VeùÜ
 
missL©’cy
[
MemCmd
::
NUM_MEM_CMDS
];

353 
Sts
::
FÜmuÏ
 
demªdMissL©’cy
;

355 
Sts
::
FÜmuÏ
 
ov”®lMissL©’cy
;

358 
Sts
::
FÜmuÏ
 
acûs£s
[
MemCmd
::
NUM_MEM_CMDS
];

360 
Sts
::
FÜmuÏ
 
demªdAcûs£s
;

362 
Sts
::
FÜmuÏ
 
ov”®lAcûs£s
;

365 
Sts
::
FÜmuÏ
 
missR©e
[
MemCmd
::
NUM_MEM_CMDS
];

367 
Sts
::
FÜmuÏ
 
demªdMissR©e
;

369 
Sts
::
FÜmuÏ
 
ov”®lMissR©e
;

372 
Sts
::
FÜmuÏ
 
avgMissL©’cy
[
MemCmd
::
NUM_MEM_CMDS
];

374 
Sts
::
FÜmuÏ
 
demªdAvgMissL©’cy
;

376 
Sts
::
FÜmuÏ
 
ov”®lAvgMissL©’cy
;

379 
Sts
::
VeùÜ
 
blocked_cyşes
;

381 
Sts
::
VeùÜ
 
blocked_ÿu£s
;

384 
Sts
::
FÜmuÏ
 
avg_blocked
;

387 
Sts
::
SÿÏr
 
unu£dP»ãtches
;

390 
Sts
::
VeùÜ
 
wr™ebacks
;

393 
Sts
::
VeùÜ
 
mshr_h™s
[
MemCmd
::
NUM_MEM_CMDS
];

395 
Sts
::
FÜmuÏ
 
demªdMshrH™s
;

397 
Sts
::
FÜmuÏ
 
ov”®lMshrH™s
;

400 
Sts
::
VeùÜ
 
mshr_mis£s
[
MemCmd
::
NUM_MEM_CMDS
];

402 
Sts
::
FÜmuÏ
 
demªdMshrMis£s
;

404 
Sts
::
FÜmuÏ
 
ov”®lMshrMis£s
;

407 
Sts
::
VeùÜ
 
mshr_unÿch—bË
[
MemCmd
::
NUM_MEM_CMDS
];

409 
Sts
::
FÜmuÏ
 
ov”®lMshrUnÿch—bË
;

412 
Sts
::
VeùÜ
 
mshr_miss_Ï‹ncy
[
MemCmd
::
NUM_MEM_CMDS
];

414 
Sts
::
FÜmuÏ
 
demªdMshrMissL©’cy
;

416 
Sts
::
FÜmuÏ
 
ov”®lMshrMissL©’cy
;

419 
Sts
::
VeùÜ
 
mshr_unÿch—bË_Ït
[
MemCmd
::
NUM_MEM_CMDS
];

421 
Sts
::
FÜmuÏ
 
ov”®lMshrUnÿch—bËL©’cy
;

425 
Sts
::
FÜmuÏ
 
mshrAcûs£s
[
MemCmd
::
NUM_MEM_CMDS
];

427 
Sts
::
FÜmuÏ
 
demªdMshrAcûs£s
;

429 
Sts
::
FÜmuÏ
 
ov”®lMshrAcûs£s
;

433 
Sts
::
FÜmuÏ
 
mshrMissR©e
[
MemCmd
::
NUM_MEM_CMDS
];

435 
Sts
::
FÜmuÏ
 
demªdMshrMissR©e
;

437 
Sts
::
FÜmuÏ
 
ov”®lMshrMissR©e
;

440 
Sts
::
FÜmuÏ
 
avgMshrMissL©’cy
[
MemCmd
::
NUM_MEM_CMDS
];

442 
Sts
::
FÜmuÏ
 
demªdAvgMshrMissL©’cy
;

444 
Sts
::
FÜmuÏ
 
ov”®lAvgMshrMissL©’cy
;

447 
Sts
::
FÜmuÏ
 
avgMshrUnÿch—bËL©’cy
[
MemCmd
::
NUM_MEM_CMDS
];

449 
Sts
::
FÜmuÏ
 
ov”®lAvgMshrUnÿch—bËL©’cy
;

458 
vœtu®
 
	`»gSts
();

460 
public
:

461 
	`Ba£Cache
(cÚ¡ 
Ba£CacheP¬ams
 *
p
, 
blk_size
);

462 ~
	$Ba£Cache
(è{
	}
}

464 
vœtu®
 
š™
();

466 
vœtu®
 
	gBa£Ma¡”PÜt
 &
g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

467 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

468 
vœtu®
 
	gBa£SÏvePÜt
 &
g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

469 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

476 
	$g‘BlockSize
() const

478  
blkSize
;

479 
	}
}

482 
Addr
 
	$blockAlign
(
Addr
 
addr
ècÚ¡ {  (add¸& ~(
	`Addr
(
blkSize
 - 1))); 
	}
}

485 cÚ¡ 
	gAddrRªgeLi¡
 &
	$g‘AddrRªges
(ècÚ¡ {  
addrRªges
; 
	}
}

487 
MSHR
 *
	$®loÿ‹MissBufãr
(
Pack‘PŒ
 
pkt
, 
Tick
 
time
, 
boŞ
 
sched_£nd
 = 
Œue
)

489 
MSHR
 *
mshr
 = 
mshrQueue
.
	`®loÿ‹
(
	`blockAlign
(
pkt
->
	`g‘Addr
()), 
blkSize
,

490 
pkt
, 
time
, 
Üd”
++,

491 
	`®locOnFl
(
pkt
->
cmd
));

493 ià(
mshrQueue
.
	`isFuÎ
()) {

494 
	`£tBlocked
((
BlockedCau£
)
MSHRQueue_MSHRs
);

497 ià(
sched_£nd
) {

499 
	`schedMemSideS’dEv’t
(
time
);

502  
mshr
;

503 
	}
}

505 
	$®loÿ‹Wr™eBufãr
(
Pack‘PŒ
 
pkt
, 
Tick
 
time
)

508 
	`as£¹
(
pkt
->
	`isWr™e
(è||…kt->
cmd
 =ğ
MemCmd
::
CËªEviù
);

510 
Addr
 
blk_addr
 = 
	`blockAlign
(
pkt
->
	`g‘Addr
());

512 
Wr™eQueueEÁry
 *
wq_’Œy
 =

513 
wr™eBufãr
.
	`fšdM©ch
(
blk_addr
, 
pkt
->
	`isSecu»
());

514 ià(
wq_’Œy
 && !wq_’Œy->
šS”viû
) {

515 
	`DPRINTF
(
Cache
, "Potentialo merge writeback %so %#llx",

516 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

519 
wr™eBufãr
.
	`®loÿ‹
(
blk_addr
, 
blkSize
, 
pkt
, 
time
, 
Üd”
++);

521 ià(
wr™eBufãr
.
	`isFuÎ
()) {

522 
	`£tBlocked
((
BlockedCau£
)
MSHRQueue_Wr™eBufãr
);

526 
	`schedMemSideS’dEv’t
(
time
);

527 
	}
}

532 
boŞ
 
	$isBlocked
() const

534  
blocked
 != 0;

535 
	}
}

542 
	$£tBlocked
(
BlockedCau£
 
ÿu£
)

544 
ušt8_t
 
æag
 = 1 << 
ÿu£
;

545 ià(
blocked
 == 0) {

546 
blocked_ÿu£s
[
ÿu£
]++;

547 
blockedCyşe
 = 
	`curCyşe
();

548 
ıuSidePÜt
->
	`£tBlocked
();

550 
blocked
 |ğ
æag
;

551 
	`DPRINTF
(
Cache
,"Blockšg fÜ cau£ %d, mask=%d\n", 
ÿu£
, 
blocked
);

552 
	}
}

561 
	$ş—rBlocked
(
BlockedCau£
 
ÿu£
)

563 
ušt8_t
 
æag
 = 1 << 
ÿu£
;

564 
blocked
 &ğ~
æag
;

565 
	`DPRINTF
(
Cache
,"Unblockšg fÜ cau£ %d, mask=%d\n", 
ÿu£
, 
blocked
);

566 ià(
blocked
 == 0) {

567 
blocked_cyşes
[
ÿu£
] +ğ
	`curCyşe
(è- 
blockedCyşe
;

568 
ıuSidePÜt
->
	`ş—rBlocked
();

570 
	}
}

580 
	$schedMemSideS’dEv’t
(
Tick
 
time
)

582 
memSidePÜt
->
	`schedS’dEv’t
(
time
);

583 
	}
}

585 
vœtu®
 
boŞ
 
	$šCache
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const = 0;

587 
vœtu®
 
boŞ
 
	$šMissQueue
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const = 0;

589 
	$šcMissCouÁ
(
Pack‘PŒ
 
pkt
)

591 
	`as£¹
(
pkt
->
»q
->
	`ma¡”Id
(è< 
sy¡em
->
	`maxMa¡”s
());

592 
mis£s
[
pkt
->
	`cmdToIndex
()][pkt->
»q
->
	`ma¡”Id
()]++;

593 
pkt
->
»q
->
	`šcAcûssD•th
();

594 ià(
missCouÁ
) {

595 --
missCouÁ
;

596 ià(
missCouÁ
 == 0)

597 
	`ex™SimLoİ
("A cache„eachedhe maximum miss count");

599 
	}
}

600 
	$šcH™CouÁ
(
Pack‘PŒ
 
pkt
)

602 
	`as£¹
(
pkt
->
»q
->
	`ma¡”Id
(è< 
sy¡em
->
	`maxMa¡”s
());

603 
h™s
[
pkt
->
	`cmdToIndex
()][pkt->
»q
->
	`ma¡”Id
()]++;

605 
	}
}

	@cache/blk.cc

41 
	~"mem/ÿche/blk.hh
"

43 
	~"ba£/ırštf.hh
"

46 
	gCacheBlkPrštW¿µ”
::
	$´št
(
¡d
::
o¡»am
 &
os
, 
v”bos™y
,

47 cÚ¡ 
¡d
::
¡ršg
 &
´efix
) const

49 
	`cırštf
(
os
, "%sblk %c%c%c%c\n", 
´efix
,

50 
blk
->
	`isV®id
() ? 'V' : '-',

51 
blk
->
	`isWr™abË
() ? 'E' : '-',

52 
blk
->
	`isDœty
() ? 'M' : '-',

53 
blk
->
	`isSecu»
() ? 'S' : '-');

54 
	}
}

	@cache/blk.hh

48 #iâdeà
__MEM_CACHE_BLK_HH__


49 
	#__MEM_CACHE_BLK_HH__


	)

51 
	~<li¡
>

53 
	~"ba£/´šbË.hh
"

54 
	~"mem/·ck‘.hh
"

55 
	~"mem/»que¡.hh
"

60 
	gCacheBlkStusB™s
 : {

62 
BlkV®id
 = 0x01,

64 
	gBlkWr™abË
 = 0x02,

66 
	gBlkR—dabË
 = 0x04,

68 
	gBlkDœty
 = 0x08,

70 
	gBlkHWP»ãtched
 = 0x20,

72 
	gBlkSecu»
 = 0x40,

79 şas 
	cCacheBlk


81 
	mpublic
:

83 
ušt32_t
 
sk_id
;

86 
	masid
;

88 
Addr
 
	mg
;

96 
ušt8_t
 *
	md©a
;

98 
	msize
;

101 
	tS‹
;

104 
S‹
 
	m¡©us
;

107 
Tick
 
	mwh’R—dy
;

113 
	m£t
, 
	mway
;

116 
boŞ
 
	misTouched
;

119 
	m»fCouÁ
;

122 
	m¤cMa¡”Id
;

124 
Tick
 
	mtickIn£¹ed
;

126 
	m´Ùeùed
:

131 şas 
	cLock
 {

132 
public
:

133 
CÚ‹xtID
 
cÚ‹xtId
;

134 
Addr
 
	mlowAddr
;

135 
Addr
 
	mhighAddr
;

139 
boŞ
 
m©ches
(cÚ¡ 
Reque¡PŒ
 
»q
) const

141 
Addr
 
	m»q_low
 = 
»q
->
g‘Paddr
();

142 
Addr
 
	m»q_high
 = 
»q_low
 + 
»q
->
g‘Size
() -1;

143  (
	mcÚ‹xtId
 =ğ
»q
->
cÚ‹xtId
()) &&

144 (
»q_low
 >ğ
lowAddr
è&& (
»q_high
 <ğ
highAddr
);

148 
boŞ
 
š‹r£ùs
(cÚ¡ 
Reque¡PŒ
 
»q
) const

150 
Addr
 
	m»q_low
 = 
»q
->
g‘Paddr
();

151 
Addr
 
	m»q_high
 = 
»q_low
 + 
»q
->
g‘Size
() - 1;

153  (
	m»q_low
 <ğ
highAddr
è&& (
»q_high
 >ğ
lowAddr
);

156 
Lock
(cÚ¡ 
Reque¡PŒ
 
»q
)

157 : 
cÚ‹xtId
(
»q
->contextId()),

158 
lowAddr
(
»q
->
g‘Paddr
()),

159 
highAddr
(
lowAddr
 + 
»q
->
g‘Size
() - 1)

166 
	g¡d
::
li¡
<
Lock
> 
lockLi¡
;

168 
	gpublic
:

170 
	$CacheBlk
()

171 : 
	`sk_id
(
CÚ‹xtSw™chTaskId
::
Unknown
),

172 
	`asid
(-1), 
	`g
(0), 
	`d©a
(0è,
	`size
(0), 
	`¡©us
(0), 
	`wh’R—dy
(0),

173 
	`£t
(-1), 
	`way
(-1), 
	`isTouched
(
çl£
), 
	`»fCouÁ
(0),

174 
	`¤cMa¡”Id
(
Reque¡
::
švldMa¡”Id
),

175 
	$tickIn£¹ed
(0)

176 {
	}
}

178 
CacheBlk
(cÚ¡ CacheBlk&èğ
d–‘e
;

179 
	gCacheBlk
& 
	gİ”©Ü
=(cÚ¡ 
CacheBlk
&èğ
d–‘e
;

185 
boŞ
 
	$isWr™abË
() const

187 cÚ¡ 
S‹
 
Ãeded_b™s
 = 
BlkWr™abË
 | 
BlkV®id
;

188  (
¡©us
 & 
Ãeded_b™s
) ==‚eeded_bits;

189 
	}
}

197 
boŞ
 
	$isR—dabË
() const

199 cÚ¡ 
S‹
 
Ãeded_b™s
 = 
BlkR—dabË
 | 
BlkV®id
;

200  (
¡©us
 & 
Ãeded_b™s
) ==‚eeded_bits;

201 
	}
}

207 
boŞ
 
	$isV®id
() const

209  (
¡©us
 & 
BlkV®id
) != 0;

210 
	}
}

215 
	$šv®id©e
()

217 
¡©us
 = 0;

218 
isTouched
 = 
çl£
;

219 
lockLi¡
.
	`ş—r
();

220 
	}
}

226 
boŞ
 
	$isDœty
() const

228  (
¡©us
 & 
BlkDœty
) != 0;

229 
	}
}

236 
boŞ
 
	$wasP»ãtched
() const

238  (
¡©us
 & 
BlkHWP»ãtched
) != 0;

239 
	}
}

245 
boŞ
 
	$isSecu»
() const

247  (
¡©us
 & 
BlkSecu»
) != 0;

248 
	}
}

254 
	$ŒackLßdLocked
(
Pack‘PŒ
 
pkt
)

256 
	`as£¹
(
pkt
->
	`isLLSC
());

257 autØ
l
 = 
lockLi¡
.
	`begš
();

258 
l
 !ğ
lockLi¡
.
	`’d
()) {

259 ià(
l
->
	`š‹r£ùs
(
pkt
->
»q
))

260 
l
 = 
lockLi¡
.
	`”a£
(l);

262 ++
l
;

265 
lockLi¡
.
	`em¶aû_äÚt
(
pkt
->
»q
);

266 
	}
}

272 
	$ş—rLßdLocks
(
Reque¡PŒ
 
»q
)

274 autØ
l
 = 
lockLi¡
.
	`begš
();

275 
l
 !ğ
lockLi¡
.
	`’d
()) {

276 ià(
l
->
	`š‹r£ùs
(
»q
è&&†->
cÚ‹xtId
 !ğ»q->
	`cÚ‹xtId
()) {

277 
l
 = 
lockLi¡
.
	`”a£
(l);

279 ++
l
;

282 
	}
}

290 
	g¡d
::
¡ršg
 
	$´št
() const

316 
¡©e
 = 
	`isWr™abË
(è<< 2 | 
	`isDœty
(è<< 1 | 
	`isV®id
();

317 
s
 = '?';

318 
¡©e
) {

319 0b111: 
s
 = 'M'; ;

320 0b011: 
s
 = 'O'; ;

321 0b101: 
s
 = 'E'; ;

322 0b001: 
s
 = 'S'; ;

323 0b000: 
s
 = 'I'; ;

324 : 
s
 = 'T'; ;

326  
	`c¥rštf
("state: %x (%c) valid: %d writable: %d„eadable: %d "

327 "dœty: %dag: %x", 
¡©us
, 
s
, 
	`isV®id
(),

328 
	`isWr™abË
(), 
	`isR—dabË
(), 
	`isDœty
(), 
g
);

329 
	}
}

336 
boŞ
 
	$checkWr™e
(
Pack‘PŒ
 
pkt
)

338 
	`as£¹
(
pkt
->
	`isWr™e
());

341 ià(!
pkt
->
	`isLLSC
(è&& 
lockLi¡
.
	`em±y
())

342  
Œue
;

344 
Reque¡PŒ
 
»q
 = 
pkt
->req;

346 ià(
pkt
->
	`isLLSC
()) {

349 
boŞ
 
sucûss
 = 
çl£
;

351 autØ
l
 = 
lockLi¡
.
	`begš
();

352 !
sucûss
 && 
l
 !ğ
lockLi¡
.
	`’d
()) {

353 ià(
l
->
	`m©ches
(
pkt
->
»q
)) {

357 
sucûss
 = 
Œue
;

358 
lockLi¡
.
	`”a£
(
l
);

360 ++
l
;

364 
»q
->
	`£tExŒaD©a
(
sucûss
 ? 1 : 0);

367 
	`ş—rLßdLocks
(
»q
);

368  
sucûss
;

373 
	`ş—rLßdLocks
(
»q
);

374  
Œue
;

376 
	}
}

385 şas 
	cCacheBlkPrštW¿µ”
 : 
public
 
PršbË


387 
CacheBlk
 *
blk
;

388 
	mpublic
:

389 
	$CacheBlkPrštW¿µ”
(
CacheBlk
 *
_blk
è: 
	$blk
(
_blk
) {}

390 
vœtu®
 ~
	$CacheBlkPrštW¿µ”
(è{
	}
}

391 
´št
(
¡d
::
o¡»am
 &
o
, 
v”bos™y
 = 0,

392 cÚ¡ 
¡d
::
¡ršg
 &
´efix
 = "") const;

401 şas 
	cCacheBlkVis™Ü


403 
	mpublic
:

405 
	$CacheBlkVis™Ü
() {}

406 
vœtu®
 ~
	$CacheBlkVis™Ü
(è{
	}
}

408 
vœtu®
 
boŞ
 
	$İ”©Ü
()(
CacheBlk
 &
blk
) = 0;

409 
	}
};

	@cache/cache.cc

54 
	~"mem/ÿche/ÿche.hh
"

56 
	~"ba£/misc.hh
"

57 
	~"ba£/ty³s.hh
"

58 
	~"debug/Cache.hh
"

59 
	~"debug/CachePÜt.hh
"

60 
	~"debug/CacheTags.hh
"

61 
	~"debug/CacheV”bo£.hh
"

62 
	~"mem/ÿche/blk.hh
"

63 
	~"mem/ÿche/mshr.hh
"

64 
	~"mem/ÿche/´eãtch/ba£.hh
"

65 
	~"sim/sim_ex™.hh
"

67 
	gCache
::
	$Cache
(cÚ¡ 
CacheP¬ams
 *
p
)

68 : 
	`Ba£Cache
(
p
,…->
sy¡em
->
	`ÿcheLšeSize
()),

69 
	`gs
(
p
->
gs
),

70 
	`´eãtch”
(
p
->
´eãtch”
),

71 
	`doFa¡Wr™es
(
Œue
),

72 
	`´eãtchOnAcûss
(
p
->
´eãtch_Ú_acûss
),

73 
	`şusiv™y
(
p
->
şusiv™y
),

74 
	`wr™ebackCËª
(
p
->
wr™eback_ş—n
),

75 
	`‹mpBlockWr™eback
(
nuÎ±r
),

76 
	$wr™ebackTempBlockAtomicEv’t
(
this
, 
çl£
,

77 
Ev’tBa£
::
D–ayed_Wr™eback_Pri
)

79 
‹mpBlock
 = 
Ãw
 
	`CacheBlk
();

80 
‹mpBlock
->
d©a
 = 
Ãw
 
ušt8_t
[
blkSize
];

82 
ıuSidePÜt
 = 
Ãw
 
	`CpuSidePÜt
(
p
->
Çme
 + ".ıu_side", 
this
,

84 
memSidePÜt
 = 
Ãw
 
	`MemSidePÜt
(
p
->
Çme
 + ".mem_side", 
this
,

87 
gs
->
	`£tCache
(
this
);

88 ià(
´eãtch”
)

89 
´eãtch”
->
	`£tCache
(
this
);

90 
	}
}

92 
	gCache
::~
	$Cache
()

94 
d–‘e
 [] 
‹mpBlock
->
d©a
;

95 
d–‘e
 
‹mpBlock
;

97 
d–‘e
 
ıuSidePÜt
;

98 
d–‘e
 
memSidePÜt
;

99 
	}
}

102 
	gCache
::
	$»gSts
()

104 
Ba£Cache
::
	`»gSts
();

105 
	}
}

108 
	gCache
::
	$cmpAndSw­
(
CacheBlk
 *
blk
, 
Pack‘PŒ
 
pkt
)

110 
	`as£¹
(
pkt
->
	`isReque¡
());

112 
ušt64_t
 
ov”wr™e_v®
;

113 
boŞ
 
ov”wr™e_mem
;

114 
ušt64_t
 
cÚd™iÚ_v®64
;

115 
ušt32_t
 
cÚd™iÚ_v®32
;

117 
off£t
 = 
gs
->
	`exŒaùBlkOff£t
(
pkt
->
	`g‘Addr
());

118 
ušt8_t
 *
blk_d©a
 = 
blk
->
d©a
 + 
off£t
;

120 
	`as£¹
((
ušt64_t
è>ğ
pkt
->
	`g‘Size
());

122 
ov”wr™e_mem
 = 
Œue
;

125 
pkt
->
	`wr™eD©a
((
ušt8_t
 *)&
ov”wr™e_v®
);

126 
pkt
->
	`£tD©a
(
blk_d©a
);

128 ià(
pkt
->
»q
->
	`isCÚdSw­
()) {

129 ià(
pkt
->
	`g‘Size
(è=ğ(
ušt64_t
)) {

130 
cÚd™iÚ_v®64
 = 
pkt
->
»q
->
	`g‘ExŒaD©a
();

131 
ov”wr™e_mem
 = !
¡d
::
	`memcmp
(&
cÚd™iÚ_v®64
, 
blk_d©a
,

132 (
ušt64_t
));

133 } ià(
pkt
->
	`g‘Size
(è=ğ(
ušt32_t
)) {

134 
cÚd™iÚ_v®32
 = (
ušt32_t
)
pkt
->
»q
->
	`g‘ExŒaD©a
();

135 
ov”wr™e_mem
 = !
¡d
::
	`memcmp
(&
cÚd™iÚ_v®32
, 
blk_d©a
,

136 (
ušt32_t
));

138 
	`·nic
("Invalid size for conditional„ead/write\n");

141 ià(
ov”wr™e_mem
) {

142 
¡d
::
	`memıy
(
blk_d©a
, &
ov”wr™e_v®
, 
pkt
->
	`g‘Size
());

143 
blk
->
¡©us
 |ğ
BlkDœty
;

145 
	}
}

149 
	gCache
::
	$§tisfyReque¡
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
,

150 
boŞ
 
deã¼ed_»¥Ú£
, boŞ 
³ndšg_downg¿de
)

152 
	`as£¹
(
pkt
->
	`isReque¡
());

154 
	`as£¹
(
blk
 && blk->
	`isV®id
());

162 
	`as£¹
(
pkt
->
	`g‘Off£t
(
blkSize
è+…kt->
	`g‘Size
() <= blkSize);

166 ià(
pkt
->
cmd
 =ğ
MemCmd
::
Sw­Req
) {

167 
	`cmpAndSw­
(
blk
, 
pkt
);

168 } ià(
pkt
->
	`isWr™e
()) {

173 
	`as£¹
(
blk
->
	`isWr™abË
());

175 ià(
blk
->
	`checkWr™e
(
pkt
)) {

176 
pkt
->
	`wr™eD©aToBlock
(
blk
->
d©a
, 
blkSize
);

182 
blk
->
¡©us
 |ğ
BlkDœty
;

183 
	`DPRINTF
(
CacheV”bo£
, "%s for %s‡ddr %#llx size %d (write)\n",

184 
__func__
, 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

185 } ià(
pkt
->
	`isR—d
()) {

186 ià(
pkt
->
	`isLLSC
()) {

187 
blk
->
	`ŒackLßdLocked
(
pkt
);

191 
	`as£¹
(
pkt
->
	`hasRe¥D©a
());

192 
pkt
->
	`£tD©aFromBlock
(
blk
->
d©a
, 
blkSize
);

195 ià(
pkt
->
	`äomCache
()) {

196 
	`as£¹
(
pkt
->
	`g‘Size
(è=ğ
blkSize
);

199 ià(
pkt
->
	`ÃedsWr™abË
()) {

201 
	`as£¹
(
pkt
->
cmd
 =ğ
MemCmd
::
R—dExReq
 ||

202 
pkt
->
cmd
 =ğ
MemCmd
::
SCUpg¿deFaReq
);

203 
	`as£¹
(!
pkt
->
	`hasSh¬”s
());

207 ià(
blk
->
	`isDœty
()) {

208 
pkt
->
	`£tCacheRe¥Údšg
();

209 
blk
->
¡©us
 &ğ~
BlkDœty
;

211 } ià(
blk
->
	`isWr™abË
(è&& !
³ndšg_downg¿de
 &&

212 !
pkt
->
	`hasSh¬”s
() &&

213 
pkt
->
cmd
 !ğ
MemCmd
::
R—dCËªReq
) {

224 ià(
blk
->
	`isDœty
()) {

226 ià(!
deã¼ed_»¥Ú£
) {

229 
pkt
->
	`£tCacheRe¥Údšg
();

246 
blk
->
¡©us
 &ğ~
BlkDœty
;

253 
pkt
->
	`£tHasSh¬”s
();

258 
pkt
->
	`£tHasSh¬”s
();

261 } ià(
pkt
->
	`isUpg¿de
()) {

263 
	`as£¹
(!
pkt
->
	`hasSh¬”s
());

265 ià(
blk
->
	`isDœty
()) {

269 
pkt
->
	`£tCacheRe¥Údšg
();

270 
blk
->
¡©us
 &ğ~
BlkDœty
;

273 
	`as£¹
(
pkt
->
	`isInv®id©e
());

274 
	`šv®id©eBlock
(
blk
);

275 
	`DPRINTF
(
CacheV”bo£
, "%s for %s‡ddr %#llx size %d (invalidation)\n",

276 
__func__
, 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

278 
	}
}

286 
boŞ


287 
	gCache
::
	$acûss
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *&
blk
, 
Cyşes
 &
Ït
,

288 
Pack‘Li¡
 &
wr™ebacks
)

291 
	`as£¹
(
pkt
->
	`isReque¡
());

293 
	`ch©ty_as£¹
(!(
isR—dOÆy
 && 
pkt
->
	`isWr™e
()),

295 
	`Çme
());

297 
	`DPRINTF
(
CacheV”bo£
, "% fÜ % add¸%#Îx siz%d\n", 
__func__
,

298 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

300 ià(
pkt
->
»q
->
	`isUnÿch—bË
()) {

301 
	`DPRINTF
(
Cache
, "%s% add¸%#Îx unÿch—bË\n", 
pkt
->
	`cmdSŒšg
(),

302 
pkt
->
»q
->
	`isIn¡F‘ch
() ? " (ifetch)" : "",

303 
pkt
->
	`g‘Addr
());

306 
CacheBlk
 *
	`Şd_blk
(
gs
->
	`fšdBlock
(
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
()));

307 ià(
Şd_blk
 && old_blk->
	`isV®id
()) {

308 ià(
Şd_blk
->
	`isDœty
(è|| 
wr™ebackCËª
)

309 
wr™ebacks
.
	`push_back
(
	`wr™ebackBlk
(
Şd_blk
));

311 
wr™ebacks
.
	`push_back
(
	`ş—nEviùBlk
(
Şd_blk
));

312 
gs
->
	`šv®id©e
(
Şd_blk
);

313 
Şd_blk
->
	`šv®id©e
();

316 
blk
 = 
nuÎ±r
;

318 
Ït
 = 
lookupL©’cy
;

319  
çl£
;

322 
CÚ‹xtID
 
id
 = 
pkt
->
»q
->
	`hasCÚ‹xtId
() ?

323 
pkt
->
»q
->
	`cÚ‹xtId
(è: 
Inv®idCÚ‹xtID
;

326 
blk
 = 
gs
->
	`acûssBlock
(
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
(), 
Ït
, 
id
);

328 
	`DPRINTF
(
Cache
, "%s% add¸%#Îx siz%d (%sè%s\n", 
pkt
->
	`cmdSŒšg
(),

329 
pkt
->
»q
->
	`isIn¡F‘ch
() ? " (ifetch)" : "",

330 
pkt
->
	`g‘Addr
(),…kt->
	`g‘Size
(),…kt->
	`isSecu»
() ? "s" : "ns",

331 
blk
 ? "h™ " + blk->
	`´št
() : "miss");

334 ià(
pkt
->
	`isEviùiÚ
()) {

343 
Wr™eQueueEÁry
 *
wb_’Œy
 = 
wr™eBufãr
.
	`fšdM©ch
(
pkt
->
	`g‘Addr
(),

344 
pkt
->
	`isSecu»
());

345 ià(
wb_’Œy
) {

346 
	`as£¹
(
wb_’Œy
->
	`g‘NumT¬g‘s
() == 1);

347 
Pack‘PŒ
 
wbPkt
 = 
wb_’Œy
->
	`g‘T¬g‘
()->
pkt
;

348 
	`as£¹
(
wbPkt
->
	`isWr™eback
());

350 ià(
pkt
->
	`isCËªEviùiÚ
()) {

359 
wbPkt
->
	`ş—rBlockCached
();

360  
Œue
;

362 
	`as£¹
(
pkt
->
cmd
 =ğ
MemCmd
::
Wr™ebackDœty
);

366 
	`m¬kInS”viû
(
wb_’Œy
);

367 
d–‘e
 
wbPkt
;

374 ià(
pkt
->
	`isWr™eback
()) {

375 
	`as£¹
(
blkSize
 =ğ
pkt
->
	`g‘Size
());

381 ià(
pkt
->
cmd
 =ğ
MemCmd
::
Wr™ebackCËª
 &&

382 
mshrQueue
.
	`fšdM©ch
(
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
())) {

383 
	`DPRINTF
(
Cache
, "Clean writeback %#llxo block with MSHR, "

384 "drİpšg\n", 
pkt
->
	`g‘Addr
());

385  
Œue
;

388 ià(
blk
 =ğ
nuÎ±r
) {

390 
blk
 = 
	`®loÿ‹Block
(
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
(), 
wr™ebacks
);

391 ià(
blk
 =ğ
nuÎ±r
) {

393 
	`šcMissCouÁ
(
pkt
);

394  
çl£
;

396 
gs
->
	`š£¹Block
(
pkt
, 
blk
);

398 
blk
->
¡©us
 = (
BlkV®id
 | 
BlkR—dabË
);

399 ià(
pkt
->
	`isSecu»
()) {

400 
blk
->
¡©us
 |ğ
BlkSecu»
;

405 ià(
pkt
->
cmd
 =ğ
MemCmd
::
Wr™ebackDœty
) {

406 
blk
->
¡©us
 |ğ
BlkDœty
;

411 ià(!
pkt
->
	`hasSh¬”s
()) {

412 
blk
->
¡©us
 |ğ
BlkWr™abË
;

415 
	`as£¹
(!
pkt
->
	`ÃedsRe¥Ú£
());

416 
¡d
::
	`memıy
(
blk
->
d©a
, 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(), 
blkSize
);

417 
	`DPRINTF
(
Cache
, "% Ãw s‹ i %s\n", 
__func__
, 
blk
->
	`´št
());

418 
	`šcH™CouÁ
(
pkt
);

419  
Œue
;

420 } ià(
pkt
->
cmd
 =ğ
MemCmd
::
CËªEviù
) {

421 ià(
blk
 !ğ
nuÎ±r
) {

426  
Œue
;

432  
çl£
;

433 } ià(
blk
 && (
pkt
->
	`ÃedsWr™abË
(è? blk->
	`isWr™abË
() :

434 
blk
->
	`isR—dabË
())) {

436 
	`šcH™CouÁ
(
pkt
);

437 
	`§tisfyReque¡
(
pkt
, 
blk
);

438 
	`maššClusiv™y
(
pkt
->
	`äomCache
(), 
blk
);

440  
Œue
;

446 
	`šcMissCouÁ
(
pkt
);

448 ià(
blk
 =ğ
nuÎ±r
 && 
pkt
->
	`isLLSC
(è&&…kt->
	`isWr™e
()) {

450 
pkt
->
»q
->
	`£tExŒaD©a
(0);

451  
Œue
;

454  
çl£
;

455 
	}
}

458 
	gCache
::
	$maššClusiv™y
(
boŞ
 
äom_ÿche
, 
CacheBlk
 *
blk
)

460 ià(
äom_ÿche
 && 
blk
 && blk->
	`isV®id
(è&& !blk->
	`isDœty
() &&

461 
şusiv™y
 =ğ
Enums
::
mo¡ly_exş
) {

465 
	`šv®id©eBlock
(
blk
);

467 
	}
}

470 
	gCache
::
	$doWr™ebacks
(
Pack‘Li¡
& 
wr™ebacks
, 
Tick
 
fÜw¬d_time
)

472 !
wr™ebacks
.
	`em±y
()) {

473 
Pack‘PŒ
 
wbPkt
 = 
wr™ebacks
.
	`äÚt
();

478 ià(
	`isCachedAbove
(
wbPkt
)) {

479 ià(
wbPkt
->
cmd
 =ğ
MemCmd
::
CËªEviù
) {

484 
d–‘e
 
wbPkt
;

485 } ià(
wbPkt
->
cmd
 =ğ
MemCmd
::
Wr™ebackCËª
) {

488 
	`as£¹
(
wr™ebackCËª
);

489 
d–‘e
 
wbPkt
;

491 
	`as£¹
(
wbPkt
->
cmd
 =ğ
MemCmd
::
Wr™ebackDœty
);

495 
wbPkt
->
	`£tBlockCached
();

496 
	`®loÿ‹Wr™eBufãr
(
wbPkt
, 
fÜw¬d_time
);

503 
	`®loÿ‹Wr™eBufãr
(
wbPkt
, 
fÜw¬d_time
);

505 
wr™ebacks
.
	`pİ_äÚt
();

507 
	}
}

510 
	gCache
::
	$doWr™ebacksAtomic
(
Pack‘Li¡
& 
wr™ebacks
)

512 !
wr™ebacks
.
	`em±y
()) {

513 
Pack‘PŒ
 
wbPkt
 = 
wr™ebacks
.
	`äÚt
();

517 ià(
	`isCachedAbove
(
wbPkt
, 
çl£
)) {

518 ià(
wbPkt
->
cmd
 =ğ
MemCmd
::
Wr™ebackDœty
) {

525 
memSidePÜt
->
	`£ndAtomic
(
wbPkt
);

532 
memSidePÜt
->
	`£ndAtomic
(
wbPkt
);

534 
wr™ebacks
.
	`pİ_äÚt
();

538 
d–‘e
 
wbPkt
;

540 
	}
}

544 
	gCache
::
	$»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

546 
	`DPRINTF
(
Cache
, "% fÜ % add¸%#Îx siz%d\n", 
__func__
,

547 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

549 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

550 
	`as£¹
(!
sy¡em
->
	`by·ssCaches
());

555 cÚ¡ 
boŞ
 
fÜw¬dAsSnoİ
 = 
out¡ªdšgSnoİ
.
	`fšd
(
pkt
->
»q
) ==

556 
out¡ªdšgSnoİ
.
	`’d
();

558 ià(!
fÜw¬dAsSnoİ
) {

561 
	`as£¹
(
pkt
->
cmd
 =ğ
MemCmd
::
H¬dPFRe¥
);

563 
out¡ªdšgSnoİ
.
	`”a£
(
pkt
->
»q
);

565 
	`DPRINTF
(
Cache
, "Got…refetch„esponse from‡bove for‡ddr "

566 "%#Îx (%s)\n", 
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
() ? "s" : "ns");

567 
	`»cvTimšgRe¥
(
pkt
);

575 
Tick
 
¢oİ_»¥_time
 = 
	`şockEdge
(
fÜw¬dL©’cy
è+ 
pkt
->
h—d”D–ay
;

577 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

578 
memSidePÜt
->
	`schedTimšgSnoİRe¥
(
pkt
, 
¢oİ_»¥_time
);

579 
	}
}

582 
	gCache
::
	$´omÙeWhŞeLšeWr™es
(
Pack‘PŒ
 
pkt
)

585 ià(
doFa¡Wr™es
 && (
pkt
->
cmd
 =ğ
MemCmd
::
Wr™eReq
) &&

586 (
pkt
->
	`g‘Size
(è=ğ
blkSize
è&& (pkt->
	`g‘Off£t
(blkSize) == 0)) {

587 
pkt
->
cmd
 = 
MemCmd
::
Wr™eLšeReq
;

588 
	`DPRINTF
(
Cache
, "packet…romoted from Writeo WriteLineReq\n");

590 
	}
}

592 
boŞ


593 
	gCache
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

595 
	`DPRINTF
(
CacheTags
, "% gs: %s\n", 
__func__
, 
gs
->
	`´št
());

597 
	`as£¹
(
pkt
->
	`isReque¡
());

600 ià(
sy¡em
->
	`by·ssCaches
()) {

602 
boŞ
 
M5_VAR_USED
 
sucûss
 = 
memSidePÜt
->
	`£ndTimšgReq
(
pkt
);

603 
	`as£¹
(
sucûss
);

604  
Œue
;

607 
	`´omÙeWhŞeLšeWr™es
(
pkt
);

609 ià(
pkt
->
	`ÿcheRe¥Údšg
()) {

613 
	`DPRINTF
(
Cache
, "Cache‡bove„espondingo %#llx (%s): "

615 
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
() ? "s" : "ns");

622 
	`as£¹
(
pkt
->
	`ÃedsWr™abË
(è&& !pkt->
	`»¥Úd”HadWr™abË
());

639 
Pack‘
 *
¢oİ_pkt
 = 
Ãw
 
	`Pack‘
(
pkt
, 
Œue
, 
çl£
);

643 
¢oİ_pkt
->
h—d”D–ay
 = snoİ_pkt->
·ylßdD–ay
 = 0;

650 
¢oİ_pkt
->
	`£tEx´essSnoİ
();

651 
¢oİ_pkt
->
	`£tCacheRe¥Údšg
();

656 
boŞ
 
M5_VAR_USED
 
sucûss
 = 
memSidePÜt
->
	`£ndTimšgReq
(
¢oİ_pkt
);

658 
	`as£¹
(
sucûss
);

664 
³ndšgD–‘e
.
	`»£t
(
pkt
);

671  
Œue
;

676 
Tick
 
fÜw¬d_time
 = 
	`şockEdge
(
fÜw¬dL©’cy
è+ 
pkt
->
h—d”D–ay
;

680 
Cyşes
 
Ït
 = 
lookupL©’cy
;

681 
CacheBlk
 *
blk
 = 
nuÎ±r
;

682 
boŞ
 
§tisf›d
 = 
çl£
;

684 
Pack‘Li¡
 
wr™ebacks
;

687 
§tisf›d
 = 
	`acûss
(
pkt
, 
blk
, 
Ït
, 
wr™ebacks
);

691 
	`doWr™ebacks
(
wr™ebacks
, 
fÜw¬d_time
);

700 
Tick
 
»que¡_time
 = 
	`şockEdge
(
Ït
è+ 
pkt
->
h—d”D–ay
;

702 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

705 
Tick
 
Ãxt_pf_time
 = 
MaxTick
;

707 
boŞ
 
ÃedsRe¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

709 ià(
§tisf›d
) {

713 
	`as£¹
(!
pkt
->
»q
->
	`isUnÿch—bË
());

717 ià(
´eãtch”
 && (
´eãtchOnAcûss
 ||

718 (
blk
 && blk->
	`wasP»ãtched
()))) {

719 ià(
blk
)

720 
blk
->
¡©us
 &ğ~
BlkHWP»ãtched
;

723 ià(!
pkt
->
cmd
.
	`isSWP»ãtch
())

724 
Ãxt_pf_time
 = 
´eãtch”
->
	`nÙify
(
pkt
);

727 ià(
ÃedsRe¥Ú£
) {

728 
pkt
->
	`makeTimšgRe¥Ú£
();

730 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

737 
ıuSidePÜt
->
	`schedTimšgRe¥
(
pkt
, 
»que¡_time
, 
Œue
);

739 
	`DPRINTF
(
Cache
, "%s satisfied %s‡ddr %#llx,‚o„esponse‚eeded\n",

740 
__func__
, 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

746 
³ndšgD–‘e
.
	`»£t
(
pkt
);

751 
Addr
 
blk_addr
 = 
	`blockAlign
(
pkt
->
	`g‘Addr
());

755 
MSHR
 *
mshr
 = 
pkt
->
»q
->
	`isUnÿch—bË
(è? 
nuÎ±r
 :

756 
mshrQueue
.
	`fšdM©ch
(
blk_addr
, 
pkt
->
	`isSecu»
());

767 ià(
pkt
->
cmd
.
	`isSWP»ãtch
()) {

768 
	`as£¹
(
ÃedsRe¥Ú£
);

769 
	`as£¹
(
pkt
->
»q
->
	`hasPaddr
());

770 
	`as£¹
(!
pkt
->
»q
->
	`isUnÿch—bË
());

776 
Pack‘PŒ
 
pf
 = 
nuÎ±r
;

778 ià(!
mshr
) {

780 
Reque¡PŒ
 
»q
 = 
Ãw
 
	`Reque¡
(
pkt
->»q->
	`g‘Paddr
(),

781 
pkt
->
»q
->
	`g‘Size
(),

782 
pkt
->
»q
->
	`g‘FÏgs
(),

783 
pkt
->
»q
->
	`ma¡”Id
());

784 
pf
 = 
Ãw
 
	`Pack‘
(
»q
, 
pkt
->
cmd
);

785 
pf
->
	`®loÿ‹
();

786 
	`as£¹
(
pf
->
	`g‘Addr
(è=ğ
pkt
->getAddr());

787 
	`as£¹
(
pf
->
	`g‘Size
(è=ğ
pkt
->getSize());

790 
pkt
->
	`makeTimšgRe¥Ú£
();

794 
ıuSidePÜt
->
	`schedTimšgRe¥
(
pkt
, 
»que¡_time
, 
Œue
);

798 
pkt
 = 
pf
;

801 ià(
mshr
) {

809 ià(
pkt
) {

810 
	`as£¹
(!
pkt
->
	`isWr™eback
());

813 ià(
pkt
->
cmd
 =ğ
MemCmd
::
CËªEviù
) {

814 
³ndšgD–‘e
.
	`»£t
(
pkt
);

816 
	`DPRINTF
(
Cache
, "%s coalescing MSHR for %s‡ddr %#llx "

817 "siz%d\n", 
__func__
, 
pkt
->
	`cmdSŒšg
(),

818 
pkt
->
	`g‘Addr
(),…kt->
	`g‘Size
());

820 
	`as£¹
(
pkt
->
»q
->
	`ma¡”Id
(è< 
sy¡em
->
	`maxMa¡”s
());

821 
mshr_h™s
[
pkt
->
	`cmdToIndex
()][pkt->
»q
->
	`ma¡”Id
()]++;

829 
mshr
->
	`®loÿ‹T¬g‘
(
pkt
, 
fÜw¬d_time
, 
Üd”
++,

830 
	`®locOnFl
(
pkt
->
cmd
));

831 ià(
mshr
->
	`g‘NumT¬g‘s
(è=ğ
numT¬g‘
) {

832 
noT¬g‘MSHR
 = 
mshr
;

833 
	`£tBlocked
(
Blocked_NoT¬g‘s
);

847 ià(
´eãtch”
) {

849 ià(!
pkt
->
cmd
.
	`isSWP»ãtch
())

850 
Ãxt_pf_time
 = 
´eãtch”
->
	`nÙify
(
pkt
);

855 
	`as£¹
(
pkt
->
»q
->
	`ma¡”Id
(è< 
sy¡em
->
	`maxMa¡”s
());

856 ià(
pkt
->
»q
->
	`isUnÿch—bË
()) {

857 
mshr_unÿch—bË
[
pkt
->
	`cmdToIndex
()][pkt->
»q
->
	`ma¡”Id
()]++;

859 
mshr_mis£s
[
pkt
->
	`cmdToIndex
()][pkt->
»q
->
	`ma¡”Id
()]++;

862 ià(
pkt
->
	`isEviùiÚ
() ||

863 (
pkt
->
»q
->
	`isUnÿch—bË
(è&&…kt->
	`isWr™e
())) {

866 
	`®loÿ‹Wr™eBufãr
(
pkt
, 
fÜw¬d_time
);

868 ià(
blk
 && blk->
	`isV®id
()) {

870 
	`as£¹
(!
pkt
->
»q
->
	`isUnÿch—bË
());

887 
	`as£¹
(
pkt
->
	`ÃedsWr™abË
());

888 
	`as£¹
(!
blk
->
	`isWr™abË
());

889 
blk
->
¡©us
 &ğ~
BlkR—dabË
;

894 
	`®loÿ‹MissBufãr
(
pkt
, 
fÜw¬d_time
);

897 ià(
´eãtch”
) {

899 ià(!
pkt
->
cmd
.
	`isSWP»ãtch
())

900 
Ãxt_pf_time
 = 
´eãtch”
->
	`nÙify
(
pkt
);

905 ià(
Ãxt_pf_time
 !ğ
MaxTick
)

906 
	`schedMemSideS’dEv’t
(
Ãxt_pf_time
);

908  
Œue
;

909 
	}
}

911 
Pack‘PŒ


912 
	gCache
::
	$ü—‹MissPack‘
(
Pack‘PŒ
 
ıu_pkt
, 
CacheBlk
 *
blk
,

913 
boŞ
 
ÃedsWr™abË
) const

916 
	`as£¹
(!
ıu_pkt
->
	`isEviùiÚ
());

918 
boŞ
 
blkV®id
 = 
blk
 && blk->
	`isV®id
();

920 ià(
ıu_pkt
->
»q
->
	`isUnÿch—bË
() ||

921 (!
blkV®id
 && 
ıu_pkt
->
	`isUpg¿de
())) {

924  
nuÎ±r
;

927 
	`as£¹
(
ıu_pkt
->
	`ÃedsRe¥Ú£
());

929 
MemCmd
 
cmd
;

934 cÚ¡ 
boŞ
 
u£Upg¿des
 = 
Œue
;

935 ià(
blkV®id
 && 
u£Upg¿des
) {

938 
	`as£¹
(
ÃedsWr™abË
);

939 
	`as£¹
(!
blk
->
	`isWr™abË
());

940 
cmd
 = 
ıu_pkt
->
	`isLLSC
(è? 
MemCmd
::
SCUpg¿deReq
 : MemCmd::
Upg¿deReq
;

941 } ià(
ıu_pkt
->
cmd
 =ğ
MemCmd
::
SCUpg¿deFaReq
 ||

942 
ıu_pkt
->
cmd
 =ğ
MemCmd
::
StÜeCÚdFaReq
) {

947 
cmd
 = 
MemCmd
::
SCUpg¿deFaReq
;

948 } ià(
ıu_pkt
->
cmd
 =ğ
MemCmd
::
Wr™eLšeReq
 ||

949 
ıu_pkt
->
cmd
 =ğ
MemCmd
::
Inv®id©eReq
) {

953 
cmd
 = 
MemCmd
::
Inv®id©eReq
;

956 
cmd
 = 
ÃedsWr™abË
 ? 
MemCmd
::
R—dExReq
 :

957 (
isR—dOÆy
 ? 
MemCmd
::
R—dCËªReq
 : MemCmd::
R—dSh¬edReq
);

959 
Pack‘PŒ
 
pkt
 = 
Ãw
 
	`Pack‘
(
ıu_pkt
->
»q
, 
cmd
, 
blkSize
);

964 ià(
ıu_pkt
->
	`hasSh¬”s
(è&& !
ÃedsWr™abË
) {

969 
pkt
->
	`£tHasSh¬”s
();

970 
	`DPRINTF
(
Cache
, "%s…assing hasSharers from %so %s‡ddr %#llx "

972 
__func__
, 
ıu_pkt
->
	`cmdSŒšg
(), 
pkt
->cmdString(),

973 
pkt
->
	`g‘Addr
(),…kt->
	`g‘Size
());

977 
	`as£¹
(
pkt
->
	`g‘Addr
(è=ğ
	`blockAlign
(pkt->getAddr()));

979 
pkt
->
	`®loÿ‹
();

980 
	`DPRINTF
(
Cache
, "%s created %s from %s for‡ddr %#llx size %d\n",

981 
__func__
, 
pkt
->
	`cmdSŒšg
(), 
ıu_pkt
->cmdSŒšg(),…kt->
	`g‘Addr
(),

982 
pkt
->
	`g‘Size
());

983  
pkt
;

984 
	}
}

987 
Tick


988 
	gCache
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

991 
Cyşes
 
Ït
 = 
lookupL©’cy
;

994 ià(
sy¡em
->
	`by·ssCaches
())

995  
	`ticksToCyşes
(
memSidePÜt
->
	`£ndAtomic
(
pkt
));

997 
	`´omÙeWhŞeLšeWr™es
(
pkt
);

1001 ià(
pkt
->
	`ÿcheRe¥Údšg
()) {

1002 
	`DPRINTF
(
Cache
, "Cache‡bove„espondingo %#llx (%s): "

1004 
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
() ? "s" : "ns");

1009 
	`as£¹
(
pkt
->
	`ÃedsWr™abË
(è&& !pkt->
	`»¥Úd”HadWr™abË
());

1010 
Ït
 +ğ
	`ticksToCyşes
(
memSidePÜt
->
	`£ndAtomic
(
pkt
));

1012  
Ït
 * 
	`şockP”iod
();

1019 
CacheBlk
 *
blk
 = 
nuÎ±r
;

1020 
Pack‘Li¡
 
wr™ebacks
;

1021 
boŞ
 
§tisf›d
 = 
	`acûss
(
pkt
, 
blk
, 
Ït
, 
wr™ebacks
);

1025 
	`doWr™ebacksAtomic
(
wr™ebacks
);

1027 ià(!
§tisf›d
) {

1032 ià(
pkt
->
	`isEviùiÚ
() ||

1033 (
pkt
->
»q
->
	`isUnÿch—bË
(è&&…kt->
	`isWr™e
())) {

1034 
Ït
 +ğ
	`ticksToCyşes
(
memSidePÜt
->
	`£ndAtomic
(
pkt
));

1035  
Ït
 * 
	`şockP”iod
();

1039 
Pack‘PŒ
 
bus_pkt
 = 
	`ü—‹MissPack‘
(
pkt
, 
blk
,…kt->
	`ÃedsWr™abË
());

1041 
boŞ
 
is_fÜw¬d
 = (
bus_pkt
 =ğ
nuÎ±r
);

1043 ià(
is_fÜw¬d
) {

1046 
bus_pkt
 = 
pkt
;

1049 
	`DPRINTF
(
Cache
, "Sending‡n‡tomic %s for %#llx (%s)\n",

1050 
bus_pkt
->
	`cmdSŒšg
(), bus_pkt->
	`g‘Addr
(),

1051 
bus_pkt
->
	`isSecu»
() ? "s" : "ns");

1053 #ià
TRACING_ON


1054 
CacheBlk
::
S‹
 
Şd_¡©e
 = 
blk
 ? blk->
¡©us
 : 0;

1057 
Ït
 +ğ
	`ticksToCyşes
(
memSidePÜt
->
	`£ndAtomic
(
bus_pkt
));

1059 
boŞ
 
is_šv®id©e
 = 
bus_pkt
->
	`isInv®id©e
();

1062 
	`DPRINTF
(
Cache
, "Receive„esponse: %s for‡ddr %#llx (%s) in "

1063 "¡©%i\n", 
bus_pkt
->
	`cmdSŒšg
(), bus_pkt->
	`g‘Addr
(),

1064 
bus_pkt
->
	`isSecu»
() ? "s" : "ns",

1065 
Şd_¡©e
);

1071 ià(!
is_fÜw¬d
) {

1072 ià(
pkt
->
	`ÃedsRe¥Ú£
()) {

1073 
	`as£¹
(
bus_pkt
->
	`isRe¥Ú£
());

1074 ià(
bus_pkt
->
	`isE¼Ü
()) {

1075 
pkt
->
	`makeAtomicRe¥Ú£
();

1076 
pkt
->
	`cİyE¼Ü
(
bus_pkt
);

1077 } ià(
pkt
->
cmd
 =ğ
MemCmd
::
Wr™eLšeReq
) {

1082 
blk
 = 
	`hªdËFl
(
pkt
, blk, 
wr™ebacks
,

1083 
	`®locOnFl
(
pkt
->
cmd
));

1084 
	`as£¹
(
blk
 !ğ
NULL
);

1085 
is_šv®id©e
 = 
çl£
;

1086 
	`§tisfyReque¡
(
pkt
, 
blk
);

1087 } ià(
bus_pkt
->
	`isR—d
() ||

1088 
bus_pkt
->
cmd
 =ğ
MemCmd
::
Upg¿deRe¥
) {

1091 
blk
 = 
	`hªdËFl
(
bus_pkt
, blk, 
wr™ebacks
,

1092 
	`®locOnFl
(
pkt
->
cmd
));

1093 
	`§tisfyReque¡
(
pkt
, 
blk
);

1094 
	`maššClusiv™y
(
pkt
->
	`äomCache
(), 
blk
);

1098 
pkt
->
	`makeAtomicRe¥Ú£
();

1101 
d–‘e
 
bus_pkt
;

1104 ià(
is_šv®id©e
 && 
blk
 && blk->
	`isV®id
()) {

1105 
	`šv®id©eBlock
(
blk
);

1121 
	`doWr™ebacksAtomic
(
wr™ebacks
);

1127 ià(
blk
 =ğ
‹mpBlock
 &&empBlock->
	`isV®id
()) {

1131 ià(
‹mpBlockWr™eback
) {

1134 
	`wr™ebackTempBlockAtomic
();

1140 
	`scheduË
(
wr™ebackTempBlockAtomicEv’t
, 
	`curTick
());

1143 
‹mpBlockWr™eback
 = (
blk
->
	`isDœty
(è|| 
wr™ebackCËª
) ?

1144 
	`wr™ebackBlk
(
blk
è: 
	`ş—nEviùBlk
(blk);

1145 
blk
->
	`šv®id©e
();

1148 ià(
pkt
->
	`ÃedsRe¥Ú£
()) {

1149 
pkt
->
	`makeAtomicRe¥Ú£
();

1152  
Ït
 * 
	`şockP”iod
();

1153 
	}
}

1157 
	gCache
::
	$funùiÚ®Acûss
(
Pack‘PŒ
 
pkt
, 
boŞ
 
äomCpuSide
)

1159 ià(
sy¡em
->
	`by·ssCaches
()) {

1162 
	`as£¹
(
äomCpuSide
);

1166 
memSidePÜt
->
	`£ndFunùiÚ®
(
pkt
);

1170 
Addr
 
blk_addr
 = 
	`blockAlign
(
pkt
->
	`g‘Addr
());

1171 
boŞ
 
is_£cu»
 = 
pkt
->
	`isSecu»
();

1172 
CacheBlk
 *
blk
 = 
gs
->
	`fšdBlock
(
pkt
->
	`g‘Addr
(), 
is_£cu»
);

1173 
MSHR
 *
mshr
 = 
mshrQueue
.
	`fšdM©ch
(
blk_addr
, 
is_£cu»
);

1175 
pkt
->
	`pushLab–
(
	`Çme
());

1177 
CacheBlkPrštW¿µ”
 
	`cbpw
(
blk
);

1185 
boŞ
 
have_d©a
 = 
blk
 && blk->
	`isV®id
()

1186 && 
pkt
->
	`checkFunùiÚ®
(&
cbpw
, 
blk_addr
, 
is_£cu»
, 
blkSize
,

1187 
blk
->
d©a
);

1191 
boŞ
 
have_dœty
 =

1192 
have_d©a
 && (
blk
->
	`isDœty
() ||

1193 (
mshr
 && mshr->
šS”viû
 && mshr->
	`isP’dšgModif›d
()));

1195 
boŞ
 
dÚe
 = 
have_dœty


1196 || 
ıuSidePÜt
->
	`checkFunùiÚ®
(
pkt
)

1197 || 
mshrQueue
.
	`checkFunùiÚ®
(
pkt
, 
blk_addr
)

1198 || 
wr™eBufãr
.
	`checkFunùiÚ®
(
pkt
, 
blk_addr
)

1199 || 
memSidePÜt
->
	`checkFunùiÚ®
(
pkt
);

1201 
	`DPRINTF
(
CacheV”bo£
, "functional %s %#llx (%s) %s%s%s\n",

1202 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(), 
is_£cu»
 ? "s" : "ns",

1203 (
blk
 && blk->
	`isV®id
()) ? "valid " : "",

1204 
have_d©a
 ? "d©¨" : "", 
dÚe
 ? "done " : "");

1207 
pkt
->
	`pİLab–
();

1209 ià(
dÚe
) {

1210 
pkt
->
	`makeRe¥Ú£
();

1214 ià(
äomCpuSide
) {

1215 
memSidePÜt
->
	`£ndFunùiÚ®
(
pkt
);

1216 } ià(
ıuSidePÜt
->
	`isSnoİšg
()) {

1219 
ıuSidePÜt
->
	`£ndFunùiÚ®Snoİ
(
pkt
);

1222 
	}
}

1233 
	gCache
::
	$hªdËUnÿch—bËWr™eRe¥
(
Pack‘PŒ
 
pkt
)

1235 
Tick
 
com¶‘iÚ_time
 = 
	`şockEdge
(
»¥Ú£L©’cy
) +

1236 
pkt
->
h—d”D–ay
 +…kt->
·ylßdD–ay
;

1239 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

1241 
ıuSidePÜt
->
	`schedTimšgRe¥
(
pkt
, 
com¶‘iÚ_time
, 
Œue
);

1242 
	}
}

1245 
	gCache
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

1247 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

1251 
	`·nic_if
(
pkt
->
h—d”D–ay
 !ğ0 &&…kt->
cmd
 !ğ
MemCmd
::
H¬dPFRe¥
,

1252 "% §w‡‚Ú-z”Ø·ck‘ d–ay\n", 
	`Çme
());

1254 
boŞ
 
is_”rÜ
 = 
pkt
->
	`isE¼Ü
();

1256 ià(
is_”rÜ
) {

1257 
	`DPRINTF
(
Cache
, "Cache„eceived…acket withƒrror for‡ddr %#llx (%s), "

1258 "cmd: %s\n", 
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
() ? "s" : "ns",

1259 
pkt
->
	`cmdSŒšg
());

1262 
	`DPRINTF
(
Cache
, "Handling„esponse %s for‡ddr %#llx size %d (%s)\n",

1263 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
(),

1264 
pkt
->
	`isSecu»
() ? "s" : "ns");

1268 ià(
pkt
->
	`isWr™e
()) {

1269 
	`as£¹
(
pkt
->
»q
->
	`isUnÿch—bË
());

1270 
	`hªdËUnÿch—bËWr™eRe¥
(
pkt
);

1276 
MSHR
 *
mshr
 = 
dyÇmic_ÿ¡
<MSHR*>(
pkt
->
	`pİS’d”S‹
());

1277 
	`as£¹
(
mshr
);

1279 ià(
mshr
 =ğ
noT¬g‘MSHR
) {

1281 
	`ş—rBlocked
(
Blocked_NoT¬g‘s
);

1282 
noT¬g‘MSHR
 = 
nuÎ±r
;

1286 
MSHR
::
T¬g‘
 *
š™Ÿl_tgt
 = 
mshr
->
	`g‘T¬g‘
();

1287 
¡©s_cmd_idx
 = 
š™Ÿl_tgt
->
pkt
->
	`cmdToIndex
();

1288 
Tick
 
miss_Ï‹ncy
 = 
	`curTick
(è- 
š™Ÿl_tgt
->
»cvTime
;

1290 ià(
pkt
->
»q
->
	`isUnÿch—bË
()) {

1291 
	`as£¹
(
pkt
->
»q
->
	`ma¡”Id
(è< 
sy¡em
->
	`maxMa¡”s
());

1292 
mshr_unÿch—bË_Ït
[
¡©s_cmd_idx
][
pkt
->
»q
->
	`ma¡”Id
()] +=

1293 
miss_Ï‹ncy
;

1295 
	`as£¹
(
pkt
->
»q
->
	`ma¡”Id
(è< 
sy¡em
->
	`maxMa¡”s
());

1296 
mshr_miss_Ï‹ncy
[
¡©s_cmd_idx
][
pkt
->
»q
->
	`ma¡”Id
()] +=

1297 
miss_Ï‹ncy
;

1300 
boŞ
 
wasFuÎ
 = 
mshrQueue
.
	`isFuÎ
();

1302 
Pack‘Li¡
 
wr™ebacks
;

1304 
Tick
 
fÜw¬d_time
 = 
	`şockEdge
(
fÜw¬dL©’cy
è+ 
pkt
->
h—d”D–ay
;

1308 ià(!
pkt
->
	`hasSh¬”s
()) {

1309 
mshr
->
	`´omÙeWr™abË
();

1312 
boŞ
 
is_fl
 = !
mshr
->
isFÜw¬d
 &&

1313 (
pkt
->
	`isR—d
(è||…kt->
cmd
 =ğ
MemCmd
::
Upg¿deRe¥
);

1315 
CacheBlk
 *
blk
 = 
gs
->
	`fšdBlock
(
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
());

1317 ià(
is_fl
 && !
is_”rÜ
) {

1318 
	`DPRINTF
(
Cache
, "Block for‡ddr %#llx being updated in Cache\n",

1319 
pkt
->
	`g‘Addr
());

1321 
blk
 = 
	`hªdËFl
(
pkt
, blk, 
wr™ebacks
, 
mshr
->
®locOnFl
);

1322 
	`as£¹
(
blk
 !ğ
nuÎ±r
);

1327 
boŞ
 
is_šv®id©e
 = 
pkt
->
	`isInv®id©e
();

1330 
š™Ÿl_off£t
 = 
š™Ÿl_tgt
->
pkt
->
	`g‘Off£t
(
blkSize
);

1332 
boŞ
 
äom_ÿche
 = 
çl£
;

1334 
mshr
->
	`hasT¬g‘s
()) {

1335 
MSHR
::
T¬g‘
 *
rg‘
 = 
mshr
->
	`g‘T¬g‘
();

1336 
Pack‘
 *
tgt_pkt
 = 
rg‘
->
pkt
;

1338 
rg‘
->
sourû
) {

1339 
MSHR
::
T¬g‘
::
FromCPU
:

1340 
Tick
 
com¶‘iÚ_time
;

1343 
com¶‘iÚ_time
 = 
pkt
->
h—d”D–ay
;

1346 ià(
tgt_pkt
->
cmd
.
	`isSWP»ãtch
()) {

1351 
d–‘e
 
tgt_pkt
->
»q
;

1352 
d–‘e
 
tgt_pkt
;

1358 
äom_ÿche
 = from_ÿch|| 
tgt_pkt
->
	`äomCache
();

1366 ià(
tgt_pkt
->
cmd
 =ğ
MemCmd
::
Wr™eLšeReq
) {

1367 
	`as£¹
(!
is_”rÜ
);

1370 
mshr
->
	`´omÙeWr™abË
();

1372 
blk
 = 
	`hªdËFl
(
tgt_pkt
, blk, 
wr™ebacks
, 
mshr
->
®locOnFl
);

1373 
	`as£¹
(
blk
 !ğ
nuÎ±r
);

1377 
is_fl
 = 
Œue
;

1378 
is_šv®id©e
 = 
çl£
;

1381 ià(
is_fl
) {

1382 
	`§tisfyReque¡
(
tgt_pkt
, 
blk
, 
Œue
, 
mshr
->
	`hasPo¡Downg¿de
());

1385 
Œªsãr_off£t
 =

1386 
tgt_pkt
->
	`g‘Off£t
(
blkSize
è- 
š™Ÿl_off£t
;

1387 ià(
Œªsãr_off£t
 < 0) {

1388 
Œªsãr_off£t
 +ğ
blkSize
;

1395 
com¶‘iÚ_time
 +ğ
	`şockEdge
(
»¥Ú£L©’cy
) +

1396 (
Œªsãr_off£t
 ? 
pkt
->
·ylßdD–ay
 : 0);

1398 
	`as£¹
(!
tgt_pkt
->
»q
->
	`isUnÿch—bË
());

1400 
	`as£¹
(
tgt_pkt
->
»q
->
	`ma¡”Id
(è< 
sy¡em
->
	`maxMa¡”s
());

1401 
missL©’cy
[
tgt_pkt
->
	`cmdToIndex
()][tgt_pkt->
»q
->
	`ma¡”Id
()] +=

1402 
com¶‘iÚ_time
 - 
rg‘
->
»cvTime
;

1403 } ià(
pkt
->
cmd
 =ğ
MemCmd
::
Upg¿deFaRe¥
) {

1405 
	`as£¹
(
tgt_pkt
->
cmd
 =ğ
MemCmd
::
StÜeCÚdReq
 ||

1406 
tgt_pkt
->
cmd
 =ğ
MemCmd
::
StÜeCÚdFaReq
 ||

1407 
tgt_pkt
->
cmd
 =ğ
MemCmd
::
SCUpg¿deFaReq
);

1411 
com¶‘iÚ_time
 +ğ
	`şockEdge
(
»¥Ú£L©’cy
) +

1412 
pkt
->
·ylßdD–ay
;

1413 
tgt_pkt
->
»q
->
	`£tExŒaD©a
(0);

1418 
com¶‘iÚ_time
 +ğ
	`şockEdge
(
»¥Ú£L©’cy
) +

1419 
pkt
->
·ylßdD–ay
;

1420 ià(
pkt
->
	`isR—d
(è&& !
is_”rÜ
) {

1422 
	`as£¹
(
pkt
->
	`g‘Addr
(è=ğ
tgt_pkt
->getAddr());

1423 
	`as£¹
(
pkt
->
	`g‘Size
(è>ğ
tgt_pkt
->getSize());

1425 
tgt_pkt
->
	`£tD©a
(
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>());

1428 
tgt_pkt
->
	`makeTimšgRe¥Ú£
();

1430 ià(
is_”rÜ
)

1431 
tgt_pkt
->
	`cİyE¼Ü
(
pkt
);

1432 ià(
tgt_pkt
->
cmd
 =ğ
MemCmd
::
R—dRe¥
 &&

1433 (
is_šv®id©e
 || 
mshr
->
	`hasPo¡Inv®id©e
())) {

1437 
tgt_pkt
->
cmd
 = 
MemCmd
::
R—dRe¥W™hInv®id©e
;

1438 
	`DPRINTF
(
Cache
, "%s updated cmdo %s for‡ddr %#llx\n",

1439 
__func__
, 
tgt_pkt
->
	`cmdSŒšg
(),gt_pkt->
	`g‘Addr
());

1442 
tgt_pkt
->
h—d”D–ay
 =gt_pkt->
·ylßdD–ay
 = 0;

1443 
ıuSidePÜt
->
	`schedTimšgRe¥
(
tgt_pkt
, 
com¶‘iÚ_time
, 
Œue
);

1446 
MSHR
::
T¬g‘
::
FromP»ãtch”
:

1447 
	`as£¹
(
tgt_pkt
->
cmd
 =ğ
MemCmd
::
H¬dPFReq
);

1448 ià(
blk
)

1449 
blk
->
¡©us
 |ğ
BlkHWP»ãtched
;

1450 
d–‘e
 
tgt_pkt
->
»q
;

1451 
d–‘e
 
tgt_pkt
;

1454 
MSHR
::
T¬g‘
::
FromSnoİ
:

1456 
	`as£¹
(!
is_”rÜ
);

1458 
	`DPRINTF
(
Cache
, "processing deferred snoop...\n");

1459 
	`as£¹
(!(
is_šv®id©e
 && !
mshr
->
	`hasPo¡Inv®id©e
()));

1460 
	`hªdËSnoİ
(
tgt_pkt
, 
blk
, 
Œue
,rue, 
mshr
->
	`hasPo¡Inv®id©e
());

1464 
	`·nic
("IÎeg®¬g‘->sourûƒnum %d\n", 
rg‘
->
sourû
);

1467 
mshr
->
	`pİT¬g‘
();

1470 
	`maššClusiv™y
(
äom_ÿche
, 
blk
);

1472 ià(
blk
 && blk->
	`isV®id
()) {

1476 ià(
is_šv®id©e
 || 
mshr
->
	`hasPo¡Inv®id©e
()) {

1477 
	`šv®id©eBlock
(
blk
);

1478 } ià(
mshr
->
	`hasPo¡Downg¿de
()) {

1479 
blk
->
¡©us
 &ğ~
BlkWr™abË
;

1483 ià(
mshr
->
	`´omÙeDeã¼edT¬g‘s
()) {

1486 ià(
blk
) {

1487 
blk
->
¡©us
 &ğ~
BlkR—dabË
;

1489 
mshrQueue
.
	`m¬kP’dšg
(
mshr
);

1490 
	`schedMemSideS’dEv’t
(
	`şockEdge
(è+ 
pkt
->
·ylßdD–ay
);

1492 
mshrQueue
.
	`d—Îoÿ‹
(
mshr
);

1493 ià(
wasFuÎ
 && !
mshrQueue
.
	`isFuÎ
()) {

1494 
	`ş—rBlocked
(
Blocked_NoMSHRs
);

1499 ià(
´eãtch”
 && 
mshrQueue
.
	`ÿnP»ãtch
()) {

1500 
Tick
 
Ãxt_pf_time
 = 
¡d
::
	`max
(
´eãtch”
->
	`ÃxtP»ãtchR—dyTime
(),

1501 
	`şockEdge
());

1502 ià(
Ãxt_pf_time
 !ğ
MaxTick
)

1503 
	`schedMemSideS’dEv’t
(
Ãxt_pf_time
);

1507 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

1510 
	`doWr™ebacks
(
wr™ebacks
, 
fÜw¬d_time
);

1513 ià(
blk
 =ğ
‹mpBlock
 &&empBlock->
	`isV®id
()) {

1518 ià(
blk
->
	`isDœty
(è|| 
wr™ebackCËª
) {

1519 
Pack‘PŒ
 
wbPkt
 = 
	`wr™ebackBlk
(
blk
);

1520 
	`®loÿ‹Wr™eBufãr
(
wbPkt
, 
fÜw¬d_time
);

1522 ià(
	`isCachedAbove
(
wbPkt
))

1523 
wbPkt
->
	`£tBlockCached
();

1525 
Pack‘PŒ
 
wcPkt
 = 
	`ş—nEviùBlk
(
blk
);

1528 ià(
	`isCachedAbove
(
wcPkt
))

1529 
d–‘e
 
wcPkt
;

1531 
	`®loÿ‹Wr™eBufãr
(
wcPkt
, 
fÜw¬d_time
);

1533 
blk
->
	`šv®id©e
();

1536 
	`DPRINTF
(
CacheV”bo£
, "L—všg % w™h % fÜ‡dd¸%#Îx\n", 
__func__
,

1537 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

1538 
d–‘e
 
pkt
;

1539 
	}
}

1541 
Pack‘PŒ


1542 
	gCache
::
	$wr™ebackBlk
(
CacheBlk
 *
blk
)

1544 
	`ch©ty_as£¹
(!
isR—dOÆy
 || 
wr™ebackCËª
,

1546 
	`as£¹
(
blk
 && blk->
	`isV®id
(è&& (blk->
	`isDœty
(è|| 
wr™ebackCËª
));

1548 
wr™ebacks
[
Reque¡
::
wbMa¡”Id
]++;

1550 
Reque¡
 *
»q
 = 
Ãw
 
	`Reque¡
(
gs
->
	`»g’”©eBlkAddr
(
blk
->
g
, blk->
£t
),

1551 
blkSize
, 0, 
Reque¡
::
wbMa¡”Id
);

1552 ià(
blk
->
	`isSecu»
())

1553 
»q
->
	`£tFÏgs
(
Reque¡
::
SECURE
);

1555 
»q
->
	`skId
(
blk
->
sk_id
);

1556 
blk
->
sk_id
ğ
CÚ‹xtSw™chTaskId
::
Unknown
;

1557 
blk
->
tickIn£¹ed
 = 
	`curTick
();

1559 
Pack‘PŒ
 
pkt
 =

1560 
Ãw
 
	`Pack‘
(
»q
, 
blk
->
	`isDœty
() ?

1561 
MemCmd
::
Wr™ebackDœty
 : MemCmd::
Wr™ebackCËª
);

1563 
	`DPRINTF
(
Cache
, "Create Writeback %#llx writable: %d, dirty: %d\n",

1564 
pkt
->
	`g‘Addr
(), 
blk
->
	`isWr™abË
(), blk->
	`isDœty
());

1566 ià(
blk
->
	`isWr™abË
()) {

1569 
blk
->
¡©us
 &ğ~
BlkWr™abË
;

1572 
pkt
->
	`£tHasSh¬”s
();

1576 
blk
->
¡©us
 &ğ~
BlkDœty
;

1578 
pkt
->
	`®loÿ‹
();

1579 
¡d
::
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(), 
blk
->
d©a
, 
blkSize
);

1581  
pkt
;

1582 
	}
}

1584 
Pack‘PŒ


1585 
	gCache
::
	$ş—nEviùBlk
(
CacheBlk
 *
blk
)

1587 
	`as£¹
(!
wr™ebackCËª
);

1588 
	`as£¹
(
blk
 && blk->
	`isV®id
(è&& !blk->
	`isDœty
());

1590 
Reque¡
 *
»q
 =

1591 
Ãw
 
	`Reque¡
(
gs
->
	`»g’”©eBlkAddr
(
blk
->
g
, blk->
£t
), 
blkSize
, 0,

1592 
Reque¡
::
wbMa¡”Id
);

1593 ià(
blk
->
	`isSecu»
())

1594 
»q
->
	`£tFÏgs
(
Reque¡
::
SECURE
);

1596 
»q
->
	`skId
(
blk
->
sk_id
);

1597 
blk
->
sk_id
 = 
CÚ‹xtSw™chTaskId
::
Unknown
;

1598 
blk
->
tickIn£¹ed
 = 
	`curTick
();

1600 
Pack‘PŒ
 
pkt
 = 
Ãw
 
	`Pack‘
(
»q
, 
MemCmd
::
CËªEviù
);

1601 
pkt
->
	`®loÿ‹
();

1602 
	`DPRINTF
(
Cache
, "%s% %x C»©CËªEviù\n", 
pkt
->
	`cmdSŒšg
(),

1603 
pkt
->
»q
->
	`isIn¡F‘ch
() ? " (ifetch)" : "",

1604 
pkt
->
	`g‘Addr
());

1606  
pkt
;

1607 
	}
}

1610 
	gCache
::
	$memWr™eback
()

1612 
CacheBlkVis™ÜW¿µ”
 
	`vis™Ü
(*
this
, &
Cache
::
wr™ebackVis™Ü
);

1613 
gs
->
	`fÜEachBlk
(
vis™Ü
);

1614 
	}
}

1617 
	gCache
::
	$memInv®id©e
()

1619 
CacheBlkVis™ÜW¿µ”
 
	`vis™Ü
(*
this
, &
Cache
::
šv®id©eVis™Ü
);

1620 
gs
->
	`fÜEachBlk
(
vis™Ü
);

1621 
	}
}

1623 
boŞ


1624 
	gCache
::
	$isDœty
() const

1626 
CacheBlkIsDœtyVis™Ü
 
vis™Ü
;

1627 
gs
->
	`fÜEachBlk
(
vis™Ü
);

1629  
vis™Ü
.
	`isDœty
();

1630 
	}
}

1632 
boŞ


1633 
	gCache
::
	$wr™ebackVis™Ü
(
CacheBlk
 &
blk
)

1635 ià(
blk
.
	`isDœty
()) {

1636 
	`as£¹
(
blk
.
	`isV®id
());

1638 
Reque¡
 
	`»que¡
(
gs
->
	`»g’”©eBlkAddr
(
blk
.
g
, blk.
£t
),

1639 
blkSize
, 0, 
Reque¡
::
funcMa¡”Id
);

1640 
»que¡
.
	`skId
(
blk
.
sk_id
);

1642 
Pack‘
 
	`·ck‘
(&
»que¡
, 
MemCmd
::
Wr™eReq
);

1643 
·ck‘
.
	`d©aStic
(
blk
.
d©a
);

1645 
memSidePÜt
->
	`£ndFunùiÚ®
(&
·ck‘
);

1647 
blk
.
¡©us
 &ğ~
BlkDœty
;

1650  
Œue
;

1651 
	}
}

1653 
boŞ


1654 
	gCache
::
	$šv®id©eVis™Ü
(
CacheBlk
 &
blk
)

1657 ià(
blk
.
	`isDœty
())

1658 
	`w¬n_Úû
("Invalidating dirty cache†ines. Expecthingso break.\n");

1660 ià(
blk
.
	`isV®id
()) {

1661 
	`as£¹
(!
blk
.
	`isDœty
());

1662 
gs
->
	`šv®id©e
(&
blk
);

1663 
blk
.
	`šv®id©e
();

1666  
Œue
;

1667 
	}
}

1669 
CacheBlk
*

1670 
	gCache
::
	$®loÿ‹Block
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Pack‘Li¡
 &
wr™ebacks
)

1672 
CacheBlk
 *
blk
 = 
gs
->
	`fšdViùim
(
addr
);

1675 ià(!
blk
)

1676  
nuÎ±r
;

1678 ià(
blk
->
	`isV®id
()) {

1679 
Addr
 
»¶_addr
 = 
gs
->
	`»g’”©eBlkAddr
(
blk
->
g
, blk->
£t
);

1680 
MSHR
 *
»¶_mshr
 = 
mshrQueue
.
	`fšdM©ch
(
»¶_addr
, 
blk
->
	`isSecu»
());

1681 ià(
»¶_mshr
) {

1684 
	`as£¹
(!
blk
->
	`isWr™abË
(è|| blk->
	`isDœty
());

1685 
	`as£¹
(
»¶_mshr
->
	`ÃedsWr™abË
());

1688  
nuÎ±r
;

1690 
	`DPRINTF
(
Cache
, "replacement:„eplacing %#llx (%s) with %#llx "

1691 "(%s): %s\n", 
»¶_addr
, 
blk
->
	`isSecu»
() ? "s" : "ns",

1692 
addr
, 
is_£cu»
 ? "s" : "ns",

1693 
blk
->
	`isDœty
() ? "writeback" : "clean");

1695 ià(
blk
->
	`wasP»ãtched
()) {

1696 
unu£dP»ãtches
++;

1700 ià(
blk
->
	`isDœty
(è|| 
wr™ebackCËª
) {

1702 
wr™ebacks
.
	`push_back
(
	`wr™ebackBlk
(
blk
));

1704 
wr™ebacks
.
	`push_back
(
	`ş—nEviùBlk
(
blk
));

1709  
blk
;

1710 
	}
}

1713 
	gCache
::
	$šv®id©eBlock
(
CacheBlk
 *
blk
)

1715 ià(
blk
 !ğ
‹mpBlock
)

1716 
gs
->
	`šv®id©e
(
blk
);

1717 
blk
->
	`šv®id©e
();

1718 
	}
}

1725 
CacheBlk
*

1726 
	gCache
::
	$hªdËFl
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
, 
Pack‘Li¡
 &
wr™ebacks
,

1727 
boŞ
 
®loÿ‹
)

1729 
	`as£¹
(
pkt
->
	`isRe¥Ú£
(è||…kt->
cmd
 =ğ
MemCmd
::
Wr™eLšeReq
);

1730 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

1731 
boŞ
 
is_£cu»
 = 
pkt
->
	`isSecu»
();

1732 #ià
TRACING_ON


1733 
CacheBlk
::
S‹
 
Şd_¡©e
 = 
blk
 ? blk->
¡©us
 : 0;

1737 
	`as£¹
(
addr
 =ğ
	`blockAlign
(addr));

1738 
	`as£¹
(!
wr™eBufãr
.
	`fšdM©ch
(
addr
, 
is_£cu»
));

1740 ià(
blk
 =ğ
nuÎ±r
) {

1742 
	`as£¹
(
pkt
->
	`hasD©a
());

1747 
	`as£¹
(
pkt
->
	`isR—d
(è||…kt->
cmd
 =ğ
MemCmd
::
Wr™eLšeReq
);

1751 
blk
 = 
®loÿ‹
 ? 
	`®loÿ‹Block
(
addr
, 
is_£cu»
, 
wr™ebacks
è: 
nuÎ±r
;

1753 ià(
blk
 =ğ
nuÎ±r
) {

1757 
	`as£¹
(!
‹mpBlock
->
	`isV®id
());

1758 
blk
 = 
‹mpBlock
;

1759 
‹mpBlock
->
£t
 = 
gs
->
	`exŒaùS‘
(
addr
);

1760 
‹mpBlock
->
g
 = 
gs
->
	`exŒaùTag
(
addr
);

1762 
	`DPRINTF
(
Cache
, "usšgem°block fÜ %#Îx (%s)\n", 
addr
,

1763 
is_£cu»
 ? "s" : "ns");

1765 
gs
->
	`š£¹Block
(
pkt
, 
blk
);

1769 
	`as£¹
(!
blk
->
	`isV®id
());

1772 
	`as£¹
(
blk
->
g
 =ğ
gs
->
	`exŒaùTag
(
addr
));

1774 
	`as£¹
(
pkt
->
	`hasD©a
(è|| 
blk
->
	`isV®id
());

1779 ià(
is_£cu»
)

1780 
blk
->
¡©us
 |ğ
BlkSecu»
;

1781 
blk
->
¡©us
 |ğ
BlkV®id
 | 
BlkR—dabË
;

1786 ià(
pkt
->
cmd
 =ğ
MemCmd
::
Wr™eLšeReq
) {

1787 
	`as£¹
(!
pkt
->
	`hasSh¬”s
());

1790 
	`as£¹
(!
pkt
->
	`ÿcheRe¥Údšg
());

1800 ià(!
pkt
->
	`hasSh¬”s
()) {

1804 
blk
->
¡©us
 |ğ
BlkWr™abË
;

1808 ià(
pkt
->
	`ÿcheRe¥Údšg
()) {

1811 
blk
->
¡©us
 |ğ
BlkDœty
;

1813 
	`ch©ty_as£¹
(!
isR—dOÆy
, "Should‚ever see dirty snoop„esponse "

1814 "š„—d-Úly cach%s\n", 
	`Çme
());

1818 
	`DPRINTF
(
Cache
, "Block‡ddr %#llx (%s) moving from state %xo %s\n",

1819 
addr
, 
is_£cu»
 ? "s" : "ns", 
Şd_¡©e
, 
blk
->
	`´št
());

1823 ià(
pkt
->
	`isR—d
()) {

1825 
	`as£¹
(
pkt
->
	`hasD©a
());

1826 
	`as£¹
(
pkt
->
	`g‘Size
(è=ğ
blkSize
);

1828 
¡d
::
	`memıy
(
blk
->
d©a
, 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(), 
blkSize
);

1831 
blk
->
wh’R—dy
 = 
	`şockEdge
(è+ 
flL©’cy
 * 
	`şockP”iod
() +

1832 
pkt
->
·ylßdD–ay
;

1834  
blk
;

1835 
	}
}

1845 
	gCache
::
	$doTimšgSuµlyRe¥Ú£
(
Pack‘PŒ
 
»q_pkt
, cÚ¡ 
ušt8_t
 *
blk_d©a
,

1846 
boŞ
 
®»ady_cİ›d
, boŞ 
³ndšg_šv®
)

1849 
	`as£¹
(
»q_pkt
->
	`isReque¡
());

1850 
	`as£¹
(
»q_pkt
->
	`ÃedsRe¥Ú£
());

1852 
	`DPRINTF
(
Cache
, "% fÜ % add¸%#Îx siz%d\n", 
__func__
,

1853 
»q_pkt
->
	`cmdSŒšg
(),„eq_pkt->
	`g‘Addr
(),„eq_pkt->
	`g‘Size
());

1856 
Pack‘PŒ
 
pkt
 = 
»q_pkt
;

1857 ià(!
®»ady_cİ›d
)

1861 
pkt
 = 
Ãw
 
	`Pack‘
(
»q_pkt
, 
çl£
,„eq_pkt->
	`isR—d
());

1863 
	`as£¹
(
»q_pkt
->
»q
->
	`isUnÿch—bË
(è||„eq_pkt->
	`isInv®id©e
() ||

1864 
pkt
->
	`hasSh¬”s
());

1865 
pkt
->
	`makeTimšgRe¥Ú£
();

1866 ià(
pkt
->
	`isR—d
()) {

1867 
pkt
->
	`£tD©aFromBlock
(
blk_d©a
, 
blkSize
);

1869 ià(
pkt
->
cmd
 =ğ
MemCmd
::
R—dRe¥
 && 
³ndšg_šv®
) {

1877 
pkt
->
cmd
 = 
MemCmd
::
R—dRe¥W™hInv®id©e
;

1882 
Tick
 
fÜw¬d_time
 = 
	`şockEdge
(
fÜw¬dL©’cy
è+ 
pkt
->
h—d”D–ay
;

1884 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

1885 
	`DPRINTF
(
CacheV”bo£
,

1887 
__func__
, 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
(),

1888 
fÜw¬d_time
);

1889 
memSidePÜt
->
	`schedTimšgSnoİRe¥
(
pkt
, 
fÜw¬d_time
, 
Œue
);

1890 
	}
}

1892 
ušt32_t


1893 
	gCache
::
	$hªdËSnoİ
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
, 
boŞ
 
is_timšg
,

1894 
boŞ
 
is_deã¼ed
, boŞ 
³ndšg_šv®
)

1896 
	`DPRINTF
(
CacheV”bo£
, "% fÜ % add¸%#Îx siz%d\n", 
__func__
,

1897 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

1899 
	`as£¹
(!(
is_deã¼ed
 && !
is_timšg
));

1901 
	`as£¹
(!(
³ndšg_šv®
 && !
is_deã¼ed
));

1902 
	`as£¹
(
pkt
->
	`isReque¡
());

1907 
boŞ
 
šv®id©e
 = 
pkt
->
	`isInv®id©e
();

1908 
boŞ
 
M5_VAR_USED
 
Ãeds_wr™abË
 = 
pkt
->
	`ÃedsWr™abË
();

1913 
	`·nic_if
(
šv®id©e
 && 
pkt
->
»q
->
	`isUnÿch—bË
(),

1915 
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

1917 
ušt32_t
 
¢oİ_d–ay
 = 0;

1919 ià(
fÜw¬dSnoİs
) {

1923 
boŞ
 
®»adyRe¥Úded
 = 
pkt
->
	`ÿcheRe¥Údšg
();

1924 ià(
is_timšg
) {

1929 
Pack‘
 
	`¢oİPkt
(
pkt
, 
Œue
,rue);

1930 
¢oİPkt
.
	`£tEx´essSnoİ
();

1933 
¢oİPkt
.
h—d”D–ay
 = snoİPkt.
·ylßdD–ay
 = 0;

1934 
ıuSidePÜt
->
	`£ndTimšgSnoİReq
(&
¢oİPkt
);

1939 
¢oİ_d–ay
 +ğ
¢oİPkt
.
h—d”D–ay
;

1941 ià(
¢oİPkt
.
	`ÿcheRe¥Údšg
()) {

1943 
	`as£¹
(!
®»adyRe¥Úded
);

1944 
pkt
->
	`£tCacheRe¥Údšg
();

1948 ià(
¢oİPkt
.
	`hasSh¬”s
()) {

1949 
pkt
->
	`£tHasSh¬”s
();

1954 ià(
¢oİPkt
.
	`isBlockCached
()) {

1955 
pkt
->
	`£tBlockCached
();

1958 
ıuSidePÜt
->
	`£ndAtomicSnoİ
(
pkt
);

1959 ià(!
®»adyRe¥Úded
 && 
pkt
->
	`ÿcheRe¥Údšg
()) {

1962 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

1967 ià(!
blk
 || !blk->
	`isV®id
()) {

1968 ià(
is_deã¼ed
) {

1972 
	`as£¹
(
pkt
->
	`ÃedsRe¥Ú£
());

1976 
	`as£¹
(
pkt
->
	`ÿcheRe¥Údšg
());

1978 
d–‘e
 
pkt
;

1981 
	`DPRINTF
(
CacheV”bo£
, "%s snoop miss for %s‡ddr %#llx size %d\n",

1982 
__func__
, 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

1983  
¢oİ_d–ay
;

1985 
	`DPRINTF
(
Cache
, "%s snoop hit for %s‡ddr %#llx size %d, "

1986 "Şd s‹ i %s\n", 
__func__
, 
pkt
->
	`cmdSŒšg
(),

1987 
pkt
->
	`g‘Addr
(),…kt->
	`g‘Size
(), 
blk
->
	`´št
());

1990 
	`ch©ty_as£¹
(!(
isR—dOÆy
 && 
blk
->
	`isDœty
()),

1992 
	`Çme
());

1999 
boŞ
 
»¥Úd
 = 
blk
->
	`isDœty
(è&& 
pkt
->
	`ÃedsRe¥Ú£
() &&

2000 
pkt
->
cmd
 !ğ
MemCmd
::
Inv®id©eReq
;

2001 
boŞ
 
have_wr™abË
 = 
blk
->
	`isWr™abË
();

2007 ià(
pkt
->
	`mu¡CheckAbove
()) {

2008 
	`DPRINTF
(
Cache
, "Found‡ddr %#llx in upper†evel cache for snoop %s "

2009 "äom†ow” cache\n", 
pkt
->
	`g‘Addr
(),…kt->
	`cmdSŒšg
());

2010 
pkt
->
	`£tBlockCached
();

2011  
¢oİ_d–ay
;

2014 ià(
pkt
->
	`isR—d
(è&& !
šv®id©e
) {

2016 
	`as£¹
(!
Ãeds_wr™abË
);

2017 
pkt
->
	`£tHasSh¬”s
();

2024 ià(!
pkt
->
»q
->
	`isUnÿch—bË
())

2025 
blk
->
¡©us
 &ğ~
BlkWr™abË
;

2028 ià(
»¥Úd
) {

2032 
pkt
->
	`£tCacheRe¥Údšg
();

2033 ià(
have_wr™abË
) {

2037 
pkt
->
	`£tRe¥Úd”HadWr™abË
();

2051 
	`·nic_if
(!
šv®id©e
 && !
pkt
->
	`hasSh¬”s
(),

2054 
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

2056 ià(
is_timšg
) {

2057 
	`doTimšgSuµlyRe¥Ú£
(
pkt
, 
blk
->
d©a
, 
is_deã¼ed
, 
³ndšg_šv®
);

2059 
pkt
->
	`makeAtomicRe¥Ú£
();

2062 ià(
pkt
->
	`hasD©a
())

2063 
pkt
->
	`£tD©aFromBlock
(
blk
->
d©a
, 
blkSize
);

2067 ià(!
»¥Úd
 && 
is_deã¼ed
) {

2068 
	`as£¹
(
pkt
->
	`ÃedsRe¥Ú£
());

2074 ià(!
pkt
->
	`ÿcheRe¥Údšg
()) {

2075 
d–‘e
 
pkt
->
»q
;

2078 
d–‘e
 
pkt
;

2083 ià(
šv®id©e
) {

2084 
	`šv®id©eBlock
(
blk
);

2087 
	`DPRINTF
(
Cache
, "Ãw s‹ i %s\n", 
blk
->
	`´št
());

2089  
¢oİ_d–ay
;

2090 
	}
}

2094 
	gCache
::
	$»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

2096 
	`DPRINTF
(
CacheV”bo£
, "% fÜ % add¸%#Îx siz%d\n", 
__func__
,

2097 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

2100 
	`as£¹
(!
sy¡em
->
	`by·ssCaches
());

2103 ià(!
	`šRªge
(
pkt
->
	`g‘Addr
())) {

2107 
boŞ
 
is_£cu»
 = 
pkt
->
	`isSecu»
();

2108 
CacheBlk
 *
blk
 = 
gs
->
	`fšdBlock
(
pkt
->
	`g‘Addr
(), 
is_£cu»
);

2110 
Addr
 
blk_addr
 = 
	`blockAlign
(
pkt
->
	`g‘Addr
());

2111 
MSHR
 *
mshr
 = 
mshrQueue
.
	`fšdM©ch
(
blk_addr
, 
is_£cu»
);

2118 
pkt
->
¢oİD–ay
 = 
¡d
::
max
<
ušt32_t
>(pkt->snoopDelay,

2119 
lookupL©’cy
 * 
	`şockP”iod
());

2123 ià(
mshr
 && 
pkt
->
	`mu¡CheckAbove
()) {

2124 
	`DPRINTF
(
Cache
, "Setting block cached for %s from"

2126 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

2127 
pkt
->
	`£tBlockCached
();

2133 ià(
mshr
 && mshr->
	`hªdËSnoİ
(
pkt
, 
Üd”
++)) {

2134 
	`DPRINTF
(
Cache
, "Deferring snoop on in-service MSHRo blk %#llx (%s)."

2135 "mshrs: %s\n", 
blk_addr
, 
is_£cu»
 ? "s" : "ns",

2136 
mshr
->
	`´št
());

2138 ià(
mshr
->
	`g‘NumT¬g‘s
(è> 
numT¬g‘
)

2139 
	`w¬n
("allocating bonusarget for snoop");

2144 
Wr™eQueueEÁry
 *
wb_’Œy
 = 
wr™eBufãr
.
	`fšdM©ch
(
blk_addr
, 
is_£cu»
);

2145 ià(
wb_’Œy
) {

2146 
	`DPRINTF
(
Cache
, "Snoop hit in writebacko‡ddr %#llx (%s)\n",

2147 
pkt
->
	`g‘Addr
(), 
is_£cu»
 ? "s" : "ns");

2150 
	`as£¹
(!
wb_’Œy
->
	`isUnÿch—bË
());

2153 
	`as£¹
(
wb_’Œy
->
	`g‘NumT¬g‘s
() == 1);

2154 
Pack‘PŒ
 
wb_pkt
 = 
wb_’Œy
->
	`g‘T¬g‘
()->
pkt
;

2155 
	`as£¹
(
wb_pkt
->
	`isEviùiÚ
());

2157 ià(
pkt
->
	`isEviùiÚ
()) {

2162 
pkt
->
	`£tBlockCached
();

2163 
	`DPRINTF
(
Cache
, "Squashing %s from†ower cache on writequeue hit"

2164 " %#x\n", 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

2173 
boŞ
 
»¥Úd
 = 
wb_pkt
->
cmd
 =ğ
MemCmd
::
Wr™ebackDœty
 &&

2174 
pkt
->
	`ÃedsRe¥Ú£
(è&&…kt->
cmd
 !ğ
MemCmd
::
Inv®id©eReq
;

2175 
boŞ
 
have_wr™abË
 = !
wb_pkt
->
	`hasSh¬”s
();

2176 
boŞ
 
šv®id©e
 = 
pkt
->
	`isInv®id©e
();

2178 ià(!
pkt
->
»q
->
	`isUnÿch—bË
(è&&…kt->
	`isR—d
(è&& !
šv®id©e
) {

2179 
	`as£¹
(!
pkt
->
	`ÃedsWr™abË
());

2180 
pkt
->
	`£tHasSh¬”s
();

2181 
wb_pkt
->
	`£tHasSh¬”s
();

2184 ià(
»¥Úd
) {

2185 
pkt
->
	`£tCacheRe¥Údšg
();

2187 ià(
have_wr™abË
) {

2188 
pkt
->
	`£tRe¥Úd”HadWr™abË
();

2191 
	`doTimšgSuµlyRe¥Ú£
(
pkt
, 
wb_pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(),

2192 
çl£
, false);

2195 ià(
šv®id©e
) {

2198 
	`m¬kInS”viû
(
wb_’Œy
);

2199 
d–‘e
 
wb_pkt
;

2208 
ušt32_t
 
¢oİ_d–ay
 = 
	`hªdËSnoİ
(
pkt
, 
blk
, 
Œue
, 
çl£
, false);

2212 
pkt
->
¢oİD–ay
 = 
¡d
::
max
<
ušt32_t
>Õkt->¢oİD–ay, 
¢oİ_d–ay
 +

2213 
lookupL©’cy
 * 
	`şockP”iod
());

2214 
	}
}

2216 
boŞ


2217 
	gCache
::
CpuSidePÜt
::
	$»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

2220 
ÿche
->
	`»cvTimšgSnoİRe¥
(
pkt
);

2221  
Œue
;

2222 
	}
}

2224 
Tick


2225 
	gCache
::
	$»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

2228 
	`as£¹
(!
sy¡em
->
	`by·ssCaches
());

2231 ià(!
	`šRªge
(
pkt
->
	`g‘Addr
())) {

2235 
CacheBlk
 *
blk
 = 
gs
->
	`fšdBlock
(
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
());

2236 
ušt32_t
 
¢oİ_d–ay
 = 
	`hªdËSnoİ
(
pkt
, 
blk
, 
çl£
, false, false);

2237  
¢oİ_d–ay
 + 
lookupL©’cy
 * 
	`şockP”iod
();

2238 
	}
}

2241 
QueueEÁry
*

2242 
	gCache
::
	$g‘NextQueueEÁry
()

2247 
MSHR
 *
miss_mshr
 = 
mshrQueue
.
	`g‘Next
();

2248 
Wr™eQueueEÁry
 *
wq_’Œy
 = 
wr™eBufãr
.
	`g‘Next
();

2252 ià(
wq_’Œy
 && (
wr™eBufãr
.
	`isFuÎ
(è|| !
miss_mshr
)) {

2254 
MSHR
 *
cÚæiù_mshr
 =

2255 
mshrQueue
.
	`fšdP’dšg
(
wq_’Œy
->
blkAddr
,

2256 
wq_’Œy
->
isSecu»
);

2258 ià(
cÚæiù_mshr
 && cÚæiù_mshr->
Üd”
 < 
wq_’Œy
->order) {

2260  
cÚæiù_mshr
;

2266  
wq_’Œy
;

2267 } ià(
miss_mshr
) {

2269 
Wr™eQueueEÁry
 *
cÚæiù_mshr
 =

2270 
wr™eBufãr
.
	`fšdP’dšg
(
miss_mshr
->
blkAddr
,

2271 
miss_mshr
->
isSecu»
);

2272 ià(
cÚæiù_mshr
) {

2285  
cÚæiù_mshr
;

2291  
miss_mshr
;

2295 
	`as£¹
(!
miss_mshr
 && !
wq_’Œy
);

2296 ià(
´eãtch”
 && 
mshrQueue
.
	`ÿnP»ãtch
()) {

2298 
Pack‘PŒ
 
pkt
 = 
´eãtch”
->
	`g‘Pack‘
();

2299 ià(
pkt
) {

2300 
Addr
 
pf_addr
 = 
	`blockAlign
(
pkt
->
	`g‘Addr
());

2301 ià(!
gs
->
	`fšdBlock
(
pf_addr
, 
pkt
->
	`isSecu»
()) &&

2302 !
mshrQueue
.
	`fšdM©ch
(
pf_addr
, 
pkt
->
	`isSecu»
()) &&

2303 !
wr™eBufãr
.
	`fšdM©ch
(
pf_addr
, 
pkt
->
	`isSecu»
())) {

2306 
	`as£¹
(
pkt
->
»q
->
	`ma¡”Id
(è< 
sy¡em
->
	`maxMa¡”s
());

2307 
mshr_mis£s
[
pkt
->
	`cmdToIndex
()][pkt->
»q
->
	`ma¡”Id
()]++;

2312  
	`®loÿ‹MissBufãr
(
pkt
, 
	`curTick
(), 
çl£
);

2315 
d–‘e
 
pkt
->
»q
;

2316 
d–‘e
 
pkt
;

2321  
nuÎ±r
;

2322 
	}
}

2324 
boŞ


2325 
	gCache
::
	$isCachedAbove
(
Pack‘PŒ
 
pkt
, 
boŞ
 
is_timšg
) const

2327 ià(!
fÜw¬dSnoİs
)

2328  
çl£
;

2334 ià(
is_timšg
) {

2335 
Pack‘
 
	`¢oİ_pkt
(
pkt
, 
Œue
, 
çl£
);

2336 
¢oİ_pkt
.
	`£tEx´essSnoİ
();

2340 
	`as£¹
(
pkt
->
	`isEviùiÚ
());

2341 
¢oİ_pkt
.
£nd”S‹
 = 
nuÎ±r
;

2342 
ıuSidePÜt
->
	`£ndTimšgSnoİReq
(&
¢oİ_pkt
);

2344 
	`as£¹
(!(
¢oİ_pkt
.
	`ÿcheRe¥Údšg
()));

2345  
¢oİ_pkt
.
	`isBlockCached
();

2347 
ıuSidePÜt
->
	`£ndAtomicSnoİ
(
pkt
);

2348  
pkt
->
	`isBlockCached
();

2350 
	}
}

2352 
Tick


2353 
	gCache
::
	$ÃxtQueueR—dyTime
() const

2355 
Tick
 
ÃxtR—dy
 = 
¡d
::
	`mš
(
mshrQueue
.
	`ÃxtR—dyTime
(),

2356 
wr™eBufãr
.
	`ÃxtR—dyTime
());

2360 ià(
´eãtch”
 && 
mshrQueue
.
	`ÿnP»ãtch
()) {

2361 
ÃxtR—dy
 = 
¡d
::
	`mš
(nextReady,

2362 
´eãtch”
->
	`ÃxtP»ãtchR—dyTime
());

2365  
ÃxtR—dy
;

2366 
	}
}

2368 
boŞ


2369 
	gCache
::
	$£ndMSHRQueuePack‘
(
MSHR
* 
mshr
)

2371 
	`as£¹
(
mshr
);

2374 
Pack‘PŒ
 
tgt_pkt
 = 
mshr
->
	`g‘T¬g‘
()->
pkt
;

2376 
	`DPRINTF
(
Cache
, "% MSHR % fÜ‡dd¸%#Îx siz%d\n", 
__func__
,

2377 
tgt_pkt
->
	`cmdSŒšg
(),gt_pkt->
	`g‘Addr
(),

2378 
tgt_pkt
->
	`g‘Size
());

2380 
CacheBlk
 *
blk
 = 
gs
->
	`fšdBlock
(
mshr
->
blkAddr
, mshr->
isSecu»
);

2382 ià(
tgt_pkt
->
cmd
 =ğ
MemCmd
::
H¬dPFReq
 && 
fÜw¬dSnoİs
) {

2385 
	`as£¹
(
blk
 =ğ
nuÎ±r
);

2392 
Pack‘
 
	`¢oİ_pkt
(
tgt_pkt
, 
Œue
, 
çl£
);

2393 
¢oİ_pkt
.
	`£tEx´essSnoİ
();

2398 
¢oİ_pkt
.
£nd”S‹
 = 
mshr
;

2399 
ıuSidePÜt
->
	`£ndTimšgSnoİReq
(&
¢oİ_pkt
);

2413 ià(
¢oİ_pkt
.
	`ÿcheRe¥Údšg
()) {

2414 autØ
M5_VAR_USED
 
r
 = 
out¡ªdšgSnoİ
.
	`š£¹
(
¢oİ_pkt
.
»q
);

2415 
	`as£¹
(
r
.
£cÚd
);

2419 
boŞ
 
³ndšg_modif›d_»¥
 = !
¢oİ_pkt
.
	`hasSh¬”s
();

2420 
	`m¬kInS”viû
(
mshr
, 
³ndšg_modif›d_»¥
);

2422 
	`DPRINTF
(
Cache
, "Upward snoop of…refetch for‡ddr"

2424 
tgt_pkt
->
	`g‘Addr
(),gt_pkt->
	`isSecu»
()? "s": "ns");

2425  
çl£
;

2428 ià(
¢oİ_pkt
.
	`isBlockCached
()) {

2429 
	`DPRINTF
(
Cache
, "Block…resent,…refetch squashed by cache. "

2431 
mshr
->
blkAddr
);

2434 ià(
mshrQueue
.
	`fÜûD—Îoÿ‹T¬g‘
(
mshr
)) {

2437 
	`ş—rBlocked
(
Blocked_NoMSHRs
);

2439  
çl£
;

2445 
Pack‘PŒ
 
pkt
 = 
	`ü—‹MissPack‘
(
tgt_pkt
, 
blk
, 
mshr
->
	`ÃedsWr™abË
());

2447 
mshr
->
isFÜw¬d
 = (
pkt
 =ğ
nuÎ±r
);

2449 ià(
mshr
->
isFÜw¬d
) {

2453 
pkt
 = 
Ãw
 
	`Pack‘
(
tgt_pkt
, 
çl£
, 
Œue
);

2454 
	`as£¹
(!
pkt
->
	`isWr™e
());

2459 
pkt
->
	`pushS’d”S‹
(
mshr
);

2461 ià(!
memSidePÜt
->
	`£ndTimšgReq
(
pkt
)) {

2465 
d–‘e
 
pkt
;

2472  
Œue
;

2481 
boŞ
 
³ndšg_modif›d_»¥
 = !
pkt
->
	`hasSh¬”s
() &&

2482 
pkt
->
	`ÿcheRe¥Údšg
();

2483 
	`m¬kInS”viû
(
mshr
, 
³ndšg_modif›d_»¥
);

2484  
çl£
;

2486 
	}
}

2488 
boŞ


2489 
	gCache
::
	$£ndWr™eQueuePack‘
(
Wr™eQueueEÁry
* 
wq_’Œy
)

2491 
	`as£¹
(
wq_’Œy
);

2494 
Pack‘PŒ
 
tgt_pkt
 = 
wq_’Œy
->
	`g‘T¬g‘
()->
pkt
;

2496 
	`DPRINTF
(
Cache
, "% wr™% fÜ‡dd¸%#Îx siz%d\n", 
__func__
,

2497 
tgt_pkt
->
	`cmdSŒšg
(),gt_pkt->
	`g‘Addr
(),

2498 
tgt_pkt
->
	`g‘Size
());

2501 ià(!
memSidePÜt
->
	`£ndTimšgReq
(
tgt_pkt
)) {

2507  
Œue
;

2509 
	`m¬kInS”viû
(
wq_’Œy
);

2510  
çl£
;

2512 
	}
}

2515 
	gCache
::
	$£rŸlize
(
CheckpoštOut
 &
ı
) const

2517 
boŞ
 
	`dœty
(
	`isDœty
());

2519 ià(
dœty
) {

2520 
	`w¬n
("*** The cache still contains dirty data. ***\n");

2521 
	`w¬n
(" Make sureo drainhe system usinghe correct flags.\n");

2522 
	`w¬n
(" This checkpoint will‚ot„estore correctly‡nd dirty data "

2530 
boŞ
 
	`bad_checkpošt
(
dœty
);

2531 
	`SERIALIZE_SCALAR
(
bad_checkpošt
);

2532 
	}
}

2535 
	gCache
::
	$un£rŸlize
(
CheckpoštIn
 &
ı
)

2537 
boŞ
 
bad_checkpošt
;

2538 
	`UNSERIALIZE_SCALAR
(
bad_checkpošt
);

2539 ià(
bad_checkpošt
) {

2540 
	`çl
("Restoring from checkpoints with dirty caches is‚ot supported "

2544 
	}
}

2552 
AddrRªgeLi¡


2553 
	gCache
::
CpuSidePÜt
::
	$g‘AddrRªges
() const

2555  
ÿche
->
	`g‘AddrRªges
();

2556 
	}
}

2558 
boŞ


2559 
	gCache
::
CpuSidePÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

2561 
	`as£¹
(!
ÿche
->
sy¡em
->
	`by·ssCaches
());

2563 
boŞ
 
sucûss
 = 
çl£
;

2566 ià(
pkt
->
	`isEx´essSnoİ
()) {

2568 
boŞ
 
M5_VAR_USED
 
by·ss_sucûss
 = 
ÿche
->
	`»cvTimšgReq
(
pkt
);

2569 
	`as£¹
(
by·ss_sucûss
);

2570  
Œue
;

2571 } ià(
blocked
 || 
mu¡S’dR‘ry
) {

2573 
sucûss
 = 
çl£
;

2577 
sucûss
 = 
ÿche
->
	`»cvTimšgReq
(
pkt
);

2581 
mu¡S’dR‘ry
 = !
sucûss
;

2582  
sucûss
;

2583 
	}
}

2585 
Tick


2586 
	gCache
::
CpuSidePÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

2588  
ÿche
->
	`»cvAtomic
(
pkt
);

2589 
	}
}

2592 
	gCache
::
CpuSidePÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

2595 
ÿche
->
	`funùiÚ®Acûss
(
pkt
, 
Œue
);

2596 
	}
}

2598 
	gCache
::

2599 
CpuSidePÜt
::
	$CpuSidePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
Cache
 *
_ÿche
,

2600 cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
)

2601 : 
Ba£Cache
::
	`CacheSÏvePÜt
(
_Çme
, 
_ÿche
, 
_Ïb–
), 
	$ÿche
(
_ÿche
)

2603 
	}
}

2605 
Cache
*

2606 
	gCacheP¬ams
::
	$ü—‹
()

2608 
	`as£¹
(
gs
);

2610  
Ãw
 
	`Cache
(
this
);

2611 
	}
}

2618 
boŞ


2619 
	gCache
::
MemSidePÜt
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

2621 
ÿche
->
	`»cvTimšgRe¥
(
pkt
);

2622  
Œue
;

2623 
	}
}

2627 
	gCache
::
MemSidePÜt
::
	$»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

2630 
ÿche
->
	`»cvTimšgSnoİReq
(
pkt
);

2631 
	}
}

2633 
Tick


2634 
	gCache
::
MemSidePÜt
::
	$»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

2636  
ÿche
->
	`»cvAtomicSnoİ
(
pkt
);

2637 
	}
}

2640 
	gCache
::
MemSidePÜt
::
	$»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

2645 
ÿche
->
	`funùiÚ®Acûss
(
pkt
, 
çl£
);

2646 
	}
}

2649 
	gCache
::
CacheReqPack‘Queue
::
	$£ndDeã¼edPack‘
()

2652 
	`as£¹
(!
wa™šgOnR‘ry
);

2657 
	`as£¹
(
	`deã¼edPack‘R—dyTime
(è=ğ
MaxTick
);

2660 
QueueEÁry
* 
’Œy
 = 
ÿche
.
	`g‘NextQueueEÁry
();

2662 ià(!
’Œy
) {

2669 ià(
	`checkCÚæiùšgSnoİ
(
’Œy
->
blkAddr
)) {

2672 
wa™šgOnR‘ry
 = 
’Œy
->
	`£ndPack‘
(
ÿche
);

2679 ià(!
wa™šgOnR‘ry
) {

2680 
	`schedS’dEv’t
(
ÿche
.
	`ÃxtQueueR—dyTime
());

2682 
	}
}

2684 
	gCache
::

2685 
MemSidePÜt
::
	$MemSidePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
Cache
 *
_ÿche
,

2686 cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
)

2687 : 
Ba£Cache
::
	`CacheMa¡”PÜt
(
_Çme
, 
_ÿche
, 
_»qQueue
, 
_¢oİRe¥Queue
),

2688 
	`_»qQueue
(*
_ÿche
, *
this
, 
_¢oİRe¥Queue
, 
_Ïb–
),

2689 
	`_¢oİRe¥Queue
(*
_ÿche
, *
this
, 
_Ïb–
), 
	$ÿche
(
_ÿche
)

2691 
	}
}

	@cache/cache.hh

52 #iâdeà
__MEM_CACHE_CACHE_HH__


53 
	#__MEM_CACHE_CACHE_HH__


	)

55 
	~"ba£/misc.hh
"

56 
	~"’ums/Clusiv™y.hh
"

57 
	~"mem/ÿche/ba£.hh
"

58 
	~"mem/ÿche/blk.hh
"

59 
	~"mem/ÿche/mshr.hh
"

60 
	~"mem/ÿche/gs/ba£.hh
"

61 
	~"·¿ms/Cache.hh
"

62 
	~"sim/ev’tq.hh
"

65 
şass
 
	gBa£P»ãtch”
;

72 şas 
	cCache
 : 
public
 
Ba£Cache


74 
public
:

77 
¡d
::
	tli¡
<
	tCacheBlk
*> 
	tBlkLi¡
;

79 
	m´Ùeùed
:

85 şas 
	cCpuSidePÜt
 : 
public
 
CacheSÏvePÜt


87 
´iv©e
:

90 
Cache
 *
ÿche
;

92 
	m´Ùeùed
:

94 
vœtu®
 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
);

96 
vœtu®
 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

98 
vœtu®
 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

100 
vœtu®
 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

102 
vœtu®
 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

104 
	mpublic
:

106 
CpuSidePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
Cache
 *
_ÿche
,

107 cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
);

117 şas 
	cCacheReqPack‘Queue
 : 
public
 
ReqPack‘Queue


120 
´Ùeùed
:

122 
Cache
 &
ÿche
;

123 
	gSnoİRe¥Pack‘Queue
 &
	g¢oİRe¥Queue
;

125 
	gpublic
:

127 
CacheReqPack‘Queue
(
Cache
 &
ÿche
, 
Ma¡”PÜt
 &
pÜt
,

128 
SnoİRe¥Pack‘Queue
 &
¢oİ_»¥_queue
,

129 cÚ¡ 
¡d
::
¡ršg
 &
Ïb–
) :

130 
ReqPack‘Queue
(
ÿche
, 
pÜt
, 
Ïb–
), cache(cache),

131 
¢oİRe¥Queue
(
¢oİ_»¥_queue
) { }

138 
vœtu®
 
£ndDeã¼edPack‘
();

146 
boŞ
 
checkCÚæiùšgSnoİ
(
Addr
 
addr
)

148 ià(
	g¢oİRe¥Queue
.
hasAddr
(
addr
)) {

149 
DPRINTF
(
CachePÜt
, "Waiting for snoop„esponseo be "

151 
Tick
 
	gwh’
 = 
¢oİRe¥Queue
.
deã¼edPack‘R—dyTime
();

152 
schedS’dEv’t
(
wh’
);

153  
	gŒue
;

155  
	gçl£
;

163 şas 
	cMemSidePÜt
 : 
public
 
CacheMa¡”PÜt


165 
´iv©e
:

168 
CacheReqPack‘Queue
 
_»qQueue
;

170 
SnoİRe¥Pack‘Queue
 
	g_¢oİRe¥Queue
;

173 
Cache
 *
	gÿche
;

175 
	g´Ùeùed
:

177 
vœtu®
 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
);

179 
vœtu®
 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

181 
vœtu®
 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
);

183 
vœtu®
 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
);

185 
	gpublic
:

187 
MemSidePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
Cache
 *
_ÿche
,

188 cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
);

192 
Ba£Tags
 *
	ggs
;

195 
Ba£P»ãtch”
 *
	g´eãtch”
;

198 
CacheBlk
 *
	g‹mpBlock
;

203 cÚ¡ 
boŞ
 
	gdoFa¡Wr™es
;

208 
´omÙeWhŞeLšeWr™es
(
Pack‘PŒ
 
pkt
);

213 cÚ¡ 
boŞ
 
	g´eãtchOnAcûss
;

220 cÚ¡ 
	gEnums
::
Clusiv™y
 
şusiv™y
;

229 cÚ¡ 
boŞ
 
	gwr™ebackCËª
;

235 
	g¡d
::
unique_±r
<
Pack‘
> 
³ndšgD–‘e
;

244 
Pack‘PŒ
 
	g‹mpBlockWr™eback
;

251 
	$wr™ebackTempBlockAtomic
() {

252 
	`as£¹
(
‹mpBlockWr™eback
 !ğ
nuÎ±r
);

253 
Pack‘Li¡
 
wr™ebacks
{
‹mpBlockWr™eback
};

254 
	`doWr™ebacksAtomic
(
wr™ebacks
);

255 
‹mpBlockWr™eback
 = 
nuÎ±r
;

256 
	}
}

263 
	gEv’tW¿µ”
<
	gCache
, &Cache::
wr™ebackTempBlockAtomic
> \

264 
wr™ebackTempBlockAtomicEv’t
;

271 
	g¡d
::
unÜd”ed_£t
<
Reque¡PŒ
> 
out¡ªdšgSnoİ
;

281 
boŞ
 
acûss
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *&
blk
,

282 
Cyşes
 &
Ït
, 
Pack‘Li¡
 &
wr™ebacks
);

287 
cmpAndSw­
(
CacheBlk
 *
blk
, 
Pack‘PŒ
 
pkt
);

296 
CacheBlk
 *
®loÿ‹Block
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Pack‘Li¡
 &
wr™ebacks
);

303 
šv®id©eBlock
(
CacheBlk
 *
blk
);

314 
maššClusiv™y
(
boŞ
 
äom_ÿche
, 
CacheBlk
 *
blk
);

326 
CacheBlk
 *
hªdËFl
(
Pack‘PŒ
 
pkt
, CacheBlk *
blk
,

327 
Pack‘Li¡
 &
wr™ebacks
, 
boŞ
 
®loÿ‹
);

342 
šlše
 
boŞ
 
	$®locOnFl
(
MemCmd
 
cmd
ècÚ¡ 
ov”ride


344  
şusiv™y
 =ğ
Enums
::
mo¡ly_šş
 ||

345 
cmd
 =ğ
MemCmd
::
Wr™eLšeReq
 ||

346 
cmd
 =ğ
MemCmd
::
R—dReq
 ||

347 
cmd
 =ğ
MemCmd
::
Wr™eReq
 ||

348 
cmd
.
	`isP»ãtch
() ||

349 
cmd
.
	`isLLSC
();

350 
	}
}

357 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

362 
doWr™ebacks
(
Pack‘Li¡
& 
wr™ebacks
, 
Tick
 
fÜw¬d_time
);

367 
doWr™ebacksAtomic
(
Pack‘Li¡
& 
wr™ebacks
);

373 
hªdËUnÿch—bËWr™eRe¥
(
Pack‘PŒ
 
pkt
);

379 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

385 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
);

391 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
);

398 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

406 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
);

413 
funùiÚ®Acûss
(
Pack‘PŒ
 
pkt
, 
boŞ
 
äomCpuSide
);

428 
§tisfyReque¡
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
,

429 
boŞ
 
deã¼ed_»¥Ú£
 = 
çl£
,

430 
boŞ
 
³ndšg_downg¿de
 = 
çl£
);

432 
doTimšgSuµlyRe¥Ú£
(
Pack‘PŒ
 
»q_pkt
, cÚ¡ 
ušt8_t
 *
blk_d©a
,

433 
boŞ
 
®»ady_cİ›d
, boŞ 
³ndšg_šv®
);

447 
ušt32_t
 
hªdËSnoİ
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
,

448 
boŞ
 
is_timšg
, boŞ 
is_deã¼ed
, boŞ 
³ndšg_šv®
);

455 
Pack‘PŒ
 
wr™ebackBlk
(
CacheBlk
 *
blk
);

462 
Pack‘PŒ
 
ş—nEviùBlk
(
CacheBlk
 *
blk
);

465 
	$memWr™eback
(è
ov”ride
;

466 
	$memInv®id©e
(è
ov”ride
;

467 
boŞ
 
	$isDœty
(ècÚ¡ 
ov”ride
;

475 
boŞ
 
	`wr™ebackVis™Ü
(
CacheBlk
 &
blk
);

483 
boŞ
 
	`šv®id©eVis™Ü
(
CacheBlk
 &
blk
);

496 
Pack‘PŒ
 
	$ü—‹MissPack‘
(
Pack‘PŒ
 
ıu_pkt
, 
CacheBlk
 *
blk
,

497 
boŞ
 
ÃedsWr™abË
) const;

505 
QueueEÁry
* 
	`g‘NextQueueEÁry
();

511 
boŞ
 
	$isCachedAbove
(
Pack‘PŒ
 
pkt
, 
boŞ
 
is_timšg
 = 
Œue
) const;

516 
boŞ
 
	$out¡ªdšgMis£s
() const

518  !
mshrQueue
.
	`isEm±y
();

519 
	}
}

521 
CacheBlk
 *
	$fšdBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const {

522  
gs
->
	`fšdBlock
(
addr
, 
is_£cu»
);

523 
	}
}

525 
boŞ
 
	$šCache
(
Addr
 
addr
, 
boŞ
 
is_£cu»
ècÚ¡ 
ov”ride
 {

526  (
gs
->
	`fšdBlock
(
addr
, 
is_£cu»
) != 0);

527 
	}
}

529 
boŞ
 
	$šMissQueue
(
Addr
 
addr
, 
boŞ
 
is_£cu»
ècÚ¡ 
ov”ride
 {

530  (
mshrQueue
.
	`fšdM©ch
(
addr
, 
is_£cu»
) != 0);

531 
	}
}

536 
Tick
 
	$ÃxtQueueR—dyTime
() const;

538 
public
:

540 
	`Cache
(cÚ¡ 
CacheP¬ams
 *
p
);

543 
vœtu®
 ~
	`Cache
();

545 
	$»gSts
(è
ov”ride
;

555 
boŞ
 
	`£ndMSHRQueuePack‘
(
MSHR
* 
mshr
);

565 
boŞ
 
	`£ndWr™eQueuePack‘
(
Wr™eQueueEÁry
* 
wq_’Œy
);

570 
	$£rŸlize
(
CheckpoštOut
 &
ı
ècÚ¡ 
ov”ride
;

571 
	$un£rŸlize
(
CheckpoštIn
 &
ı
è
ov”ride
;

572 
	}
};

582 şas 
	cCacheBlkVis™ÜW¿µ”
 : 
public
 
CacheBlkVis™Ü


584 
public
:

585 
	$boŞ
 (
	tCache
::*
	tVis™ÜPŒ
)(
	tCacheBlk
 &
	tblk
);

587 
	$CacheBlkVis™ÜW¿µ”
(
Cache
 &
_ÿche
, 
Vis™ÜPŒ
 
_vis™Ü
)

588 : 
	`ÿche
(
_ÿche
), 
	$vis™Ü
(
_vis™Ü
) {}

590 
boŞ
 
	$İ”©Ü
()(
CacheBlk
 &
blk
è
ov”ride
 {

591  (
ÿche
.*
vis™Ü
)(
blk
);

592 
	}
}

594 
	g´iv©e
:

595 
Cache
 &
ÿche
;

596 
Vis™ÜPŒ
 
	gvis™Ü
;

606 şas 
	cCacheBlkIsDœtyVis™Ü
 : 
public
 
CacheBlkVis™Ü


608 
public
:

609 
	$CacheBlkIsDœtyVis™Ü
()

610 : 
	$_isDœty
(
çl£
) {}

612 
boŞ
 
	$İ”©Ü
()(
CacheBlk
 &
blk
è
ov”ride
 {

613 ià(
blk
.
	`isDœty
()) {

614 
_isDœty
 = 
Œue
;

615  
çl£
;

617  
Œue
;

619 
	}
}

626 
boŞ
 
	$isDœty
(ècÚ¡ {  
_isDœty
; 
	}
};

628 
	g´iv©e
:

629 
boŞ
 
_isDœty
;

	@cache/mshr.cc

50 
	~"mem/ÿche/mshr.hh
"

52 
	~<®gÜ™hm
>

53 
	~<ÿs£¹
>

54 
	~<¡ršg
>

55 
	~<veùÜ
>

57 
	~"ba£/misc.hh
"

58 
	~"ba£/ty³s.hh
"

59 
	~"debug/Cache.hh
"

60 
	~"mem/ÿche/ÿche.hh
"

61 
	~"sim/cÜe.hh
"

63 
usšg
 
Çme¥aû
 
	g¡d
;

65 
	gMSHR
::
	$MSHR
(è: 
	`down¡»amP’dšg
(
çl£
),

66 
	`³ndšgModif›d
(
çl£
),

67 
	`po¡Inv®id©e
(
çl£
), 
	`po¡Downg¿de
(false),

68 
	`isFÜw¬d
(
çl£
), 
	$®locOnFl
(
çl£
)

70 
	}
}

72 
	gMSHR
::
T¬g‘Li¡
::
	$T¬g‘Li¡
()

73 : 
	`ÃedsWr™abË
(
çl£
), 
	$hasUpg¿de
(
çl£
)

74 {
	}
}

77 
šlše
 

78 
	gMSHR
::
T¬g‘Li¡
::
	$add
(
Pack‘PŒ
 
pkt
, 
Tick
 
»adyTime
,

79 
CouÁ”
 
Üd”
, 
T¬g‘
::
Sourû
 
sourû
, 
boŞ
 
m¬kP’dšg
)

81 ià(
sourû
 !ğ
T¬g‘
::
FromSnoİ
) {

82 ià(
pkt
->
	`ÃedsWr™abË
()) {

83 
ÃedsWr™abË
 = 
Œue
;

89 ià(
pkt
->
	`isUpg¿de
(è||…kt->
cmd
 =ğ
MemCmd
::
StÜeCÚdReq
) {

90 
hasUpg¿de
 = 
Œue
;

94 ià(
m¬kP’dšg
) {

98 
MSHR
 *
mshr
 = 
pkt
->
fšdNextS’d”S‹
<MSHR>();

99 ià(
mshr
 !ğ
nuÎ±r
) {

100 
	`as£¹
(!
mshr
->
down¡»amP’dšg
);

101 
mshr
->
down¡»amP’dšg
 = 
Œue
;

104 
m¬kP’dšg
 = 
çl£
;

108 
	`em¶aû_back
(
pkt
, 
»adyTime
, 
Üd”
, 
sourû
, 
m¬kP’dšg
);

109 
	}
}

113 
	$»¶aûUpg¿de
(
Pack‘PŒ
 
pkt
)

116 
boŞ
 
has_d©a
 = 
pkt
->
	`hasD©a
(è||…kt->
	`hasRe¥D©a
();

118 ià(
pkt
->
cmd
 =ğ
MemCmd
::
Upg¿deReq
) {

119 
pkt
->
cmd
 = 
MemCmd
::
R—dExReq
;

120 
	`DPRINTF
(
Cache
, "Replacing UpgradeReq with ReadExReq\n");

121 } ià(
pkt
->
cmd
 =ğ
MemCmd
::
SCUpg¿deReq
) {

122 
pkt
->
cmd
 = 
MemCmd
::
SCUpg¿deFaReq
;

123 
	`DPRINTF
(
Cache
, "Replacing SCUpgradeReq with SCUpgradeFailReq\n");

124 } ià(
pkt
->
cmd
 =ğ
MemCmd
::
StÜeCÚdReq
) {

125 
pkt
->
cmd
 = 
MemCmd
::
StÜeCÚdFaReq
;

126 
	`DPRINTF
(
Cache
, "Replacing StoreCondReq with StoreCondFailReq\n");

129 ià(!
has_d©a
) {

132 
	`as£¹
(!
pkt
->
	`hasD©a
());

134 ià(
pkt
->
	`hasRe¥D©a
()) {

138 
pkt
->
	`®loÿ‹
();

141 
	}
}

145 
	gMSHR
::
T¬g‘Li¡
::
	$»¶aûUpg¿des
()

147 ià(!
hasUpg¿de
)

150 auto& 
t
 : *
this
) {

151 
	`»¶aûUpg¿de
(
t
.
pkt
);

154 
hasUpg¿de
 = 
çl£
;

155 
	}
}

159 
	gMSHR
::
T¬g‘Li¡
::
	$ş—rDown¡»amP’dšg
()

161 auto& 
t
 : *
this
) {

162 ià(
t
.
m¬kedP’dšg
) {

169 
MSHR
 *
mshr
 = 
t
.
pkt
->
fšdNextS’d”S‹
<MSHR>();

170 ià(
mshr
 !ğ
nuÎ±r
) {

171 
mshr
->
	`ş—rDown¡»amP’dšg
();

175 
	}
}

178 
boŞ


179 
	gMSHR
::
T¬g‘Li¡
::
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

181 auto& 
t
 : *
this
) {

182 ià(
pkt
->
	`checkFunùiÚ®
(
t
.pkt)) {

183  
Œue
;

187  
çl£
;

188 
	}
}

192 
	gMSHR
::
T¬g‘Li¡
::
	$´št
(
¡d
::
o¡»am
 &
os
, 
v”bos™y
,

193 cÚ¡ 
¡d
::
¡ršg
 &
´efix
) const

195 auto& 
t
 : *
this
) {

196 cÚ¡ *
s
;

197 
t
.
sourû
) {

198 
T¬g‘
::
FromCPU
:

199 
s
 = "FromCPU";

201 
T¬g‘
::
FromSnoİ
:

202 
s
 = "FromSnoop";

204 
T¬g‘
::
FromP»ãtch”
:

205 
s
 = "FromPrefetcher";

208 
s
 = "";

211 
	`cırštf
(
os
, "%s%s: ", 
´efix
, 
s
);

212 
t
.
pkt
->
	`´št
(
os
, 
v”bos™y
, "");

214 
	}
}

218 
	gMSHR
::
	$®loÿ‹
(
Addr
 
blk_addr
, 
blk_size
, 
Pack‘PŒ
 
rg‘
,

219 
Tick
 
wh’_»ady
, 
CouÁ”
 
_Üd”
, 
boŞ
 
®loc_Ú_fl
)

221 
blkAddr
 = 
blk_addr
;

222 
blkSize
 = 
blk_size
;

223 
isSecu»
 = 
rg‘
->
	`isSecu»
();

224 
»adyTime
 = 
wh’_»ady
;

225 
Üd”
 = 
_Üd”
;

226 
	`as£¹
(
rg‘
);

227 
isFÜw¬d
 = 
çl£
;

228 
®locOnFl
 = 
®loc_Ú_fl
;

229 
_isUnÿch—bË
 = 
rg‘
->
»q
->
	`isUnÿch—bË
();

230 
šS”viû
 = 
çl£
;

231 
down¡»amP’dšg
 = 
çl£
;

232 
	`as£¹
(
rg‘s
.
	`isRe£t
());

235 
T¬g‘
::
Sourû
 
sourû
 = (
rg‘
->
cmd
 =ğ
MemCmd
::
H¬dPFReq
) ?

236 
T¬g‘
::
FromP»ãtch”
 : T¬g‘::
FromCPU
;

237 
rg‘s
.
	`add
(
rg‘
, 
wh’_»ady
, 
_Üd”
, 
sourû
, 
Œue
);

238 
	`as£¹
(
deã¼edT¬g‘s
.
	`isRe£t
());

239 
	}
}

243 
	gMSHR
::
	$ş—rDown¡»amP’dšg
()

245 
	`as£¹
(
down¡»amP’dšg
);

246 
down¡»amP’dšg
 = 
çl£
;

249 
rg‘s
.
	`ş—rDown¡»amP’dšg
();

250 
	}
}

253 
	gMSHR
::
	$m¬kInS”viû
(
boŞ
 
³ndšg_modif›d_»¥
)

255 
	`as£¹
(!
šS”viû
);

257 
šS”viû
 = 
Œue
;

258 
³ndšgModif›d
 = 
rg‘s
.
ÃedsWr™abË
 || 
³ndšg_modif›d_»¥
;

259 
po¡Inv®id©e
 = 
po¡Downg¿de
 = 
çl£
;

261 ià(!
down¡»amP’dšg
) {

264 
rg‘s
.
	`ş—rDown¡»amP’dšg
();

266 
	}
}

270 
	gMSHR
::
	$d—Îoÿ‹
()

272 
	`as£¹
(
rg‘s
.
	`em±y
());

273 
rg‘s
.
	`»£tFÏgs
();

274 
	`as£¹
(
deã¼edT¬g‘s
.
	`isRe£t
());

275 
šS”viû
 = 
çl£
;

276 
	}
}

282 
	gMSHR
::
	$®loÿ‹T¬g‘
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’R—dy
, 
CouÁ”
 
_Üd”
,

283 
boŞ
 
®loc_Ú_fl
)

287 
	`as£¹
(
pkt
->
cmd
 !ğ
MemCmd
::
H¬dPFReq
);

292 
	`as£¹
(!
_isUnÿch—bË
);

296 
®locOnFl
 =‡ÎocOnFÈ|| 
®loc_Ú_fl
;

308 ià(
šS”viû
 &&

309 (!
deã¼edT¬g‘s
.
	`em±y
(è|| 
	`hasPo¡Inv®id©e
() ||

310 (
pkt
->
	`ÃedsWr™abË
() &&

311 (!
	`isP’dšgModif›d
(è|| 
	`hasPo¡Downg¿de
(è|| 
isFÜw¬d
)))) {

313 ià(
	`hasPo¡Inv®id©e
())

314 
	`»¶aûUpg¿de
(
pkt
);

315 
deã¼edT¬g‘s
.
	`add
(
pkt
, 
wh’R—dy
, 
_Üd”
, 
T¬g‘
::
FromCPU
, 
Œue
);

321 
rg‘s
.
	`add
(
pkt
, 
wh’R—dy
, 
_Üd”
, 
T¬g‘
::
FromCPU
, !
šS”viû
);

323 
	}
}

325 
boŞ


326 
	gMSHR
::
	$hªdËSnoİ
(
Pack‘PŒ
 
pkt
, 
CouÁ”
 
_Üd”
)

328 
	`DPRINTF
(
Cache
, "% fÜ % add¸%#Îx siz%d\n", 
__func__
,

329 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

334 
	`·nic_if
(
pkt
->
	`ÃedsWr™abË
(è!ğpkt->
	`isInv®id©e
(),

336 "dÛ nÙ m©ch isInv®id©e", 
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),

337 
pkt
->
	`g‘Addr
());

339 ià(!
šS”viû
 || (
pkt
->
	`isEx´essSnoİ
(è&& 
down¡»amP’dšg
)) {

353 ià(
pkt
->
	`ÃedsWr™abË
()) {

354 
rg‘s
.
	`»¶aûUpg¿des
();

355 
deã¼edT¬g‘s
.
	`»¶aûUpg¿des
();

358  
çl£
;

363 ià(
pkt
->
	`ÃedsWr™abË
()) {

366 
deã¼edT¬g‘s
.
	`»¶aûUpg¿des
();

369 ià(
	`hasPo¡Inv®id©e
()) {

373  
Œue
;

376 ià(
	`isP’dšgModif›d
(è|| 
pkt
->
	`isInv®id©e
()) {

387 
boŞ
 
wl_»¥Úd
 = 
	`isP’dšgModif›d
(è&& 
pkt
->
	`ÃedsRe¥Ú£
() &&

388 
pkt
->
cmd
 !ğ
MemCmd
::
Inv®id©eReq
;

400 
Pack‘PŒ
 
ı_pkt
 = 
wl_»¥Úd
 ? 
Ãw
 
	`Pack‘
(
pkt
, 
Œue
,rue) :

401 
Ãw
 
	`Pack‘
Òew 
	`Reque¡
(*
pkt
->
»q
),…kt->
cmd
);

403 ià(
wl_»¥Úd
) {

408 
pkt
->
	`£tCacheRe¥Údšg
();

413 
pkt
->
	`£tRe¥Úd”HadWr™abË
();

419 
rg‘s
.
	`add
(
ı_pkt
, 
	`curTick
(), 
_Üd”
, 
T¬g‘
::
FromSnoİ
,

420 
down¡»amP’dšg
 && 
rg‘s
.
ÃedsWr™abË
);

422 ià(
pkt
->
	`ÃedsWr™abË
()) {

424 
po¡Inv®id©e
 = 
Œue
;

428 ià(!
pkt
->
	`ÃedsWr™abË
(è&& !pkt->
»q
->
	`isUnÿch—bË
()) {

431 
po¡Downg¿de
 = 
Œue
;

435 
pkt
->
	`£tHasSh¬”s
();

438  
Œue
;

439 
	}
}

442 
boŞ


443 
	gMSHR
::
	$´omÙeDeã¼edT¬g‘s
()

445 
	`as£¹
(
rg‘s
.
	`em±y
());

446 ià(
deã¼edT¬g‘s
.
	`em±y
()) {

447  
çl£
;

451 
¡d
::
	`sw­
(
rg‘s
, 
deã¼edT¬g‘s
);

454 
deã¼edT¬g‘s
.
	`»£tFÏgs
();

456 
Üd”
 = 
rg‘s
.
	`äÚt
().order;

457 
»adyTime
 = 
¡d
::
	`max
(
	`curTick
(), 
rg‘s
.
	`äÚt
().readyTime);

459  
Œue
;

460 
	}
}

464 
	gMSHR
::
	$´omÙeWr™abË
()

466 ià(
deã¼edT¬g‘s
.
ÃedsWr™abË
 &&

467 !(
	`hasPo¡Inv®id©e
(è|| 
	`hasPo¡Downg¿de
())) {

475 
	`as£¹
(!
rg‘s
.
ÃedsWr™abË
);

476 
rg‘s
.
ÃedsWr™abË
 = 
Œue
;

479 
	`as£¹
(!
down¡»amP’dšg
);

480 
deã¼edT¬g‘s
.
	`ş—rDown¡»amP’dšg
();

482 
rg‘s
.
	`¥liû
Ñ¬g‘s.
	`’d
(), 
deã¼edT¬g‘s
);

483 
deã¼edT¬g‘s
.
	`»£tFÏgs
();

485 
	}
}

488 
boŞ


489 
	gMSHR
::
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

494 ià(
pkt
->
	`isPršt
()) {

495 
pkt
->
	`checkFunùiÚ®
(
this
, 
blkAddr
, 
isSecu»
, 
blkSize
, 
nuÎ±r
);

496  
çl£
;

498  (
rg‘s
.
	`checkFunùiÚ®
(
pkt
) ||

499 
deã¼edT¬g‘s
.
	`checkFunùiÚ®
(
pkt
));

501 
	}
}

503 
boŞ


504 
	gMSHR
::
	$£ndPack‘
(
Cache
 &
ÿche
)

506  
ÿche
.
	`£ndMSHRQueuePack‘
(
this
);

507 
	}
}

510 
	gMSHR
::
	$´št
(
¡d
::
o¡»am
 &
os
, 
v”bos™y
, cÚ¡ std::
¡ršg
 &
´efix
) const

512 
	`cırštf
(
os
, "%s[%#llx:%#llx](%s) %s %s %s state: %s %s %s %s %s\n",

513 
´efix
, 
blkAddr
, blkAdd¸+ 
blkSize
 - 1,

514 
isSecu»
 ? "s" : "ns",

515 
isFÜw¬d
 ? "Forward" : "",

516 
®locOnFl
 ? "AllocOnFill" : "",

517 
	`ÃedsWr™abË
() ? "Wrtbl" : "",

518 
_isUnÿch—bË
 ? "Unc" : "",

519 
šS”viû
 ? "InSvc" : "",

520 
down¡»amP’dšg
 ? "DwnPend" : "",

521 
po¡Inv®id©e
 ? "PostInv" : "",

522 
po¡Downg¿de
 ? "PostDowngr" : "");

524 ià(!
rg‘s
.
	`em±y
()) {

525 
	`cırštf
(
os
, "%  T¬g‘s:\n", 
´efix
);

526 
rg‘s
.
	`´št
(
os
, 
v”bos™y
, 
´efix
 + " ");

528 ià(!
deã¼edT¬g‘s
.
	`em±y
()) {

529 
	`cırštf
(
os
, "%  Deã¼ed T¬g‘s:\n", 
´efix
);

530 
deã¼edT¬g‘s
.
	`´št
(
os
, 
v”bos™y
, 
´efix
 + " ");

532 
	}
}

534 
	g¡d
::
¡ršg


535 
MSHR
::
	$´št
() const

537 
o¡ršg¡»am
 
¡r
;

538 
	`´št
(
¡r
);

539  
¡r
.
	`¡r
();

540 
	}
}

	@cache/mshr.hh

48 #iâdeà
__MEM_CACHE_MSHR_HH__


49 
	#__MEM_CACHE_MSHR_HH__


	)

51 
	~<li¡
>

53 
	~"ba£/´šbË.hh
"

54 
	~"mem/ÿche/queue_’Œy.hh
"

56 
şass
 
	gCache
;

63 
şass
 
	gMSHR
 : 
public
 
QueueEÁry
,…ubliø
	gPršbË


69 
	g‹m¶©e
<
ty³Çme
 
	gEÁry
>

70 
ä›nd
 
şass
 
	gQueue
;

71 
ä›nd
 
şass
 
	gMSHRQueue
;

73 
	g´iv©e
:

76 
boŞ
 
down¡»amP’dšg
;

102 
boŞ
 
	g³ndšgModif›d
;

105 
boŞ
 
	gpo¡Inv®id©e
;

108 
boŞ
 
	gpo¡Downg¿de
;

110 
	gpublic
:

113 
boŞ
 
isFÜw¬d
;

115 şas 
	cT¬g‘
 {

116 
	gpublic
:

118 
	eSourû
 {

119 
FromCPU
,

120 
	gFromSnoİ
,

121 
	gFromP»ãtch”


124 cÚ¡ 
Tick
 
	g»cvTime
;

125 cÚ¡ 
Tick
 
	g»adyTime
;

126 cÚ¡ 
CouÁ”
 
	gÜd”
;

127 cÚ¡ 
Pack‘PŒ
 
	gpkt
;

128 cÚ¡ 
Sourû
 
	gsourû
;

129 cÚ¡ 
boŞ
 
	gm¬kedP’dšg
;

132 
T¬g‘
(
Pack‘PŒ
 
_pkt
, 
Tick
 
_»adyTime
, 
CouÁ”
 
_Üd”
,

133 
Sourû
 
_sourû
, 
boŞ
 
_m¬kedP’dšg
)

134 : 
»cvTime
(
curTick
()), 
»adyTime
(
_»adyTime
), 
Üd”
(
_Üd”
),

135 
pkt
(
_pkt
), 
sourû
(
_sourû
), 
m¬kedP’dšg
(
_m¬kedP’dšg
)

139 
şass
 
	gT¬g‘Li¡
 : 
public
 
¡d
::
li¡
<
T¬g‘
> {

141 
public
:

142 
boŞ
 
ÃedsWr™abË
;

143 
boŞ
 
	ghasUpg¿de
;

145 
T¬g‘Li¡
();

146 
»£tFÏgs
(è{ 
	gÃedsWr™abË
 = 
hasUpg¿de
 = 
çl£
; }

147 
boŞ
 
isRe£t
(ècÚ¡ {  !
	gÃedsWr™abË
 && !
	ghasUpg¿de
; }

148 
add
(
Pack‘PŒ
 
pkt
, 
Tick
 
»adyTime
, 
CouÁ”
 
Üd”
,

149 
T¬g‘
::
Sourû
 
sourû
, 
boŞ
 
m¬kP’dšg
);

155 
»¶aûUpg¿des
();

157 
ş—rDown¡»amP’dšg
();

158 
boŞ
 
checkFunùiÚ®
(
Pack‘PŒ
 
pkt
);

159 
´št
(
¡d
::
o¡»am
 &
os
, 
v”bos™y
,

160 cÚ¡ 
¡d
::
¡ršg
 &
´efix
) const;

164 
	g¡d
::
	tli¡
<
	tMSHR
 *> 
	tLi¡
;

166 
	gLi¡
::
	t™”©Ü
 
	tI‹¿tÜ
;

169 
boŞ
 
	g®locOnFl
;

177 
boŞ
 
	$ÃedsWr™abË
(ècÚ¡ {  
rg‘s
.
ÃedsWr™abË
; 
	}
}

179 
boŞ
 
	$isP’dšgModif›d
() const {

180 
	`as£¹
(
šS”viû
);  
³ndšgModif›d
;

181 
	}
}

183 
boŞ
 
	$hasPo¡Inv®id©e
() const {

184 
	`as£¹
(
šS”viû
);  
po¡Inv®id©e
;

185 
	}
}

187 
boŞ
 
	$hasPo¡Downg¿de
() const {

188 
	`as£¹
(
šS”viû
);  
po¡Downg¿de
;

189 
	}
}

191 
boŞ
 
£ndPack‘
(
Cache
 &
ÿche
);

193 
	g´iv©e
:

199 
I‹¿tÜ
 
»adyI‹r
;

205 
I‹¿tÜ
 
	g®locI‹r
;

208 
T¬g‘Li¡
 
	grg‘s
;

210 
T¬g‘Li¡
 
	gdeã¼edT¬g‘s
;

212 
	gpublic
:

223 
®loÿ‹
(
Addr
 
blk_addr
, 
blk_size
, 
Pack‘PŒ
 
pkt
,

224 
Tick
 
wh’_»ady
, 
CouÁ”
 
_Üd”
, 
boŞ
 
®loc_Ú_fl
);

226 
m¬kInS”viû
(
boŞ
 
³ndšg_modif›d_»¥
);

228 
ş—rDown¡»amP’dšg
();

233 
d—Îoÿ‹
();

239 
®loÿ‹T¬g‘
(
Pack‘PŒ
 
rg‘
, 
Tick
 
wh’
, 
CouÁ”
 
Üd”
,

240 
boŞ
 
®loc_Ú_fl
);

241 
boŞ
 
hªdËSnoİ
(
Pack‘PŒ
 
rg‘
, 
CouÁ”
 
Üd”
);

244 
MSHR
();

250 
	$g‘NumT¬g‘s
() const

251 {  
rg‘s
.
	`size
(è+ 
deã¼edT¬g‘s
.size(); 
	}
}

257 
boŞ
 
	$hasT¬g‘s
(ècÚ¡ {  !
rg‘s
.
	`em±y
(); 
	}
}

263 
T¬g‘
 *
	$g‘T¬g‘
()

265 
	`as£¹
(
	`hasT¬g‘s
());

266  &
rg‘s
.
	`äÚt
();

267 
	}
}

272 
	$pİT¬g‘
()

274 
rg‘s
.
	`pİ_äÚt
();

275 
	}
}

277 
boŞ
 
´omÙeDeã¼edT¬g‘s
();

279 
´omÙeWr™abË
();

281 
boŞ
 
checkFunùiÚ®
(
Pack‘PŒ
 
pkt
);

286 
´št
(
¡d
::
o¡»am
 &
os
,

287 
v”bos™y
 = 0,

288 cÚ¡ 
¡d
::
¡ršg
 &
´efix
 = "") const;

295 
	g¡d
::
¡ršg
 
	$´št
() const;

296 
	}
};

	@cache/mshr_queue.cc

48 
	~"mem/ÿche/mshr_queue.hh
"

50 
usšg
 
Çme¥aû
 
	g¡d
;

52 
	gMSHRQueue
::
	$MSHRQueue
(cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
,

53 
num_’Œ›s
, 
»£rve
, 
demªd_»£rve
)

54 : 
Queue
<
MSHR
>(
_Ïb–
, 
num_’Œ›s
, 
»£rve
),

55 
	$demªdRe£rve
(
demªd_»£rve
)

56 {
	}
}

58 
MSHR
 *

59 
	gMSHRQueue
::
	$®loÿ‹
(
Addr
 
blk_addr
, 
blk_size
, 
Pack‘PŒ
 
pkt
,

60 
Tick
 
wh’_»ady
, 
CouÁ”
 
Üd”
, 
boŞ
 
®loc_Ú_fl
)

62 
	`as£¹
(!
ä“Li¡
.
	`em±y
());

63 
MSHR
 *
mshr
 = 
ä“Li¡
.
	`äÚt
();

64 
	`as£¹
(
mshr
->
	`g‘NumT¬g‘s
() == 0);

65 
ä“Li¡
.
	`pİ_äÚt
();

67 
mshr
->
	`®loÿ‹
(
blk_addr
, 
blk_size
, 
pkt
, 
wh’_»ady
, 
Üd”
, 
®loc_Ú_fl
);

68 
mshr
->
®locI‹r
 = 
®loÿ‹dLi¡
.
	`š£¹
×Îoÿ‹dLi¡.
	`’d
(), mshr);

69 
mshr
->
»adyI‹r
 = 
	`addToR—dyLi¡
(mshr);

71 
®loÿ‹d
 += 1;

72  
mshr
;

73 
	}
}

76 
	gMSHRQueue
::
	$moveToFrÚt
(
MSHR
 *
mshr
)

78 ià(!
mshr
->
šS”viû
) {

79 
	`as£¹
(
mshr
 =ğ*(mshr->
»adyI‹r
));

80 
»adyLi¡
.
	`”a£
(
mshr
->
»adyI‹r
);

81 
mshr
->
»adyI‹r
 = 
»adyLi¡
.
	`š£¹
Ô—dyLi¡.
	`begš
(), mshr);

83 
	}
}

86 
	gMSHRQueue
::
	$m¬kInS”viû
(
MSHR
 *
mshr
, 
boŞ
 
³ndšg_modif›d_»¥
)

88 
mshr
->
	`m¬kInS”viû
(
³ndšg_modif›d_»¥
);

89 
»adyLi¡
.
	`”a£
(
mshr
->
»adyI‹r
);

90 
_numInS”viû
 += 1;

91 
	}
}

94 
	gMSHRQueue
::
	$m¬kP’dšg
(
MSHR
 *
mshr
)

96 
	`as£¹
(
mshr
->
šS”viû
);

97 
mshr
->
šS”viû
 = 
çl£
;

98 --
_numInS”viû
;

103 
mshr
->
»adyI‹r
 = 
	`addToR—dyLi¡
(mshr);

104 
	}
}

106 
boŞ


107 
	gMSHRQueue
::
	$fÜûD—Îoÿ‹T¬g‘
(
MSHR
 *
mshr
)

109 
boŞ
 
was_fuÎ
 = 
	`isFuÎ
();

110 
	`as£¹
(
mshr
->
	`hasT¬g‘s
());

112 
mshr
->
	`pİT¬g‘
();

114 ià(!
mshr
->
	`hasT¬g‘s
(è&& !mshr->
	`´omÙeDeã¼edT¬g‘s
()) {

115 
	`d—Îoÿ‹
(
mshr
);

119  
was_fuÎ
 && !
	`isFuÎ
();

120 
	}
}

	@cache/mshr_queue.hh

48 #iâdeà
__MEM_CACHE_MSHR_QUEUE_HH__


49 
	#__MEM_CACHE_MSHR_QUEUE_HH__


	)

51 
	~<veùÜ
>

53 
	~"mem/ÿche/mshr.hh
"

54 
	~"mem/ÿche/queue.hh
"

59 
şass
 
	gMSHRQueue
 : 
public
 
Queue
<
MSHR
>

61 
´iv©e
:

67 cÚ¡ 
demªdRe£rve
;

69 
	gpublic
:

79 
MSHRQueue
(cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
, 
num_’Œ›s
, 
»£rve
,

80 
demªd_»£rve
);

97 
MSHR
 *
®loÿ‹
(
Addr
 
blk_addr
, 
blk_size
, 
Pack‘PŒ
 
pkt
,

98 
Tick
 
wh’_»ady
, 
CouÁ”
 
Üd”
, 
boŞ
 
®loc_Ú_fl
);

105 
moveToFrÚt
(
MSHR
 *
mshr
);

115 
m¬kInS”viû
(
MSHR
 *
mshr
, 
boŞ
 
³ndšg_modif›d_»¥
);

121 
m¬kP’dšg
(
MSHR
 *
mshr
);

127 
boŞ
 
fÜûD—Îoÿ‹T¬g‘
(
MSHR
 *
mshr
);

133 
boŞ
 
haveP’dšg
() const

135  !
	g»adyLi¡
.
em±y
();

142 
boŞ
 
ÿnP»ãtch
() const

146  (
	g®loÿ‹d
 < 
	gnumEÁr›s
 - (
	gnumRe£rve
 + 1 + 
	gdemªdRe£rve
));

	@cache/prefetch/base.cc

49 
	~<li¡
>

51 
	~"ba£/štm©h.hh
"

52 
	~"mem/ÿche/´eãtch/ba£.hh
"

53 
	~"mem/ÿche/ba£.hh
"

54 
	~"sim/sy¡em.hh
"

56 
	gBa£P»ãtch”
::
	$Ba£P»ãtch”
(cÚ¡ 
Ba£P»ãtch”P¬ams
 *
p
)

57 : 
	`ClockedObjeù
(
p
), 
	`ÿche
(
nuÎ±r
), 
	`blkSize
(0), 
	`lBlkSize
(0),

58 
	`sy¡em
(
p
->
sys
), 
	`ÚMiss
Õ->
Ú_miss
), 
	`ÚR—d
Õ->
Ú_»ad
),

59 
	`ÚWr™e
(
p
->
Ú_wr™e
), 
	`ÚD©a
Õ->
Ú_d©a
), 
	`ÚIn¡
Õ->
Ú_š¡
),

60 
	`ma¡”Id
(
sy¡em
->
	`g‘Ma¡”Id
(
	`Çme
())),

61 
	`·geBy‹s
(
sy¡em
->
	$g‘PageBy‹s
())

63 
	}
}

66 
	gBa£P»ãtch”
::
	$£tCache
(
Ba£Cache
 *
_ÿche
)

68 
	`as£¹
(!
ÿche
);

69 
ÿche
 = 
_ÿche
;

70 
blkSize
 = 
ÿche
->
	`g‘BlockSize
();

71 
lBlkSize
 = 
	`æoÜLog2
(
blkSize
);

72 
	}
}

75 
	gBa£P»ãtch”
::
	$»gSts
()

77 
ClockedObjeù
::
	`»gSts
();

79 
pfIssued


80 .
	`Çme
(name() + ".num_hwpf_issued")

81 .
	`desc
("number of hwpf issued")

84 
	}
}

86 
boŞ


87 
	gBa£P»ãtch”
::
	$ob£rveAcûss
(cÚ¡ 
Pack‘PŒ
 &
pkt
) const

89 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

90 
boŞ
 
ãtch
 = 
pkt
->
»q
->
	`isIn¡F‘ch
();

91 
boŞ
 
»ad
 = 
pkt
->
	`isR—d
();

92 
boŞ
 
šv
 = 
pkt
->
	`isInv®id©e
();

93 
boŞ
 
is_£cu»
 = 
pkt
->
	`isSecu»
();

95 ià(
pkt
->
»q
->
	`isUnÿch—bË
()è 
çl£
;

96 ià(
ãtch
 && !
ÚIn¡
è 
çl£
;

97 ià(!
ãtch
 && !
ÚD©a
è 
çl£
;

98 ià(!
ãtch
 && 
»ad
 && !
ÚR—d
è 
çl£
;

99 ià(!
ãtch
 && !
»ad
 && !
ÚWr™e
è 
çl£
;

100 ià(!
ãtch
 && !
»ad
 && 
šv
è 
çl£
;

101 ià(
pkt
->
cmd
 =ğ
MemCmd
::
CËªEviù
è 
çl£
;

103 ià(
ÚMiss
) {

104  !
	`šCache
(
addr
, 
is_£cu»
) &&

105 !
	`šMissQueue
(
addr
, 
is_£cu»
);

108  
Œue
;

109 
	}
}

111 
boŞ


112 
	gBa£P»ãtch”
::
	$šCache
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const

114 ià(
ÿche
->
	`šCache
(
addr
, 
is_£cu»
)) {

115  
Œue
;

117  
çl£
;

118 
	}
}

120 
boŞ


121 
	gBa£P»ãtch”
::
	$šMissQueue
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const

123 ià(
ÿche
->
	`šMissQueue
(
addr
, 
is_£cu»
)) {

124  
Œue
;

126  
çl£
;

127 
	}
}

129 
boŞ


130 
	gBa£P»ãtch”
::
	$§mePage
(
Addr
 
a
, Add¸
b
) const

132  
	`roundDown
(
a
, 
·geBy‹s
è=ğroundDown(
b
,…ageBytes);

133 
	}
}

135 
Addr


136 
	gBa£P»ãtch”
::
	$blockAdd»ss
(
Addr
 
a
) const

138  
a
 & ~(
blkSize
-1);

139 
	}
}

141 
Addr


142 
	gBa£P»ãtch”
::
	$blockIndex
(
Addr
 
a
) const

144  
a
 >> 
lBlkSize
;

145 
	}
}

147 
Addr


148 
	gBa£P»ãtch”
::
	$·geAdd»ss
(
Addr
 
a
) const

150  
	`roundDown
(
a
, 
·geBy‹s
);

151 
	}
}

153 
Addr


154 
	gBa£P»ãtch”
::
	$·geOff£t
(
Addr
 
a
) const

156  
a
 & (
·geBy‹s
 - 1);

157 
	}
}

159 
Addr


160 
	gBa£P»ãtch”
::
	$·geIthBlockAdd»ss
(
Addr
 
·ge
, 
ušt32_t
 
blockIndex
) const

162  
·ge
 + (
blockIndex
 << 
lBlkSize
);

163 
	}
}

	@cache/prefetch/base.hh

49 #iâdeà
__MEM_CACHE_PREFETCH_BASE_HH__


50 
	#__MEM_CACHE_PREFETCH_BASE_HH__


	)

52 
	~"ba£/¡©i¡ics.hh
"

53 
	~"mem/·ck‘.hh
"

54 
	~"·¿ms/Ba£P»ãtch”.hh
"

55 
	~"sim/şocked_objeù.hh
"

57 
şass
 
	gBa£Cache
;

59 şas 
	cBa£P»ãtch”
 : 
public
 
ClockedObjeù


61 
´Ùeùed
:

66 
Ba£Cache
* 
ÿche
;

69 
	mblkSize
;

72 
	mlBlkSize
;

75 
Sy¡em
* 
	msy¡em
;

78 
boŞ
 
	mÚMiss
;

81 
boŞ
 
	mÚR—d
;

84 
boŞ
 
	mÚWr™e
;

87 
boŞ
 
	mÚD©a
;

90 
boŞ
 
	mÚIn¡
;

93 
Ma¡”ID
 
	mma¡”Id
;

95 cÚ¡ 
Addr
 
	m·geBy‹s
;

98 
boŞ
 
	$ob£rveAcûss
(cÚ¡ 
Pack‘PŒ
 &
pkt
) const;

101 
boŞ
 
	$šCache
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const;

104 
boŞ
 
	$šMissQueue
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const;

107 
boŞ
 
	$§mePage
(
Addr
 
a
, Add¸
b
) const;

109 
Addr
 
	$blockAdd»ss
(
Addr
 
a
) const;

111 
Addr
 
	$blockIndex
(
Addr
 
a
) const;

113 
Addr
 
	$·geAdd»ss
(
Addr
 
a
) const;

115 
Addr
 
	$·geOff£t
(
Addr
 
a
) const;

117 
Addr
 
	$·geIthBlockAdd»ss
(
Addr
 
·ge
, 
ušt32_t
 
i
) const;

120 
Sts
::
SÿÏr
 
pfIssued
;

122 
public
:

124 
	`Ba£P»ãtch”
(cÚ¡ 
Ba£P»ãtch”P¬ams
 *
p
);

126 
vœtu®
 ~
	$Ba£P»ãtch”
() {}

128 
	`£tCache
(
Ba£Cache
 *
_ÿche
);

135 
vœtu®
 
Tick
 
	`nÙify
(cÚ¡ 
Pack‘PŒ
 &
pkt
) = 0;

137 
vœtu®
 
Pack‘PŒ
 
	`g‘Pack‘
() = 0;

139 
vœtu®
 
Tick
 
	$ÃxtP»ãtchR—dyTime
() const = 0;

141 
vœtu®
 
	`»gSts
();

142 
	}
};

	@cache/prefetch/queued.cc

40 
	~"debug/HWP»ãtch.hh
"

41 
	~"mem/ÿche/´eãtch/queued.hh
"

42 
	~"mem/ÿche/ba£.hh
"

44 
	gQueuedP»ãtch”
::
	$QueuedP»ãtch”
(cÚ¡ 
QueuedP»ãtch”P¬ams
 *
p
)

45 : 
	`Ba£P»ãtch”
(
p
), 
	`queueSize
Õ->
queue_size
), 
	`Ï‹ncy
Õ->
Ï‹ncy
),

46 
	`queueSquash
(
p
->
queue_squash
), 
	`queueF‹r
Õ->
queue_f‹r
),

47 
	`ÿcheSnoİ
(
p
->
ÿche_¢oİ
), 
	`gP»ãtch
Õ->
g_´eãtch
)

50 
	}
}

52 
	gQueuedP»ãtch”
::~
	$QueuedP»ãtch”
()

55 
Deã¼edPack‘
 &
p
 : 
pfq
) {

56 
d–‘e
 
p
.
pkt
->
»q
;

57 
d–‘e
 
p
.
pkt
;

59 
	}
}

61 
Tick


62 
	gQueuedP»ãtch”
::
	$nÙify
(cÚ¡ 
Pack‘PŒ
 &
pkt
)

65 ià(
	`ob£rveAcûss
(
pkt
)) {

66 
Addr
 
blk_addr
 = 
pkt
->
	`g‘BlockAddr
(
blkSize
);

67 
boŞ
 
is_£cu»
 = 
pkt
->
	`isSecu»
();

70 ià(
queueSquash
) {

71 autØ
™r
 = 
pfq
.
	`begš
();

72 
™r
 !ğ
pfq
.
	`’d
()) {

73 ià(
™r
->
pkt
->
	`g‘Addr
(è=ğ
blk_addr
 &&

74 
™r
->
pkt
->
	`isSecu»
(è=ğ
is_£cu»
) {

75 
d–‘e
 
™r
->
pkt
->
»q
;

76 
d–‘e
 
™r
->
pkt
;

77 
™r
 = 
pfq
.
	`”a£
(itr);

79 ++
™r
;

85 
¡d
::
veùÜ
<
AddrPriÜ™y
> 
add»s£s
;

86 
	`ÿlcuÏ‹P»ãtch
(
pkt
, 
add»s£s
);

89 
AddrPriÜ™y
& 
pf_šfo
 : 
add»s£s
) {

92 
pf_šfo
.
fœ¡
 &ğ~(
Addr
)(
blkSize
 - 1);

94 
pfId’tif›d
++;

95 
	`DPRINTF
(
HWP»ãtch
, "Found‡…f candidate‡ddr: %#x, "

96 "š£¹šg iÁØ´eãtch queue.\n", 
pf_šfo
.
fœ¡
);

99 
Pack‘PŒ
 
pf_pkt
 = 
	`š£¹
(
pf_šfo
, 
is_£cu»
);

101 ià(
pf_pkt
 !ğ
nuÎ±r
) {

102 ià(
gP»ãtch
 && 
pkt
->
»q
->
	`hasPC
()) {

104 
pf_pkt
->
»q
->
	`£tPC
(
pkt
->»q->
	`g‘PC
());

110  
pfq
.
	`em±y
(è? 
MaxTick
 :…fq.
	`äÚt
().
tick
;

111 
	}
}

113 
Pack‘PŒ


114 
	gQueuedP»ãtch”
::
	$g‘Pack‘
()

116 
	`DPRINTF
(
HWP»ãtch
, "Requesting‡…refetcho issue.\n");

118 ià(
pfq
.
	`em±y
()) {

119 
	`DPRINTF
(
HWP»ãtch
, "No hardware…refetches‡vailable.\n");

120  
nuÎ±r
;

123 
Pack‘PŒ
 
pkt
 = 
pfq
.
	`begš
()->pkt;

124 
pfq
.
	`pİ_äÚt
();

126 
pfIssued
++;

127 
	`as£¹
(
pkt
 !ğ
nuÎ±r
);

128 
	`DPRINTF
(
HWP»ãtch
, "G’”©šg…»ãtch fÜ %#x.\n", 
pkt
->
	`g‘Addr
());

129  
pkt
;

130 
	}
}

132 
	g¡d
::
li¡
<
QueuedP»ãtch”
::
Deã¼edPack‘
>::
cÚ¡_™”©Ü


133 
QueuedP»ãtch”
::
	$šP»ãtch
(
Addr
 
add»ss
, 
boŞ
 
is_£cu»
) const

135 
cÚ¡_™”©Ü
 
dp
 = 
pfq
.
	`begš
(); d°!ğpfq.
	`’d
(); dp++) {

136 ià((*
dp
).
pkt
->
	`g‘Addr
(è=ğ
add»ss
 &&

137 (*
dp
).
pkt
->
	`isSecu»
(è=ğ
is_£cu»
)  dp;

140  
pfq
.
	`’d
();

141 
	}
}

143 
	gQueuedP»ãtch”
::
™”©Ü


144 
QueuedP»ãtch”
::
	$šP»ãtch
(
Addr
 
add»ss
, 
boŞ
 
is_£cu»
)

146 
™”©Ü
 
dp
 = 
pfq
.
	`begš
(); d°!ğpfq.
	`’d
(); dp++) {

147 ià(
dp
->
pkt
->
	`g‘Addr
(è=ğ
add»ss
 &&

148 
dp
->
pkt
->
	`isSecu»
(è=ğ
is_£cu»
)  dp;

151  
pfq
.
	`’d
();

152 
	}
}

155 
	gQueuedP»ãtch”
::
	$»gSts
()

157 
Ba£P»ãtch”
::
	`»gSts
();

159 
pfId’tif›d


160 .
	`Çme
(name() + ".pfIdentified")

161 .
	`desc
("number of…refetch candidates identified");

163 
pfBufãrH™


164 .
	`Çme
(name() + ".pfBufferHit")

165 .
	`desc
("number of„edundant…refetches‡lready in…refetch queue");

167 
pfInCache


168 .
	`Çme
(name() + ".pfInCache")

169 .
	`desc
("number of„edundant…refetches‡lready in cache/mshr dropped");

171 
pfRemovedFuÎ


172 .
	`Çme
(name() + ".pfRemovedFull")

173 .
	`desc
("number of…refetches dropped dueo…refetch queue size");

175 
pfS·nPage


176 .
	`Çme
(name() + ".pfSpanPage")

177 .
	`desc
("number of…refetches‚ot generated dueo…age crossing");

178 
	}
}

180 
Pack‘PŒ


181 
	gQueuedP»ãtch”
::
	$š£¹
(
AddrPriÜ™y
 &
pf_šfo
, 
boŞ
 
is_£cu»
)

183 ià(
queueF‹r
) {

184 
™”©Ü
 
™
 = 
	`šP»ãtch
(
pf_šfo
.
fœ¡
, 
is_£cu»
);

186 ià(
™
 !ğ
pfq
.
	`’d
()) {

187 
pfBufãrH™
++;

188 ià(
™
->
´iÜ™y
 < 
pf_šfo
.
£cÚd
) {

190 
™
->
´iÜ™y
 = 
pf_šfo
.
£cÚd
;

191 
™”©Ü
 
´ev
 = 
™
;

192 
boŞ
 
cÚt
 = 
Œue
;

193 
cÚt
 && 
´ev
 !ğ
pfq
.
	`begš
()) {

194 
´ev
--;

196 ià(*
™
 > *
´ev
) {

197 
¡d
::
	`sw­
(*
™
, *
´ev
);

198 
™
 = 
´ev
;

201 
	`DPRINTF
(
HWP»ãtch
, "Prefetch‡ddr‡lready in "

204 
	`DPRINTF
(
HWP»ãtch
, "Prefetch‡ddr‡lready in "

207  
nuÎ±r
;

211 ià(
ÿcheSnoİ
 && (
	`šCache
(
pf_šfo
.
fœ¡
, 
is_£cu»
) ||

212 
	`šMissQueue
(
pf_šfo
.
fœ¡
, 
is_£cu»
))) {

213 
pfInCache
++;

214 
	`DPRINTF
(
HWP»ãtch
, "Dropping„edundant in "

215 "ÿche/MSHR…»ãtch‡ddr:%#x\n", 
pf_šfo
.
fœ¡
);

216  
nuÎ±r
;

220 
Reque¡
 *
pf_»q
 =

221 
Ãw
 
	`Reque¡
(
pf_šfo
.
fœ¡
, 
blkSize
, 0, 
ma¡”Id
);

223 ià(
is_£cu»
) {

224 
pf_»q
->
	`£tFÏgs
(
Reque¡
::
SECURE
);

226 
pf_»q
->
	`skId
(
CÚ‹xtSw™chTaskId
::
P»ãtch”
);

227 
Pack‘PŒ
 
pf_pkt
 = 
Ãw
 
	`Pack‘
(
pf_»q
, 
MemCmd
::
H¬dPFReq
);

228 
pf_pkt
->
	`®loÿ‹
();

231 ià(
pfq
.
	`size
(è=ğ
queueSize
) {

232 
pfRemovedFuÎ
++;

234 
™”©Ü
 
™
 = 
pfq
.
	`’d
();

235 
	`·nic_if
 (
™
 =ğ
pfq
.
	`begš
(), "Prefetch queue is both full‡ndƒmpty!");

236 --
™
;

238 
	`·nic_if
 (
™
 =ğ
pfq
.
	`begš
(), "Prefetch queue is full with 1ƒlement!");

239 
™”©Ü
 
´ev
 = 
™
;

240 
boŞ
 
cÚt
 = 
Œue
;

242 
cÚt
 && 
´ev
 !ğ
pfq
.
	`begš
()) {

243 
´ev
--;

245 
cÚt
 = (*
´ev
).
´iÜ™y
 =ğ(*
™
).priority;

246 ià(
cÚt
)

248 
™
 = 
´ev
;

250 
	`DPRINTF
(
HWP»ãtch
, "Prefetch queue full,„emoving†owest…riority "

251 "Şde¡…ack‘,‡ddr: %#x", 
™
->
pkt
->
	`g‘Addr
());

252 
d–‘e
 
™
->
pkt
->
»q
;

253 
d–‘e
 
™
->
pkt
;

254 
pfq
.
	`”a£
(
™
);

257 
Tick
 
pf_time
 = 
	`curTick
(è+ 
	`şockP”iod
(è* 
Ï‹ncy
;

258 
	`DPRINTF
(
HWP»ãtch
, "Prefetch queued. "

260 
pf_šfo
.
fœ¡
,…f_šfo.
£cÚd
, 
pf_time
);

263 
Deã¼edPack‘
 
	`dµ
(
pf_time
, 
pf_pkt
, 
pf_šfo
.
£cÚd
);

264 ià(
pfq
.
	`size
() == 0) {

265 
pfq
.
	`em¶aû_back
(
dµ
);

267 
™”©Ü
 
™
 = 
pfq
.
	`’d
();

268 
™
 !ğ
pfq
.
	`begš
(è&& 
dµ
 > *it)

269 --
™
;

272 ià(
™
 =ğ
pfq
.
	`begš
(è&& 
dµ
 <= *it)

273 
™
++;

274 
pfq
.
	`š£¹
(
™
, 
dµ
);

277  
pf_pkt
;

278 
	}
}

	@cache/prefetch/queued.hh

40 #iâdeà
__MEM_CACHE_PREFETCH_QUEUED_HH__


41 
	#__MEM_CACHE_PREFETCH_QUEUED_HH__


	)

43 
	~<li¡
>

45 
	~"mem/ÿche/´eãtch/ba£.hh
"

46 
	~"·¿ms/QueuedP»ãtch”.hh
"

48 şas 
	cQueuedP»ãtch”
 : 
public
 
Ba£P»ãtch”


50 
´Ùeùed
:

51 
	sDeã¼edPack‘
 {

52 
Tick
 
tick
;

53 
Pack‘PŒ
 
	mpkt
;

54 
št32_t
 
	m´iÜ™y
;

55 
Deã¼edPack‘
(
Tick
 
t
, 
Pack‘PŒ
 
p
, 
št32_t
 
´
è: 
tick
Ñ), 
pkt
(p),

56 
´iÜ™y
(
´
) {}

57 
boŞ
 
	mİ”©Ü
>(cÚ¡ 
	mDeã¼edPack‘
& 
	mth©
) const

59  
	m´iÜ™y
 > 
	mth©
.priority;

61 
boŞ
 
	mİ”©Ü
<(cÚ¡ 
	mDeã¼edPack‘
& 
	mth©
) const

63  
	m´iÜ™y
 < 
	mth©
.priority;

65 
boŞ
 
	mİ”©Ü
<=(cÚ¡ 
Deã¼edPack‘
& 
th©
) const

67  !(*
this
 > 
th©
);

70 
usšg
 
	gAddrPriÜ™y
 = 
¡d
::
·œ
<
Addr
, 
	gšt32_t
>;

72 
	g¡d
::
li¡
<
Deã¼edPack‘
> 
pfq
;

77 cÚ¡ 
	gqueueSize
;

80 cÚ¡ 
Cyşes
 
	gÏ‹ncy
;

83 cÚ¡ 
boŞ
 
	gqueueSquash
;

86 cÚ¡ 
boŞ
 
	gqueueF‹r
;

89 cÚ¡ 
boŞ
 
	gÿcheSnoİ
;

92 cÚ¡ 
boŞ
 
	ggP»ãtch
;

94 
usšg
 
	gcÚ¡_™”©Ü
 = 
¡d
::
li¡
<
Deã¼edPack‘
>::
cÚ¡_™”©Ü
;

95 
	g¡d
::
li¡
<
Deã¼edPack‘
>::
cÚ¡_™”©Ü
 
	$šP»ãtch
(
Addr
 
add»ss
,

96 
boŞ
 
is_£cu»
) const;

97 
usšg
 
™”©Ü
 = 
¡d
::
li¡
<
Deã¼edPack‘
>::iterator;

98 
¡d
::
li¡
<
Deã¼edPack‘
>::
™”©Ü
 
	`šP»ãtch
(
Addr
 
add»ss
,

99 
boŞ
 
is_£cu»
);

102 
Sts
::
SÿÏr
 
pfId’tif›d
;

103 
Sts
::
SÿÏr
 
pfBufãrH™
;

104 
Sts
::
SÿÏr
 
pfInCache
;

105 
Sts
::
SÿÏr
 
pfRemovedFuÎ
;

106 
Sts
::
SÿÏr
 
pfS·nPage
;

108 
public
:

109 
	`QueuedP»ãtch”
(cÚ¡ 
QueuedP»ãtch”P¬ams
 *
p
);

110 
vœtu®
 ~
	`QueuedP»ãtch”
();

112 
Tick
 
	`nÙify
(cÚ¡ 
Pack‘PŒ
 &
pkt
);

113 
Pack‘PŒ
 
	`š£¹
(
AddrPriÜ™y
& 
šfo
, 
boŞ
 
is_£cu»
);

116 
vœtu®
 
	`ÿlcuÏ‹P»ãtch
(cÚ¡ 
Pack‘PŒ
 &
pkt
,

117 
¡d
::
veùÜ
<
AddrPriÜ™y
> &
add»s£s
) = 0;

118 
Pack‘PŒ
 
	`g‘Pack‘
();

120 
Tick
 
	$ÃxtP»ãtchR—dyTime
() const

122  
pfq
.
	`em±y
(è? 
MaxTick
 :…fq.
	`äÚt
().
tick
;

123 
	}
}

125 
»gSts
();

	@cache/prefetch/stride.cc

49 
	~"ba£/¿ndom.hh
"

50 
	~"debug/HWP»ãtch.hh
"

51 
	~"mem/ÿche/´eãtch/¡ride.hh
"

53 
	gSŒideP»ãtch”
::
	$SŒideP»ãtch”
(cÚ¡ 
SŒideP»ãtch”P¬ams
 *
p
)

54 : 
	`QueuedP»ãtch”
(
p
),

55 
	`maxCÚf
(
p
->
max_cÚf
),

56 
	`th»shCÚf
(
p
->
th»sh_cÚf
),

57 
	`mšCÚf
(
p
->
mš_cÚf
),

58 
	`¡¬tCÚf
(
p
->
¡¬t_cÚf
),

59 
	`pcTabËAssoc
(
p
->
bË_assoc
),

60 
	`pcTabËS‘s
(
p
->
bË_£ts
),

61 
	`u£Ma¡”Id
(
p
->
u£_ma¡”_id
),

62 
	`deg»e
(
p
->
deg»e
),

63 
	`pcTabË
(
pcTabËAssoc
, 
pcTabËS‘s
, 
	$Çme
())

66 
ÚIn¡
 = 
çl£
;

68 
	`as£¹
(
	`isPow”Of2
(
pcTabËS‘s
));

69 
	}
}

71 
	gSŒideP»ãtch”
::
SŒideEÁry
**

72 
SŒideP»ãtch”
::
PCTabË
::
	$®loÿ‹NewCÚ‹xt
(
cÚ‹xt
)

74 autØ
»s
 = 
’Œ›s
.
	`š£¹
(
¡d
::
	`make_·œ
(
cÚ‹xt
,

75 
Ãw
 
SŒideEÁry
*[
pcTabËS‘s
]));

76 autØ
™
 = 
»s
.
fœ¡
;

77 
	`ch©ty_as£¹
(
»s
.
£cÚd
, "Allocating‡n‡lready created context\n");

78 
	`as£¹
(
™
->
fœ¡
 =ğ
cÚ‹xt
);

80 
	`DPRINTF
(
HWP»ãtch
, "Adding context %i with strideƒntries‡t %p\n",

81 
cÚ‹xt
, 
™
->
£cÚd
);

83 
SŒideEÁry
** 
’Œy
 = 
™
->
£cÚd
;

84 
s
 = 0; s < 
pcTabËS‘s
; s++) {

85 
’Œy
[
s
] = 
Ãw
 
SŒideEÁry
[
pcTabËAssoc
];

87  
’Œy
;

88 
	}
}

90 
	gSŒideP»ãtch”
::
PCTabË
::~
	$PCTabË
() {

91 autØ
’Œy
 : 
’Œ›s
) {

92 
s
 = 0; s < 
pcTabËS‘s
; s++) {

93 
d–‘e
[] 
’Œy
.
£cÚd
[
s
];

95 
d–‘e
[] 
’Œy
.
£cÚd
;

97 
	}
}

100 
	gSŒideP»ãtch”
::
ÿlcuÏ‹P»ãtch
(cÚ¡ 
Pack‘PŒ
 &
pkt
,

101 
¡d
::
veùÜ
<
AddrPriÜ™y
> &
add»s£s
)

103 ià(!
pkt
->
»q
->
hasPC
()) {

104 
DPRINTF
(
HWP»ãtch
, "Ignoring„equest with‚o PC.\n");

109 
Addr
 
	gpkt_addr
 = 
pkt
->
g‘Addr
();

110 
Addr
 
	gpc
 = 
pkt
->
»q
->
g‘PC
();

111 
boŞ
 
	gis_£cu»
 = 
pkt
->
isSecu»
();

112 
Ma¡”ID
 
	gma¡”_id
 = 
u£Ma¡”Id
 ? 
pkt
->
»q
->
ma¡”Id
() : 0;

115 
SŒideEÁry
 *
	g’Œy
;

117 ià(
pcTabËH™
(
pc
, 
is_£cu»
, 
ma¡”_id
, 
’Œy
)) {

119 
	gÃw_¡ride
 = 
pkt_addr
 - 
’Œy
->
Ï¡Addr
;

120 
boŞ
 
	g¡ride_m©ch
 = (
Ãw_¡ride
 =ğ
’Œy
->
¡ride
);

123 ià(
	g¡ride_m©ch
 && 
	gÃw_¡ride
 != 0) {

124 ià(
’Œy
->
cÚfid’û
 < 
maxCÚf
)

125 
’Œy
->
cÚfid’û
++;

127 ià(
	g’Œy
->
	gcÚfid’û
 > 
	gmšCÚf
)

128 
	g’Œy
->
	gcÚfid’û
--;

130 ià(
	g’Œy
->
	gcÚfid’û
 < 
	gth»shCÚf
)

131 
	g’Œy
->
	g¡ride
 = 
Ãw_¡ride
;

134 
DPRINTF
(
HWP»ãtch
, "Hit: PC %x…kt_addr %x (%s) stride %d (%s), "

135 "cÚà%d\n", 
pc
, 
pkt_addr
, 
is_£cu»
 ? "s" : "ns", 
Ãw_¡ride
,

136 
¡ride_m©ch
 ? "match" : "change",

137 
’Œy
->
cÚfid’û
);

139 
	g’Œy
->
	gÏ¡Addr
 = 
pkt_addr
;

142 ià(
	g’Œy
->
	gcÚfid’û
 < 
	gth»shCÚf
)

146 
	gd
 = 1; d <ğ
deg»e
; d++) {

148 
	g´eãtch_¡ride
 = 
Ãw_¡ride
;

149 ià(
abs
(
Ãw_¡ride
è< 
	gblkSize
) {

150 
	g´eãtch_¡ride
 = (
Ãw_¡ride
 < 0è? -
blkSize
 : blkSize;

153 
Addr
 
	gÃw_addr
 = 
pkt_addr
 + 
d
 * 
´eãtch_¡ride
;

154 ià(
§mePage
(
pkt_addr
, 
Ãw_addr
)) {

155 
DPRINTF
(
HWP»ãtch
, "Queušg…»ãtchØ%#x.\n", 
Ãw_addr
);

156 
	gadd»s£s
.
push_back
(
AddrPriÜ™y
(
Ãw_addr
, 0));

159 
	gpfS·nPage
 +ğ
deg»e
 - 
d
 + 1;

160 
DPRINTF
(
HWP»ãtch
, "Ignoring…age crossing…refetch.\n");

166 
DPRINTF
(
HWP»ãtch
, "Miss: PC %x…kt_add¸%x (%s)\n", 
pc
, 
pkt_addr
,

167 
is_£cu»
 ? "s" : "ns");

169 
SŒideEÁry
* 
	g’Œy
 = 
pcTabËViùim
(
pc
, 
ma¡”_id
);

170 
	g’Œy
->
	gš¡Addr
 = 
pc
;

171 
	g’Œy
->
	gÏ¡Addr
 = 
pkt_addr
;

172 
	g’Œy
->
	gisSecu»
ğ
is_£cu»
;

173 
	g’Œy
->
	g¡ride
 = 0;

174 
	g’Œy
->
	gcÚfid’û
 = 
¡¬tCÚf
;

178 
šlše
 
Addr


179 
	gSŒideP»ãtch”
::
	$pcHash
(
Addr
 
pc
) const

181 
Addr
 
hash1
 = 
pc
 >> 1;

182 
Addr
 
hash2
 = 
hash1
 >> 
	`æoÜLog2
(
pcTabËS‘s
);

183  (
hash1
 ^ 
hash2
è& (
Addr
)(
pcTabËS‘s
 - 1);

184 
	}
}

186 
šlše
 
	gSŒideP»ãtch”
::
SŒideEÁry
*

187 
SŒideP»ãtch”
::
	$pcTabËViùim
(
Addr
 
pc
, 
ma¡”_id
)

190 
£t
 = 
	`pcHash
(
pc
);

191 
way
 = 
¿ndom_mt
.
¿ndom
<>(0, 
pcTabËAssoc
 - 1);

193 
	`DPRINTF
(
HWP»ãtch
, "Viùimizšg†ooku°bË[%d][%d].\n", 
£t
, 
way
);

194  &
pcTabË
[
ma¡”_id
][
£t
][
way
];

195 
	}
}

197 
šlše
 
boŞ


198 
	gSŒideP»ãtch”
::
	$pcTabËH™
(
Addr
 
pc
, 
boŞ
 
is_£cu»
, 
ma¡”_id
,

199 
SŒideEÁry
* &
’Œy
)

201 
£t
 = 
	`pcHash
(
pc
);

202 
SŒideEÁry
* 
£t_’Œ›s
 = 
pcTabË
[
ma¡”_id
][
£t
];

203 
way
 = 0; way < 
pcTabËAssoc
; way++) {

205 ià(
£t_’Œ›s
[
way
].
š¡Addr
 =ğ
pc
 &&

206 
£t_’Œ›s
[
way
].
isSecu»
 =ğ
is_£cu»
) {

207 
	`DPRINTF
(
HWP»ãtch
, "Looku°h™abË[%d][%d].\n", 
£t
, 
way
);

208 
’Œy
 = &
£t_’Œ›s
[
way
];

209  
Œue
;

212  
çl£
;

213 
	}
}

215 
SŒideP»ãtch”
*

216 
	gSŒideP»ãtch”P¬ams
::
	$ü—‹
()

218  
Ãw
 
	`SŒideP»ãtch”
(
this
);

219 
	}
}

	@cache/prefetch/stride.hh

48 #iâdeà
__MEM_CACHE_PREFETCH_STRIDE_HH__


49 
	#__MEM_CACHE_PREFETCH_STRIDE_HH__


	)

51 
	~<unÜd”ed_m­
>

53 
	~"mem/ÿche/´eãtch/queued.hh
"

54 
	~"·¿ms/SŒideP»ãtch”.hh
"

56 şas 
	cSŒideP»ãtch”
 : 
public
 
QueuedP»ãtch”


58 
´Ùeùed
:

59 cÚ¡ 
maxCÚf
;

60 cÚ¡ 
	mth»shCÚf
;

61 cÚ¡ 
	mmšCÚf
;

62 cÚ¡ 
	m¡¬tCÚf
;

64 cÚ¡ 
	mpcTabËAssoc
;

65 cÚ¡ 
	mpcTabËS‘s
;

67 cÚ¡ 
boŞ
 
	mu£Ma¡”Id
;

69 cÚ¡ 
	mdeg»e
;

71 
	sSŒideEÁry


73 
SŒideEÁry
(è: 
š¡Addr
(0), 
Ï¡Addr
(0), 
isSecu»
(
çl£
), 
¡ride
(0),

74 
cÚfid’û
(0)

77 
Addr
 
	mš¡Addr
;

78 
Addr
 
	mÏ¡Addr
;

79 
boŞ
 
	misSecu»
;

80 
	m¡ride
;

81 
	mcÚfid’û
;

84 şas 
	cPCTabË


86 
	gpublic
:

87 
PCTabË
(
assoc
, 
£ts
, cÚ¡ 
¡d
::
¡ršg
 
Çme
) :

88 
pcTabËAssoc
(
assoc
), 
pcTabËS‘s
(
£ts
), 
_Çme
(
Çme
) {}

89 
SŒideEÁry
** 
	gİ”©Ü
[] (
	gcÚ‹xt
) {

90 autØ
	g™
 = 
’Œ›s
.
fšd
(
cÚ‹xt
);

91 ià(
	g™
 !ğ
’Œ›s
.
’d
())

92  
™
->
£cÚd
;

94  
®loÿ‹NewCÚ‹xt
(
cÚ‹xt
);

97 ~
PCTabË
();

98 
	g´iv©e
:

99 cÚ¡ 
¡d
::
¡ršg
 
Çme
(è{ 
_Çme
; }

100 cÚ¡ 
	gpcTabËAssoc
;

101 cÚ¡ 
	gpcTabËS‘s
;

102 cÚ¡ 
	g¡d
::
¡ršg
 
_Çme
;

103 
	g¡d
::
unÜd”ed_m­
<, 
	gSŒideEÁry
**> 
	g’Œ›s
;

105 
SŒideEÁry
** 
®loÿ‹NewCÚ‹xt
(
cÚ‹xt
);

107 
PCTabË
 
	gpcTabË
;

109 
boŞ
 
pcTabËH™
(
Addr
 
pc
, boŞ 
is_£cu»
, 
ma¡”_id
, 
SŒideEÁry
* &
’Œy
);

110 
SŒideEÁry
* 
pcTabËViùim
(
Addr
 
pc
, 
ma¡”_id
);

112 
Addr
 
	$pcHash
(
Addr
 
pc
) const;

113 
public
:

115 
	`SŒideP»ãtch”
(cÚ¡ 
SŒideP»ãtch”P¬ams
 *
p
);

117 
	`ÿlcuÏ‹P»ãtch
(cÚ¡ 
Pack‘PŒ
 &
pkt
,

118 
¡d
::
veùÜ
<
AddrPriÜ™y
> &
add»s£s
);

119 
	}
};

	@cache/prefetch/tagged.cc

36 
	~"mem/ÿche/´eãtch/gged.hh
"

38 
	gTaggedP»ãtch”
::
	$TaggedP»ãtch”
(cÚ¡ 
TaggedP»ãtch”P¬ams
 *
p
)

39 : 
	`QueuedP»ãtch”
(
p
), 
	`deg»e
Õ->
deg»e
)

42 
	}
}

45 
	gTaggedP»ãtch”
::
ÿlcuÏ‹P»ãtch
(cÚ¡ 
Pack‘PŒ
 &
pkt
,

46 
¡d
::
veùÜ
<
AddrPriÜ™y
> &
add»s£s
)

48 
Addr
 
blkAddr
 = 
pkt
->
g‘Addr
(è& ~(Addr)(
blkSize
-1);

50 
	gd
 = 1; d <ğ
deg»e
; d++) {

51 
Addr
 
	gÃwAddr
 = 
blkAddr
 + 
d
*(
blkSize
);

52 ià(!
§mePage
(
blkAddr
, 
ÃwAddr
)) {

54 
	gpfS·nPage
 +ğ
deg»e
 - 
d
 + 1;

57 
	gadd»s£s
.
push_back
(
AddrPriÜ™y
(
ÃwAddr
,0));

62 
TaggedP»ãtch”
*

63 
	gTaggedP»ãtch”P¬ams
::
	$ü—‹
()

65  
Ãw
 
	`TaggedP»ãtch”
(
this
);

66 
	}
}

	@cache/prefetch/tagged.hh

36 #iâdeà
__MEM_CACHE_PREFETCH_TAGGED_HH__


37 
	#__MEM_CACHE_PREFETCH_TAGGED_HH__


	)

39 
	~"mem/ÿche/´eãtch/queued.hh
"

40 
	~"·¿ms/TaggedP»ãtch”.hh
"

43 şas 
	cTaggedP»ãtch”
 : 
public
 
QueuedP»ãtch”


45 
´Ùeùed
:

46 
deg»e
;

48 
	mpublic
:

49 
TaggedP»ãtch”
(cÚ¡ 
TaggedP»ãtch”P¬ams
 *
p
);

51 ~
	$TaggedP»ãtch”
() {}

53 
	`ÿlcuÏ‹P»ãtch
(cÚ¡ 
Pack‘PŒ
 &
pkt
,

54 
¡d
::
veùÜ
<
AddrPriÜ™y
> &
add»s£s
);

55 
	}
};

	@cache/queue.hh

49 #iâdeà
__MEM_CACHE_QUEUE_HH__


50 
	#__MEM_CACHE_QUEUE_HH__


	)

52 
	~<ÿs£¹
>

54 
	~"ba£/Œaû.hh
"

55 
	~"debug/D¿š.hh
"

56 
	~"mem/ÿche/queue_’Œy.hh
"

57 
	~"sim/d¿š.hh
"

63 
	g‹m¶©e
<
şass
 
	gEÁry
>

64 şas 
	cQueue
 : 
public
 
D¿šabË


66 
´Ùeùed
:

68 cÚ¡ 
¡d
::
¡ršg
 
Ïb–
;

76 cÚ¡ 
	mnumEÁr›s
;

84 cÚ¡ 
	mnumRe£rve
;

87 
	m¡d
::
veùÜ
<
EÁry
> 
’Œ›s
;

89 
ty³Çme
 
	mEÁry
::
Li¡
 
®loÿ‹dLi¡
;

91 
ty³Çme
 
	mEÁry
::
Li¡
 
»adyLi¡
;

93 
ty³Çme
 
	mEÁry
::
Li¡
 
ä“Li¡
;

95 
ty³Çme
 
	mEÁry
::
I‹¿tÜ
 
	$addToR—dyLi¡
(
EÁry
* 
’Œy
)

97 ià(
»adyLi¡
.
	`em±y
() ||

98 
»adyLi¡
.
	`back
()->
»adyTime
 <ğ
’Œy
->readyTime) {

99  
»adyLi¡
.
	`š£¹
Ô—dyLi¡.
	`’d
(), 
’Œy
);

102 autØ
i
 = 
»adyLi¡
.
	`begš
(); i !ğ»adyLi¡.
	`’d
(); ++i) {

103 ià((*
i
)->
»adyTime
 > 
’Œy
->readyTime) {

104  
»adyLi¡
.
	`š£¹
(
i
, 
’Œy
);

107 
	`as£¹
(
çl£
);

108  
»adyLi¡
.
	`’d
();

112 
_numInS”viû
;

115 
®loÿ‹d
;

117 
public
:

125 
	$Queue
(cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
, 
num_’Œ›s
, 
»£rve
) :

126 
	`Ïb–
(
_Ïb–
), 
	`numEÁr›s
(
num_’Œ›s
 + 
»£rve
),

127 
	`numRe£rve
(
»£rve
), 
	`’Œ›s
(
numEÁr›s
), 
	`_numInS”viû
(0),

128 
	$®loÿ‹d
(0)

130 
i
 = 0; i < 
numEÁr›s
; ++i) {

131 
ä“Li¡
.
	`push_back
(&
’Œ›s
[
i
]);

133 
	}
}

135 
boŞ
 
	$isEm±y
() const

137  
®loÿ‹d
 == 0;

138 
	}
}

140 
boŞ
 
	$isFuÎ
() const

142  (
®loÿ‹d
 >ğ
numEÁr›s
 - 
numRe£rve
);

143 
	}
}

145 
	$numInS”viû
() const

147  
_numInS”viû
;

148 
	}
}

156 
EÁry
* 
	$fšdM©ch
(
Addr
 
blk_addr
, 
boŞ
 
is_£cu»
) const

158 cÚ¡‡uto& 
’Œy
 : 
®loÿ‹dLi¡
) {

165 ià(!
’Œy
->
	`isUnÿch—bË
(è&&ƒÁry->
blkAddr
 =ğ
blk_addr
 &&

166 
’Œy
->
isSecu»
 =ğ
is_£cu»
) {

167  
’Œy
;

170  
nuÎ±r
;

171 
	}
}

173 
boŞ
 
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
, 
Addr
 
blk_addr
)

175 
pkt
->
	`pushLab–
(
Ïb–
);

176 cÚ¡‡uto& 
’Œy
 : 
®loÿ‹dLi¡
) {

177 ià(
’Œy
->
blkAddr
 =ğ
blk_addr
 &&ƒÁry->
	`checkFunùiÚ®
(
pkt
)) {

178 
pkt
->
	`pİLab–
();

179  
Œue
;

182 
pkt
->
	`pİLab–
();

183  
çl£
;

184 
	}
}

192 
EÁry
* 
	$fšdP’dšg
(
Addr
 
blk_addr
, 
boŞ
 
is_£cu»
) const

194 cÚ¡‡uto& 
’Œy
 : 
»adyLi¡
) {

195 ià(
’Œy
->
blkAddr
 =ğ
blk_addr
 &&ƒÁry->
isSecu»
 =ğ
is_£cu»
) {

196  
’Œy
;

199  
nuÎ±r
;

200 
	}
}

206 
EÁry
* 
	$g‘Next
() const

208 ià(
»adyLi¡
.
	`em±y
(è||„—dyLi¡.
	`äÚt
()->
»adyTime
 > 
	`curTick
()) {

209  
nuÎ±r
;

211  
»adyLi¡
.
	`äÚt
();

212 
	}
}

214 
Tick
 
	$ÃxtR—dyTime
() const

216  
»adyLi¡
.
	`em±y
(è? 
MaxTick
 :„—dyLi¡.
	`äÚt
()->
»adyTime
;

217 
	}
}

225 
	$d—Îoÿ‹
(
EÁry
 *
’Œy
)

227 
®loÿ‹dLi¡
.
	`”a£
(
’Œy
->
®locI‹r
);

228 
ä“Li¡
.
	`push_äÚt
(
’Œy
);

229 
®loÿ‹d
--;

230 ià(
’Œy
->
šS”viû
) {

231 
_numInS”viû
--;

233 
»adyLi¡
.
	`”a£
(
’Œy
->
»adyI‹r
);

235 
’Œy
->
	`d—Îoÿ‹
();

236 ià(
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
 && 
®loÿ‹d
 == 0) {

240 
	`DPRINTF
(
D¿š
, "Queue‚owƒmpty, signalling drained\n");

241 
	`sigÇlD¿šDÚe
();

243 
	}
}

245 
D¿šS‹
 
	$d¿š
(è
ov”ride


247  
®loÿ‹d
 =ğ0 ? 
D¿šS‹
::
D¿šed
 : D¿šS‹::
D¿ššg
;

248 
	}
}

	@cache/queue_entry.hh

49 #iâdeà
__MEM_CACHE_QUEUE_ENTRY_HH__


50 
	#__MEM_CACHE_QUEUE_ENTRY_HH__


	)

52 
	~"mem/·ck‘.hh
"

54 
şass
 
	gCache
;

60 şas 
	cQueueEÁry
 : 
public
 
Pack‘
::
S’d”S‹


66 
‹m¶©e
 <
şass
 
EÁry
>

67 
ä›nd
 
şass
 
Queue
;

69 
	m´Ùeùed
:

72 
Tick
 
»adyTime
;

75 
boŞ
 
	m_isUnÿch—bË
;

77 
	mpublic
:

80 
boŞ
 
šS”viû
;

83 
CouÁ”
 
	mÜd”
;

86 
Addr
 
	mblkAddr
;

89 
	mblkSize
;

92 
boŞ
 
	misSecu»
;

94 
	$QueueEÁry
(è: 
	`»adyTime
(0), 
	`_isUnÿch—bË
(
çl£
),

95 
	`šS”viû
(
çl£
), 
	`Üd”
(0), 
	`blkAddr
(0), 
	`blkSize
(0),

96 
	$isSecu»
(
çl£
)

99 
boŞ
 
	$isUnÿch—bË
(ècÚ¡ {  
_isUnÿch—bË
; 
	}
}

105 
vœtu®
 
boŞ
 
£ndPack‘
(
Cache
 &
ÿche
) = 0;

	@cache/tags/base.cc

49 
	~"mem/ÿche/gs/ba£.hh
"

51 
	~"ıu/smt.hh
"

52 
	~"mem/ÿche/ba£.hh
"

53 
	~"sim/sim_ex™.hh
"

55 
usšg
 
Çme¥aû
 
	g¡d
;

57 
	gBa£Tags
::
	$Ba£Tags
(cÚ¡ 
P¬ams
 *
p
)

58 : 
	`ClockedObjeù
(
p
), 
	`blkSize
Õ->
block_size
), 
	`size
Õ->
size
),

59 
	`acûssL©’cy
(
p
->
h™_Ï‹ncy
), 
	`ÿche
(
nuÎ±r
), 
	`w¬mupBound
(0),

60 
	`w¬medUp
(
çl£
), 
	$numBlocks
(0)

62 
	}
}

65 
	gBa£Tags
::
	$£tCache
(
Ba£Cache
 *
_ÿche
)

67 
	`as£¹
(!
ÿche
);

68 
ÿche
 = 
_ÿche
;

69 
	}
}

72 
	gBa£Tags
::
	$»gSts
()

74 
ClockedObjeù
::
	`»gSts
();

76 
usšg
 
Çme¥aû
 
Sts
;

78 
»¶aûm’ts


79 .
	`š™
(
maxTh»adsP”CPU
)

80 .
	`Çme
(name() + ".replacements")

81 .
	`desc
("number of„eplacements")

82 .
	`æags
(
tÙ®
)

85 
gsInU£


86 .
	`Çme
(name() + ".tagsinuse")

87 .
	`desc
("Cycle‡verage ofags in use")

90 
tÙ®Refs


91 .
	`Çme
(name() + ".total_refs")

92 .
	`desc
("Total‚umber of„eferenceso valid blocks.")

95 
§m¶edRefs


96 .
	`Çme
(name() + ".sampled_refs")

97 .
	`desc
("Sample count of„eferenceso valid blocks.")

100 
avgRefs


101 .
	`Çme
(name() + ".avg_refs")

102 .
	`desc
("Average‚umber of„eferenceso valid blocks.")

105 
avgRefs
 = 
tÙ®Refs
/
§m¶edRefs
;

107 
w¬mupCyşe


108 .
	`Çme
(name() + ".warmup_cycle")

109 .
	`desc
("Cycle whenhe warmup…ercentage was hit.")

112 
occu·nc›s


113 .
	`š™
(
ÿche
->
sy¡em
->
	`maxMa¡”s
())

114 .
	`Çme
(name() + ".occ_blocks")

115 .
	`desc
("Average occupied blocks…er„equestor")

116 .
	`æags
(
noz”o
 | 
nÚª
)

118 
i
 = 0; i < 
ÿche
->
sy¡em
->
	`maxMa¡”s
(); i++) {

119 
occu·nc›s
.
	`subÇme
(
i
, 
ÿche
->
sy¡em
->
	`g‘Ma¡”Name
(i));

122 
avgOccs


123 .
	`Çme
(name() + ".occ_percent")

124 .
	`desc
("Average…ercentage of cache occupancy")

125 .
	`æags
(
noz”o
 | 
tÙ®
)

127 
i
 = 0; i < 
ÿche
->
sy¡em
->
	`maxMa¡”s
(); i++) {

128 
avgOccs
.
	`subÇme
(
i
, 
ÿche
->
sy¡em
->
	`g‘Ma¡”Name
(i));

131 
avgOccs
 = 
occu·nc›s
 / 
Sts
::
	`cÚ¡ªt
(
numBlocks
);

133 
occu·nc›sTaskId


134 .
	`š™
(
CÚ‹xtSw™chTaskId
::
NumTaskId
)

135 .
	`Çme
(name() + ".occ_task_id_blocks")

136 .
	`desc
("Occupied blocks…erask id")

137 .
	`æags
(
noz”o
 | 
nÚª
)

140 
ageTaskId


141 .
	`š™
(
CÚ‹xtSw™chTaskId
::
NumTaskId
, 5)

142 .
	`Çme
(name() + ".age_task_id_blocks")

143 .
	`desc
("Occupied blocks…erask id")

144 .
	`æags
(
noz”o
 | 
nÚª
)

147 
³rûÁOccsTaskId


148 .
	`Çme
(name() + ".occ_task_id_percent")

149 .
	`desc
("Percentage of cache occupancy…erask id")

150 .
	`æags
(
noz”o
)

153 
³rûÁOccsTaskId
 = 
occu·nc›sTaskId
 / 
Sts
::
	`cÚ¡ªt
(
numBlocks
);

155 
gAcûs£s


156 .
	`Çme
(name() + ".tag_accesses")

157 .
	`desc
("Number ofag‡ccesses")

160 
d©aAcûs£s


161 .
	`Çme
(name() + ".data_accesses")

162 .
	`desc
("Number of data‡ccesses")

165 
	`»gi¡”DumpC®lback
(
Ãw
 
	`Ba£TagsDumpC®lback
(
this
));

166 
	`»gi¡”Ex™C®lback
(
Ãw
 
	`Ba£TagsC®lback
(
this
));

167 
	}
}

	@cache/tags/base.hh

49 #iâdeà
__BASE_TAGS_HH__


50 
	#__BASE_TAGS_HH__


	)

52 
	~<¡ršg
>

54 
	~"ba£/ÿÎback.hh
"

55 
	~"ba£/¡©i¡ics.hh
"

56 
	~"mem/ÿche/blk.hh
"

57 
	~"·¿ms/Ba£Tags.hh
"

58 
	~"sim/şocked_objeù.hh
"

60 
şass
 
	gBa£Cache
;

65 şas 
	cBa£Tags
 : 
public
 
ClockedObjeù


67 
´Ùeùed
:

69 cÚ¡ 
blkSize
;

71 cÚ¡ 
	msize
;

73 cÚ¡ 
Cyşes
 
	macûssL©’cy
;

75 
Ba£Cache
 *
	mÿche
;

81 
	mw¬mupBound
;

83 
boŞ
 
	mw¬medUp
;

86 
	mnumBlocks
;

95 
	mSts
::
VeùÜ
 
»¶aûm’ts
;

97 
	mSts
::
Av”age
 
gsInU£
;

100 
	mSts
::
SÿÏr
 
tÙ®Refs
;

107 
	mSts
::
SÿÏr
 
§m¶edRefs
;

113 
	mSts
::
FÜmuÏ
 
avgRefs
;

116 
	mSts
::
SÿÏr
 
w¬mupCyşe
;

119 
	mSts
::
Av”ageVeùÜ
 
occu·nc›s
;

122 
	mSts
::
FÜmuÏ
 
avgOccs
;

125 
	mSts
::
VeùÜ
 
occu·nc›sTaskId
;

128 
	mSts
::
VeùÜ2d
 
ageTaskId
;

131 
	mSts
::
FÜmuÏ
 
³rûÁOccsTaskId
;

134 
	mSts
::
SÿÏr
 
gAcûs£s
;

136 
	mSts
::
SÿÏr
 
d©aAcûs£s
;

142 
	mpublic
:

143 
Ba£TagsP¬ams
 
	tP¬ams
;

144 
Ba£Tags
(cÚ¡ 
P¬ams
 *
p
);

149 
	mvœtu®
 ~
	$Ba£Tags
() {}

155 
	`£tCache
(
Ba£Cache
 *
_ÿche
);

160 
	`»gSts
();

166 
vœtu®
 
	$ş—nupRefs
(è{
	}
}

171 
vœtu®
 
	$compu‹Sts
(è{
	}
}

176 
vœtu®
 
	g¡d
::
¡ršg
 
	$´št
() const = 0;

181 
vœtu®
 
CacheBlk
 * 
	$fšdBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const = 0;

188 
	$exŒaùBlkOff£t
(
Addr
 
addr
) const

190  (
addr
 & (
Addr
)(
blkSize
-1));

191 
	}
}

199 
vœtu®
 
CacheBlk
 *
	$fšdBlockByS‘AndWay
(
£t
, 
way
) const = 0;

205 
vœtu®
 
	$£tWayAÎoÿtiÚMax
(
ways
)

207 
	`·nic
("Thisag class does‚ot implement way‡llocation†imit!\n");

208 
	}
}

214 
vœtu®
 
	$g‘WayAÎoÿtiÚMax
() const

216 
	`·nic
("Thisag class does‚ot implement way‡llocation†imit!\n");

218 
	}
}

220 
vœtu®
 
	$g‘NumS‘s
() const = 0;

222 
vœtu®
 
	$g‘NumWays
() const = 0;

224 
vœtu®
 
	`šv®id©e
(
CacheBlk
 *
blk
) = 0;

226 
vœtu®
 
CacheBlk
* 
	`acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
,

227 
cÚ‹xt_¤c
) = 0;

229 
vœtu®
 
Addr
 
	$exŒaùTag
(
Addr
 
addr
) const = 0;

231 
vœtu®
 
	`š£¹Block
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
) = 0;

233 
vœtu®
 
Addr
 
	$»g’”©eBlkAddr
(
Addr
 
g
, 
£t
) const = 0;

235 
vœtu®
 
CacheBlk
* 
	`fšdViùim
(
Addr
 
addr
) = 0;

237 
vœtu®
 
	$exŒaùS‘
(
Addr
 
addr
) const = 0;

239 
vœtu®
 
	`fÜEachBlk
(
CacheBlkVis™Ü
 &
vis™Ü
) = 0;

240 
	}
};

242 şas 
	cBa£TagsC®lback
 : 
public
 
C®lback


244 
Ba£Tags
 *
gs
;

245 
	mpublic
:

246 
	$Ba£TagsC®lback
(
Ba£Tags
 *
t
è: 
	$gs
(
t
) {}

247 
vœtu®
 
	$´oûss
(è{ 
gs
->
	`ş—nupRefs
(); 
	}
};

250 şas 
	cBa£TagsDumpC®lback
 : 
public
 
C®lback


252 
Ba£Tags
 *
gs
;

253 
	mpublic
:

254 
	$Ba£TagsDumpC®lback
(
Ba£Tags
 *
t
è: 
	$gs
(
t
) {}

255 
vœtu®
 
	$´oûss
(è{ 
gs
->
	`compu‹Sts
(); 
	}
};

	@cache/tags/base_set_assoc.cc

48 
	~"mem/ÿche/gs/ba£_£t_assoc.hh
"

50 
	~<¡ršg
>

52 
	~"ba£/štm©h.hh
"

53 
	~"sim/cÜe.hh
"

55 
usšg
 
Çme¥aû
 
	g¡d
;

57 
	gBa£S‘Assoc
::
	$Ba£S‘Assoc
(cÚ¡ 
P¬ams
 *
p
)

58 :
	`Ba£Tags
(
p
), 
	`assoc
Õ->
assoc
), 
	`®locAssoc
(p->assoc),

59 
	`numS‘s
(
p
->
size
 / (p->
block_size
 *…->
assoc
)),

60 
	`£qu’tŸlAcûss
(
p
->
£qu’tŸl_acûss
)

63 ià(
blkSize
 < 4 || !
	`isPow”Of2
(blkSize)) {

64 
	`çl
("Block size must be‡t†east 4‡nd‡…ower of 2");

66 ià(
numS‘s
 <ğ0 || !
	`isPow”Of2
(numSets)) {

67 
	`çl
("# of sets must be‚on-zero‡nd‡…ower of 2");

69 ià(
assoc
 <= 0) {

70 
	`çl
("associativity must be greaterhan zero");

73 
blkMask
 = 
blkSize
 - 1;

74 
£tShiá
 = 
	`æoÜLog2
(
blkSize
);

75 
£tMask
 = 
numS‘s
 - 1;

76 
gShiá
 = 
£tShiá
 + 
	`æoÜLog2
(
numS‘s
);

78 
w¬mupBound
 = 
numS‘s
 * 
assoc
;

80 
£ts
 = 
Ãw
 
S‘Ty³
[
numS‘s
];

81 
blks
 = 
Ãw
 
BlkTy³
[
numS‘s
 * 
assoc
];

83 
numBlocks
 = 
numS‘s
 * 
assoc
;

84 
d©aBlks
 = 
Ãw
 
ušt8_t
[
numBlocks
 * 
blkSize
];

86 
blkIndex
 = 0;

87 
i
 = 0; i < 
numS‘s
; ++i) {

88 
£ts
[
i
].
assoc
 =‡ssoc;

90 
£ts
[
i
].
blks
 = 
Ãw
 
BlkTy³
*[
assoc
];

93 
j
 = 0; j < 
assoc
; ++j) {

95 
BlkTy³
 *
blk
 = &
blks
[
blkIndex
];

96 
blk
->
d©a
 = &
d©aBlks
[
blkSize
*
blkIndex
];

97 ++
blkIndex
;

100 
blk
->
	`šv®id©e
();

106 
blk
->
g
 = 
j
;

107 
blk
->
wh’R—dy
 = 0;

108 
blk
->
isTouched
 = 
çl£
;

109 
blk
->
size
 = 
blkSize
;

110 
£ts
[
i
].
blks
[
j
]=
blk
;

111 
blk
->
£t
 = 
i
;

112 
blk
->
way
 = 
j
;

115 
	}
}

117 
	gBa£S‘Assoc
::~
	$Ba£S‘Assoc
()

119 
d–‘e
 [] 
d©aBlks
;

120 
d–‘e
 [] 
blks
;

121 
d–‘e
 [] 
£ts
;

122 
	}
}

124 
CacheBlk
*

125 
	gBa£S‘Assoc
::
	$fšdBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const

127 
Addr
 
g
 = 
	`exŒaùTag
(
addr
);

128 
£t
 = 
	`exŒaùS‘
(
addr
);

129 
BlkTy³
 *
blk
 = 
£ts
[
£t
].
	`fšdBlk
(
g
, 
is_£cu»
);

130  
blk
;

131 
	}
}

133 
CacheBlk
*

134 
	gBa£S‘Assoc
::
	$fšdBlockByS‘AndWay
(
£t
, 
way
) const

136  
£ts
[
£t
].
blks
[
way
];

137 
	}
}

139 
	g¡d
::
¡ršg


140 
Ba£S‘Assoc
::
	$´št
() const {

141 
¡d
::
¡ršg
 
ÿche_¡©e
;

142 
i
 = 0; i < 
numS‘s
; ++i) {

144 
j
 = 0; j < 
assoc
; ++j) {

145 
BlkTy³
 *
blk
 = 
£ts
[
i
].
blks
[
j
];

146 ià(
blk
->
	`isV®id
())

147 
ÿche_¡©e
 +ğ
	`c¥rštf
("\t£t: %d block: %d %s\n", 
i
, 
j
,

148 
blk
->
	`´št
());

151 ià(
ÿche_¡©e
.
	`em±y
())

152 
ÿche_¡©e
 = "no validags\n";

153  
ÿche_¡©e
;

154 
	}
}

157 
	gBa£S‘Assoc
::
	$ş—nupRefs
()

159 
i
 = 0; i < 
numS‘s
*
assoc
; ++i) {

160 ià(
blks
[
i
].
	`isV®id
()) {

161 
tÙ®Refs
 +ğ
blks
[
i
].
»fCouÁ
;

162 ++
§m¶edRefs
;

165 
	}
}

168 
	gBa£S‘Assoc
::
	$compu‹Sts
()

170 
i
 = 0; i < 
CÚ‹xtSw™chTaskId
::
NumTaskId
; ++i) {

171 
occu·nc›sTaskId
[
i
] = 0;

172 
j
 = 0; j < 5; ++j) {

173 
ageTaskId
[
i
][
j
] = 0;

177 
i
 = 0; i < 
numS‘s
 * 
assoc
; ++i) {

178 ià(
blks
[
i
].
	`isV®id
()) {

179 
	`as£¹
(
blks
[
i
].
sk_id
 < 
CÚ‹xtSw™chTaskId
::
NumTaskId
);

180 
occu·nc›sTaskId
[
blks
[
i
].
sk_id
]++;

181 
	`as£¹
(
blks
[
i
].
tickIn£¹ed
 <ğ
	`curTick
());

182 
Tick
 
age
 = 
	`curTick
(è- 
blks
[
i
].
tickIn£¹ed
;

184 
age_šdex
;

185 ià(
age
 / 
SimClock
::
IÁ
::
us
 < 10) {

186 
age_šdex
 = 0;

187 } ià(
age
 / 
SimClock
::
IÁ
::
us
 < 100) {

188 
age_šdex
 = 1;

189 } ià(
age
 / 
SimClock
::
IÁ
::
ms
 < 1) {

190 
age_šdex
 = 2;

191 } ià(
age
 / 
SimClock
::
IÁ
::
ms
 < 10) {

192 
age_šdex
 = 3;

194 
age_šdex
 = 4;

196 
ageTaskId
[
blks
[
i
].
sk_id
][
age_šdex
]++;

199 
	}
}

	@cache/tags/base_set_assoc.hh

48 #iâdeà
__MEM_CACHE_TAGS_BASESETASSOC_HH__


49 
	#__MEM_CACHE_TAGS_BASESETASSOC_HH__


	)

51 
	~<ÿs£¹
>

52 
	~<c¡ršg
>

53 
	~<li¡
>

55 
	~"mem/ÿche/ba£.hh
"

56 
	~"mem/ÿche/blk.hh
"

57 
	~"mem/ÿche/gs/ba£.hh
"

58 
	~"mem/ÿche/gs/ÿche£t.hh
"

59 
	~"mem/·ck‘.hh
"

60 
	~"·¿ms/Ba£S‘Assoc.hh
"

76 şas 
	cBa£S‘Assoc
 : 
public
 
Ba£Tags


78 
public
:

80 
CacheBlk
 
	tBlkTy³
;

82 
	m¡d
::
	tli¡
<
	tBlkTy³
*> 
	tBlkLi¡
;

84 
	mCacheS‘
<
	tCacheBlk
> 
	tS‘Ty³
;

87 
	m´Ùeùed
:

89 cÚ¡ 
assoc
;

91 
	m®locAssoc
;

93 cÚ¡ 
	mnumS‘s
;

95 cÚ¡ 
boŞ
 
	m£qu’tŸlAcûss
;

98 
S‘Ty³
 *
	m£ts
;

101 
BlkTy³
 *
	mblks
;

103 
ušt8_t
 *
	md©aBlks
;

106 
	m£tShiá
;

108 
	mgShiá
;

110 
	m£tMask
;

112 
	mblkMask
;

114 
	mpublic
:

117 
Ba£S‘AssocP¬ams
 
	tP¬ams
;

122 
Ba£S‘Assoc
(cÚ¡ 
P¬ams
 *
p
);

127 
	mvœtu®
 ~
Ba£S‘Assoc
();

134 
	$g‘BlockSize
() const

136  
blkSize
;

145 
	$g‘SubBlockSize
() const

147  
blkSize
;

148 
	}
}

155 
	$g‘NumS‘s
(ècÚ¡ 
ov”ride


157  
numS‘s
;

158 
	}
}

165 
	$g‘NumWays
(ècÚ¡ 
ov”ride


167  
assoc
;

168 
	}
}

176 
CacheBlk
 *
	$fšdBlockByS‘AndWay
(
£t
, 
way
ècÚ¡ 
ov”ride
;

182 
	$šv®id©e
(
CacheBlk
 *
blk
è
ov”ride


184 
	`as£¹
(
blk
);

185 
	`as£¹
(
blk
->
	`isV®id
());

186 
gsInU£
--;

187 
	`as£¹
(
blk
->
¤cMa¡”Id
 < 
ÿche
->
sy¡em
->
	`maxMa¡”s
());

188 
occu·nc›s
[
blk
->
¤cMa¡”Id
]--;

189 
blk
->
¤cMa¡”Id
 = 
Reque¡
::
švldMa¡”Id
;

190 
blk
->
sk_id
 = 
CÚ‹xtSw™chTaskId
::
Unknown
;

191 
blk
->
tickIn£¹ed
 = 
	`curTick
();

192 
	}
}

205 
CacheBlk
* 
	$acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
,

206 
cÚ‹xt_¤c
è
ov”ride


208 
Addr
 
g
 = 
	`exŒaùTag
(
addr
);

209 
£t
 = 
	`exŒaùS‘
(
addr
);

210 
BlkTy³
 *
blk
 = 
£ts
[
£t
].
	`fšdBlk
(
g
, 
is_£cu»
);

211 
Ït
 = 
acûssL©’cy
;;

216 
gAcûs£s
 +ğ
®locAssoc
;

217 ià(
£qu’tŸlAcûss
) {

218 ià(
blk
 !ğ
nuÎ±r
) {

219 
d©aAcûs£s
 += 1;

222 
d©aAcûs£s
 +ğ
®locAssoc
;

225 ià(
blk
 !ğ
nuÎ±r
) {

226 ià(
blk
->
wh’R—dy
 > 
	`curTick
()

227 && 
ÿche
->
	`ticksToCyşes
(
blk
->
wh’R—dy
 - 
	`curTick
())

228 > 
acûssL©’cy
) {

229 
Ït
 = 
ÿche
->
	`ticksToCyşes
(
blk
->
wh’R—dy
 - 
	`curTick
());

231 
blk
->
»fCouÁ
 += 1;

234  
blk
;

235 
	}
}

245 
CacheBlk
* 
	$fšdBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
ècÚ¡ 
ov”ride
;

254 
CacheBlk
* 
	$fšdViùim
(
Addr
 
addr
è
ov”ride


256 
BlkTy³
 *
blk
 = 
nuÎ±r
;

257 
£t
 = 
	`exŒaùS‘
(
addr
);

260 
i
 = 0; i < 
®locAssoc
; ++i) {

261 
blk
 = 
£ts
[
£t
].
blks
[
i
];

262 ià(!
blk
->
	`isV®id
())

266  
blk
;

267 
	}
}

274 
	$š£¹Block
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
è
ov”ride


276 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

277 
Ma¡”ID
 
ma¡”_id
 = 
pkt
->
»q
->
	`ma¡”Id
();

278 
ušt32_t
 
sk_id
 = 
pkt
->
»q
->
	`skId
();

280 ià(!
blk
->
isTouched
) {

281 
gsInU£
++;

282 
blk
->
isTouched
 = 
Œue
;

283 ià(!
w¬medUp
 && 
gsInU£
.
	`v®ue
(è>ğ
w¬mupBound
) {

284 
w¬medUp
 = 
Œue
;

285 
w¬mupCyşe
 = 
	`curTick
();

293 ià(
blk
->
	`isV®id
()) {

294 
»¶aûm’ts
[0]++;

295 
tÙ®Refs
 +ğ
blk
->
»fCouÁ
;

296 ++
§m¶edRefs
;

297 
blk
->
»fCouÁ
 = 0;

300 
	`as£¹
(
blk
->
¤cMa¡”Id
 < 
ÿche
->
sy¡em
->
	`maxMa¡”s
());

301 
occu·nc›s
[
blk
->
¤cMa¡”Id
]--;

303 
blk
->
	`šv®id©e
();

306 
blk
->
isTouched
 = 
Œue
;

309 
blk
->
g
 = 
	`exŒaùTag
(
addr
);

312 
	`as£¹
(
ma¡”_id
 < 
ÿche
->
sy¡em
->
	`maxMa¡”s
());

313 
occu·nc›s
[
ma¡”_id
]++;

314 
blk
->
¤cMa¡”Id
 = 
ma¡”_id
;

315 
blk
->
sk_id
 =ask_id;

316 
blk
->
tickIn£¹ed
 = 
	`curTick
();

319 
gAcûs£s
 += 1;

320 
d©aAcûs£s
 += 1;

321 
	}
}

327 
vœtu®
 
	$£tWayAÎoÿtiÚMax
(
ways
è
ov”ride


329 
	`çl_if
(
ways
 < 1, "Allocation†imit must be greaterhan zero");

330 
®locAssoc
 = 
ways
;

331 
	}
}

337 
vœtu®
 
	$g‘WayAÎoÿtiÚMax
(ècÚ¡ 
ov”ride


339  
®locAssoc
;

340 
	}
}

347 
Addr
 
	$exŒaùTag
(
Addr
 
addr
ècÚ¡ 
ov”ride


349  (
addr
 >> 
gShiá
);

350 
	}
}

357 
	$exŒaùS‘
(
Addr
 
addr
ècÚ¡ 
ov”ride


359  ((
addr
 >> 
£tShiá
è& 
£tMask
);

360 
	}
}

367 
Addr
 
	$blkAlign
(
Addr
 
addr
) const

369  (
addr
 & ~(
Addr
)
blkMask
);

370 
	}
}

378 
Addr
 
	$»g’”©eBlkAddr
(
Addr
 
g
, 
£t
ècÚ¡ 
ov”ride


380  ((
g
 << 
gShiá
è| ((
Addr
)
£t
 << 
£tShiá
));

381 
	}
}

386 
	$ş—nupRefs
(è
ov”ride
;

391 
¡d
::
¡ršg
 
	$´št
(ècÚ¡ 
ov”ride
;

396 
	$compu‹Sts
(è
ov”ride
;

410 
	$fÜEachBlk
(
CacheBlkVis™Ü
 &
vis™Ü
è
ov”ride
 {

411 
i
 = 0; i < 
numS‘s
 * 
assoc
; ++i) {

412 ià(!
	`vis™Ü
(
blks
[
i
]))

415 
	}
}

	@cache/tags/cacheset.hh

48 #iâdeà
__MEM_CACHE_TAGS_CACHESET_HH__


49 
	#__MEM_CACHE_TAGS_CACHESET_HH__


	)

51 
	~<ÿs£¹
>

56 
	g‹m¶©e
 <
şass
 
	gBlkty³
>

57 şas 
	cCacheS‘


59 
	mpublic
:

61 
assoc
;

64 
Blkty³
 **
	mblks
;

73 
Blkty³
* 
	$fšdBlk
(
Addr
 
g
, 
boŞ
 
is_£cu»
, & 
way_id
) const ;

74 
Blkty³
* 
	$fšdBlk
(
Addr
 
g
, 
boŞ
 
is_£cu»
) const ;

80 
	`moveToH—d
(
Blkty³
 *
blk
);

86 
	`moveToTa
(
Blkty³
 *
blk
);

90 
‹m¶©e
 <
şass
 
Blkty³
>

91 
Blkty³
*

92 
CacheS‘
<
Blkty³
>::
	$fšdBlk
(
Addr
 
g
, 
boŞ
 
is_£cu»
, & 
way_id
) const

98 
way_id
 = 
assoc
;

99 
i
 = 0; i < 
assoc
; ++i) {

100 ià(
blks
[
i
]->
g
 =ğg && blks[i]->
	`isV®id
() &&

101 
blks
[
i
]->
	`isSecu»
(è=ğ
is_£cu»
) {

102 
way_id
 = 
i
;

103  
blks
[
i
];

106  
nuÎ±r
;

107 
	}
}

109 
	g‹m¶©e
 <
şass
 
	gBlkty³
>

110 
Blkty³
*

111 
	gCacheS‘
<
	gBlkty³
>::
	$fšdBlk
(
Addr
 
g
, 
boŞ
 
is_£cu»
) const

113 
ignÜed_way_id
;

114  
	`fšdBlk
(
g
, 
is_£cu»
, 
ignÜed_way_id
);

115 
	}
}

117 
	g‹m¶©e
 <
şass
 
	gBlkty³
>

119 
	gCacheS‘
<
	gBlkty³
>::
	$moveToH—d
(
Blkty³
 *
blk
)

122 ià(
blks
[0] =ğ
blk
)

129 
i
 = 0;

130 
Blkty³
 *
Ãxt
 = 
blk
;

133 
	`as£¹
(
i
 < 
assoc
);

134 
¡d
::
	`sw­
(
blks
[
i
], 
Ãxt
);

135 ++
i
;

136 } 
Ãxt
 !ğ
blk
);

137 
	}
}

139 
	g‹m¶©e
 <
şass
 
	gBlkty³
>

141 
	gCacheS‘
<
	gBlkty³
>::
	$moveToTa
(
Blkty³
 *
blk
)

144 ià(
blks
[
assoc
 - 1] =ğ
blk
)

151 
i
 = 
assoc
 - 1;

152 
Blkty³
 *
Ãxt
 = 
blk
;

155 
	`as£¹
(
i
 >= 0);

156 
¡d
::
	`sw­
(
blks
[
i
], 
Ãxt
);

157 --
i
;

158 } 
Ãxt
 !ğ
blk
);

159 
	}
}

	@cache/tags/fa_lru.cc

48 
	~"mem/ÿche/gs/ç_Ìu.hh
"

50 
	~<ÿs£¹
>

51 
	~<s¡»am
>

53 
	~"ba£/štm©h.hh
"

54 
	~"ba£/misc.hh
"

56 
usšg
 
Çme¥aû
 
	g¡d
;

58 
	gFALRU
::
	$FALRU
(cÚ¡ 
P¬ams
 *
p
)

59 : 
	`Ba£Tags
(
p
), 
	$ÿcheBound¬›s
(
nuÎ±r
)

61 ià(!
	`isPow”Of2
(
blkSize
))

62 
	`çl
("cache block size (in bytes) `%d' must be‡…ower ofwo",

63 
blkSize
);

64 ià(!
	`isPow”Of2
(
size
))

65 
	`çl
("Cache Size must be…ower of 2 for‚ow");

68 
numCaches
 = 
	`æoÜLog2
(
size
) - 17;

69 ià(
numCaches
 >0){

70 
ÿcheBound¬›s
 = 
Ãw
 
FALRUBlk
 *[
numCaches
];

71 
ÿcheMask
 = (
	`ULL
(1è<< 
numCaches
) - 1;

73 
ÿcheMask
 = 0;

76 
w¬mupBound
 = 
size
/
blkSize
;

77 
numBlocks
 = 
size
/
blkSize
;

79 
blks
 = 
Ãw
 
FALRUBlk
[
numBlocks
];

80 
h—d
 = &(
blks
[0]);

81 

 = &(
blks
[
numBlocks
-1]);

83 
h—d
->
´ev
 = 
nuÎ±r
;

84 
h—d
->
Ãxt
 = &(
blks
[1]);

85 
h—d
->
šCache
 = 
ÿcheMask
;

87 

->
´ev
 = &(
blks
[
numBlocks
-2]);

88 

->
Ãxt
 = 
nuÎ±r
;

89 

->
šCache
 = 0;

91 
šdex
 = (1 << 17è/ 
blkSize
;

92 
j
 = 0;

93 
æags
 = 
ÿcheMask
;

94 
i
 = 1; i < 
numBlocks
 - 1; i++) {

95 
blks
[
i
].
šCache
 = 
æags
;

96 ià(
i
 =ğ
šdex
 - 1){

97 
ÿcheBound¬›s
[
j
] = &(
blks
[
i
]);

98 
æags
 &ğ~ (1<<
j
);

99 ++
j
;

100 
šdex
 = index << 1;

102 
blks
[
i
].
´ev
 = &(blks[i-1]);

103 
blks
[
i
].
Ãxt
 = &(blks[i+1]);

104 
blks
[
i
].
isTouched
 = 
çl£
;

105 
blks
[
i
].
£t
 = 0;

106 
blks
[
i
].
way
 = i;

108 
	`as£¹
(
j
 =ğ
numCaches
);

109 
	`as£¹
(
šdex
 =ğ
numBlocks
);

111 
	}
}

113 
	gFALRU
::~
	$FALRU
()

115 ià(
numCaches
)

116 
d–‘e
[] 
ÿcheBound¬›s
;

118 
d–‘e
[] 
blks
;

119 
	}
}

122 
	gFALRU
::
	$»gSts
()

124 
usšg
 
Çme¥aû
 
Sts
;

125 
Ba£Tags
::
	`»gSts
();

126 
h™s


127 .
	`š™
(
numCaches
+1)

128 .
	`Çme
(name() + ".falru_hits")

129 .
	`desc
("The‚umber of hits inƒach cache size.")

131 
mis£s


132 .
	`š™
(
numCaches
+1)

133 .
	`Çme
(name() + ".falru_misses")

134 .
	`desc
("The‚umber of misses inƒach cache size.")

136 
acûs£s


137 .
	`Çme
(name() + ".falru_accesses")

138 .
	`desc
("The‚umber of‡ccessesohe FA LRU cache.")

141 
i
 = 0; i <ğ
numCaches
; ++i) {

142 
¡ršg¡»am
 
size_¡r
;

143 ià(
i
 < 3){

144 
size_¡r
 << (1<<(
i
+7)) <<"K";

146 
size_¡r
 << (1<<(
i
-3)) <<"M";

149 
h™s
.
	`subÇme
(
i
, 
size_¡r
.
	`¡r
());

150 
h™s
.
	`subdesc
(
i
, "H™ š‡ " + 
size_¡r
.
	`¡r
() +" cache");

151 
mis£s
.
	`subÇme
(
i
, 
size_¡r
.
	`¡r
());

152 
mis£s
.
	`subdesc
(
i
, "Mis£ š‡ " + 
size_¡r
.
	`¡r
() +" cache");

154 
	}
}

156 
FALRUBlk
 *

157 
	gFALRU
::
	$hashLookup
(
Addr
 
addr
) const

159 
gI‹¿tÜ
 
™”
 = 
gHash
.
	`fšd
(
addr
);

160 ià(
™”
 !ğ
gHash
.
	`’d
()) {

161  (*
™”
).
£cÚd
;

163  
nuÎ±r
;

164 
	}
}

167 
	gFALRU
::
	$šv®id©e
(
CacheBlk
 *
blk
)

169 
	`as£¹
(
blk
);

170 
gsInU£
--;

171 
	}
}

173 
CacheBlk
*

174 
	gFALRU
::
	$acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
, 
cÚ‹xt_¤c
)

176  
	`acûssBlock
(
addr
, 
is_£cu»
, 
Ït
, 
cÚ‹xt_¤c
, 0);

177 
	}
}

179 
CacheBlk
*

180 
	gFALRU
::
	$acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
, 
cÚ‹xt_¤c
,

181 *
šCache
)

183 
acûs£s
++;

184 
tmp_š_ÿche
 = 0;

185 
Addr
 
blkAddr
 = 
	`blkAlign
(
addr
);

186 
FALRUBlk
* 
blk
 = 
	`hashLookup
(
blkAddr
);

188 ià(
blk
 && blk->
	`isV®id
()) {

189 
	`as£¹
(
blk
->
g
 =ğ
blkAddr
);

190 
tmp_š_ÿche
 = 
blk
->
šCache
;

191 
i
 = 0; i < 
numCaches
; i++) {

192 ià(1<<
i
 & 
blk
->
šCache
) {

193 
h™s
[
i
]++;

195 
mis£s
[
i
]++;

198 
h™s
[
numCaches
]++;

199 ià(
blk
 !ğ
h—d
){

200 
	`moveToH—d
(
blk
);

203 
blk
 = 
nuÎ±r
;

204 
i
 = 0; i <ğ
numCaches
; ++i) {

205 
mis£s
[
i
]++;

208 ià(
šCache
) {

209 *
šCache
 = 
tmp_š_ÿche
;

212 
Ït
 = 
acûssL©’cy
;

214  
blk
;

215 
	}
}

218 
CacheBlk
*

219 
	gFALRU
::
	$fšdBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
) const

221 
Addr
 
blkAddr
 = 
	`blkAlign
(
addr
);

222 
FALRUBlk
* 
blk
 = 
	`hashLookup
(
blkAddr
);

224 ià(
blk
 && blk->
	`isV®id
()) {

225 
	`as£¹
(
blk
->
g
 =ğ
blkAddr
);

227 
blk
 = 
nuÎ±r
;

229  
blk
;

230 
	}
}

232 
CacheBlk
*

233 
	gFALRU
::
	$fšdBlockByS‘AndWay
(
£t
, 
way
) const

235 
	`as£¹
(
£t
 == 0);

236  &
blks
[
way
];

237 
	}
}

239 
CacheBlk
*

240 
	gFALRU
::
	$fšdViùim
(
Addr
 
addr
)

242 
FALRUBlk
 * 
blk
 = 

;

243 
	`as£¹
(
blk
->
šCache
 == 0);

244 
	`moveToH—d
(
blk
);

245 
gHash
.
	`”a£
(
blk
->
g
);

246 
gHash
[
	`blkAlign
(
addr
)] = 
blk
;

247 ià(
blk
->
	`isV®id
()) {

248 
»¶aûm’ts
[0]++;

250 
gsInU£
++;

251 
blk
->
isTouched
 = 
Œue
;

252 ià(!
w¬medUp
 && 
gsInU£
.
	`v®ue
(è>ğ
w¬mupBound
) {

253 
w¬medUp
 = 
Œue
;

254 
w¬mupCyşe
 = 
	`curTick
();

258  
blk
;

259 
	}
}

262 
	gFALRU
::
	$š£¹Block
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
)

264 
	}
}

267 
	gFALRU
::
	$moveToH—d
(
FALRUBlk
 *
blk
)

269 
upd©eMask
 = 
blk
->
šCache
 ^ 
ÿcheMask
;

270 
i
 = 0; i < 
numCaches
; i++){

271 ià((1<<
i
è& 
upd©eMask
) {

272 
ÿcheBound¬›s
[
i
]->
šCache
 &= ~(1<<i);

273 
ÿcheBound¬›s
[
i
] = cacheBound¬›s[i]->
´ev
;

274 } ià(
ÿcheBound¬›s
[
i
] =ğ
blk
) {

275 
ÿcheBound¬›s
[
i
] = 
blk
->
´ev
;

278 
blk
->
šCache
 = 
ÿcheMask
;

279 ià(
blk
 !ğ
h—d
) {

280 ià(
blk
 =ğ

){

281 
	`as£¹
(
blk
->
Ãxt
 =ğ
nuÎ±r
);

282 

 = 
blk
->
´ev
;

283 

->
Ãxt
 = 
nuÎ±r
;

285 
blk
->
´ev
->
Ãxt
 = blk->next;

286 
blk
->
Ãxt
->
´ev
 = blk->prev;

288 
blk
->
Ãxt
 = 
h—d
;

289 
blk
->
´ev
 = 
nuÎ±r
;

290 
h—d
->
´ev
 = 
blk
;

291 
h—d
 = 
blk
;

293 
	}
}

295 
boŞ


296 
	gFALRU
::
	$check
()

298 
FALRUBlk
* 
blk
 = 
h—d
;

299 
tÙ_size
 = 0;

300 
bound¬y
 = 1<<17;

301 
j
 = 0;

302 
æags
 = 
ÿcheMask
;

303 
blk
) {

304 
tÙ_size
 +ğ
blkSize
;

305 ià(
blk
->
šCache
 !ğ
æags
) {

306  
çl£
;

308 ià(
tÙ_size
 =ğ
bound¬y
 && 
blk
 !ğ

) {

309 ià(
ÿcheBound¬›s
[
j
] !ğ
blk
) {

310  
çl£
;

312 
æags
 &=~(1 << 
j
);

313 
bound¬y
 = boundary<<1;

314 ++
j
;

316 
blk
 = blk->
Ãxt
;

318  
Œue
;

319 
	}
}

321 
FALRU
 *

322 
	gFALRUP¬ams
::
	$ü—‹
()

324  
Ãw
 
	`FALRU
(
this
);

325 
	}
}

	@cache/tags/fa_lru.hh

48 #iâdeà
__MEM_CACHE_TAGS_FA_LRU_HH__


49 
	#__MEM_CACHE_TAGS_FA_LRU_HH__


	)

51 
	~<li¡
>

52 
	~<unÜd”ed_m­
>

54 
	~"mem/ÿche/blk.hh
"

55 
	~"mem/ÿche/gs/ba£.hh
"

56 
	~"mem/·ck‘.hh
"

57 
	~"·¿ms/FALRU.hh
"

62 şas 
	cFALRUBlk
 : 
public
 
CacheBlk


64 
public
:

66 
FALRUBlk
 *
´ev
;

68 
FALRUBlk
 *
	mÃxt
;

70 
boŞ
 
	misTouched
;

80 
	mšCache
;

87 şas 
	cFALRU
 : 
public
 
Ba£Tags


89 
public
:

91 
FALRUBlk
 
	tBlkTy³
;

93 
	m¡d
::
	tli¡
<
	tFALRUBlk
*> 
	tBlkLi¡
;

95 
	m´Ùeùed
:

97 
FALRUBlk
 **
ÿcheBound¬›s
;

99 
	mÿcheMask
;

101 
	mnumCaches
;

104 
FALRUBlk
 *
	mblks
;

107 
FALRUBlk
 *
	mh—d
;

109 
FALRUBlk
 *
	m
;

112 
	m¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	tFALRUBlk
 *, 
	t¡d
::
	thash
<Addr> > 
	thash_t
;

114 
	mhash_t
::
	tcÚ¡_™”©Ü
 
	tgI‹¿tÜ
;

117 
hash_t
 
	mgHash
;

124 
FALRUBlk
 * 
	$hashLookup
(
Addr
 
addr
) const;

130 
	`moveToH—d
(
FALRUBlk
 *
blk
);

137 
boŞ
 
	`check
();

147 
Sts
::
VeùÜ
 
h™s
;

149 
Sts
::
VeùÜ
 
mis£s
;

151 
Sts
::
SÿÏr
 
acûs£s
;

157 
public
:

159 
FALRUP¬ams
 
	tP¬ams
;

164 
	`FALRU
(cÚ¡ 
P¬ams
 *
p
);

165 ~
	`FALRU
();

171 
	$»gSts
(è
ov”ride
;

177 
	$šv®id©e
(
CacheBlk
 *
blk
è
ov”ride
;

191 
CacheBlk
* 
	`acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
,

192 
cÚ‹xt_¤c
, *
šCache
);

197 
CacheBlk
* 
	$acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
,

198 
cÚ‹xt_¤c
è
ov”ride
;

207 
CacheBlk
* 
	$fšdBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
ècÚ¡ 
ov”ride
;

214 
CacheBlk
* 
	$fšdViùim
(
Addr
 
addr
è
ov”ride
;

216 
	$š£¹Block
(
Pack‘PŒ
 
pkt
, 
CacheBlk
 *
blk
è
ov”ride
;

223 
	$g‘BlockSize
() const

225  
blkSize
;

233 
	$g‘SubBlockSize
() const

235  
blkSize
;

236 
	}
}

243 
	$g‘NumS‘s
(ècÚ¡ 
ov”ride


246 
	}
}

253 
	$g‘NumWays
(ècÚ¡ 
ov”ride


255  
numBlocks
;

256 
	}
}

264 
CacheBlk
* 
	$fšdBlockByS‘AndWay
(
£t
, 
way
ècÚ¡ 
ov”ride
;

271 
Addr
 
	$blkAlign
(
Addr
 
addr
) const

273  (
addr
 & ~(
Addr
)(
blkSize
-1));

274 
	}
}

282 
Addr
 
	$exŒaùTag
(
Addr
 
addr
ècÚ¡ 
ov”ride


284  
	`blkAlign
(
addr
);

285 
	}
}

292 
	$exŒaùS‘
(
Addr
 
addr
ècÚ¡ 
ov”ride


295 
	}
}

303 
Addr
 
	$»g’”©eBlkAddr
(
Addr
 
g
, 
£t
ècÚ¡ 
ov”ride


305  (
g
);

306 
	}
}

311 
vœtu®
 
	g¡d
::
¡ršg
 
	$´št
(ècÚ¡ 
ov”ride
 {  ""; 
	}
}

325 
	$fÜEachBlk
(
CacheBlkVis™Ü
 &
vis™Ü
è
ov”ride
 {

326 
i
 = 0; i < 
numBlocks
; i++) {

327 ià(!
	`vis™Ü
(
blks
[
i
]))

330 
	}
}

	@cache/tags/lru.cc

48 
	~"mem/ÿche/gs/Ìu.hh
"

50 
	~"debug/CacheR•l.hh
"

51 
	~"mem/ÿche/ba£.hh
"

53 
	gLRU
::
	$LRU
(cÚ¡ 
P¬ams
 *
p
)

54 : 
	$Ba£S‘Assoc
(
p
)

56 
	}
}

58 
CacheBlk
*

59 
LRU
::
	$acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
, 
ma¡”_id
)

61 
CacheBlk
 *
blk
 = 
Ba£S‘Assoc
::
	`acûssBlock
(
addr
, 
is_£cu»
, 
Ït
, 
ma¡”_id
);

63 ià(
blk
 !ğ
nuÎ±r
) {

65 
£ts
[
blk
->
£t
].
	`moveToH—d
(blk);

66 
	`DPRINTF
(
CacheR•l
, "set %x: moving blk %x (%s)o MRU\n",

67 
blk
->
£t
, 
	`»g’”©eBlkAddr
(blk->
g
, blk->set),

68 
is_£cu»
 ? "s" : "ns");

71  
blk
;

72 
	}
}

74 
CacheBlk
*

75 
	gLRU
::
	$fšdViùim
(
Addr
 
addr
)

77 
£t
 = 
	`exŒaùS‘
(
addr
);

79 
BlkTy³
 *
blk
 = 
nuÎ±r
;

80 
i
 = 
assoc
 - 1; i >= 0; i--) {

81 
BlkTy³
 *
b
 = 
£ts
[
£t
].
blks
[
i
];

82 ià(
b
->
way
 < 
®locAssoc
) {

83 
blk
 = 
b
;

87 
	`as£¹
(!
blk
 || blk->
way
 < 
®locAssoc
);

89 ià(
blk
 && blk->
	`isV®id
()) {

90 
	`DPRINTF
(
CacheR•l
, "set %x: selecting blk %x for„eplacement\n",

91 
£t
, 
	`»g’”©eBlkAddr
(
blk
->
g
, set));

94  
blk
;

95 
	}
}

98 
	gLRU
::
	$š£¹Block
(
Pack‘PŒ
 
pkt
, 
BlkTy³
 *
blk
)

100 
Ba£S‘Assoc
::
	`š£¹Block
(
pkt
, 
blk
);

102 
£t
 = 
	`exŒaùS‘
(
pkt
->
	`g‘Addr
());

103 
£ts
[
£t
].
	`moveToH—d
(
blk
);

104 
	}
}

107 
	gLRU
::
	$šv®id©e
(
CacheBlk
 *
blk
)

109 
Ba£S‘Assoc
::
	`šv®id©e
(
blk
);

112 
£t
 = 
blk
->set;

113 
£ts
[
£t
].
	`moveToTa
(
blk
);

114 
	}
}

116 
LRU
*

117 
	gLRUP¬ams
::
	$ü—‹
()

119  
Ãw
 
	`LRU
(
this
);

120 
	}
}

	@cache/tags/lru.hh

50 #iâdeà
__MEM_CACHE_TAGS_LRU_HH__


51 
	#__MEM_CACHE_TAGS_LRU_HH__


	)

53 
	~"mem/ÿche/gs/ba£_£t_assoc.hh
"

54 
	~"·¿ms/LRU.hh
"

56 şas 
	cLRU
 : 
public
 
Ba£S‘Assoc


58 
public
:

60 
LRUP¬ams
 
	tP¬ams
;

65 
LRU
(cÚ¡ 
P¬ams
 *
p
);

70 ~
	$LRU
() {}

72 
CacheBlk
* 
	`acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
,

73 
cÚ‹xt_¤c
);

74 
CacheBlk
* 
	`fšdViùim
(
Addr
 
addr
);

75 
	`š£¹Block
(
Pack‘PŒ
 
pkt
, 
BlkTy³
 *
blk
);

76 
	`šv®id©e
(
CacheBlk
 *
blk
);

77 
	}
};

	@cache/tags/random_repl.cc

36 
	~"mem/ÿche/gs/¿ndom_»¶.hh
"

38 
	~"ba£/¿ndom.hh
"

39 
	~"debug/CacheR•l.hh
"

40 
	~"mem/ÿche/ba£.hh
"

42 
	gRªdomR•l
::
	$RªdomR•l
(cÚ¡ 
P¬ams
 *
p
)

43 : 
	$Ba£S‘Assoc
(
p
)

46 
	}
}

48 
CacheBlk
*

49 
RªdomR•l
::
	$acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
, 
ma¡”_id
)

51  
Ba£S‘Assoc
::
	`acûssBlock
(
addr
, 
is_£cu»
, 
Ït
, 
ma¡”_id
);

52 
	}
}

54 
CacheBlk
*

55 
	gRªdomR•l
::
	$fšdViùim
(
Addr
 
addr
)

57 
CacheBlk
 *
blk
 = 
Ba£S‘Assoc
::
	`fšdViùim
(
addr
);

58 
£t
 = 
	`exŒaùS‘
(
addr
);

61 ià(
blk
 && blk->
	`isV®id
()) {

63 
idx
 = 
¿ndom_mt
.
¿ndom
<>(0, 
assoc
 - 1);

64 
blk
 = 
£ts
[
£t
].
blks
[
idx
];

66 
blk
->
way
 >ğ
®locAssoc
) {

67 
idx
 = (idx + 1è% 
assoc
;

68 
blk
 = 
£ts
[
£t
].
blks
[
idx
];

71 
	`as£¹
(
idx
 < 
assoc
);

72 
	`as£¹
(
idx
 >= 0);

73 
	`as£¹
(
blk
->
way
 < 
®locAssoc
);

75 
	`DPRINTF
(
CacheR•l
, "set %x: selecting blk %x for„eplacement\n",

76 
blk
->
£t
, 
	`»g’”©eBlkAddr
(blk->
g
, blk->set));

79  
blk
;

80 
	}
}

83 
	gRªdomR•l
::
	$š£¹Block
(
Pack‘PŒ
 
pkt
, 
BlkTy³
 *
blk
)

85 
Ba£S‘Assoc
::
	`š£¹Block
(
pkt
, 
blk
);

86 
	}
}

89 
	gRªdomR•l
::
	$šv®id©e
(
CacheBlk
 *
blk
)

91 
Ba£S‘Assoc
::
	`šv®id©e
(
blk
);

92 
	}
}

94 
RªdomR•l
*

95 
	gRªdomR•lP¬ams
::
	$ü—‹
()

97  
Ãw
 
	`RªdomR•l
(
this
);

98 
	}
}

	@cache/tags/random_repl.hh

39 #iâdeà
__MEM_CACHE_TAGS_RANDOM_REPL_HH__


40 
	#__MEM_CACHE_TAGS_RANDOM_REPL_HH__


	)

42 
	~"mem/ÿche/gs/ba£_£t_assoc.hh
"

43 
	~"·¿ms/RªdomR•l.hh
"

45 şas 
	cRªdomR•l
 : 
public
 
Ba£S‘Assoc


47 
public
:

49 
RªdomR•lP¬ams
 
	tP¬ams
;

54 
RªdomR•l
(cÚ¡ 
P¬ams
 *
p
);

59 ~
	$RªdomR•l
() {}

61 
CacheBlk
* 
	`acûssBlock
(
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
Cyşes
 &
Ït
,

62 
cÚ‹xt_¤c
);

63 
CacheBlk
* 
	`fšdViùim
(
Addr
 
addr
);

64 
	`š£¹Block
(
Pack‘PŒ
 
pkt
, 
BlkTy³
 *
blk
);

65 
	`šv®id©e
(
CacheBlk
 *
blk
);

66 
	}
};

	@cache/write_queue.cc

49 
	~"mem/ÿche/wr™e_queue.hh
"

51 
usšg
 
Çme¥aû
 
	g¡d
;

53 
	gWr™eQueue
::
	$Wr™eQueue
(cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
,

54 
num_’Œ›s
, 
»£rve
)

55 : 
Queue
<
Wr™eQueueEÁry
>(
_Ïb–
, 
num_’Œ›s
, 
»£rve
)

56 {
	}
}

58 
Wr™eQueueEÁry
 *

59 
	gWr™eQueue
::
	$®loÿ‹
(
Addr
 
blk_addr
, 
blk_size
, 
Pack‘PŒ
 
pkt
,

60 
Tick
 
wh’_»ady
, 
CouÁ”
 
Üd”
)

62 
	`as£¹
(!
ä“Li¡
.
	`em±y
());

63 
Wr™eQueueEÁry
 *
’Œy
 = 
ä“Li¡
.
	`äÚt
();

64 
	`as£¹
(
’Œy
->
	`g‘NumT¬g‘s
() == 0);

65 
ä“Li¡
.
	`pİ_äÚt
();

67 
’Œy
->
	`®loÿ‹
(
blk_addr
, 
blk_size
, 
pkt
, 
wh’_»ady
, 
Üd”
);

68 
’Œy
->
®locI‹r
 = 
®loÿ‹dLi¡
.
	`š£¹
×Îoÿ‹dLi¡.
	`’d
(),ƒntry);

69 
’Œy
->
»adyI‹r
 = 
	`addToR—dyLi¡
(entry);

71 
®loÿ‹d
 += 1;

72  
’Œy
;

73 
	}
}

76 
	gWr™eQueue
::
	$m¬kInS”viû
(
Wr™eQueueEÁry
 *
’Œy
)

82 
’Œy
->
	`pİT¬g‘
();

83 
	`d—Îoÿ‹
(
’Œy
);

84 
	}
}

	@cache/write_queue.hh

45 #iâdeà
__MEM_CACHE_WRITE_QUEUE_HH__


46 
	#__MEM_CACHE_WRITE_QUEUE_HH__


	)

48 
	~<veùÜ
>

50 
	~"mem/ÿche/queue.hh
"

51 
	~"mem/ÿche/wr™e_queue_’Œy.hh
"

57 
şass
 
	gWr™eQueue
 : 
public
 
Queue
<
Wr™eQueueEÁry
>

60 
public
:

68 
Wr™eQueue
(cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
, 
num_’Œ›s
, 
»£rve
);

84 
Wr™eQueueEÁry
 *
®loÿ‹
(
Addr
 
blk_addr
, 
blk_size
,

85 
Pack‘PŒ
 
pkt
, 
Tick
 
wh’_»ady
, 
CouÁ”
 
Üd”
);

94 
m¬kInS”viû
(
Wr™eQueueEÁry
 *
’Œy
);

	@cache/write_queue_entry.cc

51 
	~"mem/ÿche/wr™e_queue_’Œy.hh
"

53 
	~<®gÜ™hm
>

54 
	~<ÿs£¹
>

55 
	~<¡ršg
>

56 
	~<veùÜ
>

58 
	~"ba£/misc.hh
"

59 
	~"ba£/ty³s.hh
"

60 
	~"debug/Cache.hh
"

61 
	~"mem/ÿche/ÿche.hh
"

62 
	~"sim/cÜe.hh
"

64 
usšg
 
Çme¥aû
 
	g¡d
;

66 
šlše
 

67 
	gWr™eQueueEÁry
::
T¬g‘Li¡
::
	$add
(
Pack‘PŒ
 
pkt
, 
Tick
 
»adyTime
,

68 
CouÁ”
 
Üd”
)

70 
	`em¶aû_back
(
pkt
, 
»adyTime
, 
Üd”
);

71 
	}
}

73 
boŞ


74 
	gWr™eQueueEÁry
::
T¬g‘Li¡
::
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

76 auto& 
t
 : *
this
) {

77 ià(
pkt
->
	`checkFunùiÚ®
(
t
.pkt)) {

78  
Œue
;

82  
çl£
;

83 
	}
}

86 
	gWr™eQueueEÁry
::
T¬g‘Li¡
::
	$´št
(
¡d
::
o¡»am
 &
os
, 
v”bos™y
,

87 cÚ¡ 
¡d
::
¡ršg
 &
´efix
) const

89 auto& 
t
 : *
this
) {

90 
	`cırštf
(
os
, "%sFromCPU: ", 
´efix
);

91 
t
.
pkt
->
	`´št
(
os
, 
v”bos™y
, "");

93 
	}
}

96 
	gWr™eQueueEÁry
::
	$®loÿ‹
(
Addr
 
blk_addr
, 
blk_size
, 
Pack‘PŒ
 
rg‘
,

97 
Tick
 
wh’_»ady
, 
CouÁ”
 
_Üd”
)

99 
blkAddr
 = 
blk_addr
;

100 
blkSize
 = 
blk_size
;

101 
isSecu»
 = 
rg‘
->
	`isSecu»
();

102 
»adyTime
 = 
wh’_»ady
;

103 
Üd”
 = 
_Üd”
;

104 
	`as£¹
(
rg‘
);

105 
_isUnÿch—bË
 = 
rg‘
->
»q
->
	`isUnÿch—bË
();

106 
šS”viû
 = 
çl£
;

110 
	`·nic_if
(!
_isUnÿch—bË
 && !
rg‘s
.
	`em±y
(),

112 "ÿch—bË¬g‘", 
blkAddr
);

113 
	`·nic_if
(!((
rg‘
->
	`isWr™e
(è&& 
_isUnÿch—bË
) ||

114 (
rg‘
->
	`isEviùiÚ
(è&& !
_isUnÿch—bË
)),

118 
rg‘s
.
	`add
(
rg‘
, 
wh’_»ady
, 
_Üd”
);

119 
	}
}

122 
	gWr™eQueueEÁry
::
	$d—Îoÿ‹
()

124 
	`as£¹
(
rg‘s
.
	`em±y
());

125 
šS”viû
 = 
çl£
;

126 
	}
}

128 
boŞ


129 
	gWr™eQueueEÁry
::
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

134 ià(
pkt
->
	`isPršt
()) {

135 
pkt
->
	`checkFunùiÚ®
(
this
, 
blkAddr
, 
isSecu»
, 
blkSize
, 
nuÎ±r
);

136  
çl£
;

138  
rg‘s
.
	`checkFunùiÚ®
(
pkt
);

140 
	}
}

142 
boŞ


143 
	gWr™eQueueEÁry
::
	$£ndPack‘
(
Cache
 &
ÿche
)

145  
ÿche
.
	`£ndWr™eQueuePack‘
(
this
);

146 
	}
}

149 
	gWr™eQueueEÁry
::
	$´št
(
¡d
::
o¡»am
 &
os
, 
v”bos™y
,

150 cÚ¡ 
¡d
::
¡ršg
 &
´efix
) const

152 
	`cırštf
(
os
, "%s[%#llx:%#llx](%s) %s %s %s state: %s %s %s %s %s\n",

153 
´efix
, 
blkAddr
, blkAdd¸+ 
blkSize
 - 1,

154 
isSecu»
 ? "s" : "ns",

155 
_isUnÿch—bË
 ? "Unc" : "",

156 
šS”viû
 ? "InSvc" : "");

158 
	`cırštf
(
os
, "%  T¬g‘s:\n", 
´efix
);

159 
rg‘s
.
	`´št
(
os
, 
v”bos™y
, 
´efix
 + " ");

160 
	}
}

162 
	g¡d
::
¡ršg


163 
Wr™eQueueEÁry
::
	$´št
() const

165 
o¡ršg¡»am
 
¡r
;

166 
	`´št
(
¡r
);

167  
¡r
.
	`¡r
();

168 
	}
}

	@cache/write_queue_entry.hh

49 #iâdeà
__MEM_CACHE_WRITE_QUEUE_ENTRY_HH__


50 
	#__MEM_CACHE_WRITE_QUEUE_ENTRY_HH__


	)

52 
	~<li¡
>

54 
	~"ba£/´šbË.hh
"

55 
	~"mem/ÿche/queue_’Œy.hh
"

57 
şass
 
	gCache
;

62 
şass
 
	gWr™eQueueEÁry
 : 
public
 
QueueEÁry
,…ubliø
	gPršbË


68 
	g‹m¶©e
<
ty³Çme
 
	gEÁry
>

69 
ä›nd
 
şass
 
	gQueue
;

70 
ä›nd
 
şass
 
	gWr™eQueue
;

72 
	gpublic
:

74 şas 
	cT¬g‘
 {

75 
public
:

77 cÚ¡ 
Tick
 
»cvTime
;

78 cÚ¡ 
Tick
 
	g»adyTime
;

79 cÚ¡ 
CouÁ”
 
	gÜd”
;

80 cÚ¡ 
Pack‘PŒ
 
	gpkt
;

82 
T¬g‘
(
Pack‘PŒ
 
_pkt
, 
Tick
 
_»adyTime
, 
CouÁ”
 
_Üd”
)

83 : 
»cvTime
(
curTick
()), 
»adyTime
(
_»adyTime
), 
Üd”
(
_Üd”
),

84 
pkt
(
_pkt
)

88 
şass
 
	gT¬g‘Li¡
 : 
public
 
¡d
::
li¡
<
T¬g‘
> {

90 
public
:

92 
T¬g‘Li¡
() {}

93 
add
(
Pack‘PŒ
 
pkt
, 
Tick
 
»adyTime
, 
CouÁ”
 
Üd”
);

94 
boŞ
 
checkFunùiÚ®
(
Pack‘PŒ
 
pkt
);

95 
´št
(
¡d
::
o¡»am
 &
os
, 
v”bos™y
,

96 cÚ¡ 
¡d
::
¡ršg
 &
´efix
) const;

100 
	g¡d
::
	tli¡
<
	tWr™eQueueEÁry
 *> 
	tLi¡
;

102 
	gLi¡
::
	t™”©Ü
 
	tI‹¿tÜ
;

104 
boŞ
 
£ndPack‘
(
Cache
 &
ÿche
);

106 
	g´iv©e
:

112 
I‹¿tÜ
 
»adyI‹r
;

118 
I‹¿tÜ
 
	g®locI‹r
;

121 
T¬g‘Li¡
 
	grg‘s
;

123 
	gpublic
:

126 
	$Wr™eQueueEÁry
(è{
	}
}

136 
®loÿ‹
(
Addr
 
blk_addr
, 
blk_size
, 
Pack‘PŒ
 
pkt
,

137 
Tick
 
wh’_»ady
, 
CouÁ”
 
_Üd”
);

143 
d—Îoÿ‹
();

149 
	$g‘NumT¬g‘s
() const

150 {  
rg‘s
.
	`size
(); 
	}
}

156 
boŞ
 
	$hasT¬g‘s
(ècÚ¡ {  !
rg‘s
.
	`em±y
(); 
	}
}

162 
T¬g‘
 *
	$g‘T¬g‘
()

164 
	`as£¹
(
	`hasT¬g‘s
());

165  &
rg‘s
.
	`äÚt
();

166 
	}
}

171 
	$pİT¬g‘
()

173 
rg‘s
.
	`pİ_äÚt
();

174 
	}
}

176 
boŞ
 
checkFunùiÚ®
(
Pack‘PŒ
 
pkt
);

181 
´št
(
¡d
::
o¡»am
 &
os
,

182 
v”bos™y
 = 0,

183 cÚ¡ 
¡d
::
¡ršg
 &
´efix
 = "") const;

190 
	g¡d
::
¡ršg
 
	$´št
() const;

191 
	}
};

	@coherent_xbar.cc

50 
	~"ba£/misc.hh
"

51 
	~"ba£/Œaû.hh
"

52 
	~"debug/AddrRªges.hh
"

53 
	~"debug/Coh”’tXB¬.hh
"

54 
	~"mem/coh”’t_xb¬.hh
"

55 
	~"sim/sy¡em.hh
"

57 
	gCoh”’tXB¬
::
	$Coh”’tXB¬
(cÚ¡ 
Coh”’tXB¬P¬ams
 *
p
)

58 : 
	`Ba£XB¬
(
p
), 
	`sy¡em
Õ->
sy¡em
), 
	`¢oİF‹r
Õ->
¢oİ_f‹r
),

59 
	`¢oİRe¥Ú£L©’cy
(
p
->
¢oİ_»¥Ú£_Ï‹ncy
),

60 
	`poštOfCoh”’cy
(
p
->
pošt_of_coh”’cy
)

65 
i
 = 0; i < 
p
->
pÜt_ma¡”_cÚÃùiÚ_couÁ
; ++i) {

66 
¡d
::
¡ršg
 
pÜtName
 = 
	`c¥rštf
("%s.ma¡”[%d]", 
	`Çme
(), 
i
);

67 
Ma¡”PÜt
* 
bp
 = 
Ãw
 
	`Coh”’tXB¬Ma¡”PÜt
(
pÜtName
, *
this
, 
i
);

68 
ma¡”PÜts
.
	`push_back
(
bp
);

69 
»qLay”s
.
	`push_back
(
Ãw
 
	`ReqLay”
(*
bp
, *
this
,

70 
	`c¥rštf
(".»qLay”%d", 
i
)));

71 
¢oİLay”s
.
	`push_back
(
Ãw
 
	`SnoİRe¥Lay”
(*
bp
, *
this
,

72 
	`c¥rštf
(".¢oİLay”%d", 
i
)));

77 ià(
p
->
pÜt_deçuÉ_cÚÃùiÚ_couÁ
) {

78 
deçuÉPÜtID
 = 
ma¡”PÜts
.
	`size
();

79 
¡d
::
¡ršg
 
pÜtName
 = 
	`Çme
() + ".default";

80 
Ma¡”PÜt
* 
bp
 = 
Ãw
 
	`Coh”’tXB¬Ma¡”PÜt
(
pÜtName
, *
this
,

81 
deçuÉPÜtID
);

82 
ma¡”PÜts
.
	`push_back
(
bp
);

83 
»qLay”s
.
	`push_back
(
Ãw
 
	`ReqLay”
(*
bp
, *
this
, 
	`c¥rštf
(".reqLayer%d",

84 
deçuÉPÜtID
)));

85 
¢oİLay”s
.
	`push_back
(
Ãw
 
	`SnoİRe¥Lay”
(*
bp
, *
this
,

86 
	`c¥rštf
(".snoopLayer%d",

87 
deçuÉPÜtID
)));

91 
i
 = 0; i < 
p
->
pÜt_¦ave_cÚÃùiÚ_couÁ
; ++i) {

92 
¡d
::
¡ršg
 
pÜtName
 = 
	`c¥rštf
("%s.¦ave[%d]", 
	`Çme
(), 
i
);

93 
QueuedSÏvePÜt
* 
bp
 = 
Ãw
 
	`Coh”’tXB¬SÏvePÜt
(
pÜtName
, *
this
, 
i
);

94 
¦avePÜts
.
	`push_back
(
bp
);

95 
»¥Lay”s
.
	`push_back
(
Ãw
 
	`Re¥Lay”
(*
bp
, *
this
,

96 
	`c¥rštf
(".»¥Lay”%d", 
i
)));

97 
¢oİRe¥PÜts
.
	`push_back
(
Ãw
 
	`SnoİRe¥PÜt
(*
bp
, *
this
));

100 
	`ş—rPÜtCache
();

101 
	}
}

103 
	gCoh”’tXB¬
::~
	$Coh”’tXB¬
()

105 autØ
l
: 
»qLay”s
)

106 
d–‘e
 
l
;

107 autØ
l
: 
»¥Lay”s
)

108 
d–‘e
 
l
;

109 autØ
l
: 
¢oİLay”s
)

110 
d–‘e
 
l
;

111 autØ
p
: 
¢oİRe¥PÜts
)

112 
d–‘e
 
p
;

113 
	}
}

116 
	gCoh”’tXB¬
::
	$š™
()

118 
Ba£XB¬
::
	`š™
();

122 cÚ¡‡uto& 
p
: 
¦avePÜts
) {

124 ià(
p
->
	`isSnoİšg
()) {

125 
	`DPRINTF
(
AddrRªges
, "Adding snooping master %s\n",

126 
p
->
	`g‘Ma¡”PÜt
().
	`Çme
());

127 
¢oİPÜts
.
	`push_back
(
p
);

131 ià(
¢oİPÜts
.
	`em±y
())

132 
	`w¬n
("Coh”’tXB¬ % ha nØ¢oİšg…Üt ©ched!\n", 
	`Çme
());

136 ià(
¢oİF‹r
)

137 
¢oİF‹r
->
	`£tSÏvePÜts
(
¦avePÜts
);

138 
	}
}

140 
boŞ


141 
	gCoh”’tXB¬
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
)

144 
SÏvePÜt
 *
¤c_pÜt
 = 
¦avePÜts
[
¦ave_pÜt_id
];

147 
boŞ
 
is_ex´ess_¢oİ
 = 
pkt
->
	`isEx´essSnoİ
();

148 
boŞ
 
ÿche_»¥Údšg
 = 
pkt
->
	`ÿcheRe¥Údšg
();

151 
	`as£¹
(
is_ex´ess_¢oİ
 =ğ
ÿche_»¥Údšg
);

154 
PÜtID
 
ma¡”_pÜt_id
 = 
	`fšdPÜt
(
pkt
->
	`g‘Addr
());

158 ià(!
is_ex´ess_¢oİ
 && !
»qLay”s
[
ma¡”_pÜt_id
]->
	`ŒyTimšg
(
¤c_pÜt
)) {

159 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingReq: src %s %s 0x%x BUSY\n",

160 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

161  
çl£
;

164 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingReq: src %s %sƒxpr %d 0x%x\n",

165 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(), 
is_ex´ess_¢oİ
,

166 
pkt
->
	`g‘Addr
());

170 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

171 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

174 
Tick
 
Şd_h—d”_d–ay
 = 
pkt
->
h—d”D–ay
;

177 
Tick
 
xb¬_d–ay
 = (
äÚ‹ndL©’cy
 + 
fÜw¬dL©’cy
è* 
	`şockP”iod
();

180 
	`ÿlcPack‘Timšg
(
pkt
, 
xb¬_d–ay
);

183 
Tick
 
·ck‘FšishTime
 = 
	`şockEdge
(
	`Cyşes
(1)è+ 
pkt
->
·ylßdD–ay
;

185 ià(!
sy¡em
->
	`by·ssCaches
()) {

186 
	`as£¹
(
pkt
->
¢oİD–ay
 == 0);

190 ià(
¢oİF‹r
) {

192 autØ
sf_»s
 = 
¢oİF‹r
->
	`lookupReque¡
(
pkt
, *
¤c_pÜt
);

196 
pkt
->
h—d”D–ay
 +ğ
sf_»s
.
£cÚd
 * 
	`şockP”iod
();

197 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingReq: src %s %s 0x%x"\

198 " SF size: %˜Ït: %i\n", 
¤c_pÜt
->
	`Çme
(),

199 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(), 
sf_»s
.
fœ¡
.
	`size
(),

200 
sf_»s
.
£cÚd
);

202 ià(
pkt
->
	`isEviùiÚ
()) {

208 ià(!
sf_»s
.
fœ¡
.
	`em±y
())

209 
pkt
->
	`£tBlockCached
();

211 
	`fÜw¬dTimšg
(
pkt
, 
¦ave_pÜt_id
, 
sf_»s
.
fœ¡
);

214 
	`fÜw¬dTimšg
(
pkt
, 
¦ave_pÜt_id
);

218 
pkt
->
h—d”D–ay
 +ğpkt->
¢oİD–ay
;

219 
pkt
->
¢oİD–ay
 = 0;

223 
boŞ
 
sucûss
 = 
Œue
;

228 cÚ¡ 
boŞ
 
ex³ù_¢oİ_»¥
 = !
ÿche_»¥Údšg
 && 
pkt
->
	`ÿcheRe¥Údšg
();

229 
boŞ
 
ex³ù_»¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
(è&& !pkt->
	`ÿcheRe¥Údšg
();

231 cÚ¡ 
boŞ
 
sšk_·ck‘
 = 
	`sškPack‘
(
pkt
);

234 
boŞ
 
»¥Úd_dœeùly
 = 
çl£
;

237 cÚ¡ 
Addr
 
	`addr
(
pkt
->
	`g‘Addr
());

238 ià(
sšk_·ck‘
) {

239 
	`DPRINTF
(
Coh”’tXB¬
, "Not forwarding %so %#llx\n",

240 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

244 ià(!
poštOfCoh”’cy
 || 
pkt
->
	`isR—d
(è||…kt->
	`isWr™e
()) {

250 ià(
pkt
->
	`ÿcheRe¥Údšg
()) {

251 
pkt
->
	`£tEx´essSnoİ
();

255 
sucûss
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`£ndTimšgReq
(
pkt
);

259 
	`as£¹
(
pkt
->
	`ÃedsRe¥Ú£
());

261 
»¥Úd_dœeùly
 = 
Œue
;

262 
	`as£¹
(!
ex³ù_¢oİ_»¥
);

263 
ex³ù_»¥Ú£
 = 
çl£
;

267 ià(
¢oİF‹r
 && !
sy¡em
->
	`by·ssCaches
()) {

269 
¢oİF‹r
->
	`fšishReque¡
(!
sucûss
, 
addr
, 
pkt
->
	`isSecu»
());

273 ià(!
sucûss
) {

275 
	`as£¹
(!
is_ex´ess_¢oİ
);

278 
pkt
->
h—d”D–ay
 = 
Şd_h—d”_d–ay
;

280 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingReq: src %s %s 0x%x RETRY\n",

281 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

284 
»qLay”s
[
ma¡”_pÜt_id
]->
	`çedTimšg
(
¤c_pÜt
,

285 
	`şockEdge
(
	`Cyşes
(1)));

288 ià(!
is_ex´ess_¢oİ
) {

291 ià(
ex³ù_¢oİ_»¥
) {

293 
	`as£¹
(
out¡ªdšgSnoİ
.
	`fšd
(
pkt
->
»q
) ==

294 
out¡ªdšgSnoİ
.
	`’d
());

295 
out¡ªdšgSnoİ
.
	`š£¹
(
pkt
->
»q
);

298 
	`·nic_if
(
out¡ªdšgSnoİ
.
	`size
() > 512,

303 ià(
ex³ù_»¥Ú£
 || 
ex³ù_¢oİ_»¥
) {

304 
	`as£¹
(
rou‹To
.
	`fšd
(
pkt
->
»q
è=ğrou‹To.
	`’d
());

305 
rou‹To
[
pkt
->
»q
] = 
¦ave_pÜt_id
;

307 
	`·nic_if
(
rou‹To
.
	`size
() > 512,

312 
»qLay”s
[
ma¡”_pÜt_id
]->
	`sucûededTimšg
(
·ck‘FšishTime
);

316 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

317 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

318 
ŒªsDi¡
[
pkt_cmd
]++;

320 ià(
is_ex´ess_¢oİ
) {

321 
¢oİs
++;

322 
¢oİT¿ffic
 +ğ
pkt_size
;

326 ià(
sšk_·ck‘
)

328 
³ndšgD–‘e
.
	`»£t
(
pkt
);

330 ià(
»¥Úd_dœeùly
) {

331 
	`as£¹
(
pkt
->
	`ÃedsRe¥Ú£
());

332 
	`as£¹
(
sucûss
);

334 
pkt
->
	`makeRe¥Ú£
();

336 ià(
¢oİF‹r
 && !
sy¡em
->
	`by·ssCaches
()) {

338 
¢oİF‹r
->
	`upd©eRe¥Ú£
(
pkt
, *
¦avePÜts
[
¦ave_pÜt_id
]);

341 
Tick
 
»¥Ú£_time
 = 
	`şockEdge
(è+ 
pkt
->
h—d”D–ay
;

342 
pkt
->
h—d”D–ay
 = 0;

344 
¦avePÜts
[
¦ave_pÜt_id
]->
	`schedTimšgRe¥
(
pkt
, 
»¥Ú£_time
);

347  
sucûss
;

348 
	}
}

350 
boŞ


351 
	gCoh”’tXB¬
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
)

354 
Ma¡”PÜt
 *
¤c_pÜt
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
];

357 cÚ¡‡utØ
rou‹_lookup
 = 
rou‹To
.
	`fšd
(
pkt
->
»q
);

358 
	`as£¹
(
rou‹_lookup
 !ğ
rou‹To
.
	`’d
());

359 cÚ¡ 
PÜtID
 
¦ave_pÜt_id
 = 
rou‹_lookup
->
£cÚd
;

360 
	`as£¹
(
¦ave_pÜt_id
 !ğ
Inv®idPÜtID
);

361 
	`as£¹
(
¦ave_pÜt_id
 < 
»¥Lay”s
.
	`size
());

365 ià(!
»¥Lay”s
[
¦ave_pÜt_id
]->
	`ŒyTimšg
(
¤c_pÜt
)) {

366 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingResp: src %s %s 0x%x BUSY\n",

367 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

368  
çl£
;

371 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingResp: src %s %s 0x%x\n",

372 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

376 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

377 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

380 
Tick
 
xb¬_d–ay
 = 
»¥Ú£L©’cy
 * 
	`şockP”iod
();

383 
	`ÿlcPack‘Timšg
(
pkt
, 
xb¬_d–ay
);

386 
Tick
 
·ck‘FšishTime
 = 
	`şockEdge
(
	`Cyşes
(1)è+ 
pkt
->
·ylßdD–ay
;

388 ià(
¢oİF‹r
 && !
sy¡em
->
	`by·ssCaches
()) {

390 
¢oİF‹r
->
	`upd©eRe¥Ú£
(
pkt
, *
¦avePÜts
[
¦ave_pÜt_id
]);

395 
Tick
 
Ï‹ncy
 = 
pkt
->
h—d”D–ay
;

396 
pkt
->
h—d”D–ay
 = 0;

397 
¦avePÜts
[
¦ave_pÜt_id
]->
	`schedTimšgRe¥
(
pkt
, 
	`curTick
(è+ 
Ï‹ncy
);

400 
rou‹To
.
	`”a£
(
rou‹_lookup
);

402 
»¥Lay”s
[
¦ave_pÜt_id
]->
	`sucûededTimšg
(
·ck‘FšishTime
);

405 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

406 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

407 
ŒªsDi¡
[
pkt_cmd
]++;

409  
Œue
;

410 
	}
}

413 
	gCoh”’tXB¬
::
	$»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
)

415 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingSnoopReq: src %s %s 0x%x\n",

416 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),

417 
pkt
->
	`g‘Addr
());

420 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

421 
ŒªsDi¡
[
pkt
->
	`cmdToIndex
()]++;

422 
¢oİs
++;

423 
¢oİT¿ffic
 +ğ
pkt_size
;

426 
	`as£¹
(
pkt
->
	`isEx´essSnoİ
());

430 
	`ÿlcPack‘Timšg
(
pkt
, 
fÜw¬dL©’cy
 * 
	`şockP”iod
());

434 cÚ¡ 
boŞ
 
ÿche_»¥Údšg
 = 
pkt
->
	`ÿcheRe¥Údšg
();

436 
	`as£¹
(
pkt
->
¢oİD–ay
 == 0);

438 ià(
¢oİF‹r
) {

440 autØ
sf_»s
 = 
¢oİF‹r
->
	`lookupSnoİ
(
pkt
);

444 
pkt
->
h—d”D–ay
 +ğ
sf_»s
.
£cÚd
 * 
	`şockP”iod
();

445 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingSnoopReq: src %s %s 0x%x"\

446 " SF size: %˜Ït: %i\n", 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`Çme
(),

447 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(), 
sf_»s
.
fœ¡
.
	`size
(),

448 
sf_»s
.
£cÚd
);

451 
	`fÜw¬dTimšg
(
pkt
, 
Inv®idPÜtID
, 
sf_»s
.
fœ¡
);

453 
	`fÜw¬dTimšg
(
pkt
, 
Inv®idPÜtID
);

457 
pkt
->
h—d”D–ay
 +ğpkt->
¢oİD–ay
;

458 
pkt
->
¢oİD–ay
 = 0;

461 ià(!
ÿche_»¥Údšg
 && 
pkt
->
	`ÿcheRe¥Údšg
()) {

462 
	`as£¹
(
rou‹To
.
	`fšd
(
pkt
->
»q
è=ğrou‹To.
	`’d
());

463 
rou‹To
[
pkt
->
»q
] = 
ma¡”_pÜt_id
;

471 
	`as£¹
(
ma¡”_pÜt_id
 =ğ
	`fšdPÜt
(
pkt
->
	`g‘Addr
()));

472 
	}
}

474 
boŞ


475 
	gCoh”’tXB¬
::
	$»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
)

478 
SÏvePÜt
* 
¤c_pÜt
 = 
¦avePÜts
[
¦ave_pÜt_id
];

481 cÚ¡‡utØ
rou‹_lookup
 = 
rou‹To
.
	`fšd
(
pkt
->
»q
);

482 
	`as£¹
(
rou‹_lookup
 !ğ
rou‹To
.
	`’d
());

483 cÚ¡ 
PÜtID
 
de¡_pÜt_id
 = 
rou‹_lookup
->
£cÚd
;

484 
	`as£¹
(
de¡_pÜt_id
 !ğ
Inv®idPÜtID
);

490 cÚ¡ 
boŞ
 
fÜw¬dAsSnoİ
 = 
out¡ªdšgSnoİ
.
	`fšd
(
pkt
->
»q
) ==

491 
out¡ªdšgSnoİ
.
	`’d
();

497 ià(
fÜw¬dAsSnoİ
) {

498 
	`as£¹
(
de¡_pÜt_id
 < 
¢oİLay”s
.
	`size
());

499 ià(!
¢oİLay”s
[
de¡_pÜt_id
]->
	`ŒyTimšg
(
¤c_pÜt
)) {

500 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingSnoopResp: src %s %s 0x%x BUSY\n",

501 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

502  
çl£
;

506 
Ma¡”PÜt
* 
¢oİ_pÜt
 = 
¢oİRe¥PÜts
[
¦ave_pÜt_id
];

507 
	`as£¹
(
de¡_pÜt_id
 < 
»¥Lay”s
.
	`size
());

508 ià(!
»¥Lay”s
[
de¡_pÜt_id
]->
	`ŒyTimšg
(
¢oİ_pÜt
)) {

509 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingSnoopResp: src %s %s 0x%x BUSY\n",

510 
¢oİ_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

511  
çl£
;

515 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingSnoopResp: src %s %s 0x%x\n",

516 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

520 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

521 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

524 
	`as£¹
(!
pkt
->
	`isEx´essSnoİ
());

528 
Tick
 
xb¬_d–ay
 =

529 (
fÜw¬dAsSnoİ
 ? 
¢oİRe¥Ú£L©’cy
 : 
»¥Ú£L©’cy
) *

530 
	`şockP”iod
();

533 
	`ÿlcPack‘Timšg
(
pkt
, 
xb¬_d–ay
);

536 
Tick
 
·ck‘FšishTime
 = 
	`şockEdge
(
	`Cyşes
(1)è+ 
pkt
->
·ylßdD–ay
;

539 ià(
fÜw¬dAsSnoİ
) {

544 ià(
¢oİF‹r
) {

546 
¢oİF‹r
->
	`upd©eSnoİFÜw¬d
(
pkt
, *
¦avePÜts
[
¦ave_pÜt_id
],

547 *
ma¡”PÜts
[
de¡_pÜt_id
]);

550 
boŞ
 
sucûss
 
M5_VAR_USED
 =

551 
ma¡”PÜts
[
de¡_pÜt_id
]->
	`£ndTimšgSnoİRe¥
(
pkt
);

552 
pktCouÁ
[
¦ave_pÜt_id
][
de¡_pÜt_id
]++;

553 
pktSize
[
¦ave_pÜt_id
][
de¡_pÜt_id
] +ğ
pkt_size
;

554 
	`as£¹
(
sucûss
);

556 
¢oİLay”s
[
de¡_pÜt_id
]->
	`sucûededTimšg
(
·ck‘FšishTime
);

562 
out¡ªdšgSnoİ
.
	`”a£
(
pkt
->
»q
);

567 
	`as£¹
(
¦ave_pÜt_id
 !ğ
de¡_pÜt_id
);

569 ià(
¢oİF‹r
) {

571 
¢oİF‹r
->
	`upd©eSnoİRe¥Ú£
(
pkt
, *
¦avePÜts
[
¦ave_pÜt_id
],

572 *
¦avePÜts
[
de¡_pÜt_id
]);

575 
	`DPRINTF
(
Coh”’tXB¬
, "recvTimingSnoopResp: src %s %s 0x%x"\

576 " FWD RESP\n", 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),

577 
pkt
->
	`g‘Addr
());

582 
Tick
 
Ï‹ncy
 = 
pkt
->
h—d”D–ay
;

583 
pkt
->
h—d”D–ay
 = 0;

584 
¦avePÜts
[
de¡_pÜt_id
]->
	`schedTimšgRe¥
(
pkt
, 
	`curTick
(è+ 
Ï‹ncy
);

586 
»¥Lay”s
[
de¡_pÜt_id
]->
	`sucûededTimšg
(
·ck‘FšishTime
);

590 
rou‹To
.
	`”a£
(
rou‹_lookup
);

593 
ŒªsDi¡
[
pkt_cmd
]++;

594 
¢oİs
++;

595 
¢oİT¿ffic
 +ğ
pkt_size
;

597  
Œue
;

598 
	}
}

602 
	gCoh”’tXB¬
::
fÜw¬dTimšg
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
exşude_¦ave_pÜt_id
,

603 cÚ¡ 
¡d
::
veùÜ
<
QueuedSÏvePÜt
*>& 
de¡s
)

605 
DPRINTF
(
Coh”’tXB¬
, "% fÜ % add»s %x siz%d\n", 
__func__
,

606 
pkt
->
cmdSŒšg
(),…kt->
g‘Addr
(),…kt->
g‘Size
());

609 
as£¹
(!
sy¡em
->
by·ssCaches
());

611 
	gçnout
 = 0;

613 cÚ¡‡uto& 
	gp
: 
de¡s
) {

618 ià(
exşude_¦ave_pÜt_id
 =ğ
Inv®idPÜtID
 ||

619 
p
->
g‘Id
(è!ğ
exşude_¦ave_pÜt_id
) {

621 
p
->
£ndTimšgSnoİReq
(
pkt
);

622 
	gçnout
++;

627 
	g¢oİFªout
.
§m¶e
(
çnout
);

631 
	gCoh”’tXB¬
::
	$»cvReqR‘ry
(
PÜtID
 
ma¡”_pÜt_id
)

636 
»qLay”s
[
ma¡”_pÜt_id
]->
	`»cvR‘ry
();

637 
	}
}

639 
Tick


640 
	gCoh”’tXB¬
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
)

642 
	`DPRINTF
(
Coh”’tXB¬
, "recvAtomic:…acket src %s‡ddr 0x%x cmd %s\n",

643 
¦avePÜts
[
¦ave_pÜt_id
]->
	`Çme
(), 
pkt
->
	`g‘Addr
(),

644 
pkt
->
	`cmdSŒšg
());

646 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

647 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

649 
MemCmd
 
¢oİ_»¥Ú£_cmd
 = MemCmd::
Inv®idCmd
;

650 
Tick
 
¢oİ_»¥Ú£_Ï‹ncy
 = 0;

652 ià(!
sy¡em
->
	`by·ssCaches
()) {

654 
¡d
::
·œ
<
MemCmd
, 
Tick
> 
¢oİ_»suÉ
;

655 ià(
¢oİF‹r
) {

657 autØ
sf_»s
 =

658 
¢oİF‹r
->
	`lookupReque¡
(
pkt
, *
¦avePÜts
[
¦ave_pÜt_id
]);

659 
¢oİ_»¥Ú£_Ï‹ncy
 +ğ
sf_»s
.
£cÚd
 * 
	`şockP”iod
();

660 
	`DPRINTF
(
Coh”’tXB¬
, "%s: src %s %s 0x%x"\

661 " SF size: %˜Ït: %i\n", 
__func__
,

662 
¦avePÜts
[
¦ave_pÜt_id
]->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),

663 
pkt
->
	`g‘Addr
(), 
sf_»s
.
fœ¡
.
	`size
(), sf_»s.
£cÚd
);

669 
¢oİF‹r
->
	`fšishReque¡
(
çl£
, 
pkt
->
	`g‘Addr
(),…kt->
	`isSecu»
());

671 
¢oİ_»suÉ
 = 
	`fÜw¬dAtomic
(
pkt
, 
¦ave_pÜt_id
, 
Inv®idPÜtID
,

672 
sf_»s
.
fœ¡
);

674 
¢oİ_»suÉ
 = 
	`fÜw¬dAtomic
(
pkt
, 
¦ave_pÜt_id
);

676 
¢oİ_»¥Ú£_cmd
 = 
¢oİ_»suÉ
.
fœ¡
;

677 
¢oİ_»¥Ú£_Ï‹ncy
 +ğ
¢oİ_»suÉ
.
£cÚd
;

681 
Tick
 
»¥Ú£_Ï‹ncy
 = 0;

683 cÚ¡ 
boŞ
 
sšk_·ck‘
 = 
	`sškPack‘
(
pkt
);

687 
PÜtID
 
ma¡”_pÜt_id
 = 
	`fšdPÜt
(
pkt
->
	`g‘Addr
());

689 ià(
sšk_·ck‘
) {

690 
	`DPRINTF
(
Coh”’tXB¬
, "Not forwarding %so %#llx\n",

691 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

693 ià(!
poštOfCoh”’cy
 || 
pkt
->
	`isR—d
(è||…kt->
	`isWr™e
()) {

695 
»¥Ú£_Ï‹ncy
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`£ndAtomic
(
pkt
);

698 
	`as£¹
(
pkt
->
	`ÃedsRe¥Ú£
());

700 
pkt
->
	`makeRe¥Ú£
();

705 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

706 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

707 
ŒªsDi¡
[
pkt_cmd
]++;

711 ià(!
sy¡em
->
	`by·ssCaches
(è&& 
¢oİF‹r
 && 
pkt
->
	`isRe¥Ú£
()) {

712 
¢oİF‹r
->
	`upd©eRe¥Ú£
(
pkt
, *
¦avePÜts
[
¦ave_pÜt_id
]);

716 ià(
¢oİ_»¥Ú£_cmd
 !ğ
MemCmd
::
Inv®idCmd
) {

718 
	`as£¹
(!
pkt
->
	`isRe¥Ú£
());

719 
pkt
->
cmd
 = 
¢oİ_»¥Ú£_cmd
;

720 
»¥Ú£_Ï‹ncy
 = 
¢oİ_»¥Ú£_Ï‹ncy
;

724 ià(
pkt
->
	`isRe¥Ú£
()) {

725 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

726 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

729 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

730 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

731 
ŒªsDi¡
[
pkt_cmd
]++;

735 
pkt
->
·ylßdD–ay
 = 
»¥Ú£_Ï‹ncy
;

736  
»¥Ú£_Ï‹ncy
;

737 
	}
}

739 
Tick


740 
	gCoh”’tXB¬
::
	$»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
)

742 
	`DPRINTF
(
Coh”’tXB¬
, "recvAtomicSnoop:…acket src %s‡ddr 0x%x cmd %s\n",

743 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`Çme
(), 
pkt
->
	`g‘Addr
(),

744 
pkt
->
	`cmdSŒšg
());

747 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

748 
¢oİs
++;

749 
¢oİT¿ffic
 +ğ
pkt_size
;

752 
¡d
::
·œ
<
MemCmd
, 
Tick
> 
¢oİ_»suÉ
;

753 
Tick
 
¢oİ_»¥Ú£_Ï‹ncy
 = 0;

754 ià(
¢oİF‹r
) {

755 autØ
sf_»s
 = 
¢oİF‹r
->
	`lookupSnoİ
(
pkt
);

756 
¢oİ_»¥Ú£_Ï‹ncy
 +ğ
sf_»s
.
£cÚd
 * 
	`şockP”iod
();

757 
	`DPRINTF
(
Coh”’tXB¬
, "%s: src %s %s 0x%x SF size: %i†at: %i\n",

758 
__func__
, 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),

759 
pkt
->
	`g‘Addr
(), 
sf_»s
.
fœ¡
.
	`size
(), sf_»s.
£cÚd
);

760 
¢oİ_»suÉ
 = 
	`fÜw¬dAtomic
(
pkt
, 
Inv®idPÜtID
, 
ma¡”_pÜt_id
,

761 
sf_»s
.
fœ¡
);

763 
¢oİ_»suÉ
 = 
	`fÜw¬dAtomic
(
pkt
, 
Inv®idPÜtID
);

765 
MemCmd
 
¢oİ_»¥Ú£_cmd
 = 
¢oİ_»suÉ
.
fœ¡
;

766 
¢oİ_»¥Ú£_Ï‹ncy
 +ğ
¢oİ_»suÉ
.
£cÚd
;

768 ià(
¢oİ_»¥Ú£_cmd
 !ğ
MemCmd
::
Inv®idCmd
)

769 
pkt
->
cmd
 = 
¢oİ_»¥Ú£_cmd
;

772 ià(
pkt
->
	`isRe¥Ú£
()) {

773 
¢oİs
++;

777 
pkt
->
·ylßdD–ay
 = 
¢oİ_»¥Ú£_Ï‹ncy
;

778  
¢oİ_»¥Ú£_Ï‹ncy
;

779 
	}
}

781 
	g¡d
::
·œ
<
MemCmd
, 
	gTick
>

782 
	gCoh”’tXB¬
::
fÜw¬dAtomic
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
exşude_¦ave_pÜt_id
,

783 
PÜtID
 
sourû_ma¡”_pÜt_id
,

784 cÚ¡ 
¡d
::
veùÜ
<
QueuedSÏvePÜt
*>& 
de¡s
)

789 
MemCmd
 
Üig_cmd
 = 
pkt
->
cmd
;

790 
MemCmd
 
	g¢oİ_»¥Ú£_cmd
 = MemCmd::
Inv®idCmd
;

791 
Tick
 
	g¢oİ_»¥Ú£_Ï‹ncy
 = 0;

794 
as£¹
(!
sy¡em
->
by·ssCaches
());

796 
	gçnout
 = 0;

798 cÚ¡‡uto& 
	gp
: 
de¡s
) {

803 ià(
exşude_¦ave_pÜt_id
 !ğ
Inv®idPÜtID
 &&

804 
p
->
g‘Id
(è=ğ
exşude_¦ave_pÜt_id
)

807 
Tick
 
	gÏ‹ncy
 = 
p
->
£ndAtomicSnoİ
(
pkt
);

808 
	gçnout
++;

813 ià(!
	gpkt
->
isRe¥Ú£
())

817 
as£¹
(
pkt
->
cmd
 !ğ
Üig_cmd
);

818 
as£¹
(
pkt
->
ÿcheRe¥Údšg
());

820 
as£¹
(
¢oİ_»¥Ú£_cmd
 =ğ
MemCmd
::
Inv®idCmd
);

822 
	g¢oİ_»¥Ú£_cmd
 = 
pkt
->
cmd
;

823 
	g¢oİ_»¥Ú£_Ï‹ncy
 = 
Ï‹ncy
;

825 ià(
	g¢oİF‹r
) {

828 ià(
	gsourû_ma¡”_pÜt_id
 !ğ
Inv®idPÜtID
) {

830 
as£¹
(
exşude_¦ave_pÜt_id
 =ğ
Inv®idPÜtID
);

831 
	g¢oİF‹r
->
upd©eSnoİFÜw¬d
(
pkt
, *
p
,

832 *
ma¡”PÜts
[
sourû_ma¡”_pÜt_id
]);

835 
as£¹
(
sourû_ma¡”_pÜt_id
 =ğ
Inv®idPÜtID
);

836 
	g¢oİF‹r
->
upd©eSnoİRe¥Ú£
(
pkt
, *
p
,

837 *
¦avePÜts
[
exşude_¦ave_pÜt_id
]);

841 
	gpkt
->
	gcmd
 = 
Üig_cmd
;

845 
	g¢oİFªout
.
§m¶e
(
çnout
);

849  
	g¡d
::
make_·œ
(
¢oİ_»¥Ú£_cmd
, 
¢oİ_»¥Ú£_Ï‹ncy
);

853 
	gCoh”’tXB¬
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
)

855 ià(!
pkt
->
	`isPršt
()) {

857 
	`DPRINTF
(
Coh”’tXB¬
,

859 
¦avePÜts
[
¦ave_pÜt_id
]->
	`Çme
(), 
pkt
->
	`g‘Addr
(),

860 
pkt
->
	`cmdSŒšg
());

863 ià(!
sy¡em
->
	`by·ssCaches
()) {

865 
	`fÜw¬dFunùiÚ®
(
pkt
, 
¦ave_pÜt_id
);

870 ià(!
pkt
->
	`isRe¥Ú£
()) {

872 cÚ¡‡uto& 
p
 : 
¦avePÜts
) {

876 ià(
p
->
	`checkFunùiÚ®
(
pkt
)) {

877 ià(
pkt
->
	`ÃedsRe¥Ú£
())

878 
pkt
->
	`makeRe¥Ú£
();

883 
PÜtID
 
de¡_id
 = 
	`fšdPÜt
(
pkt
->
	`g‘Addr
());

885 
ma¡”PÜts
[
de¡_id
]->
	`£ndFunùiÚ®
(
pkt
);

887 
	}
}

890 
	gCoh”’tXB¬
::
	$»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
)

892 ià(!
pkt
->
	`isPršt
()) {

894 
	`DPRINTF
(
Coh”’tXB¬
,

896 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`Çme
(), 
pkt
->
	`g‘Addr
(),

897 
pkt
->
	`cmdSŒšg
());

900 cÚ¡‡uto& 
p
 : 
¦avePÜts
) {

901 ià(
p
->
	`checkFunùiÚ®
(
pkt
)) {

902 ià(
pkt
->
	`ÃedsRe¥Ú£
())

903 
pkt
->
	`makeRe¥Ú£
();

909 
	`fÜw¬dFunùiÚ®
(
pkt
, 
Inv®idPÜtID
);

910 
	}
}

913 
	gCoh”’tXB¬
::
	$fÜw¬dFunùiÚ®
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
exşude_¦ave_pÜt_id
)

916 
	`as£¹
(!
sy¡em
->
	`by·ssCaches
());

918 cÚ¡‡uto& 
p
: 
¢oİPÜts
) {

923 ià(
exşude_¦ave_pÜt_id
 =ğ
Inv®idPÜtID
 ||

924 
p
->
	`g‘Id
(è!ğ
exşude_¦ave_pÜt_id
)

925 
p
->
	`£ndFunùiÚ®Snoİ
(
pkt
);

928 ià(
pkt
->
	`isRe¥Ú£
()) {

932 
	}
}

934 
boŞ


935 
	gCoh”’tXB¬
::
	$sškPack‘
(cÚ¡ 
Pack‘PŒ
 
pkt
) const

950  (
poštOfCoh”’cy
 && 
pkt
->
	`ÿcheRe¥Údšg
()) ||

951 (
poštOfCoh”’cy
 && !(
pkt
->
	`isR—d
(è||…kt->
	`isWr™e
()) &&

952 !
pkt
->
	`ÃedsRe¥Ú£
()) ||

953 (
pkt
->
	`isCËªEviùiÚ
(è&&…kt->
	`isBlockCached
()) ||

954 (
pkt
->
	`ÿcheRe¥Údšg
() &&

955 (!
pkt
->
	`ÃedsWr™abË
(è||…kt->
	`»¥Úd”HadWr™abË
()));

956 
	}
}

959 
	gCoh”’tXB¬
::
	$»gSts
()

962 
Ba£XB¬
::
	`»gSts
();

963 autØ
l
: 
»qLay”s
)

964 
l
->
	`»gSts
();

965 autØ
l
: 
»¥Lay”s
)

966 
l
->
	`»gSts
();

967 autØ
l
: 
¢oİLay”s
)

968 
l
->
	`»gSts
();

970 
¢oİs


971 .
	`Çme
(name() + ".snoops")

972 .
	`desc
("Total snoops (count)")

975 
¢oİT¿ffic


976 .
	`Çme
(name() + ".snoopTraffic")

977 .
	`desc
("Total snoopraffic (bytes)")

980 
¢oİFªout


981 .
	`š™
(0, 
¢oİPÜts
.
	`size
(), 1)

982 .
	`Çme
(name() + ".snoop_fanout")

983 .
	`desc
("Request fanout histogram")

985 
	}
}

987 
Coh”’tXB¬
 *

988 
	gCoh”’tXB¬P¬ams
::
	$ü—‹
()

990  
Ãw
 
	`Coh”’tXB¬
(
this
);

991 
	}
}

	@coherent_xbar.hh

51 #iâdeà
__MEM_COHERENT_XBAR_HH__


52 
	#__MEM_COHERENT_XBAR_HH__


	)

54 
	~"mem/¢oİ_f‹r.hh
"

55 
	~"mem/xb¬.hh
"

56 
	~"·¿ms/Coh”’tXB¬.hh
"

69 şas 
	cCoh”’tXB¬
 : 
public
 
Ba£XB¬


72 
´Ùeùed
:

78 
¡d
::
veùÜ
<
ReqLay”
*> 
»qLay”s
;

79 
	m¡d
::
veùÜ
<
Re¥Lay”
*> 
»¥Lay”s
;

80 
	m¡d
::
veùÜ
<
SnoİRe¥Lay”
*> 
¢oİLay”s
;

87 şas 
	cCoh”’tXB¬SÏvePÜt
 : 
public
 
QueuedSÏvePÜt


90 
´iv©e
:

93 
Coh”’tXB¬
 &
xb¬
;

96 
Re¥Pack‘Queue
 
	mqueue
;

98 
	mpublic
:

100 
Coh”’tXB¬SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

101 
Coh”’tXB¬
 &
_xb¬
, 
PÜtID
 
_id
)

102 : 
QueuedSÏvePÜt
(
_Çme
, &
_xb¬
, 
queue
, 
_id
), 
xb¬
(_xbar),

103 
queue
(
_xb¬
, *
this
)

106 
	m´Ùeùed
:

111 
vœtu®
 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

112 {  
xb¬
.
»cvTimšgReq
(
pkt
, 
id
); }

117 
vœtu®
 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

118 {  
	mxb¬
.
»cvTimšgSnoİRe¥
(
pkt
, 
id
); }

123 
vœtu®
 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
)

124 {  
	mxb¬
.
»cvAtomic
(
pkt
, 
id
); }

129 
vœtu®
 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

130 { 
	mxb¬
.
»cvFunùiÚ®
(
pkt
, 
id
); }

135 
vœtu®
 
AddrRªgeLi¡
 
g‘AddrRªges
() const

136 {  
	mxb¬
.
g‘AddrRªges
(); }

145 şas 
	cCoh”’tXB¬Ma¡”PÜt
 : 
public
 
Ma¡”PÜt


147 
´iv©e
:

149 
Coh”’tXB¬
 &
xb¬
;

151 
	gpublic
:

153 
Coh”’tXB¬Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

154 
Coh”’tXB¬
 &
_xb¬
, 
PÜtID
 
_id
)

155 : 
Ma¡”PÜt
(
_Çme
, &
_xb¬
, 
_id
), 
xb¬
(_xbar)

158 
	g´Ùeùed
:

166 
vœtu®
 
boŞ
 
isSnoİšg
() const

167 {  
Œue
; }

172 
vœtu®
 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

173 {  
	gxb¬
.
»cvTimšgRe¥
(
pkt
, 
id
); }

178 
vœtu®
 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

179 {  
	gxb¬
.
»cvTimšgSnoİReq
(
pkt
, 
id
); }

184 
vœtu®
 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

185 {  
	gxb¬
.
»cvAtomicSnoİ
(
pkt
, 
id
); }

190 
vœtu®
 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

191 { 
	gxb¬
.
»cvFunùiÚ®Snoİ
(
pkt
, 
id
); }

195 
vœtu®
 
»cvRªgeChªge
()

196 { 
	gxb¬
.
»cvRªgeChªge
(
id
); }

200 
vœtu®
 
»cvReqR‘ry
()

201 { 
	gxb¬
.
»cvReqR‘ry
(
id
); }

210 şas 
	cSnoİRe¥PÜt
 : 
public
 
Ma¡”PÜt


213 
´iv©e
:

216 
QueuedSÏvePÜt
& 
¦avePÜt
;

218 
	gpublic
:

223 
SnoİRe¥PÜt
(
QueuedSÏvePÜt
& 
¦ave_pÜt
, 
Coh”’tXB¬
& 
_xb¬
) :

224 
Ma¡”PÜt
(
¦ave_pÜt
.
Çme
(è+ ".¢oİRe¥PÜt", &
_xb¬
),

225 
¦avePÜt
(
¦ave_pÜt
) { }

231 
£ndR‘ryRe¥
() {

233 
	g¦avePÜt
.
£ndR‘rySnoİRe¥
();

239 
»cvReqR‘ry
(è{ 
·nic
("SnoopRespPort should‚ever see„etry\n"); }

244 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

246 
·nic
("SnoopRespPort should‚ever seeiming„esponse\n");

247  
	gçl£
;

252 
	g¡d
::
veùÜ
<
SnoİRe¥PÜt
*> 
¢oİRe¥PÜts
;

254 
	g¡d
::
veùÜ
<
QueuedSÏvePÜt
*> 
¢oİPÜts
;

261 
	g¡d
::
unÜd”ed_£t
<
Reque¡PŒ
> 
out¡ªdšgSnoİ
;

267 
Sy¡em
 *
	gsy¡em
;

271 
SnoİF‹r
 *
	g¢oİF‹r
;

274 cÚ¡ 
Cyşes
 
	g¢oİRe¥Ú£L©’cy
;

277 cÚ¡ 
boŞ
 
	gpoštOfCoh”’cy
;

283 
	g¡d
::
unique_±r
<
Pack‘
> 
³ndšgD–‘e
;

287 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
);

291 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
);

295 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
);

299 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
);

303 
»cvReqR‘ry
(
PÜtID
 
ma¡”_pÜt_id
);

313 
	$fÜw¬dTimšg
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
exşude_¦ave_pÜt_id
) {

314 
	`fÜw¬dTimšg
(
pkt
, 
exşude_¦ave_pÜt_id
, 
¢oİPÜts
);

315 
	}
}

326 
fÜw¬dTimšg
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
exşude_¦ave_pÜt_id
,

327 cÚ¡ 
¡d
::
veùÜ
<
QueuedSÏvePÜt
*>& 
de¡s
);

331 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
);

335 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
);

347 
	g¡d
::
·œ
<
MemCmd
, 
	gTick
> 
	$fÜw¬dAtomic
(
Pack‘PŒ
 
pkt
,

348 
PÜtID
 
exşude_¦ave_pÜt_id
)

350  
	`fÜw¬dAtomic
(
pkt
, 
exşude_¦ave_pÜt_id
, 
Inv®idPÜtID
,

351 
¢oİPÜts
);

352 
	}
}

366 
	g¡d
::
·œ
<
MemCmd
, 
	gTick
> 
fÜw¬dAtomic
(
Pack‘PŒ
 
pkt
,

367 
PÜtID
 
exşude_¦ave_pÜt_id
,

368 
PÜtID
 
sourû_ma¡”_pÜt_id
,

369 cÚ¡ 
¡d
::
veùÜ
<
QueuedSÏvePÜt
*>&

370 
de¡s
);

374 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
);

378 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
);

388 
fÜw¬dFunùiÚ®
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
exşude_¦ave_pÜt_id
);

394 
boŞ
 
	$sškPack‘
(cÚ¡ 
Pack‘PŒ
 
pkt
) const;

396 
Sts
::
SÿÏr
 
¢oİs
;

397 
Sts
::
SÿÏr
 
¢oİT¿ffic
;

398 
Sts
::
Di¡ributiÚ
 
¢oİFªout
;

400 
public
:

402 
vœtu®
 
	`š™
();

404 
	`Coh”’tXB¬
(cÚ¡ 
Coh”’tXB¬P¬ams
 *
p
);

406 
vœtu®
 ~
	`Coh”’tXB¬
();

408 
vœtu®
 
	`»gSts
();

409 
	}
};

	@comm_monitor.cc

41 
	~"ba£/Œaû.hh
"

42 
	~"debug/CommMÚ™Ü.hh
"

43 
	~"mem/comm_mÚ™Ü.hh
"

44 
	~"sim/¡©s.hh
"

46 
	gCommMÚ™Ü
::
	$CommMÚ™Ü
(
P¬ams
* 
·¿ms
)

47 : 
	`MemObjeù
(
·¿ms
),

48 
	`ma¡”PÜt
(
	`Çme
(è+ "-ma¡”", *
this
),

49 
	`¦avePÜt
(
	`Çme
(è+ "-¦ave", *
this
),

50 
	`§m¶eP”iodicEv’t
(
this
),

51 
	`§m¶eP”iodTicks
(
·¿ms
->
§m¶e_³riod
),

52 
	`§m¶eP”iod
(
·¿ms
->
§m¶e_³riod
 / 
SimClock
::
Flßt
::
s
),

53 
	`»adAddrMask
(
·¿ms
->
»ad_addr_mask
),

54 
	`wr™eAddrMask
(
·¿ms
->
wr™e_addr_mask
),

55 
	$¡©s
(
·¿ms
)

57 
	`DPRINTF
(
CommMÚ™Ü
,

59 
	`Çme
(), 
§m¶eP”iodTicks
, 
§m¶eP”iod
 * 1E3);

60 
	}
}

62 
CommMÚ™Ü
*

63 
	gCommMÚ™ÜP¬ams
::
	$ü—‹
()

65  
Ãw
 
	`CommMÚ™Ü
(
this
);

66 
	}
}

69 
	gCommMÚ™Ü
::
	$š™
()

72 ià(!
¦avePÜt
.
	`isCÚÃùed
(è|| !
ma¡”PÜt
.isConnected())

73 
	`çl
("Communication monitor is‚ot connected on both sides.\n");

74 
	}
}

77 
	gCommMÚ™Ü
::
	$»gProbePošts
()

79 
µPktReq
.
	`»£t
(
Ãw
 
ProbePošts
::
	`Pack‘
(
	`g‘ProbeMªag”
(), "PktRequest"));

80 
µPktRe¥
.
	`»£t
(
Ãw
 
ProbePošts
::
	`Pack‘
(
	`g‘ProbeMªag”
(), "PktResponse"));

81 
	}
}

83 
	gBa£Ma¡”PÜt
&

84 
	gCommMÚ™Ü
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
, 
PÜtID
 
idx
)

86 ià(
if_Çme
 == "master") {

87  
ma¡”PÜt
;

89  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

91 
	}
}

93 
	gBa£SÏvePÜt
&

94 
	gCommMÚ™Ü
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
, 
PÜtID
 
idx
)

96 ià(
if_Çme
 == "slave") {

97  
¦avePÜt
;

99  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

101 
	}
}

104 
	gCommMÚ™Ü
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

106 
ma¡”PÜt
.
	`£ndFunùiÚ®
(
pkt
);

107 
	}
}

110 
	gCommMÚ™Ü
::
	$»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

112 
¦avePÜt
.
	`£ndFunùiÚ®Snoİ
(
pkt
);

113 
	}
}

115 
Tick


116 
	gCommMÚ™Ü
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

118 
ProbePošts
::
Pack‘Info
 
	`»q_pkt_šfo
(
pkt
);

119 
µPktReq
->
	`nÙify
(
»q_pkt_šfo
);

121 cÚ¡ 
Tick
 
	`d–ay
(
ma¡”PÜt
.
	`£ndAtomic
(
pkt
));

122 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

123 
ProbePošts
::
Pack‘Info
 
	`»¥_pkt_šfo
(
pkt
);

124 
µPktRe¥
->
	`nÙify
(
»¥_pkt_šfo
);

125  
d–ay
;

126 
	}
}

128 
Tick


129 
	gCommMÚ™Ü
::
	$»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

131  
¦avePÜt
.
	`£ndAtomicSnoİ
(
pkt
);

132 
	}
}

134 
boŞ


135 
	gCommMÚ™Ü
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

138 
	`as£¹
(
pkt
->
	`isReque¡
());

142 cÚ¡ 
ProbePošts
::
Pack‘Info
 
	`pkt_šfo
(
pkt
);

144 cÚ¡ 
boŞ
 
is_»ad
 = 
pkt
->
	`isR—d
();

145 cÚ¡ 
boŞ
 
is_wr™e
 = 
pkt
->
	`isWr™e
();

146 cÚ¡ 
boŞ
 
	`ex³ùs_»¥Ú£
(

147 
pkt
->
	`ÃedsRe¥Ú£
(è&& !pkt->
	`ÿcheRe¥Údšg
());

153 ià(
ex³ùs_»¥Ú£
 && !
¡©s
.
di§bËL©’cyHi¡s
) {

154 
pkt
->
	`pushS’d”S‹
(
Ãw
 
	`CommMÚ™ÜS’d”S‹
(
	`curTick
()));

158 
boŞ
 
sucûssful
 = 
ma¡”PÜt
.
	`£ndTimšgReq
(
pkt
);

161 ià(!
sucûssful
 && 
ex³ùs_»¥Ú£
 && !
¡©s
.
di§bËL©’cyHi¡s
) {

162 
d–‘e
 
pkt
->
	`pİS’d”S‹
();

165 ià(
sucûssful
) {

166 
µPktReq
->
	`nÙify
(
pkt_šfo
);

169 ià(
sucûssful
 && 
is_»ad
) {

170 
	`DPRINTF
(
CommMÚ™Ü
, "Forwarded„ead„equest\n");

173 ià(!
¡©s
.
di§bËT¿n§ùiÚHi¡s
) {

174 ++
¡©s
.
»adT¿ns
;

178 ià(!
¡©s
.
di§bËBur¡L’gthHi¡s
) {

179 
¡©s
.
»adBur¡L’gthHi¡
.
	`§m¶e
(
pkt_šfo
.
size
);

183 ià(!
¡©s
.
di§bËAddrDi¡s
) {

184 
¡©s
.
»adAddrDi¡
.
	`§m¶e
(
pkt_šfo
.
addr
 & 
»adAddrMask
);

189 ià(!
¡©s
.
di§bËOut¡ªdšgHi¡s
 && 
ex³ùs_»¥Ú£
) {

190 ++
¡©s
.
out¡ªdšgR—dReqs
;

193 ià(!
¡©s
.
di§bËITTDi¡s
) {

195 ià(
¡©s
.
timeOfLa¡R—d
 != 0) {

196 
¡©s
.
™tR—dR—d
.
	`§m¶e
(
	`curTick
(è- sts.
timeOfLa¡R—d
);

198 
¡©s
.
timeOfLa¡R—d
 = 
	`curTick
();

201 ià(
¡©s
.
timeOfLa¡Req
 != 0) {

202 
¡©s
.
™tReqReq
.
	`§m¶e
(
	`curTick
(è- sts.
timeOfLa¡Req
);

204 
¡©s
.
timeOfLa¡Req
 = 
	`curTick
();

206 } ià(
sucûssful
 && 
is_wr™e
) {

207 
	`DPRINTF
(
CommMÚ™Ü
, "Forwarded write„equest\n");

210 ià(!
¡©s
.
di§bËT¿n§ùiÚHi¡s
) {

211 ++
¡©s
.
wr™eT¿ns
;

214 ià(!
¡©s
.
di§bËBur¡L’gthHi¡s
) {

215 
¡©s
.
wr™eBur¡L’gthHi¡
.
	`§m¶e
(
pkt_šfo
.
size
);

219 ià(!
¡©s
.
di§bËBªdwidthHi¡s
) {

220 
¡©s
.
wr™‹nBy‹s
 +ğ
pkt_šfo
.
size
;

221 
¡©s
.
tÙ®Wr™‹nBy‹s
 +ğ
pkt_šfo
.
size
;

225 ià(!
¡©s
.
di§bËAddrDi¡s
) {

226 
¡©s
.
wr™eAddrDi¡
.
	`§m¶e
(
pkt_šfo
.
addr
 & 
wr™eAddrMask
);

229 ià(!
¡©s
.
di§bËOut¡ªdšgHi¡s
 && 
ex³ùs_»¥Ú£
) {

230 ++
¡©s
.
out¡ªdšgWr™eReqs
;

233 ià(!
¡©s
.
di§bËITTDi¡s
) {

235 ià(
¡©s
.
timeOfLa¡Wr™e
 != 0) {

236 
¡©s
.
™tWr™eWr™e
.
	`§m¶e
(
	`curTick
(è- sts.
timeOfLa¡Wr™e
);

238 
¡©s
.
timeOfLa¡Wr™e
 = 
	`curTick
();

241 ià(
¡©s
.
timeOfLa¡Req
 != 0) {

242 
¡©s
.
™tReqReq
.
	`§m¶e
(
	`curTick
(è- sts.
timeOfLa¡Req
);

244 
¡©s
.
timeOfLa¡Req
 = 
	`curTick
();

246 } ià(
sucûssful
) {

247 
	`DPRINTF
(
CommMÚ™Ü
, "Forwarded‚on„ead/write„equest\n");

250  
sucûssful
;

251 
	}
}

253 
boŞ


254 
	gCommMÚ™Ü
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

257 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

261 cÚ¡ 
ProbePošts
::
Pack‘Info
 
	`pkt_šfo
(
pkt
);

263 
boŞ
 
is_»ad
 = 
pkt
->
	`isR—d
();

264 
boŞ
 
is_wr™e
 = 
pkt
->
	`isWr™e
();

265 
Tick
 
Ï‹ncy
 = 0;

266 
CommMÚ™ÜS’d”S‹
* 
»ûived_¡©e
 =

267 
dyÇmic_ÿ¡
<
CommMÚ™ÜS’d”S‹
*>(
pkt
->
£nd”S‹
);

269 ià(!
¡©s
.
di§bËL©’cyHi¡s
) {

271 ià(
»ûived_¡©e
 =ğ
NULL
)

272 
	`·nic
("Monitor got‡„esponse without monitor sender state\n");

275 
pkt
->
£nd”S‹
 = 
»ûived_¡©e
->
´edeûssÜ
;

279 
boŞ
 
sucûssful
 = 
¦avePÜt
.
	`£ndTimšgRe¥
(
pkt
);

281 ià(!
¡©s
.
di§bËL©’cyHi¡s
) {

284 ià(
sucûssful
) {

285 
Ï‹ncy
 = 
	`curTick
(è- 
»ûived_¡©e
->
Œªsm™Time
;

286 
	`DPRINTF
(
CommMÚ™Ü
, "L©’cy: %d\n", 
Ï‹ncy
);

287 
d–‘e
 
»ûived_¡©e
;

291 
pkt
->
£nd”S‹
 = 
»ûived_¡©e
;

295 ià(
sucûssful
) {

296 
µPktRe¥
->
	`nÙify
(
pkt_šfo
);

299 ià(
sucûssful
 && 
is_»ad
) {

301 
	`DPRINTF
(
CommMÚ™Ü
, "Received„ead„esponse\n");

302 ià(!
¡©s
.
di§bËOut¡ªdšgHi¡s
) {

303 
	`as£¹
(
¡©s
.
out¡ªdšgR—dReqs
 != 0);

304 --
¡©s
.
out¡ªdšgR—dReqs
;

307 ià(!
¡©s
.
di§bËL©’cyHi¡s
) {

308 
¡©s
.
»adL©’cyHi¡
.
	`§m¶e
(
Ï‹ncy
);

312 ià(!
¡©s
.
di§bËBªdwidthHi¡s
) {

313 
¡©s
.
»adBy‹s
 +ğ
pkt_šfo
.
size
;

314 
¡©s
.
tÙ®R—dBy‹s
 +ğ
pkt_šfo
.
size
;

317 } ià(
sucûssful
 && 
is_wr™e
) {

319 
	`DPRINTF
(
CommMÚ™Ü
, "Received write„esponse\n");

320 ià(!
¡©s
.
di§bËOut¡ªdšgHi¡s
) {

321 
	`as£¹
(
¡©s
.
out¡ªdšgWr™eReqs
 != 0);

322 --
¡©s
.
out¡ªdšgWr™eReqs
;

325 ià(!
¡©s
.
di§bËL©’cyHi¡s
) {

326 
¡©s
.
wr™eL©’cyHi¡
.
	`§m¶e
(
Ï‹ncy
);

328 } ià(
sucûssful
) {

329 
	`DPRINTF
(
CommMÚ™Ü
, "Received‚on„ead/write„esponse\n");

331  
sucûssful
;

332 
	}
}

335 
	gCommMÚ™Ü
::
	$»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

337 
¦avePÜt
.
	`£ndTimšgSnoİReq
(
pkt
);

338 
	}
}

340 
boŞ


341 
	gCommMÚ™Ü
::
	$»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

343  
ma¡”PÜt
.
	`£ndTimšgSnoİRe¥
(
pkt
);

344 
	}
}

347 
	gCommMÚ™Ü
::
	$»cvR‘rySnoİRe¥
()

349 
¦avePÜt
.
	`£ndR‘rySnoİRe¥
();

350 
	}
}

352 
boŞ


353 
	gCommMÚ™Ü
::
	$isSnoİšg
() const

356  
¦avePÜt
.
	`isSnoİšg
();

357 
	}
}

359 
AddrRªgeLi¡


360 
	gCommMÚ™Ü
::
	$g‘AddrRªges
() const

363  
ma¡”PÜt
.
	`g‘AddrRªges
();

364 
	}
}

367 
	gCommMÚ™Ü
::
	$»cvReqR‘ry
()

369 
¦avePÜt
.
	`£ndR‘ryReq
();

370 
	}
}

373 
	gCommMÚ™Ü
::
	$»cvRe¥R‘ry
()

375 
ma¡”PÜt
.
	`£ndR‘ryRe¥
();

376 
	}
}

379 
	gCommMÚ™Ü
::
	$»cvRªgeChªge
()

381 
¦avePÜt
.
	`£ndRªgeChªge
();

382 
	}
}

385 
	gCommMÚ™Ü
::
	$»gSts
()

387 
MemObjeù
::
	`»gSts
();

390 
usšg
 
Çme¥aû
 
Sts
;

392 
¡©s
.
»adBur¡L’gthHi¡


393 .
	`š™
(
	`·¿ms
()->
bur¡_Ëngth_bšs
)

394 .
	`Çme
(name() + ".readBurstLengthHist")

395 .
	`desc
("Histogram of burst†engths ofransmitted…ackets")

396 .
	`æags
(
¡©s
.
di§bËBur¡L’gthHi¡s
 ? 
noz”o
 : 
pdf
);

398 
¡©s
.
wr™eBur¡L’gthHi¡


399 .
	`š™
(
	`·¿ms
()->
bur¡_Ëngth_bšs
)

400 .
	`Çme
(name() + ".writeBurstLengthHist")

401 .
	`desc
("Histogram of burst†engths ofransmitted…ackets")

402 .
	`æags
(
¡©s
.
di§bËBur¡L’gthHi¡s
 ? 
noz”o
 : 
pdf
);

405 
¡©s
.
»adBªdwidthHi¡


406 .
	`š™
(
	`·¿ms
()->
bªdwidth_bšs
)

407 .
	`Çme
(name() + ".readBandwidthHist")

408 .
	`desc
("Histogram of„ead bandwidth…er sample…eriod (bytes/s)")

409 .
	`æags
(
¡©s
.
di§bËBªdwidthHi¡s
 ? 
noz”o
 : 
pdf
);

411 
¡©s
.
av”ageR—dBW


412 .
	`Çme
(name() + ".averageReadBandwidth")

413 .
	`desc
("Average„ead bandwidth (bytes/s)")

414 .
	`æags
(
¡©s
.
di§bËBªdwidthHi¡s
 ? 
noz”o
 : 
pdf
);

416 
¡©s
.
tÙ®R—dBy‹s


417 .
	`Çme
(name() + ".totalReadBytes")

418 .
	`desc
("Number of bytes„ead")

419 .
	`æags
(
¡©s
.
di§bËBªdwidthHi¡s
 ? 
noz”o
 : 
pdf
);

421 
¡©s
.
av”ageR—dBW
 = sts.
tÙ®R—dBy‹s
 / 
simSecÚds
;

424 
¡©s
.
wr™eBªdwidthHi¡


425 .
	`š™
(
	`·¿ms
()->
bªdwidth_bšs
)

426 .
	`Çme
(name() + ".writeBandwidthHist")

427 .
	`desc
("Histogram of write bandwidth (bytes/s)")

428 .
	`æags
(
¡©s
.
di§bËBªdwidthHi¡s
 ? (
pdf
 | 
noz”o
) :…df);

430 
¡©s
.
av”ageWr™eBW


431 .
	`Çme
(name() + ".averageWriteBandwidth")

432 .
	`desc
("Average write bandwidth (bytes/s)")

433 .
	`æags
(
¡©s
.
di§bËBªdwidthHi¡s
 ? 
noz”o
 : 
pdf
);

435 
¡©s
.
tÙ®Wr™‹nBy‹s


436 .
	`Çme
(name() + ".totalWrittenBytes")

437 .
	`desc
("Number of bytes written")

438 .
	`æags
(
¡©s
.
di§bËBªdwidthHi¡s
 ? 
noz”o
 : 
pdf
);

440 
¡©s
.
av”ageWr™eBW
 = sts.
tÙ®Wr™‹nBy‹s
 / 
simSecÚds
;

442 
¡©s
.
»adL©’cyHi¡


443 .
	`š™
(
	`·¿ms
()->
Ï‹ncy_bšs
)

444 .
	`Çme
(name() + ".readLatencyHist")

445 .
	`desc
("Read„equest-response†atency")

446 .
	`æags
(
¡©s
.
di§bËL©’cyHi¡s
 ? 
noz”o
 : 
pdf
);

448 
¡©s
.
wr™eL©’cyHi¡


449 .
	`š™
(
	`·¿ms
()->
Ï‹ncy_bšs
)

450 .
	`Çme
(name() + ".writeLatencyHist")

451 .
	`desc
("Write„equest-response†atency")

452 .
	`æags
(
¡©s
.
di§bËL©’cyHi¡s
 ? 
noz”o
 : 
pdf
);

454 
¡©s
.
™tR—dR—d


455 .
	`š™
(1, 
	`·¿ms
()->
™t_max_bš
,…arams()->itt_max_bin /

456 
	`·¿ms
()->
™t_bšs
)

457 .
	`Çme
(name() + ".ittReadRead")

458 .
	`desc
("Read-to-read interransactionime")

459 .
	`æags
(
¡©s
.
di§bËITTDi¡s
 ? 
noz”o
 : 
pdf
);

461 
¡©s
.
™tWr™eWr™e


462 .
	`š™
(1, 
	`·¿ms
()->
™t_max_bš
,…arams()->itt_max_bin /

463 
	`·¿ms
()->
™t_bšs
)

464 .
	`Çme
(name() + ".ittWriteWrite")

465 .
	`desc
("Write-to-write interransactionime")

466 .
	`æags
(
¡©s
.
di§bËITTDi¡s
 ? 
noz”o
 : 
pdf
);

468 
¡©s
.
™tReqReq


469 .
	`š™
(1, 
	`·¿ms
()->
™t_max_bš
,…arams()->itt_max_bin /

470 
	`·¿ms
()->
™t_bšs
)

471 .
	`Çme
(name() + ".ittReqReq")

472 .
	`desc
("Request-to-request interransactionime")

473 .
	`æags
(
¡©s
.
di§bËITTDi¡s
 ? 
noz”o
 : 
pdf
);

475 
¡©s
.
out¡ªdšgR—dsHi¡


476 .
	`š™
(
	`·¿ms
()->
out¡ªdšg_bšs
)

477 .
	`Çme
(name() + ".outstandingReadsHist")

478 .
	`desc
("Outstanding„eadransactions")

479 .
	`æags
(
¡©s
.
di§bËOut¡ªdšgHi¡s
 ? 
noz”o
 : 
pdf
);

481 
¡©s
.
out¡ªdšgWr™esHi¡


482 .
	`š™
(
	`·¿ms
()->
out¡ªdšg_bšs
)

483 .
	`Çme
(name() + ".outstandingWritesHist")

484 .
	`desc
("Outstanding writeransactions")

485 .
	`æags
(
¡©s
.
di§bËOut¡ªdšgHi¡s
 ? 
noz”o
 : 
pdf
);

487 
¡©s
.
»adT¿nsHi¡


488 .
	`š™
(
	`·¿ms
()->
Œª§ùiÚ_bšs
)

489 .
	`Çme
(name() + ".readTransHist")

490 .
	`desc
("Histogram of„eadransactions…er sample…eriod")

491 .
	`æags
(
¡©s
.
di§bËT¿n§ùiÚHi¡s
 ? 
noz”o
 : 
pdf
);

493 
¡©s
.
wr™eT¿nsHi¡


494 .
	`š™
(
	`·¿ms
()->
Œª§ùiÚ_bšs
)

495 .
	`Çme
(name() + ".writeTransHist")

496 .
	`desc
("Histogram of„eadransactions…er sample…eriod")

497 .
	`æags
(
¡©s
.
di§bËT¿n§ùiÚHi¡s
 ? 
noz”o
 : 
pdf
);

499 
¡©s
.
»adAddrDi¡


500 .
	`š™
(0)

501 .
	`Çme
(name() + ".readAddrDist")

502 .
	`desc
("Read‡ddress distribution")

503 .
	`æags
(
¡©s
.
di§bËAddrDi¡s
 ? 
noz”o
 : 
pdf
);

505 
¡©s
.
wr™eAddrDi¡


506 .
	`š™
(0)

507 .
	`Çme
(name() + ".writeAddrDist")

508 .
	`desc
("Write‡ddress distribution")

509 .
	`æags
(
¡©s
.
di§bËAddrDi¡s
 ? 
noz”o
 : 
pdf
);

510 
	}
}

513 
	gCommMÚ™Ü
::
	$§m¶eP”iodic
()

523 ià(
simTicks
.
	`v®ue
(è>ğ
§m¶eP”iodTicks
) {

524 ià(!
¡©s
.
di§bËT¿n§ùiÚHi¡s
) {

525 
¡©s
.
»adT¿nsHi¡
.
	`§m¶e
(¡©s.
»adT¿ns
);

526 
¡©s
.
wr™eT¿nsHi¡
.
	`§m¶e
(¡©s.
wr™eT¿ns
);

529 ià(!
¡©s
.
di§bËBªdwidthHi¡s
) {

530 
¡©s
.
»adBªdwidthHi¡
.
	`§m¶e
(¡©s.
»adBy‹s
 / 
§m¶eP”iod
);

531 
¡©s
.
wr™eBªdwidthHi¡
.
	`§m¶e
(¡©s.
wr™‹nBy‹s
 / 
§m¶eP”iod
);

534 ià(!
¡©s
.
di§bËOut¡ªdšgHi¡s
) {

535 
¡©s
.
out¡ªdšgR—dsHi¡
.
	`§m¶e
(¡©s.
out¡ªdšgR—dReqs
);

536 
¡©s
.
out¡ªdšgWr™esHi¡
.
	`§m¶e
(¡©s.
out¡ªdšgWr™eReqs
);

541 
¡©s
.
»adT¿ns
 = 0;

542 
¡©s
.
wr™eT¿ns
 = 0;

544 
¡©s
.
»adBy‹s
 = 0;

545 
¡©s
.
wr™‹nBy‹s
 = 0;

547 
	`scheduË
(
§m¶eP”iodicEv’t
, 
	`curTick
(è+ 
§m¶eP”iodTicks
);

548 
	}
}

551 
	gCommMÚ™Ü
::
	$¡¬tup
()

553 
	`scheduË
(
§m¶eP”iodicEv’t
, 
	`curTick
(è+ 
§m¶eP”iodTicks
);

554 
	}
}

	@comm_monitor.hh

41 #iâdeà
__MEM_COMM_MONITOR_HH__


42 
	#__MEM_COMM_MONITOR_HH__


	)

44 
	~"ba£/¡©i¡ics.hh
"

45 
	~"mem/mem_objeù.hh
"

46 
	~"·¿ms/CommMÚ™Ü.hh
"

47 
	~"sim/´obe/mem.hh
"

60 şas 
	cCommMÚ™Ü
 : 
public
 
MemObjeù


63 
public
:

66 
CommMÚ™ÜP¬ams
 
	tP¬ams
;

67 cÚ¡ 
P¬ams
* 
	$·¿ms
() const

68 {  
»š‹½»t_ÿ¡
<cÚ¡ 
P¬ams
*>(
_·¿ms
); }

75 
	`CommMÚ™Ü
(
P¬ams
* 
·¿ms
);

77 
	$š™
(è
ov”ride
;

78 
	$»gSts
(è
ov”ride
;

79 
	$¡¬tup
(è
ov”ride
;

80 
	$»gProbePošts
(è
ov”ride
;

82 
public
:

83 
Ba£Ma¡”PÜt
& 
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

84 
PÜtID
 
idx
 = 
Inv®idPÜtID
è
ov”ride
;

86 
Ba£SÏvePÜt
& 
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

87 
PÜtID
 
idx
 = 
Inv®idPÜtID
è
ov”ride
;

89 
´iv©e
:

95 şas 
	cCommMÚ™ÜS’d”S‹
 : 
public
 
Pack‘
::
S’d”S‹


98 
public
:

106 
	`CommMÚ™ÜS’d”S‹
(
Tick
 
_Œªsm™Time
)

107 : 
	`Œªsm™Time
(
_Œªsm™Time
)

111 ~
	`CommMÚ™ÜS’d”S‹
() { }

114 
Tick
 
Œªsm™Time
;

116 
	}
};

124 şas 
	cMÚ™ÜMa¡”PÜt
 : 
public
 
Ma¡”PÜt


127 
public
:

129 
MÚ™ÜMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
CommMÚ™Ü
& 
_mÚ
)

130 : 
Ma¡”PÜt
(
_Çme
, &
_mÚ
), 
mÚ
(_mon)

133 
	g´Ùeùed
:

135 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

137 
mÚ
.
»cvFunùiÚ®Snoİ
(
pkt
);

140 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

142  
	gmÚ
.
»cvAtomicSnoİ
(
pkt
);

145 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

147  
	gmÚ
.
»cvTimšgRe¥
(
pkt
);

150 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

152 
	gmÚ
.
»cvTimšgSnoİReq
(
pkt
);

155 
»cvRªgeChªge
()

157 
	gmÚ
.
»cvRªgeChªge
();

160 
boŞ
 
isSnoİšg
() const

162  
	gmÚ
.
isSnoİšg
();

165 
»cvReqR‘ry
()

167 
	gmÚ
.
»cvReqR‘ry
();

170 
»cvR‘rySnoİRe¥
()

172 
	gmÚ
.
»cvR‘rySnoİRe¥
();

175 
	g´iv©e
:

177 
CommMÚ™Ü
& 
mÚ
;

182 
MÚ™ÜMa¡”PÜt
 
	gma¡”PÜt
;

190 şas 
	cMÚ™ÜSÏvePÜt
 : 
public
 
SÏvePÜt


193 
public
:

195 
MÚ™ÜSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
CommMÚ™Ü
& 
_mÚ
)

196 : 
SÏvePÜt
(
_Çme
, &
_mÚ
), 
mÚ
(_mon)

199 
	g´Ùeùed
:

201 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

203 
mÚ
.
»cvFunùiÚ®
(
pkt
);

206 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
)

208  
	gmÚ
.
»cvAtomic
(
pkt
);

211 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

213  
	gmÚ
.
»cvTimšgReq
(
pkt
);

216 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

218  
	gmÚ
.
»cvTimšgSnoİRe¥
(
pkt
);

221 
AddrRªgeLi¡
 
g‘AddrRªges
() const

223  
	gmÚ
.
g‘AddrRªges
();

226 
»cvRe¥R‘ry
()

228 
	gmÚ
.
»cvRe¥R‘ry
();

231 
	g´iv©e
:

233 
CommMÚ™Ü
& 
mÚ
;

238 
MÚ™ÜSÏvePÜt
 
	g¦avePÜt
;

240 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

242 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
);

244 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

246 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
);

248 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

250 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

252 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
);

254 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
);

256 
»cvR‘rySnoİRe¥
();

258 
AddrRªgeLi¡
 
	$g‘AddrRªges
() const;

260 
boŞ
 
	$isSnoİšg
() const;

262 
	`»cvReqR‘ry
();

264 
	`»cvRe¥R‘ry
();

266 
	`»cvRªgeChªge
();

269 
	sMÚ™ÜSts


273 
boŞ
 
di§bËBur¡L’gthHi¡s
;

276 
Sts
::
Hi¡og¿m
 
»adBur¡L’gthHi¡
;

279 
Sts
::
Hi¡og¿m
 
wr™eBur¡L’gthHi¡
;

282 
boŞ
 
di§bËBªdwidthHi¡s
;

288 
»adBy‹s
;

289 
Sts
::
Hi¡og¿m
 
»adBªdwidthHi¡
;

290 
Sts
::
FÜmuÏ
 
av”ageR—dBW
;

291 
Sts
::
SÿÏr
 
tÙ®R—dBy‹s
;

297 
wr™‹nBy‹s
;

298 
Sts
::
Hi¡og¿m
 
wr™eBªdwidthHi¡
;

299 
Sts
::
FÜmuÏ
 
av”ageWr™eBW
;

300 
Sts
::
SÿÏr
 
tÙ®Wr™‹nBy‹s
;

303 
boŞ
 
di§bËL©’cyHi¡s
;

306 
Sts
::
Hi¡og¿m
 
»adL©’cyHi¡
;

309 
Sts
::
Hi¡og¿m
 
wr™eL©’cyHi¡
;

312 
boŞ
 
di§bËITTDi¡s
;

320 
Sts
::
Di¡ributiÚ
 
™tR—dR—d
;

321 
Sts
::
Di¡ributiÚ
 
™tWr™eWr™e
;

322 
Sts
::
Di¡ributiÚ
 
™tReqReq
;

323 
Tick
 
timeOfLa¡R—d
;

324 
Tick
 
timeOfLa¡Wr™e
;

325 
Tick
 
timeOfLa¡Req
;

328 
boŞ
 
di§bËOut¡ªdšgHi¡s
;

335 
Sts
::
Hi¡og¿m
 
out¡ªdšgR—dsHi¡
;

336 
out¡ªdšgR—dReqs
;

343 
Sts
::
Hi¡og¿m
 
out¡ªdšgWr™esHi¡
;

344 
out¡ªdšgWr™eReqs
;

347 
boŞ
 
di§bËT¿n§ùiÚHi¡s
;

350 
Sts
::
Hi¡og¿m
 
»adT¿nsHi¡
;

351 
»adT¿ns
;

354 
Sts
::
Hi¡og¿m
 
wr™eT¿nsHi¡
;

355 
wr™eT¿ns
;

358 
boŞ
 
di§bËAddrDi¡s
;

364 
Sts
::
S·r£Hi¡og¿m
 
»adAddrDi¡
;

370 
Sts
::
S·r£Hi¡og¿m
 
wr™eAddrDi¡
;

377 
	`MÚ™ÜSts
(cÚ¡ 
CommMÚ™ÜP¬ams
* 
·¿ms
) :

378 
	`di§bËBur¡L’gthHi¡s
(
·¿ms
->
di§bË_bur¡_Ëngth_hi¡s
),

379 
	`di§bËBªdwidthHi¡s
(
·¿ms
->
di§bË_bªdwidth_hi¡s
),

380 
	`»adBy‹s
(0), 
	`wr™‹nBy‹s
(0),

381 
	`di§bËL©’cyHi¡s
(
·¿ms
->
di§bË_Ï‹ncy_hi¡s
),

382 
	`di§bËITTDi¡s
(
·¿ms
->
di§bË_™t_di¡s
),

383 
	`timeOfLa¡R—d
(0), 
	`timeOfLa¡Wr™e
(0), 
	`timeOfLa¡Req
(0),

384 
	`di§bËOut¡ªdšgHi¡s
(
·¿ms
->
di§bË_out¡ªdšg_hi¡s
),

385 
	`out¡ªdšgR—dReqs
(0), 
	`out¡ªdšgWr™eReqs
(0),

386 
	`di§bËT¿n§ùiÚHi¡s
(
·¿ms
->
di§bË_Œª§ùiÚ_hi¡s
),

387 
	`»adT¿ns
(0), 
	`wr™eT¿ns
(0),

388 
	`di§bËAddrDi¡s
(
·¿ms
->
di§bË_addr_di¡s
)

391 
	}
};

394 
§m¶eP”iodic
();

397 
	gEv’tW¿µ”
<
	gCommMÚ™Ü
, &CommMÚ™Ü::
§m¶eP”iodic
> 
§m¶eP”iodicEv’t
;

405 cÚ¡ 
Tick
 
	g§m¶eP”iodTicks
;

407 cÚ¡ 
	g§m¶eP”iod
;

410 cÚ¡ 
Addr
 
	g»adAddrMask
;

413 cÚ¡ 
Addr
 
	gwr™eAddrMask
;

418 
MÚ™ÜSts
 
	g¡©s
;

420 
	g´Ùeùed
:

427 
ProbePošts
::
Pack‘UPŒ
 
µPktReq
;

430 
	gProbePošts
::
Pack‘UPŒ
 
µPktRe¥
;

	@dram_ctrl.cc

47 
	~"ba£/b™f›ld.hh
"

48 
	~"ba£/Œaû.hh
"

49 
	~"debug/DRAM.hh
"

50 
	~"debug/DRAMPow”.hh
"

51 
	~"debug/DRAMS‹.hh
"

52 
	~"debug/D¿š.hh
"

53 
	~"mem/d¿m_ù¾.hh
"

54 
	~"sim/sy¡em.hh
"

56 
usšg
 
Çme¥aû
 
	g¡d
;

57 
usšg
 
Çme¥aû
 
	gD©a
;

59 
	gDRAMCŒl
::
	$DRAMCŒl
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
) :

60 
	`Ab¡¿ùMemÜy
(
p
),

61 
	`pÜt
(
	`Çme
(è+ ".pÜt", *
this
), 
	`isTimšgMode
(
çl£
),

62 
	`»ŒyRdReq
(
çl£
), 
	`»ŒyWrReq
(false),

63 
	`busS‹
(
READ
),

64 
	`busS‹Next
(
READ
),

65 
	`ÃxtReqEv’t
(
this
), 
	`»¥ÚdEv’t
(this),

66 
	`deviûSize
(
p
->
deviû_size
),

67 
	`deviûBusWidth
(
p
->
deviû_bus_width
), 
	`bur¡L’gth
Õ->
bur¡_Ëngth
),

68 
	`deviûRowBufãrSize
(
p
->
deviû_rowbufãr_size
),

69 
	`deviûsP”Rªk
(
p
->
deviûs_³r_¿nk
),

70 
	`bur¡Size
((
deviûsP”Rªk
 * 
bur¡L’gth
 * 
deviûBusWidth
) / 8),

71 
	`rowBufãrSize
(
deviûsP”Rªk
 * 
deviûRowBufãrSize
),

72 
	`cŞumnsP”RowBufãr
(
rowBufãrSize
 / 
bur¡Size
),

73 
	`cŞumnsP”SŒe
(
¿nge
.
	`š‹¾—ved
(è?„ªge.
	`g¿nuÏr™y
(è/ 
bur¡Size
 : 1),

74 
	`¿nksP”ChªÃl
(
p
->
¿nks_³r_chªÃl
),

75 
	`bªkGroupsP”Rªk
(
p
->
bªk_groups_³r_¿nk
),

76 
	`bªkGroupArch
(
p
->
bªk_groups_³r_¿nk
 > 0),

77 
	`bªksP”Rªk
(
p
->
bªks_³r_¿nk
), 
	`chªÃls
Õ->
chªÃls
), 
	`rowsP”Bªk
(0),

78 
	`»adBufãrSize
(
p
->
»ad_bufãr_size
),

79 
	`wr™eBufãrSize
(
p
->
wr™e_bufãr_size
),

80 
	`wr™eHighTh»shŞd
(
wr™eBufãrSize
 * 
p
->
wr™e_high_th»sh_³rc
 / 100.0),

81 
	`wr™eLowTh»shŞd
(
wr™eBufãrSize
 * 
p
->
wr™e_low_th»sh_³rc
 / 100.0),

82 
	`mšWr™esP”Sw™ch
(
p
->
mš_wr™es_³r_sw™ch
),

83 
	`wr™esThisTime
(0), 
	`»adsThisTime
(0),

84 
	`tCK
(
p
->
tCK
), 
	`tWTR
Õ->
tWTR
), 
	`tRTW
Õ->
tRTW
), 
	`tCS
Õ->
tCS
), 
	`tBURST
Õ->
tBURST
),

85 
	`tCCD_L
(
p
->
tCCD_L
), 
	`tRCD
Õ->
tRCD
), 
	`tCL
Õ->
tCL
), 
	`tRP
Õ->
tRP
), 
	`tRAS
Õ->
tRAS
),

86 
	`tWR
(
p
->
tWR
), 
	`tRTP
Õ->
tRTP
), 
	`tRFC
Õ->
tRFC
), 
	`tREFI
Õ->
tREFI
), 
	`tRRD
Õ->
tRRD
),

87 
	`tRRD_L
(
p
->
tRRD_L
), 
	`tXAW
Õ->
tXAW
), 
	`tXP
Õ->
tXP
), 
	`tXS
Õ->
tXS
),

88 
	`aùiv©iÚLim™
(
p
->
aùiv©iÚ_lim™
),

89 
	`memSchedPŞicy
(
p
->
mem_sched_pŞicy
), 
	`addrM­pšg
Õ->
addr_m­pšg
),

90 
	`·geMgmt
(
p
->
·ge_pŞicy
),

91 
	`maxAcûs£sP”Row
(
p
->
max_acûs£s_³r_row
),

92 
	`äÚ‹ndL©’cy
(
p
->
¡©ic_äÚ‹nd_Ï‹ncy
),

93 
	`back’dL©’cy
(
p
->
¡©ic_back’d_Ï‹ncy
),

94 
	`busBusyUÁ
(0), 
	`´evA¼iv®
(0),

95 
	`ÃxtReqTime
(0), 
	`aùiveRªk
(0), 
	$timeSmpOff£t
(0)

99 
	`çl_if
(!
	`isPow”Of2
(
¿nksP”ChªÃl
), "DRAM„ank count of %d is‚ot "

100 "®lowed, mu¡ b¨pow” oàtwo\n", 
¿nksP”ChªÃl
);

102 
	`çl_if
(!
	`isPow”Of2
(
bur¡Size
), "DRAM burst size %d is‚ot‡llowed, "

103 "mu¡ b¨pow” oàtwo\n", 
bur¡Size
);

105 
i
 = 0; i < 
¿nksP”ChªÃl
; i++) {

106 
Rªk
* 
¿nk
 = 
Ãw
 
	`Rªk
(*
this
, 
p
);

107 
¿nks
.
	`push_back
(
¿nk
);

109 
¿nk
->
aùTicks
.
	`»size
(
aùiv©iÚLim™
, 0);

110 
¿nk
->
bªks
.
	`»size
(
bªksP”Rªk
);

111 
¿nk
->¿nk = 
i
;

113 
b
 = 0; b < 
bªksP”Rªk
; b++) {

114 
¿nk
->
bªks
[
b
].
bªk
 = b;

118 ià(
bªkGroupArch
) {

126 
¿nk
->
bªks
[
b
].
bªkgr
 = b % 
bªkGroupsP”Rªk
;

129 
¿nk
->
bªks
[
b
].
bªkgr
 = b;

135 ià(
p
->
wr™e_low_th»sh_³rc
 >ğp->
wr™e_high_th»sh_³rc
)

136 
	`çl
("Write buffer†owhreshold %d must be smallerhanhe "

137 "highh»shŞd %d\n", 
p
->
wr™e_low_th»sh_³rc
,

138 
p
->
wr™e_high_th»sh_³rc
);

141 
ušt64_t
 
ÿ·c™y
 = 
	`ULL
(1è<< 
	`ûLog2
(
Ab¡¿ùMemÜy
::
	`size
());

144 
ušt64_t
 
deviûC­ac™y
 = 
deviûSize
 / (1024 * 1024è* 
deviûsP”Rªk
 *

145 
¿nksP”ChªÃl
;

148 ià(
deviûC­ac™y
 !ğ
ÿ·c™y
 / (1024 * 1024))

149 
	`w¬n
("DRAM device capacity (%d Mbytes) does‚ot matchhe "

150 "add»s ¿ngassigÃd (%d Mby‹s)\n", 
deviûC­ac™y
,

151 
ÿ·c™y
 / (1024 * 1024));

153 
	`DPRINTF
(
DRAM
, "MemÜy c­ac™y %Îd (%Îdèby‹s\n", 
ÿ·c™y
,

154 
Ab¡¿ùMemÜy
::
	`size
());

156 
	`DPRINTF
(
DRAM
, "Row buffer size %d bytes with %d columns…er„ow buffer\n",

157 
rowBufãrSize
, 
cŞumnsP”RowBufãr
);

159 
rowsP”Bªk
 = 
ÿ·c™y
 / (
rowBufãrSize
 * 
bªksP”Rªk
 * 
¿nksP”ChªÃl
);

162 ià(
tREFI
 <ğ
tRP
 ||REFI <ğ
tRFC
) {

163 
	`çl
("tREFI (%d) must be†argerhanRP (%d)‡ndRFC (%d)\n",

164 
tREFI
, 
tRP
, 
tRFC
);

168 ià(
bªkGroupArch
) {

170 ià(
bªkGroupsP”Rªk
 > 
bªksP”Rªk
) {

171 
	`çl
("banks…er„ank (%d) must beƒqualo or†argerhan "

173 
bªksP”Rªk
, 
bªkGroupsP”Rªk
);

176 ià((
bªksP”Rªk
 % 
bªkGroupsP”Rªk
) != 0) {

177 
	`çl
("Banks…er„ank (%d) must beƒvenly divisible by bank groups "

179 
bªksP”Rªk
, 
bªkGroupsP”Rªk
);

182 ià(
tCCD_L
 <ğ
tBURST
) {

183 
	`çl
("tCCD_L (%d) should be†argerhanBURST (%d) when "

185 
tCCD_L
, 
tBURST
, 
bªkGroupsP”Rªk
);

189 ià(
tRRD_L
 < 
tRRD
) {

190 
	`çl
("tRRD_L (%d) should be†argerhanRRD (%d) when "

192 
tRRD_L
, 
tRRD
, 
bªkGroupsP”Rªk
);

196 
	}
}

199 
	gDRAMCŒl
::
	$š™
()

201 
Ab¡¿ùMemÜy
::
	`š™
();

203 ià(!
pÜt
.
	`isCÚÃùed
()) {

204 
	`çl
("DRAMCŒÈ% i uncÚÃùed!\n", 
	`Çme
());

206 
pÜt
.
	`£ndRªgeChªge
();

211 ià(
¿nge
.
	`š‹¾—ved
()) {

212 ià(
chªÃls
 !ğ
¿nge
.
	`¡res
())

213 
	`çl
("%s has %d interleaved‡ddress stripes but %d channel(s)\n",

214 
	`Çme
(), 
¿nge
.
	`¡res
(), 
chªÃls
);

216 ià(
addrM­pšg
 =ğ
Enums
::
RoRaBaChCo
) {

217 ià(
rowBufãrSize
 !ğ
¿nge
.
	`g¿nuÏr™y
()) {

218 
	`çl
("Channel interleaving of %s doesn't match RoRaBaChCo "

219 "add»s m­\n", 
	`Çme
());

221 } ià(
addrM­pšg
 =ğ
Enums
::
RoRaBaCoCh
 ||

222 
addrM­pšg
 =ğ
Enums
::
RoCoRaBaCh
) {

230 
	`as£¹
(
cŞumnsP”SŒe
 >= 1);

234 ià(
	`sy¡em
()->
	`ÿcheLšeSize
(è> 
¿nge
.
	`g¿nuÏr™y
()) {

235 
	`çl
("Channel interleaving of %s must be‡t†east‡s†arge "

236 "a thÿchlšsize\n", 
	`Çme
());

240 ià(
rowBufãrSize
 < 
¿nge
.
	`g¿nuÏr™y
()) {

241 
	`çl
("Channel interleaving of %s must be‡t most‡s†arge "

242 "a throw-bufã¸size\n", 
	`Çme
());

245 
	`as£¹
(
cŞumnsP”SŒe
 <ğ
cŞumnsP”RowBufãr
);

248 
	}
}

251 
	gDRAMCŒl
::
	$¡¬tup
()

254 
isTimšgMode
 = 
	`sy¡em
()->
	`isTimšgMode
();

256 ià(
isTimšgMode
) {

258 
timeSmpOff£t
 = 
	`divCe
(
	`curTick
(), 
tCK
);

262 autØ
r
 : 
¿nks
) {

263 
r
->
	`¡¬tup
(
	`curTick
(è+ 
tREFI
 - 
tRP
);

270 
busBusyUÁ
 = 
	`curTick
(è+ 
tRP
 + 
tRCD
 + 
tCL
;

272 
	}
}

274 
Tick


275 
	gDRAMCŒl
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

277 
	`DPRINTF
(
DRAM
, "»cvAtomic: % 0x%x\n", 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

279 
	`·nic_if
(
pkt
->
	`ÿcheRe¥Údšg
(), "Should‚ot see…ackets where cache "

283 
	`acûss
(
pkt
);

285 
Tick
 
Ï‹ncy
 = 0;

286 ià(
pkt
->
	`hasD©a
()) {

289 
Ï‹ncy
 = 
tRP
 + 
tRCD
 + 
tCL
;

291  
Ï‹ncy
;

292 
	}
}

294 
boŞ


295 
	gDRAMCŒl
::
	$»adQueueFuÎ
(
ÃededEÁr›s
) const

297 
	`DPRINTF
(
DRAM
, "Read queue†imit %d, current size %d,ƒntries‚eeded %d\n",

298 
»adBufãrSize
, 
»adQueue
.
	`size
(è+ 
»¥Queue
.size(),

299 
ÃededEÁr›s
);

302 (
»adQueue
.
	`size
(è+ 
»¥Queue
.size(è+ 
ÃededEÁr›s
è> 
»adBufãrSize
;

303 
	}
}

305 
boŞ


306 
	gDRAMCŒl
::
	$wr™eQueueFuÎ
(
ÃededEÁr›s
) const

308 
	`DPRINTF
(
DRAM
, "Write queue†imit %d, current size %d,ƒntries‚eeded %d\n",

309 
wr™eBufãrSize
, 
wr™eQueue
.
	`size
(), 
ÃededEÁr›s
);

310  (
wr™eQueue
.
	`size
(è+ 
ÃededEÁr›s
è> 
wr™eBufãrSize
;

311 
	}
}

313 
	gDRAMCŒl
::
DRAMPack‘
*

314 
DRAMCŒl
::
	$decodeAddr
(
Pack‘PŒ
 
pkt
, 
Addr
 
d¿mPktAddr
, 
size
,

315 
boŞ
 
isR—d
)

320 
ušt8_t
 
¿nk
;

321 
ušt8_t
 
bªk
;

324 
ušt64_t
 
row
;

328 
Addr
 
addr
 = 
d¿mPktAddr
 / 
bur¡Size
;

332 ià(
addrM­pšg
 =ğ
Enums
::
RoRaBaChCo
) {

335 
addr
 =‡dd¸/ 
cŞumnsP”RowBufãr
;

338 
addr
 =‡dd¸/ 
chªÃls
;

342 
bªk
 = 
addr
 % 
bªksP”Rªk
;

343 
addr
 =‡dd¸/ 
bªksP”Rªk
;

347 
¿nk
 = 
addr
 % 
¿nksP”ChªÃl
;

348 
addr
 =‡dd¸/ 
¿nksP”ChªÃl
;

351 
row
 = 
addr
 % 
rowsP”Bªk
;

352 } ià(
addrM­pšg
 =ğ
Enums
::
RoRaBaCoCh
) {

354 
addr
 =‡dd¸/ 
cŞumnsP”SŒe
;

357 
addr
 =‡dd¸/ 
chªÃls
;

360 
addr
 =‡dd¸/ (
cŞumnsP”RowBufãr
 / 
cŞumnsP”SŒe
);

364 
bªk
 = 
addr
 % 
bªksP”Rªk
;

365 
addr
 =‡dd¸/ 
bªksP”Rªk
;

369 
¿nk
 = 
addr
 % 
¿nksP”ChªÃl
;

370 
addr
 =‡dd¸/ 
¿nksP”ChªÃl
;

373 
row
 = 
addr
 % 
rowsP”Bªk
;

374 } ià(
addrM­pšg
 =ğ
Enums
::
RoCoRaBaCh
) {

379 
addr
 =‡dd¸/ 
cŞumnsP”SŒe
;

384 
addr
 =‡dd¸/ 
chªÃls
;

388 
bªk
 = 
addr
 % 
bªksP”Rªk
;

389 
addr
 =‡dd¸/ 
bªksP”Rªk
;

392 
¿nk
 = 
addr
 % 
¿nksP”ChªÃl
;

393 
addr
 =‡dd¸/ 
¿nksP”ChªÃl
;

396 
addr
 =‡dd¸/ (
cŞumnsP”RowBufãr
 / 
cŞumnsP”SŒe
);

399 
row
 = 
addr
 % 
rowsP”Bªk
;

401 
	`·nic
("Unknown‡ddress mapping…olicy chosen!");

403 
	`as£¹
(
¿nk
 < 
¿nksP”ChªÃl
);

404 
	`as£¹
(
bªk
 < 
bªksP”Rªk
);

405 
	`as£¹
(
row
 < 
rowsP”Bªk
);

406 
	`as£¹
(
row
 < 
Bªk
::
NO_ROW
);

408 
	`DPRINTF
(
DRAM
, "Address: %lld Rank %d Bank %d Row %d\n",

409 
d¿mPktAddr
, 
¿nk
, 
bªk
, 
row
);

414 
ušt16_t
 
bªk_id
 = 
bªksP”Rªk
 * 
¿nk
 + 
bªk
;

415  
Ãw
 
	`DRAMPack‘
(
pkt
, 
isR—d
, 
¿nk
, 
bªk
, 
row
, 
bªk_id
, 
d¿mPktAddr
,

416 
size
, 
¿nks
[
¿nk
]->
bªks
[
bªk
], *ranks[rank]);

417 
	}
}

420 
	gDRAMCŒl
::
	$addToR—dQueue
(
Pack‘PŒ
 
pkt
, 
pktCouÁ
)

424 
	`as£¹
(!
pkt
->
	`isWr™e
());

426 
	`as£¹
(
pktCouÁ
 != 0);

434 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

435 
pktsS”viûdByWrQ
 = 0;

436 
Bur¡H–³r
* 
bur¡_h–³r
 = 
NULL
;

437 
út
 = 0; cÁ < 
pktCouÁ
; ++cnt) {

438 
size
 = 
¡d
::
	`mš
((
addr
 | (
bur¡Size
 - 1)) + 1,

439 
pkt
->
	`g‘Addr
(è+…kt->
	`g‘Size
()è- 
addr
;

440 
»adPktSize
[
	`ûLog2
(
size
)]++;

441 
»adBur¡s
++;

445 
boŞ
 
foundInWrQ
 = 
çl£
;

446 
Addr
 
bur¡_addr
 = 
	`bur¡Align
(
addr
);

449 ià(
isInWr™eQueue
.
	`fšd
(
bur¡_addr
è!ğisInWr™eQueue.
	`’d
()) {

450 cÚ¡‡uto& 
p
 : 
wr™eQueue
) {

453 ià(
p
->
addr
 <ğadd¸&& (add¸+ 
size
) <= (p->addr +…->size)) {

454 
foundInWrQ
 = 
Œue
;

455 
£rviûdByWrQ
++;

456 
pktsS”viûdByWrQ
++;

457 
	`DPRINTF
(
DRAM
, "Reado‡ddr %lld with size %d serviced by "

458 "wr™queue\n", 
addr
, 
size
);

459 
by‹sR—dWrQ
 +ğ
bur¡Size
;

467 ià(!
foundInWrQ
) {

470 ià(
pktCouÁ
 > 1 && 
bur¡_h–³r
 =ğ
NULL
) {

471 
	`DPRINTF
(
DRAM
, "Reado‡ddr %lldranslateso %d "

472 "d¿m„eque¡s\n", 
pkt
->
	`g‘Addr
(), 
pktCouÁ
);

473 
bur¡_h–³r
 = 
Ãw
 
	`Bur¡H–³r
(
pktCouÁ
);

476 
DRAMPack‘
* 
d¿m_pkt
 = 
	`decodeAddr
(
pkt
, 
addr
, 
size
, 
Œue
);

477 
d¿m_pkt
->
bur¡H–³r
 = 
bur¡_h–³r
;

479 
	`as£¹
(!
	`»adQueueFuÎ
(1));

480 
rdQL’Pdf
[
»adQueue
.
	`size
(è+ 
»¥Queue
.size()]++;

482 
	`DPRINTF
(
DRAM
, "Addingo„ead queue\n");

484 
»adQueue
.
	`push_back
(
d¿m_pkt
);

487 ++
d¿m_pkt
->
¿nkRef
.
»adEÁr›s
;

490 
avgRdQL’
 = 
»adQueue
.
	`size
(è+ 
»¥Queue
.size();

494 
addr
 = (add¸| (
bur¡Size
 - 1)) + 1;

498 ià(
pktsS”viûdByWrQ
 =ğ
pktCouÁ
) {

499 
	`acûssAndRe¥Úd
(
pkt
, 
äÚ‹ndL©’cy
);

504 ià(
bur¡_h–³r
 !ğ
NULL
)

505 
bur¡_h–³r
->
bur¡sS”viûd
 = 
pktsS”viûdByWrQ
;

509 ià(!
ÃxtReqEv’t
.
	`scheduËd
()) {

510 
	`DPRINTF
(
DRAM
, "Request scheduled immediately\n");

511 
	`scheduË
(
ÃxtReqEv’t
, 
	`curTick
());

513 
	}
}

516 
	gDRAMCŒl
::
	$addToWr™eQueue
(
Pack‘PŒ
 
pkt
, 
pktCouÁ
)

520 
	`as£¹
(
pkt
->
	`isWr™e
());

524 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

525 
út
 = 0; cÁ < 
pktCouÁ
; ++cnt) {

526 
size
 = 
¡d
::
	`mš
((
addr
 | (
bur¡Size
 - 1)) + 1,

527 
pkt
->
	`g‘Addr
(è+…kt->
	`g‘Size
()è- 
addr
;

528 
wr™ePktSize
[
	`ûLog2
(
size
)]++;

529 
wr™eBur¡s
++;

533 
boŞ
 
m”ged
 = 
isInWr™eQueue
.
	`fšd
(
	`bur¡Align
(
addr
)) !=

534 
isInWr™eQueue
.
	`’d
();

538 ià(!
m”ged
) {

539 
DRAMPack‘
* 
d¿m_pkt
 = 
	`decodeAddr
(
pkt
, 
addr
, 
size
, 
çl£
);

541 
	`as£¹
(
wr™eQueue
.
	`size
(è< 
wr™eBufãrSize
);

542 
wrQL’Pdf
[
wr™eQueue
.
	`size
()]++;

544 
	`DPRINTF
(
DRAM
, "Addingo write queue\n");

546 
wr™eQueue
.
	`push_back
(
d¿m_pkt
);

547 
isInWr™eQueue
.
	`š£¹
(
	`bur¡Align
(
addr
));

548 
	`as£¹
(
wr™eQueue
.
	`size
(è=ğ
isInWr™eQueue
.size());

551 
avgWrQL’
 = 
wr™eQueue
.
	`size
();

554 ++
d¿m_pkt
->
¿nkRef
.
wr™eEÁr›s
;

556 
	`DPRINTF
(
DRAM
, "Merging write burst withƒxisting queueƒntry\n");

560 
m”gedWrBur¡s
++;

564 
addr
 = (add¸| (
bur¡Size
 - 1)) + 1;

572 
	`acûssAndRe¥Úd
(
pkt
, 
äÚ‹ndL©’cy
);

576 ià(!
ÃxtReqEv’t
.
	`scheduËd
()) {

577 
	`DPRINTF
(
DRAM
, "Request scheduled immediately\n");

578 
	`scheduË
(
ÃxtReqEv’t
, 
	`curTick
());

580 
	}
}

583 
	gDRAMCŒl
::
	$´štQs
() const {

584 
	`DPRINTF
(
DRAM
, "===READ QUEUE===\n\n");

585 autØ
i
 = 
»adQueue
.
	`begš
(è; i !ğ»adQueue.
	`’d
() ; ++i) {

586 
	`DPRINTF
(
DRAM
, "R—d %lu\n", (*
i
)->
addr
);

588 
	`DPRINTF
(
DRAM
, "\n===RESP QUEUE===\n\n");

589 autØ
i
 = 
»¥Queue
.
	`begš
(è; i !ğ»¥Queue.
	`’d
() ; ++i) {

590 
	`DPRINTF
(
DRAM
, "Re¥Ú£ %lu\n", (*
i
)->
addr
);

592 
	`DPRINTF
(
DRAM
, "\n===WRITE QUEUE===\n\n");

593 autØ
i
 = 
wr™eQueue
.
	`begš
(è; i !ğwr™eQueue.
	`’d
() ; ++i) {

594 
	`DPRINTF
(
DRAM
, "Wr™%lu\n", (*
i
)->
addr
);

596 
	}
}

598 
boŞ


599 
	gDRAMCŒl
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

602 
	`DPRINTF
(
DRAM
, "recvTimingReq:„equest %s‡ddr %lld size %d\n",

603 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
());

605 
	`·nic_if
(
pkt
->
	`ÿcheRe¥Údšg
(), "Should‚ot see…ackets where cache "

608 
	`·nic_if
(!(
pkt
->
	`isR—d
(è||…kt->
	`isWr™e
()),

612 ià(
´evA¼iv®
 != 0) {

613 
tÙG­
 +ğ
	`curTick
(è- 
´evA¼iv®
;

615 
´evA¼iv®
 = 
	`curTick
();

622 
size
 = 
pkt
->
	`g‘Size
();

623 
off£t
 = 
pkt
->
	`g‘Addr
(è& (
bur¡Size
 - 1);

624 
d¿m_pkt_couÁ
 = 
	`divCe
(
off£t
 + 
size
, 
bur¡Size
);

627 ià(
pkt
->
	`isR—d
()) {

628 
	`as£¹
(
size
 != 0);

629 ià(
	`»adQueueFuÎ
(
d¿m_pkt_couÁ
)) {

630 
	`DPRINTF
(
DRAM
, "Read queue full,‚ot‡ccepting\n");

632 
»ŒyRdReq
 = 
Œue
;

633 
numRdR‘ry
++;

634  
çl£
;

636 
	`addToR—dQueue
(
pkt
, 
d¿m_pkt_couÁ
);

637 
»adReqs
++;

638 
by‹sR—dSys
 +ğ
size
;

641 
	`as£¹
(
pkt
->
	`isWr™e
());

642 
	`as£¹
(
size
 != 0);

643 ià(
	`wr™eQueueFuÎ
(
d¿m_pkt_couÁ
)) {

644 
	`DPRINTF
(
DRAM
, "Write queue full,‚ot‡ccepting\n");

646 
»ŒyWrReq
 = 
Œue
;

647 
numWrR‘ry
++;

648  
çl£
;

650 
	`addToWr™eQueue
(
pkt
, 
d¿m_pkt_couÁ
);

651 
wr™eReqs
++;

652 
by‹sWr™‹nSys
 +ğ
size
;

656  
Œue
;

657 
	}
}

660 
	gDRAMCŒl
::
	$´oûssRe¥ÚdEv’t
()

662 
	`DPRINTF
(
DRAM
,

665 
DRAMPack‘
* 
d¿m_pkt
 = 
»¥Queue
.
	`äÚt
();

670 --
d¿m_pkt
->
¿nkRef
.
»adEÁr›s
;

671 
	`DPRINTF
(
DRAM
, "number of„eadƒntries for„ank %d is %d\n",

672 
d¿m_pkt
->
¿nk
, d¿m_pkt->
¿nkRef
.
»adEÁr›s
);

676 
	`as£¹
(
d¿m_pkt
->
¿nkRef
.
out¡ªdšgEv’ts
 > 0);

678 --
d¿m_pkt
->
¿nkRef
.
out¡ªdšgEv’ts
;

682 
	`as£¹
((
d¿m_pkt
->
¿nkRef
.
pwrS‹
 =ğ
PWR_ACT
) ||

683 (
d¿m_pkt
->
¿nkRef
.
pwrS‹
 =ğ
PWR_IDLE
));

687 ià(
d¿m_pkt
->
¿nkRef
.
	`lowPow”EÁryR—dy
()) {

689 
	`as£¹
(!
d¿m_pkt
->
¿nkRef
.
aùiv©eEv’t
.
	`scheduËd
());

690 
	`as£¹
(!
d¿m_pkt
->
¿nkRef
.
´ech¬geEv’t
.
	`scheduËd
());

691 
	`as£¹
(
d¿m_pkt
->
¿nkRef
.
»äeshS‹
 =ğ
REF_IDLE
);

695 
	`DPRINTF
(
DRAMS‹
, "Rank %d sleep‡tick %d; current…ower state is "

696 "%d\n", 
d¿m_pkt
->
¿nk
, 
	`curTick
(), d¿m_pkt->
¿nkRef
.
pwrS‹
);

700 
Pow”S‹
 
Ãxt_pwr_¡©e
 = 
PWR_ACT_PDN
;

701 ià(
d¿m_pkt
->
¿nkRef
.
pwrS‹
 =ğ
PWR_IDLE
) {

702 
Ãxt_pwr_¡©e
 = 
PWR_PRE_PDN
;

705 
d¿m_pkt
->
¿nkRef
.
	`pow”DownSË•
(
Ãxt_pwr_¡©e
, 
	`curTick
());

708 ià(
d¿m_pkt
->
bur¡H–³r
) {

710 
d¿m_pkt
->
bur¡H–³r
->
bur¡sS”viûd
++;

711 ià(
d¿m_pkt
->
bur¡H–³r
->
bur¡sS”viûd
 ==

712 
d¿m_pkt
->
bur¡H–³r
->
bur¡CouÁ
) {

717 
	`acûssAndRe¥Úd
(
d¿m_pkt
->
pkt
, 
äÚ‹ndL©’cy
 + 
back’dL©’cy
);

718 
d–‘e
 
d¿m_pkt
->
bur¡H–³r
;

719 
d¿m_pkt
->
bur¡H–³r
 = 
NULL
;

723 
	`acûssAndRe¥Úd
(
d¿m_pkt
->
pkt
, 
äÚ‹ndL©’cy
 + 
back’dL©’cy
);

726 
d–‘e
 
»¥Queue
.
	`äÚt
();

727 
»¥Queue
.
	`pİ_äÚt
();

729 ià(!
»¥Queue
.
	`em±y
()) {

730 
	`as£¹
(
»¥Queue
.
	`äÚt
()->
»adyTime
 >ğ
	`curTick
());

731 
	`as£¹
(!
»¥ÚdEv’t
.
	`scheduËd
());

732 
	`scheduË
(
»¥ÚdEv’t
, 
»¥Queue
.
	`äÚt
()->
»adyTime
);

735 ià(
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
 &&

736 
wr™eQueue
.
	`em±y
(è&& 
»adQueue
.em±y(è&& 
	`®lRªksD¿šed
()) {

738 
	`DPRINTF
(
D¿š
, "DRAM controller done draining\n");

739 
	`sigÇlD¿šDÚe
();

745 ià(
»ŒyRdReq
) {

746 
»ŒyRdReq
 = 
çl£
;

747 
pÜt
.
	`£ndR‘ryReq
();

749 
	}
}

751 
boŞ


752 
	gDRAMCŒl
::
choo£Next
(
¡d
::
deque
<
DRAMPack‘
*>& 
queue
, 
Tick
 
exŒa_cŞ_d–ay
)

758 
as£¹
(!
queue
.
em±y
());

761 
boŞ
 
	gfound_·ck‘
 = 
çl£
;

762 ià(
	gqueue
.
size
() == 1) {

763 
DRAMPack‘
* 
d¿m_pkt
 = 
queue
.
äÚt
();

765 ià(
	g¿nks
[
d¿m_pkt
->
¿nk
]->
isAvaabË
()) {

766 
	gfound_·ck‘
 = 
Œue
;

767 
DPRINTF
(
DRAM
, "Single„equest, goingo‡ free„ank\n");

769 
DPRINTF
(
DRAM
, "Single„equest, goingo‡ busy„ank\n");

771  
	gfound_·ck‘
;

774 ià(
	gmemSchedPŞicy
 =ğ
Enums
::
fcfs
) {

776 autØ
i
 = 
queue
.
begš
(); 
	gi
 !ğqueue.
’d
() ; ++i) {

777 
DRAMPack‘
* 
	gd¿m_pkt
 = *
i
;

778 ià(
	g¿nks
[
d¿m_pkt
->
¿nk
]->
isAvaabË
()) {

779 
	gqueue
.
”a£
(
i
);

780 
	gqueue
.
push_äÚt
(
d¿m_pkt
);

781 
	gfound_·ck‘
 = 
Œue
;

785 } ià(
	gmemSchedPŞicy
 =ğ
Enums
::
äfcfs
) {

786 
found_·ck‘
 = 
»Üd”Queue
(
queue
, 
exŒa_cŞ_d–ay
);

788 
·nic
("No scheduling…olicy chosen\n");

789  
	gfound_·ck‘
;

792 
boŞ


793 
	gDRAMCŒl
::
»Üd”Queue
(
¡d
::
deque
<
DRAMPack‘
*>& 
queue
, 
Tick
 
exŒa_cŞ_d–ay
)

796 
ušt64_t
 
	g—¾›¡_bªks
 = 0;

797 
boŞ
 
	ghidd’_bªk_´•
 = 
çl£
;

804 
boŞ
 
	gfound_hidd’_bªk
 = 
çl£
;

808 
boŞ
 
	gfound_´•³d_pkt
 = 
çl£
;

812 
boŞ
 
	gfound_—¾›¡_pkt
 = 
çl£
;

814 autØ
	g£Ëùed_pkt_™
 = 
queue
.
’d
();

817 cÚ¡ 
Tick
 
	gmš_cŞ_©
 = 
¡d
::
max
(
busBusyUÁ
 - 
tCL
 + 
exŒa_cŞ_d–ay
,

818 
curTick
());

820 autØ
	gi
 = 
queue
.
begš
(); i !ğqueue.
’d
() ; ++i) {

821 
DRAMPack‘
* 
	gd¿m_pkt
 = *
i
;

822 cÚ¡ 
	gBªk
& 
	gbªk
 = 
d¿m_pkt
->
bªkRef
;

825 ià(
	gd¿m_pkt
->
	g¿nkRef
.
isAvaabË
()) {

827 ià(
	gbªk
.
	gİ’Row
 =ğ
d¿m_pkt
->
row
) {

831 ià(
bªk
.
cŞAÎowedAt
 <ğ
mš_cŞ_©
) {

836 
DPRINTF
(
DRAM
, "Seamless„ow buffer hit\n");

837 
	g£Ëùed_pkt_™
 = 
i
;

840 } ià(!
	gfound_hidd’_bªk
 && !
	gfound_´•³d_pkt
) {

845 
	g£Ëùed_pkt_™
 = 
i
;

846 
	gfound_´•³d_pkt
 = 
Œue
;

847 
DPRINTF
(
DRAM
, "Prepped„ow buffer hit\n");

849 } ià(!
	gfound_—¾›¡_pkt
) {

852 ià(
	g—¾›¡_bªks
 == 0) {

854 
·œ
<
ušt64_t
, 
boŞ
> 
bªkStus
 =

855 
mšBªkP»p
(
queue
, 
mš_cŞ_©
);

856 
	g—¾›¡_bªks
 = 
bªkStus
.
fœ¡
;

857 
	ghidd’_bªk_´•
 = 
bªkStus
.
£cÚd
;

863 ià(
b™s
(
—¾›¡_bªks
, 
d¿m_pkt
->
bªkId
, dram_pkt->bankId)) {

864 
	gfound_—¾›¡_pkt
 = 
Œue
;

865 
	gfound_hidd’_bªk
 = 
hidd’_bªk_´•
;

871 ià(
	ghidd’_bªk_´•
 || !
	gfound_´•³d_pkt
)

872 
	g£Ëùed_pkt_™
 = 
i
;

878 ià(
	g£Ëùed_pkt_™
 !ğ
queue
.
’d
()) {

879 
DRAMPack‘
* 
£Ëùed_pkt
 = *
£Ëùed_pkt_™
;

880 
	gqueue
.
”a£
(
£Ëùed_pkt_™
);

881 
	gqueue
.
push_äÚt
(
£Ëùed_pkt
);

882  
	gŒue
;

885  
	gçl£
;

889 
	gDRAMCŒl
::
	$acûssAndRe¥Úd
(
Pack‘PŒ
 
pkt
, 
Tick
 
¡©ic_Ï‹ncy
)

891 
	`DPRINTF
(
DRAM
, "Re¥ÚdšgØAdd»s %Îd.. ",
pkt
->
	`g‘Addr
());

893 
boŞ
 
ÃedsRe¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

896 
	`acûss
(
pkt
);

899 ià(
ÃedsRe¥Ú£
) {

901 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

906 
Tick
 
»¥Ú£_time
 = 
	`curTick
(è+ 
¡©ic_Ï‹ncy
 + 
pkt
->
h—d”D–ay
 +

907 
pkt
->
·ylßdD–ay
;

909 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

913 
pÜt
.
	`schedTimšgRe¥
(
pkt
, 
»¥Ú£_time
, 
Œue
);

917 
³ndšgD–‘e
.
	`»£t
(
pkt
);

920 
	`DPRINTF
(
DRAM
, "Done\n");

923 
	}
}

926 
	gDRAMCŒl
::
	$aùiv©eBªk
(
Rªk
& 
¿nk_»f
, 
Bªk
& 
bªk_»f
,

927 
Tick
 
aù_tick
, 
ušt32_t
 
row
)

929 
	`as£¹
(
¿nk_»f
.
aùTicks
.
	`size
(è=ğ
aùiv©iÚLim™
);

931 
	`DPRINTF
(
DRAM
, "Aùiv©©ick %d\n", 
aù_tick
);

934 
	`as£¹
(
bªk_»f
.
İ’Row
 =ğ
Bªk
::
NO_ROW
);

935 
bªk_»f
.
İ’Row
 = 
row
;

940 
bªk_»f
.
by‹sAcûs£d
 = 0;

941 
bªk_»f
.
rowAcûs£s
 = 0;

943 ++
¿nk_»f
.
numBªksAùive
;

944 
	`as£¹
(
¿nk_»f
.
numBªksAùive
 <ğ
bªksP”Rªk
);

946 
	`DPRINTF
(
DRAM
, "Activate bank %d,„ank %d‡tick %lld,‚ow got %d‡ctive\n",

947 
bªk_»f
.
bªk
, 
¿nk_»f
.
¿nk
, 
aù_tick
,

948 
¿nks
[
¿nk_»f
.
¿nk
]->
numBªksAùive
);

950 
¿nk_»f
.
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
ACT
, 
bªk_»f
.
bªk
,

951 
aù_tick
));

953 
	`DPRINTF
(
DRAMPow”
, "%Îu,ACT,%d,%d\n", 
	`divCe
(
aù_tick
, 
tCK
) -

954 
timeSmpOff£t
, 
bªk_»f
.
bªk
, 
¿nk_»f
.
¿nk
);

957 
bªk_»f
.
´eAÎowedAt
 = 
aù_tick
 + 
tRAS
;

960 
bªk_»f
.
cŞAÎowedAt
 = 
¡d
::
	`max
(
aù_tick
 + 
tRCD
, bank_ref.colAllowedAt);

963 
i
 = 0; i < 
bªksP”Rªk
; i++) {

966 ià(
bªkGroupArch
 && (
bªk_»f
.
bªkgr
 =ğ
¿nk_»f
.
bªks
[
i
].bankgr)) {

970 
¿nk_»f
.
bªks
[
i
].
aùAÎowedAt
 = 
¡d
::
	`max
(
aù_tick
 + 
tRRD_L
,

971 
¿nk_»f
.
bªks
[
i
].
aùAÎowedAt
);

976 
¿nk_»f
.
bªks
[
i
].
aùAÎowedAt
 = 
¡d
::
	`max
(
aù_tick
 + 
tRRD
,

977 
¿nk_»f
.
bªks
[
i
].
aùAÎowedAt
);

983 ià(!
¿nk_»f
.
aùTicks
.
	`em±y
()) {

985 ià(
¿nk_»f
.
aùTicks
.
	`back
() &&

986 (
aù_tick
 - 
¿nk_»f
.
aùTicks
.
	`back
()è< 
tXAW
) {

987 
	`·nic
("Got %d‡ctivates in window %d (%llu - %llu) which "

988 "i sm®Ë¸thª %Îu\n", 
aùiv©iÚLim™
, 
aù_tick
 -

989 
¿nk_»f
.
aùTicks
.
	`back
(), 
aù_tick
,

990 
¿nk_»f
.
aùTicks
.
	`back
(), 
tXAW
);

995 
¿nk_»f
.
aùTicks
.
	`pİ_back
();

998 
¿nk_»f
.
aùTicks
.
	`push_äÚt
(
aù_tick
);

1003 ià(
¿nk_»f
.
aùTicks
.
	`back
() &&

1004 (
aù_tick
 - 
¿nk_»f
.
aùTicks
.
	`back
()è< 
tXAW
) {

1005 
	`DPRINTF
(
DRAM
, "EnforcingXAW with X = %d,‚ext‡ctivate "

1006 "nØ—¾›¸thª %Îu\n", 
aùiv©iÚLim™
,

1007 
¿nk_»f
.
aùTicks
.
	`back
(è+ 
tXAW
);

1008 
j
 = 0; j < 
bªksP”Rªk
; j++)

1010 
¿nk_»f
.
bªks
[
j
].
aùAÎowedAt
 =

1011 
¡d
::
	`max
(
¿nk_»f
.
aùTicks
.
	`back
(è+ 
tXAW
,

1012 
¿nk_»f
.
bªks
[
j
].
aùAÎowedAt
);

1018 ià(!
¿nk_»f
.
aùiv©eEv’t
.
	`scheduËd
())

1019 
	`scheduË
(
¿nk_»f
.
aùiv©eEv’t
, 
aù_tick
);

1020 ià(
¿nk_»f
.
aùiv©eEv’t
.
	`wh’
(è> 
aù_tick
)

1022 
	`»scheduË
(
¿nk_»f
.
aùiv©eEv’t
, 
aù_tick
);

1023 
	}
}

1026 
	gDRAMCŒl
::
	$´ech¬geBªk
(
Rªk
& 
¿nk_»f
, 
Bªk
& 
bªk
, 
Tick
 
´e_©
, 
boŞ
 
Œaû
)

1029 
	`as£¹
(
bªk
.
İ’Row
 !ğ
Bªk
::
NO_ROW
);

1033 
by‹sP”Aùiv©e
.
	`§m¶e
(
bªk
.
by‹sAcûs£d
);

1035 
bªk
.
İ’Row
 = 
Bªk
::
NO_ROW
;

1038 
bªk
.
´eAÎowedAt
 = 
´e_©
;

1040 
Tick
 
´e_dÚe_©
 = 
´e_©
 + 
tRP
;

1042 
bªk
.
aùAÎowedAt
 = 
¡d
::
	`max
(bªk.aùAÎowedAt, 
´e_dÚe_©
);

1044 
	`as£¹
(
¿nk_»f
.
numBªksAùive
 != 0);

1045 --
¿nk_»f
.
numBªksAùive
;

1047 
	`DPRINTF
(
DRAM
, "Precharging bank %d,„ank %d‡tick %lld,‚ow got "

1048 "%d‡ùive\n", 
bªk
.bªk, 
¿nk_»f
.
¿nk
, 
´e_©
,

1049 
¿nk_»f
.
numBªksAùive
);

1051 ià(
Œaû
) {

1053 
¿nk_»f
.
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
PRE
, 
bªk
.bank,

1054 
´e_©
));

1055 
	`DPRINTF
(
DRAMPow”
, "%Îu,PRE,%d,%d\n", 
	`divCe
(
´e_©
, 
tCK
) -

1056 
timeSmpOff£t
, 
bªk
.bªk, 
¿nk_»f
.
¿nk
);

1064 ià(!
¿nk_»f
.
´ech¬geEv’t
.
	`scheduËd
()) {

1065 
	`scheduË
(
¿nk_»f
.
´ech¬geEv’t
, 
´e_dÚe_©
);

1067 ++
¿nk_»f
.
out¡ªdšgEv’ts
;

1068 } ià(
¿nk_»f
.
´ech¬geEv’t
.
	`wh’
(è< 
´e_dÚe_©
) {

1069 
	`»scheduË
(
¿nk_»f
.
´ech¬geEv’t
, 
´e_dÚe_©
);

1071 
	}
}

1074 
	gDRAMCŒl
::
	$doDRAMAcûss
(
DRAMPack‘
* 
d¿m_pkt
)

1076 
	`DPRINTF
(
DRAM
, "Timing‡ccesso‡ddr %lld,„ank/bank/row %d %d %d\n",

1077 
d¿m_pkt
->
addr
, d¿m_pkt->
¿nk
, d¿m_pkt->
bªk
, d¿m_pkt->
row
);

1080 
Rªk
& 
¿nk
 = 
d¿m_pkt
->
¿nkRef
;

1085 ià(
¿nk
.
šLowPow”S‹
) {

1086 
	`as£¹
(
¿nk
.
pwrS‹
 !ğ
PWR_SREF
);

1087 
¿nk
.
	`scheduËWakeUpEv’t
(
tXP
);

1091 
Bªk
& 
bªk
 = 
d¿m_pkt
->
bªkRef
;

1094 
boŞ
 
row_h™
 = 
Œue
;

1097 
Tick
 
cmd_©
 = 
¡d
::
	`max
(
bªk
.
cŞAÎowedAt
, 
	`curTick
());

1100 ià(
bªk
.
İ’Row
 =ğ
d¿m_pkt
->
row
) {

1103 
row_h™
 = 
çl£
;

1106 ià(
bªk
.
İ’Row
 !ğ
Bªk
::
NO_ROW
) {

1107 
	`´ech¬geBªk
(
¿nk
, 
bªk
, 
¡d
::
	`max
(bªk.
´eAÎowedAt
, 
	`curTick
()));

1112 
Tick
 
aù_tick
 = 
¡d
::
	`max
(
bªk
.
aùAÎowedAt
, 
	`curTick
());

1116 
	`aùiv©eBªk
(
¿nk
, 
bªk
, 
aù_tick
, 
d¿m_pkt
->
row
);

1119 
cmd_©
 = 
bªk
.
cŞAÎowedAt
;

1124 
cmd_©
 = 
¡d
::
	`max
(cmd_©, 
busBusyUÁ
 - 
tCL
);

1127 
d¿m_pkt
->
»adyTime
 = 
cmd_©
 + 
tCL
 + 
tBURST
;

1130 
	`as£¹
(
d¿m_pkt
->
»adyTime
 - 
busBusyUÁ
 >ğ
tBURST
);

1134 
Tick
 
cmd_dly
;

1135 
j
 = 0; j < 
¿nksP”ChªÃl
; j++) {

1136 
i
 = 0; i < 
bªksP”Rªk
; i++) {

1140 ià(
d¿m_pkt
->
¿nk
 =ğ
j
) {

1141 ià(
bªkGroupArch
 &&

1142 (
bªk
.
bªkgr
 =ğ
¿nks
[
j
]->
bªks
[
i
].bankgr)) {

1146 
cmd_dly
 = 
tCCD_L
;

1152 
cmd_dly
 = 
tBURST
;

1159 
cmd_dly
 = 
tBURST
 + 
tCS
;

1161 
¿nks
[
j
]->
bªks
[
i
].
cŞAÎowedAt
 = 
¡d
::
	`max
(
cmd_©
 + 
cmd_dly
,

1162 
¿nks
[
j
]->
bªks
[
i
].
cŞAÎowedAt
);

1167 
aùiveRªk
 = 
d¿m_pkt
->
¿nk
;

1172 
bªk
.
´eAÎowedAt
 = 
¡d
::
	`max
(bank.preAllowedAt,

1173 
d¿m_pkt
->
isR—d
 ? 
cmd_©
 + 
tRTP
 :

1174 
d¿m_pkt
->
»adyTime
 + 
tWR
);

1177 
bªk
.
by‹sAcûs£d
 +ğ
bur¡Size
;

1178 ++
bªk
.
rowAcûs£s
;

1181 
boŞ
 
auto_´ech¬ge
 = 
·geMgmt
 =ğ
Enums
::
şo£
 ||

1182 
bªk
.
rowAcûs£s
 =ğ
maxAcûs£sP”Row
;

1186 ià(!
auto_´ech¬ge
 &&

1187 (
·geMgmt
 =ğ
Enums
::
İ’_ad­tive
 ||

1188 
·geMgmt
 =ğ
Enums
::
şo£_ad­tive
)) {

1197 
boŞ
 
gÙ_mÜe_h™s
 = 
çl£
;

1198 
boŞ
 
gÙ_bªk_cÚæiù
 = 
çl£
;

1201 cÚ¡ 
deque
<
DRAMPack‘
*>& 
queue
 = 
d¿m_pkt
->
isR—d
 ? 
»adQueue
 :

1202 
wr™eQueue
;

1203 autØ
p
 = 
queue
.
	`begš
();

1206 ++
p
;

1213 !
gÙ_mÜe_h™s
 && 
p
 !ğ
queue
.
	`’d
()) {

1214 
boŞ
 
§me_¿nk_bªk
 = (
d¿m_pkt
->
¿nk
 =ğ(*
p
)->rank) &&

1215 (
d¿m_pkt
->
bªk
 =ğ(*
p
)->bank);

1216 
boŞ
 
§me_row
 = 
d¿m_pkt
->
row
 =ğ(*
p
)->row;

1217 
gÙ_mÜe_h™s
 |ğ
§me_¿nk_bªk
 && 
§me_row
;

1218 
gÙ_bªk_cÚæiù
 |ğ
§me_¿nk_bªk
 && !
§me_row
;

1219 ++
p
;

1226 
auto_´ech¬ge
 = !
gÙ_mÜe_h™s
 &&

1227 (
gÙ_bªk_cÚæiù
 || 
·geMgmt
 =ğ
Enums
::
şo£_ad­tive
);

1231 
¡d
::
¡ršg
 
mem_cmd
 = 
d¿m_pkt
->
isR—d
 ? "RD" : "WR";

1234 
MemCommªd
::
cmds
 
commªd
 = (
mem_cmd
 =ğ"RD"è? MemCommªd::
RD
 :

1235 
MemCommªd
::
WR
;

1238 
busBusyUÁ
 = 
d¿m_pkt
->
»adyTime
;

1240 
	`DPRINTF
(
DRAM
, "Accesso %lld,„eady‡t %lld bus busy until %lld.\n",

1241 
d¿m_pkt
->
addr
, d¿m_pkt->
»adyTime
, 
busBusyUÁ
);

1243 
d¿m_pkt
->
¿nkRef
.
cmdLi¡
.
	`push_back
(
	`Commªd
(
commªd
, d¿m_pkt->
bªk
,

1244 
cmd_©
));

1246 
	`DPRINTF
(
DRAMPow”
, "%Îu,%s,%d,%d\n", 
	`divCe
(
cmd_©
, 
tCK
) -

1247 
timeSmpOff£t
, 
mem_cmd
, 
d¿m_pkt
->
bªk
, d¿m_pkt->
¿nk
);

1251 ià(
auto_´ech¬ge
) {

1254 
	`´ech¬geBªk
(
¿nk
, 
bªk
, 
¡d
::
	`max
(
	`curTick
(), bªk.
´eAÎowedAt
));

1256 
	`DPRINTF
(
DRAM
, "Auto-´ech¬ged bªk: %d\n", 
d¿m_pkt
->
bªkId
);

1263 
ÃxtReqTime
 = 
busBusyUÁ
 - (
tRP
 + 
tRCD
 + 
tCL
);

1266 ià(
d¿m_pkt
->
isR—d
) {

1267 ++
»adsThisTime
;

1268 ià(
row_h™
)

1269 
»adRowH™s
++;

1270 
by‹sR—dDRAM
 +ğ
bur¡Size
;

1271 
³rBªkRdBur¡s
[
d¿m_pkt
->
bªkId
]++;

1274 
tÙMemAccL©
 +ğ
d¿m_pkt
->
»adyTime
 - d¿m_pkt->
’ŒyTime
;

1275 
tÙBusL©
 +ğ
tBURST
;

1276 
tÙQL©
 +ğ
cmd_©
 - 
d¿m_pkt
->
’ŒyTime
;

1278 ++
wr™esThisTime
;

1279 ià(
row_h™
)

1280 
wr™eRowH™s
++;

1281 
by‹sWr™‹n
 +ğ
bur¡Size
;

1282 
³rBªkWrBur¡s
[
d¿m_pkt
->
bªkId
]++;

1284 
	}
}

1287 
	gDRAMCŒl
::
	$´oûssNextReqEv’t
()

1289 
busyRªks
 = 0;

1290 autØ
r
 : 
¿nks
) {

1291 ià(!
r
->
	`isAvaabË
()) {

1292 ià(
r
->
pwrS‹
 !ğ
PWR_SREF
) {

1294 
	`DPRINTF
(
DRAMS‹
, "Rªk %d i nÙ‡vaabË\n", 
r
->
¿nk
);

1295 
busyRªks
++;

1299 
r
->
	`checkD¿šDÚe
();

1304 ià((
r
->
pwrS‹
 =ğ
PWR_SREF
è&&„->
šLowPow”S‹
) {

1305 
	`DPRINTF
(
DRAMS‹
, "Rªk %d i š s–f-»äesh\n", 
r
->
¿nk
);

1309 ià(
r
->
	`fÜûS–fReäeshEx™
()) {

1310 
	`DPRINTF
(
DRAMS‹
, "rank %d was in self„efresh‡nd"

1311 " should wakup\n", 
r
->
¿nk
);

1313 
r
->
	`scheduËWakeUpEv’t
(
tXS
);

1322 ià(
busyRªks
 =ğ
¿nksP”ChªÃl
) {

1331 
boŞ
 
sw™ched_cmd_ty³
 = 
çl£
;

1332 ià(
busS‹
 !ğ
busS‹Next
) {

1333 ià(
busS‹
 =ğ
READ
) {

1334 
	`DPRINTF
(
DRAM
, "Switchingo writes‡fter %d„eads with %d„eads "

1335 "wa™šg\n", 
»adsThisTime
, 
»adQueue
.
	`size
());

1339 
rdP”TuºAround
.
	`§m¶e
(
»adsThisTime
);

1340 
»adsThisTime
 = 0;

1343 
sw™ched_cmd_ty³
 = 
Œue
;

1345 
	`DPRINTF
(
DRAM
, "Switchingo„eads‡fter %d writes with %d writes "

1346 "wa™šg\n", 
wr™esThisTime
, 
wr™eQueue
.
	`size
());

1348 
wrP”TuºAround
.
	`§m¶e
(
wr™esThisTime
);

1349 
wr™esThisTime
 = 0;

1351 
sw™ched_cmd_ty³
 = 
Œue
;

1354 
busS‹
 = 
busS‹Next
;

1358 ià(
busS‹
 =ğ
READ
) {

1361 
boŞ
 
sw™ch_to_wr™es
 = 
çl£
;

1363 ià(
»adQueue
.
	`em±y
()) {

1367 ià(!
wr™eQueue
.
	`em±y
() &&

1368 (
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
 ||

1369 
wr™eQueue
.
	`size
(è> 
wr™eLowTh»shŞd
)) {

1371 
sw™ch_to_wr™es
 = 
Œue
;

1377 ià(
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
 &&

1378 
»¥Queue
.
	`em±y
(è&& 
	`®lRªksD¿šed
()) {

1380 
	`DPRINTF
(
D¿š
, "DRAM controller done draining\n");

1381 
	`sigÇlD¿šDÚe
();

1390 
boŞ
 
found_»ad
 = 
çl£
;

1396 
found_»ad
 = 
	`choo£Next
(
»adQueue
,

1397 
sw™ched_cmd_ty³
 ? 
tCS
 : 0);

1404 ià(!
found_»ad
)

1407 
DRAMPack‘
* 
d¿m_pkt
 = 
»adQueue
.
	`äÚt
();

1408 
	`as£¹
(
d¿m_pkt
->
¿nkRef
.
	`isAvaabË
());

1415 ià(
sw™ched_cmd_ty³
 && 
d¿m_pkt
->
¿nk
 =ğ
aùiveRªk
) {

1416 
busBusyUÁ
 +ğ
tWTR
 + 
tCL
;

1419 
	`doDRAMAcûss
(
d¿m_pkt
);

1422 
»adQueue
.
	`pİ_äÚt
();

1425 ++
d¿m_pkt
->
¿nkRef
.
out¡ªdšgEv’ts
;

1428 
	`as£¹
(
d¿m_pkt
->
size
 <ğ
bur¡Size
);

1429 
	`as£¹
(
d¿m_pkt
->
»adyTime
 >ğ
	`curTick
());

1433 ià(
»¥Queue
.
	`em±y
()) {

1434 
	`as£¹
(!
»¥ÚdEv’t
.
	`scheduËd
());

1435 
	`scheduË
(
»¥ÚdEv’t
, 
d¿m_pkt
->
»adyTime
);

1437 
	`as£¹
(
»¥Queue
.
	`back
()->
»adyTime
 <ğ
d¿m_pkt
->readyTime);

1438 
	`as£¹
(
»¥ÚdEv’t
.
	`scheduËd
());

1441 
»¥Queue
.
	`push_back
(
d¿m_pkt
);

1444 ià(
wr™eQueue
.
	`size
(è> 
wr™eHighTh»shŞd
) {

1445 
sw™ch_to_wr™es
 = 
Œue
;

1452 ià(
sw™ch_to_wr™es
) {

1454 
busS‹Next
 = 
WRITE
;

1458 
boŞ
 
found_wr™e
 = 
çl£
;

1462 
found_wr™e
 = 
	`choo£Next
(
wr™eQueue
,

1463 
sw™ched_cmd_ty³
 ? 
¡d
::
	`mš
(
tRTW
, 
tCS
) : 0);

1469 ià(!
found_wr™e
)

1472 
DRAMPack‘
* 
d¿m_pkt
 = 
wr™eQueue
.
	`äÚt
();

1473 
	`as£¹
(
d¿m_pkt
->
¿nkRef
.
	`isAvaabË
());

1475 
	`as£¹
(
d¿m_pkt
->
size
 <ğ
bur¡Size
);

1481 ià(
sw™ched_cmd_ty³
 && 
d¿m_pkt
->
¿nk
 =ğ
aùiveRªk
) {

1482 
busBusyUÁ
 +ğ
tRTW
;

1485 
	`doDRAMAcûss
(
d¿m_pkt
);

1487 
wr™eQueue
.
	`pİ_äÚt
();

1490 --
d¿m_pkt
->
¿nkRef
.
wr™eEÁr›s
;

1498 ià(!
d¿m_pkt
->
¿nkRef
.
wr™eDÚeEv’t
.
	`scheduËd
()) {

1499 
	`scheduË
(
d¿m_pkt
->
¿nkRef
.
wr™eDÚeEv’t
, d¿m_pkt->
»adyTime
);

1501 ++
d¿m_pkt
->
¿nkRef
.
out¡ªdšgEv’ts
;

1503 } ià(
d¿m_pkt
->
¿nkRef
.
wr™eDÚeEv’t
.
	`wh’
() <

1504 
d¿m_pkt
-> 
»adyTime
) {

1505 
	`»scheduË
(
d¿m_pkt
->
¿nkRef
.
wr™eDÚeEv’t
, d¿m_pkt->
»adyTime
);

1508 
isInWr™eQueue
.
	`”a£
(
	`bur¡Align
(
d¿m_pkt
->
addr
));

1509 
d–‘e
 
d¿m_pkt
;

1515 ià(
wr™eQueue
.
	`em±y
() ||

1516 (
wr™eQueue
.
	`size
(è+ 
mšWr™esP”Sw™ch
 < 
wr™eLowTh»shŞd
 &&

1517 
	`d¿šS‹
(è!ğ
D¿šS‹
::
D¿ššg
) ||

1518 (!
»adQueue
.
	`em±y
(è&& 
wr™esThisTime
 >ğ
mšWr™esP”Sw™ch
)) {

1520 
busS‹Next
 = 
READ
;

1530 ià(!
ÃxtReqEv’t
.
	`scheduËd
())

1531 
	`scheduË
(
ÃxtReqEv’t
, 
¡d
::
	`max
(
ÃxtReqTime
, 
	`curTick
()));

1537 ià(
»ŒyWrReq
 && 
wr™eQueue
.
	`size
(è< 
wr™eBufãrSize
) {

1538 
»ŒyWrReq
 = 
çl£
;

1539 
pÜt
.
	`£ndR‘ryReq
();

1541 
	}
}

1543 
	g·œ
<
	gušt64_t
, 
	gboŞ
>

1544 
	gDRAMCŒl
::
mšBªkP»p
(cÚ¡ 
deque
<
DRAMPack‘
*>& 
queue
,

1545 
Tick
 
mš_cŞ_©
) const

1547 
ušt64_t
 
	gbªk_mask
 = 0;

1548 
Tick
 
	gmš_aù_©
 = 
MaxTick
;

1552 cÚ¡ 
Tick
 
	ghidd’_aù_max
 = 
¡d
::
max
(
mš_cŞ_©
 - 
tRCD
, 
curTick
());

1555 
boŞ
 
	gfound_£amËss_bªk
 = 
çl£
;

1559 
boŞ
 
	ghidd’_bªk_´•
 = 
çl£
;

1563 
	gveùÜ
<
	gboŞ
> 
gÙ_wa™šg
(
¿nksP”ChªÃl
 * 
bªksP”Rªk
, 
çl£
);

1564 cÚ¡‡uto& 
	gp
 : 
queue
) {

1565 ià(
p
->
¿nkRef
.
isAvaabË
())

1566 
gÙ_wa™šg
[
p
->
bªkId
] = 
Œue
;

1571 
	gi
 = 0; i < 
	g¿nksP”ChªÃl
; i++) {

1572 
	gj
 = 0; j < 
	gbªksP”Rªk
; j++) {

1573 
ušt16_t
 
	gbªk_id
 = 
i
 * 
bªksP”Rªk
 + 
j
;

1577 ià(
	ggÙ_wa™šg
[
bªk_id
]) {

1579 
as£¹
(
¿nks
[
i
]->
isAvaabË
());

1583 
Tick
 
	gaù_©
 = 
¿nks
[
i
]->
bªks
[
j
].
İ’Row
 =ğ
Bªk
::
NO_ROW
 ?

1584 
¡d
::
max
(
¿nks
[
i
]->
bªks
[
j
].
aùAÎowedAt
, 
curTick
()) :

1585 
¡d
::
max
(
¿nks
[
i
]->
bªks
[
j
].
´eAÎowedAt
, 
curTick
()è+ 
	gtRP
;

1588 
Tick
 
	gcŞ_©
 = 
¡d
::
max
(
¿nks
[
i
]->
bªks
[
j
].
cŞAÎowedAt
,

1589 
aù_©
 + 
tRCD
);

1593 
boŞ
 
	gÃw_£amËss_bªk
 = 
cŞ_©
 <ğ
mš_cŞ_©
;

1598 ià(
	gÃw_£amËss_bªk
 ||

1599 (!
	gfound_£amËss_bªk
 && 
	gaù_©
 <ğ
mš_aù_©
)) {

1605 ià(!
found_£amËss_bªk
 &&

1606 (
Ãw_£amËss_bªk
 || 
aù_©
 < 
mš_aù_©
)) {

1607 
bªk_mask
 = 0;

1610 
	gfound_£amËss_bªk
 |ğ
Ãw_£amËss_bªk
;

1613 
	ghidd’_bªk_´•
 = 
aù_©
 <ğ
hidd’_aù_max
;

1616 
»¶aûB™s
(
bªk_mask
, 
bªk_id
, bank_id, 1);

1617 
	gmš_aù_©
 = 
aù_©
;

1623  
make_·œ
(
bªk_mask
, 
hidd’_bªk_´•
);

1626 
	gDRAMCŒl
::
Rªk
::
	$Rªk
(
DRAMCŒl
& 
_memÜy
, cÚ¡ 
DRAMCŒlP¬ams
* 
_p
)

1627 : 
	`Ev’tMªag”
(&
_memÜy
), 
	`memÜy
(_memory),

1628 
	`pwrS‹T¿ns
(
PWR_IDLE
), 
	`pwrS‹Po¡Reäesh
(PWR_IDLE),

1629 
	`pwrS‹Tick
(0), 
	`»äeshDueAt
(0), 
	`pwrS‹
(
PWR_IDLE
),

1630 
	`»äeshS‹
(
REF_IDLE
), 
	`šLowPow”S‹
(
çl£
), 
	`¿nk
(0),

1631 
	`»adEÁr›s
(0), 
	`wr™eEÁr›s
(0), 
	`out¡ªdšgEv’ts
(0),

1632 
	`wakeUpAÎowedAt
(0), 
	`pow”
(
_p
, 
çl£
), 
	`numBªksAùive
(0),

1633 
	`wr™eDÚeEv’t
(*
this
), 
	`aùiv©eEv’t
(*this), 
	`´ech¬geEv’t
(*this),

1634 
	`»äeshEv’t
(*
this
), 
	`pow”Ev’t
(*this), 
	$wakeUpEv’t
(*
this
)

1635 { 
	}
}

1638 
	gDRAMCŒl
::
Rªk
::
	$¡¬tup
(
Tick
 
»f_tick
)

1640 
	`as£¹
(
»f_tick
 > 
	`curTick
());

1642 
pwrS‹Tick
 = 
	`curTick
();

1646 
	`scheduË
(
»äeshEv’t
, 
»f_tick
);

1647 
	}
}

1650 
	gDRAMCŒl
::
Rªk
::
	$su¥’d
()

1652 
	`descheduË
(
»äeshEv’t
);

1655 
	`upd©ePow”Sts
();

1658 
pwrS‹Po¡Reäesh
 = 
PWR_IDLE
;

1659 
	}
}

1661 
boŞ


1662 
	gDRAMCŒl
::
Rªk
::
	$lowPow”EÁryR—dy
() const

1664 
boŞ
 
no_queued_cmds
 = ((
memÜy
.
busS‹Next
 =ğ
READ
è&& (
»adEÁr›s
 == 0))

1665 || ((
memÜy
.
busS‹Next
 =ğ
WRITE
) &&

1666 (
wr™eEÁr›s
 == 0));

1668 ià(
»äeshS‹
 =ğ
REF_RUN
) {

1672  
no_queued_cmds
;

1675  (
no_queued_cmds
 && (
out¡ªdšgEv’ts
 == 0));

1677 
	}
}

1680 
	gDRAMCŒl
::
Rªk
::
	$checkD¿šDÚe
()

1684 ià(
»äeshS‹
 =ğ
REF_DRAIN
) {

1685 
	`DPRINTF
(
DRAM
, "Refresh drain done,‚ow…recharging\n");

1687 
»äeshS‹
 = 
REF_PD_EXIT
;

1690 
	`scheduË
(
»äeshEv’t
, 
	`curTick
());

1692 
	}
}

1695 
	gDRAMCŒl
::
Rªk
::
	$æushCmdLi¡
()

1699 
	`sÜt
(
cmdLi¡
.
	`begš
(), cmdLi¡.
	`’d
(), 
DRAMCŒl
::
sÜtTime
);

1701 autØ
Ãxt_™”
 = 
cmdLi¡
.
	`begš
();

1703  ; 
Ãxt_™”
 !ğ
cmdLi¡
.
	`’d
() ; ++next_iter) {

1704 
Commªd
 
cmd
 = *
Ãxt_™”
;

1705 ià(
cmd
.
timeSmp
 <ğ
	`curTick
()) {

1707 
pow”
.
pow”lib
.
	`doCommªd
(
cmd
.
ty³
, cmd.
bªk
,

1708 
	`divCe
(
cmd
.
timeSmp
, 
memÜy
.
tCK
) -

1709 
memÜy
.
timeSmpOff£t
);

1719 
cmdLi¡
.
	`assign
(
Ãxt_™”
, cmdLi¡.
	`’d
());

1720 
	}
}

1723 
	gDRAMCŒl
::
Rªk
::
	$´oûssAùiv©eEv’t
()

1726 ià(
pwrS‹
 !ğ
PWR_ACT
)

1729 
	`scheduËPow”Ev’t
(
PWR_ACT
, 
	`curTick
());

1730 
	}
}

1733 
	gDRAMCŒl
::
Rªk
::
	$´oûssP»ch¬geEv’t
()

1737 
	`as£¹
(
out¡ªdšgEv’ts
 > 0);

1739 --
out¡ªdšgEv’ts
;

1743 ià(
numBªksAùive
 == 0) {

1746 ià(
	`lowPow”EÁryR—dy
()) {

1748 
	`as£¹
(
pwrS‹
 =ğ
PWR_ACT
);

1751 
	`DPRINTF
(
DRAMS‹
, "Rank %d sleep‡tick %d\n",

1752 
¿nk
, 
	`curTick
());

1753 
	`pow”DownSË•
(
PWR_PRE_PDN
, 
	`curTick
());

1757 
	`scheduËPow”Ev’t
(
PWR_IDLE
, 
	`curTick
());

1760 
	}
}

1763 
	gDRAMCŒl
::
Rªk
::
	$´oûssWr™eDÚeEv’t
()

1767 
	`as£¹
(
out¡ªdšgEv’ts
 > 0);

1770 --
out¡ªdšgEv’ts
;

1771 
	}
}

1774 
	gDRAMCŒl
::
Rªk
::
	$´oûssReäeshEv’t
()

1777 ià((
»äeshS‹
 =ğ
REF_IDLE
è|| (»äeshS‹ =ğ
REF_SREF_EXIT
)) {

1779 
»äeshDueAt
 = 
	`curTick
();

1782 
»äeshS‹
 = 
REF_DRAIN
;

1786 ++
out¡ªdšgEv’ts
;

1788 
	`DPRINTF
(
DRAM
, "Refresh due\n");

1794 ià(
»äeshS‹
 =ğ
REF_DRAIN
) {

1797 ià((
¿nk
 =ğ
memÜy
.
aùiveRªk
)

1798 && (
memÜy
.
ÃxtReqEv’t
.
	`scheduËd
())) {

1801 
	`DPRINTF
(
DRAM
, "Refresh‡waiting draining\n");

1805 
»äeshS‹
 = 
REF_PD_EXIT
;

1810 ià(
»äeshS‹
 =ğ
REF_PD_EXIT
) {

1813 ià(
šLowPow”S‹
) {

1814 
	`DPRINTF
(
DRAM
, "Wake Up for„efresh\n");

1816 
	`scheduËWakeUpEv’t
(
memÜy
.
tXP
);

1819 
»äeshS‹
 = 
REF_PRE
;

1824 ià(
»äeshS‹
 =ğ
REF_PRE
) {

1826 ià(
numBªksAùive
 != 0) {

1829 
	`DPRINTF
(
DRAM
, "Precharging‡ll\n");

1832 
Tick
 
´e_©
 = 
	`curTick
();

1834 autØ&
b
 : 
bªks
) {

1838 
´e_©
 = 
¡d
::
	`max
(
b
.
´eAÎowedAt
,…re_at);

1843 
Tick
 
aù_®lowed_©
 = 
´e_©
 + 
memÜy
.
tRP
;

1845 autØ&
b
 : 
bªks
) {

1846 ià(
b
.
İ’Row
 !ğ
Bªk
::
NO_ROW
) {

1847 
memÜy
.
	`´ech¬geBªk
(*
this
, 
b
, 
´e_©
, 
çl£
);

1849 
b
.
aùAÎowedAt
 = 
¡d
::
	`max
(b.aùAÎowedAt, 
aù_®lowed_©
);

1850 
b
.
´eAÎowedAt
 = 
¡d
::
	`max
(b.´eAÎowedAt, 
´e_©
);

1855 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
PREA
, 0, 
´e_©
));

1857 
	`DPRINTF
(
DRAMPow”
, "%llu,PREA,0,%d\n",

1858 
	`divCe
(
´e_©
, 
memÜy
.
tCK
) -

1859 
memÜy
.
timeSmpOff£t
, 
¿nk
);

1860 } ià((
pwrS‹
 =ğ
PWR_IDLE
è&& (
out¡ªdšgEv’ts
 == 1)) {

1863 
	`DPRINTF
(
DRAM
, "All banks‡lready…recharged, starting„efresh\n");

1867 
	`scheduËPow”Ev’t
(
PWR_REF
, 
	`curTick
());

1872 
	`as£¹
(
´ech¬geEv’t
.
	`scheduËd
());

1876 
	`as£¹
(
numBªksAùive
 == 0);

1886 ià(
»äeshS‹
 =ğ
REF_START
) {

1888 
	`as£¹
(
numBªksAùive
 == 0);

1889 
	`as£¹
(
pwrS‹
 =ğ
PWR_REF
);

1891 
Tick
 
»f_dÚe_©
 = 
	`curTick
(è+ 
memÜy
.
tRFC
;

1893 autØ&
b
 : 
bªks
) {

1894 
b
.
aùAÎowedAt
 = 
»f_dÚe_©
;

1898 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
REF
, 0, 
	`curTick
()));

1901 
	`upd©ePow”Sts
();

1903 
	`DPRINTF
(
DRAMPow”
, "%Îu,REF,0,%d\n", 
	`divCe
(
	`curTick
(), 
memÜy
.
tCK
) -

1904 
memÜy
.
timeSmpOff£t
, 
¿nk
);

1907 
»äeshDueAt
 +ğ
memÜy
.
tREFI
;

1911 ià(
»äeshDueAt
 < 
»f_dÚe_©
) {

1912 
	`çl
("Refresh was delayed so†ong we cannot catch up\n");

1917 
»äeshS‹
 = 
REF_RUN
;

1918 
	`scheduË
(
»äeshEv’t
, 
»f_dÚe_©
);

1922 ià(
»äeshS‹
 =ğ
REF_RUN
) {

1924 
	`as£¹
(
numBªksAùive
 == 0);

1925 
	`as£¹
(
pwrS‹
 =ğ
PWR_REF
);

1927 
	`as£¹
(!
pow”Ev’t
.
	`scheduËd
());

1929 ià((
memÜy
.
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
) ||

1930 (
memÜy
.
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿šed
)) {

1933 
	`scheduËPow”Ev’t
(
PWR_IDLE
, 
	`curTick
());

1937 ià(
pwrS‹Po¡Reäesh
 !ğ
PWR_IDLE
) {

1939 
	`as£¹
(
pwrS‹
 =ğ
PWR_REF
);

1940 
	`DPRINTF
(
DRAMS‹
, "Rank %d sleeping‡fter„efresh‡nd was in "

1941 "pow” s‹ %d befÜ»äeshšg\n", 
¿nk
,

1942 
pwrS‹Po¡Reäesh
);

1943 
	`pow”DownSË•
(
pwrS‹
, 
	`curTick
());

1947 } ià(
	`lowPow”EÁryR—dy
()) {

1948 
	`DPRINTF
(
DRAMS‹
, "Rank %d sleeping‡fter„efresh but was NOT"

1949 " iÀ¨low…ow” s‹ befÜ»äeshšg\n", 
¿nk
);

1950 
	`pow”DownSË•
(
PWR_PRE_PDN
, 
	`curTick
());

1956 
	`scheduËPow”Ev’t
(
PWR_IDLE
, 
	`curTick
());

1962 ià(
pwrS‹T¿ns
 !ğ
PWR_SREF
) {

1965 
	`scheduË
(
»äeshEv’t
, 
»äeshDueAt
 - 
memÜy
.
tRP
);

1967 
	`DPRINTF
(
DRAMS‹
, "Refresh done‡t %llu‡nd‚ext„efresh"

1968 "‡ˆ%Îu\n", 
	`curTick
(), 
»äeshDueAt
);

1971 
	}
}

1974 
	gDRAMCŒl
::
Rªk
::
	$scheduËPow”Ev’t
(
Pow”S‹
 
pwr_¡©e
, 
Tick
 
tick
)

1977 
	`as£¹
(
tick
 >ğ
	`curTick
());

1979 ià(!
pow”Ev’t
.
	`scheduËd
()) {

1980 
	`DPRINTF
(
DRAMS‹
, "Scheduling…owerƒvent‡t %lluo state %d\n",

1981 
tick
, 
pwr_¡©e
);

1984 
pwrS‹T¿ns
 = 
pwr_¡©e
;

1986 
	`scheduË
(
pow”Ev’t
, 
tick
);

1988 
	`·nic
("Scheduled…owerƒvent‡t %lluo state %d, "

1989 "w™h scheduËdƒv’ˆ© %ÎuØ%d\n", 
tick
, 
pwr_¡©e
,

1990 
pow”Ev’t
.
	`wh’
(), 
pwrS‹T¿ns
);

1992 
	}
}

1995 
	gDRAMCŒl
::
Rªk
::
	$pow”DownSË•
(
Pow”S‹
 
pwr_¡©e
, 
Tick
 
tick
)

2000 ià(
pwr_¡©e
 =ğ
PWR_ACT_PDN
) {

2001 
	`scheduËPow”Ev’t
(
pwr_¡©e
, 
tick
);

2003 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
PDN_F_ACT
, 0, 
tick
));

2004 
	`DPRINTF
(
DRAMPow”
, "%Îu,PDN_F_ACT,0,%d\n", 
	`divCe
(
tick
,

2005 
memÜy
.
tCK
è- memÜy.
timeSmpOff£t
, 
¿nk
);

2006 } ià(
pwr_¡©e
 =ğ
PWR_PRE_PDN
) {

2010 
	`scheduËPow”Ev’t
(
pwr_¡©e
, 
tick
);

2012 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
PDN_F_PRE
, 0, 
tick
));

2013 
	`DPRINTF
(
DRAMPow”
, "%Îu,PDN_F_PRE,0,%d\n", 
	`divCe
(
tick
,

2014 
memÜy
.
tCK
è- memÜy.
timeSmpOff£t
, 
¿nk
);

2015 } ià(
pwr_¡©e
 =ğ
PWR_REF
) {

2019 ià(
pwrS‹Po¡Reäesh
 =ğ
PWR_ACT_PDN
 || !
	`lowPow”EÁryR—dy
()) {

2022 
	`scheduËPow”Ev’t
(
PWR_PRE_PDN
, 
tick
);

2024 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
PDN_F_PRE
, 0, 
tick
));

2025 
	`DPRINTF
(
DRAMPow”
, "%Îu,PDN_F_PRE,0,%d\n", 
	`divCe
(
tick
,

2026 
memÜy
.
tCK
è- memÜy.
timeSmpOff£t
, 
¿nk
);

2029 
	`as£¹
(
pwrS‹Po¡Reäesh
 =ğ
PWR_PRE_PDN
);

2032 
	`scheduËPow”Ev’t
(
PWR_SREF
, 
tick
);

2034 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
SREN
, 0, 
tick
));

2035 
	`DPRINTF
(
DRAMPow”
, "%Îu,SREN,0,%d\n", 
	`divCe
(
tick
,

2036 
memÜy
.
tCK
è- memÜy.
timeSmpOff£t
, 
¿nk
);

2042 
wakeUpAÎowedAt
 = 
tick
 + 
memÜy
.
tCK
;

2045 
šLowPow”S‹
 = 
Œue
;

2046 
	}
}

2049 
	gDRAMCŒl
::
Rªk
::
	$scheduËWakeUpEv’t
(
Tick
 
ex™_d–ay
)

2051 
Tick
 
wake_up_tick
 = 
¡d
::
	`max
(
	`curTick
(), 
wakeUpAÎowedAt
);

2053 
	`DPRINTF
(
DRAMS‹
, "Scheduling wake-up for„ank %d‡tick %d\n",

2054 
¿nk
, 
wake_up_tick
);

2058 ià(
»äeshS‹
 =ğ
REF_PD_EXIT
) {

2059 
pwrS‹Po¡Reäesh
 = 
pwrS‹
;

2062 
pwrS‹Po¡Reäesh
 = 
PWR_IDLE
;

2067 
	`scheduË
(
wakeUpEv’t
, 
wake_up_tick
);

2069 autØ&
b
 : 
bªks
) {

2073 
b
.
cŞAÎowedAt
 = 
¡d
::
	`max
(
wake_up_tick
 + 
ex™_d–ay
, b.colAllowedAt);

2074 
b
.
´eAÎowedAt
 = 
¡d
::
	`max
(
wake_up_tick
 + 
ex™_d–ay
, b.preAllowedAt);

2075 
b
.
aùAÎowedAt
 = 
¡d
::
	`max
(
wake_up_tick
 + 
ex™_d–ay
, b.actAllowedAt);

2078 
šLowPow”S‹
 = 
çl£
;

2083 ià(
pwrS‹T¿ns
 =ğ
PWR_ACT_PDN
) {

2084 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
PUP_ACT
, 0, 
wake_up_tick
));

2085 
	`DPRINTF
(
DRAMPow”
, "%Îu,PUP_ACT,0,%d\n", 
	`divCe
(
wake_up_tick
,

2086 
memÜy
.
tCK
è- memÜy.
timeSmpOff£t
, 
¿nk
);

2088 } ià(
pwrS‹T¿ns
 =ğ
PWR_PRE_PDN
) {

2089 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
PUP_PRE
, 0, 
wake_up_tick
));

2090 
	`DPRINTF
(
DRAMPow”
, "%Îu,PUP_PRE,0,%d\n", 
	`divCe
(
wake_up_tick
,

2091 
memÜy
.
tCK
è- memÜy.
timeSmpOff£t
, 
¿nk
);

2092 } ià(
pwrS‹T¿ns
 =ğ
PWR_SREF
) {

2093 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
SREX
, 0, 
wake_up_tick
));

2094 
	`DPRINTF
(
DRAMPow”
, "%Îu,SREX,0,%d\n", 
	`divCe
(
wake_up_tick
,

2095 
memÜy
.
tCK
è- memÜy.
timeSmpOff£t
, 
¿nk
);

2097 
	}
}

2100 
	gDRAMCŒl
::
Rªk
::
	$´oûssWakeUpEv’t
()

2103 
	`as£¹
((
pwrS‹
 =ğ
PWR_ACT_PDN
è|| (pwrS‹ =ğ
PWR_PRE_PDN
) ||

2104 (
pwrS‹
 =ğ
PWR_SREF
));

2107 ià(
pwrS‹
 =ğ
PWR_ACT_PDN
) {

2109 
	`scheduËPow”Ev’t
(
PWR_ACT
, 
	`curTick
());

2113 
	`scheduËPow”Ev’t
(
PWR_IDLE
, 
	`curTick
());

2115 
	}
}

2118 
	gDRAMCŒl
::
Rªk
::
	$´oûssPow”Ev’t
()

2120 
	`as£¹
(
	`curTick
(è>ğ
pwrS‹Tick
);

2122 
Tick
 
du¿tiÚ
 = 
	`curTick
(è- 
pwrS‹Tick
;

2123 
Pow”S‹
 
´ev_¡©e
 = 
pwrS‹
;

2126 
pwrS‹Time
[
´ev_¡©e
] +ğ
du¿tiÚ
;

2129 ià((
´ev_¡©e
 =ğ
PWR_PRE_PDN
è|| (´ev_¡©=ğ
PWR_ACT_PDN
) ||

2130 (
´ev_¡©e
 =ğ
PWR_SREF
)) {

2131 
tÙ®IdËTime
 +ğ
du¿tiÚ
;

2134 
pwrS‹
 = 
pwrS‹T¿ns
;

2135 
pwrS‹Tick
 = 
	`curTick
();

2138 ià(
´ev_¡©e
 =ğ
PWR_REF
) {

2141 
	`as£¹
(
out¡ªdšgEv’ts
 == 1);

2143 --
out¡ªdšgEv’ts
;

2145 
	`DPRINTF
(
DRAMS‹
, "Wa »äeshšg fÜ %Îuicks\n", 
du¿tiÚ
);

2147 ià(
pwrS‹
 !ğ
PWR_IDLE
) {

2148 
	`as£¹
((
pwrS‹
 =ğ
PWR_PRE_PDN
è|| (pwrS‹ =ğ
PWR_SREF
));

2149 
	`DPRINTF
(
DRAMS‹
, "Switchingo…ower down state‡fter„efreshing"

2150 "„ªk %d‡ˆ%Îuick\n", 
¿nk
, 
	`curTick
());

2152 ià(
pwrS‹
 !ğ
PWR_SREF
) {

2155 
»äeshS‹
 = 
REF_IDLE
;

2159 ià(!
memÜy
.
ÃxtReqEv’t
.
	`scheduËd
()) {

2160 
	`DPRINTF
(
DRAM
, "Scheduling‚ext„equest‡fter„efreshing„ank %d\n",

2161 
¿nk
);

2162 
	`scheduË
(
memÜy
.
ÃxtReqEv’t
, 
	`curTick
());

2164 } ià(
pwrS‹
 =ğ
PWR_ACT
) {

2165 ià(
»äeshS‹
 =ğ
REF_PD_EXIT
) {

2167 
	`as£¹
(
´ev_¡©e
 =ğ
PWR_ACT_PDN
);

2170 
»äeshS‹
 = 
REF_PRE
;

2171 
	`scheduË
(
»äeshEv’t
, 
	`curTick
());

2173 } ià(
pwrS‹
 =ğ
PWR_IDLE
) {

2174 
	`DPRINTF
(
DRAMS‹
, "All banks…recharged\n");

2175 ià(
´ev_¡©e
 =ğ
PWR_SREF
) {

2180 
»äeshS‹
 = 
REF_SREF_EXIT
;

2181 
	`scheduË
(
»äeshEv’t
, 
	`curTick
(è+ 
memÜy
.
tXS
);

2185 ià((
»äeshS‹
 =ğ
REF_PRE
è|| (»äeshS‹ =ğ
REF_PD_EXIT
)) {

2190 ià(!
aùiv©eEv’t
.
	`scheduËd
()) {

2192 
	`as£¹
(!
pow”Ev’t
.
	`scheduËd
());

2194 
pwrS‹
 = 
PWR_REF
;

2198 
	`as£¹
(
´ech¬geEv’t
.
	`scheduËd
());

2208 ià(
pwrS‹
 =ğ
PWR_REF
) {

2209 
	`as£¹
(
»äeshS‹
 =ğ
REF_PRE
 ||„eäeshS‹ =ğ
REF_PD_EXIT
);

2210 
	`DPRINTF
(
DRAMS‹
, "Refreshing\n");

2215 ià(
»äeshS‹
 =ğ
REF_PD_EXIT
) {

2217 
	`scheduË
(
»äeshEv’t
, 
	`curTick
(è+ 
memÜy
.
tXP
);

2219 
	`scheduË
(
»äeshEv’t
, 
	`curTick
());

2222 
»äeshS‹
 = 
REF_START
;

2224 
	}
}

2227 
	gDRAMCŒl
::
Rªk
::
	$upd©ePow”Sts
()

2231 
	`æushCmdLi¡
();

2241 
pow”
.
pow”lib
.
	`upd©eCouÁ”s
(
çl£
);

2244 
pow”
.
pow”lib
.
	`ÿlcEÃrgy
();

2247 
D©a
::
MemÜyPow”Mod–
::
EÃrgy
 
’”gy
 =

2248 
pow”
.
pow”lib
.
	`g‘EÃrgy
();

2249 
D©a
::
MemÜyPow”Mod–
::
Pow”
 
¿nk_pow”
 =

2250 
pow”
.
pow”lib
.
	`g‘Pow”
();

2252 
aùEÃrgy
 = 
’”gy
.
aù_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2253 
´eEÃrgy
 = 
’”gy
.
´e_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2254 
»adEÃrgy
 = 
’”gy
.
»ad_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2255 
wr™eEÃrgy
 = 
’”gy
.
wr™e_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2256 
»äeshEÃrgy
 = 
’”gy
.
»f_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2257 
aùBackEÃrgy
 = 
’”gy
.
aù_¡dby_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2258 
´eBackEÃrgy
 = 
’”gy
.
´e_¡dby_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2259 
aùPow”DownEÃrgy
 = 
’”gy
.
f_aù_pd_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2260 
´ePow”DownEÃrgy
 = 
’”gy
.
f_´e_pd_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2261 
£lfReäeshEÃrgy
 = 
’”gy
.
¤ef_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2262 
tÙ®EÃrgy
 = 
’”gy
.
tÙ®_’”gy
 * 
memÜy
.
deviûsP”Rªk
;

2263 
av”agePow”
 = 
¿nk_pow”
.
av”age_pow”
 * 
memÜy
.
deviûsP”Rªk
;

2264 
	}
}

2267 
	gDRAMCŒl
::
Rªk
::
	$compu‹Sts
()

2269 
	`DPRINTF
(
DRAM
,"Computing final stats\n");

2273 
cmdLi¡
.
	`push_back
(
	`Commªd
(
MemCommªd
::
NOP
, 0, 
	`curTick
()));

2276 
	`upd©ePow”Sts
();

2279 
pwrS‹Time
[
pwrS‹
] +ğ(
	`curTick
(è- 
pwrS‹Tick
);

2280 
pwrS‹Tick
 = 
	`curTick
();

2282 
	}
}

2285 
	gDRAMCŒl
::
Rªk
::
	$»gSts
()

2287 
usšg
 
Çme¥aû
 
Sts
;

2289 
pwrS‹Time


2290 .
	`š™
(6)

2291 .
	`Çme
(name() + ".memoryStateTime")

2292 .
	`desc
("Time in different…ower states");

2293 
pwrS‹Time
.
	`subÇme
(0, "IDLE");

2294 
pwrS‹Time
.
	`subÇme
(1, "REF");

2295 
pwrS‹Time
.
	`subÇme
(2, "SREF");

2296 
pwrS‹Time
.
	`subÇme
(3, "PRE_PDN");

2297 
pwrS‹Time
.
	`subÇme
(4, "ACT");

2298 
pwrS‹Time
.
	`subÇme
(5, "ACT_PDN");

2300 
aùEÃrgy


2301 .
	`Çme
(name() + ".actEnergy")

2302 .
	`desc
("Energy for‡ctivate commands…er„ank (pJ)");

2304 
´eEÃrgy


2305 .
	`Çme
(name() + ".preEnergy")

2306 .
	`desc
("Energy for…recharge commands…er„ank (pJ)");

2308 
»adEÃrgy


2309 .
	`Çme
(name() + ".readEnergy")

2310 .
	`desc
("Energy for„ead commands…er„ank (pJ)");

2312 
wr™eEÃrgy


2313 .
	`Çme
(name() + ".writeEnergy")

2314 .
	`desc
("Energy for write commands…er„ank (pJ)");

2316 
»äeshEÃrgy


2317 .
	`Çme
(name() + ".refreshEnergy")

2318 .
	`desc
("Energy for„efresh commands…er„ank (pJ)");

2320 
aùBackEÃrgy


2321 .
	`Çme
(name() + ".actBackEnergy")

2322 .
	`desc
("Energy for‡ctive background…er„ank (pJ)");

2324 
´eBackEÃrgy


2325 .
	`Çme
(name() + ".preBackEnergy")

2326 .
	`desc
("Energy for…recharge background…er„ank (pJ)");

2328 
aùPow”DownEÃrgy


2329 .
	`Çme
(name() + ".actPowerDownEnergy")

2330 .
	`desc
("Energy for‡ctive…ower-down…er„ank (pJ)");

2332 
´ePow”DownEÃrgy


2333 .
	`Çme
(name() + ".prePowerDownEnergy")

2334 .
	`desc
("Energy for…recharge…ower-down…er„ank (pJ)");

2336 
£lfReäeshEÃrgy


2337 .
	`Çme
(name() + ".selfRefreshEnergy")

2338 .
	`desc
("Energy for self„efresh…er„ank (pJ)");

2340 
tÙ®EÃrgy


2341 .
	`Çme
(name() + ".totalEnergy")

2342 .
	`desc
("Totalƒnergy…er„ank (pJ)");

2344 
av”agePow”


2345 .
	`Çme
(name() + ".averagePower")

2346 .
	`desc
("Core…ower…er„ank (mW)");

2348 
tÙ®IdËTime


2349 .
	`Çme
(name() + ".totalIdleTime")

2350 .
	`desc
("Total Idleime Per DRAM Rank");

2352 
	`»gi¡”DumpC®lback
(
Ãw
 
	`RªkDumpC®lback
(
this
));

2353 
	}
}

2355 
	gDRAMCŒl
::
	$»gSts
()

2357 
usšg
 
Çme¥aû
 
Sts
;

2359 
Ab¡¿ùMemÜy
::
	`»gSts
();

2361 autØ
r
 : 
¿nks
) {

2362 
r
->
	`»gSts
();

2365 
»adReqs


2366 .
	`Çme
(name() + ".readReqs")

2367 .
	`desc
("Number of„ead„equests‡ccepted");

2369 
wr™eReqs


2370 .
	`Çme
(name() + ".writeReqs")

2371 .
	`desc
("Number of write„equests‡ccepted");

2373 
»adBur¡s


2374 .
	`Çme
(name() + ".readBursts")

2375 .
	`desc
("Number of DRAM„ead bursts, "

2378 
wr™eBur¡s


2379 .
	`Çme
(name() + ".writeBursts")

2380 .
	`desc
("Number of DRAM write bursts, "

2383 
£rviûdByWrQ


2384 .
	`Çme
(name() + ".servicedByWrQ")

2385 .
	`desc
("Number of DRAM„ead bursts serviced byhe write queue");

2387 
m”gedWrBur¡s


2388 .
	`Çme
(name() + ".mergedWrBursts")

2389 .
	`desc
("Number of DRAM write bursts merged with‡nƒxisting one");

2391 
Ã™h”R—dNÜWr™e


2392 .
	`Çme
(name() + ".neitherReadNorWriteReqs")

2393 .
	`desc
("Number of„equestshat‡re‚either„ead‚or write");

2395 
³rBªkRdBur¡s


2396 .
	`š™
(
bªksP”Rªk
 * 
¿nksP”ChªÃl
)

2397 .
	`Çme
(name() + ".perBankRdBursts")

2398 .
	`desc
("Per bank write bursts");

2400 
³rBªkWrBur¡s


2401 .
	`š™
(
bªksP”Rªk
 * 
¿nksP”ChªÃl
)

2402 .
	`Çme
(name() + ".perBankWrBursts")

2403 .
	`desc
("Per bank write bursts");

2405 
avgRdQL’


2406 .
	`Çme
(name() + ".avgRdQLen")

2407 .
	`desc
("Average„ead queue†ength whenƒnqueuing")

2408 .
	`´ecisiÚ
(2);

2410 
avgWrQL’


2411 .
	`Çme
(name() + ".avgWrQLen")

2412 .
	`desc
("Average write queue†ength whenƒnqueuing")

2413 .
	`´ecisiÚ
(2);

2415 
tÙQL©


2416 .
	`Çme
(name() + ".totQLat")

2417 .
	`desc
("Totalicks spent queuing");

2419 
tÙBusL©


2420 .
	`Çme
(name() + ".totBusLat")

2421 .
	`desc
("Totalicks spent in databusransfers");

2423 
tÙMemAccL©


2424 .
	`Çme
(name() + ".totMemAccLat")

2425 .
	`desc
("Totalicks spent from burst creation until serviced "

2428 
avgQL©


2429 .
	`Çme
(name() + ".avgQLat")

2430 .
	`desc
("Average queueing delay…er DRAM burst")

2431 .
	`´ecisiÚ
(2);

2433 
avgQL©
 = 
tÙQL©
 / (
»adBur¡s
 - 
£rviûdByWrQ
);

2435 
avgBusL©


2436 .
	`Çme
(name() + ".avgBusLat")

2437 .
	`desc
("Average bus†atency…er DRAM burst")

2438 .
	`´ecisiÚ
(2);

2440 
avgBusL©
 = 
tÙBusL©
 / (
»adBur¡s
 - 
£rviûdByWrQ
);

2442 
avgMemAccL©


2443 .
	`Çme
(name() + ".avgMemAccLat")

2444 .
	`desc
("Average memory‡ccess†atency…er DRAM burst")

2445 .
	`´ecisiÚ
(2);

2447 
avgMemAccL©
 = 
tÙMemAccL©
 / (
»adBur¡s
 - 
£rviûdByWrQ
);

2449 
numRdR‘ry


2450 .
	`Çme
(name() + ".numRdRetry")

2451 .
	`desc
("Number ofimes„ead queue was full causing„etry");

2453 
numWrR‘ry


2454 .
	`Çme
(name() + ".numWrRetry")

2455 .
	`desc
("Number ofimes write queue was full causing„etry");

2457 
»adRowH™s


2458 .
	`Çme
(name() + ".readRowHits")

2459 .
	`desc
("Number of„ow buffer hits during„eads");

2461 
wr™eRowH™s


2462 .
	`Çme
(name() + ".writeRowHits")

2463 .
	`desc
("Number of„ow buffer hits during writes");

2465 
»adRowH™R©e


2466 .
	`Çme
(name() + ".readRowHitRate")

2467 .
	`desc
("Row buffer hit„ate for„eads")

2468 .
	`´ecisiÚ
(2);

2470 
»adRowH™R©e
 = (
»adRowH™s
 / (
»adBur¡s
 - 
£rviûdByWrQ
)) * 100;

2472 
wr™eRowH™R©e


2473 .
	`Çme
(name() + ".writeRowHitRate")

2474 .
	`desc
("Row buffer hit„ate for writes")

2475 .
	`´ecisiÚ
(2);

2477 
wr™eRowH™R©e
 = (
wr™eRowH™s
 / (
wr™eBur¡s
 - 
m”gedWrBur¡s
)) * 100;

2479 
»adPktSize


2480 .
	`š™
(
	`ûLog2
(
bur¡Size
) + 1)

2481 .
	`Çme
(name() + ".readPktSize")

2482 .
	`desc
("Read„equest sizes (log2)");

2484 
wr™ePktSize


2485 .
	`š™
(
	`ûLog2
(
bur¡Size
) + 1)

2486 .
	`Çme
(name() + ".writePktSize")

2487 .
	`desc
("Write„equest sizes (log2)");

2489 
rdQL’Pdf


2490 .
	`š™
(
»adBufãrSize
)

2491 .
	`Çme
(name() + ".rdQLenPdf")

2492 .
	`desc
("What„ead queue†ength does‡n incoming„eq see");

2494 
wrQL’Pdf


2495 .
	`š™
(
wr™eBufãrSize
)

2496 .
	`Çme
(name() + ".wrQLenPdf")

2497 .
	`desc
("What write queue†ength does‡n incoming„eq see");

2499 
by‹sP”Aùiv©e


2500 .
	`š™
(
maxAcûs£sP”Row
)

2501 .
	`Çme
(name() + ".bytesPerActivate")

2502 .
	`desc
("Bytes‡ccessed…er„ow‡ctivation")

2503 .
	`æags
(
noz”o
);

2505 
rdP”TuºAround


2506 .
	`š™
(
»adBufãrSize
)

2507 .
	`Çme
(name() + ".rdPerTurnAround")

2508 .
	`desc
("Reads beforeurninghe bus‡round for writes")

2509 .
	`æags
(
noz”o
);

2511 
wrP”TuºAround


2512 .
	`š™
(
wr™eBufãrSize
)

2513 .
	`Çme
(name() + ".wrPerTurnAround")

2514 .
	`desc
("Writes beforeurninghe bus‡round for„eads")

2515 .
	`æags
(
noz”o
);

2517 
by‹sR—dDRAM


2518 .
	`Çme
(name() + ".bytesReadDRAM")

2519 .
	`desc
("Total‚umber of bytes„ead from DRAM");

2521 
by‹sR—dWrQ


2522 .
	`Çme
(name() + ".bytesReadWrQ")

2523 .
	`desc
("Total‚umber of bytes„ead from write queue");

2525 
by‹sWr™‹n


2526 .
	`Çme
(name() + ".bytesWritten")

2527 .
	`desc
("Total‚umber of bytes writteno DRAM");

2529 
by‹sR—dSys


2530 .
	`Çme
(name() + ".bytesReadSys")

2531 .
	`desc
("Total„ead bytes fromhe system interface side");

2533 
by‹sWr™‹nSys


2534 .
	`Çme
(name() + ".bytesWrittenSys")

2535 .
	`desc
("Total written bytes fromhe system interface side");

2537 
avgRdBW


2538 .
	`Çme
(name() + ".avgRdBW")

2539 .
	`desc
("Average DRAM„ead bandwidth in MiByte/s")

2540 .
	`´ecisiÚ
(2);

2542 
avgRdBW
 = (
by‹sR—dDRAM
 / 1000000è/ 
simSecÚds
;

2544 
avgWrBW


2545 .
	`Çme
(name() + ".avgWrBW")

2546 .
	`desc
("Average‡chieved write bandwidth in MiByte/s")

2547 .
	`´ecisiÚ
(2);

2549 
avgWrBW
 = (
by‹sWr™‹n
 / 1000000è/ 
simSecÚds
;

2551 
avgRdBWSys


2552 .
	`Çme
(name() + ".avgRdBWSys")

2553 .
	`desc
("Average system„ead bandwidth in MiByte/s")

2554 .
	`´ecisiÚ
(2);

2556 
avgRdBWSys
 = (
by‹sR—dSys
 / 1000000è/ 
simSecÚds
;

2558 
avgWrBWSys


2559 .
	`Çme
(name() + ".avgWrBWSys")

2560 .
	`desc
("Average system write bandwidth in MiByte/s")

2561 .
	`´ecisiÚ
(2);

2563 
avgWrBWSys
 = (
by‹sWr™‹nSys
 / 1000000è/ 
simSecÚds
;

2565 
³akBW


2566 .
	`Çme
(name() + ".peakBW")

2567 .
	`desc
("Theoretical…eak bandwidth in MiByte/s")

2568 .
	`´ecisiÚ
(2);

2570 
³akBW
 = (
SimClock
::
F»qu’cy
 / 
tBURST
è* 
bur¡Size
 / 1000000;

2572 
busUt


2573 .
	`Çme
(name() + ".busUtil")

2574 .
	`desc
("Data bus utilization in…ercentage")

2575 .
	`´ecisiÚ
(2);

2576 
busUt
 = (
avgRdBW
 + 
avgWrBW
è/ 
³akBW
 * 100;

2578 
tÙG­


2579 .
	`Çme
(name() + ".totGap")

2580 .
	`desc
("Total gap between„equests");

2582 
avgG­


2583 .
	`Çme
(name() + ".avgGap")

2584 .
	`desc
("Average gap between„equests")

2585 .
	`´ecisiÚ
(2);

2587 
avgG­
 = 
tÙG­
 / (
»adReqs
 + 
wr™eReqs
);

2590 
busUtR—d


2591 .
	`Çme
(name() + ".busUtilRead")

2592 .
	`desc
("Data bus utilization in…ercentage for„eads")

2593 .
	`´ecisiÚ
(2);

2595 
busUtR—d
 = 
avgRdBW
 / 
³akBW
 * 100;

2597 
busUtWr™e


2598 .
	`Çme
(name() + ".busUtilWrite")

2599 .
	`desc
("Data bus utilization in…ercentage for writes")

2600 .
	`´ecisiÚ
(2);

2602 
busUtWr™e
 = 
avgWrBW
 / 
³akBW
 * 100;

2604 
·geH™R©e


2605 .
	`Çme
(name() + ".pageHitRate")

2606 .
	`desc
("Row buffer hit„ate,„ead‡nd write combined")

2607 .
	`´ecisiÚ
(2);

2609 
·geH™R©e
 = (
wr™eRowH™s
 + 
»adRowH™s
) /

2610 (
wr™eBur¡s
 - 
m”gedWrBur¡s
 + 
»adBur¡s
 - 
£rviûdByWrQ
) * 100;

2611 
	}
}

2614 
	gDRAMCŒl
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

2617 
	`funùiÚ®Acûss
(
pkt
);

2618 
	}
}

2620 
	gBa£SÏvePÜt
&

2621 
	gDRAMCŒl
::
	$g‘SÏvePÜt
(cÚ¡ 
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

2623 ià(
if_Çme
 != "port") {

2624  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

2626  
pÜt
;

2628 
	}
}

2630 
D¿šS‹


2631 
	gDRAMCŒl
::
	$d¿š
()

2635 ià(!(
wr™eQueue
.
	`em±y
(è&& 
»adQueue
.em±y(è&& 
»¥Queue
.empty() &&

2636 
	`®lRªksD¿šed
())) {

2638 
	`DPRINTF
(
D¿š
, "DRAM controller‚ot drained, write: %d,„ead: %d,"

2639 "„e¥: %d\n", 
wr™eQueue
.
	`size
(), 
»adQueue
.size(),

2640 
»¥Queue
.
	`size
());

2644 ià(!
wr™eQueue
.
	`em±y
(è&& !
ÃxtReqEv’t
.
	`scheduËd
()) {

2645 
	`scheduË
(
ÃxtReqEv’t
, 
	`curTick
());

2649 autØ
r
 : 
¿nks
) {

2651 ià(
r
->
pwrS‹
 =ğ
PWR_SREF
) {

2652 
	`DPRINTF
(
DRAM
,"Rank%d: Forcing self-refresh wakeup in drain\n",

2653 
r
->
¿nk
);

2654 
r
->
	`scheduËWakeUpEv’t
(
tXS
);

2658  
D¿šS‹
::
D¿ššg
;

2660  
D¿šS‹
::
D¿šed
;

2662 
	}
}

2664 
boŞ


2665 
	gDRAMCŒl
::
	$®lRªksD¿šed
() const

2668 
boŞ
 
®l_¿nks_d¿šed
 = 
Œue
;

2669 autØ
r
 : 
¿nks
) {

2672 
®l_¿nks_d¿šed
 = 
r
->
	`šPwrIdËS‹
() &&‡ll_ranks_drained;

2674  
®l_¿nks_d¿šed
;

2675 
	}
}

2678 
	gDRAMCŒl
::
	$d¿šResume
()

2680 ià(!
isTimšgMode
 && 
	`sy¡em
()->
	`isTimšgMode
()) {

2683 
	`¡¬tup
();

2684 } ià(
isTimšgMode
 && !
	`sy¡em
()->
	`isTimšgMode
()) {

2687 autØ
r
 : 
¿nks
) {

2688 
r
->
	`su¥’d
();

2693 
isTimšgMode
 = 
	`sy¡em
()->
	`isTimšgMode
();

2694 
	}
}

2696 
	gDRAMCŒl
::
MemÜyPÜt
::
	$MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
DRAMCŒl
& 
_memÜy
)

2697 : 
	`QueuedSÏvePÜt
(
Çme
, &
_memÜy
, 
queue
), 
	`queue
(_memÜy, *
this
),

2698 
	$memÜy
(
_memÜy
)

2699 { 
	}
}

2701 
AddrRªgeLi¡


2702 
	gDRAMCŒl
::
MemÜyPÜt
::
	$g‘AddrRªges
() const

2704 
AddrRªgeLi¡
 
¿nges
;

2705 
¿nges
.
	`push_back
(
memÜy
.
	`g‘AddrRªge
());

2706  
¿nges
;

2707 
	}
}

2710 
	gDRAMCŒl
::
MemÜyPÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

2712 
pkt
->
	`pushLab–
(
memÜy
.
	`Çme
());

2714 ià(!
queue
.
	`checkFunùiÚ®
(
pkt
)) {

2718 
memÜy
.
	`»cvFunùiÚ®
(
pkt
);

2721 
pkt
->
	`pİLab–
();

2722 
	}
}

2724 
Tick


2725 
	gDRAMCŒl
::
MemÜyPÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

2727  
memÜy
.
	`»cvAtomic
(
pkt
);

2728 
	}
}

2730 
boŞ


2731 
	gDRAMCŒl
::
MemÜyPÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

2734  
memÜy
.
	`»cvTimšgReq
(
pkt
);

2735 
	}
}

2737 
DRAMCŒl
*

2738 
	gDRAMCŒlP¬ams
::
	$ü—‹
()

2740  
Ãw
 
	`DRAMCŒl
(
this
);

2741 
	}
}

	@dram_ctrl.hh

53 #iâdeà
__MEM_DRAM_CTRL_HH__


54 
	#__MEM_DRAM_CTRL_HH__


	)

56 
	~<deque
>

57 
	~<¡ršg
>

58 
	~<unÜd”ed_£t
>

60 
	~"ba£/ÿÎback.hh
"

61 
	~"ba£/¡©i¡ics.hh
"

62 
	~"’ums/AddrM­.hh
"

63 
	~"’ums/MemSched.hh
"

64 
	~"’ums/PageMªage.hh
"

65 
	~"mem/ab¡¿ù_mem.hh
"

66 
	~"mem/qpÜt.hh
"

67 
	~"·¿ms/DRAMCŒl.hh
"

68 
	~"sim/ev’tq.hh
"

69 
	~"mem/d¿mpow”.hh
"

96 şas 
	cDRAMCŒl
 : 
public
 
Ab¡¿ùMemÜy


99 
´iv©e
:

103 şas 
	cMemÜyPÜt
 : 
public
 
QueuedSÏvePÜt


106 
Re¥Pack‘Queue
 
queue
;

107 
	mDRAMCŒl
& 
	mmemÜy
;

109 
	mpublic
:

111 
MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
DRAMCŒl
& 
_memÜy
);

113 
	m´Ùeùed
:

115 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

117 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

119 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
);

121 
vœtu®
 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

129 
MemÜyPÜt
 
	gpÜt
;

134 
boŞ
 
	gisTimšgMode
;

139 
boŞ
 
	g»ŒyRdReq
;

140 
boŞ
 
	g»ŒyWrReq
;

146 
	eBusS‹
 {

147 
	gREAD
 = 0,

148 
	gWRITE
,

151 
BusS‹
 
	gbusS‹
;

154 
BusS‹
 
	gbusS‹Next
;

160 
	sCommªd
 {

161 
	gD©a
::
MemCommªd
::
cmds
 
ty³
;

162 
ušt8_t
 
	gbªk
;

163 
Tick
 
	gtimeSmp
;

165 
cÚ¡ex´
 
Commªd
(
D©a
::
MemCommªd
::
cmds
 
_ty³
, 
ušt8_t
 
_bªk
,

166 
Tick
 
time_¡amp
)

167 : 
ty³
(
_ty³
), 
bªk
(
_bªk
), 
timeSmp
(
time_¡amp
)

180 şas 
	cBªk


183 
	gpublic
:

185 cÚ¡ 
ušt32_t
 
NO_ROW
 = -1;

187 
ušt32_t
 
	gİ’Row
;

188 
ušt8_t
 
	gbªk
;

189 
ušt8_t
 
	gbªkgr
;

191 
Tick
 
	gcŞAÎowedAt
;

192 
Tick
 
	g´eAÎowedAt
;

193 
Tick
 
	gaùAÎowedAt
;

195 
ušt32_t
 
	growAcûs£s
;

196 
ušt32_t
 
	gby‹sAcûs£d
;

198 
Bªk
() :

199 
İ’Row
(
NO_ROW
), 
bªk
(0), 
bªkgr
(0),

200 
cŞAÎowedAt
(0), 
´eAÎowedAt
(0), 
aùAÎowedAt
(0),

201 
rowAcûs£s
(0), 
by‹sAcûs£d
(0)

233 
	ePow”S‹
 {

234 
	gPWR_IDLE
 = 0,

235 
	gPWR_REF
,

236 
	gPWR_SREF
,

237 
	gPWR_PRE_PDN
,

238 
	gPWR_ACT
,

239 
	gPWR_ACT_PDN


272 
	eReäeshS‹
 {

273 
	gREF_IDLE
 = 0,

274 
	gREF_DRAIN
,

275 
	gREF_PD_EXIT
,

276 
	gREF_SREF_EXIT
,

277 
	gREF_PRE
,

278 
	gREF_START
,

279 
	gREF_RUN


289 şas 
	cRªk
 : 
public
 
Ev’tMªag”


292 
´iv©e
:

297 
DRAMCŒl
& 
memÜy
;

303 
Pow”S‹
 
	gpwrS‹T¿ns
;

308 
Pow”S‹
 
	gpwrS‹Po¡Reäesh
;

313 
Tick
 
	gpwrS‹Tick
;

318 
Tick
 
	g»äeshDueAt
;

323 
	gSts
::
SÿÏr
 
aùEÃrgy
;

324 
	gSts
::
SÿÏr
 
´eEÃrgy
;

325 
	gSts
::
SÿÏr
 
»adEÃrgy
;

326 
	gSts
::
SÿÏr
 
wr™eEÃrgy
;

327 
	gSts
::
SÿÏr
 
»äeshEÃrgy
;

332 
	gSts
::
SÿÏr
 
aùBackEÃrgy
;

337 
	gSts
::
SÿÏr
 
´eBackEÃrgy
;

342 
	gSts
::
SÿÏr
 
aùPow”DownEÃrgy
;

347 
	gSts
::
SÿÏr
 
´ePow”DownEÃrgy
;

352 
	gSts
::
SÿÏr
 
£lfReäeshEÃrgy
;

354 
	gSts
::
SÿÏr
 
tÙ®EÃrgy
;

355 
	gSts
::
SÿÏr
 
av”agePow”
;

361 
	gSts
::
SÿÏr
 
tÙ®IdËTime
;

366 
	gSts
::
VeùÜ
 
pwrS‹Time
;

371 
upd©ePow”Sts
();

380 
scheduËPow”Ev’t
(
Pow”S‹
 
pwr_¡©e
, 
Tick
 
tick
);

382 
	gpublic
:

387 
Pow”S‹
 
pwrS‹
;

392 
ReäeshS‹
 
	g»äeshS‹
;

397 
boŞ
 
	gšLowPow”S‹
;

402 
ušt8_t
 
	g¿nk
;

407 
ušt32_t
 
	g»adEÁr›s
;

412 
ušt32_t
 
	gwr™eEÁr›s
;

419 
ušt8_t
 
	gout¡ªdšgEv’ts
;

424 
Tick
 
	gwakeUpAÎowedAt
;

429 
DRAMPow”
 
	gpow”
;

437 
	g¡d
::
veùÜ
<
Commªd
> 
cmdLi¡
;

443 
	g¡d
::
veùÜ
<
Bªk
> 
bªks
;

449 
	gnumBªksAùive
;

452 
	g¡d
::
deque
<
Tick
> 
aùTicks
;

454 
Rªk
(
DRAMCŒl
& 
_memÜy
, cÚ¡ 
DRAMCŒlP¬ams
* 
_p
);

456 cÚ¡ 
	g¡d
::
¡ršg
 
Çme
() const

458  
c¥rštf
("%s_%d", 
memÜy
.
Çme
(), 
¿nk
);

467 
¡¬tup
(
Tick
 
»f_tick
);

472 
su¥’d
();

483 
boŞ
 
isAvaabË
(ècÚ¡ {  
	g»äeshS‹
 =ğ
REF_IDLE
; }

492 
boŞ
 
šPwrIdËS‹
(ècÚ¡ {  
	gpwrS‹
 =ğ
PWR_IDLE
; }

504 
boŞ
 
fÜûS–fReäeshEx™
() const {

505  (
	g»adEÁr›s
 != 0) ||

506 ((
memÜy
.
busS‹Next
 =ğ
WRITE
è&& (
wr™eEÁr›s
 != 0));

515 
boŞ
 
lowPow”EÁryR—dy
() const;

521 
checkD¿šDÚe
();

529 
æushCmdLi¡
();

534 
»gSts
();

539 
compu‹Sts
();

547 
pow”DownSË•
(
Pow”S‹
 
pwr_¡©e
, 
Tick
 
tick
);

556 
scheduËWakeUpEv’t
(
Tick
 
ex™_d–ay
);

558 
´oûssWr™eDÚeEv’t
();

559 
	gEv’tW¿µ”
<
	gRªk
, &Rªk::
´oûssWr™eDÚeEv’t
>

560 
wr™eDÚeEv’t
;

562 
´oûssAùiv©eEv’t
();

563 
	gEv’tW¿µ”
<
	gRªk
, &Rªk::
´oûssAùiv©eEv’t
>

564 
aùiv©eEv’t
;

566 
´oûssP»ch¬geEv’t
();

567 
	gEv’tW¿µ”
<
	gRªk
, &Rªk::
´oûssP»ch¬geEv’t
>

568 
´ech¬geEv’t
;

570 
´oûssReäeshEv’t
();

571 
	gEv’tW¿µ”
<
	gRªk
, &Rªk::
´oûssReäeshEv’t
>

572 
»äeshEv’t
;

574 
´oûssPow”Ev’t
();

575 
	gEv’tW¿µ”
<
	gRªk
, &Rªk::
´oûssPow”Ev’t
>

576 
pow”Ev’t
;

578 
´oûssWakeUpEv’t
();

579 
	gEv’tW¿µ”
<
	gRªk
, &Rªk::
´oûssWakeUpEv’t
>

580 
wakeUpEv’t
;

588 şas 
	cRªkDumpC®lback
 : 
public
 
C®lback


590 
Rªk
 *
¿nks
;

591 
	gpublic
:

592 
RªkDumpC®lback
(
Rªk
 *
r
è: 
¿nks
(r) {}

593 
vœtu®
 
´oûss
(è{ 
¿nks
->
compu‹Sts
(); };

602 şas 
	cBur¡H–³r
 {

604 
	gpublic
:

607 cÚ¡ 
bur¡CouÁ
;

610 
	gbur¡sS”viûd
;

612 
Bur¡H–³r
(
_bur¡CouÁ
)

613 : 
bur¡CouÁ
(
_bur¡CouÁ
), 
bur¡sS”viûd
(0)

621 şas 
	cDRAMPack‘
 {

623 
	gpublic
:

626 cÚ¡ 
Tick
 
’ŒyTime
;

629 
Tick
 
	g»adyTime
;

632 cÚ¡ 
Pack‘PŒ
 
	gpkt
;

634 cÚ¡ 
boŞ
 
	gisR—d
;

637 cÚ¡ 
ušt8_t
 
	g¿nk
;

638 cÚ¡ 
ušt8_t
 
	gbªk
;

639 cÚ¡ 
ušt32_t
 
	grow
;

646 cÚ¡ 
ušt16_t
 
	gbªkId
;

654 
Addr
 
	gaddr
;

660 
	gsize
;

666 
Bur¡H–³r
* 
	gbur¡H–³r
;

667 
	gBªk
& 
	gbªkRef
;

668 
	gRªk
& 
	g¿nkRef
;

670 
DRAMPack‘
(
Pack‘PŒ
 
_pkt
, 
boŞ
 
is_»ad
, 
ušt8_t
 
_¿nk
, ušt8_ˆ
_bªk
,

671 
ušt32_t
 
_row
, 
ušt16_t
 
bªk_id
, 
Addr
 
_addr
,

672 
_size
, 
Bªk
& 
bªk_»f
, 
Rªk
& 
¿nk_»f
)

673 : 
’ŒyTime
(
curTick
()), 
»adyTime
(curTick()),

674 
pkt
(
_pkt
), 
isR—d
(
is_»ad
), 
¿nk
(
_¿nk
), 
bªk
(
_bªk
), 
row
(
_row
),

675 
bªkId
(
bªk_id
), 
addr
(
_addr
), 
size
(
_size
), 
bur¡H–³r
(
NULL
),

676 
bªkRef
(
bªk_»f
), 
¿nkRef
(
¿nk_»f
)

687 
´oûssNextReqEv’t
();

688 
	gEv’tW¿µ”
<
	gDRAMCŒl
,&DRAMCŒl::
´oûssNextReqEv’t
> 
ÃxtReqEv’t
;

690 
´oûssRe¥ÚdEv’t
();

691 
	gEv’tW¿µ”
<
	gDRAMCŒl
, &DRAMCŒl::
´oûssRe¥ÚdEv’t
> 
»¥ÚdEv’t
;

699 
boŞ
 
	$»adQueueFuÎ
(
pktCouÁ
) const;

707 
boŞ
 
	$wr™eQueueFuÎ
(
pktCouÁ
) const;

723 
	`addToR—dQueue
(
Pack‘PŒ
 
pkt
, 
pktCouÁ
);

736 
	`addToWr™eQueue
(
Pack‘PŒ
 
pkt
, 
pktCouÁ
);

748 
	`doDRAMAcûss
(
DRAMPack‘
* 
d¿m_pkt
);

759 
	`acûssAndRe¥Úd
(
Pack‘PŒ
 
pkt
, 
Tick
 
¡©ic_Ï‹ncy
);

773 
DRAMPack‘
* 
	`decodeAddr
(
Pack‘PŒ
 
pkt
, 
Addr
 
d¿mPktAddr
, 
size
,

774 
boŞ
 
isR—d
);

788 
boŞ
 
	`choo£Next
(
¡d
::
deque
<
DRAMPack‘
*>& 
queue
, 
Tick
 
exŒa_cŞ_d–ay
);

799 
boŞ
 
	`»Üd”Queue
(
¡d
::
deque
<
DRAMPack‘
*>& 
queue
, 
Tick
 
exŒa_cŞ_d–ay
);

811 
¡d
::
·œ
<
ušt64_t
, 
boŞ
> 
	`mšBªkP»p
(cÚ¡ std::
deque
<
DRAMPack‘
*>& 
queue
,

812 
Tick
 
mš_cŞ_©
) const;

825 
	`aùiv©eBªk
(
Rªk
& 
¿nk_»f
, 
Bªk
& 
bªk_»f
, 
Tick
 
aù_tick
,

826 
ušt32_t
 
row
);

838 
	`´ech¬geBªk
(
Rªk
& 
¿nk_»f
, 
Bªk
& 
bªk_»f
,

839 
Tick
 
´e_©
, 
boŞ
 
Œaû
 = 
Œue
);

844 
	$´štQs
() const;

853 
Addr
 
	$bur¡Align
(
Addr
 
addr
ècÚ¡ {  (add¸& ~(
	`Addr
(
bur¡Size
 - 1))); 
	}
}

858 
	g¡d
::
deque
<
DRAMPack‘
*> 
»adQueue
;

859 
	g¡d
::
deque
<
DRAMPack‘
*> 
wr™eQueue
;

868 
	g¡d
::
unÜd”ed_£t
<
Addr
> 
isInWr™eQueue
;

878 
	g¡d
::
deque
<
DRAMPack‘
*> 
»¥Queue
;

883 
	g¡d
::
veùÜ
<
Rªk
*> 
¿nks
;

891 cÚ¡ 
ušt32_t
 
	gdeviûSize
;

892 cÚ¡ 
ušt32_t
 
	gdeviûBusWidth
;

893 cÚ¡ 
ušt32_t
 
	gbur¡L’gth
;

894 cÚ¡ 
ušt32_t
 
	gdeviûRowBufãrSize
;

895 cÚ¡ 
ušt32_t
 
	gdeviûsP”Rªk
;

896 cÚ¡ 
ušt32_t
 
	gbur¡Size
;

897 cÚ¡ 
ušt32_t
 
	growBufãrSize
;

898 cÚ¡ 
ušt32_t
 
	gcŞumnsP”RowBufãr
;

899 cÚ¡ 
ušt32_t
 
	gcŞumnsP”SŒe
;

900 cÚ¡ 
ušt32_t
 
	g¿nksP”ChªÃl
;

901 cÚ¡ 
ušt32_t
 
	gbªkGroupsP”Rªk
;

902 cÚ¡ 
boŞ
 
	gbªkGroupArch
;

903 cÚ¡ 
ušt32_t
 
	gbªksP”Rªk
;

904 cÚ¡ 
ušt32_t
 
	gchªÃls
;

905 
ušt32_t
 
	growsP”Bªk
;

906 cÚ¡ 
ušt32_t
 
	g»adBufãrSize
;

907 cÚ¡ 
ušt32_t
 
	gwr™eBufãrSize
;

908 cÚ¡ 
ušt32_t
 
	gwr™eHighTh»shŞd
;

909 cÚ¡ 
ušt32_t
 
	gwr™eLowTh»shŞd
;

910 cÚ¡ 
ušt32_t
 
	gmšWr™esP”Sw™ch
;

911 
ušt32_t
 
	gwr™esThisTime
;

912 
ušt32_t
 
	g»adsThisTime
;

918 cÚ¡ 
Tick
 
M5_CLASS_VAR_USED
 
	gtCK
;

919 cÚ¡ 
Tick
 
	gtWTR
;

920 cÚ¡ 
Tick
 
	gtRTW
;

921 cÚ¡ 
Tick
 
	gtCS
;

922 cÚ¡ 
Tick
 
	gtBURST
;

923 cÚ¡ 
Tick
 
	gtCCD_L
;

924 cÚ¡ 
Tick
 
	gtRCD
;

925 cÚ¡ 
Tick
 
	gtCL
;

926 cÚ¡ 
Tick
 
	gtRP
;

927 cÚ¡ 
Tick
 
	gtRAS
;

928 cÚ¡ 
Tick
 
	gtWR
;

929 cÚ¡ 
Tick
 
	gtRTP
;

930 cÚ¡ 
Tick
 
	gtRFC
;

931 cÚ¡ 
Tick
 
	gtREFI
;

932 cÚ¡ 
Tick
 
	gtRRD
;

933 cÚ¡ 
Tick
 
	gtRRD_L
;

934 cÚ¡ 
Tick
 
	gtXAW
;

935 cÚ¡ 
Tick
 
	gtXP
;

936 cÚ¡ 
Tick
 
	gtXS
;

937 cÚ¡ 
ušt32_t
 
	gaùiv©iÚLim™
;

943 
	gEnums
::
MemSched
 
memSchedPŞicy
;

944 
	gEnums
::
AddrM­
 
addrM­pšg
;

945 
	gEnums
::
PageMªage
 
·geMgmt
;

951 cÚ¡ 
ušt32_t
 
	gmaxAcûs£sP”Row
;

958 cÚ¡ 
Tick
 
	gäÚ‹ndL©’cy
;

965 cÚ¡ 
Tick
 
	gback’dL©’cy
;

970 
Tick
 
	gbusBusyUÁ
;

972 
Tick
 
	g´evA¼iv®
;

980 
Tick
 
	gÃxtReqTime
;

983 
	gSts
::
SÿÏr
 
»adReqs
;

984 
	gSts
::
SÿÏr
 
wr™eReqs
;

985 
	gSts
::
SÿÏr
 
»adBur¡s
;

986 
	gSts
::
SÿÏr
 
wr™eBur¡s
;

987 
	gSts
::
SÿÏr
 
by‹sR—dDRAM
;

988 
	gSts
::
SÿÏr
 
by‹sR—dWrQ
;

989 
	gSts
::
SÿÏr
 
by‹sWr™‹n
;

990 
	gSts
::
SÿÏr
 
by‹sR—dSys
;

991 
	gSts
::
SÿÏr
 
by‹sWr™‹nSys
;

992 
	gSts
::
SÿÏr
 
£rviûdByWrQ
;

993 
	gSts
::
SÿÏr
 
m”gedWrBur¡s
;

994 
	gSts
::
SÿÏr
 
Ã™h”R—dNÜWr™e
;

995 
	gSts
::
VeùÜ
 
³rBªkRdBur¡s
;

996 
	gSts
::
VeùÜ
 
³rBªkWrBur¡s
;

997 
	gSts
::
SÿÏr
 
numRdR‘ry
;

998 
	gSts
::
SÿÏr
 
numWrR‘ry
;

999 
	gSts
::
SÿÏr
 
tÙG­
;

1000 
	gSts
::
VeùÜ
 
»adPktSize
;

1001 
	gSts
::
VeùÜ
 
wr™ePktSize
;

1002 
	gSts
::
VeùÜ
 
rdQL’Pdf
;

1003 
	gSts
::
VeùÜ
 
wrQL’Pdf
;

1004 
	gSts
::
Hi¡og¿m
 
by‹sP”Aùiv©e
;

1005 
	gSts
::
Hi¡og¿m
 
rdP”TuºAround
;

1006 
	gSts
::
Hi¡og¿m
 
wrP”TuºAround
;

1009 
	gSts
::
SÿÏr
 
tÙQL©
;

1010 
	gSts
::
SÿÏr
 
tÙMemAccL©
;

1011 
	gSts
::
SÿÏr
 
tÙBusL©
;

1014 
	gSts
::
FÜmuÏ
 
avgQL©
;

1015 
	gSts
::
FÜmuÏ
 
avgBusL©
;

1016 
	gSts
::
FÜmuÏ
 
avgMemAccL©
;

1019 
	gSts
::
FÜmuÏ
 
avgRdBW
;

1020 
	gSts
::
FÜmuÏ
 
avgWrBW
;

1021 
	gSts
::
FÜmuÏ
 
avgRdBWSys
;

1022 
	gSts
::
FÜmuÏ
 
avgWrBWSys
;

1023 
	gSts
::
FÜmuÏ
 
³akBW
;

1024 
	gSts
::
FÜmuÏ
 
busUt
;

1025 
	gSts
::
FÜmuÏ
 
busUtR—d
;

1026 
	gSts
::
FÜmuÏ
 
busUtWr™e
;

1029 
	gSts
::
Av”age
 
avgRdQL’
;

1030 
	gSts
::
Av”age
 
avgWrQL’
;

1033 
	gSts
::
SÿÏr
 
»adRowH™s
;

1034 
	gSts
::
SÿÏr
 
wr™eRowH™s
;

1035 
	gSts
::
FÜmuÏ
 
»adRowH™R©e
;

1036 
	gSts
::
FÜmuÏ
 
wr™eRowH™R©e
;

1037 
	gSts
::
FÜmuÏ
 
avgG­
;

1040 
	gSts
::
FÜmuÏ
 
·geH™R©e
;

1043 
ušt8_t
 
	gaùiveRªk
;

1046 
ušt64_t
 
	gtimeSmpOff£t
;

1052 
	g¡d
::
unique_±r
<
Pack‘
> 
³ndšgD–‘e
;

1063 
upd©ePow”Sts
(
Rªk
& 
¿nk_»f
);

1072 
boŞ
 
	$sÜtTime
(cÚ¡ 
Commªd
& 
cmd
, cÚ¡ Commªd& 
cmd_Ãxt
) {

1073  
cmd
.
timeSmp
 < 
cmd_Ãxt
.timeStamp;

1074 
	}
};

1076 
	gpublic
:

1078 
	$»gSts
(è
ov”ride
;

1080 
	`DRAMCŒl
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
);

1082 
D¿šS‹
 
	$d¿š
(è
ov”ride
;

1084 
vœtu®
 
Ba£SÏvePÜt
& 
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

1085 
PÜtID
 
idx
 = 
Inv®idPÜtID
è
ov”ride
;

1087 
vœtu®
 
	$š™
(è
ov”ride
;

1088 
vœtu®
 
	$¡¬tup
(è
ov”ride
;

1089 
vœtu®
 
	$d¿šResume
(è
ov”ride
;

1100 
boŞ
 
	$®lRªksD¿šed
() const;

1102 
´Ùeùed
:

1104 
Tick
 
	`»cvAtomic
(
Pack‘PŒ
 
pkt
);

1105 
	`»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

1106 
boŞ
 
	`»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

1108 
	}
};

	@drampower.cc

40 
	~"ba£/štm©h.hh
"

41 
	~"mem/d¿mpow”.hh
"

42 
	~"sim/cÜe.hh
"

44 
usšg
 
Çme¥aû
 
	gD©a
;

46 
	gDRAMPow”
::
	$DRAMPow”
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
, 
boŞ
 
šşude_io
) :

47 
	`pow”lib
(
	`libDRAMPow”
(
	`g‘MemS³c
(
p
), 
šşude_io
))

49 
	}
}

51 
	gD©a
::
MemArch™eùu»S³c


52 
DRAMPow”
::
	$g‘ArchP¬ams
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
)

54 
D©a
::
MemArch™eùu»S³c
 
¬chS³c
;

55 
¬chS³c
.
bur¡L’gth
 = 
p
->
bur¡_Ëngth
;

56 
¬chS³c
.
nbrOfBªks
 = 
p
->
bªks_³r_¿nk
;

58 
¬chS³c
.
nbrOfRªks
 = 1;

59 
¬chS³c
.
d©aR©e
 = 
	`g‘D©aR©e
(
p
);

62 
¬chS³c
.
nbrOfCŞumns
 = 0;

63 
¬chS³c
.
nbrOfRows
 = 0;

64 
¬chS³c
.
width
 = 
p
->
deviû_bus_width
;

65 
¬chS³c
.
nbrOfBªkGroups
 = 
p
->
bªk_groups_³r_¿nk
;

66 
¬chS³c
.
dÎ
 = 
p
->dll;

67 
¬chS³c
.
twoVŞgeDomašs
 = 
	`hasTwoVDD
(
p
);

69 
¬chS³c
.
‹rmš©iÚ
 = 
çl£
;

70  
¬chS³c
;

71 
	}
}

73 
	gD©a
::
MemTimšgS³c


74 
DRAMPow”
::
	$g‘TimšgP¬ams
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
)

80 
D©a
::
MemTimšgS³c
 
timšgS³c
;

81 
timšgS³c
.
RC
 = 
	`divCe
((
p
->
tRAS
 +…->
tRP
),…->
tCK
);

82 
timšgS³c
.
RCD
 = 
	`divCe
(
p
->
tRCD
,…->
tCK
);

83 
timšgS³c
.
RL
 = 
	`divCe
(
p
->
tCL
,…->
tCK
);

84 
timšgS³c
.
RP
 = 
	`divCe
(
p
->
tRP
,…->
tCK
);

85 
timšgS³c
.
RFC
 = 
	`divCe
(
p
->
tRFC
,…->
tCK
);

86 
timšgS³c
.
RAS
 = 
	`divCe
(
p
->
tRAS
,…->
tCK
);

89 
timšgS³c
.
WL
 =imšgS³c.
RL
 - 1;

90 
timšgS³c
.
DQSCK
 = 0;

91 
timšgS³c
.
RTP
 = 
	`divCe
(
p
->
tRTP
,…->
tCK
);

92 
timšgS³c
.
WR
 = 
	`divCe
(
p
->
tWR
,…->
tCK
);

93 
timšgS³c
.
XP
 = 
	`divCe
(
p
->
tXP
,…->
tCK
);

94 
timšgS³c
.
XPDLL
 = 
	`divCe
(
p
->
tXPDLL
,…->
tCK
);

95 
timšgS³c
.
XS
 = 
	`divCe
(
p
->
tXS
,…->
tCK
);

96 
timšgS³c
.
XSDLL
 = 
	`divCe
(
p
->
tXSDLL
,…->
tCK
);

99 
timšgS³c
.
şkP”iod
 = (
p
->
tCK
 / ()(
SimClock
::
IÁ
::
ns
));

100 
	`as£¹
(
timšgS³c
.
şkP”iod
 != 0);

101 
timšgS³c
.
şkMhz
 = (1 /imšgS³c.
şkP”iod
) * 1000;

102  
timšgS³c
;

103 
	}
}

105 
	gD©a
::
MemPow”S³c


106 
DRAMPow”
::
	$g‘Pow”P¬ams
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
)

109 
D©a
::
MemPow”S³c
 
pow”S³c
;

110 
pow”S³c
.
idd0
 = 
p
->
IDD0
 * 1000;

111 
pow”S³c
.
idd02
 = 
p
->
IDD02
 * 1000;

112 
pow”S³c
.
idd2p0
 = 
p
->
IDD2P0
 * 1000;

113 
pow”S³c
.
idd2p02
 = 
p
->
IDD2P02
 * 1000;

114 
pow”S³c
.
idd2p1
 = 
p
->
IDD2P1
 * 1000;

115 
pow”S³c
.
idd2p12
 = 
p
->
IDD2P12
 * 1000;

116 
pow”S³c
.
idd2n
 = 
p
->
IDD2N
 * 1000;

117 
pow”S³c
.
idd2n2
 = 
p
->
IDD2N2
 * 1000;

118 
pow”S³c
.
idd3p0
 = 
p
->
IDD3P0
 * 1000;

119 
pow”S³c
.
idd3p02
 = 
p
->
IDD3P02
 * 1000;

120 
pow”S³c
.
idd3p1
 = 
p
->
IDD3P1
 * 1000;

121 
pow”S³c
.
idd3p12
 = 
p
->
IDD3P12
 * 1000;

122 
pow”S³c
.
idd3n
 = 
p
->
IDD3N
 * 1000;

123 
pow”S³c
.
idd3n2
 = 
p
->
IDD3N2
 * 1000;

124 
pow”S³c
.
idd4r
 = 
p
->
IDD4R
 * 1000;

125 
pow”S³c
.
idd4r2
 = 
p
->
IDD4R2
 * 1000;

126 
pow”S³c
.
idd4w
 = 
p
->
IDD4W
 * 1000;

127 
pow”S³c
.
idd4w2
 = 
p
->
IDD4W2
 * 1000;

128 
pow”S³c
.
idd5
 = 
p
->
IDD5
 * 1000;

129 
pow”S³c
.
idd52
 = 
p
->
IDD52
 * 1000;

130 
pow”S³c
.
idd6
 = 
p
->
IDD6
 * 1000;

131 
pow”S³c
.
idd62
 = 
p
->
IDD62
 * 1000;

132 
pow”S³c
.
vdd
 = 
p
->
VDD
;

133 
pow”S³c
.
vdd2
 = 
p
->
VDD2
;

134  
pow”S³c
;

135 
	}
}

137 
	gD©a
::
MemÜyS³cifiÿtiÚ


138 
DRAMPow”
::
	$g‘MemS³c
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
)

140 
D©a
::
MemÜyS³cifiÿtiÚ
 
memS³c
;

141 
memS³c
.
memArchS³c
 = 
	`g‘ArchP¬ams
(
p
);

142 
memS³c
.
memTimšgS³c
 = 
	`g‘TimšgP¬ams
(
p
);

143 
memS³c
.
memPow”S³c
 = 
	`g‘Pow”P¬ams
(
p
);

144  
memS³c
;

145 
	}
}

147 
boŞ


148 
	gDRAMPow”
::
	$hasTwoVDD
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
)

150  
p
->
VDD2
 =ğ0 ? 
çl£
 : 
Œue
;

151 
	}
}

153 
ušt8_t


154 
	gDRAMPow”
::
	$g‘D©aR©e
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
)

156 
ušt32_t
 
bur¡_cyşes
 = 
	`divCe
(
p
->
tBURST
,…->
tCK
);

157 
ušt8_t
 
d©a_¿‹
 = 
p
->
bur¡_Ëngth
 / 
bur¡_cyşes
;

159 ià(
d©a_¿‹
 != 1 && data_rate != 2 && data_rate != 4)

160 
	`çl
("Got unexpected data„ate %d, should be 1 or 2 or 4\n");

161  
d©a_¿‹
;

162 
	}
}

	@drampower.hh

45 #iâdeà
__MEM_DRAM_POWER_HH__


46 
	#__MEM_DRAM_POWER_HH__


	)

48 
	~"libd¿mpow”/LibDRAMPow”.h
"

49 
	~"·¿ms/DRAMCŒl.hh
"

55 şas 
	cDRAMPow”


58 
	m´iv©e
:

64 
D©a
::
MemArch™eùu»S³c
 
g‘ArchP¬ams
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
);

70 
	mD©a
::
MemTimšgS³c
 
g‘TimšgP¬ams
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
);

76 
	mD©a
::
MemPow”S³c
 
g‘Pow”P¬ams
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
);

81 
ušt8_t
 
g‘D©aR©e
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
);

86 
boŞ
 
hasTwoVDD
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
);

91 
	mD©a
::
MemÜyS³cifiÿtiÚ
 
g‘MemS³c
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
);

93 
	mpublic
:

96 
libDRAMPow”
 
pow”lib
;

98 
DRAMPow”
(cÚ¡ 
DRAMCŒlP¬ams
* 
p
, 
boŞ
 
šşude_io
);

	@dramsim2.cc

40 
	~"DRAMSim2/C®lback.h
"

41 
	~"ba£/ÿÎback.hh
"

42 
	~"ba£/Œaû.hh
"

43 
	~"debug/DRAMSim2.hh
"

44 
	~"debug/D¿š.hh
"

45 
	~"mem/d¿msim2.hh
"

46 
	~"sim/sy¡em.hh
"

48 
	gDRAMSim2
::
	$DRAMSim2
(cÚ¡ 
P¬ams
* 
p
) :

49 
	`Ab¡¿ùMemÜy
(
p
),

50 
	`pÜt
(
	`Çme
(è+ ".pÜt", *
this
),

51 
	`w¿µ”
(
p
->
deviûCÚfigFe
,…->
sy¡emCÚfigFe
,…->
feP©h
,

52 
p
->
ŒaûFe
,…->
¿nge
.
	`size
(è/ 1024 / 1024,…->
’abËDebug
),

53 
	`»ŒyReq
(
çl£
), 
	`»ŒyRe¥
(çl£), 
	`¡¬tTick
(0),

54 
	`nbrOut¡ªdšgR—ds
(0), 
	`nbrOut¡ªdšgWr™es
(0),

55 
	`£ndRe¥Ú£Ev’t
(
this
), 
	$tickEv’t
(
this
)

57 
	`DPRINTF
(
DRAMSim2
,

59 
w¿µ”
.
	`şockP”iod
(), w¿µ”.
	`queueSize
());

61 
DRAMSim
::
T¿n§ùiÚCom¶‘eCB
* 
»ad_cb
 =

62 
Ãw
 
DRAMSim
::
C®lback
<
DRAMSim2
, , , 
ušt64_t
, uint64_t>(

63 
this
, &
DRAMSim2
::
»adCom¶‘e
);

64 
DRAMSim
::
T¿n§ùiÚCom¶‘eCB
* 
wr™e_cb
 =

65 
Ãw
 
DRAMSim
::
C®lback
<
DRAMSim2
, , , 
ušt64_t
, uint64_t>(

66 
this
, &
DRAMSim2
::
wr™eCom¶‘e
);

67 
w¿µ”
.
	`£tC®lbacks
(
»ad_cb
, 
wr™e_cb
);

71 
C®lback
* 
cb
 = 
Ãw
 
MakeC®lback
<
DRAMSim2W¿µ”
,

72 &
DRAMSim2W¿µ”
::
´štSts
>(
w¿µ”
);

73 
	`»gi¡”Ex™C®lback
(
cb
);

74 
	}
}

77 
	gDRAMSim2
::
	$š™
()

79 
Ab¡¿ùMemÜy
::
	`š™
();

81 ià(!
pÜt
.
	`isCÚÃùed
()) {

82 
	`çl
("DRAMSim2 % i uncÚÃùed!\n", 
	`Çme
());

84 
pÜt
.
	`£ndRªgeChªge
();

87 ià(
	`sy¡em
()->
	`ÿcheLšeSize
(è!ğ
w¿µ”
.
	`bur¡Size
())

88 
	`çl
("DRAMSim2 burst size %d does‚ot match cache†ine size %d\n",

89 
w¿µ”
.
	`bur¡Size
(), 
	`sy¡em
()->
	`ÿcheLšeSize
());

90 
	}
}

93 
	gDRAMSim2
::
	$¡¬tup
()

95 
¡¬tTick
 = 
	`curTick
();

98 
	`scheduË
(
tickEv’t
, 
	`şockEdge
());

99 
	}
}

102 
	gDRAMSim2
::
	$£ndRe¥Ú£
()

104 
	`as£¹
(!
»ŒyRe¥
);

105 
	`as£¹
(!
»¥Ú£Queue
.
	`em±y
());

107 
	`DPRINTF
(
DRAMSim2
, "Attemptingo send„esponse\n");

109 
boŞ
 
sucûss
 = 
pÜt
.
	`£ndTimšgRe¥
(
»¥Ú£Queue
.
	`äÚt
());

110 ià(
sucûss
) {

111 
»¥Ú£Queue
.
	`pİ_äÚt
();

113 
	`DPRINTF
(
DRAMSim2
, "Have %d„ead, %d write, %d„esponses outstanding\n",

114 
nbrOut¡ªdšgR—ds
, 
nbrOut¡ªdšgWr™es
,

115 
»¥Ú£Queue
.
	`size
());

117 ià(!
»¥Ú£Queue
.
	`em±y
(è&& !
£ndRe¥Ú£Ev’t
.
	`scheduËd
())

118 
	`scheduË
(
£ndRe¥Ú£Ev’t
, 
	`curTick
());

120 ià(
	`nbrOut¡ªdšg
() == 0)

121 
	`sigÇlD¿šDÚe
();

123 
»ŒyRe¥
 = 
Œue
;

125 
	`DPRINTF
(
DRAMSim2
, "Waiting for„esponse„etry\n");

127 
	`as£¹
(!
£ndRe¥Ú£Ev’t
.
	`scheduËd
());

129 
	}
}

132 
	gDRAMSim2
::
	$nbrOut¡ªdšg
() const

134  
nbrOut¡ªdšgR—ds
 + 
nbrOut¡ªdšgWr™es
 + 
»¥Ú£Queue
.
	`size
();

135 
	}
}

138 
	gDRAMSim2
::
	$tick
()

140 
w¿µ”
.
	`tick
();

144 ià(
»ŒyReq
 && 
	`nbrOut¡ªdšg
(è< 
w¿µ”
.
	`queueSize
()) {

145 
»ŒyReq
 = 
çl£
;

146 
pÜt
.
	`£ndR‘ryReq
();

149 
	`scheduË
(
tickEv’t
, 
	`curTick
(è+ 
w¿µ”
.
	`şockP”iod
(è* 
SimClock
::
IÁ
::
ns
);

150 
	}
}

152 
Tick


153 
	gDRAMSim2
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

155 
	`acûss
(
pkt
);

158  
pkt
->
	`ÿcheRe¥Údšg
() ? 0 : 50000;

159 
	}
}

162 
	gDRAMSim2
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

164 
pkt
->
	`pushLab–
(
	`Çme
());

166 
	`funùiÚ®Acûss
(
pkt
);

169 autØ
i
 = 
»¥Ú£Queue
.
	`begš
(); i !ğ»¥Ú£Queue.
	`’d
(); ++i)

170 
pkt
->
	`checkFunùiÚ®
(*
i
);

172 
pkt
->
	`pİLab–
();

173 
	}
}

175 
boŞ


176 
	gDRAMSim2
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

179 ià(
pkt
->
	`ÿcheRe¥Údšg
()) {

180 
³ndšgD–‘e
.
	`»£t
(
pkt
);

181  
Œue
;

187 ià(
»ŒyReq
)

188  
çl£
;

192 
boŞ
 
ÿn_acû±
 = 
	`nbrOut¡ªdšg
(è< 
w¿µ”
.
	`queueSize
();

195 ià(
pkt
->
	`isR—d
()) {

196 ià(
ÿn_acû±
) {

197 
out¡ªdšgR—ds
[
pkt
->
	`g‘Addr
()].
	`push
(pkt);

202 ++
nbrOut¡ªdšgR—ds
;

204 } ià(
pkt
->
	`isWr™e
()) {

205 ià(
ÿn_acû±
) {

206 
out¡ªdšgWr™es
[
pkt
->
	`g‘Addr
()].
	`push
(pkt);

208 ++
nbrOut¡ªdšgWr™es
;

211 
	`acûssAndRe¥Úd
(
pkt
);

215 
	`acûssAndRe¥Úd
(
pkt
);

216  
Œue
;

219 ià(
ÿn_acû±
) {

222 
	`as£¹
(
w¿µ”
.
	`ÿnAcû±
());

224 
	`DPRINTF
(
DRAMSim2
, "Enqueuešg‡dd»s %Îd\n", 
pkt
->
	`g‘Addr
());

229 
w¿µ”
.
	`’queue
(
pkt
->
	`isWr™e
(),…kt->
	`g‘Addr
());

231  
Œue
;

233 
»ŒyReq
 = 
Œue
;

234  
çl£
;

236 
	}
}

239 
	gDRAMSim2
::
	$»cvRe¥R‘ry
()

241 
	`DPRINTF
(
DRAMSim2
, "Retrying\n");

243 
	`as£¹
(
»ŒyRe¥
);

244 
»ŒyRe¥
 = 
çl£
;

245 
	`£ndRe¥Ú£
();

246 
	}
}

249 
	gDRAMSim2
::
	$acûssAndRe¥Úd
(
Pack‘PŒ
 
pkt
)

251 
	`DPRINTF
(
DRAMSim2
, "Acûs fÜ‡dd»s %Îd\n", 
pkt
->
	`g‘Addr
());

253 
boŞ
 
ÃedsRe¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

257 
	`acûss
(
pkt
);

260 ià(
ÃedsRe¥Ú£
) {

262 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

265 
Tick
 
time
 = 
	`curTick
(è+ 
pkt
->
h—d”D–ay
 +…kt->
·ylßdD–ay
;

267 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

269 
	`DPRINTF
(
DRAMSim2
, "Queuing„esponse for‡ddress %lld\n",

270 
pkt
->
	`g‘Addr
());

273 
»¥Ú£Queue
.
	`push_back
(
pkt
);

277 ià(!
»ŒyRe¥
 && !
£ndRe¥Ú£Ev’t
.
	`scheduËd
())

278 
	`scheduË
(
£ndRe¥Ú£Ev’t
, 
time
);

281 
³ndšgD–‘e
.
	`»£t
(
pkt
);

283 
	}
}

285 
	gDRAMSim2
::
	$»adCom¶‘e
(
id
, 
ušt64_t
 
addr
, ušt64_ˆ
cyşe
)

287 
	`as£¹
(
cyşe
 =ğ
	`divCe
(
	`curTick
(è- 
¡¬tTick
,

288 
w¿µ”
.
	`şockP”iod
(è* 
SimClock
::
IÁ
::
ns
));

290 
	`DPRINTF
(
DRAMSim2
, "R—dØadd»s %Îd com¶‘e\n", 
addr
);

293 autØ
p
 = 
out¡ªdšgR—ds
.
	`fšd
(
addr
);

294 
	`as£¹
(
p
 !ğ
out¡ªdšgR—ds
.
	`’d
());

298 
Pack‘PŒ
 
pkt
 = 
p
->
£cÚd
.
	`äÚt
();

299 
p
->
£cÚd
.
	`pİ
();

301 ià(
p
->
£cÚd
.
	`em±y
())

302 
out¡ªdšgR—ds
.
	`”a£
(
p
);

306 
	`as£¹
(
nbrOut¡ªdšgR—ds
 != 0);

307 --
nbrOut¡ªdšgR—ds
;

310 
	`acûssAndRe¥Úd
(
pkt
);

311 
	}
}

313 
	gDRAMSim2
::
	$wr™eCom¶‘e
(
id
, 
ušt64_t
 
addr
, ušt64_ˆ
cyşe
)

315 
	`as£¹
(
cyşe
 =ğ
	`divCe
(
	`curTick
(è- 
¡¬tTick
,

316 
w¿µ”
.
	`şockP”iod
(è* 
SimClock
::
IÁ
::
ns
));

318 
	`DPRINTF
(
DRAMSim2
, "Wr™tØadd»s %Îd com¶‘e\n", 
addr
);

321 autØ
p
 = 
out¡ªdšgWr™es
.
	`fšd
(
addr
);

322 
	`as£¹
(
p
 !ğ
out¡ªdšgWr™es
.
	`’d
());

326 
p
->
£cÚd
.
	`pİ
();

327 ià(
p
->
£cÚd
.
	`em±y
())

328 
out¡ªdšgWr™es
.
	`”a£
(
p
);

330 
	`as£¹
(
nbrOut¡ªdšgWr™es
 != 0);

331 --
nbrOut¡ªdšgWr™es
;

333 ià(
	`nbrOut¡ªdšg
() == 0)

334 
	`sigÇlD¿šDÚe
();

335 
	}
}

337 
	gBa£SÏvePÜt
&

338 
	gDRAMSim2
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

340 ià(
if_Çme
 != "port") {

341  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

343  
pÜt
;

345 
	}
}

347 
D¿šS‹


348 
	gDRAMSim2
::
	$d¿š
()

352  
	`nbrOut¡ªdšg
(è!ğ0 ? 
D¿šS‹
::
D¿ššg
 : D¿šS‹::
D¿šed
;

353 
	}
}

355 
	gDRAMSim2
::
MemÜyPÜt
::
	$MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
,

356 
DRAMSim2
& 
_memÜy
)

357 : 
	`SÏvePÜt
(
_Çme
, &
_memÜy
), 
	$memÜy
(
_memÜy
)

358 { 
	}
}

360 
AddrRªgeLi¡


361 
	gDRAMSim2
::
MemÜyPÜt
::
	$g‘AddrRªges
() const

363 
AddrRªgeLi¡
 
¿nges
;

364 
¿nges
.
	`push_back
(
memÜy
.
	`g‘AddrRªge
());

365  
¿nges
;

366 
	}
}

368 
Tick


369 
	gDRAMSim2
::
MemÜyPÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

371  
memÜy
.
	`»cvAtomic
(
pkt
);

372 
	}
}

375 
	gDRAMSim2
::
MemÜyPÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

377 
memÜy
.
	`»cvFunùiÚ®
(
pkt
);

378 
	}
}

380 
boŞ


381 
	gDRAMSim2
::
MemÜyPÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

384  
memÜy
.
	`»cvTimšgReq
(
pkt
);

385 
	}
}

388 
	gDRAMSim2
::
MemÜyPÜt
::
	$»cvRe¥R‘ry
()

390 
memÜy
.
	`»cvRe¥R‘ry
();

391 
	}
}

393 
DRAMSim2
*

394 
	gDRAMSim2P¬ams
::
	$ü—‹
()

396  
Ãw
 
	`DRAMSim2
(
this
);

397 
	}
}

	@dramsim2.hh

44 #iâdeà
__MEM_DRAMSIM2_HH__


45 
	#__MEM_DRAMSIM2_HH__


	)

47 
	~<queue
>

48 
	~<unÜd”ed_m­
>

50 
	~"mem/ab¡¿ù_mem.hh
"

51 
	~"mem/d¿msim2_w¿µ”.hh
"

52 
	~"mem/qpÜt.hh
"

53 
	~"·¿ms/DRAMSim2.hh
"

55 şas 
	cDRAMSim2
 : 
public
 
Ab¡¿ùMemÜy


57 
´iv©e
:

64 şas 
	cMemÜyPÜt
 : 
public
 
SÏvePÜt


67 
´iv©e
:

69 
DRAMSim2
& 
memÜy
;

71 
	mpublic
:

73 
MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
DRAMSim2
& 
_memÜy
);

75 
	m´Ùeùed
:

77 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

79 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

81 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

83 
»cvRe¥R‘ry
();

85 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

89 
MemÜyPÜt
 
	gpÜt
;

94 
DRAMSim2W¿µ”
 
	gw¿µ”
;

99 
boŞ
 
	g»ŒyReq
;

104 
boŞ
 
	g»ŒyRe¥
;

109 
Tick
 
	g¡¬tTick
;

117 
	g¡d
::
unÜd”ed_m­
<
Addr
, std::
queue
<
Pack‘PŒ
> > 
out¡ªdšgR—ds
;

118 
	g¡d
::
unÜd”ed_m­
<
Addr
, std::
queue
<
Pack‘PŒ
> > 
out¡ªdšgWr™es
;

125 
	gnbrOut¡ªdšgR—ds
;

126 
	gnbrOut¡ªdšgWr™es
;

133 
	g¡d
::
deque
<
Pack‘PŒ
> 
»¥Ú£Queue
;

135 
	$nbrOut¡ªdšg
() const;

144 
	`acûssAndRe¥Úd
(
Pack‘PŒ
 
pkt
);

146 
	`£ndRe¥Ú£
();

151 
Ev’tW¿µ”
<
DRAMSim2
, &DRAMSim2::
£ndRe¥Ú£
> 
£ndRe¥Ú£Ev’t
;

156 
	`tick
();

161 
Ev’tW¿µ”
<
DRAMSim2
, &DRAMSim2::
tick
> 
tickEv’t
;

167 
¡d
::
unique_±r
<
Pack‘
> 
³ndšgD–‘e
;

169 
public
:

171 
DRAMSim2P¬ams
 
	tP¬ams
;

172 
	`DRAMSim2
(cÚ¡ 
P¬ams
 *
p
);

181 
	`»adCom¶‘e
(
id
, 
ušt64_t
 
addr
, ušt64_ˆ
cyşe
);

190 
	`wr™eCom¶‘e
(
id
, 
ušt64_t
 
addr
, ušt64_ˆ
cyşe
);

192 
D¿šS‹
 
	$d¿š
(è
ov”ride
;

194 
vœtu®
 
Ba£SÏvePÜt
& 
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

195 
PÜtID
 
idx
 = 
Inv®idPÜtID
è
ov”ride
;

197 
	$š™
(è
ov”ride
;

198 
	$¡¬tup
(è
ov”ride
;

200 
´Ùeùed
:

202 
Tick
 
	`»cvAtomic
(
Pack‘PŒ
 
pkt
);

203 
	`»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

204 
boŞ
 
	`»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

205 
	`»cvRe¥R‘ry
();

207 
	}
};

	@dramsim2_wrapper.cc

40 
	~<ÿs£¹
>

47 #ifdeà
DEBUG


48 #undeà
DEBUG


51 
	~<f¡»am
>

53 
	~"DRAMSim2/MuÉiChªÃlMemÜySy¡em.h
"

54 
	~"ba£/comp”.hh
"

55 
	~"ba£/misc.hh
"

56 
	~"mem/d¿msim2_w¿µ”.hh
"

63 
	gSHOW_SIM_OUTPUT
 = 0;

65 
	gDRAMSim2W¿µ”
::
	$DRAMSim2W¿µ”
(cÚ¡ 
¡d
::
¡ršg
& 
cÚfig_fe
,

66 cÚ¡ 
¡d
::
¡ršg
& 
sy¡em_fe
,

67 cÚ¡ 
¡d
::
¡ršg
& 
wÜkšg_dœ
,

68 cÚ¡ 
¡d
::
¡ršg
& 
Œaû_fe
,

69 
memÜy_size_mb
,

70 
boŞ
 
’abË_debug
) :

71 
	`d¿msim
(
Ãw
 
DRAMSim
::
	`MuÉiChªÃlMemÜySy¡em
(
cÚfig_fe
, 
sy¡em_fe
,

72 
wÜkšg_dœ
, 
Œaû_fe
,

73 
memÜy_size_mb
, 
NULL
, NULL)),

74 
	`_şockP”iod
(0.0), 
	`_queueSize
(0), 
	$_bur¡Size
(0)

77 
d¿msim
->
	`£tCPUClockS³ed
(0);

80 ià(
’abË_debug
)

81 
SHOW_SIM_OUTPUT
 = 1;

85 
_şockP”iod
 = 
exŒaùCÚfig
<>("tCK=",

86 
wÜkšg_dœ
 + '/' + 
cÚfig_fe
);

88 ià(!
_şockP”iod
)

89 
	`çl
("DRAMSim2 wrapper failedo get clock\n");

93 
_queueSize
 = 
exŒaùCÚfig
<>("TRANS_QUEUE_DEPTH=",

94 
wÜkšg_dœ
 + '/' + 
sy¡em_fe
);

96 ià(!
_queueSize
)

97 
	`çl
("DRAMSim2 wrapper failedo get queue size\n");

102 
d©aBusB™s
 =

103 
exŒaùCÚfig
<>("JEDEC_DATA_BUS_BITS=",

104 
wÜkšg_dœ
 + '/' + 
sy¡em_fe
);

105 
bur¡L’gth
 =

106 
exŒaùCÚfig
<>("BL=", 
wÜkšg_dœ
 + '/' + 
cÚfig_fe
);

108 ià(!
d©aBusB™s
 || !
bur¡L’gth
)

109 
	`çl
("DRAMSim22 wrapper failedo get burst size\n");

111 
_bur¡Size
 = 
d©aBusB™s
 * 
bur¡L’gth
 / 8;

112 
	}
}

114 
	gDRAMSim2W¿µ”
::~
	$DRAMSim2W¿µ”
()

116 
d–‘e
 
d¿msim
;

117 
	}
}

119 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

120 
T


121 
	gDRAMSim2W¿µ”
::
	$exŒaùCÚfig
(cÚ¡ 
¡d
::
¡ršg
& 
f›ld_Çme
,

122 cÚ¡ 
¡d
::
¡ršg
& 
fe_Çme
) const

124 
¡d
::
if¡»am
 
	`fe_¡»am
(
fe_Çme
.
	`c_¡r
(), 
ios
::
š
);

126 ià(!
fe_¡»am
.
	`good
())

127 
	`çl
("DRAMSim2 w¿µ” could‚Ù o³À% fÜ„—dšg\n", 
fe_Çme
);

129 
boŞ
 
found
 = 
çl£
;

130 
T
 
»s
;

131 
¡d
::
¡ršg
 
lše
;

132 !
found
 && 
fe_¡»am
) {

133 
	`g‘lše
(
fe_¡»am
, 
lše
);

134 ià(
lše
.
	`sub¡r
(0, 
f›ld_Çme
.
	`size
()) == field_name) {

135 
found
 = 
Œue
;

136 
i¡ršg¡»am
 
	`iss
(
lše
.
	`sub¡r
(
f›ld_Çme
.
	`size
()));

137 
iss
 >> 
»s
;

141 
fe_¡»am
.
	`şo£
();

143 ià(!
found
)

144 
	`çl
("DRAMSim2 w¿µ” could‚Ù fšd % š %s\n", 
f›ld_Çme
,

145 
fe_Çme
);

147  
»s
;

148 
	}
}

151 
	gDRAMSim2W¿µ”
::
	$´štSts
()

153 
d¿msim
->
	`´štSts
(
Œue
);

154 
	}
}

157 
	gDRAMSim2W¿µ”
::
	$£tC®lbacks
(
DRAMSim
::
T¿n§ùiÚCom¶‘eCB
* 
»ad_ÿÎback
,

158 
DRAMSim
::
T¿n§ùiÚCom¶‘eCB
* 
wr™e_ÿÎback
)

161 
d¿msim
->
	`Regi¡”C®lbacks
(
»ad_ÿÎback
, 
wr™e_ÿÎback
, 
NULL
);

162 
	}
}

164 
boŞ


165 
	gDRAMSim2W¿µ”
::
	$ÿnAcû±
() const

167  
d¿msim
->
	`wlAcû±T¿n§ùiÚ
();

168 
	}
}

171 
	gDRAMSim2W¿µ”
::
	$’queue
(
boŞ
 
is_wr™e
, 
ušt64_t
 
addr
)

173 
boŞ
 
sucûss
 
M5_VAR_USED
 = 
d¿msim
->
	`addT¿n§ùiÚ
(
is_wr™e
, 
addr
);

174 
	`as£¹
(
sucûss
);

175 
	}
}

178 
	gDRAMSim2W¿µ”
::
	$şockP”iod
() const

180  
_şockP”iod
;

181 
	}
}

184 
	gDRAMSim2W¿µ”
::
	$queueSize
() const

186  
_queueSize
;

187 
	}
}

190 
	gDRAMSim2W¿µ”
::
	$bur¡Size
() const

192  
_bur¡Size
;

193 
	}
}

196 
	gDRAMSim2W¿µ”
::
	$tick
()

198 
d¿msim
->
	`upd©e
();

199 
	}
}

	@dramsim2_wrapper.hh

45 #iâdeà
__MEM_DRAMSIM2_WRAPPER_HH__


46 
	#__MEM_DRAMSIM2_WRAPPER_HH__


	)

48 
	~<¡ršg
>

50 
	~"DRAMSim2/C®lback.h
"

55 
Çme¥aû
 
	gDRAMSim
 {

57 
şass
 
	gMuÉiChªÃlMemÜySy¡em
;

69 şas 
	cDRAMSim2W¿µ”


72 
	m´iv©e
:

74 
DRAMSim
::
MuÉiChªÃlMemÜySy¡em
* 
d¿msim
;

76 
	m_şockP”iod
;

78 
	m_queueSize
;

80 
	m_bur¡Size
;

82 
	m‹m¶©e
 <
ty³Çme
 
	mT
>

83 
T
 
	$exŒaùCÚfig
(cÚ¡ 
¡d
::
¡ršg
& 
f›ld_Çme
,

84 cÚ¡ 
¡d
::
¡ršg
& 
fe_Çme
) const;

86 
public
:

99 
	`DRAMSim2W¿µ”
(cÚ¡ 
¡d
::
¡ršg
& 
cÚfig_fe
,

100 cÚ¡ 
¡d
::
¡ršg
& 
sy¡em_fe
,

101 cÚ¡ 
¡d
::
¡ršg
& 
wÜkšg_dœ
,

102 cÚ¡ 
¡d
::
¡ršg
& 
Œaû_fe
,

103 
memÜy_size_mb
,

104 
boŞ
 
’abË_debug
);

105 ~
	`DRAMSim2W¿µ”
();

110 
	`´štSts
();

118 
	`£tC®lbacks
(
DRAMSim
::
T¿n§ùiÚCom¶‘eCB
* 
»ad_ÿÎback
,

119 
DRAMSim
::
T¿n§ùiÚCom¶‘eCB
* 
wr™e_ÿÎback
);

126 
boŞ
 
	$ÿnAcû±
() const;

133 
	`’queue
(
boŞ
 
is_wr™e
, 
ušt64_t
 
addr
);

141 
	$şockP”iod
() const;

148 
	$queueSize
() const;

155 
	$bur¡Size
() const;

160 
	`tick
();

	@external_master.cc

41 
	~<cùy³
>

42 
	~<iomª
>

44 
	~"debug/Ex‹º®PÜt.hh
"

45 
	~"mem/ex‹º®_ma¡”.hh
"

47 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gEx‹º®Ma¡”
::
HªdËr
 *>

48 
Ex‹º®Ma¡”
::
pÜtHªdËrs
;

50 
	gEx‹º®Ma¡”
::
	$Ex‹º®Ma¡”
(
Ex‹º®Ma¡”P¬ams
 *
·¿ms
) :

51 
	`MemObjeù
(
·¿ms
),

52 
	`ex‹º®PÜt
(
NULL
),

53 
	`pÜtName
(
·¿ms
->
Çme
 + ".port"),

54 
	`pÜtTy³
(
·¿ms
->
pÜt_ty³
),

55 
	`pÜtD©a
(
·¿ms
->
pÜt_d©a
)

56 {
	}
}

58 
	gBa£Ma¡”PÜt
 &

59 
	gEx‹º®Ma¡”
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

60 
PÜtID
 
idx
)

62 ià(
if_Çme
 == "port") {

63 
	`DPRINTF
(
Ex‹º®PÜt
, "Tryingo bindƒxternal…ort: %s %s\n",

64 
pÜtTy³
, 
pÜtName
);

66 ià(!
ex‹º®PÜt
) {

67 autØ
hªdËrI‹r
 = 
pÜtHªdËrs
.
	`fšd
(
pÜtTy³
);

69 ià(
hªdËrI‹r
 =ğ
pÜtHªdËrs
.
	`’d
())

70 
	`çl
("Cª'ˆfšd…ÜˆhªdË¸ty³ '%s'\n", 
pÜtTy³
);

72 
ex‹º®PÜt
 = 
pÜtHªdËrs
[
pÜtTy³
]->
	`g‘Ex‹º®PÜt
(
pÜtName
,

73 *
this
, 
pÜtD©a
);

75 ià(!
ex‹º®PÜt
) {

76 
	`çl
("%s: Can't findƒxternal…ortype: %s"

77 "…Üt_d©a: '%s'\n", 
pÜtName
, 
pÜtTy³
, 
pÜtD©a
);

80  *
ex‹º®PÜt
;

82  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

84 
	}
}

87 
	gEx‹º®Ma¡”
::
	$š™
()

89 ià(!
ex‹º®PÜt
) {

90 
	`çl
("Ex‹º®Ma¡” %s:ƒx‹º®PÜˆnÙ s‘!\n", 
	`Çme
());

91 } ià(!
ex‹º®PÜt
->
	`isCÚÃùed
()) {

92 
	`çl
("Ex‹º®Ma¡” % i uncÚÃùed!\n", 
	`Çme
());

94 
	}
}

96 
Ex‹º®Ma¡”
 *

97 
	gEx‹º®Ma¡”P¬ams
::
	$ü—‹
()

99  
Ãw
 
	`Ex‹º®Ma¡”
(
this
);

100 
	}
}

103 
	gEx‹º®Ma¡”
::
	$»gi¡”HªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
hªdËr_Çme
,

104 
HªdËr
 *
hªdËr
)

106 
pÜtHªdËrs
[
hªdËr_Çme
] = 
hªdËr
;

107 
	}
}

	@external_master.hh

59 #iâdeà
__MEM_EXTERNAL_MASTER__


60 
	#__MEM_EXTERNAL_MASTER__


	)

62 
	~"mem/mem_objeù.hh
"

63 
	~"·¿ms/Ex‹º®Ma¡”.hh
"

65 şas 
	cEx‹º®Ma¡”
 : 
public
 
MemObjeù


67 
public
:

69 şas 
	cPÜt
 : 
public
 
Ma¡”PÜt


71 
´Ùeùed
:

72 
Ex‹º®Ma¡”
 &
owÃr
;

74 
	mpublic
:

75 
PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
Çme_
,

76 
Ex‹º®Ma¡”
 &
owÃr_
) :

77 
Ma¡”PÜt
(
Çme_
, &
owÃr_
), 
owÃr
(owner_)

80 ~
PÜt
() { }

90 şas 
	cHªdËr


92 
	gpublic
:

95 
vœtu®
 
PÜt
 *
g‘Ex‹º®PÜt
(

96 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, 
Ex‹º®Ma¡”
 &
owÃr
,

97 cÚ¡ 
¡d
::
¡ršg
 &
pÜt_d©a
) = 0;

100 
	g´Ùeùed
:

102 
PÜt
 *
ex‹º®PÜt
;

105 
	g¡d
::
¡ršg
 
pÜtName
;

108 
	g¡d
::
¡ršg
 
pÜtTy³
;

111 
	g¡d
::
¡ršg
 
pÜtD©a
;

117 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gHªdËr
 *> 
	gpÜtHªdËrs
;

119 
	gpublic
:

120 
Ex‹º®Ma¡”
(
Ex‹º®Ma¡”P¬ams
 *
·¿ms
);

123 
	gBa£Ma¡”PÜt
 &
g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

124 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

128 
»gi¡”HªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
hªdËr_Çme
,

129 
HªdËr
 *
hªdËr
);

131 
š™
();

	@external_slave.cc

40 
	~<cùy³
>

41 
	~<iomª
>

43 
	~"debug/Ex‹º®PÜt.hh
"

44 
	~"mem/ex‹º®_¦ave.hh
"

50 şas 
	cStubSÏvePÜt
 : 
public
 
Ex‹º®SÏve
::
PÜt


52 
public
:

53 şas 
	cRe¥Ú£Ev’t
 : 
public
 
Ev’t


55 
public
:

56 
StubSÏvePÜt
 &
owÃr
;

58 
Re¥Ú£Ev’t
(
StubSÏvePÜt
 &
owÃr_
è: 
owÃr
(owner_) { }

60 
´oûss
();

63 
Re¥Ú£Ev’t
 
	g»¥Ú£Ev’t
;

67 
Pack‘PŒ
 
	g»¥Ú£Pack‘
;

71 
boŞ
 
	gmu¡R‘ry
;

73 
	$StubSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
Çme_
,

74 
Ex‹º®SÏve
 &
owÃr_
) :

75 
Ex‹º®SÏve
::
	`PÜt
(
Çme_
, 
owÃr_
),

76 
	`»¥Ú£Ev’t
(*
this
), 
	`»¥Ú£Pack‘
(
NULL
), 
	$mu¡R‘ry
(
çl£
)

77 { 
	}
}

79 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
·ck‘
);

80 
»cvFunùiÚ®
(
Pack‘PŒ
 
·ck‘
);

81 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
·ck‘
);

82 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
·ck‘
);

83 
»cvRe¥R‘ry
();

84 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
·ck‘
);

87 şas 
	cStubSÏvePÜtHªdËr
 : 
public


88 
Ex‹º®SÏve
::
HªdËr


90 
public
:

91 
Ex‹º®SÏve
::
PÜt
 *
	$g‘Ex‹º®PÜt
(

92 cÚ¡ 
¡d
::
¡ršg
 &
Çme_
,

93 
Ex‹º®SÏve
 &
owÃr
,

94 cÚ¡ 
¡d
::
¡ršg
 &
pÜt_d©a
)

96 
SŒšgW¿p
 
	`Çme
(
Çme_
);

98 
	`DPRINTF
(
Ex‹º®PÜt
, "fšdšg stub…Üˆ'%s'\n", 
pÜt_d©a
);

99  
Ãw
 
	`StubSÏvePÜt
(
Çme_
, 
owÃr
);

101 
	}
};

103 
Tick


104 
	gStubSÏvePÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
·ck‘
)

106 ià(
	`DTRACE
(
Ex‹º®PÜt
)) {

107 
M5_VAR_USED
 
size
 = 
·ck‘
->
	`g‘Size
();

109 
	`DPRINTF
(
Ex‹º®PÜt
, "StubSlavePort:„ecvAtomic‡: 0x%x size: %d"

110 " d©a: ...\n", 
·ck‘
->
	`g‘Addr
(), 
size
);

111 
	`DDUMP
(
Ex‹º®PÜt
, 
·ck‘
->
g‘CÚ¡PŒ
<
ušt8_t
>(), 
size
);

115 
	}
}

118 
	gStubSÏvePÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
·ck‘
)

120 
	`»cvAtomic
(
·ck‘
);

121 
	}
}

124 
	gStubSÏvePÜt
::
Re¥Ú£Ev’t
::
	$´oûss
()

126 
owÃr
.
»¥Ú£Pack‘
->
	`makeRe¥Ú£
();

127 
owÃr
.
»¥Ú£Pack‘
->
h—d”D–ay
 = 0;

128 
owÃr
.
»¥Ú£Pack‘
->
·ylßdD–ay
 = 0;

130 ià(
owÃr
.
	`£ndTimšgRe¥
(owÃr.
»¥Ú£Pack‘
)) {

131 
owÃr
.
»¥Ú£Pack‘
 = 
NULL
;

133 ià(
owÃr
.
mu¡R‘ry
)

134 
owÃr
.
	`£ndR‘ryReq
();

135 
owÃr
.
mu¡R‘ry
 = 
çl£
;

137 
	}
}

139 
boŞ


140 
	gStubSÏvePÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
·ck‘
)

142 ià(
»¥Ú£Pack‘
) {

143 
mu¡R‘ry
 = 
Œue
;

145  
çl£
;

147 
	`»cvAtomic
(
·ck‘
);

149 
»¥Ú£Pack‘
 = 
·ck‘
;

150 
owÃr
.
	`scheduË
(
»¥Ú£Ev’t
, 
	`curTick
());

152  
Œue
;

154 
	}
}

156 
boŞ


157 
	gStubSÏvePÜt
::
	$»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
·ck‘
)

159 
	`çl
("StubSÏvePÜt: funùiÚ: %s\n", 
__func__
);

160  
çl£
;

161 
	}
}

164 
	gStubSÏvePÜt
::
	$»cvRe¥R‘ry
()

166 
	`as£¹
(
»¥Ú£Pack‘
);

170 
»¥Ú£Ev’t
.
	`´oûss
();

171 
	}
}

174 
	gStubSÏvePÜt
::
	$»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
·ck‘
)

176 
	`çl
("StubSÏvePÜt: unim¶em’‹d funùiÚ: %s\n", 
__func__
);

177 
	}
}

179 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gEx‹º®SÏve
::
HªdËr
 *>

180 
Ex‹º®SÏve
::
pÜtHªdËrs
;

182 
AddrRªgeLi¡


183 
	gEx‹º®SÏve
::
PÜt
::
	$g‘AddrRªges
() const

185  
owÃr
.
addrRªges
;

186 
	}
}

188 
	gEx‹º®SÏve
::
	$Ex‹º®SÏve
(
Ex‹º®SÏveP¬ams
 *
·¿ms
) :

189 
	`MemObjeù
(
·¿ms
),

190 
	`ex‹º®PÜt
(
NULL
),

191 
	`pÜtName
(
·¿ms
->
Çme
 + ".port"),

192 
	`pÜtTy³
(
·¿ms
->
pÜt_ty³
),

193 
	`pÜtD©a
(
·¿ms
->
pÜt_d©a
),

194 
	`addrRªges
(
·¿ms
->
addr_¿nges
.
	`begš
(),…¬ams->addr_¿nges.
	$’d
())

197 ià(
pÜtHªdËrs
.
	`fšd
("¡ub"è=ğpÜtHªdËrs.
	`’d
())

198 
	`»gi¡”HªdËr
("¡ub", 
Ãw
 
StubSÏvePÜtHªdËr
);

199 
	}
}

201 
	gBa£SÏvePÜt
 &

202 
	gEx‹º®SÏve
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

203 
PÜtID
 
idx
)

205 ià(
if_Çme
 == "port") {

206 
	`DPRINTF
(
Ex‹º®PÜt
, "Tryingo bindƒxternal…ort: %s %s\n",

207 
pÜtTy³
, 
pÜtName
);

209 ià(!
ex‹º®PÜt
) {

210 autØ
hªdËrI‹r
 = 
pÜtHªdËrs
.
	`fšd
(
pÜtTy³
);

212 ià(
hªdËrI‹r
 =ğ
pÜtHªdËrs
.
	`’d
())

213 
	`çl
("Cª'ˆfšd…ÜˆhªdË¸ty³ '%s'\n", 
pÜtTy³
);

215 
ex‹º®PÜt
 = 
pÜtHªdËrs
[
pÜtTy³
]->
	`g‘Ex‹º®PÜt
(
pÜtName
,

216 *
this
, 
pÜtD©a
);

218 ià(!
ex‹º®PÜt
) {

219 
	`çl
("%s: Can't findƒxternal…ortype: %s"

220 "…Üt_d©a: '%s'\n", 
pÜtName
, 
pÜtTy³
, 
pÜtD©a
);

223  *
ex‹º®PÜt
;

225  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

227 
	}
}

230 
	gEx‹º®SÏve
::
	$š™
()

232 ià(!
ex‹º®PÜt
) {

233 
	`çl
("Ex‹º®SÏv%s:ƒx‹º®PÜˆnÙ s‘!\n", 
	`Çme
());

234 } ià(!
ex‹º®PÜt
->
	`isCÚÃùed
()) {

235 
	`çl
("Ex‹º®SÏv% i uncÚÃùed!\n", 
	`Çme
());

237 
ex‹º®PÜt
->
	`£ndRªgeChªge
();

239 
	}
}

241 
Ex‹º®SÏve
 *

242 
	gEx‹º®SÏveP¬ams
::
	$ü—‹
()

244  
Ãw
 
	`Ex‹º®SÏve
(
this
);

245 
	}
}

248 
	gEx‹º®SÏve
::
	$»gi¡”HªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
hªdËr_Çme
,

249 
HªdËr
 *
hªdËr
)

251 
pÜtHªdËrs
[
hªdËr_Çme
] = 
hªdËr
;

252 
	}
}

	@external_slave.hh

60 #iâdeà
__MEM_EXTERNAL_SLAVE__


61 
	#__MEM_EXTERNAL_SLAVE__


	)

63 
	~"mem/mem_objeù.hh
"

64 
	~"·¿ms/Ex‹º®SÏve.hh
"

66 şas 
	cEx‹º®SÏve
 : 
public
 
MemObjeù


68 
public
:

70 şas 
	cPÜt
 : 
public
 
SÏvePÜt


72 
´Ùeùed
:

73 
Ex‹º®SÏve
 &
owÃr
;

75 
	mpublic
:

76 
PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
Çme_
,

77 
Ex‹º®SÏve
 &
owÃr_
) :

78 
SÏvePÜt
(
Çme_
, &
owÃr_
), 
owÃr
(owner_)

81 ~
PÜt
() { }

86 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

93 şas 
	cHªdËr


95 
	gpublic
:

98 
vœtu®
 
PÜt
 *
g‘Ex‹º®PÜt
(

99 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, 
Ex‹º®SÏve
 &
owÃr
,

100 cÚ¡ 
¡d
::
¡ršg
 &
pÜt_d©a
) = 0;

103 
	g´Ùeùed
:

105 
PÜt
 *
ex‹º®PÜt
;

108 
	g¡d
::
¡ršg
 
pÜtName
;

111 
	g¡d
::
¡ršg
 
pÜtTy³
;

114 
	g¡d
::
¡ršg
 
pÜtD©a
;

118 
AddrRªgeLi¡
 
	gaddrRªges
;

124 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gHªdËr
 *> 
	gpÜtHªdËrs
;

126 
	gpublic
:

127 
Ex‹º®SÏve
(
Ex‹º®SÏveP¬ams
 *
·¿ms
);

130 
	gBa£SÏvePÜt
 &
g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

131 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

135 
»gi¡”HªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
hªdËr_Çme
,

136 
HªdËr
 *
hªdËr
);

138 
š™
();

	@fs_translating_port_proxy.cc

49 
	~"¬ch/vtİhys.hh
"

50 
	~"ba£/chunk_g’”©Ü.hh
"

51 
	~"ıu/ba£.hh
"

52 
	~"ıu/th»ad_cÚ‹xt.hh
"

53 
	~"mem/fs_Œª¦©šg_pÜt_´oxy.hh
"

54 
	~"sim/sy¡em.hh
"

56 
usšg
 
Çme¥aû
 
	gTheISA
;

58 
	gFST¿n¦©šgPÜtProxy
::
	$FST¿n¦©šgPÜtProxy
(
Th»adCÚ‹xt
 *
tc
)

59 : 
	`PÜtProxy
(
tc
->
	`g‘CpuPŒ
()->
	`g‘D©aPÜt
(),

60 
tc
->
	`g‘Sy¡emPŒ
()->
	`ÿcheLšeSize
()), 
	$_tc
(
tc
)

62 
	}
}

64 
	gFST¿n¦©šgPÜtProxy
::
	$FST¿n¦©šgPÜtProxy
(
Ma¡”PÜt
 &
pÜt
,

65 
ÿcheLšeSize
)

66 : 
	`PÜtProxy
(
pÜt
, 
ÿcheLšeSize
), 
	$_tc
(
NULL
)

68 
	}
}

70 
	gFST¿n¦©šgPÜtProxy
::~
	$FST¿n¦©šgPÜtProxy
()

72 
	}
}

75 
FST¿n¦©šgPÜtProxy
::
	$»adBlob
(
Addr
 
addr
, 
ušt8_t
 *
p
, 
size
) const

77 
Addr
 
·ddr
;

78 
ChunkG’”©Ü
 
	`g’
(
addr
, 
size
, 
TheISA
::
PageBy‹s
); !
g’
.
	`dÚe
();

79 
g’
.
	`Ãxt
())

81 ià(
_tc
)

82 
·ddr
 = 
TheISA
::
	`vtİhys
(
_tc
,
g’
.
	`addr
());

84 
·ddr
 = 
TheISA
::
	`vtİhys
(
g’
.
	`addr
());

86 
PÜtProxy
::
	`»adBlob
(
·ddr
, 
p
, 
g’
.
	`size
());

87 
p
 +ğ
g’
.
	`size
();

89 
	}
}

92 
	gFST¿n¦©šgPÜtProxy
::
	$wr™eBlob
(
Addr
 
addr
, cÚ¡ 
ušt8_t
 *
p
, 
size
) const

94 
Addr
 
·ddr
;

95 
ChunkG’”©Ü
 
	`g’
(
addr
, 
size
, 
TheISA
::
PageBy‹s
); !
g’
.
	`dÚe
();

96 
g’
.
	`Ãxt
())

98 ià(
_tc
)

99 
·ddr
 = 
TheISA
::
	`vtİhys
(
_tc
,
g’
.
	`addr
());

101 
·ddr
 = 
TheISA
::
	`vtİhys
(
g’
.
	`addr
());

103 
PÜtProxy
::
	`wr™eBlob
(
·ddr
, 
p
, 
g’
.
	`size
());

104 
p
 +ğ
g’
.
	`size
();

106 
	}
}

109 
	gFST¿n¦©šgPÜtProxy
::
	$mem£tBlob
(
Addr
 
add»ss
, 
ušt8_t
 
v
, 
size
) const

111 
Addr
 
·ddr
;

112 
ChunkG’”©Ü
 
	`g’
(
add»ss
, 
size
, 
TheISA
::
PageBy‹s
); !
g’
.
	`dÚe
();

113 
g’
.
	`Ãxt
())

115 ià(
_tc
)

116 
·ddr
 = 
TheISA
::
	`vtİhys
(
_tc
,
g’
.
	`addr
());

118 
·ddr
 = 
TheISA
::
	`vtİhys
(
g’
.
	`addr
());

120 
PÜtProxy
::
	`mem£tBlob
(
·ddr
, 
v
, 
g’
.
	`size
());

122 
	}
}

125 
	$CİyOut
(
Th»adCÚ‹xt
 *
tc
, *
de¡
, 
Addr
 
¤c
, 
size_t
 
ıËn
)

127 
ušt8_t
 *
d¡
 = (ušt8_ˆ*)
de¡
;

128 
tc
->
	`g‘VœtProxy
().
	`»adBlob
(
¤c
, 
d¡
, 
ıËn
);

129 
	}
}

132 
	$CİyIn
(
Th»adCÚ‹xt
 *
tc
, 
Addr
 
de¡
, cÚ¡ *
sourû
, 
size_t
 
ıËn
)

134 
ušt8_t
 *
¤c
 = (ušt8_ˆ*)
sourû
;

135 
tc
->
	`g‘VœtProxy
().
	`wr™eBlob
(
de¡
, 
¤c
, 
ıËn
);

136 
	}
}

139 
	$CİySŒšgOut
(
Th»adCÚ‹xt
 *
tc
, *
d¡
, 
Addr
 
vaddr
, 
size_t
 
maxËn
)

141 *
¡¬t
 = 
d¡
;

142 
FST¿n¦©šgPÜtProxy
 &
vp
 = 
tc
->
	`g‘VœtProxy
();

144 
boŞ
 
foundNuÎ
 = 
çl£
;

145 (
d¡
 - 
¡¬t
 + 1è< 
maxËn
 && !
foundNuÎ
) {

146 
vp
.
	`»adBlob
(
vaddr
++, (
ušt8_t
*)
d¡
, 1);

147 ià(*
d¡
 == '\0')

148 
foundNuÎ
 = 
Œue
;

149 
d¡
++;

152 ià(!
foundNuÎ
)

153 *
d¡
 = '\0';

154 
	}
}

157 
	$CİySŒšgIn
(
Th»adCÚ‹xt
 *
tc
, cÚ¡ *
¤c
, 
Addr
 
vaddr
)

159 
FST¿n¦©šgPÜtProxy
 &
vp
 = 
tc
->
	`g‘VœtProxy
();

160 
ChunkG’”©Ü
 
	`g’
(
vaddr
, 
	`¡¾’
(
¤c
), 
TheISA
::
PageBy‹s
); !
g’
.
	`dÚe
();

161 
g’
.
	`Ãxt
())

163 
vp
.
	`wr™eBlob
(
g’
.
	`addr
(), (
ušt8_t
*)
¤c
, g’.
	`size
());

164 
¤c
 +ğ
g’
.
	`size
();

166 
	}
}

	@fs_translating_port_proxy.hh

59 #iâdeà
__MEM_FS_PORT_PROXY_HH__


60 
	#__MEM_FS_PORT_PROXY_HH__


	)

62 
	~"mem/pÜt_´oxy.hh
"

64 
şass
 
	gTh»adCÚ‹xt
;

73 şas 
	cFST¿n¦©šgPÜtProxy
 : 
public
 
PÜtProxy


75 
´iv©e
:

76 
Th»adCÚ‹xt
* 
_tc
;

78 
	mpublic
:

80 
FST¿n¦©šgPÜtProxy
(
Th»adCÚ‹xt
* 
tc
);

82 
FST¿n¦©šgPÜtProxy
(
Ma¡”PÜt
 &
pÜt
, 
ÿcheLšeSize
);

84 
	mvœtu®
 ~
FST¿n¦©šgPÜtProxy
();

88 
vœtu®
 
	$»adBlob
(
Addr
 
addr
, 
ušt8_t
 *
p
, 
size
) const;

92 
vœtu®
 
	$wr™eBlob
(
Addr
 
addr
, cÚ¡ 
ušt8_t
 *
p
, 
size
) const;

97 
vœtu®
 
	$mem£tBlob
(
Addr
 
add»ss
, 
ušt8_t
 
v
, 
size
) const;

100 
	`CİyOut
(
Th»adCÚ‹xt
 *
tc
, *
de¡
, 
Addr
 
¤c
, 
size_t
 
ıËn
);

101 
	`CİyIn
(
Th»adCÚ‹xt
 *
tc
, 
Addr
 
de¡
, cÚ¡ *
sourû
, 
size_t
 
ıËn
);

102 
	`CİySŒšgOut
(
Th»adCÚ‹xt
 *
tc
, *
d¡
, 
Addr
 
vaddr
, 
size_t
 
maxËn
);

103 
	`CİySŒšgIn
(
Th»adCÚ‹xt
 *
tc
, cÚ¡ *
¤c
, 
Addr
 
vaddr
);

	@hmc_controller.cc

1 
	~"ba£/¿ndom.hh
"

2 
	~"debug/HMCCÚŒŞËr.hh
"

3 
	~"mem/hmc_cÚŒŞËr.hh
"

5 
	gHMCCÚŒŞËr
::
	$HMCCÚŒŞËr
(cÚ¡ 
HMCCÚŒŞËrP¬ams
* 
p
) :

6 
	`NÚcoh”’tXB¬
(
p
),

7 
	`n_ma¡”_pÜts
(
p
->
pÜt_ma¡”_cÚÃùiÚ_couÁ
),

8 
	$¼_couÁ”
(0)

10 
	`as£¹
(
p
->
pÜt_¦ave_cÚÃùiÚ_couÁ
 == 1);

11 
	}
}

13 
HMCCÚŒŞËr
*

14 
	gHMCCÚŒŞËrP¬ams
::
	$ü—‹
()

16  
Ãw
 
	`HMCCÚŒŞËr
(
this
);

17 
	}
}

21 
	gHMCCÚŒŞËr
::
	$»cvRªgeChªge
(
PÜtID
 
ma¡”_pÜt_id
)

23 ià(
ma¡”_pÜt_id
 == 0)

25 
gÙAÎAddrRªges
 = 
Œue
;

26 
Ba£XB¬
::
	`»cvRªgeChªge
(
ma¡”_pÜt_id
);

29 
gÙAddrRªges
[
ma¡”_pÜt_id
] = 
Œue
;

30 
	}
}

32 
	gHMCCÚŒŞËr
::
	$rÙ©e_couÁ”
()

34 
cu¼’t_v®ue
 = 
¼_couÁ”
;

35 
¼_couÁ”
++;

36 ià(
¼_couÁ”
 =ğ
n_ma¡”_pÜts
)

37 
¼_couÁ”
 = 0;

38  
cu¼’t_v®ue
;

39 
	}
}

41 
boŞ
 
	gHMCCÚŒŞËr
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
)

44 
SÏvePÜt
 *
¤c_pÜt
 = 
¦avePÜts
[
¦ave_pÜt_id
];

47 
	`as£¹
(!
pkt
->
	`isEx´essSnoİ
());

51 
PÜtID
 
ma¡”_pÜt_id
 = 
	`rÙ©e_couÁ”
();

55 ià(!
»qLay”s
[
ma¡”_pÜt_id
]->
	`ŒyTimšg
(
¤c_pÜt
)) {

56 
	`DPRINTF
(
HMCCÚŒŞËr
, "recvTimingReq: src %s %s 0x%x BUSY\n",

57 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

58  
çl£
;

61 
	`DPRINTF
(
HMCCÚŒŞËr
, "recvTimingReq: src %s %s 0x%x\n",

62 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

66 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

67 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

70 
Tick
 
Şd_h—d”_d–ay
 = 
pkt
->
h—d”D–ay
;

73 
Tick
 
xb¬_d–ay
 = (
äÚ‹ndL©’cy
 + 
fÜw¬dL©’cy
è* 
	`şockP”iod
();

76 
	`ÿlcPack‘Timšg
(
pkt
, 
xb¬_d–ay
);

79 
Tick
 
·ck‘FšishTime
 = 
	`şockEdge
(
	`Cyşes
(1)è+ 
pkt
->
·ylßdD–ay
;

83 cÚ¡ 
boŞ
 
ex³ù_»¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
() &&

84 !
pkt
->
	`ÿcheRe¥Údšg
();

87 
boŞ
 
sucûss
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`£ndTimšgReq
(
pkt
);

89 ià(!
sucûss
) {

90 
	`DPRINTF
(
HMCCÚŒŞËr
, "recvTimingReq: src %s %s 0x%x RETRY\n",

91 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

94 
pkt
->
h—d”D–ay
 = 
Şd_h—d”_d–ay
;

97 
»qLay”s
[
ma¡”_pÜt_id
]->
	`çedTimšg
(
¤c_pÜt
,

98 
	`şockEdge
(
	`Cyşes
(1)));

100  
çl£
;

104 ià(
ex³ù_»¥Ú£
) {

105 
	`as£¹
(
rou‹To
.
	`fšd
(
pkt
->
»q
è=ğrou‹To.
	`’d
());

106 
rou‹To
[
pkt
->
»q
] = 
¦ave_pÜt_id
;

109 
»qLay”s
[
ma¡”_pÜt_id
]->
	`sucûededTimšg
(
·ck‘FšishTime
);

112 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

113 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

114 
ŒªsDi¡
[
pkt_cmd
]++;

116  
Œue
;

117 
	}
}

	@hmc_controller.hh

49 #iâdeà
__HMC_CONTROLLER__


50 
	#__HMC_CONTROLLER__


	)

52 
	~"mem/nÚcoh”’t_xb¬.hh
"

53 
	~"mem/pÜt.hh
"

54 
	~"·¿ms/HMCCÚŒŞËr.hh
"

75 şas 
	cHMCCÚŒŞËr
 : 
public
 
NÚcoh”’tXB¬


77 
public
:

79 
HMCCÚŒŞËr
(cÚ¡ 
HMCCÚŒŞËrP¬ams
 *
p
);

81 
	m´iv©e
:

85 
vœtu®
 
»cvRªgeChªge
(
PÜtID
 
ma¡”_pÜt_id
);

90 
vœtu®
 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
);

92 
	mn_ma¡”_pÜts
;

95 
	m¼_couÁ”
;

100 
rÙ©e_couÁ”
();

	@mem_checker.cc

41 
	~<ÿs£¹
>

43 
	~"mem/mem_check”.hh
"

46 
	gMemCheck”
::
Wr™eClu¡”
::
	$¡¬tWr™e
(
MemCheck”
::
S”Ÿl
 
£rŸl
, 
Tick
 
_¡¬t
,

47 
ušt8_t
 
d©a
)

49 
	`as£¹
(!
	`isCom¶‘e
());

51 ià(
¡¬t
 =ğ
TICK_FUTURE
) {

53 
¡¬t
 = 
_¡¬t
;

55 
	`ch©ty_as£¹
(
¡¬t
 <ğ
_¡¬t
, "WriteClusters must filled in order!");

57 ++
numIncom¶‘e
;

59 ià(
com¶‘e
 !ğ
TICK_FUTURE
) {

61 
	`as£¹
(
_¡¬t
 < 
com¶‘e
);

64 
com¶‘e
 = 
TICK_FUTURE
;

68 
wr™es
.
	`š£¹
(
¡d
::
	`make_·œ
(
£rŸl
,

69 
MemCheck”
::
	`T¿n§ùiÚ
(
£rŸl
, 
_¡¬t
, 
TICK_FUTURE
, 
d©a
)));

70 
	}
}

73 
	gMemCheck”
::
Wr™eClu¡”
::
	$com¶‘eWr™e
(
MemCheck”
::
S”Ÿl
 
£rŸl
, 
Tick
 
_com¶‘e
)

75 autØ
™
 = 
wr™es
.
	`fšd
(
£rŸl
);

77 ià(
™
 =ğ
wr™es
.
	`’d
()) {

78 
	`w¬n
("Could‚ot†ocate writeransaction: serial = %d, complete = %d\n",

79 
£rŸl
, 
_com¶‘e
);

84 
	`as£¹
(
™
->
£cÚd
.
com¶‘e
 =ğ
TICK_FUTURE
);

85 
™
->
£cÚd
.
com¶‘e
 = 
_com¶‘e
;

88 ià(
com¶‘eMax
 < 
_com¶‘e
) {

89 
com¶‘eMax
 = 
_com¶‘e
;

92 ià(--
numIncom¶‘e
 == 0) {

99 
com¶‘e
 = 
com¶‘eMax
;

101 
	}
}

104 
	gMemCheck”
::
Wr™eClu¡”
::
	$abÜtWr™e
(
MemCheck”
::
S”Ÿl
 
£rŸl
)

106 ià(!
wr™es
.
	`”a£
(
£rŸl
)) {

107 
	`w¬n
("Could‚Ù†oÿ‹ wr™Œª§ùiÚ: s”ŸÈğ%d\n", 
£rŸl
);

111 ià(--
numIncom¶‘e
 =ğ0 && !
wr™es
.
	`em±y
()) {

114 
com¶‘e
 = 
com¶‘eMax
;

120 
	}
}

123 
	gMemCheck”
::
By‹T¿ck”
::
	$¡¬tR—d
(
MemCheck”
::
S”Ÿl
 
£rŸl
, 
Tick
 
¡¬t
)

125 
out¡ªdšgR—ds
.
	`š£¹
(
¡d
::
	`make_·œ
(
£rŸl
,

126 
MemCheck”
::
	`T¿n§ùiÚ
(
£rŸl
, 
¡¬t
, 
TICK_FUTURE
)));

127 
	}
}

129 
boŞ


130 
	gMemCheck”
::
By‹T¿ck”
::
	$šEx³ùedD©a
(
Tick
 
¡¬t
, Tick 
com¶‘e
, 
ušt8_t
 
d©a
)

132 
_Ï¡Ex³ùedD©a
.
	`ş—r
();

134 
boŞ
 
wc_ov”Ïp
 = 
Œue
;

137 cÚ¡ 
T¿n§ùiÚ
& 
Ï¡_obs
 =

138 *
	`Ï¡Com¶‘edT¿n§ùiÚ
(&
»adOb£rv©iÚs
, 
¡¬t
);

139 
boŞ
 
Ï¡_obs_v®id
 = (
Ï¡_obs
.
com¶‘e
 !ğ
TICK_INITIAL
);

143 autØ
şu¡”
 = 
wr™eClu¡”s
.
	`rbegš
();

144 
şu¡”
 !ğ
wr™eClu¡”s
.
	`»nd
(è&& 
wc_ov”Ïp
; ++cluster) {

145 cÚ¡‡uto& 
addr_wr™e
 : 
şu¡”
->
wr™es
) {

146 cÚ¡ 
T¿n§ùiÚ
& 
wr™e
 = 
addr_wr™e
.
£cÚd
;

148 ià(
wr™e
.
com¶‘e
 < 
Ï¡_obs
.
¡¬t
) {

155 ià(
wr™e
.
d©a
 == data) {

157  
Œue
;

161 
_Ï¡Ex³ùedD©a
.
	`push_back
(
wr™e
.
d©a
);

163 ià(
wr™e
.
com¶‘e
 > 
¡¬t
) {

172 
wc_ov”Ïp
 = 
çl£
;

174 ià(
Ï¡_obs
.
com¶‘e
 < 
wr™e
.
¡¬t
) {

181 
Ï¡_obs_v®id
 = 
çl£
;

188 ià(
Ï¡_obs_v®id
) {

191 
	`as£¹
(
Ï¡_obs
.
com¶‘e
 <ğ
¡¬t
);

192 ià(
Ï¡_obs
.
d©a
 == data) {

194  
Œue
;

197 
_Ï¡Ex³ùedD©a
.
	`push_back
(
Ï¡_obs
.
d©a
);

203 ià(!
wr™eClu¡”s
.
	`em±y
(è&& 
wc_ov”Ïp
) {

205 
	`as£¹
(
wr™eClu¡”s
.
	`begš
()->
¡¬t
 < 
com¶‘e
 &&

206 
wr™eClu¡”s
.
	`rbegš
()->
com¶‘e
 > 
¡¬t
);

207  
Œue
;

211 ià(
_Ï¡Ex³ùedD©a
.
	`em±y
()) {

212 
	`as£¹
(
Ï¡_obs
.
com¶‘e
 =ğ
TICK_INITIAL
);

215 
	`DPRINTF
(
MemCheck”
, "no†ast observation‚or write! start = %d, "\

216 "com¶‘ğ%d, d©¨ğ%#x\n", 
¡¬t
, 
com¶‘e
, 
d©a
);

217  
Œue
;

219  
çl£
;

220 
	}
}

222 
boŞ


223 
	gMemCheck”
::
By‹T¿ck”
::
	$com¶‘eR—d
(
MemCheck”
::
S”Ÿl
 
£rŸl
,

224 
Tick
 
com¶‘e
, 
ušt8_t
 
d©a
)

226 autØ
™
 = 
out¡ªdšgR—ds
.
	`fšd
(
£rŸl
);

228 ià(
™
 =ğ
out¡ªdšgR—ds
.
	`’d
()) {

230 
	`w¬n
("Could‚ot†ocate„eadransaction: serial = %d, complete = %d\n",

231 
£rŸl
, 
com¶‘e
);

232  
Œue
;

235 
Tick
 
¡¬t
 = 
™
->
£cÚd
.start;

236 
out¡ªdšgR—ds
.
	`”a£
(
™
);

239 cÚ¡ 
boŞ
 
»suÉ
 = 
	`šEx³ùedD©a
(
¡¬t
, 
com¶‘e
, 
d©a
);

241 
»adOb£rv©iÚs
.
	`em¶aû_back
(
£rŸl
, 
¡¬t
, 
com¶‘e
, 
d©a
);

242 
	`´uÃT¿n§ùiÚs
();

244  
»suÉ
;

245 
	}
}

247 
	gMemCheck”
::
Wr™eClu¡”
*

248 
MemCheck”
::
By‹T¿ck”
::
	$g‘Incom¶‘eWr™eClu¡”
()

250 ià(
wr™eClu¡”s
.
	`em±y
(è|| wr™eClu¡”s.
	`back
().
	`isCom¶‘e
()) {

251 
wr™eClu¡”s
.
	`em¶aû_back
();

254  &
wr™eClu¡”s
.
	`back
();

255 
	}
}

258 
	gMemCheck”
::
By‹T¿ck”
::
	$¡¬tWr™e
(
MemCheck”
::
S”Ÿl
 
£rŸl
, 
Tick
 
¡¬t
,

259 
ušt8_t
 
d©a
)

261 
	`g‘Incom¶‘eWr™eClu¡”
()->
	`¡¬tWr™e
(
£rŸl
, 
¡¬t
, 
d©a
);

262 
	}
}

265 
	gMemCheck”
::
By‹T¿ck”
::
	$com¶‘eWr™e
(
MemCheck”
::
S”Ÿl
 
£rŸl
, 
Tick
 
com¶‘e
)

267 
	`g‘Incom¶‘eWr™eClu¡”
()->
	`com¶‘eWr™e
(
£rŸl
, 
com¶‘e
);

268 
	`´uÃT¿n§ùiÚs
();

269 
	}
}

272 
	gMemCheck”
::
By‹T¿ck”
::
	$abÜtWr™e
(
MemCheck”
::
S”Ÿl
 
£rŸl
)

274 
	`g‘Incom¶‘eWr™eClu¡”
()->
	`abÜtWr™e
(
£rŸl
);

275 
	}
}

278 
	gMemCheck”
::
By‹T¿ck”
::
	$´uÃT¿n§ùiÚs
()

283 cÚ¡ 
Tick
 
befÜe
 = 
out¡ªdšgR—ds
.
	`em±y
(è? 
	`curTick
() :

284 
out¡ªdšgR—ds
.
	`begš
()->
£cÚd
.
¡¬t
;

287 
»adOb£rv©iÚs
.
	`”a£
Ô—dOb£rv©iÚs.
	`begš
(),

288 
	`Ï¡Com¶‘edT¿n§ùiÚ
(&
»adOb£rv©iÚs
, 
befÜe
));

291 ià(!
wr™eClu¡”s
.
	`em±y
()) {

292 
wr™eClu¡”s
.
	`”a£
(wr™eClu¡”s.
	`begš
(),

293 
	`Ï¡Com¶‘edT¿n§ùiÚ
(&
wr™eClu¡”s
, 
befÜe
));

295 
	}
}

297 
boŞ


298 
	gMemCheck”
::
	$com¶‘eR—d
(
MemCheck”
::
S”Ÿl
 
£rŸl
, 
Tick
 
com¶‘e
,

299 
Addr
 
addr
, 
size_t
 
size
, 
ušt8_t
 *
d©a
)

301 
boŞ
 
»suÉ
 = 
Œue
;

303 
	`DPRINTF
(
MemCheck”
,

305 "add¸ğ%#Îx, sizğ%d\n", 
£rŸl
, 
com¶‘e
, 
addr
, 
size
);

307 
size_t
 
i
 = 0; i < 
size
; ++i) {

308 
By‹T¿ck”
 *
Œack”
 = 
	`g‘By‹T¿ck”
(
addr
 + 
i
);

310 ià(!
Œack”
->
	`com¶‘eR—d
(
£rŸl
, 
com¶‘e
, 
d©a
[
i
])) {

313 ià(
»suÉ
) {

314 
»suÉ
 = 
çl£
;

315 
”rÜMes§ge
 = "";

317 
”rÜMes§ge
 += "\n";

320 
”rÜMes§ge
 +ğ
	`c¥rštf
(" Readransaction for‡ddress %#llx "

322 ()(
addr
 + 
i
), 
d©a
[i]);

324 
size_t
 
j
 = 0; j < 
Œack”
->
	`Ï¡Ex³ùedD©a
().
	`size
(); ++j) {

325 
”rÜMes§ge
 +=

326 
	`c¥rštf
("%#x%s",

327 
Œack”
->
	`Ï¡Ex³ùedD©a
()[
j
],

328 (
j
 =ğ
Œack”
->
	`Ï¡Ex³ùedD©a
().
	`size
() - 1)

334 ià(!
»suÉ
) {

335 
	`DPRINTF
(
MemCheck”
, "»ad oà%#Îx @ cyş%d faed:\n%s\n", 
addr
,

336 
com¶‘e
, 
”rÜMes§ge
);

339  
»suÉ
;

340 
	}
}

343 
	gMemCheck”
::
	$»£t
(
Addr
 
addr
, 
size_t
 
size
)

345 
size_t
 
i
 = 0; i < 
size
; ++i) {

346 
by‹_Œack”s
.
	`”a£
(
addr
 + 
i
);

348 
	}
}

350 
MemCheck”
*

351 
	gMemCheck”P¬ams
::
	$ü—‹
()

353  
Ãw
 
	`MemCheck”
(
this
);

354 
	}
}

	@mem_checker.hh

41 #iâdeà
__MEM_MEM_CHECKER_HH__


42 
	#__MEM_MEM_CHECKER_HH__


	)

44 
	~<li¡
>

45 
	~<m­
>

46 
	~<¡ršg
>

47 
	~<unÜd”ed_m­
>

48 
	~<veùÜ
>

50 
	~"ba£/misc.hh
"

51 
	~"ba£/ty³s.hh
"

52 
	~"debug/MemCheck”.hh
"

53 
	~"·¿ms/MemCheck”.hh
"

54 
	~"sim/cÜe.hh
"

55 
	~"sim/sim_objeù.hh
"

71 şas 
	cMemCheck”
 : 
public
 
SimObjeù


73 
public
:

79 
ušt64_t
 
	tS”Ÿl
;

81 cÚ¡ 
S”Ÿl
 
	mSERIAL_INITIAL
 = 0;

88 cÚ¡ 
Tick
 
	mTICK_INITIAL
 = 0;

93 cÚ¡ 
Tick
 
	mTICK_FUTURE
 = 
MaxTick
;

98 cÚ¡ 
ušt8_t
 
	mDATA_INITIAL
 = 0x00;

104 şas 
	cT¿n§ùiÚ


106 
	mpublic
:

108 
T¿n§ùiÚ
(
S”Ÿl
 
_£rŸl
,

109 
Tick
 
_¡¬t
, Tick 
_com¶‘e
,

110 
ušt8_t
 
_d©a
 = 
DATA_INITIAL
)

111 : 
£rŸl
(
_£rŸl
),

112 
¡¬t
(
_¡¬t
), 
com¶‘e
(
_com¶‘e
),

113 
d©a
(
_d©a
)

116 
	mpublic
:

117 
S”Ÿl
 
£rŸl
;

118 
Tick
 
	m¡¬t
;

119 
Tick
 
	mcom¶‘e
;

126 
ušt8_t
 
	md©a
;

131 
boŞ
 
	mİ”©Ü
<(cÚ¡ 
	mT¿n§ùiÚ
& 
	mrhs
) const

132 {  
	m£rŸl
 < 
	mrhs
.serial; }

140 şas 
	cWr™eClu¡”


142 
	gpublic
:

143 
Wr™eClu¡”
()

144 : 
¡¬t
(
TICK_FUTURE
), 
com¶‘e
(TICK_FUTURE),

145 
com¶‘eMax
(
TICK_INITIAL
), 
numIncom¶‘e
(0)

156 
¡¬tWr™e
(
S”Ÿl
 
£rŸl
, 
Tick
 
_¡¬t
, 
ušt8_t
 
d©a
);

165 
com¶‘eWr™e
(
S”Ÿl
 
£rŸl
, 
Tick
 
_com¶‘e
);

172 
abÜtWr™e
(
S”Ÿl
 
£rŸl
);

177 
boŞ
 
isCom¶‘e
(ècÚ¡ {  
	gcom¶‘e
 !ğ
TICK_FUTURE
; }

179 
	gpublic
:

180 
Tick
 
¡¬t
;

181 
Tick
 
	gcom¶‘e
;

187 
	g¡d
::
unÜd”ed_m­
<
S”Ÿl
, 
	gT¿n§ùiÚ
> 
	gwr™es
;

189 
	g´iv©e
:

190 
Tick
 
com¶‘eMax
;

191 
size_t
 
	gnumIncom¶‘e
;

194 
	g¡d
::
	tli¡
<
	tT¿n§ùiÚ
> 
	tT¿n§ùiÚLi¡
;

195 
	g¡d
::
	tli¡
<
	tWr™eClu¡”
> 
	tWr™eClu¡”Li¡
;

202 şas 
	cBy‹T¿ck”
 : 
public
 
Named


204 
public
:

206 
By‹T¿ck”
(
Addr
 
addr
 = 0, cÚ¡ 
MemCheck”
 *
·»Á
 = 
NULL
)

207 : 
Named
((
·»Á
 !ğ
NULL
 ?…¬’t->
Çme
() : "") +

208 
c¥rštf
(".By‹T¿ck”@%#Îx", 
addr
))

213 
	g»adOb£rv©iÚs
.
em¶aû_back
(

214 
T¿n§ùiÚ
(
SERIAL_INITIAL
, 
TICK_INITIAL
, TICK_INITIAL,

215 
DATA_INITIAL
));

224 
¡¬tR—d
(
S”Ÿl
 
£rŸl
, 
Tick
 
¡¬t
);

250 
boŞ
 
šEx³ùedD©a
(
Tick
 
¡¬t
, Tick 
com¶‘e
, 
ušt8_t
 
d©a
);

259 
boŞ
 
com¶‘eR—d
(
S”Ÿl
 
£rŸl
, 
Tick
 
com¶‘e
, 
ušt8_t
 
d©a
);

270 
¡¬tWr™e
(
S”Ÿl
 
£rŸl
, 
Tick
 
¡¬t
, 
ušt8_t
 
d©a
);

279 
com¶‘eWr™e
(
S”Ÿl
 
£rŸl
, 
Tick
 
com¶‘e
);

287 
abÜtWr™e
(
S”Ÿl
 
£rŸl
);

298 cÚ¡ 
	g¡d
::
veùÜ
<
ušt8_t
>& 
Ï¡Ex³ùedD©a
() const

299 {  
_Ï¡Ex³ùedD©a
; }

301 
	g´iv©e
:

310 
Wr™eClu¡”
* 
g‘Incom¶‘eWr™eClu¡”
();

321 
	g‹m¶©e
 <
şass
 
	gTLi¡
>

322 
ty³Çme
 
	gTLi¡
::
™”©Ü
 
Ï¡Com¶‘edT¿n§ùiÚ
(
TLi¡
 *
l
, 
Tick
 
befÜe
)

324 
as£¹
(!
l
->
em±y
());

328 autØ
	g™
 = 
l
->
’d
();

330 --
	g™
; iˆ!ğ
l
->
begš
(è&& 
™
->
com¶‘e
 >ğ
befÜe
; --it);

332  
	g™
;

344 
´uÃT¿n§ùiÚs
();

346 
	g´iv©e
:

354 
¡d
::
m­
<
S”Ÿl
, 
	gT¿n§ùiÚ
> 
	gout¡ªdšgR—ds
;

359 
T¿n§ùiÚLi¡
 
	g»adOb£rv©iÚs
;

364 
Wr™eClu¡”Li¡
 
	gwr™eClu¡”s
;

369 
	g¡d
::
veùÜ
<
ušt8_t
> 
_Ï¡Ex³ùedD©a
;

372 
	gpublic
:

374 
	$MemCheck”
(cÚ¡ 
MemCheck”P¬ams
 *
p
)

375 : 
	`SimObjeù
(
p
),

376 
	$ÃxtS”Ÿl
(
SERIAL_INITIAL
)

377 {
	}
}

379 
	gvœtu®
 ~
	$MemCheck”
(è{
	}
}

390 
S”Ÿl
 
¡¬tR—d
(
Tick
 
¡¬t
, 
Addr
 
addr
, 
size_t
 
size
);

402 
S”Ÿl
 
¡¬tWr™e
(
Tick
 
¡¬t
, 
Addr
 
addr
, 
size_t
 
size
, cÚ¡ 
ušt8_t
 *
d©a
);

417 
boŞ
 
com¶‘eR—d
(
S”Ÿl
 
£rŸl
, 
Tick
 
com¶‘e
,

418 
Addr
 
addr
, 
size_t
 
size
, 
ušt8_t
 *
d©a
);

430 
com¶‘eWr™e
(
S”Ÿl
 
£rŸl
, 
Tick
 
com¶‘e
, 
Addr
 
addr
, 
size_t
 
size
);

440 
abÜtWr™e
(
S”Ÿl
 
£rŸl
, 
Addr
 
addr
, 
size_t
 
size
);

451 
	$»£t
()

452 { 
by‹_Œack”s
.
	`ş—r
(); 
	}
}

462 
»£t
(
Addr
 
addr
, 
size_t
 
size
);

473 cÚ¡ 
	g¡d
::
¡ršg
& 
	$g‘E¼ÜMes§ge
(ècÚ¡ {  
”rÜMes§ge
; 
	}
}

475 
	g´iv©e
:

479 
By‹T¿ck”
* 
	$g‘By‹T¿ck”
(
Addr
 
addr
)

481 autØ
™
 = 
by‹_Œack”s
.
	`fšd
(
addr
);

482 ià(
™
 =ğ
by‹_Œack”s
.
	`’d
()) {

483 
™
 = 
by‹_Œack”s
.
	`š£¹
(

484 
¡d
::
	`make_·œ
(
addr
, 
	`By‹T¿ck”
×ddr, 
this
))).
fœ¡
;

486  &
™
->
£cÚd
;

487 
	}
};

489 
	g´iv©e
:

493 
¡d
::
¡ršg
 
”rÜMes§ge
;

499 
S”Ÿl
 
	gÃxtS”Ÿl
;

512 
	g¡d
::
unÜd”ed_m­
<
Addr
, 
	gBy‹T¿ck”
> 
	gby‹_Œack”s
;

515 
šlše
 
	gMemCheck”
::
S”Ÿl


516 
MemCheck”
::
	$¡¬tR—d
(
Tick
 
¡¬t
, 
Addr
 
addr
, 
size_t
 
size
)

518 
	`DPRINTF
(
MemCheck”
,

520 "sizğ%d\n", 
ÃxtS”Ÿl
, 
¡¬t
, 
addr
 , 
size
);

522 
size_t
 
i
 = 0; i < 
size
; ++i) {

523 
	`g‘By‹T¿ck”
(
addr
 + 
i
)->
	`¡¬tR—d
(
ÃxtS”Ÿl
, 
¡¬t
);

526  
ÃxtS”Ÿl
++;

527 
	}
}

529 
šlše
 
	gMemCheck”
::
S”Ÿl


530 
MemCheck”
::
	$¡¬tWr™e
(
Tick
 
¡¬t
, 
Addr
 
addr
, 
size_t
 
size
, cÚ¡ 
ušt8_t
 *
d©a
)

532 
	`DPRINTF
(
MemCheck”
,

534 "sizğ%d\n", 
ÃxtS”Ÿl
, 
¡¬t
, 
addr
, 
size
);

536 
size_t
 
i
 = 0; i < 
size
; ++i) {

537 
	`g‘By‹T¿ck”
(
addr
 + 
i
)->
	`¡¬tWr™e
(
ÃxtS”Ÿl
, 
¡¬t
, 
d©a
[i]);

540  
ÃxtS”Ÿl
++;

541 
	}
}

543 
šlše
 

544 
	gMemCheck”
::
	$com¶‘eWr™e
(
MemCheck”
::
S”Ÿl
 
£rŸl
, 
Tick
 
com¶‘e
,

545 
Addr
 
addr
, 
size_t
 
size
)

547 
	`DPRINTF
(
MemCheck”
,

549 "add¸ğ%#Îx, sizğ%d\n", 
£rŸl
, 
com¶‘e
, 
addr
, 
size
);

551 
size_t
 
i
 = 0; i < 
size
; ++i) {

552 
	`g‘By‹T¿ck”
(
addr
 + 
i
)->
	`com¶‘eWr™e
(
£rŸl
, 
com¶‘e
);

554 
	}
}

556 
šlše
 

557 
	gMemCheck”
::
	$abÜtWr™e
(
MemCheck”
::
S”Ÿl
 
£rŸl
, 
Addr
 
addr
, 
size_t
 
size
)

559 
	`DPRINTF
(
MemCheck”
,

561 
£rŸl
, 
addr
, 
size
);

563 
size_t
 
i
 = 0; i < 
size
; ++i) {

564 
	`g‘By‹T¿ck”
(
addr
 + 
i
)->
	`abÜtWr™e
(
£rŸl
);

566 
	}
}

	@mem_checker_monitor.cc

42 
	~<memÜy
>

44 
	~"ba£/ouut.hh
"

45 
	~"ba£/Œaû.hh
"

46 
	~"debug/MemCheck”MÚ™Ü.hh
"

47 
	~"mem/mem_check”_mÚ™Ü.hh
"

49 
usšg
 
Çme¥aû
 
	g¡d
;

51 
	gMemCheck”MÚ™Ü
::
	$MemCheck”MÚ™Ü
(
P¬ams
* 
·¿ms
)

52 : 
	`MemObjeù
(
·¿ms
),

53 
	`ma¡”PÜt
(
	`Çme
(è+ "-ma¡”", *
this
),

54 
	`¦avePÜt
(
	`Çme
(è+ "-¦ave", *
this
),

55 
	`w¬nOÆy
(
·¿ms
->
w¬n_Úly
),

56 
	`memcheck”
(
·¿ms
->
memcheck”
)

57 {
	}
}

59 
	gMemCheck”MÚ™Ü
::~
	$MemCheck”MÚ™Ü
()

60 {
	}
}

62 
MemCheck”MÚ™Ü
*

63 
MemCheck”MÚ™ÜP¬ams
::
	$ü—‹
()

65  
Ãw
 
	`MemCheck”MÚ™Ü
(
this
);

66 
	}
}

69 
	gMemCheck”MÚ™Ü
::
	$š™
()

72 ià(!
¦avePÜt
.
	`isCÚÃùed
(è|| !
ma¡”PÜt
.isConnected())

73 
	`çl
("Communication monitor is‚ot connected on both sides.\n");

74 
	}
}

76 
	gBa£Ma¡”PÜt
&

77 
	gMemCheck”MÚ™Ü
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
, 
PÜtID
 
idx
)

79 ià(
if_Çme
 == "master" || if_name == "mem_side") {

80  
ma¡”PÜt
;

82  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

84 
	}
}

86 
	gBa£SÏvePÜt
&

87 
	gMemCheck”MÚ™Ü
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
, 
PÜtID
 
idx
)

89 ià(
if_Çme
 == "slave" || if_name == "cpu_side") {

90  
¦avePÜt
;

92  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

94 
	}
}

97 
	gMemCheck”MÚ™Ü
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

99 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

100 
size
 = 
pkt
->
	`g‘Size
();

105 
memcheck”
->
	`»£t
(
addr
, 
size
);

107 
ma¡”PÜt
.
	`£ndFunùiÚ®
(
pkt
);

109 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

111 
addr
, 
size
);

112 
	}
}

115 
	gMemCheck”MÚ™Ü
::
	$»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

117 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

118 
size
 = 
pkt
->
	`g‘Size
();

121 
memcheck”
->
	`»£t
(
addr
, 
size
);

123 
¦avePÜt
.
	`£ndFunùiÚ®Snoİ
(
pkt
);

125 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

127 
addr
, 
size
);

128 
	}
}

130 
Tick


131 
	gMemCheck”MÚ™Ü
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

133 
	`as£¹
(
çl£
 && "Atomic‚ot supported");

134  
ma¡”PÜt
.
	`£ndAtomic
(
pkt
);

135 
	}
}

137 
Tick


138 
	gMemCheck”MÚ™Ü
::
	$»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

140 
	`as£¹
(
çl£
 && "Atomic‚ot supported");

141  
¦avePÜt
.
	`£ndAtomicSnoİ
(
pkt
);

142 
	}
}

144 
boŞ


145 
	gMemCheck”MÚ™Ü
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

148 
	`as£¹
(
pkt
->
	`isReque¡
());

155 
boŞ
 
is_»ad
 = 
pkt
->
	`isR—d
(è&& !pkt->
»q
->
	`isP»ãtch
();

156 
boŞ
 
is_wr™e
 = 
pkt
->
	`isWr™e
();

157 
size
 = 
pkt
->
	`g‘Size
();

158 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

159 
boŞ
 
ex³ùs_»¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
(è&& !pkt->
	`ÿcheRe¥Údšg
();

160 
¡d
::
unique_±r
<
ušt8_t
[]> 
pkt_d©a
;

161 
MemCheck”MÚ™ÜS’d”S‹
* 
¡©e
 = 
NULL
;

163 ià(
ex³ùs_»¥Ú£
 && 
is_wr™e
) {

167 
pkt_d©a
.
	`»£t
(
Ãw
 
ušt8_t
[
size
]);

168 
	`memıy
(
pkt_d©a
.
	`g‘
(), 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
*>(), 
size
);

175 ià(
ex³ùs_»¥Ú£
 && (
is_»ad
 || 
is_wr™e
)) {

176 
¡©e
 = 
Ãw
 
	`MemCheck”MÚ™ÜS’d”S‹
(0);

177 
pkt
->
	`pushS’d”S‹
(
¡©e
);

181 
boŞ
 
sucûssful
 = 
ma¡”PÜt
.
	`£ndTimšgReq
(
pkt
);

184 ià(!
sucûssful
 && 
ex³ùs_»¥Ú£
 && (
is_»ad
 || 
is_wr™e
)) {

185 
d–‘e
 
pkt
->
	`pİS’d”S‹
();

188 ià(
sucûssful
 && 
ex³ùs_»¥Ú£
) {

189 ià(
is_»ad
) {

190 
MemCheck”
::
S”Ÿl
 
£rŸl
 = 
memcheck”
->
	`¡¬tR—d
(
	`curTick
(),

191 
addr
,

192 
size
);

205 
¡©e
->
£rŸl
 = serial;

207 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

210 
£rŸl
, 
addr
, 
size
);

211 } ià(
is_wr™e
) {

212 
MemCheck”
::
S”Ÿl
 
£rŸl
 = 
memcheck”
->
	`¡¬tWr™e
(
	`curTick
(),

213 
addr
,

214 
size
,

215 
pkt_d©a
.
	`g‘
());

217 
¡©e
->
£rŸl
 = serial;

219 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

222 
£rŸl
, 
addr
, 
size
);

224 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

225 "FÜw¬ded‚Ú„—d/wr™»que¡:‡dd¸ğ%#Îx\n", 
addr
);

227 } ià(
sucûssful
) {

228 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

230 
addr
);

233  
sucûssful
;

234 
	}
}

236 
boŞ


237 
	gMemCheck”MÚ™Ü
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

240 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

244 
boŞ
 
is_»ad
 = 
pkt
->
	`isR—d
(è&& !pkt->
»q
->
	`isP»ãtch
();

245 
boŞ
 
is_wr™e
 = 
pkt
->
	`isWr™e
();

246 
boŞ
 
is_çed_LLSC
 = 
pkt
->
	`isLLSC
(è&&…kt->
»q
->
	`g‘ExŒaD©a
() == 0;

247 
size
 = 
pkt
->
	`g‘Size
();

248 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

249 
¡d
::
unique_±r
<
ušt8_t
[]> 
pkt_d©a
;

250 
MemCheck”MÚ™ÜS’d”S‹
* 
»ûived_¡©e
 = 
NULL
;

252 ià(
is_»ad
) {

256 
pkt_d©a
.
	`»£t
(
Ãw
 
ušt8_t
[
size
]);

257 
	`memıy
(
pkt_d©a
.
	`g‘
(), 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
*>(), 
size
);

260 ià(
is_»ad
 || 
is_wr™e
) {

261 
»ûived_¡©e
 =

262 
dyÇmic_ÿ¡
<
MemCheck”MÚ™ÜS’d”S‹
*>(
pkt
->
£nd”S‹
);

265 
	`·nic_if
(
»ûived_¡©e
 =ğ
NULL
,

269 
pkt
->
£nd”S‹
 = 
»ûived_¡©e
->
´edeûssÜ
;

273 
boŞ
 
sucûssful
 = 
¦avePÜt
.
	`£ndTimšgRe¥
(
pkt
);

277 ià(
sucûssful
) {

278 ià(
is_»ad
) {

279 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

282 
»ûived_¡©e
->
£rŸl
, 
addr
, 
size
);

284 
boŞ
 
»suÉ
 = 
memcheck”
->
	`com¶‘eR—d
(
»ûived_¡©e
->
£rŸl
,

285 
	`curTick
(),

286 
addr
,

287 
size
,

288 
pkt_d©a
.
	`g‘
());

290 ià(!
»suÉ
) {

291 
	`w¬n
("%s:„ead of %#llx @ cycle %d failed:\n%s\n",

292 
	`Çme
(),

293 
addr
, 
	`curTick
(),

294 
memcheck”
->
	`g‘E¼ÜMes§ge
().
	`c_¡r
());

296 
	`·nic_if
(!
w¬nOÆy
, "MemChecker violation!");

299 
d–‘e
 
»ûived_¡©e
;

300 } ià(
is_wr™e
) {

301 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

304 
»ûived_¡©e
->
£rŸl
, 
addr
, 
size
);

306 ià(
is_çed_LLSC
) {

308 
memcheck”
->
	`abÜtWr™e
(
»ûived_¡©e
->
£rŸl
,

309 
addr
,

310 
size
);

312 
memcheck”
->
	`com¶‘eWr™e
(
»ûived_¡©e
->
£rŸl
,

313 
	`curTick
(),

314 
addr
,

315 
size
);

318 
d–‘e
 
»ûived_¡©e
;

320 
	`DPRINTF
(
MemCheck”MÚ™Ü
,

321 "Reûived‚Ú„—d/wr™»¥Ú£:‡dd¸ğ%#Îx\n", 
addr
);

323 } ià(
is_»ad
 || 
is_wr™e
) {

326 
pkt
->
£nd”S‹
 = 
»ûived_¡©e
;

329  
sucûssful
;

330 
	}
}

333 
	gMemCheck”MÚ™Ü
::
	$»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

335 
¦avePÜt
.
	`£ndTimšgSnoİReq
(
pkt
);

336 
	}
}

338 
boŞ


339 
	gMemCheck”MÚ™Ü
::
	$»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

341  
ma¡”PÜt
.
	`£ndTimšgSnoİRe¥
(
pkt
);

342 
	}
}

344 
boŞ


345 
	gMemCheck”MÚ™Ü
::
	$isSnoİšg
() const

348  
¦avePÜt
.
	`isSnoİšg
();

349 
	}
}

351 
AddrRªgeLi¡


352 
	gMemCheck”MÚ™Ü
::
	$g‘AddrRªges
() const

355  
ma¡”PÜt
.
	`g‘AddrRªges
();

356 
	}
}

359 
	gMemCheck”MÚ™Ü
::
	$»cvReqR‘ry
()

361 
¦avePÜt
.
	`£ndR‘ryReq
();

362 
	}
}

365 
	gMemCheck”MÚ™Ü
::
	$»cvRe¥R‘ry
()

367 
ma¡”PÜt
.
	`£ndR‘ryRe¥
();

368 
	}
}

371 
	gMemCheck”MÚ™Ü
::
	$»cvRªgeChªge
()

373 
¦avePÜt
.
	`£ndRªgeChªge
();

374 
	}
}

	@mem_checker_monitor.hh

42 #iâdeà
__MEM_MEM_CHECKER_MONITOR_HH__


43 
	#__MEM_MEM_CHECKER_MONITOR_HH__


	)

45 
	~"ba£/¡©i¡ics.hh
"

46 
	~"mem/mem_check”.hh
"

47 
	~"mem/mem_objeù.hh
"

48 
	~"·¿ms/MemCheck”MÚ™Ü.hh
"

49 
	~"sim/sy¡em.hh
"

54 şas 
	cMemCheck”MÚ™Ü
 : 
public
 
MemObjeù


56 
public
:

59 
MemCheck”MÚ™ÜP¬ams
 
	tP¬ams
;

60 cÚ¡ 
P¬ams
* 
	$·¿ms
() const

61 {  
»š‹½»t_ÿ¡
<cÚ¡ 
P¬ams
*>(
_·¿ms
); }

68 
	`MemCheck”MÚ™Ü
(
P¬ams
* 
·¿ms
);

71 ~
	`MemCheck”MÚ™Ü
();

73 
vœtu®
 
Ba£Ma¡”PÜt
& 
	`g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

74 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

76 
vœtu®
 
Ba£SÏvePÜt
& 
	`g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

77 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

79 
vœtu®
 
	`š™
();

81 
´iv©e
:

83 
MemCheck”MÚ™ÜS’d”S‹
 : 
public
 
Pack‘
::
S’d”S‹


85 
	`MemCheck”MÚ™ÜS’d”S‹
(
MemCheck”
::
S”Ÿl
 
_£rŸl
)

86 : 
	`£rŸl
(
_£rŸl
)

89 
MemCheck”
::
S”Ÿl
 
£rŸl
;

90 
	}
};

98 şas 
	cMÚ™ÜMa¡”PÜt
 : 
public
 
Ma¡”PÜt


101 
public
:

103 
MÚ™ÜMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
MemCheck”MÚ™Ü
& 
_mÚ
)

104 : 
Ma¡”PÜt
(
_Çme
, &
_mÚ
), 
mÚ
(_mon)

107 
	g´Ùeùed
:

109 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

111 
mÚ
.
»cvFunùiÚ®Snoİ
(
pkt
);

114 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

116  
	gmÚ
.
»cvAtomicSnoİ
(
pkt
);

119 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

121  
	gmÚ
.
»cvTimšgRe¥
(
pkt
);

124 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

126 
	gmÚ
.
»cvTimšgSnoİReq
(
pkt
);

129 
»cvRªgeChªge
()

131 
	gmÚ
.
»cvRªgeChªge
();

134 
boŞ
 
isSnoİšg
() const

136  
	gmÚ
.
isSnoİšg
();

139 
»cvReqR‘ry
()

141 
	gmÚ
.
»cvReqR‘ry
();

144 
	g´iv©e
:

146 
MemCheck”MÚ™Ü
& 
mÚ
;

151 
MÚ™ÜMa¡”PÜt
 
	gma¡”PÜt
;

159 şas 
	cMÚ™ÜSÏvePÜt
 : 
public
 
SÏvePÜt


162 
public
:

164 
MÚ™ÜSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
MemCheck”MÚ™Ü
& 
_mÚ
)

165 : 
SÏvePÜt
(
_Çme
, &
_mÚ
), 
mÚ
(_mon)

168 
	g´Ùeùed
:

170 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

172 
mÚ
.
»cvFunùiÚ®
(
pkt
);

175 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
)

177  
	gmÚ
.
»cvAtomic
(
pkt
);

180 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

182  
	gmÚ
.
»cvTimšgReq
(
pkt
);

185 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

187  
	gmÚ
.
»cvTimšgSnoİRe¥
(
pkt
);

190 
AddrRªgeLi¡
 
g‘AddrRªges
() const

192  
	gmÚ
.
g‘AddrRªges
();

195 
»cvRe¥R‘ry
()

197 
	gmÚ
.
»cvRe¥R‘ry
();

200 
	g´iv©e
:

202 
MemCheck”MÚ™Ü
& 
mÚ
;

207 
MÚ™ÜSÏvePÜt
 
	g¦avePÜt
;

209 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

211 
»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
);

213 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

215 
Tick
 
»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
);

217 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

219 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

221 
»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
);

223 
boŞ
 
»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
);

225 
AddrRªgeLi¡
 
	$g‘AddrRªges
() const;

227 
boŞ
 
	$isSnoİšg
() const;

229 
	`»cvReqR‘ry
();

231 
	`»cvRe¥R‘ry
();

233 
	`»cvRªgeChªge
();

235 
boŞ
 
w¬nOÆy
;

237 
MemCheck”
 *
memcheck”
;

238 
	}
};

	@mem_object.cc

44 
	~"mem/mem_objeù.hh
"

46 
	gMemObjeù
::
	$MemObjeù
(cÚ¡ 
P¬ams
 *
·¿ms
)

47 : 
	$ClockedObjeù
(
·¿ms
)

49 
	}
}

51 
Ba£Ma¡”PÜt
&

52 
MemObjeù
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
, 
PÜtID
 
idx
)

54 
	`çl
("% dÛ nÙ havªy ma¡”…ÜˆÇmed %s\n", 
	`Çme
(), 
if_Çme
);

55 
	}
}

57 
	gBa£SÏvePÜt
&

58 
	gMemObjeù
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
, 
PÜtID
 
idx
)

60 
	`çl
("% dÛ nÙ havªy sÏvpÜˆÇmed %s\n", 
	`Çme
(), 
if_Çme
);

61 
	}
}

	@mem_object.hh

49 #iâdeà
__MEM_MEM_OBJECT_HH__


50 
	#__MEM_MEM_OBJECT_HH__


	)

52 
	~"mem/pÜt.hh
"

53 
	~"·¿ms/MemObjeù.hh
"

54 
	~"sim/şocked_objeù.hh
"

60 şas 
	cMemObjeù
 : 
public
 
ClockedObjeù


62 
public
:

63 
MemObjeùP¬ams
 
	tP¬ams
;

64 cÚ¡ 
P¬ams
 *
	$·¿ms
() const

65 {  
dyÇmic_ÿ¡
<cÚ¡ 
P¬ams
 *>(
_·¿ms
); }

67 
	`MemObjeù
(cÚ¡ 
P¬ams
 *
·¿ms
);

79 
vœtu®
 
Ba£Ma¡”PÜt
& 
	`g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

80 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

92 
vœtu®
 
Ba£SÏvePÜt
& 
	`g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

93 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

94 
	}
};

	@mport.cc

43 
	~"mem/mpÜt.hh
"

45 
Tick


46 
	gMes§geSÏvePÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

48 ià(
pkt
->
cmd
 =ğ
MemCmd
::
Mes§geReq
) {

49  
	`»cvMes§ge
(
pkt
);

51 
	`·nic
("%s„eceived unexpected‡tomic command %s from %s.\n",

52 
	`Çme
(), 
pkt
->
cmd
.
	`toSŒšg
(), 
	`g‘Ma¡”PÜt
().name());

54 
	}
}

	@mport.hh

43 #iâdeà
__MEM_MPORT_HH__


44 
	#__MEM_MPORT_HH__


	)

46 
	~"mem/mem_objeù.hh
"

47 
	~"mem/Üt.hh
"

56 şas 
	cMes§geSÏvePÜt
 : 
public
 
Sim¶eTimšgPÜt


59 
public
:

60 
	$Mes§geSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, 
MemObjeù
 *
owÃr
) :

61 
	$Sim¶eTimšgPÜt
(
Çme
, 
owÃr
)

64 
vœtu®
 ~
	$Mes§geSÏvePÜt
()

65 {
	}
}

67 
	g´Ùeùed
:

69 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

71 
vœtu®
 
Tick
 
»cvMes§ge
(
Pack‘PŒ
 
pkt
) = 0;

74 şas 
	cMes§geMa¡”PÜt
 : 
public
 
QueuedMa¡”PÜt


76 
public
:

78 
	$Mes§geMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, 
MemObjeù
 *
owÃr
) :

79 
	`QueuedMa¡”PÜt
(
Çme
, 
owÃr
, 
»qQueue
, 
¢oİRe¥Queue
),

80 
	`»qQueue
(*
owÃr
, *
this
), 
	$¢oİRe¥Queue
(*
owÃr
, *
this
)

83 
vœtu®
 ~
	$Mes§geMa¡”PÜt
()

84 {
	}
}

86 
boŞ
 
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
è{ 
	`»cvRe¥Ú£
Õkt);  
Œue
; 
	}
}

88 
	g´Ùeùed
:

91 
ReqPack‘Queue
 
»qQueue
;

92 
SnoİRe¥Pack‘Queue
 
	g¢oİRe¥Queue
;

95 
vœtu®
 
Tick
 
	$»cvRe¥Ú£
(
Pack‘PŒ
 
pkt
)

98 
	}
}

	@multi_level_page_table.cc

31 
	~"mem/muÉi_Ëv–_·ge_bË_im¶.hh
"

33 
‹m¶©e
 
şass
 
	gMuÉiLev–PageTabË
<
	gTheISA
::
PageTabËOps
>;

	@multi_level_page_table.hh

36 #iâdeà
__MEM_MULTI_LEVEL_PAGE_TABLE_HH__


37 
	#__MEM_MULTI_LEVEL_PAGE_TABLE_HH__


	)

39 
	~<¡ršg
>

41 
	~"¬ch/i§_Œa™s.hh
"

42 
	~"¬ch/b.hh
"

43 
	~"ba£/ty³s.hh
"

44 
	~"cÚfig/the_i§.hh
"

45 
	~"mem/·ge_bË.hh
"

46 
	~"sim/£rŸlize.hh
"

47 
	~"sim/sy¡em.hh
"

104 
	g‹m¶©e
 <
şass
 
	gISAOps
>

105 şas 
	cMuÉiLev–PageTabË
 : 
public
 
PageTabËBa£


110 
ISAOps
 
pTabËISAOps
;

115 
Sy¡em
 *
	msy¡em
;

120 
Addr
 
	mba£PŒ
;

125 cÚ¡ 
	m¡d
::
veùÜ
<
ušt8_t
> 
logLev–Size
;

130 cÚ¡ 
ušt64_t
 
	mnumLev–s
;

141 
boŞ
 
w®k
(
Addr
 
vaddr
, boŞ 
®loÿ‹
, Add¸&
PTE_addr
);

143 
	mpublic
:

144 
MuÉiLev–PageTabË
(cÚ¡ 
¡d
::
¡ršg
 &
__Çme
, 
ušt64_t
 
_pid
,

145 
Sy¡em
 *
_sys
);

146 ~
MuÉiLev–PageTabË
();

148 
	$š™S‹
(
Th»adCÚ‹xt
* 
tc
è
ov”ride
;

150 
	$m­
(
Addr
 
vaddr
, Add¸
·ddr
, 
št64_t
 
size
,

151 
ušt64_t
 
æags
 = 0è
ov”ride
;

152 
	$»m­
(
Addr
 
vaddr
, 
št64_t
 
size
, Add¸
Ãw_vaddr
è
ov”ride
;

153 
	$unm­
(
Addr
 
vaddr
, 
št64_t
 
size
è
ov”ride
;

154 
boŞ
 
	$isUnm­³d
(
Addr
 
vaddr
, 
št64_t
 
size
è
ov”ride
;

155 
boŞ
 
	$lookup
(
Addr
 
vaddr
, 
TheISA
::
TlbEÁry
 &
’Œy
è
ov”ride
;

156 
	$£rŸlize
(
CheckpoštOut
 &
ı
ècÚ¡ 
ov”ride
;

157 
	$un£rŸlize
(
CheckpoštIn
 &
ı
è
ov”ride
;

	@multi_level_page_table_impl.hh

35 
	~<f¡»am
>

36 
	~<m­
>

37 
	~<¡ršg
>

39 
	~"ba£/b™f›ld.hh
"

40 
	~"ba£/štm©h.hh
"

41 
	~"ba£/Œaû.hh
"

42 
	~"cÚfig/the_i§.hh
"

43 
	~"debug/MMU.hh
"

44 
	~"mem/muÉi_Ëv–_·ge_bË.hh
"

45 
	~"sim/çuÉs.hh
"

46 
	~"sim/sim_objeù.hh
"

48 
usšg
 
Çme¥aû
 
	g¡d
;

49 
usšg
 
Çme¥aû
 
	gTheISA
;

51 
	g‹m¶©e
 <
şass
 
	gISAOps
>

52 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$MuÉiLev–PageTabË
(cÚ¡ 
¡d
::
¡ršg
 &
__Çme
,

53 
ušt64_t
 
_pid
, 
Sy¡em
 *
_sys
)

54 : 
	`PageTabËBa£
(
__Çme
, 
_pid
), 
	`sy¡em
(
_sys
),

55 
	`logLev–Size
(
PageTabËLayout
),

56 
	`numLev–s
(
logLev–Size
.
	$size
())

58 
	}
}

60 
	g‹m¶©e
 <
şass
 
	gISAOps
>

61 
	gMuÉiLev–PageTabË
<
	gISAOps
>::~
	$MuÉiLev–PageTabË
()

63 
	}
}

65 
‹m¶©e
 <
şass
 
ISAOps
>

67 
MuÉiLev–PageTabË
<
ISAOps
>::
	$š™S‹
(
Th»adCÚ‹xt
* 
tc
)

69 
ba£PŒ
 = 
pTabËISAOps
.
	`g‘Ba£PŒ
(
tc
);

70 ià(
ba£PŒ
 == 0) basePtr++;

71 
	`DPRINTF
(
MMU
, "ba£PŒ: %d\n", 
ba£PŒ
);

73 
sy¡em
->
·gePŒ
 = 
ba£PŒ
;

76 
ušt64_t
 
log_»q_size
 = 
	`æoÜLog2
((
PageTabËEÁry
)) +

77 
logLev–Size
[
numLev–s
-1];

78 
	`as£¹
(
log_»q_size
 >ğ
PageShiá
);

79 
ušt64_t
 
Åages
 = 1 << (
log_»q_size
 - 
PageShiá
);

81 
Addr
 
·ddr
 = 
sy¡em
->
	`®locPhysPages
(
Åages
);

83 
PÜtProxy
 &
p
 = 
sy¡em
->
physProxy
;

84 
p
.
	`mem£tBlob
(
·ddr
, 0, 
Åages
 << 
PageShiá
);

85 
	}
}

88 
	g‹m¶©e
 <
şass
 
	gISAOps
>

89 
boŞ


90 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$w®k
(
Addr
 
vaddr
, 
boŞ
 
®loÿ‹
, Add¸&
PTE_addr
)

92 
¡d
::
veùÜ
<
ušt64_t
> 
off£ts
 = 
pTabËISAOps
.
	`g‘Off£ts
(
vaddr
);

94 
Addr
 
Ëv–_ba£
 = 
ba£PŒ
;

95 
i
 = 
numLev–s
 - 1; i > 0; i--) {

97 
Addr
 
’Œy_addr
 = (
Ëv–_ba£
<<
PageShiá
) +

98 
off£ts
[
i
] * (
PageTabËEÁry
);

100 
PÜtProxy
 &
p
 = 
sy¡em
->
physProxy
;

101 
PageTabËEÁry
 
’Œy
 = 
p
.
»ad
<PageTabËEÁry>(
’Œy_addr
);

103 
Addr
 
Ãxt_’Œy_²um
 = 
pTabËISAOps
.
	`g‘Pnum
(
’Œy
);

104 ià(
Ãxt_’Œy_²um
 == 0) {

106 ià(!
®loÿ‹
è 
çl£
;

108 
ušt64_t
 
log_»q_size
 = 
	`æoÜLog2
((
PageTabËEÁry
)) +

109 
logLev–Size
[
i
-1];

110 
	`as£¹
(
log_»q_size
 >ğ
PageShiá
);

111 
ušt64_t
 
Åages
 = 1 << (
log_»q_size
 - 
PageShiá
);

113 
	`DPRINTF
(
MMU
, "Allocating %d…ages‚eeded forƒntry in†evel %d\n",

114 
Åages
, 
i
 - 1);

117 
Addr
 
Ãxt_’Œy_·ddr
 = 
sy¡em
->
	`®locPhysPages
(
Åages
);

118 
p
.
	`mem£tBlob
(
Ãxt_’Œy_·ddr
, 0, 
Åages
 << 
PageShiá
);

120 
Ãxt_’Œy_²um
 = 
Ãxt_’Œy_·ddr
 >> 
PageShiá
;

121 
pTabËISAOps
.
	`£tPnum
(
’Œy
, 
Ãxt_’Œy_²um
);

122 
pTabËISAOps
.
	`£tPTEF›lds
(
’Œy
);

123 
p
.
wr™e
<
PageTabËEÁry
>(
’Œy_addr
, 
’Œy
);

126 
	`DPRINTF
(
MMU
, "Level %d base: %d offset: %dƒntry: %d\n",

127 
i
, 
Ëv–_ba£
, 
off£ts
[i], 
Ãxt_’Œy_²um
);

128 
Ëv–_ba£
 = 
Ãxt_’Œy_²um
;

131 
PTE_addr
 = (
Ëv–_ba£
<<
PageShiá
) +

132 
off£ts
[0] * (
PageTabËEÁry
);

133 
	`DPRINTF
(
MMU
, "R‘uºšg PTE_addr: %x\n", 
PTE_addr
);

134  
Œue
;

135 
	}
}

137 
	g‹m¶©e
 <
şass
 
	gISAOps
>

139 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$m­
(
Addr
 
vaddr
, Add¸
·ddr
,

140 
št64_t
 
size
, 
ušt64_t
 
æags
)

142 
boŞ
 
şobb”
 = 
æags
 & 
Clobb”
;

144 
	`as£¹
(
	`·geOff£t
(
vaddr
) == 0);

146 
	`DPRINTF
(
MMU
, "AÎoÿtšg Page: %#x-%#x\n", 
vaddr
, vadd¸+ 
size
);

148 
PÜtProxy
 &
p
 = 
sy¡em
->
physProxy
;

150 ; 
size
 > 0; siz-ğ
·geSize
, 
vaddr
 +ğ·geSize, 
·ddr
 +=…ageSize) {

151 
Addr
 
PTE_addr
;

152 ià(
	`w®k
(
vaddr
, 
Œue
, 
PTE_addr
)) {

153 
PageTabËEÁry
 
PTE
 = 
p
.
»ad
<PageTabËEÁry>(
PTE_addr
);

154 
Addr
 
’Œy_·ddr
 = 
pTabËISAOps
.
	`g‘Pnum
(
PTE
);

155 ià(!
şobb”
 && 
’Œy_·ddr
 != 0) {

156 
	`çl
("add¸0x%x‡Ì—dy m­³dØ%x", 
vaddr
, 
’Œy_·ddr
);

158 
pTabËISAOps
.
	`£tPnum
(
PTE
, 
·ddr
 >> 
PageShiá
);

159 
ušt64_t
 
PTE_æags
 = 0;

160 ià(
æags
 & 
NÙP»£Á
)

161 
PTE_æags
 |ğ
TheISA
::
PTE_NÙP»£Á
;

162 ià(
æags
 & 
Unÿch—bË
)

163 
PTE_æags
 |ğ
TheISA
::
PTE_Unÿch—bË
;

164 ià(
æags
 & 
R—dOÆy
)

165 
PTE_æags
 |ğ
TheISA
::
PTE_R—dOÆy
;

166 
pTabËISAOps
.
	`£tPTEF›lds
(
PTE
, 
PTE_æags
);

167 
p
.
wr™e
<
PageTabËEÁry
>(
PTE_addr
, 
PTE
);

168 
	`DPRINTF
(
MMU
, "New m­pšg: %#x-%#x\n", 
vaddr
, 
·ddr
);

170 
	`”a£CacheEÁry
(
vaddr
);

171 
	`upd©eCache
(
vaddr
, 
	`TlbEÁry
(
pid
, vaddr, 
·ddr
,

172 
æags
 & 
Unÿch—bË
,

173 
æags
 & 
R—dOÆy
));

177 
	}
}

179 
	g‹m¶©e
 <
şass
 
	gISAOps
>

181 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$»m­
(
Addr
 
vaddr
, 
št64_t
 
size
, Add¸
Ãw_vaddr
)

183 
	`as£¹
(
	`·geOff£t
(
vaddr
) == 0);

184 
	`as£¹
(
	`·geOff£t
(
Ãw_vaddr
) == 0);

186 
	`DPRINTF
(
MMU
, "movšg…age äom vadd¸%08°tØ%08p, sizğ%d\n", 
vaddr
,

187 
Ãw_vaddr
, 
size
);

189 
PÜtProxy
 &
p
 = 
sy¡em
->
physProxy
;

191 ; 
size
 > 0;

192 
size
 -ğ
·geSize
, 
vaddr
 +ğ·geSize, 
Ãw_vaddr
 +=…ageSize)

194 
Addr
 
PTE_addr
;

195 ià(
	`w®k
(
vaddr
, 
çl£
, 
PTE_addr
)) {

196 
PageTabËEÁry
 
PTE
 = 
p
.
»ad
<PageTabËEÁry>(
PTE_addr
);

197 
Addr
 
·ddr
 = 
pTabËISAOps
.
	`g‘Pnum
(
PTE
);

199 ià(
·ddr
 == 0) {

200 
	`çl
("Page fault while„emapping");

203 
pTabËISAOps
.
	`£tPnum
(
PTE
, 0);

204 
p
.
wr™e
<
PageTabËEÁry
>(
PTE_addr
, 
PTE
);

207 
Addr
 
Ãw_PTE_addr
;

208 
	`w®k
(
Ãw_vaddr
, 
Œue
, 
Ãw_PTE_addr
);

209 
PageTabËEÁry
 
Ãw_PTE
 = 
p
.
»ad
<PageTabËEÁry>(
Ãw_PTE_addr
);

211 
pTabËISAOps
.
	`£tPnum
(
Ãw_PTE
, 
·ddr
>>
PageShiá
);

212 
pTabËISAOps
.
	`£tPTEF›lds
(
Ãw_PTE
);

213 
p
.
wr™e
<
PageTabËEÁry
>(
Ãw_PTE_addr
, 
Ãw_PTE
);

214 
	`DPRINTF
(
MMU
, "Rem­pšg: %#x-%#x\n", 
vaddr
, 
Ãw_PTE_addr
);

217 
	`”a£CacheEÁry
(
vaddr
);

218 
	`upd©eCache
(
Ãw_vaddr
, 
	`TlbEÁry
(
pid
,‚ew_vaddr, 
·ddr
,

219 
pTabËISAOps
.
	`isUnÿch—bË
(
PTE
),

220 
pTabËISAOps
.
	`isR—dOÆy
(
PTE
)));

222 
	`çl
("Page fault while„emapping");

225 
	}
}

227 
	g‹m¶©e
 <
şass
 
	gISAOps
>

229 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$unm­
(
Addr
 
vaddr
, 
št64_t
 
size
)

231 
	`as£¹
(
	`·geOff£t
(
vaddr
) == 0);

233 
	`DPRINTF
(
MMU
, "Unm­pšg…age: %#x-%#x\n", 
vaddr
, vaddr+ 
size
);

235 
PÜtProxy
 &
p
 = 
sy¡em
->
physProxy
;

237 ; 
size
 > 0; siz-ğ
·geSize
, 
vaddr
 +=…ageSize) {

238 
Addr
 
PTE_addr
;

239 ià(
	`w®k
(
vaddr
, 
çl£
, 
PTE_addr
)) {

240 
PageTabËEÁry
 
PTE
 = 
p
.
»ad
<PageTabËEÁry>(
PTE_addr
);

241 
Addr
 
·ddr
 = 
pTabËISAOps
.
	`g‘Pnum
(
PTE
);

242 ià(
·ddr
 == 0) {

243 
	`çl
("PageTabË::®loÿ‹:‡dd»s 0x%x‚Ù m­³d", 
vaddr
);

245 
pTabËISAOps
.
	`£tPnum
(
PTE
, 0);

246 
p
.
wr™e
<
PageTabËEÁry
>(
PTE_addr
, 
PTE
);

247 
	`DPRINTF
(
MMU
, "Unm­pšg: %#x\n", 
vaddr
);

249 
	`”a£CacheEÁry
(
vaddr
);

251 
	`çl
("Page fault while unmapping");

255 
	}
}

257 
	g‹m¶©e
 <
şass
 
	gISAOps
>

258 
boŞ


259 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$isUnm­³d
(
Addr
 
vaddr
, 
št64_t
 
size
)

262 
	`as£¹
(
	`·geOff£t
(
vaddr
) == 0);

263 
PÜtProxy
 &
p
 = 
sy¡em
->
physProxy
;

265 ; 
size
 > 0; siz-ğ
·geSize
, 
vaddr
 +=…ageSize) {

266 
Addr
 
PTE_addr
;

267 ià(
	`w®k
(
vaddr
, 
çl£
, 
PTE_addr
)) {

268 
PageTabËEÁry
 
PTE
 = 
p
.
»ad
<PageTabËEÁry>(
PTE_addr
);

269 ià(
pTabËISAOps
.
	`g‘Pnum
(
PTE
) != 0)

270  
çl£
;

274  
Œue
;

275 
	}
}

277 
	g‹m¶©e
 <
şass
 
	gISAOps
>

278 
boŞ


279 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$lookup
(
Addr
 
vaddr
, 
TlbEÁry
 &
’Œy
)

281 
Addr
 
·ge_addr
 = 
	`·geAlign
(
vaddr
);

283 ià(
pTabËCache
[0].
v®id
 &&…TabËCache[0].
vaddr
 =ğ
·ge_addr
) {

284 
’Œy
 = 
pTabËCache
[0].entry;

285  
Œue
;

287 ià(
pTabËCache
[1].
v®id
 &&…TabËCache[1].
vaddr
 =ğ
·ge_addr
) {

288 
’Œy
 = 
pTabËCache
[1].entry;

289  
Œue
;

291 ià(
pTabËCache
[2].
v®id
 &&…TabËCache[2].
vaddr
 =ğ
·ge_addr
) {

292 
’Œy
 = 
pTabËCache
[2].entry;

293  
Œue
;

296 
	`DPRINTF
(
MMU
, "looku°·ge_addr: %#x\n", 
·ge_addr
);

297 
Addr
 
PTE_addr
;

298 ià(
	`w®k
(
·ge_addr
, 
çl£
, 
PTE_addr
)) {

299 
PÜtProxy
 &
p
 = 
sy¡em
->
physProxy
;

300 
PageTabËEÁry
 
PTE
 = 
p
.
»ad
<PageTabËEÁry>(
PTE_addr
);

301 
Addr
 
²um
 = 
pTabËISAOps
.
	`g‘Pnum
(
PTE
);

302 ià(
²um
 == 0)

303  
çl£
;

305 
’Œy
 = 
	`TlbEÁry
(
pid
, 
vaddr
, 
²um
 << 
PageShiá
,

306 
pTabËISAOps
.
	`isUnÿch—bË
(
PTE
),

307 
pTabËISAOps
.
	`isR—dOÆy
(
PTE
));

308 
	`upd©eCache
(
·ge_addr
, 
’Œy
);

310  
çl£
;

312  
Œue
;

313 
	}
}

315 
	g‹m¶©e
 <
şass
 
	gISAOps
>

317 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$£rŸlize
(
CheckpoštOut
 &
ı
) const

323 
	`·¿mOut
(
ı
, "±abË.poš‹r", 
ba£PŒ
);

324 
	}
}

326 
	g‹m¶©e
 <
şass
 
	gISAOps
>

328 
	gMuÉiLev–PageTabË
<
	gISAOps
>::
	$un£rŸlize
(
CheckpoštIn
 &
ı
)

330 
	`·¿mIn
(
ı
, "±abË.poš‹r", 
ba£PŒ
);

331 
	}
}

	@noncoherent_xbar.cc

50 
	~"ba£/misc.hh
"

51 
	~"ba£/Œaû.hh
"

52 
	~"debug/NÚcoh”’tXB¬.hh
"

53 
	~"debug/XB¬.hh
"

54 
	~"mem/nÚcoh”’t_xb¬.hh
"

56 
	gNÚcoh”’tXB¬
::
	$NÚcoh”’tXB¬
(cÚ¡ 
NÚcoh”’tXB¬P¬ams
 *
p
)

57 : 
	$Ba£XB¬
(
p
)

62 
i
 = 0; i < 
p
->
pÜt_ma¡”_cÚÃùiÚ_couÁ
; ++i) {

63 
¡d
::
¡ršg
 
pÜtName
 = 
	`c¥rštf
("%s.ma¡”[%d]", 
	`Çme
(), 
i
);

64 
Ma¡”PÜt
* 
bp
 = 
Ãw
 
	`NÚcoh”’tXB¬Ma¡”PÜt
(
pÜtName
, *
this
, 
i
);

65 
ma¡”PÜts
.
	`push_back
(
bp
);

66 
»qLay”s
.
	`push_back
(
Ãw
 
	`ReqLay”
(*
bp
, *
this
,

67 
	`c¥rštf
(".»qLay”%d", 
i
)));

72 ià(
p
->
pÜt_deçuÉ_cÚÃùiÚ_couÁ
) {

73 
deçuÉPÜtID
 = 
ma¡”PÜts
.
	`size
();

74 
¡d
::
¡ršg
 
pÜtName
 = 
	`Çme
() + ".default";

75 
Ma¡”PÜt
* 
bp
 = 
Ãw
 
	`NÚcoh”’tXB¬Ma¡”PÜt
(
pÜtName
, *
this
,

76 
deçuÉPÜtID
);

77 
ma¡”PÜts
.
	`push_back
(
bp
);

78 
»qLay”s
.
	`push_back
(
Ãw
 
	`ReqLay”
(*
bp
, *
this
, 
	`c¥rštf
(".reqLayer%d",

79 
deçuÉPÜtID
)));

83 
i
 = 0; i < 
p
->
pÜt_¦ave_cÚÃùiÚ_couÁ
; ++i) {

84 
¡d
::
¡ršg
 
pÜtName
 = 
	`c¥rštf
("%s.¦ave[%d]", 
	`Çme
(), 
i
);

85 
QueuedSÏvePÜt
* 
bp
 = 
Ãw
 
	`NÚcoh”’tXB¬SÏvePÜt
(
pÜtName
, *
this
, 
i
);

86 
¦avePÜts
.
	`push_back
(
bp
);

87 
»¥Lay”s
.
	`push_back
(
Ãw
 
	`Re¥Lay”
(*
bp
, *
this
,

88 
	`c¥rštf
(".»¥Lay”%d", 
i
)));

91 
	`ş—rPÜtCache
();

92 
	}
}

94 
	gNÚcoh”’tXB¬
::~
	$NÚcoh”’tXB¬
()

96 autØ
l
: 
»qLay”s
)

97 
d–‘e
 
l
;

98 autØ
l
: 
»¥Lay”s
)

99 
d–‘e
 
l
;

100 
	}
}

102 
boŞ


103 
	gNÚcoh”’tXB¬
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
)

106 
SÏvePÜt
 *
¤c_pÜt
 = 
¦avePÜts
[
¦ave_pÜt_id
];

109 
	`as£¹
(!
pkt
->
	`isEx´essSnoİ
());

112 
PÜtID
 
ma¡”_pÜt_id
 = 
	`fšdPÜt
(
pkt
->
	`g‘Addr
());

116 ià(!
»qLay”s
[
ma¡”_pÜt_id
]->
	`ŒyTimšg
(
¤c_pÜt
)) {

117 
	`DPRINTF
(
NÚcoh”’tXB¬
, "recvTimingReq: src %s %s 0x%x BUSY\n",

118 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

119  
çl£
;

122 
	`DPRINTF
(
NÚcoh”’tXB¬
, "recvTimingReq: src %s %s 0x%x\n",

123 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

127 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

128 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

131 
Tick
 
Şd_h—d”_d–ay
 = 
pkt
->
h—d”D–ay
;

134 
Tick
 
xb¬_d–ay
 = (
äÚ‹ndL©’cy
 + 
fÜw¬dL©’cy
è* 
	`şockP”iod
();

137 
	`ÿlcPack‘Timšg
(
pkt
, 
xb¬_d–ay
);

140 
Tick
 
·ck‘FšishTime
 = 
	`şockEdge
(
	`Cyşes
(1)è+ 
pkt
->
·ylßdD–ay
;

144 cÚ¡ 
boŞ
 
ex³ù_»¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
() &&

145 !
pkt
->
	`ÿcheRe¥Údšg
();

148 
boŞ
 
sucûss
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`£ndTimšgReq
(
pkt
);

150 ià(!
sucûss
) {

151 
	`DPRINTF
(
NÚcoh”’tXB¬
, "recvTimingReq: src %s %s 0x%x RETRY\n",

152 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

155 
pkt
->
h—d”D–ay
 = 
Şd_h—d”_d–ay
;

158 
»qLay”s
[
ma¡”_pÜt_id
]->
	`çedTimšg
(
¤c_pÜt
,

159 
	`şockEdge
(
	`Cyşes
(1)));

161  
çl£
;

165 ià(
ex³ù_»¥Ú£
) {

166 
	`as£¹
(
rou‹To
.
	`fšd
(
pkt
->
»q
è=ğrou‹To.
	`’d
());

167 
rou‹To
[
pkt
->
»q
] = 
¦ave_pÜt_id
;

170 
»qLay”s
[
ma¡”_pÜt_id
]->
	`sucûededTimšg
(
·ck‘FšishTime
);

173 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

174 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

175 
ŒªsDi¡
[
pkt_cmd
]++;

177  
Œue
;

178 
	}
}

180 
boŞ


181 
	gNÚcoh”’tXB¬
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
)

184 
Ma¡”PÜt
 *
¤c_pÜt
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
];

187 cÚ¡‡utØ
rou‹_lookup
 = 
rou‹To
.
	`fšd
(
pkt
->
»q
);

188 
	`as£¹
(
rou‹_lookup
 !ğ
rou‹To
.
	`’d
());

189 cÚ¡ 
PÜtID
 
¦ave_pÜt_id
 = 
rou‹_lookup
->
£cÚd
;

190 
	`as£¹
(
¦ave_pÜt_id
 !ğ
Inv®idPÜtID
);

191 
	`as£¹
(
¦ave_pÜt_id
 < 
»¥Lay”s
.
	`size
());

195 ià(!
»¥Lay”s
[
¦ave_pÜt_id
]->
	`ŒyTimšg
(
¤c_pÜt
)) {

196 
	`DPRINTF
(
NÚcoh”’tXB¬
, "recvTimingResp: src %s %s 0x%x BUSY\n",

197 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

198  
çl£
;

201 
	`DPRINTF
(
NÚcoh”’tXB¬
, "recvTimingResp: src %s %s 0x%x\n",

202 
¤c_pÜt
->
	`Çme
(), 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

206 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

207 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

210 
Tick
 
xb¬_d–ay
 = 
»¥Ú£L©’cy
 * 
	`şockP”iod
();

213 
	`ÿlcPack‘Timšg
(
pkt
, 
xb¬_d–ay
);

216 
Tick
 
·ck‘FšishTime
 = 
	`şockEdge
(
	`Cyşes
(1)è+ 
pkt
->
·ylßdD–ay
;

220 
Tick
 
Ï‹ncy
 = 
pkt
->
h—d”D–ay
;

221 
pkt
->
h—d”D–ay
 = 0;

222 
¦avePÜts
[
¦ave_pÜt_id
]->
	`schedTimšgRe¥
(
pkt
, 
	`curTick
(è+ 
Ï‹ncy
);

225 
rou‹To
.
	`”a£
(
rou‹_lookup
);

227 
»¥Lay”s
[
¦ave_pÜt_id
]->
	`sucûededTimšg
(
·ck‘FšishTime
);

230 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

231 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

232 
ŒªsDi¡
[
pkt_cmd
]++;

234  
Œue
;

235 
	}
}

238 
	gNÚcoh”’tXB¬
::
	$»cvReqR‘ry
(
PÜtID
 
ma¡”_pÜt_id
)

243 
»qLay”s
[
ma¡”_pÜt_id
]->
	`»cvR‘ry
();

244 
	}
}

246 
Tick


247 
	gNÚcoh”’tXB¬
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
)

249 
	`DPRINTF
(
NÚcoh”’tXB¬
, "recvAtomic:…acket src %s‡ddr 0x%x cmd %s\n",

250 
¦avePÜts
[
¦ave_pÜt_id
]->
	`Çme
(), 
pkt
->
	`g‘Addr
(),

251 
pkt
->
	`cmdSŒšg
());

253 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

254 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

257 
PÜtID
 
ma¡”_pÜt_id
 = 
	`fšdPÜt
(
pkt
->
	`g‘Addr
());

260 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

261 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

262 
ŒªsDi¡
[
pkt_cmd
]++;

265 
Tick
 
»¥Ú£_Ï‹ncy
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`£ndAtomic
(
pkt
);

268 ià(
pkt
->
	`isRe¥Ú£
()) {

269 
pkt_size
 = 
pkt
->
	`hasD©a
(è?…kt->
	`g‘Size
() : 0;

270 
pkt_cmd
 = 
pkt
->
	`cmdToIndex
();

273 
pktCouÁ
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
]++;

274 
pktSize
[
¦ave_pÜt_id
][
ma¡”_pÜt_id
] +ğ
pkt_size
;

275 
ŒªsDi¡
[
pkt_cmd
]++;

279 
pkt
->
·ylßdD–ay
 = 
»¥Ú£_Ï‹ncy
;

280  
»¥Ú£_Ï‹ncy
;

281 
	}
}

284 
	gNÚcoh”’tXB¬
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
)

286 ià(!
pkt
->
	`isPršt
()) {

288 
	`DPRINTF
(
NÚcoh”’tXB¬
,

290 
¦avePÜts
[
¦ave_pÜt_id
]->
	`Çme
(), 
pkt
->
	`g‘Addr
(),

291 
pkt
->
	`cmdSŒšg
());

295 cÚ¡‡uto& 
p
 : 
¦avePÜts
) {

299 ià(
p
->
	`checkFunùiÚ®
(
pkt
)) {

300 ià(
pkt
->
	`ÃedsRe¥Ú£
())

301 
pkt
->
	`makeRe¥Ú£
();

307 
PÜtID
 
de¡_id
 = 
	`fšdPÜt
(
pkt
->
	`g‘Addr
());

310 
ma¡”PÜts
[
de¡_id
]->
	`£ndFunùiÚ®
(
pkt
);

311 
	}
}

313 
NÚcoh”’tXB¬
*

314 
	gNÚcoh”’tXB¬P¬ams
::
	$ü—‹
()

316  
Ãw
 
	`NÚcoh”’tXB¬
(
this
);

317 
	}
}

320 
	gNÚcoh”’tXB¬
::
	$»gSts
()

323 
Ba£XB¬
::
	`»gSts
();

324 autØ
l
: 
»qLay”s
)

325 
l
->
	`»gSts
();

326 autØ
l
: 
»¥Lay”s
)

327 
l
->
	`»gSts
();

328 
	}
}

	@noncoherent_xbar.hh

51 #iâdeà
__MEM_NONCOHERENT_XBAR_HH__


52 
	#__MEM_NONCOHERENT_XBAR_HH__


	)

54 
	~"mem/xb¬.hh
"

55 
	~"·¿ms/NÚcoh”’tXB¬.hh
"

70 şas 
	cNÚcoh”’tXB¬
 : 
public
 
Ba£XB¬


73 
´Ùeùed
:

79 
¡d
::
veùÜ
<
ReqLay”
*> 
»qLay”s
;

80 
	m¡d
::
veùÜ
<
Re¥Lay”
*> 
»¥Lay”s
;

87 şas 
	cNÚcoh”’tXB¬SÏvePÜt
 : 
public
 
QueuedSÏvePÜt


89 
´iv©e
:

92 
NÚcoh”’tXB¬
 &
xb¬
;

95 
Re¥Pack‘Queue
 
	mqueue
;

97 
	mpublic
:

99 
NÚcoh”’tXB¬SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

100 
NÚcoh”’tXB¬
 &
_xb¬
, 
PÜtID
 
_id
)

101 : 
QueuedSÏvePÜt
(
_Çme
, &
_xb¬
, 
queue
, 
_id
), 
xb¬
(_xbar),

102 
queue
(
_xb¬
, *
this
)

105 
	m´Ùeùed
:

110 
vœtu®
 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

111 {  
xb¬
.
»cvTimšgReq
(
pkt
, 
id
); }

116 
vœtu®
 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
)

117 {  
	mxb¬
.
»cvAtomic
(
pkt
, 
id
); }

122 
vœtu®
 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

123 { 
	mxb¬
.
»cvFunùiÚ®
(
pkt
, 
id
); }

128 
vœtu®
 
AddrRªgeLi¡
 
g‘AddrRªges
() const

129 {  
	mxb¬
.
g‘AddrRªges
(); }

138 şas 
	cNÚcoh”’tXB¬Ma¡”PÜt
 : 
public
 
Ma¡”PÜt


140 
´iv©e
:

143 
NÚcoh”’tXB¬
 &
xb¬
;

145 
	gpublic
:

147 
NÚcoh”’tXB¬Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

148 
NÚcoh”’tXB¬
 &
_xb¬
, 
PÜtID
 
_id
)

149 : 
Ma¡”PÜt
(
_Çme
, &
_xb¬
, 
_id
), 
xb¬
(_xbar)

152 
	g´Ùeùed
:

157 
vœtu®
 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

158 {  
xb¬
.
»cvTimšgRe¥
(
pkt
, 
id
); }

162 
vœtu®
 
»cvRªgeChªge
()

163 { 
	gxb¬
.
»cvRªgeChªge
(
id
); }

167 
vœtu®
 
»cvReqR‘ry
()

168 { 
	gxb¬
.
»cvReqR‘ry
(
id
); }

174 
vœtu®
 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
);

178 
vœtu®
 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
);

182 
»cvReqR‘ry
(
PÜtID
 
ma¡”_pÜt_id
);

186 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
);

190 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
¦ave_pÜt_id
);

192 
	gpublic
:

194 
NÚcoh”’tXB¬
(cÚ¡ 
NÚcoh”’tXB¬P¬ams
 *
p
);

196 
	gvœtu®
 ~
NÚcoh”’tXB¬
();

201 
vœtu®
 
»gSts
();

202 
	gSts
::
SÿÏr
 
tÙPktSize
;

	@packet.cc

51 
	~<c¡ršg
>

52 
	~<io¡»am
>

54 
	~"ba£/ırštf.hh
"

55 
	~"ba£/misc.hh
"

56 
	~"ba£/Œaû.hh
"

57 
	~"mem/·ck‘.hh
"

59 
usšg
 
Çme¥aû
 
	g¡d
;

62 
	#SET1
(
a1
è(1 << (a1))

	)

63 
	#SET2
(
a1
, 
a2
è(
	`SET1
×1è| SET1×2))

	)

64 
	#SET3
(
a1
, 
a2
, 
a3
è(
	`SET2
×1,‡2è| 
	`SET1
×3))

	)

65 
	#SET4
(
a1
, 
a2
, 
a3
, 
a4
è(
	`SET3
×1,‡2,‡3è| 
	`SET1
×4))

	)

66 
	#SET5
(
a1
, 
a2
, 
a3
, 
a4
, 
a5
è(
	`SET4
×1,‡2,‡3,‡4è| 
	`SET1
×5))

	)

67 
	#SET6
(
a1
, 
a2
, 
a3
, 
a4
, 
a5
, 
a6
è(
	`SET5
×1,‡2,‡3,‡4,‡5è| 
	`SET1
×6))

	)

68 
	#SET7
(
a1
, 
a2
, 
a3
, 
a4
, 
a5
, 
a6
, 
a7
è(
	`SET6
(a1,‡2,‡3,‡4,‡5,‡6) | \

69 
	`SET1
(
a7
))

	)

71 cÚ¡ 
	gMemCmd
::
CommªdInfo


72 
MemCmd
::
commªdInfo
[] =

75 { 0, 
Inv®idCmd
, "InvalidCmd" },

78 { 
SET3
(
IsR—d
, 
IsReque¡
, 
N“dsRe¥Ú£
), 
R—dRe¥
, "ReadReq" },

80 { 
SET3
(
IsR—d
, 
IsRe¥Ú£
, 
HasD©a
), 
Inv®idCmd
, "ReadResp" },

82 { 
SET4
(
IsR—d
, 
IsRe¥Ú£
, 
HasD©a
, 
IsInv®id©e
),

83 
Inv®idCmd
, "ReadRespWithInvalidate" },

85 { 
SET5
(
IsWr™e
, 
N“dsWr™abË
, 
IsReque¡
, 
N“dsRe¥Ú£
, 
HasD©a
),

86 
Wr™eRe¥
, "WriteReq" },

88 { 
SET2
(
IsWr™e
, 
IsRe¥Ú£
), 
Inv®idCmd
, "WriteResp" },

90 { 
SET5
(
IsWr™e
, 
IsReque¡
, 
IsEviùiÚ
, 
HasD©a
, 
FromCache
),

91 
Inv®idCmd
, "WritebackDirty" },

95 { 
SET5
(
IsWr™e
, 
IsReque¡
, 
IsEviùiÚ
, 
HasD©a
, 
FromCache
),

96 
Inv®idCmd
, "WritebackClean" },

98 { 
SET3
(
IsReque¡
, 
IsEviùiÚ
, 
FromCache
), 
Inv®idCmd
, "CleanEvict" },

100 { 
SET4
(
IsR—d
, 
IsReque¡
, 
IsSWP»ãtch
, 
N“dsRe¥Ú£
),

101 
SoáPFRe¥
, "SoftPFReq" },

103 { 
SET5
(
IsR—d
, 
IsReque¡
, 
IsHWP»ãtch
, 
N“dsRe¥Ú£
, 
FromCache
),

104 
H¬dPFRe¥
, "HardPFReq" },

106 { 
SET4
(
IsR—d
, 
IsRe¥Ú£
, 
IsSWP»ãtch
, 
HasD©a
),

107 
Inv®idCmd
, "SoftPFResp" },

109 { 
SET4
(
IsR—d
, 
IsRe¥Ú£
, 
IsHWP»ãtch
, 
HasD©a
),

110 
Inv®idCmd
, "HardPFResp" },

112 { 
SET5
(
IsWr™e
, 
N“dsWr™abË
, 
IsReque¡
, 
N“dsRe¥Ú£
, 
HasD©a
),

113 
Wr™eRe¥
, "WriteLineReq" },

115 { 
SET6
(
IsInv®id©e
, 
N“dsWr™abË
, 
IsUpg¿de
, 
IsReque¡
, 
N“dsRe¥Ú£
,

116 
FromCache
),

117 
Upg¿deRe¥
, "UpgradeReq" },

119 { 
SET7
(
IsInv®id©e
, 
N“dsWr™abË
, 
IsUpg¿de
, 
IsLlsc
,

120 
IsReque¡
, 
N“dsRe¥Ú£
, 
FromCache
),

121 
Upg¿deRe¥
, "SCUpgradeReq" },

123 { 
SET2
(
IsUpg¿de
, 
IsRe¥Ú£
),

124 
Inv®idCmd
, "UpgradeResp" },

126 { 
SET7
(
IsR—d
, 
N“dsWr™abË
, 
IsInv®id©e
,

127 
IsLlsc
, 
IsReque¡
, 
N“dsRe¥Ú£
, 
FromCache
),

128 
Upg¿deFaRe¥
, "SCUpgradeFailReq" },

131 { 
SET3
(
IsR—d
, 
IsRe¥Ú£
, 
HasD©a
),

132 
Inv®idCmd
, "UpgradeFailResp" },

136 { 
SET6
(
IsR—d
, 
N“dsWr™abË
, 
IsInv®id©e
, 
IsReque¡
, 
N“dsRe¥Ú£
,

137 
FromCache
),

138 
R—dExRe¥
, "ReadExReq" },

141 { 
SET3
(
IsR—d
, 
IsRe¥Ú£
, 
HasD©a
),

142 
Inv®idCmd
, "ReadExResp" },

146 { 
SET4
(
IsR—d
, 
IsReque¡
, 
N“dsRe¥Ú£
, 
FromCache
),

147 
R—dRe¥
, "ReadCleanReq" },

151 { 
SET4
(
IsR—d
, 
IsReque¡
, 
N“dsRe¥Ú£
, 
FromCache
),

152 
R—dRe¥
, "ReadSharedReq" },

155 { 
SET4
(
IsR—d
, 
IsLlsc
, 
IsReque¡
, 
N“dsRe¥Ú£
),

156 
R—dRe¥
, "LoadLockedReq" },

158 { 
SET6
(
IsWr™e
, 
N“dsWr™abË
, 
IsLlsc
,

159 
IsReque¡
, 
N“dsRe¥Ú£
, 
HasD©a
),

160 
StÜeCÚdRe¥
, "StoreCondReq" },

162 { 
SET6
(
IsWr™e
, 
N“dsWr™abË
, 
IsLlsc
,

163 
IsReque¡
, 
N“dsRe¥Ú£
, 
HasD©a
),

164 
StÜeCÚdRe¥
, "StoreCondFailReq" },

166 { 
SET3
(
IsWr™e
, 
IsLlsc
, 
IsRe¥Ú£
),

167 
Inv®idCmd
, "StoreCondResp" },

169 { 
SET6
(
IsR—d
, 
IsWr™e
, 
N“dsWr™abË
, 
IsReque¡
, 
HasD©a
, 
N“dsRe¥Ú£
),

170 
Sw­Re¥
, "SwapReq" },

172 { 
SET4
(
IsR—d
, 
IsWr™e
, 
IsRe¥Ú£
, 
HasD©a
),

173 
Inv®idCmd
, "SwapResp" },

175 { 
SET4
(
IsWr™e
, 
IsReque¡
, 
N“dsRe¥Ú£
, 
HasD©a
),

176 
Mes§geRe¥
, "MessageReq" },

178 { 
SET2
(
IsWr™e
, 
IsRe¥Ú£
), 
Inv®idCmd
, "MessageResp" },

180 {
SET2
(
IsReque¡
, 
N“dsRe¥Ú£
), 
MemF’ûRe¥
, "MemFenceReq"},

182 {
SET1
(
IsRe¥Ú£
), 
Inv®idCmd
, "MemFenceResp"},

184 { 
SET2
(
IsRe¥Ú£
, 
IsE¼Ü
), 
Inv®idCmd
, "InvalidDestError" },

186 { 
SET2
(
IsRe¥Ú£
, 
IsE¼Ü
), 
Inv®idCmd
, "BadAddressError" },

188 { 
SET3
(
IsR—d
, 
IsRe¥Ú£
, 
IsE¼Ü
), 
Inv®idCmd
, "FunctionalReadError" },

190 { 
SET3
(
IsWr™e
, 
IsRe¥Ú£
, 
IsE¼Ü
), 
Inv®idCmd
, "FunctionalWriteError" },

192 { 
SET2
(
IsReque¡
, 
IsPršt
), 
Inv®idCmd
, "PrintReq" },

194 { 
SET3
(
IsReque¡
, 
IsFlush
, 
N“dsWr™abË
), 
Inv®idCmd
, "FlushReq" },

196 { 
SET5
(
IsInv®id©e
, 
IsReque¡
, 
N“dsWr™abË
, 
N“dsRe¥Ú£
, 
FromCache
),

197 
Inv®id©eRe¥
, "InvalidateReq" },

199 { 
SET2
(
IsInv®id©e
, 
IsRe¥Ú£
),

200 
Inv®idCmd
, "InvalidateResp" }

203 
boŞ


204 
	gPack‘
::
	$checkFunùiÚ®
(
PršbË
 *
obj
, 
Addr
 
addr
, 
boŞ
 
is_£cu»
, 
size
,

205 
ušt8_t
 *
_d©a
)

207 
Addr
 
func_¡¬t
 = 
	`g‘Addr
();

208 
Addr
 
func_’d
 = 
	`g‘Addr
(è+ 
	`g‘Size
() - 1;

209 
Addr
 
v®_¡¬t
 = 
addr
;

210 
Addr
 
v®_’d
 = 
v®_¡¬t
 + 
size
 - 1;

212 ià(
is_£cu»
 !ğ
_isSecu»
 || 
func_¡¬t
 > 
v®_’d
 ||

213 
v®_¡¬t
 > 
func_’d
) {

215  
çl£
;

219 ià(
	`isPršt
()) {

220 
	`as£¹
(!
_d©a
);

221 
§ã_ÿ¡
<
PrštReqS‹
*>(
£nd”S‹
)->
	`´štObj
(
obj
);

222  
çl£
;

227 ià(!
_d©a
) {

228  
çl£
;

233 
off£t
 = 
func_¡¬t
 - 
v®_¡¬t
;

235 ià(
	`isR—d
()) {

236 ià(
func_¡¬t
 >ğ
v®_¡¬t
 && 
func_’d
 <ğ
v®_’d
) {

237 
	`memıy
(
g‘PŒ
<
ušt8_t
>(), 
_d©a
 + 
off£t
, 
	`g‘Size
());

238 ià(
by‹sV®id
.
	`em±y
())

239 
by‹sV®id
.
	`»size
(
	`g‘Size
(), 
Œue
);

242  
Œue
;

245 
func_off£t
;

246 
v®_off£t
;

247 
ov”Ïp_size
;

250 ià(
v®_¡¬t
 < 
func_¡¬t
 && 
v®_’d
 <ğ
func_’d
) {

253 
v®_off£t
 = 
func_¡¬t
 - 
v®_¡¬t
;

254 
func_off£t
 = 0;

255 
ov”Ïp_size
 = 
v®_’d
 - 
func_¡¬t
;

256 } ià(
v®_¡¬t
 >ğ
func_¡¬t
 && 
v®_’d
 > 
func_’d
) {

259 
v®_off£t
 = 0;

260 
func_off£t
 = 
v®_¡¬t
 - 
func_¡¬t
;

261 
ov”Ïp_size
 = 
func_’d
 - 
v®_¡¬t
;

262 } ià(
v®_¡¬t
 >ğ
func_¡¬t
 && 
v®_’d
 <ğ
func_’d
) {

266 
v®_off£t
 = 0;

267 
func_off£t
 = 
v®_¡¬t
 - 
func_¡¬t
;

268 
ov”Ïp_size
 = 
size
;

269 } ià(
v®_¡¬t
 < 
func_¡¬t
 && 
v®_’d
 > 
func_’d
) {

272 
v®_off£t
 = 
func_¡¬t
 - 
v®_¡¬t
;

273 
func_off£t
 = 0;

274 
ov”Ïp_size
 = 
func_’d
 - 
func_¡¬t
;

276 
	`·nic
("Missed‡ case for checkFunctional with "

278 
	`cmdSŒšg
(), 
	`g‘Addr
(), 
	`g‘Size
(), 
addr
, 
size
);

282 
ušt8_t
 *
de¡
 = 
g‘PŒ
<ušt8_t>(è+ 
func_off£t
;

283 
ušt8_t
 *
¤c
 = 
_d©a
 + 
v®_off£t
;

284 
	`memıy
(
de¡
, 
¤c
, 
ov”Ïp_size
);

288 ià(
by‹sV®id
.
	`em±y
())

289 
by‹sV®id
.
	`»size
(
	`g‘Size
(), 
çl£
);

292 
boŞ
 
®l_by‹s_v®id
 = 
Œue
;

294 
i
 = 0;

297 ; 
®l_by‹s_v®id
 && 
i
 < 
func_off£t
; ++i)

298 
®l_by‹s_v®id
 &ğ
by‹sV®id
[
i
];

301 
i
 = 
func_off£t
; i < func_off£ˆ+ 
ov”Ïp_size
; ++i)

302 
by‹sV®id
[
i
] = 
Œue
;

305 ; 
®l_by‹s_v®id
 && 
i
 < 
	`g‘Size
(); ++i)

306 
®l_by‹s_v®id
 &ğ
by‹sV®id
[
i
];

308  
®l_by‹s_v®id
;

310 } ià(
	`isWr™e
()) {

311 ià(
off£t
 >= 0) {

312 
	`memıy
(
_d©a
 + 
off£t
, 
g‘CÚ¡PŒ
<
ušt8_t
>(),

313 (
	`mš
(
func_’d
, 
v®_’d
è- 
func_¡¬t
) + 1);

316 
	`memıy
(
_d©a
, 
g‘CÚ¡PŒ
<
ušt8_t
>(è- 
off£t
,

317 (
	`mš
(
func_’d
, 
v®_’d
è- 
v®_¡¬t
) + 1);

320 
	`·nic
("DÚ'ˆknow howØhªdË commªd %s\n", 
	`cmdSŒšg
());

324  
çl£
;

325 
	}
}

328 
	gPack‘
::
	$pushS’d”S‹
(
Pack‘
::
S’d”S‹
 *
£nd”_¡©e
)

330 
	`as£¹
(
£nd”_¡©e
 !ğ
NULL
);

331 
£nd”_¡©e
->
´edeûssÜ
 = 
£nd”S‹
;

332 
£nd”S‹
 = 
£nd”_¡©e
;

333 
	}
}

335 
	gPack‘
::
S’d”S‹
 *

336 
Pack‘
::
	$pİS’d”S‹
()

338 
	`as£¹
(
£nd”S‹
 !ğ
NULL
);

339 
S’d”S‹
 *
£nd”_¡©e
 = 
£nd”S‹
;

340 
£nd”S‹
 = 
£nd”_¡©e
->
´edeûssÜ
;

341 
£nd”_¡©e
->
´edeûssÜ
 = 
NULL
;

342  
£nd”_¡©e
;

343 
	}
}

346 
	gPack‘
::
	$´št
(
o¡»am
 &
o
, cÚ¡ 
v”bos™y
, cÚ¡ 
¡ršg
 &
´efix
) const

348 
	`cırštf
(
o
, "%s[%x:%x] %s\n", 
´efix
,

349 
	`g‘Addr
(), g‘Addr(è+ 
	`g‘Size
(è- 1, 
	`cmdSŒšg
());

350 
	}
}

352 
	g¡d
::
¡ršg


353 
Pack‘
::
	$´št
() const {

354 
o¡ršg¡»am
 
¡r
;

355 
	`´št
(
¡r
);

356  
¡r
.
	`¡r
();

357 
	}
}

359 
	gPack‘
::
PrštReqS‹
::
	$PrštReqS‹
(
o¡»am
 &
_os
, 
_v”bos™y
)

360 : 
	`curP»fixPŒ
(
Ãw
 
	`¡ršg
("")), 
	`os
(
_os
), 
	$v”bos™y
(
_v”bos™y
)

362 
Ïb–Sck
.
	`push_back
(
	`Lab–SckEÁry
("", 
curP»fixPŒ
));

363 
	}
}

365 
	gPack‘
::
PrštReqS‹
::~
	$PrštReqS‹
()

367 
Ïb–Sck
.
	`pİ_back
();

368 
	`as£¹
(
Ïb–Sck
.
	`em±y
());

369 
d–‘e
 
curP»fixPŒ
;

370 
	}
}

372 
	gPack‘
::
PrštReqS‹
::

373 
Lab–SckEÁry
::
	$Lab–SckEÁry
(cÚ¡ 
¡ršg
 &
_Ïb–
, sŒšg *
_´efix
)

374 : 
	`Ïb–
(
_Ïb–
), 
	`´efix
(
_´efix
), 
	$Ïb–Prš‹d
(
çl£
)

376 
	}
}

379 
	gPack‘
::
PrštReqS‹
::
	$pushLab–
(cÚ¡ 
¡ršg
 &
lbl
, cÚ¡ sŒšg &
´efix
)

381 
Ïb–Sck
.
	`push_back
(
	`Lab–SckEÁry
(
lbl
, 
curP»fixPŒ
));

382 
curP»fixPŒ
 = 
Ãw
 
	`¡ršg
(*curPrefixPtr);

383 *
curP»fixPŒ
 +ğ
´efix
;

384 
	}
}

387 
	gPack‘
::
PrštReqS‹
::
	$pİLab–
()

389 
d–‘e
 
curP»fixPŒ
;

390 
curP»fixPŒ
 = 
Ïb–Sck
.
	`back
().
´efix
;

391 
Ïb–Sck
.
	`pİ_back
();

392 
	`as£¹
(!
Ïb–Sck
.
	`em±y
());

393 
	}
}

396 
	gPack‘
::
PrštReqS‹
::
	$´štLab–s
()

398 ià(!
Ïb–Sck
.
	`back
().
Ïb–Prš‹d
) {

399 
Lab–Sck
::
™”©Ü
 
i
 = 
Ïb–Sck
.
	`begš
();

400 
Lab–Sck
::
™”©Ü
 
’d
 = 
Ïb–Sck
.
	`’d
();

401 
i
 !ğ
’d
) {

402 ià(!
i
->
Ïb–Prš‹d
) {

403 
	`cırštf
(
os
, "%s%s\n", *(
i
->
´efix
), i->
Ïb–
);

404 
i
->
Ïb–Prš‹d
 = 
Œue
;

406 
i
++;

409 
	}
}

413 
	gPack‘
::
PrštReqS‹
::
	$´štObj
(
PršbË
 *
obj
)

415 
	`´štLab–s
();

416 
obj
->
	`´št
(
os
, 
v”bos™y
, 
	`curP»fix
());

417 
	}
}

	@packet.hh

52 #iâdeà
__MEM_PACKET_HH__


53 
	#__MEM_PACKET_HH__


	)

55 
	~<b™£t
>

56 
	~<ÿs£¹
>

57 
	~<li¡
>

59 
	~"ba£/ÿ¡.hh
"

60 
	~"ba£/comp”.hh
"

61 
	~"ba£/æags.hh
"

62 
	~"ba£/misc.hh
"

63 
	~"ba£/´šbË.hh
"

64 
	~"ba£/ty³s.hh
"

65 
	~"mem/»que¡.hh
"

66 
	~"sim/cÜe.hh
"

68 
şass
 
	gPack‘
;

69 
Pack‘
 *
	tPack‘PŒ
;

70 
ušt8_t
* 
	tPack‘D©aPŒ
;

71 
	g¡d
::
	tli¡
<
	tPack‘PŒ
> 
	tPack‘Li¡
;

73 şas 
	cMemCmd


75 
ä›nd
 
şass
 
	mPack‘
;

77 
	mpublic
:

81 
	eCommªd


83 
Inv®idCmd
,

84 
	mR—dReq
,

85 
	mR—dRe¥
,

86 
	mR—dRe¥W™hInv®id©e
,

87 
	mWr™eReq
,

88 
	mWr™eRe¥
,

89 
	mWr™ebackDœty
,

90 
	mWr™ebackCËª
,

91 
	mCËªEviù
,

92 
	mSoáPFReq
,

93 
	mH¬dPFReq
,

94 
	mSoáPFRe¥
,

95 
	mH¬dPFRe¥
,

96 
	mWr™eLšeReq
,

97 
	mUpg¿deReq
,

98 
	mSCUpg¿deReq
,

99 
	mUpg¿deRe¥
,

100 
	mSCUpg¿deFaReq
,

101 
	mUpg¿deFaRe¥
,

102 
	mR—dExReq
,

103 
	mR—dExRe¥
,

104 
	mR—dCËªReq
,

105 
	mR—dSh¬edReq
,

106 
	mLßdLockedReq
,

107 
	mStÜeCÚdReq
,

108 
	mStÜeCÚdFaReq
,

109 
	mStÜeCÚdRe¥
,

110 
	mSw­Req
,

111 
	mSw­Re¥
,

112 
	mMes§geReq
,

113 
	mMes§geRe¥
,

114 
	mMemF’ûReq
,

115 
	mMemF’ûRe¥
,

120 
	mInv®idDe¡E¼Ü
,

121 
	mBadAdd»ssE¼Ü
,

122 
	mFunùiÚ®R—dE¼Ü
,

123 
	mFunùiÚ®Wr™eE¼Ü
,

125 
	mPrštReq
,

126 
	mFlushReq
,

127 
	mInv®id©eReq
,

128 
	mInv®id©eRe¥
,

129 
	mNUM_MEM_CMDS


132 
	g´iv©e
:

136 
	eA‰ribu‹


138 
IsR—d
,

139 
	gIsWr™e
,

140 
	gIsUpg¿de
,

141 
	gIsInv®id©e
,

142 
	gN“dsWr™abË
,

143 
	gIsReque¡
,

144 
	gIsRe¥Ú£
,

145 
	gN“dsRe¥Ú£
,

146 
	gIsEviùiÚ
,

147 
	gIsSWP»ãtch
,

148 
	gIsHWP»ãtch
,

149 
	gIsLlsc
,

150 
	gHasD©a
,

151 
	gIsE¼Ü
,

152 
	gIsPršt
,

153 
	gIsFlush
,

154 
	gFromCache
,

155 
	gNUM_COMMAND_ATTRIBUTES


162 
	sCommªdInfo


165 cÚ¡ 
	g¡d
::
b™£t
<
NUM_COMMAND_ATTRIBUTES
> 
©Œibu‹s
;

168 cÚ¡ 
Commªd
 
	g»¥Ú£
;

170 cÚ¡ 
	g¡d
::
¡ršg
 
¡r
;

174 cÚ¡ 
CommªdInfo
 
	gcommªdInfo
[];

176 
	g´iv©e
:

178 
Commªd
 
cmd
;

180 
boŞ


181 
	$‹¡CmdA‰rib
(
MemCmd
::
A‰ribu‹
 
©Œib
) const

183  
commªdInfo
[
cmd
].
©Œibu‹s
[
©Œib
] != 0;

184 
	}
}

186 
	gpublic
:

188 
boŞ
 
	$isR—d
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsR—d
); 
	}
}

189 
boŞ
 
	$isWr™e
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsWr™e
); 
	}
}

190 
boŞ
 
	$isUpg¿de
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsUpg¿de
); 
	}
}

191 
boŞ
 
	$isReque¡
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsReque¡
); 
	}
}

192 
boŞ
 
	$isRe¥Ú£
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsRe¥Ú£
); 
	}
}

193 
boŞ
 
	$ÃedsWr™abË
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
N“dsWr™abË
); 
	}
}

194 
boŞ
 
	$ÃedsRe¥Ú£
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
N“dsRe¥Ú£
); 
	}
}

195 
boŞ
 
	$isInv®id©e
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsInv®id©e
); 
	}
}

196 
boŞ
 
	$isEviùiÚ
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsEviùiÚ
); 
	}
}

197 
boŞ
 
	$äomCache
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
FromCache
); 
	}
}

202 
boŞ
 
	$isWr™eback
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsEviùiÚ
) &&

203 
	`‹¡CmdA‰rib
(
HasD©a
); 
	}
}

210 
boŞ
 
	$hasD©a
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
HasD©a
); 
	}
}

211 
boŞ
 
	$isLLSC
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsLlsc
); 
	}
}

212 
boŞ
 
	$isSWP»ãtch
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsSWP»ãtch
); 
	}
}

213 
boŞ
 
	$isHWP»ãtch
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsHWP»ãtch
); 
	}
}

214 
boŞ
 
	$isP»ãtch
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsSWP»ãtch
) ||

215 
	`‹¡CmdA‰rib
(
IsHWP»ãtch
); 
	}
}

216 
boŞ
 
	$isE¼Ü
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsE¼Ü
); 
	}
}

217 
boŞ
 
	$isPršt
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsPršt
); 
	}
}

218 
boŞ
 
	$isFlush
(ècÚ¡ {  
	`‹¡CmdA‰rib
(
IsFlush
); 
	}
}

220 
Commªd


221 
	$»¥Ú£Commªd
() const

223  
commªdInfo
[
cmd
].
»¥Ú£
;

224 
	}
}

227 cÚ¡ 
	g¡d
::
¡ršg
 &
	$toSŒšg
(ècÚ¡ {  
commªdInfo
[
cmd
].
¡r
; 
	}
}

228 
	$toIÁ
(ècÚ¡ {  ()
cmd
; 
	}
}

230 
	$MemCmd
(
Commªd
 
_cmd
è: 
	$cmd
(
_cmd
è{ 
	}
}

231 
	$MemCmd
(
_cmd
è: 
	`cmd
((
Commªd
)_cmdè{ 
	}
}

232 
	$MemCmd
(è: 
	$cmd
(
Inv®idCmd
è{ 
	}
}

234 
boŞ
 
İ”©Ü
==(
MemCmd
 
c2
ècÚ¡ {  (
cmd
 == c2.cmd); }

235 
boŞ
 
	gİ”©Ü
!=(
MemCmd
 
c2
ècÚ¡ {  (
cmd
 != c2.cmd); }

245 şas 
	cPack‘
 : 
public
 
PršbË


247 
public
:

248 
ušt32_t
 
	tFÏgsTy³
;

249 ::
FÏgs
<
	tFÏgsTy³
> 
	tFÏgs
;

251 
	m´iv©e
:

253 : 
FÏgsTy³
 {

255 
COPY_FLAGS
 = 0x0000000F,

259 
	mHAS_SHARERS
 = 0x00000001,

263 
	mEXPRESS_SNOOP
 = 0x00000002,

268 
	mRESPONDER_HAD_WRITABLE
 = 0x00000004,

272 
	mCACHE_RESPONDING
 = 0x00000008,

275 
	mVALID_ADDR
 = 0x00000100,

276 
	mVALID_SIZE
 = 0x00000200,

280 
	mSTATIC_DATA
 = 0x00001000,

284 
	mDYNAMIC_DATA
 = 0x00002000,

288 
	mSUPPRESS_FUNC_ERROR
 = 0x00008000,

292 
	mBLOCK_CACHED
 = 0x00010000

295 
FÏgs
 
	gæags
;

297 
	gpublic
:

298 
MemCmd
::
	tCommªd
 Command;

301 
MemCmd
 
	gcmd
;

304 cÚ¡ 
Reque¡PŒ
 
	g»q
;

306 
	g´iv©e
:

314 
Pack‘D©aPŒ
 
d©a
;

318 
Addr
 
	gaddr
;

321 
boŞ
 
	g_isSecu»
;

324 
	gsize
;

329 
	g¡d
::
veùÜ
<
boŞ
> 
by‹sV®id
;

331 
	gpublic
:

340 
ušt32_t
 
h—d”D–ay
;

348 
ušt32_t
 
	g¢oİD–ay
;

358 
ušt32_t
 
	g·ylßdD–ay
;

377 
	sS’d”S‹


379 
S’d”S‹
* 
	g´edeûssÜ
;

380 
S’d”S‹
(è: 
´edeûssÜ
(
NULL
) {}

381 
vœtu®
 ~
S’d”S‹
() {}

388 şas 
	cPrštReqS‹
 : 
public
 
S’d”S‹


390 
´iv©e
:

394 
	sLab–SckEÁry


396 cÚ¡ 
¡d
::
¡ršg
 
Ïb–
;

397 
	g¡d
::
¡ršg
 *
´efix
;

398 
boŞ
 
	gÏb–Prš‹d
;

399 
Lab–SckEÁry
(cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
, std::¡ršg *
_´efix
);

402 
	g¡d
::
	tli¡
<
	tLab–SckEÁry
> 
	tLab–Sck
;

403 
Lab–Sck
 
	gÏb–Sck
;

405 
	g¡d
::
¡ršg
 *
curP»fixPŒ
;

407 
	gpublic
:

408 
¡d
::
o¡»am
 &
os
;

409 cÚ¡ 
	gv”bos™y
;

411 
PrštReqS‹
(
¡d
::
o¡»am
 &
os
, 
v”bos™y
 = 0);

412 ~
PrštReqS‹
();

417 cÚ¡ 
	g¡d
::
¡ršg
 &
curP»fix
(è{  *
curP»fixPŒ
; }

424 
pushLab–
(cÚ¡ 
¡d
::
¡ršg
 &
lbl
,

425 cÚ¡ 
¡d
::
¡ršg
 &
´efix
 = " ");

430 
pİLab–
();

437 
´štLab–s
();

443 
´štObj
(
PršbË
 *
obj
);

454 
S’d”S‹
 *
	g£nd”S‹
;

464 
pushS’d”S‹
(
S’d”S‹
 *
£nd”_¡©e
);

474 
S’d”S‹
 *
pİS’d”S‹
();

483 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

484 
T
 * 
	$fšdNextS’d”S‹
() const

486 
T
 *
t
 = 
NULL
;

487 
S’d”S‹
* 
£nd”_¡©e
 = 
£nd”S‹
;

488 
t
 =ğ
NULL
 && 
£nd”_¡©e
 != NULL) {

489 
t
 = 
dyÇmic_ÿ¡
<
T
*>(
£nd”_¡©e
);

490 
£nd”_¡©e
 = s’d”_¡©e->
´edeûssÜ
;

492  
t
;

493 
	}
}

497 cÚ¡ 
	g¡d
::
¡ršg
 &
	$cmdSŒšg
(ècÚ¡ {  
cmd
.
	`toSŒšg
(); 
	}
}

500 
šlše
 
	$cmdToIndex
(ècÚ¡ {  
cmd
.
	`toIÁ
(); 
	}
}

502 
boŞ
 
	$isR—d
(ècÚ¡ {  
cmd
.
	`isR—d
(); 
	}
}

503 
boŞ
 
	$isWr™e
(ècÚ¡ {  
cmd
.
	`isWr™e
(); 
	}
}

504 
boŞ
 
	$isUpg¿de
(ècÚ¡ {  
cmd
.
	`isUpg¿de
(); 
	}
}

505 
boŞ
 
	$isReque¡
(ècÚ¡ {  
cmd
.
	`isReque¡
(); 
	}
}

506 
boŞ
 
	$isRe¥Ú£
(ècÚ¡ {  
cmd
.
	`isRe¥Ú£
(); 
	}
}

507 
boŞ
 
	$ÃedsWr™abË
() const

513 
	`as£¹
(
	`isReque¡
());

514  
cmd
.
	`ÃedsWr™abË
();

515 
	}
}

516 
boŞ
 
	$ÃedsRe¥Ú£
(ècÚ¡ {  
cmd
.
	`ÃedsRe¥Ú£
(); 
	}
}

517 
boŞ
 
	$isInv®id©e
(ècÚ¡ {  
cmd
.
	`isInv®id©e
(); 
	}
}

518 
boŞ
 
	$isEviùiÚ
(ècÚ¡ {  
cmd
.
	`isEviùiÚ
(); 
	}
}

519 
boŞ
 
	$äomCache
(ècÚ¡ {  
cmd
.
	`äomCache
(); 
	}
}

520 
boŞ
 
	$isWr™eback
(ècÚ¡ {  
cmd
.
	`isWr™eback
(); 
	}
}

521 
boŞ
 
	$hasD©a
(ècÚ¡ {  
cmd
.
	`hasD©a
(); 
	}
}

522 
boŞ
 
	$hasRe¥D©a
() const

524 
MemCmd
 
»¥_cmd
 = 
cmd
.
	`»¥Ú£Commªd
();

525  
»¥_cmd
.
	`hasD©a
();

526 
	}
}

527 
boŞ
 
	$isLLSC
(ècÚ¡ {  
cmd
.
	`isLLSC
(); 
	}
}

528 
boŞ
 
	$isE¼Ü
(ècÚ¡ {  
cmd
.
	`isE¼Ü
(); 
	}
}

529 
boŞ
 
	$isPršt
(ècÚ¡ {  
cmd
.
	`isPršt
(); 
	}
}

530 
boŞ
 
	$isFlush
(ècÚ¡ {  
cmd
.
	`isFlush
(); 
	}
}

552 
	$£tCacheRe¥Údšg
()

554 
	`as£¹
(
	`isReque¡
());

555 
	`as£¹
(!
æags
.
	`isS‘
(
CACHE_RESPONDING
));

556 
æags
.
	`£t
(
CACHE_RESPONDING
);

557 
	}
}

558 
boŞ
 
	$ÿcheRe¥Údšg
(ècÚ¡ {  
æags
.
	`isS‘
(
CACHE_RESPONDING
); 
	}
}

584 
	$£tHasSh¬”s
(è{ 
æags
.
	`£t
(
HAS_SHARERS
); 
	}
}

585 
boŞ
 
	$hasSh¬”s
(ècÚ¡ {  
æags
.
	`isS‘
(
HAS_SHARERS
); 
	}
}

600 
	$£tEx´essSnoİ
(è{ 
æags
.
	`£t
(
EXPRESS_SNOOP
); 
	}
}

601 
boŞ
 
	$isEx´essSnoİ
(ècÚ¡ {  
æags
.
	`isS‘
(
EXPRESS_SNOOP
); 
	}
}

612 
	$£tRe¥Úd”HadWr™abË
()

614 
	`as£¹
(
	`ÿcheRe¥Údšg
());

615 
æags
.
	`£t
(
RESPONDER_HAD_WRITABLE
);

616 
	}
}

617 
boŞ
 
	$»¥Úd”HadWr™abË
() const

618 {  
æags
.
	`isS‘
(
RESPONDER_HAD_WRITABLE
); 
	}
}

620 
	$£tSuµ»ssFuncE¼Ü
(è{ 
æags
.
	`£t
(
SUPPRESS_FUNC_ERROR
); 
	}
}

621 
boŞ
 
	$suµ»ssFuncE¼Ü
(ècÚ¡ {  
æags
.
	`isS‘
(
SUPPRESS_FUNC_ERROR
); 
	}
}

622 
	$£tBlockCached
(è{ 
æags
.
	`£t
(
BLOCK_CACHED
); 
	}
}

623 
boŞ
 
	$isBlockCached
(ècÚ¡ {  
æags
.
	`isS‘
(
BLOCK_CACHED
); 
	}
}

624 
	$ş—rBlockCached
(è{ 
æags
.
	`ş—r
(
BLOCK_CACHED
); 
	}
}

630 
	$£tBadAdd»ss
()

632 
	`as£¹
(
	`isRe¥Ú£
());

633 
cmd
 = 
MemCmd
::
BadAdd»ssE¼Ü
;

634 
	}
}

636 
	$cİyE¼Ü
(
Pack‘
 *
pkt
è{ 
	`as£¹
Õkt->
	`isE¼Ü
()); 
cmd
 =…kt->cmd; 
	}
}

638 
Addr
 
	$g‘Addr
(ècÚ¡ { 
	`as£¹
(
æags
.
	`isS‘
(
VALID_ADDR
));  
addr
; 
	}
}

646 
	$£tAddr
(
Addr
 
_addr
è{ 
	`as£¹
(
æags
.
	`isS‘
(
VALID_ADDR
)); 
addr
 = _addr; 
	}
}

648 
	$g‘Size
(ècÚ¡ { 
	`as£¹
(
æags
.
	`isS‘
(
VALID_SIZE
));  
size
; 
	}
}

650 
Addr
 
	$g‘Off£t
(
blk_size
) const

652  
	`g‘Addr
(è& 
	`Addr
(
blk_size
 - 1);

653 
	}
}

655 
Addr
 
	$g‘BlockAddr
(
blk_size
) const

657  
	`g‘Addr
(è& ~(
	`Addr
(
blk_size
 - 1));

658 
	}
}

660 
boŞ
 
	$isSecu»
() const

662 
	`as£¹
(
æags
.
	`isS‘
(
VALID_ADDR
));

663  
_isSecu»
;

664 
	}
}

669 
AtomicOpFunùÜ
 *
	$g‘AtomicOp
(ècÚ¡ {  
»q
->
	`g‘AtomicOpFunùÜ
(); 
	}
}

670 
boŞ
 
	$isAtomicOp
(ècÚ¡ {  
»q
->
	`isAtomic
(); 
	}
}

677 
	$cÚv”tScToWr™e
()

679 
	`as£¹
(
	`isLLSC
());

680 
	`as£¹
(
	`isWr™e
());

681 
cmd
 = 
MemCmd
::
Wr™eReq
;

682 
	}
}

689 
	$cÚv”tLlToR—d
()

691 
	`as£¹
(
	`isLLSC
());

692 
	`as£¹
(
	`isR—d
());

693 
cmd
 = 
MemCmd
::
R—dReq
;

694 
	}
}

701 
	$Pack‘
(cÚ¡ 
Reque¡PŒ
 
_»q
, 
MemCmd
 
_cmd
)

702 : 
	`cmd
(
_cmd
), 
	`»q
(
_»q
), 
	`d©a
(
nuÎ±r
), 
	`addr
(0), 
	`_isSecu»
(
çl£
),

703 
	`size
(0), 
	`h—d”D–ay
(0), 
	`¢oİD–ay
(0), 
	`·ylßdD–ay
(0),

704 
	$£nd”S‹
(
NULL
)

706 ià(
»q
->
	`hasPaddr
()) {

707 
addr
 = 
»q
->
	`g‘Paddr
();

708 
æags
.
	`£t
(
VALID_ADDR
);

709 
_isSecu»
 = 
»q
->
	`isSecu»
();

711 ià(
»q
->
	`hasSize
()) {

712 
size
 = 
»q
->
	`g‘Size
();

713 
æags
.
	`£t
(
VALID_SIZE
);

715 
	}
}

722 
	$Pack‘
(cÚ¡ 
Reque¡PŒ
 
_»q
, 
MemCmd
 
_cmd
, 
_blkSize
)

723 : 
	`cmd
(
_cmd
), 
	`»q
(
_»q
), 
	`d©a
(
nuÎ±r
), 
	`addr
(0), 
	`_isSecu»
(
çl£
),

724 
	`h—d”D–ay
(0), 
	`¢oİD–ay
(0), 
	`·ylßdD–ay
(0),

725 
	$£nd”S‹
(
NULL
)

727 ià(
»q
->
	`hasPaddr
()) {

728 
addr
 = 
»q
->
	`g‘Paddr
(è& ~(
_blkSize
 - 1);

729 
æags
.
	`£t
(
VALID_ADDR
);

730 
_isSecu»
 = 
»q
->
	`isSecu»
();

732 
size
 = 
_blkSize
;

733 
æags
.
	`£t
(
VALID_SIZE
);

734 
	}
}

743 
	$Pack‘
(cÚ¡ 
Pack‘PŒ
 
pkt
, 
boŞ
 
ş—r_æags
, boŞ 
®loc_d©a
)

744 : 
	`cmd
(
pkt
->
cmd
), 
	`»q
Õkt->
»q
),

745 
	`d©a
(
nuÎ±r
),

746 
	`addr
(
pkt
->
addr
), 
	`_isSecu»
Õkt->
_isSecu»
), 
	`size
Õkt->
size
),

747 
	`by‹sV®id
(
pkt
->
by‹sV®id
),

748 
	`h—d”D–ay
(
pkt
->
h—d”D–ay
),

749 
	`¢oİD–ay
(0),

750 
	`·ylßdD–ay
(
pkt
->
·ylßdD–ay
),

751 
	`£nd”S‹
(
pkt
->
£nd”S‹
)

753 ià(!
ş—r_æags
)

754 
æags
.
	`£t
(
pkt
->æag & 
COPY_FLAGS
);

756 
æags
.
	`£t
(
pkt
->æag & (
VALID_ADDR
|
VALID_SIZE
));

761 ià(
®loc_d©a
) {

766 ià(
pkt
->
æags
.
	`isS‘
(
STATIC_DATA
)) {

767 
d©a
 = 
pkt
->data;

768 
æags
.
	`£t
(
STATIC_DATA
);

770 
	`®loÿ‹
();

773 
	}
}

778 
MemCmd


779 
	$makeR—dCmd
(cÚ¡ 
Reque¡PŒ
 
»q
)

781 ià(
»q
->
	`isLLSC
())

782  
MemCmd
::
LßdLockedReq
;

783 ià(
»q
->
	`isP»ãtch
())

784  
MemCmd
::
SoáPFReq
;

786  
MemCmd
::
R—dReq
;

787 
	}
}

792 
MemCmd


793 
	$makeWr™eCmd
(cÚ¡ 
Reque¡PŒ
 
»q
)

795 ià(
»q
->
	`isLLSC
())

796  
MemCmd
::
StÜeCÚdReq
;

797 ià(
»q
->
	`isSw­
())

798  
MemCmd
::
Sw­Req
;

800  
MemCmd
::
Wr™eReq
;

801 
	}
}

807 
Pack‘PŒ


808 
	$ü—‹R—d
(cÚ¡ 
Reque¡PŒ
 
»q
)

810  
Ãw
 
	`Pack‘
(
»q
, 
	`makeR—dCmd
(req));

811 
	}
}

813 
Pack‘PŒ


814 
	$ü—‹Wr™e
(cÚ¡ 
Reque¡PŒ
 
»q
)

816  
Ãw
 
	`Pack‘
(
»q
, 
	`makeWr™eCmd
(req));

817 
	}
}

822 ~
	$Pack‘
()

832 ià(
»q
 && 
	`isReque¡
(è&& !
	`ÃedsRe¥Ú£
() &&

833 !
	`isEx´essSnoİ
()) {

834 
d–‘e
 
»q
;

836 
	`d–‘eD©a
();

837 
	}
}

844 
	$makeRe¥Ú£
()

846 
	`as£¹
(
	`ÃedsRe¥Ú£
());

847 
	`as£¹
(
	`isReque¡
());

848 
cmd
 = cmd.
	`»¥Ú£Commªd
();

852 
æags
.
	`ş—r
(
EXPRESS_SNOOP
);

853 
	}
}

856 
	$makeAtomicRe¥Ú£
()

858 
	`makeRe¥Ú£
();

859 
	}
}

862 
	$makeTimšgRe¥Ú£
()

864 
	`makeRe¥Ú£
();

865 
	}
}

868 
	$£tFunùiÚ®Re¥Ú£Stus
(
boŞ
 
sucûss
)

870 ià(!
sucûss
) {

871 ià(
	`isWr™e
()) {

872 
cmd
 = 
MemCmd
::
FunùiÚ®Wr™eE¼Ü
;

874 
cmd
 = 
MemCmd
::
FunùiÚ®R—dE¼Ü
;

877 
	}
}

880 
	$£tSize
(
size
)

882 
	`as£¹
(!
æags
.
	`isS‘
(
VALID_SIZE
));

884 
this
->
size
 = size;

885 
æags
.
	`£t
(
VALID_SIZE
);

886 
	}
}

889 
	gpublic
:

906 
‹m¶©e
 <
ty³Çme
 
T
>

908 
	$d©aStic
(
T
 *
p
)

910 
	`as£¹
(
æags
.
	`nÚeS‘
(
STATIC_DATA
|
DYNAMIC_DATA
));

911 
d©a
 = (
Pack‘D©aPŒ
)
p
;

912 
æags
.
	`£t
(
STATIC_DATA
);

913 
	}
}

923 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

925 
	$d©aSticCÚ¡
(cÚ¡ 
T
 *
p
)

927 
	`as£¹
(
æags
.
	`nÚeS‘
(
STATIC_DATA
|
DYNAMIC_DATA
));

928 
d©a
 = 
cÚ¡_ÿ¡
<
Pack‘D©aPŒ
>(
p
);

929 
æags
.
	`£t
(
STATIC_DATA
);

930 
	}
}

944 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

946 
	$d©aDyÇmic
(
T
 *
p
)

948 
	`as£¹
(
æags
.
	`nÚeS‘
(
STATIC_DATA
|
DYNAMIC_DATA
));

949 
d©a
 = (
Pack‘D©aPŒ
)
p
;

950 
æags
.
	`£t
(
DYNAMIC_DATA
);

951 
	}
}

956 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

957 
T
*

958 
	$g‘PŒ
()

960 
	`as£¹
(
æags
.
	`isS‘
(
STATIC_DATA
|
DYNAMIC_DATA
));

961  (
T
*)
d©a
;

962 
	}
}

964 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

965 cÚ¡ 
T
*

966 
	$g‘CÚ¡PŒ
() const

968 
	`as£¹
(
æags
.
	`isS‘
(
STATIC_DATA
|
DYNAMIC_DATA
));

969  (cÚ¡ 
T
*)
d©a
;

970 
	}
}

976 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

977 
T
 
	$g‘BE
() const;

983 
‹m¶©e
 <
ty³Çme
 
T
>

984 
T
 
	$g‘LE
() const;

990 
‹m¶©e
 <
ty³Çme
 
T
>

991 
T
 
	$g‘
(
By‹Ord”
 
’dŸn
) const;

997 
‹m¶©e
 <
ty³Çme
 
T
>

998 
T
 
	$g‘
() const;

1001 
‹m¶©e
 <
ty³Çme
 
T
>

1002 
	`£tBE
(
T
 
v
);

1005 
‹m¶©e
 <
ty³Çme
 
T
>

1006 
	`£tLE
(
T
 
v
);

1012 
‹m¶©e
 <
ty³Çme
 
T
>

1013 
	`£t
(
T
 
v
, 
By‹Ord”
 
’dŸn
);

1016 
‹m¶©e
 <
ty³Çme
 
T
>

1017 
	`£t
(
T
 
v
);

1023 
	$£tD©a
(cÚ¡ 
ušt8_t
 *
p
)

1028 
	`as£¹
(
p
 !ğ
g‘PŒ
<
ušt8_t
>(è|| 
æags
.
	`isS‘
(
STATIC_DATA
));

1030 ià(
p
 !ğ
g‘PŒ
<
ušt8_t
>())

1033 
¡d
::
	`memıy
(
g‘PŒ
<
ušt8_t
>(), 
p
, 
	`g‘Size
());

1034 
	}
}

1041 
	$£tD©aFromBlock
(cÚ¡ 
ušt8_t
 *
blk_d©a
, 
blkSize
)

1043 
	`£tD©a
(
blk_d©a
 + 
	`g‘Off£t
(
blkSize
));

1044 
	}
}

1051 
	$wr™eD©a
(
ušt8_t
 *
p
) const

1053 
¡d
::
	`memıy
(
p
, 
g‘CÚ¡PŒ
<
ušt8_t
>(), 
	`g‘Size
());

1054 
	}
}

1060 
	$wr™eD©aToBlock
(
ušt8_t
 *
blk_d©a
, 
blkSize
) const

1062 
	`wr™eD©a
(
blk_d©a
 + 
	`g‘Off£t
(
blkSize
));

1063 
	}
}

1070 
	$d–‘eD©a
()

1072 ià(
æags
.
	`isS‘
(
DYNAMIC_DATA
))

1073 
d–‘e
 [] 
d©a
;

1075 
æags
.
	`ş—r
(
STATIC_DATA
|
DYNAMIC_DATA
);

1076 
d©a
 = 
NULL
;

1077 
	}
}

1081 
	$®loÿ‹
()

1085 ià(
	`hasD©a
(è|| 
	`hasRe¥D©a
()) {

1086 
	`as£¹
(
æags
.
	`nÚeS‘
(
STATIC_DATA
|
DYNAMIC_DATA
));

1087 
æags
.
	`£t
(
DYNAMIC_DATA
);

1088 
d©a
 = 
Ãw
 
ušt8_t
[
	`g‘Size
()];

1090 
	}
}

1094 
	g´iv©e
:

1096 
‹m¶©e
 <
ty³Çme
 
T
>

1097 
T
 
	$g‘Raw
() const;

1100 
‹m¶©e
 <
ty³Çme
 
T
>

1101 
	`£tRaw
(
T
 
v
);

1103 
public
:

1113 
boŞ


1114 
	$checkFunùiÚ®
(
Pack‘PŒ
 
Ùh”
)

1118  
	`checkFunùiÚ®
(
Ùh”
, oth”->
	`g‘Addr
(), oth”->
	`isSecu»
(),

1119 
Ùh”
->
	`g‘Size
(),

1120 
Ùh”
->
	`hasD©a
() ?

1121 
Ùh”
->
g‘PŒ
<
ušt8_t
>(è: 
NULL
);

1122 
	}
}

1128 
boŞ


1129 
	$mu¡CheckAbove
() const

1131  
cmd
 =ğ
MemCmd
::
H¬dPFReq
 || 
	`isEviùiÚ
();

1132 
	}
}

1138 
boŞ


1139 
	$isCËªEviùiÚ
() const

1141  
cmd
 =ğ
MemCmd
::
CËªEviù
 || cmd =ğMemCmd::
Wr™ebackCËª
;

1142 
	}
}

1151 
boŞ


1152 
checkFunùiÚ®
(
PršbË
 *
obj
, 
Addr
 
ba£
, 
boŞ
 
is_£cu»
, 
size
,

1153 
ušt8_t
 *
_d©a
);

1159 
	$pushLab–
(cÚ¡ 
¡d
::
¡ršg
 &
lbl
)

1161 ià(
	`isPršt
())

1162 
§ã_ÿ¡
<
PrštReqS‹
*>(
£nd”S‹
)->
	`pushLab–
(
lbl
);

1163 
	}
}

1169 
	$pİLab–
()

1171 ià(
	`isPršt
())

1172 
§ã_ÿ¡
<
PrštReqS‹
*>(
£nd”S‹
)->
	`pİLab–
();

1173 
	}
}

1175 
´št
(
¡d
::
o¡»am
 &
o
, 
v”bos™y
 = 0,

1176 cÚ¡ 
¡d
::
¡ršg
 &
´efix
 = "") const;

1184 
	g¡d
::
¡ršg
 
	$´št
() const;

1185 
	}
};

	@packet_access.hh

45 
	~"¬ch/i§_Œa™s.hh
"

46 
	~"ba£/bigšt.hh
"

47 
	~"cÚfig/the_i§.hh
"

48 
	~"mem/·ck‘.hh
"

49 
	~"sim/by‹sw­.hh
"

51 #iâdeà
__MEM_PACKET_ACCESS_HH__


52 
	#__MEM_PACKET_ACCESS_HH__


	)

54 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

55 
šlše
 
T


56 
	gPack‘
::
	$g‘Raw
() const

58 
	`as£¹
(
æags
.
	`isS‘
(
STATIC_DATA
|
DYNAMIC_DATA
));

59 
	`as£¹
((
T
è<ğ
size
);

60  *(
T
*)
d©a
;

61 
	}
}

63 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

64 
šlše
 

65 
	gPack‘
::
	$£tRaw
(
T
 
v
)

67 
	`as£¹
(
æags
.
	`isS‘
(
STATIC_DATA
|
DYNAMIC_DATA
));

68 
	`as£¹
((
T
è<ğ
size
);

69 *(
T
*)
d©a
 = 
v
;

70 
	}
}

73 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

74 
šlše
 
T


75 
	gPack‘
::
	$g‘BE
() const

77  
	`b‘oh
(
g‘Raw
<
T
>());

78 
	}
}

80 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

81 
šlše
 
T


82 
	gPack‘
::
	$g‘LE
() const

84  
	`Ëtoh
(
g‘Raw
<
T
>());

85 
	}
}

87 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

88 
šlše
 
T


89 
	gPack‘
::
	$g‘
(
By‹Ord”
 
’dŸn
) const

91 
’dŸn
) {

92 
BigEndŸnBy‹Ord”
:

93  
g‘BE
<
T
>();

95 
L™eEndŸnBy‹Ord”
:

96  
g‘LE
<
T
>();

99 
	`·nic
("Illegal byte order in Packet::get()\n");

101 
	}
}

103 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

104 
šlše
 
T


105 
	gPack‘
::
	$g‘
() const

107  
TheISA
::
	`gtoh
(
g‘Raw
<
T
>());

108 
	}
}

110 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

111 
šlše
 

112 
	gPack‘
::
	$£tBE
(
T
 
v
)

114 
	`£tRaw
(
	`htobe
(
v
));

115 
	}
}

117 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

118 
šlše
 

119 
	gPack‘
::
	$£tLE
(
T
 
v
)

121 
	`£tRaw
(
	`htŞe
(
v
));

122 
	}
}

124 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

125 
šlše
 

126 
	gPack‘
::
	$£t
(
T
 
v
, 
By‹Ord”
 
’dŸn
)

128 
’dŸn
) {

129 
BigEndŸnBy‹Ord”
:

130  
£tBE
<
T
>(
v
);

132 
L™eEndŸnBy‹Ord”
:

133  
£tLE
<
T
>(
v
);

136 
	`·nic
("Illegal byte order in Packet::set()\n");

138 
	}
}

140 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

141 
šlše
 

142 
	gPack‘
::
	$£t
(
T
 
v
)

144 
	`£tRaw
(
TheISA
::
	`htog
(
v
));

145 
	}
}

	@packet_queue.cc

44 
	~"ba£/Œaû.hh
"

45 
	~"debug/D¿š.hh
"

46 
	~"debug/Pack‘Queue.hh
"

47 
	~"mem/·ck‘_queue.hh
"

49 
usšg
 
Çme¥aû
 
	g¡d
;

51 
	gPack‘Queue
::
	$Pack‘Queue
(
Ev’tMªag”
& 
_em
, cÚ¡ 
¡d
::
¡ršg
& 
_Ïb–
,

52 
boŞ
 
di§bË_§n™y_check
)

53 : 
	`em
(
_em
), 
	`£ndEv’t
(
this
), 
	`_di§bËSª™yCheck
(
di§bË_§n™y_check
),

54 
	`Ïb–
(
_Ïb–
), 
	$wa™šgOnR‘ry
(
çl£
)

56 
	}
}

58 
	gPack‘Queue
::~
	$Pack‘Queue
()

60 
	}
}

63 
Pack‘Queue
::
	$»Œy
()

65 
	`DPRINTF
(
Pack‘Queue
, "Queu% »ûived„‘ry\n", 
	`Çme
());

66 
	`as£¹
(
wa™šgOnR‘ry
);

67 
wa™šgOnR‘ry
 = 
çl£
;

68 
	`£ndDeã¼edPack‘
();

69 
	}
}

71 
boŞ


72 
	gPack‘Queue
::
	$hasAddr
(
Addr
 
addr
) const

76 cÚ¡‡uto& 
p
 : 
Œªsm™Li¡
) {

77 ià(
p
.
pkt
->
	`g‘Addr
(è=ğ
addr
)

78  
Œue
;

80  
çl£
;

81 
	}
}

83 
boŞ


84 
	gPack‘Queue
::
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

86 
pkt
->
	`pushLab–
(
Ïb–
);

88 autØ
i
 = 
Œªsm™Li¡
.
	`begš
();

89 
boŞ
 
found
 = 
çl£
;

91 !
found
 && 
i
 !ğ
Œªsm™Li¡
.
	`’d
()) {

94 
found
 = 
pkt
->
	`checkFunùiÚ®
(
i
->pkt);

95 ++
i
;

98 
pkt
->
	`pİLab–
();

100  
found
;

101 
	}
}

104 
	gPack‘Queue
::
	$schedS’dTimšg
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
, 
boŞ
 
fÜû_Üd”
)

106 
	`DPRINTF
(
Pack‘Queue
, "%s for %s‡ddress %x size %d when %lu ord: %i\n",

107 
__func__
, 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
(),…kt->
	`g‘Size
(), 
wh’
,

108 
fÜû_Üd”
);

111 
	`as£¹
(
wh’
 >ğ
	`curTick
());

114 
	`as£¹
(!
pkt
->
	`isEx´essSnoİ
());

118 ià(!
_di§bËSª™yCheck
 && 
Œªsm™Li¡
.
	`size
() > 100) {

119 
	`·nic
("Packet queue %s has grown beyond 100…ackets\n",

120 
	`Çme
());

124 ià(
Œªsm™Li¡
.
	`em±y
()) {

125 
Œªsm™Li¡
.
	`em¶aû_äÚt
(
wh’
, 
pkt
);

126 
	`schedS’dEv’t
(
wh’
);

142 autØ
i
 = 
Œªsm™Li¡
.
	`’d
();

143 --
i
;

144 
i
 !ğ
Œªsm™Li¡
.
	`begš
(è&& 
wh’
 < i->
tick
 &&

145 !(
fÜû_Üd”
 && 
i
->
pkt
->
	`g‘Addr
() ==…kt->getAddr()))

146 --
i
;

150 
Œªsm™Li¡
.
	`em¶aû
(++
i
, 
wh’
, 
pkt
);

151 
	}
}

154 
	gPack‘Queue
::
	$schedS’dEv’t
(
Tick
 
wh’
)

157 ià(
wa™šgOnR‘ry
) {

158 
	`DPRINTF
(
Pack‘Queue
, "Not scheduling send‡s waiting for„etry\n");

159 
	`as£¹
(!
£ndEv’t
.
	`scheduËd
());

163 ià(
wh’
 !ğ
MaxTick
) {

166 
wh’
 = 
¡d
::
	`max
(wh’, 
	`curTick
() + 1);

169 ià(!
£ndEv’t
.
	`scheduËd
()) {

170 
em
.
	`scheduË
(&
£ndEv’t
, 
wh’
);

171 } ià(
wh’
 < 
£ndEv’t
.
	`wh’
()) {

174 
em
.
	`»scheduË
(&
£ndEv’t
, 
wh’
);

179 ià(
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
 &&

180 
Œªsm™Li¡
.
	`em±y
(è&& !
£ndEv’t
.
	`scheduËd
()) {

182 
	`DPRINTF
(
D¿š
, "PacketQueue done draining,"

184 
	`sigÇlD¿šDÚe
();

187 
	}
}

190 
	gPack‘Queue
::
	$£ndDeã¼edPack‘
()

193 
	`as£¹
(!
wa™šgOnR‘ry
);

194 
	`as£¹
(
	`deã¼edPack‘R—dy
());

196 
Deã¼edPack‘
 
dp
 = 
Œªsm™Li¡
.
	`äÚt
();

203 
Œªsm™Li¡
.
	`pİ_äÚt
();

207 
wa™šgOnR‘ry
 = !
	`£ndTimšg
(
dp
.
pkt
);

211 ià(!
wa™šgOnR‘ry
) {

212 
	`schedS’dEv’t
(
	`deã¼edPack‘R—dyTime
());

215 
Œªsm™Li¡
.
	`em¶aû_äÚt
(
dp
);

217 
	}
}

220 
	gPack‘Queue
::
	$´oûssS’dEv’t
()

222 
	`as£¹
(!
wa™šgOnR‘ry
);

223 
	`£ndDeã¼edPack‘
();

224 
	}
}

226 
D¿šS‹


227 
	gPack‘Queue
::
	$d¿š
()

229 ià(
Œªsm™Li¡
.
	`em±y
()) {

230  
D¿šS‹
::
D¿šed
;

232 
	`DPRINTF
(
D¿š
, "PacketQueue‚ot drained\n");

233  
D¿šS‹
::
D¿ššg
;

235 
	}
}

237 
	gReqPack‘Queue
::
	$ReqPack‘Queue
(
Ev’tMªag”
& 
_em
, 
Ma¡”PÜt
& 
_ma¡”PÜt
,

238 cÚ¡ 
¡d
::
¡ršg
 
_Ïb–
)

239 : 
	`Pack‘Queue
(
_em
, 
_Ïb–
), 
	$ma¡”PÜt
(
_ma¡”PÜt
)

241 
	}
}

243 
boŞ


244 
	gReqPack‘Queue
::
	$£ndTimšg
(
Pack‘PŒ
 
pkt
)

246  
ma¡”PÜt
.
	`£ndTimšgReq
(
pkt
);

247 
	}
}

249 
	gSnoİRe¥Pack‘Queue
::
	$SnoİRe¥Pack‘Queue
(
Ev’tMªag”
& 
_em
,

250 
Ma¡”PÜt
& 
_ma¡”PÜt
,

251 cÚ¡ 
¡d
::
¡ršg
 
_Ïb–
)

252 : 
	`Pack‘Queue
(
_em
, 
_Ïb–
), 
	$ma¡”PÜt
(
_ma¡”PÜt
)

254 
	}
}

256 
boŞ


257 
	gSnoİRe¥Pack‘Queue
::
	$£ndTimšg
(
Pack‘PŒ
 
pkt
)

259  
ma¡”PÜt
.
	`£ndTimšgSnoİRe¥
(
pkt
);

260 
	}
}

262 
	gRe¥Pack‘Queue
::
	$Re¥Pack‘Queue
(
Ev’tMªag”
& 
_em
, 
SÏvePÜt
& 
_¦avePÜt
,

263 cÚ¡ 
¡d
::
¡ršg
 
_Ïb–
)

264 : 
	`Pack‘Queue
(
_em
, 
_Ïb–
), 
	$¦avePÜt
(
_¦avePÜt
)

266 
	}
}

268 
boŞ


269 
	gRe¥Pack‘Queue
::
	$£ndTimšg
(
Pack‘PŒ
 
pkt
)

271  
¦avePÜt
.
	`£ndTimšgRe¥
(
pkt
);

272 
	}
}

	@packet_queue.hh

44 #iâdeà
__MEM_PACKET_QUEUE_HH__


45 
	#__MEM_PACKET_QUEUE_HH__


	)

55 
	~<li¡
>

57 
	~"mem/pÜt.hh
"

58 
	~"sim/d¿š.hh
"

59 
	~"sim/ev’tq_im¶.hh
"

65 şas 
	cPack‘Queue
 : 
public
 
D¿šabË


67 
´iv©e
:

69 şas 
	cDeã¼edPack‘
 {

70 
public
:

71 
Tick
 
tick
;

72 
Pack‘PŒ
 
	mpkt
;

73 
Deã¼edPack‘
(
Tick
 
t
, 
Pack‘PŒ
 
p
)

74 : 
tick
(
t
), 
pkt
(
p
)

78 
	g¡d
::
	tli¡
<
	tDeã¼edPack‘
> 
	tDeã¼edPack‘Li¡
;

81 
Deã¼edPack‘Li¡
 
	gŒªsm™Li¡
;

84 
	gEv’tMªag”
& 
	gem
;

87 
´oûssS’dEv’t
();

90 
	gEv’tW¿µ”
<
	gPack‘Queue
, &Pack‘Queue::
´oûssS’dEv’t
> 
£ndEv’t
;

97 
boŞ
 
	g_di§bËSª™yCheck
;

99 
	g´Ùeùed
:

102 cÚ¡ 
¡d
::
¡ršg
 
Ïb–
;

105 
boŞ
 
	gwa™šgOnR‘ry
;

108 
boŞ
 
	$deã¼edPack‘R—dy
() const

109 {  !
Œªsm™Li¡
.
	`em±y
(è&&¿nsm™Li¡.
	`äÚt
().
tick
 <ğ
	`curTick
(); 
	}
}

119 
vœtu®
 
£ndDeã¼edPack‘
();

125 
vœtu®
 
boŞ
 
£ndTimšg
(
Pack‘PŒ
 
pkt
) = 0;

136 
Pack‘Queue
(
Ev’tMªag”
& 
_em
, cÚ¡ 
¡d
::
¡ršg
& 
_Ïb–
,

137 
boŞ
 
di§bË_§n™y_check
 = 
çl£
);

142 
	gvœtu®
 ~
Pack‘Queue
();

144 
	gpublic
:

151 
vœtu®
 cÚ¡ 
¡d
::
¡ršg
 
	$Çme
() const = 0;

156 
size_t
 
	$size
(ècÚ¡ {  
Œªsm™Li¡
.
	`size
(); 
	}
}

161 
Tick
 
	$deã¼edPack‘R—dyTime
() const

162 {  
Œªsm™Li¡
.
	`em±y
(è? 
MaxTick
 :¿nsm™Li¡.
	`äÚt
().
tick
; 
	}
}

167 
boŞ
 
	$hasAddr
(
Addr
 
addr
) const;

171 
boŞ
 
	`checkFunùiÚ®
(
Pack‘PŒ
 
pkt
);

182 
	`schedS’dEv’t
(
Tick
 
wh’
);

191 
	`schedS’dTimšg
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
, 
boŞ
 
fÜû_Üd”
 = 
çl£
);

198 
	`»Œy
();

206 
	$di§bËSª™yCheck
(è{ 
_di§bËSª™yCheck
 = 
Œue
; 
	}
}

208 
D¿šS‹
 
	$d¿š
(è
ov”ride
;

209 
	}
};

211 şas 
	cReqPack‘Queue
 : 
public
 
Pack‘Queue


214 
´Ùeùed
:

216 
Ma¡”PÜt
& 
ma¡”PÜt
;

218 
	mpublic
:

229 
ReqPack‘Queue
(
Ev’tMªag”
& 
_em
, 
Ma¡”PÜt
& 
_ma¡”PÜt
,

230 cÚ¡ 
¡d
::
¡ršg
 
_Ïb–
 = "ReqPacketQueue");

232 
	mvœtu®
 ~
	$ReqPack‘Queue
() { }

234 cÚ¡ 
¡d
::
¡ršg
 
	$Çme
() const

235 {  
ma¡”PÜt
.
	`Çme
(è+ "-" + 
Ïb–
; 
	}
}

237 
boŞ
 
£ndTimšg
(
Pack‘PŒ
 
pkt
);

241 şas 
	cSnoİRe¥Pack‘Queue
 : 
public
 
Pack‘Queue


244 
´Ùeùed
:

246 
Ma¡”PÜt
& 
ma¡”PÜt
;

248 
	mpublic
:

259 
SnoİRe¥Pack‘Queue
(
Ev’tMªag”
& 
_em
, 
Ma¡”PÜt
& 
_ma¡”PÜt
,

260 cÚ¡ 
¡d
::
¡ršg
 
_Ïb–
 = "SnoopRespPacketQueue");

262 
	mvœtu®
 ~
	$SnoİRe¥Pack‘Queue
() { }

264 cÚ¡ 
¡d
::
¡ršg
 
	$Çme
() const

265 {  
ma¡”PÜt
.
	`Çme
(è+ "-" + 
Ïb–
; 
	}
}

267 
boŞ
 
£ndTimšg
(
Pack‘PŒ
 
pkt
);

271 şas 
	cRe¥Pack‘Queue
 : 
public
 
Pack‘Queue


274 
´Ùeùed
:

276 
SÏvePÜt
& 
¦avePÜt
;

278 
	mpublic
:

289 
Re¥Pack‘Queue
(
Ev’tMªag”
& 
_em
, 
SÏvePÜt
& 
_¦avePÜt
,

290 cÚ¡ 
¡d
::
¡ršg
 
_Ïb–
 = "RespPacketQueue");

292 
	mvœtu®
 ~
	$Re¥Pack‘Queue
() { }

294 cÚ¡ 
¡d
::
¡ršg
 
	$Çme
() const

295 {  
¦avePÜt
.
	`Çme
(è+ "-" + 
Ïb–
; 
	}
}

297 
boŞ
 
£ndTimšg
(
Pack‘PŒ
 
pkt
);

	@page_table.cc

38 
	~<f¡»am
>

39 
	~<m­
>

40 
	~<memÜy
>

41 
	~<¡ršg
>

43 
	~"ba£/b™f›ld.hh
"

44 
	~"ba£/štm©h.hh
"

45 
	~"ba£/Œaû.hh
"

46 
	~"cÚfig/the_i§.hh
"

47 
	~"debug/MMU.hh
"

48 
	~"mem/·ge_bË.hh
"

49 
	~"sim/çuÉs.hh
"

50 
	~"sim/sim_objeù.hh
"

52 
usšg
 
Çme¥aû
 
	g¡d
;

53 
usšg
 
Çme¥aû
 
	gTheISA
;

55 
	gFuncPageTabË
::
	$FuncPageTabË
(cÚ¡ 
¡d
::
¡ršg
 &
__Çme
,

56 
ušt64_t
 
_pid
, 
Addr
 
_·geSize
)

57 : 
	$PageTabËBa£
(
__Çme
, 
_pid
, 
_·geSize
)

59 
	}
}

61 
	gFuncPageTabË
::~
	$FuncPageTabË
()

63 
	}
}

66 
FuncPageTabË
::
	$m­
(
Addr
 
vaddr
, Add¸
·ddr
, 
št64_t
 
size
, 
ušt64_t
 
æags
)

68 
boŞ
 
şobb”
 = 
æags
 & 
Clobb”
;

70 
	`as£¹
(
	`·geOff£t
(
vaddr
) == 0);

72 
	`DPRINTF
(
MMU
, "AÎoÿtšg Page: %#x-%#x\n", 
vaddr
, vaddr+ 
size
);

74 ; 
size
 > 0; siz-ğ
·geSize
, 
vaddr
 +ğ·geSize, 
·ddr
 +=…ageSize) {

75 ià(!
şobb”
 && (
pTabË
.
	`fšd
(
vaddr
è!ğpTabË.
	`’d
())) {

77 
	`çl
("FuncPageTabË::®loÿ‹:‡dd¸0x%x‡Ì—dy m­³d", 
vaddr
);

80 
pTabË
[
vaddr
] = 
TheISA
::
	`TlbEÁry
(
pid
, vaddr, 
·ddr
,

81 
æags
 & 
Unÿch—bË
,

82 
æags
 & 
R—dOÆy
);

83 
	`”a£CacheEÁry
(
vaddr
);

84 
	`upd©eCache
(
vaddr
, 
pTabË
[vaddr]);

86 
	}
}

89 
	gFuncPageTabË
::
	$»m­
(
Addr
 
vaddr
, 
št64_t
 
size
, Add¸
Ãw_vaddr
)

91 
	`as£¹
(
	`·geOff£t
(
vaddr
) == 0);

92 
	`as£¹
(
	`·geOff£t
(
Ãw_vaddr
) == 0);

94 
	`DPRINTF
(
MMU
, "movšg…age äom vadd¸%08°tØ%08p, sizğ%d\n", 
vaddr
,

95 
Ãw_vaddr
, 
size
);

97 ; 
size
 > 0;

98 
size
 -ğ
·geSize
, 
vaddr
 +ğ·geSize, 
Ãw_vaddr
 +=…ageSize)

100 
	`as£¹
(
pTabË
.
	`fšd
(
vaddr
è!ğpTabË.
	`’d
());

102 
pTabË
[
Ãw_vaddr
] =…TabË[
vaddr
];

103 
pTabË
.
	`”a£
(
vaddr
);

104 
	`”a£CacheEÁry
(
vaddr
);

105 
pTabË
[
Ãw_vaddr
].
	`upd©eVaddr
(new_vaddr);

106 
	`upd©eCache
(
Ãw_vaddr
, 
pTabË
[new_vaddr]);

108 
	}
}

111 
	gFuncPageTabË
::
	$unm­
(
Addr
 
vaddr
, 
št64_t
 
size
)

113 
	`as£¹
(
	`·geOff£t
(
vaddr
) == 0);

115 
	`DPRINTF
(
MMU
, "Unm­pšg…age: %#x-%#x\n", 
vaddr
, vaddr+ 
size
);

117 ; 
size
 > 0; siz-ğ
·geSize
, 
vaddr
 +=…ageSize) {

118 
	`as£¹
(
pTabË
.
	`fšd
(
vaddr
è!ğpTabË.
	`’d
());

119 
pTabË
.
	`”a£
(
vaddr
);

120 
	`”a£CacheEÁry
(
vaddr
);

123 
	}
}

125 
boŞ


126 
	gFuncPageTabË
::
	$isUnm­³d
(
Addr
 
vaddr
, 
št64_t
 
size
)

129 
	`as£¹
(
	`·geOff£t
(
vaddr
) == 0);

131 ; 
size
 > 0; siz-ğ
·geSize
, 
vaddr
 +=…ageSize) {

132 ià(
pTabË
.
	`fšd
(
vaddr
è!ğpTabË.
	`’d
()) {

133  
çl£
;

137  
Œue
;

138 
	}
}

140 
boŞ


141 
	gFuncPageTabË
::
	$lookup
(
Addr
 
vaddr
, 
TheISA
::
TlbEÁry
 &
’Œy
)

143 
Addr
 
·ge_addr
 = 
	`·geAlign
(
vaddr
);

145 ià(
pTabËCache
[0].
v®id
 &&…TabËCache[0].
vaddr
 =ğ
·ge_addr
) {

146 
’Œy
 = 
pTabËCache
[0].entry;

147  
Œue
;

149 ià(
pTabËCache
[1].
v®id
 &&…TabËCache[1].
vaddr
 =ğ
·ge_addr
) {

150 
’Œy
 = 
pTabËCache
[1].entry;

151  
Œue
;

153 ià(
pTabËCache
[2].
v®id
 &&…TabËCache[2].
vaddr
 =ğ
·ge_addr
) {

154 
’Œy
 = 
pTabËCache
[2].entry;

155  
Œue
;

158 
PTabËIŒ
 
™”
 = 
pTabË
.
	`fšd
(
·ge_addr
);

160 ià(
™”
 =ğ
pTabË
.
	`’d
()) {

161  
çl£
;

164 
	`upd©eCache
(
·ge_addr
, 
™”
->
£cÚd
);

165 
’Œy
 = 
™”
->
£cÚd
;

166  
Œue
;

167 
	}
}

169 
boŞ


170 
	gPageTabËBa£
::
	$Œª¦©e
(
Addr
 
vaddr
, Add¸&
·ddr
)

172 
TheISA
::
TlbEÁry
 
’Œy
;

173 ià(!
	`lookup
(
vaddr
, 
’Œy
)) {

174 
	`DPRINTF
(
MMU
, "Couldn'ˆT¿n¦©e: %#x\n", 
vaddr
);

175  
çl£
;

177 
·ddr
 = 
	`·geOff£t
(
vaddr
è+ 
’Œy
.
	`·geS¹
();

178 
	`DPRINTF
(
MMU
, "T¿n¦©šg: %#x->%#x\n", 
vaddr
, 
·ddr
);

179  
Œue
;

180 
	}
}

182 
FauÉ


183 
	gPageTabËBa£
::
	$Œª¦©e
(
Reque¡PŒ
 
»q
)

185 
Addr
 
·ddr
;

186 
	`as£¹
(
	`·geAlign
(
»q
->
	`g‘Vaddr
(è+„eq->
	`g‘Size
() - 1)

187 =ğ
	`·geAlign
(
»q
->
	`g‘Vaddr
()));

188 ià(!
	`Œª¦©e
(
»q
->
	`g‘Vaddr
(), 
·ddr
)) {

189  
	`FauÉ
(
Ãw
 
	`G’”icPageTabËFauÉ
(
»q
->
	`g‘Vaddr
()));

191 
»q
->
	`£tPaddr
(
·ddr
);

192 ià((
·ddr
 & (
·geSize
 - 1)è+ 
»q
->
	`g‘Size
() >…ageSize) {

193 
	`·nic
("Request spans…age boundaries!\n");

194  
NoFauÉ
;

196  
NoFauÉ
;

197 
	}
}

200 
	gFuncPageTabË
::
	$£rŸlize
(
CheckpoštOut
 &
ı
) const

202 
	`·¿mOut
(
ı
, "±abË.size", 
pTabË
.
	`size
());

204 
PTabË
::
size_ty³
 
couÁ
 = 0;

205 autØ&
±e
 : 
pTabË
) {

206 
ScİedCheckpoštSeùiÚ
 
	`£c
(
ı
, 
	`c¥rštf
("EÁry%d", 
couÁ
++));

208 
	`·¿mOut
(
ı
, "vaddr", 
±e
.
fœ¡
);

209 
±e
.
£cÚd
.
	`£rŸlize
(
ı
);

211 
	`as£¹
(
couÁ
 =ğ
pTabË
.
	`size
());

212 
	}
}

215 
	gFuncPageTabË
::
	$un£rŸlize
(
CheckpoštIn
 &
ı
)

217 
couÁ
;

218 
	`·¿mIn
(
ı
, "±abË.size", 
couÁ
);

220 
i
 = 0; i < 
couÁ
; ++i) {

221 
ScİedCheckpoštSeùiÚ
 
	`£c
(
ı
, 
	`c¥rštf
("EÁry%d", 
i
));

223 
¡d
::
unique_±r
<
TheISA
::
TlbEÁry
> 
’Œy
;

224 
Addr
 
vaddr
;

226 
	`·¿mIn
(
ı
, "vaddr", 
vaddr
);

227 
’Œy
.
	`»£t
(
Ãw
 
TheISA
::
	`TlbEÁry
());

228 
’Œy
->
	`un£rŸlize
(
ı
);

230 
pTabË
[
vaddr
] = *
’Œy
;

232 
	}
}

	@page_table.hh

37 #iâdeà
__MEM_PAGE_TABLE_HH__


38 
	#__MEM_PAGE_TABLE_HH__


	)

40 
	~<¡ršg
>

41 
	~<unÜd”ed_m­
>

43 
	~"¬ch/i§_Œa™s.hh
"

44 
	~"¬ch/b.hh
"

45 
	~"ba£/ty³s.hh
"

46 
	~"cÚfig/the_i§.hh
"

47 
	~"mem/»que¡.hh
"

48 
	~"sim/£rŸlize.hh
"

49 
	~"sim/sy¡em.hh
"

51 
şass
 
	gTh»adCÚ‹xt
;

56 şas 
	cPageTabËBa£
 : 
public
 
S”ŸlizabË


58 
´Ùeùed
:

59 
	sÿcheEËm’t
 {

60 
boŞ
 
v®id
;

61 
Addr
 
	mvaddr
;

62 
	mTheISA
::
TlbEÁry
 
’Œy
;

65 
ÿcheEËm’t
 
	gpTabËCache
[3];

67 cÚ¡ 
Addr
 
	g·geSize
;

68 cÚ¡ 
Addr
 
	goff£tMask
;

70 cÚ¡ 
ušt64_t
 
	gpid
;

71 cÚ¡ 
	g¡d
::
¡ršg
 
_Çme
;

73 
	gpublic
:

75 
	$PageTabËBa£
(cÚ¡ 
¡d
::
¡ršg
 &
__Çme
, 
ušt64_t
 
_pid
,

76 
Addr
 
_·geSize
 = 
TheISA
::
PageBy‹s
)

77 : 
	`·geSize
(
_·geSize
), 
	`off£tMask
(
	`mask
(
	`æoÜLog2
(_pageSize))),

78 
	`pid
(
_pid
), 
	$_Çme
(
__Çme
)

80 
	`as£¹
(
	`isPow”Of2
(
·geSize
));

81 
pTabËCache
[0].
v®id
 = 
çl£
;

82 
pTabËCache
[1].
v®id
 = 
çl£
;

83 
pTabËCache
[2].
v®id
 = 
çl£
;

84 
	}
}

86 
	gvœtu®
 ~
	$PageTabËBa£
(è{
	}
};

95 
	gM­pšgFÏgs
 : 
ušt32_t
 {

96 
Z”o
 = 0,

97 
	gClobb”
 = 1,

98 
	gNÙP»£Á
 = 2,

99 
	gUnÿch—bË
 = 4,

100 
	gR—dOÆy
 = 8,

103 
vœtu®
 
š™S‹
(
Th»adCÚ‹xt
* 
tc
) = 0;

106 cÚ¡ 
	g¡d
::
¡ršg
 
	$Çme
(ècÚ¡ {  
_Çme
; 
	}
}

108 
Addr
 
	$·geAlign
(
Addr
 
a
è{  (¨& ~
off£tMask
); 
	}
}

109 
Addr
 
	$·geOff£t
(
Addr
 
a
è{  (¨& 
off£tMask
); 
	}
}

119 
vœtu®
 
m­
(
Addr
 
vaddr
, Add¸
·ddr
, 
št64_t
 
size
,

120 
ušt64_t
 
æags
 = 0) = 0;

121 
vœtu®
 
»m­
(
Addr
 
vaddr
, 
št64_t
 
size
, Add¸
Ãw_vaddr
) = 0;

122 
vœtu®
 
unm­
(
Addr
 
vaddr
, 
št64_t
 
size
) = 0;

130 
vœtu®
 
boŞ
 
isUnm­³d
(
Addr
 
vaddr
, 
št64_t
 
size
) = 0;

137 
vœtu®
 
boŞ
 
lookup
(
Addr
 
vaddr
, 
TheISA
::
TlbEÁry
 &
’Œy
) = 0;

145 
boŞ
 
Œª¦©e
(
Addr
 
vaddr
, Add¸&
·ddr
);

152 
boŞ
 
	$Œª¦©e
(
Addr
 
vaddr
è{ Add¸
dummy
;  
	`Œª¦©e
(vaddr, dummy); 
	}
}

159 
FauÉ
 
Œª¦©e
(
Reque¡PŒ
 
»q
);

166 
šlše
 
	$upd©eCache
(
Addr
 
vaddr
, 
TheISA
::
TlbEÁry
 
’Œy
)

168 
pTabËCache
[2].
’Œy
 =…TableCache[1].entry;

169 
pTabËCache
[2].
vaddr
 =…TableCache[1].vaddr;

170 
pTabËCache
[2].
v®id
 =…TableCache[1].valid;

172 
pTabËCache
[1].
’Œy
 =…TableCache[0].entry;

173 
pTabËCache
[1].
vaddr
 =…TableCache[0].vaddr;

174 
pTabËCache
[1].
v®id
 =…TableCache[0].valid;

176 
pTabËCache
[0].
’Œy
 =ƒntry;

177 
pTabËCache
[0].
vaddr
 = vaddr;

178 
pTabËCache
[0].
v®id
 = 
Œue
;

179 
	}
}

185 
šlše
 
	$”a£CacheEÁry
(
Addr
 
vaddr
)

188 ià(
pTabËCache
[0].
v®id
 &&…TabËCache[0].
vaddr
 == vaddr) {

189 
pTabËCache
[0].
v®id
 = 
çl£
;

190 } ià(
pTabËCache
[1].
v®id
 &&…TabËCache[1].
vaddr
 == vaddr) {

191 
pTabËCache
[1].
v®id
 = 
çl£
;

192 } ià(
pTabËCache
[2].
v®id
 &&…TabËCache[2].
vaddr
 == vaddr) {

193 
pTabËCache
[2].
v®id
 = 
çl£
;

195 
	}
}

201 şas 
	cFuncPageTabË
 : 
public
 
PageTabËBa£


203 
´iv©e
:

204 
¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	tTheISA
::
	tTlbEÁry
> 
	tPTabË
;

205 
	mPTabË
::
	t™”©Ü
 
	tPTabËIŒ
;

206 
PTabË
 
	mpTabË
;

208 
	mpublic
:

210 
FuncPageTabË
(cÚ¡ 
¡d
::
¡ršg
 &
__Çme
, 
ušt64_t
 
_pid
,

211 
Addr
 
_·geSize
 = 
TheISA
::
PageBy‹s
);

213 ~
FuncPageTabË
();

215 
	$š™S‹
(
Th»adCÚ‹xt
* 
tc
è
ov”ride


219 
	$m­
(
Addr
 
vaddr
, Add¸
·ddr
, 
št64_t
 
size
,

220 
ušt64_t
 
æags
 = 0è
ov”ride
;

221 
	$»m­
(
Addr
 
vaddr
, 
št64_t
 
size
, Add¸
Ãw_vaddr
è
ov”ride
;

222 
	$unm­
(
Addr
 
vaddr
, 
št64_t
 
size
è
ov”ride
;

230 
boŞ
 
	$isUnm­³d
(
Addr
 
vaddr
, 
št64_t
 
size
è
ov”ride
;

237 
boŞ
 
	$lookup
(
Addr
 
vaddr
, 
TheISA
::
TlbEÁry
 &
’Œy
è
ov”ride
;

239 
	$£rŸlize
(
CheckpoštOut
 &
ı
ècÚ¡ 
ov”ride
;

240 
	$un£rŸlize
(
CheckpoštIn
 &
ı
è
ov”ride
;

241 
	}
};

248 şas 
	cNoArchPageTabË
 : 
public
 
FuncPageTabË


250 
public
:

251 
	$NoArchPageTabË
(cÚ¡ 
¡d
::
¡ršg
 &
__Çme
, 
ušt64_t
 
_pid
, 
Sy¡em
 *
_sys
,

252 
Addr
 
_·geSize
 = 
TheISA
::
PageBy‹s
è: 
	$FuncPageTabË
(
__Çme
, 
_pid
)

254 
	`çl
("No‡rchitectural…ageable defined forhis ISA.\n");

256 
	}
};

	@physical.cc

40 
	~<sys/mmª.h
>

41 
	~<sys/ty³s.h
>

42 
	~<sys/u£r.h
>

43 
	~<fú.h
>

44 
	~<uni¡d.h
>

45 
	~<zlib.h
>

47 
	~<û¼no
>

48 
	~<şim™s
>

49 
	~<c¡dio
>

50 
	~<io¡»am
>

51 
	~<¡ršg
>

53 
	~"ba£/Œaû.hh
"

54 
	~"debug/AddrRªges.hh
"

55 
	~"debug/Checkpošt.hh
"

56 
	~"mem/ab¡¿ù_mem.hh
"

57 
	~"mem/physiÿl.hh
"

65 #ià
defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
)

66 #iâdeà
MAP_NORESERVE


67 
	#MAP_NORESERVE
 0

	)

71 
usšg
 
Çme¥aû
 
	g¡d
;

73 
	gPhysiÿlMemÜy
::
PhysiÿlMemÜy
(cÚ¡ 
¡ršg
& 
_Çme
,

74 cÚ¡ 
veùÜ
<
Ab¡¿ùMemÜy
*>& 
_memÜ›s
,

75 
boŞ
 
mm­_usšg_nÜe£rve
) :

76 
_Çme
(_Çme), 
¿ngeCache
(
addrM­
.
’d
()), 
size
(0),

77 
	$mm­UsšgNoRe£rve
(
mm­_usšg_nÜe£rve
)

79 ià(
mm­_usšg_nÜe£rve
)

80 
	`w¬n
("Not„eserving swap space. May cause SIGSEGV on‡ctual usage\n");

84 cÚ¡‡uto& 
m
 : 
_memÜ›s
) {

86 ià(
m
->
	`isInAddrM­
()) {

87 
memÜ›s
.
	`push_back
(
m
);

90 
size
 +ğ
m
->
	`size
();

94 
	`çl_if
(
addrM­
.
	`š£¹
(
m
->
	`g‘AddrRªge
(), mè=ğaddrM­.
	`’d
(),

96 
m
->
	`Çme
());

101 
	`DPRINTF
(
AddrRªges
,

103 
m
->
	`Çme
());

106 
	`çl_if
(
m
->
	`g‘AddrRªge
().
	`š‹¾—ved
(),

108 "bš‹¾—ved\n", 
m
->
	`Çme
());

113 
veùÜ
<
Ab¡¿ùMemÜy
*> 
unm­³d_mems
{
m
};

114 
	`ü—‹BackšgStÜe
(
m
->
	`g‘AddrRªge
(), 
unm­³d_mems
,

115 
m
->
	`isCÚfR•Ü‹d
(), m->
	`isInAddrM­
(),

116 
m
->
	`isKvmM­
());

123 
veùÜ
<
AddrRªge
> 
šv_¿nges
;

124 
veùÜ
<
Ab¡¿ùMemÜy
*> 
cu¼_memÜ›s
;

125 cÚ¡‡uto& 
r
 : 
addrM­
) {

128 ià(!
r
.
£cÚd
->
	`isNuÎ
()) {

130 ià(
r
.
fœ¡
.
	`š‹¾—ved
()) {

134 ià(!
šv_¿nges
.
	`em±y
() &&

135 !
šv_¿nges
.
	`back
().
	`m”gesW™h
(
r
.
fœ¡
)) {

136 
AddrRªge
 
	`m”ged_¿nge
(
šv_¿nges
);

138 
Ab¡¿ùMemÜy
 *
f
 = 
cu¼_memÜ›s
.
	`äÚt
();

139 cÚ¡‡uto& 
c
 : 
cu¼_memÜ›s
)

140 ià(
f
->
	`isCÚfR•Ü‹d
(è!ğ
c
->isConfReported() ||

141 
f
->
	`isInAddrM­
(è!ğ
c
->isInAddrMap() ||

142 
f
->
	`isKvmM­
(è!ğ
c
->isKvmMap())

143 
	`çl
("Inconsistent flags in‡n interleaved "

146 
	`ü—‹BackšgStÜe
(
m”ged_¿nge
, 
cu¼_memÜ›s
,

147 
f
->
	`isCÚfR•Ü‹d
(), f->
	`isInAddrM­
(),

148 
f
->
	`isKvmM­
());

150 
šv_¿nges
.
	`ş—r
();

151 
cu¼_memÜ›s
.
	`ş—r
();

153 
šv_¿nges
.
	`push_back
(
r
.
fœ¡
);

154 
cu¼_memÜ›s
.
	`push_back
(
r
.
£cÚd
);

156 
veùÜ
<
Ab¡¿ùMemÜy
*> 
sšgË_memÜy
{
r
.
£cÚd
};

157 
	`ü—‹BackšgStÜe
(
r
.
fœ¡
, 
sšgË_memÜy
,

158 
r
.
£cÚd
->
	`isCÚfR•Ü‹d
(),

159 
r
.
£cÚd
->
	`isInAddrM­
(),

160 
r
.
£cÚd
->
	`isKvmM­
());

167 ià(!
šv_¿nges
.
	`em±y
()) {

168 
AddrRªge
 
	`m”ged_¿nge
(
šv_¿nges
);

170 
Ab¡¿ùMemÜy
 *
f
 = 
cu¼_memÜ›s
.
	`äÚt
();

171 cÚ¡‡uto& 
c
 : 
cu¼_memÜ›s
)

172 ià(
f
->
	`isCÚfR•Ü‹d
(è!ğ
c
->isConfReported() ||

173 
f
->
	`isInAddrM­
(è!ğ
c
->isInAddrMap() ||

174 
f
->
	`isKvmM­
(è!ğ
c
->isKvmMap())

175 
	`çl
("Inconsistent flags in‡n interleaved "

178 
	`ü—‹BackšgStÜe
(
m”ged_¿nge
, 
cu¼_memÜ›s
,

179 
f
->
	`isCÚfR•Ü‹d
(), f->
	`isInAddrM­
(),

180 
f
->
	`isKvmM­
());

182 
	}
}

185 
	gPhysiÿlMemÜy
::
ü—‹BackšgStÜe
(
AddrRªge
 
¿nge
,

186 cÚ¡ 
veùÜ
<
Ab¡¿ùMemÜy
*>& 
_memÜ›s
,

187 
boŞ
 
cÚf_bË_»pÜ‹d
,

188 
boŞ
 
š_addr_m­
, boŞ 
kvm_m­
)

190 
·nic_if
(
¿nge
.
š‹¾—ved
(),

192 
¿nge
.
to_¡ršg
());

195 
DPRINTF
(
AddrRªges
, "Creating backing store for„ange %s with size %d\n",

196 
¿nge
.
to_¡ršg
(),„ªge.
size
());

197 
	gm­_æags
 = 
MAP_ANON
 | 
MAP_PRIVATE
;

201 ià(
	gmm­UsšgNoRe£rve
) {

202 
	gm­_æags
 |ğ
MAP_NORESERVE
;

205 
ušt8_t
* 
	gpmem
 = (ušt8_t*è
mm­
(
NULL
, 
¿nge
.
size
(),

206 
PROT_READ
 | 
PROT_WRITE
,

207 
m­_æags
, -1, 0);

209 ià(
	gpmem
 =ğ(
ušt8_t
*è
MAP_FAILED
) {

210 
³¼Ü
("mmap");

211 
çl
("Could‚Ù mm­ %d by‹ fÜ„ªg%s!\n", 
¿nge
.
size
(),

212 
¿nge
.
to_¡ršg
());

217 
	gbackšgStÜe
.
em¶aû_back
(
¿nge
, 
pmem
,

218 
cÚf_bË_»pÜ‹d
, 
š_addr_m­
, 
kvm_m­
);

221 cÚ¡‡uto& 
	gm
 : 
_memÜ›s
) {

222 
DPRINTF
(
AddrRªges
, "Mapping memory %so backing store\n",

223 
m
->
Çme
());

224 
	gm
->
£tBackšgStÜe
(
pmem
);

228 
	gPhysiÿlMemÜy
::~
	$PhysiÿlMemÜy
()

231 auto& 
s
 : 
backšgStÜe
)

232 
	`munm­
((*)
s
.
pmem
, s.
¿nge
.
	`size
());

233 
	}
}

235 
boŞ


236 
	gPhysiÿlMemÜy
::
	$isMemAddr
(
Addr
 
addr
) const

239 ià(
¿ngeCache
 !ğ
addrM­
.
	`’d
(è&&„ªgeCache->
fœ¡
.
	`cÚšs
(
addr
)) {

240  
Œue
;

243 cÚ¡‡uto& 
r
 = 
addrM­
.
	`fšd
(
addr
);

244 ià(
r
 =ğ
addrM­
.
	`’d
()) {

246  
çl£
;

249 
¿ngeCache
 = 
r
;

250  
Œue
;

252 
	}
}

254 
AddrRªgeLi¡


255 
	gPhysiÿlMemÜy
::
	$g‘CÚfAddrRªges
() const

259 
AddrRªgeLi¡
 
¿nges
;

260 
veùÜ
<
AddrRªge
> 
šv_¿nges
;

261 cÚ¡‡uto& 
r
 : 
addrM­
) {

262 ià(
r
.
£cÚd
->
	`isCÚfR•Ü‹d
()) {

264 ià(
r
.
fœ¡
.
	`š‹¾—ved
()) {

268 ià(!
šv_¿nges
.
	`em±y
() &&

269 !
šv_¿nges
.
	`back
().
	`m”gesW™h
(
r
.
fœ¡
)) {

270 
¿nges
.
	`push_back
(
	`AddrRªge
(
šv_¿nges
));

271 
šv_¿nges
.
	`ş—r
();

273 
šv_¿nges
.
	`push_back
(
r
.
fœ¡
);

276 
¿nges
.
	`push_back
(
r
.
fœ¡
);

283 ià(!
šv_¿nges
.
	`em±y
()) {

284 
¿nges
.
	`push_back
(
	`AddrRªge
(
šv_¿nges
));

287  
¿nges
;

288 
	}
}

291 
	gPhysiÿlMemÜy
::
	$acûss
(
Pack‘PŒ
 
pkt
)

293 
	`as£¹
(
pkt
->
	`isReque¡
());

294 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

295 ià(
¿ngeCache
 !ğ
addrM­
.
	`’d
(è&&„ªgeCache->
fœ¡
.
	`cÚšs
(
addr
)) {

296 
¿ngeCache
->
£cÚd
->
	`acûss
(
pkt
);

300 cÚ¡‡uto& 
m
 = 
addrM­
.
	`fšd
(
addr
);

301 
	`as£¹
(
m
 !ğ
addrM­
.
	`’d
());

302 
m
->
£cÚd
->
	`acûss
(
pkt
);

304 
	}
}

307 
	gPhysiÿlMemÜy
::
	$funùiÚ®Acûss
(
Pack‘PŒ
 
pkt
)

309 
	`as£¹
(
pkt
->
	`isReque¡
());

310 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

311 ià(
¿ngeCache
 !ğ
addrM­
.
	`’d
(è&&„ªgeCache->
fœ¡
.
	`cÚšs
(
addr
)) {

312 
¿ngeCache
->
£cÚd
->
	`funùiÚ®Acûss
(
pkt
);

316 cÚ¡‡uto& 
m
 = 
addrM­
.
	`fšd
(
addr
);

317 
	`as£¹
(
m
 !ğ
addrM­
.
	`’d
());

318 
m
->
£cÚd
->
	`funùiÚ®Acûss
(
pkt
);

320 
	}
}

323 
	gPhysiÿlMemÜy
::
	$£rŸlize
(
CheckpoštOut
 &
ı
) const

326 
veùÜ
<
Addr
> 
Ïl_addr
;

327 
veùÜ
<
CÚ‹xtID
> 
Ïl_cid
;

329 auto& 
m
 : 
memÜ›s
) {

330 cÚ¡ 
li¡
<
LockedAddr
>& 
locked_addrs
 = 
m
->
	`g‘LockedAddrLi¡
();

331 cÚ¡‡uto& 
l
 : 
locked_addrs
) {

332 
Ïl_addr
.
	`push_back
(
l
.
addr
);

333 
Ïl_cid
.
	`push_back
(
l
.
cÚ‹xtId
);

337 
	`SERIALIZE_CONTAINER
(
Ïl_addr
);

338 
	`SERIALIZE_CONTAINER
(
Ïl_cid
);

341 
nbr_of_¡Ües
 = 
backšgStÜe
.
	`size
();

342 
	`SERIALIZE_SCALAR
(
nbr_of_¡Ües
);

344 
¡Üe_id
 = 0;

346 auto& 
s
 : 
backšgStÜe
) {

347 
ScİedCheckpoštSeùiÚ
 
	`£c
(
ı
, 
	`c¥rštf
("¡Üe%d", 
¡Üe_id
));

348 
	`£rŸlizeStÜe
(
ı
, 
¡Üe_id
++, 
s
.
¿nge
, s.
pmem
);

350 
	}
}

353 
	gPhysiÿlMemÜy
::
	$£rŸlizeStÜe
(
CheckpoštOut
 &
ı
, 
¡Üe_id
,

354 
AddrRªge
 
¿nge
, 
ušt8_t
* 
pmem
) const

358 
¡ršg
 
f’ame
 = 
	`Çme
(è+ ".¡Üe" + 
	`to_¡ršg
(
¡Üe_id
) + ".pmem";

359 
¿nge_size
 = 
¿nge
.
	`size
();

361 
	`DPRINTF
(
Checkpošt
, "Serializing…hysical memory %s with size %d\n",

362 
f’ame
, 
¿nge_size
);

364 
	`SERIALIZE_SCALAR
(
¡Üe_id
);

365 
	`SERIALIZE_SCALAR
(
f’ame
);

366 
	`SERIALIZE_SCALAR
(
¿nge_size
);

369 
¡ršg
 
f•©h
 = 
CheckpoštIn
::
	`dœ
(è+ "/" + 
f’ame
.
	`c_¡r
();

370 
gzFe
 
com´es£d_mem
 = 
	`gzİ’
(
f•©h
.
	`c_¡r
(), "wb");

371 ià(
com´es£d_mem
 =ğ
NULL
)

372 
	`çl
("Can't open…hysical memory checkpoint file '%s'\n",

373 
f’ame
);

375 
ušt64_t
 
·ss_size
 = 0;

378 
ušt64_t
 
wr™‹n
 = 0; wr™‹À< 
¿nge
.
	`size
();

379 
wr™‹n
 +ğ
·ss_size
) {

380 
·ss_size
 = (
ušt64_t
)
INT_MAX
 < (
¿nge
.
	`size
(è- 
wr™‹n
) ?

381 (
ušt64_t
)
INT_MAX
 : (
¿nge
.
	`size
(è- 
wr™‹n
);

383 ià(
	`gzwr™e
(
com´es£d_mem
, 
pmem
 + 
wr™‹n
,

384 (è
·ss_size
) != ()…ass_size) {

385 
	`çl
("Write failed on…hysical memory checkpoint file '%s'\n",

386 
f’ame
);

392 ià(
	`gzşo£
(
com´es£d_mem
))

393 
	`çl
("Close failed on…hysical memory checkpoint file '%s'\n",

394 
f’ame
);

396 
	}
}

399 
	gPhysiÿlMemÜy
::
	$un£rŸlize
(
CheckpoštIn
 &
ı
)

403 
veùÜ
<
Addr
> 
Ïl_addr
;

404 
veùÜ
<
CÚ‹xtID
> 
Ïl_cid
;

405 
	`UNSERIALIZE_CONTAINER
(
Ïl_addr
);

406 
	`UNSERIALIZE_CONTAINER
(
Ïl_cid
);

407 
size_t
 
i
 = 0; i < 
Ïl_addr
.
	`size
(); ++i) {

408 cÚ¡‡uto& 
m
 = 
addrM­
.
	`fšd
(
Ïl_addr
[
i
]);

409 
m
->
£cÚd
->
	`addLockedAddr
(
	`LockedAddr
(
Ïl_addr
[
i
], 
Ïl_cid
[i]));

413 
nbr_of_¡Ües
;

414 
	`UNSERIALIZE_SCALAR
(
nbr_of_¡Ües
);

416 
i
 = 0; i < 
nbr_of_¡Ües
; ++i) {

417 
ScİedCheckpoštSeùiÚ
 
	`£c
(
ı
, 
	`c¥rštf
("¡Üe%d", 
i
));

418 
	`un£rŸlizeStÜe
(
ı
);

421 
	}
}

424 
	gPhysiÿlMemÜy
::
	$un£rŸlizeStÜe
(
CheckpoštIn
 &
ı
)

426 cÚ¡ 
ušt32_t
 
chunk_size
 = 16384;

428 
¡Üe_id
;

429 
	`UNSERIALIZE_SCALAR
(
¡Üe_id
);

431 
¡ršg
 
f’ame
;

432 
	`UNSERIALIZE_SCALAR
(
f’ame
);

433 
¡ršg
 
f•©h
 = 
ı
.
ıtDœ
 + "/" + 
f’ame
;

436 
gzFe
 
com´es£d_mem
 = 
	`gzİ’
(
f•©h
.
	`c_¡r
(), "rb");

437 ià(
com´es£d_mem
 =ğ
NULL
)

438 
	`çl
("Cª'ˆİ’…hysiÿÈmemÜy checkpošˆf'%s'", 
f’ame
);

441 
ušt8_t
* 
pmem
 = 
backšgStÜe
[
¡Üe_id
].pmem;

442 
AddrRªge
 
¿nge
 = 
backšgStÜe
[
¡Üe_id
].range;

444 
¿nge_size
;

445 
	`UNSERIALIZE_SCALAR
(
¿nge_size
);

447 
	`DPRINTF
(
Checkpošt
, "Unserializing…hysical memory %s with size %d\n",

448 
f’ame
, 
¿nge_size
);

450 ià(
¿nge_size
 !ğ
¿nge
.
	`size
())

451 
	`çl
("Memory„ange size has changed! Saw %lld,ƒxpected %lld\n",

452 
¿nge_size
, 
¿nge
.
	`size
());

454 
ušt64_t
 
cu¼_size
 = 0;

455 * 
‹mp_·ge
 = 
Ãw
 [
chunk_size
];

456 * 
pmem_cu¼’t
;

457 
ušt32_t
 
by‹s_»ad
;

458 
cu¼_size
 < 
¿nge
.
	`size
()) {

459 
by‹s_»ad
 = 
	`gz»ad
(
com´es£d_mem
, 
‹mp_·ge
, 
chunk_size
);

460 ià(
by‹s_»ad
 == 0)

463 
	`as£¹
(
by‹s_»ad
 % () == 0);

465 
ušt32_t
 
x
 = 0; x < 
by‹s_»ad
 / (); x++) {

468 ià(*(
‹mp_·ge
 + 
x
) != 0) {

469 
pmem_cu¼’t
 = (*)(
pmem
 + 
cu¼_size
 + 
x
 * ());

470 *
pmem_cu¼’t
 = *(
‹mp_·ge
 + 
x
);

473 
cu¼_size
 +ğ
by‹s_»ad
;

476 
d–‘e
[] 
‹mp_·ge
;

478 ià(
	`gzşo£
(
com´es£d_mem
))

479 
	`çl
("Close failed on…hysical memory checkpoint file '%s'\n",

480 
f’ame
);

481 
	}
}

	@physical.hh

40 #iâdeà
__MEM_PHYSICAL_HH__


41 
	#__MEM_PHYSICAL_HH__


	)

43 
	~"ba£/addr_¿nge_m­.hh
"

44 
	~"mem/·ck‘.hh
"

49 
şass
 
	gAb¡¿ùMemÜy
;

54 şas 
	cBackšgStÜeEÁry


56 
	mpublic
:

62 
	$BackšgStÜeEÁry
(
AddrRªge
 
¿nge
, 
ušt8_t
* 
pmem
,

63 
boŞ
 
cÚf_bË_»pÜ‹d
, boŞ 
š_addr_m­
, boŞ 
kvm_m­
)

64 : 
	`¿nge
(
¿nge
), 
	`pmem
(
pmem
), 
	`cÚfTabËR•Ü‹d
(
cÚf_bË_»pÜ‹d
),

65 
	`šAddrM­
(
š_addr_m­
), 
	$kvmM­
(
kvm_m­
)

71 
AddrRªge
 
¿nge
;

77 
ušt8_t
* 
pmem
;

82 
boŞ
 
cÚfTabËR•Ü‹d
;

87 
boŞ
 
šAddrM­
;

93 
boŞ
 
kvmM­
;

94 
	}
};

112 şas 
	cPhysiÿlMemÜy
 : 
public
 
S”ŸlizabË


115 
´iv©e
:

118 
¡d
::
¡ršg
 
_Çme
;

121 
	mAddrRªgeM­
<
	mAb¡¿ùMemÜy
*> 
	maddrM­
;

125 
mubË
 
	mAddrRªgeM­
<
	mAb¡¿ùMemÜy
*>::
cÚ¡_™”©Ü
 
¿ngeCache
;

128 
	m¡d
::
veùÜ
<
Ab¡¿ùMemÜy
*> 
memÜ›s
;

131 
ušt64_t
 
	msize
;

134 cÚ¡ 
boŞ
 
	mmm­UsšgNoRe£rve
;

138 
	m¡d
::
veùÜ
<
BackšgStÜeEÁry
> 
backšgStÜe
;

141 
PhysiÿlMemÜy
(const PhysicalMemory&);

144 
	mPhysiÿlMemÜy
& 
	mİ”©Ü
=(cÚ¡ 
PhysiÿlMemÜy
&);

155 
ü—‹BackšgStÜe
(
AddrRªge
 
¿nge
,

156 cÚ¡ 
¡d
::
veùÜ
<
Ab¡¿ùMemÜy
*>& 
_memÜ›s
,

157 
boŞ
 
cÚf_bË_»pÜ‹d
,

158 
boŞ
 
š_addr_m­
, boŞ 
kvm_m­
);

160 
	mpublic
:

165 
PhysiÿlMemÜy
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
,

166 cÚ¡ 
¡d
::
veùÜ
<
Ab¡¿ùMemÜy
*>& 
_memÜ›s
,

167 
boŞ
 
mm­_usšg_nÜe£rve
);

172 ~
PhysiÿlMemÜy
();

178 cÚ¡ 
	m¡d
::
¡ršg
 
	$Çme
(ècÚ¡ {  
_Çme
; }

187 
boŞ
 
	$isMemAddr
(
Addr
 
addr
) const;

197 
AddrRªgeLi¡
 
	$g‘CÚfAddrRªges
() const;

204 
ušt64_t
 
	$tÙ®Size
(ècÚ¡ {  
size
; 
	}
}

218 
	g¡d
::
veùÜ
<
BackšgStÜeEÁry
> 
	$g‘BackšgStÜe
() const

219 {  
backšgStÜe
; 
	}
}

228 
acûss
(
Pack‘PŒ
 
pkt
);

238 
funùiÚ®Acûss
(
Pack‘PŒ
 
pkt
);

248 
	$£rŸlize
(
CheckpoštOut
 &
ı
ècÚ¡ 
ov”ride
;

257 
	$£rŸlizeStÜe
(
CheckpoštOut
 &
ı
, 
¡Üe_id
,

258 
AddrRªge
 
¿nge
, 
ušt8_t
* 
pmem
) const;

265 
	$un£rŸlize
(
CheckpoštIn
 &
ı
è
ov”ride
;

270 
	`un£rŸlizeStÜe
(
CheckpoštIn
 &
ı
);

272 
	}
};

	@port.cc

49 
	~"ba£/Œaû.hh
"

50 
	~"mem/mem_objeù.hh
"

51 
	~"mem/pÜt.hh
"

53 
	gPÜt
::
	$PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
MemObjeù
& 
_owÃr
, 
PÜtID
 
_id
)

54 : 
	`pÜtName
(
_Çme
), 
	`id
(
_id
), 
	$owÃr
(
_owÃr
)

56 
	}
}

58 
	gPÜt
::~
	$PÜt
()

60 
	}
}

62 
Ba£Ma¡”PÜt
::
	$Ba£Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
,

63 
PÜtID
 
_id
)

64 : 
	`PÜt
(
Çme
, *
owÃr
, 
_id
), 
	$_ba£SÏvePÜt
(
NULL
)

66 
	}
}

68 
	gBa£Ma¡”PÜt
::~
	$Ba£Ma¡”PÜt
()

70 
	}
}

72 
Ba£SÏvePÜt
&

73 
Ba£Ma¡”PÜt
::
	$g‘SÏvePÜt
() const

75 ià(
_ba£SÏvePÜt
 =ğ
NULL
)

76 
	`·nic
("Cannot getSlavePort on master…ort %shat is‚ot connected\n",

77 
	`Çme
());

79  *
_ba£SÏvePÜt
;

80 
	}
}

82 
boŞ


83 
	gBa£Ma¡”PÜt
::
	$isCÚÃùed
() const

85  
_ba£SÏvePÜt
 !ğ
NULL
;

86 
	}
}

88 
	gBa£SÏvePÜt
::
	$Ba£SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
,

89 
PÜtID
 
_id
)

90 : 
	`PÜt
(
Çme
, *
owÃr
, 
_id
), 
	$_ba£Ma¡”PÜt
(
NULL
)

92 
	}
}

94 
	gBa£SÏvePÜt
::~
	$Ba£SÏvePÜt
()

96 
	}
}

98 
Ba£Ma¡”PÜt
&

99 
Ba£SÏvePÜt
::
	$g‘Ma¡”PÜt
() const

101 ià(
_ba£Ma¡”PÜt
 =ğ
NULL
)

102 
	`·nic
("Cannot getMasterPort on slave…ort %shat is‚ot connected\n",

103 
	`Çme
());

105  *
_ba£Ma¡”PÜt
;

106 
	}
}

108 
boŞ


109 
	gBa£SÏvePÜt
::
	$isCÚÃùed
() const

111  
_ba£Ma¡”PÜt
 !ğ
NULL
;

112 
	}
}

117 
	gMa¡”PÜt
::
	$Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
, 
PÜtID
 
_id
)

118 : 
	`Ba£Ma¡”PÜt
(
Çme
, 
owÃr
, 
_id
), 
	$_¦avePÜt
(
NULL
)

120 
	}
}

122 
	gMa¡”PÜt
::~
	$Ma¡”PÜt
()

124 
	}
}

127 
Ma¡”PÜt
::
	$bšd
(
Ba£SÏvePÜt
& 
¦ave_pÜt
)

130 
_ba£SÏvePÜt
 = &
¦ave_pÜt
;

133 
SÏvePÜt
* 
ÿ¡_¦ave_pÜt
 = 
dyÇmic_ÿ¡
<SÏvePÜt*>(&
¦ave_pÜt
);

136 ià(
ÿ¡_¦ave_pÜt
 !ğ
NULL
) {

138 
_¦avePÜt
 = 
ÿ¡_¦ave_pÜt
;

140 
_¦avePÜt
->
	`bšd
(*
this
);

142 
	`çl
("Ma¡”…Üˆ% ÿÂÙ bšdØ%s\n", 
	`Çme
(),

143 
¦ave_pÜt
.
	`Çme
());

145 
	}
}

148 
	gMa¡”PÜt
::
	$unbšd
()

150 ià(
_¦avePÜt
 =ğ
NULL
)

151 
	`·nic
("Attemptingo unbind master…ort %shat is‚ot connected\n",

152 
	`Çme
());

153 
_¦avePÜt
->
	`unbšd
();

154 
_¦avePÜt
 = 
NULL
;

155 
_ba£SÏvePÜt
 = 
NULL
;

156 
	}
}

158 
AddrRªgeLi¡


159 
	gMa¡”PÜt
::
	$g‘AddrRªges
() const

161  
_¦avePÜt
->
	`g‘AddrRªges
();

162 
	}
}

164 
Tick


165 
	gMa¡”PÜt
::
	$£ndAtomic
(
Pack‘PŒ
 
pkt
)

167 
	`as£¹
(
pkt
->
	`isReque¡
());

168  
_¦avePÜt
->
	`»cvAtomic
(
pkt
);

169 
	}
}

172 
	gMa¡”PÜt
::
	$£ndFunùiÚ®
(
Pack‘PŒ
 
pkt
)

174 
	`as£¹
(
pkt
->
	`isReque¡
());

175  
_¦avePÜt
->
	`»cvFunùiÚ®
(
pkt
);

176 
	}
}

178 
boŞ


179 
	gMa¡”PÜt
::
	$£ndTimšgReq
(
Pack‘PŒ
 
pkt
)

181 
	`as£¹
(
pkt
->
	`isReque¡
());

182  
_¦avePÜt
->
	`»cvTimšgReq
(
pkt
);

183 
	}
}

185 
boŞ


186 
	gMa¡”PÜt
::
	$£ndTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

188 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

189  
_¦avePÜt
->
	`»cvTimšgSnoİRe¥
(
pkt
);

190 
	}
}

193 
	gMa¡”PÜt
::
	$£ndR‘ryRe¥
()

195 
_¦avePÜt
->
	`»cvRe¥R‘ry
();

196 
	}
}

199 
	gMa¡”PÜt
::
	$´štAddr
(
Addr
 
a
)

201 
Reque¡
 
	`»q
(
a
, 1, 0, Reque¡::
funcMa¡”Id
);

202 
Pack‘
 
	`pkt
(&
»q
, 
MemCmd
::
PrštReq
);

203 
Pack‘
::
PrštReqS‹
 
	`´s
(
¡d
::
û¼
);

204 
pkt
.
£nd”S‹
 = &
´s
;

206 
	`£ndFunùiÚ®
(&
pkt
);

207 
	}
}

212 
	gSÏvePÜt
::
	$SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
, 
PÜtID
 
id
)

213 : 
	`Ba£SÏvePÜt
(
Çme
, 
owÃr
, 
id
), 
	$_ma¡”PÜt
(
NULL
)

215 
	}
}

217 
	gSÏvePÜt
::~
	$SÏvePÜt
()

219 
	}
}

222 
SÏvePÜt
::
	$unbšd
()

224 
_ba£Ma¡”PÜt
 = 
NULL
;

225 
_ma¡”PÜt
 = 
NULL
;

226 
	}
}

229 
	gSÏvePÜt
::
	$bšd
(
Ma¡”PÜt
& 
ma¡”_pÜt
)

231 
_ba£Ma¡”PÜt
 = &
ma¡”_pÜt
;

232 
_ma¡”PÜt
 = &
ma¡”_pÜt
;

233 
	}
}

235 
Tick


236 
	gSÏvePÜt
::
	$£ndAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

238 
	`as£¹
(
pkt
->
	`isReque¡
());

239  
_ma¡”PÜt
->
	`»cvAtomicSnoİ
(
pkt
);

240 
	}
}

243 
	gSÏvePÜt
::
	$£ndFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

245 
	`as£¹
(
pkt
->
	`isReque¡
());

246  
_ma¡”PÜt
->
	`»cvFunùiÚ®Snoİ
(
pkt
);

247 
	}
}

249 
boŞ


250 
	gSÏvePÜt
::
	$£ndTimšgRe¥
(
Pack‘PŒ
 
pkt
)

252 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

253  
_ma¡”PÜt
->
	`»cvTimšgRe¥
(
pkt
);

254 
	}
}

257 
	gSÏvePÜt
::
	$£ndTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

259 
	`as£¹
(
pkt
->
	`isReque¡
());

260 
_ma¡”PÜt
->
	`»cvTimšgSnoİReq
(
pkt
);

261 
	}
}

264 
	gSÏvePÜt
::
	$£ndR‘ryReq
()

266 
_ma¡”PÜt
->
	`»cvReqR‘ry
();

267 
	}
}

270 
	gSÏvePÜt
::
	$£ndR‘rySnoİRe¥
()

272 
_ma¡”PÜt
->
	`»cvR‘rySnoİRe¥
();

273 
	}
}

	@port.hh

50 #iâdeà
__MEM_PORT_HH__


51 
	#__MEM_PORT_HH__


	)

53 
	~"ba£/addr_¿nge.hh
"

54 
	~"mem/·ck‘.hh
"

56 
şass
 
	gMemObjeù
;

63 şas 
	cPÜt


66 
	m´iv©e
:

69 
¡d
::
¡ršg
 
pÜtName
;

71 
	m´Ùeùed
:

77 cÚ¡ 
PÜtID
 
id
;

80 
	mMemObjeù
& 
	mowÃr
;

89 
PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
MemObjeù
& 
_owÃr
, 
PÜtID
 
_id
);

94 
	mvœtu®
 ~
PÜt
();

96 
	mpublic
:

99 cÚ¡ 
¡d
::
¡ršg
 
	$Çme
(ècÚ¡ {  
pÜtName
; }

102 
PÜtID
 
	$g‘Id
(ècÚ¡ {  
id
; 
	}
}

107 
şass
 
	gBa£SÏvePÜt
;

115 şas 
	cBa£Ma¡”PÜt
 : 
public
 
PÜt


118 
´Ùeùed
:

120 
Ba£SÏvePÜt
* 
_ba£SÏvePÜt
;

122 
Ba£Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
,

123 
PÜtID
 
id
 = 
Inv®idPÜtID
);

124 
	mvœtu®
 ~
Ba£Ma¡”PÜt
();

126 
	mpublic
:

128 
vœtu®
 
bšd
(
Ba£SÏvePÜt
& 
¦ave_pÜt
) = 0;

129 
vœtu®
 
unbšd
() = 0;

130 
	mBa£SÏvePÜt
& 
	$g‘SÏvePÜt
() const;

131 
boŞ
 
	$isCÚÃùed
() const;

139 şas 
	cBa£SÏvePÜt
 : 
public
 
PÜt


142 
´Ùeùed
:

144 
Ba£Ma¡”PÜt
* 
_ba£Ma¡”PÜt
;

146 
	`Ba£SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
,

147 
PÜtID
 
id
 = 
Inv®idPÜtID
);

148 
vœtu®
 ~
	`Ba£SÏvePÜt
();

150 
public
:

152 
Ba£Ma¡”PÜt
& 
	$g‘Ma¡”PÜt
() const;

153 
boŞ
 
	$isCÚÃùed
() const;

158 
şass
 
SÏvePÜt
;

167 şas 
	cMa¡”PÜt
 : 
public
 
Ba£Ma¡”PÜt


170 
ä›nd
 
şass
 
SÏvePÜt
;

172 
´iv©e
:

174 
SÏvePÜt
* 
_¦avePÜt
;

176 
public
:

178 
	`Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
,

179 
PÜtID
 
id
 = 
Inv®idPÜtID
);

180 
vœtu®
 ~
	`Ma¡”PÜt
();

186 
	`bšd
(
Ba£SÏvePÜt
& 
¦ave_pÜt
);

191 
	`unbšd
();

202 
Tick
 
	`£ndAtomic
(
Pack‘PŒ
 
pkt
);

211 
	`£ndFunùiÚ®
(
Pack‘PŒ
 
pkt
);

224 
boŞ
 
	`£ndTimšgReq
(
Pack‘PŒ
 
pkt
);

235 
boŞ
 
	`£ndTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
);

243 
vœtu®
 
	`£ndR‘ryRe¥
();

254 
vœtu®
 
boŞ
 
	$isSnoİšg
(ècÚ¡ {  
çl£
; }

259 
AddrRªgeLi¡
 
	$g‘AddrRªges
() const;

264 
	`´štAddr
(
Addr
 
a
);

266 
´Ùeùed
:

271 
vœtu®
 
Tick
 
	$»cvAtomicSnoİ
(
Pack‘PŒ
 
pkt
)

273 
	`·nic
("% wa nÙƒx³ùšg‡À©omiø¢oİ„eque¡\n", 
	`Çme
());

275 
	}
}

280 
vœtu®
 
	$»cvFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
)

282 
	`·nic
("% wa nÙƒx³ùšg‡ funùiÚ® snoİ„eque¡\n", 
	`Çme
());

283 
	}
}

288 
vœtu®
 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
) = 0;

293 
vœtu®
 
	$»cvTimšgSnoİReq
(
Pack‘PŒ
 
pkt
)

295 
	`·nic
("% wa nÙƒx³ùšg‡imšg snoİ„eque¡\n", 
	`Çme
());

296 
	}
}

303 
vœtu®
 
»cvReqR‘ry
() = 0;

310 
vœtu®
 
	$»cvR‘rySnoİRe¥
()

312 
	`·nic
("% wa nÙƒx³ùšg‡ snoİ„‘ry\n", 
	`Çme
());

313 
	}
}

322 
vœtu®
 
	$»cvRªgeChªge
(è{ 
	}
}

331 şas 
	cSÏvePÜt
 : 
public
 
Ba£SÏvePÜt


334 
ä›nd
 
şass
 
Ma¡”PÜt
;

336 
	m´iv©e
:

338 
Ma¡”PÜt
* 
_ma¡”PÜt
;

340 
	mpublic
:

342 
SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
,

343 
PÜtID
 
id
 = 
Inv®idPÜtID
);

344 
	mvœtu®
 ~
SÏvePÜt
();

355 
Tick
 
£ndAtomicSnoİ
(
Pack‘PŒ
 
pkt
);

364 
£ndFunùiÚ®Snoİ
(
Pack‘PŒ
 
pkt
);

377 
boŞ
 
£ndTimšgRe¥
(
Pack‘PŒ
 
pkt
);

386 
£ndTimšgSnoİReq
(
Pack‘PŒ
 
pkt
);

392 
£ndR‘ryReq
();

398 
£ndR‘rySnoİRe¥
();

405 
boŞ
 
	$isSnoİšg
(ècÚ¡ {  
_ma¡”PÜt
->
	`isSnoİšg
(); }

410 
	$£ndRªgeChªge
() const {

411 ià(!
_ma¡”PÜt
)

412 
	`çl
("% ÿÂÙ s’dRªgeChªge(èw™houˆma¡”…Üt", 
	`Çme
());

413 
_ma¡”PÜt
->
	`»cvRªgeChªge
();

414 
	}
}

423 
vœtu®
 
AddrRªgeLi¡
 
	$g‘AddrRªges
() const = 0;

425 
´Ùeùed
:

431 
	`unbšd
();

437 
	`bšd
(
Ma¡”PÜt
& 
ma¡”_pÜt
);

442 
vœtu®
 
Tick
 
	`»cvAtomic
(
Pack‘PŒ
 
pkt
) = 0;

447 
vœtu®
 
	`»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
) = 0;

452 
vœtu®
 
boŞ
 
	`»cvTimšgReq
(
Pack‘PŒ
 
pkt
) = 0;

457 
vœtu®
 
boŞ
 
	$»cvTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
)

459 
	`·nic
("% wa nÙƒx³ùšg‡imšg snoİ„e¥Ú£\n", 
	`Çme
());

460 
	}
}

467 
vœtu®
 
»cvRe¥R‘ry
() = 0;

	@port_proxy.cc

40 
	~"ba£/chunk_g’”©Ü.hh
"

41 
	~"mem/pÜt_´oxy.hh
"

44 
	gPÜtProxy
::
	$»adBlob
(
Addr
 
addr
, 
ušt8_t
 *
p
, 
size
) const

46 
ChunkG’”©Ü
 
	`g’
(
addr
, 
size
, 
_ÿcheLšeSize
); !
g’
.
	`dÚe
();

47 
g’
.
	`Ãxt
()) {

48 
Reque¡
 
	`»q
(
g’
.
	`addr
(), g’.
	`size
(), 0, Reque¡::
funcMa¡”Id
);

49 
Pack‘
 
	`pkt
(&
»q
, 
MemCmd
::
R—dReq
);

50 
pkt
.
	`d©aStic
(
p
);

51 
_pÜt
.
	`£ndFunùiÚ®
(&
pkt
);

52 
p
 +ğ
g’
.
	`size
();

54 
	}
}

57 
	gPÜtProxy
::
	$wr™eBlob
(
Addr
 
addr
, cÚ¡ 
ušt8_t
 *
p
, 
size
) const

59 
ChunkG’”©Ü
 
	`g’
(
addr
, 
size
, 
_ÿcheLšeSize
); !
g’
.
	`dÚe
();

60 
g’
.
	`Ãxt
()) {

61 
Reque¡
 
	`»q
(
g’
.
	`addr
(), g’.
	`size
(), 0, Reque¡::
funcMa¡”Id
);

62 
Pack‘
 
	`pkt
(&
»q
, 
MemCmd
::
Wr™eReq
);

63 
pkt
.
	`d©aSticCÚ¡
(
p
);

64 
_pÜt
.
	`£ndFunùiÚ®
(&
pkt
);

65 
p
 +ğ
g’
.
	`size
();

67 
	}
}

70 
	gPÜtProxy
::
	$mem£tBlob
(
Addr
 
addr
, 
ušt8_t
 
v
, 
size
) const

73 
ušt8_t
 *
buf
 = 
Ãw
 ušt8_t[
size
];

75 
¡d
::
	`mem£t
(
buf
, 
v
, 
size
);

76 
PÜtProxy
::
	`wr™eBlob
(
addr
, 
buf
, 
size
);

78 
d–‘e
 [] 
buf
;

79 
	}
}

	@port_proxy.hh

59 #iâdeà
__MEM_PORT_PROXY_HH__


60 
	#__MEM_PORT_PROXY_HH__


	)

62 
	~"cÚfig/the_i§.hh
"

63 #ià
THE_ISA
 !ğ
NULL_ISA


64 
	~"¬ch/i§_Œa™s.hh
"

67 
	~"mem/pÜt.hh
"

68 
	~"sim/by‹sw­.hh
"

84 şas 
	cPÜtProxy


86 
	m´iv©e
:

89 
Ma¡”PÜt
 &
_pÜt
;

92 cÚ¡ 
	m_ÿcheLšeSize
;

94 
	mpublic
:

95 
	$PÜtProxy
(
Ma¡”PÜt
 &
pÜt
, 
ÿcheLšeSize
) :

96 
	`_pÜt
(
pÜt
), 
	$_ÿcheLšeSize
(
ÿcheLšeSize
) { }

97 
vœtu®
 ~
	$PÜtProxy
(è{ 
	}
}

102 
vœtu®
 
	$»adBlob
(
Addr
 
addr
, 
ušt8_t
* 
p
, 
size
) const;

107 
vœtu®
 
	$wr™eBlob
(
Addr
 
addr
, cÚ¡ 
ušt8_t
* 
p
, 
size
) const;

112 
vœtu®
 
	$mem£tBlob
(
Addr
 
addr
, 
ušt8_t
 
v
, 
size
) const;

117 
‹m¶©e
 <
ty³Çme
 
T
>

118 
T
 
	$»ad
(
Addr
 
add»ss
) const;

123 
‹m¶©e
 <
ty³Çme
 
T
>

124 
	$wr™e
(
Addr
 
add»ss
, 
T
 
d©a
) const;

126 #ià
THE_ISA
 !ğ
NULL_ISA


131 
‹m¶©e
 <
ty³Çme
 
T
>

132 
T
 
	$»adGtoH
(
Addr
 
add»ss
) const;

138 
‹m¶©e
 <
ty³Çme
 
T
>

139 
	$wr™eHtoG
(
Addr
 
add»ss
, 
T
 
d©a
) const;

141 
	}
};

144 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

145 
T


146 
	gPÜtProxy
::
	$»ad
(
Addr
 
add»ss
) const

148 
T
 
d©a
;

149 
	`»adBlob
(
add»ss
, (
ušt8_t
*)&
d©a
, (
T
));

150  
d©a
;

151 
	}
}

153 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

155 
	gPÜtProxy
::
	$wr™e
(
Addr
 
add»ss
, 
T
 
d©a
) const

157 
	`wr™eBlob
(
add»ss
, (
ušt8_t
*)&
d©a
, (
T
));

158 
	}
}

160 #ià
THE_ISA
 !ğ
NULL_ISA


161 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

162 
T


163 
	gPÜtProxy
::
	$»adGtoH
(
Addr
 
add»ss
) const

165 
T
 
d©a
;

166 
	`»adBlob
(
add»ss
, (
ušt8_t
*)&
d©a
, (
T
));

167  
TheISA
::
	`gtoh
(
d©a
);

168 
	}
}

170 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

172 
	gPÜtProxy
::
	$wr™eHtoG
(
Addr
 
add»ss
, 
T
 
d©a
) const

174 
d©a
 = 
TheISA
::
	`htog
(data);

175 
	`wr™eBlob
(
add»ss
, (
ušt8_t
*)&
d©a
, (
T
));

176 
	}
}

	@probes/base.cc

40 
	~"mem/´obes/ba£.hh
"

42 
	~"·¿ms/Ba£MemProbe.hh
"

45 
	gBa£MemProbe
::
	$Ba£MemProbe
(
Ba£MemProbeP¬ams
 *
p
)

46 : 
	$SimObjeù
(
p
)

48 
	}
}

51 
Ba£MemProbe
::
	$»gProbeLi¡’”s
()

53 cÚ¡ 
Ba£MemProbeP¬ams
 *
	`p
(

54 
dyÇmic_ÿ¡
<cÚ¡ 
Ba£MemProbeP¬ams
 *>(
	`·¿ms
()));

55 
	`as£¹
(
p
);

57 
li¡’”s
.
	`»size
(
p
->
mªag”
.
	`size
());

58 
i
 = 0; i < 
p
->
mªag”
.
	`size
(); i++) {

59 
ProbeMªag”
 *cÚ¡ 
	`mgr
(
p
->
mªag”
[
i
]->
	`g‘ProbeMªag”
());

60 
li¡’”s
[
i
].
	`»£t
(
Ãw
 
	`Pack‘Li¡’”
(*
this
, 
mgr
, 
p
->
´obe_Çme
));

62 
	}
}

	@probes/base.hh

40 #iâdeà
__MEM_PROBES_BASE_HH__


41 
	#__MEM_PROBES_BASE_HH__


	)

43 
	~<memÜy
>

44 
	~<veùÜ
>

46 
	~"sim/´obe/mem.hh
"

47 
	~"sim/sim_objeù.hh
"

49 
	gBa£MemProbeP¬ams
;

63 şas 
	cBa£MemProbe
 : 
public
 
SimObjeù


65 
public
:

66 
Ba£MemProbe
(
Ba£MemProbeP¬ams
 *
·¿ms
);

68 
	$»gProbeLi¡’”s
(è
ov”ride
;

70 
´Ùeùed
:

74 
vœtu®
 
	`hªdËReque¡
(cÚ¡ 
ProbePošts
::
Pack‘Info
 &
pkt_šfo
) = 0;

76 
´iv©e
:

77 
şass
 
Pack‘Li¡’”
 : 
public
 
ProbeLi¡’”ArgBa£
<
ProbePošts
::
Pack‘Info
>

79 
public
:

80 
	`Pack‘Li¡’”
(
Ba£MemProbe
 &
_·»Á
,

81 
ProbeMªag”
 *
pm
, cÚ¡ 
¡d
::
¡ršg
 &
Çme
)

82 : 
	`ProbeLi¡’”ArgBa£
(
pm
, 
Çme
),

83 
	`·»Á
(
_·»Á
) {}

85 
	`nÙify
(cÚ¡ 
ProbePošts
::
Pack‘Info
 &
pkt_šfo
è
ov”ride
 {

86 
·»Á
.
	`hªdËReque¡
(
pkt_šfo
);

89 
´Ùeùed
:

90 
Ba£MemProbe
 &
·»Á
;

93 
¡d
::
veùÜ
<¡d::
unique_±r
<
Pack‘Li¡’”
>> 
li¡’”s
;

94 
	}
};

	@probes/mem_trace.cc

41 
	~"mem/´obes/mem_Œaû.hh
"

43 
	~"ba£/ÿÎback.hh
"

44 
	~"ba£/ouut.hh
"

45 
	~"·¿ms/MemT¿ûProbe.hh
"

46 
	~"´Ùo/·ck‘.pb.h
"

48 
	gMemT¿ûProbe
::
	$MemT¿ûProbe
(
MemT¿ûProbeP¬ams
 *
p
)

49 : 
	`Ba£MemProbe
(
p
),

50 
	`ŒaûSŒ—m
(
nuÎ±r
),

51 
	`w™hPC
(
p
->
w™h_pc
)

53 
¡d
::
¡ršg
 
f’ame
;

54 ià(
p
->
Œaû_fe
 != "") {

57 
f’ame
 = 
simout
.
	`»sŞve
(
p
->
Œaû_fe
);

59 cÚ¡ 
¡d
::
¡ršg
 
suffix
 = ".gz";

62 ià(
p
->
Œaû_com´ess
 &&

63 
f’ame
.
	`com·»
(f’ame.
	`size
(è- 
suffix
.size(), suffix.size(),

64 
suffix
) != 0)

65 
f’ame
 = f’am+ 
suffix
;

69 
f’ame
 = 
simout
.
	`»sŞve
(
	`Çme
() + ".trc" +

70 (
p
->
Œaû_com´ess
 ? ".gz" : ""));

73 
ŒaûSŒ—m
 = 
Ãw
 
	`PrÙoOuutSŒ—m
(
f’ame
);

77 
PrÙoMes§ge
::
Pack‘H—d”
 
h—d”_msg
;

78 
h—d”_msg
.
	`£t_obj_id
(
	`Çme
());

79 
h—d”_msg
.
	`£t_tick_äeq
(
SimClock
::
F»qu’cy
);

80 
ŒaûSŒ—m
->
	`wr™e
(
h—d”_msg
);

85 
	`»gi¡”Ex™C®lback
(

86 
Ãw
 
MakeC®lback
<
MemT¿ûProbe
, &MemT¿ûProbe::
şo£SŒ—ms
>(
this
));

87 
	}
}

90 
	gMemT¿ûProbe
::
	$şo£SŒ—ms
()

92 ià(
ŒaûSŒ—m
 !ğ
NULL
)

93 
d–‘e
 
ŒaûSŒ—m
;

94 
	}
}

97 
	gMemT¿ûProbe
::
	$hªdËReque¡
(cÚ¡ 
ProbePošts
::
Pack‘Info
 &
pkt_šfo
)

99 
PrÙoMes§ge
::
Pack‘
 
pkt_msg
;

101 
pkt_msg
.
	`£t_tick
(
	`curTick
());

102 
pkt_msg
.
	`£t_cmd
(
pkt_šfo
.
cmd
.
	`toIÁ
());

103 
pkt_msg
.
	`£t_æags
(
pkt_šfo
.
æags
);

104 
pkt_msg
.
	`£t_addr
(
pkt_šfo
.
addr
);

105 
pkt_msg
.
	`£t_size
(
pkt_šfo
.
size
);

106 ià(
w™hPC
 && 
pkt_šfo
.
pc
 != 0)

107 
pkt_msg
.
	`£t_pc
(
pkt_šfo
.
pc
);

109 
ŒaûSŒ—m
->
	`wr™e
(
pkt_msg
);

110 
	}
}

113 
MemT¿ûProbe
 *

114 
	gMemT¿ûProbeP¬ams
::
	$ü—‹
()

116  
Ãw
 
	`MemT¿ûProbe
(
this
);

117 
	}
}

	@probes/mem_trace.hh

40 #iâdeà
__MEM_PROBES_MEM_TRACE_HH__


41 
	#__MEM_PROBES_MEM_TRACE_HH__


	)

43 
	~"mem/·ck‘.hh
"

44 
	~"mem/´obes/ba£.hh
"

45 
	~"´Ùo/´Ùoio.hh
"

47 
	gMemT¿ûProbeP¬ams
;

49 şas 
	cMemT¿ûProbe
 : 
public
 
Ba£MemProbe


51 
public
:

52 
MemT¿ûProbe
(
MemT¿ûProbeP¬ams
 *
·¿ms
);

54 
	m´Ùeùed
:

55 
	$hªdËReque¡
(cÚ¡ 
ProbePošts
::
Pack‘Info
 &
pkt_šfo
è
ov”ride
;

61 
	`şo£SŒ—ms
();

63 
´Ùeùed
:

66 
PrÙoOuutSŒ—m
 *
ŒaûSŒ—m
;

68 
´iv©e
:

71 cÚ¡ 
boŞ
 
w™hPC
;

	@probes/stack_dist.cc

40 
	~"mem/´obes/¡ack_di¡.hh
"

42 
	~"·¿ms/SckDi¡Probe.hh
"

43 
	~"sim/sy¡em.hh
"

45 
	gSckDi¡Probe
::
	$SckDi¡Probe
(
SckDi¡ProbeP¬ams
 *
p
)

46 : 
	`Ba£MemProbe
(
p
),

47 
	`lšeSize
(
p
->
lše_size
),

48 
	`di§bËLš—rHi¡s
(
p
->
di§bË_lš—r_hi¡s
),

49 
	`di§bËLogHi¡s
(
p
->
di§bË_log_hi¡s
),

50 
	`ÿlc
(
p
->
v”ify
)

52 
	`çl_if
(
p
->
sy¡em
->
	`ÿcheLšeSize
(è>…->
lše_size
,

55 
	}
}

58 
	gSckDi¡Probe
::
	$»gSts
()

60 
Ba£MemProbe
::
	`»gSts
();

62 cÚ¡ 
SckDi¡ProbeP¬ams
 *
	`p
(

63 
dyÇmic_ÿ¡
<cÚ¡ 
SckDi¡ProbeP¬ams
 *>(
	`·¿ms
()));

64 
	`as£¹
(
p
);

66 
usšg
 
Çme¥aû
 
Sts
;

68 
»adLš—rHi¡


69 .
	`š™
(
p
->
lš—r_hi¡_bšs
)

70 .
	`Çme
(name() + ".readLinearHist")

71 .
	`desc
("Reads†inear distribution")

72 .
	`æags
(
di§bËLš—rHi¡s
 ? 
noz”o
 : 
pdf
);

74 
»adLogHi¡


75 .
	`š™
(
p
->
log_hi¡_bšs
)

76 .
	`Çme
(name() + ".readLogHist")

77 .
	`desc
("Reads†ogarithmic distribution")

78 .
	`æags
(
di§bËLogHi¡s
 ? 
noz”o
 : 
pdf
);

80 
wr™eLš—rHi¡


81 .
	`š™
(
p
->
lš—r_hi¡_bšs
)

82 .
	`Çme
(name() + ".writeLinearHist")

83 .
	`desc
("Writes†inear distribution")

84 .
	`æags
(
di§bËLš—rHi¡s
 ? 
noz”o
 : 
pdf
);

86 
wr™eLogHi¡


87 .
	`š™
(
p
->
log_hi¡_bšs
)

88 .
	`Çme
(name() + ".writeLogHist")

89 .
	`desc
("Writes†ogarithmic distribution")

90 .
	`æags
(
di§bËLogHi¡s
 ? 
noz”o
 : 
pdf
);

92 
šfš™eSD


93 .
	`Çme
(name() + ".infinity")

94 .
	`desc
("Number of„equests with infinite stack distance")

95 .
	`æags
(
noz”o
);

96 
	}
}

99 
	gSckDi¡Probe
::
	$hªdËReque¡
(cÚ¡ 
ProbePošts
::
Pack‘Info
 &
pkt_šfo
)

103 ià(!
pkt_šfo
.
cmd
.
	`isR—d
(è&& !pkt_šfo.cmd.
	`isWr™e
())

107 cÚ¡ 
Addr
 
	`®igÃd_addr
(
	`roundDown
(
pkt_šfo
.
addr
, 
lšeSize
));

110 cÚ¡ 
ušt64_t
 
	`sd
(
ÿlc
.
	`ÿlcSckDi¡AndUpd©e
(
®igÃd_addr
).
fœ¡
);

111 ià(
sd
 =ğ
SckDi¡C®c
::
Infš™y
) {

112 
šfš™eSD
++;

117 ià(!
di§bËLš—rHi¡s
) {

118 ià(
pkt_šfo
.
cmd
.
	`isR—d
())

119 
»adLš—rHi¡
.
	`§m¶e
(
sd
);

121 
wr™eLš—rHi¡
.
	`§m¶e
(
sd
);

124 ià(!
di§bËLogHi¡s
) {

125 
sd_lg2
 = 
sd
 =ğ0 ? 1 : 
	`æoÜLog2
(sd);

128 ià(
pkt_šfo
.
cmd
.
	`isR—d
())

129 
»adLogHi¡
.
	`§m¶e
(
sd_lg2
);

131 
wr™eLogHi¡
.
	`§m¶e
(
sd_lg2
);

133 
	}
}

136 
SckDi¡Probe
 *

137 
	gSckDi¡ProbeP¬ams
::
	$ü—‹
()

139  
Ãw
 
	`SckDi¡Probe
(
this
);

140 
	}
}

	@probes/stack_dist.hh

40 #iâdeà
__MEM_PROBES_STACK_DIST_HH__


41 
	#__MEM_PROBES_STACK_DIST_HH__


	)

43 
	~"mem/·ck‘.hh
"

44 
	~"mem/´obes/ba£.hh
"

45 
	~"mem/¡ack_di¡_ÿlc.hh
"

46 
	~"sim/¡©s.hh
"

48 
	gSckDi¡ProbeP¬ams
;

50 şas 
	cSckDi¡Probe
 : 
public
 
Ba£MemProbe


52 
public
:

53 
SckDi¡Probe
(
SckDi¡ProbeP¬ams
 *
·¿ms
);

55 
	$»gSts
(è
ov”ride
;

57 
´Ùeùed
:

58 
	$hªdËReque¡
(cÚ¡ 
ProbePošts
::
Pack‘Info
 &
pkt_šfo
è
ov”ride
;

60 
´Ùeùed
:

62 cÚ¡ 
lšeSize
;

65 cÚ¡ 
boŞ
 
di§bËLš—rHi¡s
;

68 cÚ¡ 
boŞ
 
di§bËLogHi¡s
;

70 
´Ùeùed
:

72 
Sts
::
Hi¡og¿m
 
»adLš—rHi¡
;

75 
Sts
::
S·r£Hi¡og¿m
 
»adLogHi¡
;

78 
Sts
::
Hi¡og¿m
 
wr™eLš—rHi¡
;

81 
Sts
::
S·r£Hi¡og¿m
 
wr™eLogHi¡
;

84 
Sts
::
SÿÏr
 
šfš™eSD
;

86 
´Ùeùed
:

87 
SckDi¡C®c
 
ÿlc
;

	@qport.hh

40 #iâdeà
__MEM_QPORT_HH__


41 
	#__MEM_QPORT_HH__


	)

48 
	~"mem/·ck‘_queue.hh
"

49 
	~"mem/pÜt.hh
"

59 şas 
	cQueuedSÏvePÜt
 : 
public
 
SÏvePÜt


62 
´Ùeùed
:

65 
Re¥Pack‘Queue
 &
»¥Queue
;

67 
	$»cvRe¥R‘ry
(è{ 
»¥Queue
.
	`»Œy
(); }

69 
public
:

78 
	$QueuedSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
,

79 
Re¥Pack‘Queue
 &
»¥_queue
, 
PÜtID
 
id
 = 
Inv®idPÜtID
) :

80 
	`SÏvePÜt
(
Çme
, 
owÃr
, 
id
), 
	$»¥Queue
(
»¥_queue
)

81 { 
	}
}

83 
	gvœtu®
 ~
	$QueuedSÏvePÜt
(è{ 
	}
}

91 
	$schedTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
, 
boŞ
 
fÜû_Üd”
 = 
çl£
)

92 { 
»¥Queue
.
	`schedS’dTimšg
(
pkt
, 
wh’
, 
fÜû_Üd”
); 
	}
}

96 
boŞ
 
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

97 {  
»¥Queue
.
	`checkFunùiÚ®
(
pkt
); 
	}
}

107 şas 
	cQueuedMa¡”PÜt
 : 
public
 
Ma¡”PÜt


110 
´Ùeùed
:

113 
ReqPack‘Queue
 &
»qQueue
;

116 
	mSnoİRe¥Pack‘Queue
 &
	m¢oİRe¥Queue
;

118 
	$»cvReqR‘ry
(è{ 
»qQueue
.
	`»Œy
(); }

120 
	$»cvR‘rySnoİRe¥
(è{ 
¢oİRe¥Queue
.
	`»Œy
(); 
	}
}

122 
	gpublic
:

131 
	$QueuedMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
,

132 
ReqPack‘Queue
 &
»q_queue
,

133 
SnoİRe¥Pack‘Queue
 &
¢oİ_»¥_queue
,

134 
PÜtID
 
id
 = 
Inv®idPÜtID
) :

135 
	`Ma¡”PÜt
(
Çme
, 
owÃr
, 
id
), 
	`»qQueue
(
»q_queue
),

136 
	$¢oİRe¥Queue
(
¢oİ_»¥_queue
)

137 { 
	}
}

139 
	gvœtu®
 ~
	$QueuedMa¡”PÜt
(è{ 
	}
}

147 
	$schedTimšgReq
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
)

148 { 
»qQueue
.
	`schedS’dTimšg
(
pkt
, 
wh’
); 
	}
}

156 
	$schedTimšgSnoİRe¥
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
, 
boŞ
 
fÜû_Üd”
 =

157 
çl£
)

158 { 
¢oİRe¥Queue
.
	`schedS’dTimšg
(
pkt
, 
wh’
, 
fÜû_Üd”
); 
	}
}

162 
boŞ
 
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

164  
»qQueue
.
	`checkFunùiÚ®
(
pkt
) ||

165 
¢oİRe¥Queue
.
	`checkFunùiÚ®
(
pkt
);

166 
	}
}

	@request.hh

52 #iâdeà
__MEM_REQUEST_HH__


53 
	#__MEM_REQUEST_HH__


	)

55 
	~<ÿs£¹
>

56 
	~<şim™s
>

58 
	~"ba£/æags.hh
"

59 
	~"ba£/misc.hh
"

60 
	~"ba£/ty³s.hh
"

61 
	~"ıu/š¡_£q.hh
"

62 
	~"sim/cÜe.hh
"

72 
Çme¥aû
 
	gCÚ‹xtSw™chTaskId
 {

73 
	eTaskId
 {

74 
	gMaxNÜm®TaskId
 = 1021,

75 
	gP»ãtch”
 = 1022,

76 
	gDMA
 = 1023,

77 
	gUnknown
 = 1024,

78 
	gNumTaskId


82 
şass
 
	gReque¡
;

84 
Reque¡
* 
	tReque¡PŒ
;

85 
ušt16_t
 
	tMa¡”ID
;

87 şas 
	cReque¡


89 
	mpublic
:

90 
ušt32_t
 
	tFÏgsTy³
;

91 
ušt8_t
 
	tArchFÏgsTy³
;

92 ::
FÏgs
<
	tFÏgsTy³
> 
	tFÏgs
;

94 : 
FÏgsTy³
 {

102 
ARCH_BITS
 = 0x000000FF,

104 
	mINST_FETCH
 = 0x00000100,

106 
	mPHYSICAL
 = 0x00000200,

114 
	mUNCACHEABLE
 = 0x00000400,

124 
	mSTRICT_ORDER
 = 0x00000800,

126 
	mMMAPPED_IPR
 = 0x00002000,

128 
	mPRIVILEGED
 = 0x00008000,

134 
	mCACHE_BLOCK_ZERO
 = 0x00010000,

137 
	mNO_ACCESS
 = 0x00080000,

145 
	mLOCKED_RMW
 = 0x00100000,

147 
	mLLSC
 = 0x00200000,

149 
	mMEM_SWAP
 = 0x00400000,

150 
	mMEM_SWAP_COND
 = 0x00800000,

153 
	mPREFETCH
 = 0x01000000,

155 
	mPF_EXCLUSIVE
 = 0x02000000,

157 
	mEVICT_NEXT
 = 0x04000000,

159 
	mACQUIRE
 = 0x00020000,

161 
	mRELEASE
 = 0x00040000,

164 
	mATOMIC_RETURN_OP
 = 0x40000000,

166 
	mATOMIC_NO_RETURN_OP
 = 0x80000000,

172 
	mKERNEL
 = 0x00001000,

178 
	mGENERIC_IPR
 = 0x08000000,

181 
	mSECURE
 = 0x10000000,

183 
	mPT_WALK
 = 0x20000000,

189 
	mSTICKY_FLAGS
 = 
INST_FETCH


194 : 
Ma¡”ID
 {

196 
wbMa¡”Id
 = 0,

201 
	gfuncMa¡”Id
 = 1,

203 
	gštMa¡”Id
 = 2,

208 
	gšvldMa¡”Id
 = 
¡d
::
num”ic_lim™s
<
Ma¡”ID
>::
max
()

212 
ušt32_t
 
	tMemS·ûCÚfigFÏgsTy³
;

213 ::
FÏgs
<
	tMemS·ûCÚfigFÏgsTy³
> 
	tMemS·ûCÚfigFÏgs
;

215 : 
MemS·ûCÚfigFÏgsTy³
 {

217 
SCOPE_VALID
 = 0x00000001,

219 
	gWAVEFRONT_SCOPE
 = 0x00000002,

221 
	gWORKGROUP_SCOPE
 = 0x00000004,

223 
	gDEVICE_SCOPE
 = 0x00000008,

225 
	gSYSTEM_SCOPE
 = 0x00000010,

228 
	gGLOBAL_SEGMENT
 = 0x00000020,

230 
	gGROUP_SEGMENT
 = 0x00000040,

232 
	gPRIVATE_SEGMENT
 = 0x00000080,

234 
	gKERNARG_SEGMENT
 = 0x00000100,

236 
	gREADONLY_SEGMENT
 = 0x00000200,

238 
	gSPILL_SEGMENT
 = 0x00000400,

240 
	gARG_SEGMENT
 = 0x00000800,

243 
	g´iv©e
:

244 
ušt8_t
 
	tPriv©eFÏgsTy³
;

245 ::
FÏgs
<
	tPriv©eFÏgsTy³
> 
	tPriv©eFÏgs
;

247 : 
Priv©eFÏgsTy³
 {

249 
VALID_SIZE
 = 0x00000001,

251 
	gVALID_PADDR
 = 0x00000002,

253 
	gVALID_VADDR
 = 0x00000004,

255 
	gVALID_INST_SEQ_NUM
 = 0x00000008,

257 
	gVALID_PC
 = 0x00000010,

259 
	gVALID_CONTEXT_ID
 = 0x00000020,

261 
	gVALID_EXTRA_DATA
 = 0x00000080,

266 
	gSTICKY_PRIVATE_FLAGS
 = 
VALID_CONTEXT_ID


269 
	g´iv©e
:

276 
	$£tPhys
(
Addr
 
·ddr
, 
size
, 
FÏgs
 
æags
, 
Ma¡”ID
 
mid
, 
Tick
 
time
)

278 
_·ddr
 = 
·ddr
;

279 
_size
 = 
size
;

280 
_time
 = 
time
;

281 
_ma¡”Id
 = 
mid
;

282 
_æags
.
	`ş—r
(~
STICKY_FLAGS
);

283 
_æags
.
	`£t
(
æags
);

284 
´iv©eFÏgs
.
	`ş—r
(~
STICKY_PRIVATE_FLAGS
);

285 
´iv©eFÏgs
.
	`£t
(
VALID_PADDR
|
VALID_SIZE
);

286 
d•th
 = 0;

287 
acûssD–
 = 0;

289 
	}
}

295 
Addr
 
	g_·ddr
;

302 
	g_size
;

307 
Ma¡”ID
 
	g_ma¡”Id
;

310 
FÏgs
 
	g_æags
;

313 
MemS·ûCÚfigFÏgs
 
	g_memS·ûCÚfigFÏgs
;

316 
Priv©eFÏgs
 
	g´iv©eFÏgs
;

323 
Tick
 
	g_time
;

328 
ušt32_t
 
	g_skId
;

331 
	g_asid
;

334 
Addr
 
	g_vaddr
;

339 
ušt64_t
 
	g_exŒaD©a
;

342 
CÚ‹xtID
 
	g_cÚ‹xtId
;

345 
Addr
 
	g_pc
;

348 
In¡SeqNum
 
	g_»qIn¡SeqNum
;

351 
AtomicOpFunùÜ
 *
	g©omicOpFunùÜ
;

353 
	gpublic
:

360 
	$Reque¡
()

361 : 
	`_·ddr
(0), 
	`_size
(0), 
	`_ma¡”Id
(
švldMa¡”Id
), 
	`_time
(0),

362 
	`_skId
(
CÚ‹xtSw™chTaskId
::
Unknown
), 
	`_asid
(0), 
	`_vaddr
(0),

363 
	`_exŒaD©a
(0), 
	`_cÚ‹xtId
(0), 
	`_pc
(0),

364 
	`_»qIn¡SeqNum
(0), 
	`©omicOpFunùÜ
(
nuÎ±r
), 
	`Œª¦©eD–
(0),

365 
	`acûssD–
(0), 
	$d•th
(0)

366 {
	}
}

368 
	$Reque¡
(
Addr
 
·ddr
, 
size
, 
FÏgs
 
æags
, 
Ma¡”ID
 
mid
,

369 
In¡SeqNum
 
£q_num
, 
CÚ‹xtID
 
cid
)

370 : 
	`_·ddr
(0), 
	`_size
(0), 
	`_ma¡”Id
(
švldMa¡”Id
), 
	`_time
(0),

371 
	`_skId
(
CÚ‹xtSw™chTaskId
::
Unknown
), 
	`_asid
(0), 
	`_vaddr
(0),

372 
	`_exŒaD©a
(0), 
	`_cÚ‹xtId
(0), 
	`_pc
(0),

373 
	`_»qIn¡SeqNum
(
£q_num
), 
	`©omicOpFunùÜ
(
nuÎ±r
), 
	`Œª¦©eD–
(0),

374 
	`acûssD–
(0), 
	$d•th
(0)

376 
	`£tPhys
(
·ddr
, 
size
, 
æags
, 
mid
, 
	`curTick
());

377 
	`£tCÚ‹xt
(
cid
);

378 
´iv©eFÏgs
.
	`£t
(
VALID_INST_SEQ_NUM
);

379 
	}
}

386 
	$Reque¡
(
Addr
 
·ddr
, 
size
, 
FÏgs
 
æags
, 
Ma¡”ID
 
mid
)

387 : 
	`_·ddr
(0), 
	`_size
(0), 
	`_ma¡”Id
(
švldMa¡”Id
), 
	`_time
(0),

388 
	`_skId
(
CÚ‹xtSw™chTaskId
::
Unknown
), 
	`_asid
(0), 
	`_vaddr
(0),

389 
	`_exŒaD©a
(0), 
	`_cÚ‹xtId
(0), 
	`_pc
(0),

390 
	`_»qIn¡SeqNum
(0), 
	`©omicOpFunùÜ
(
nuÎ±r
), 
	`Œª¦©eD–
(0),

391 
	`acûssD–
(0), 
	$d•th
(0)

393 
	`£tPhys
(
·ddr
, 
size
, 
æags
, 
mid
, 
	`curTick
());

394 
	}
}

396 
	$Reque¡
(
Addr
 
·ddr
, 
size
, 
FÏgs
 
æags
, 
Ma¡”ID
 
mid
, 
Tick
 
time
)

397 : 
	`_·ddr
(0), 
	`_size
(0), 
	`_ma¡”Id
(
švldMa¡”Id
), 
	`_time
(0),

398 
	`_skId
(
CÚ‹xtSw™chTaskId
::
Unknown
), 
	`_asid
(0), 
	`_vaddr
(0),

399 
	`_exŒaD©a
(0), 
	`_cÚ‹xtId
(0), 
	`_pc
(0),

400 
	`_»qIn¡SeqNum
(0), 
	`©omicOpFunùÜ
(
nuÎ±r
), 
	`Œª¦©eD–
(0),

401 
	`acûssD–
(0), 
	$d•th
(0)

403 
	`£tPhys
(
·ddr
, 
size
, 
æags
, 
mid
, 
time
);

404 
	}
}

406 
	$Reque¡
(
Addr
 
·ddr
, 
size
, 
FÏgs
 
æags
, 
Ma¡”ID
 
mid
, 
Tick
 
time
,

407 
Addr
 
pc
)

408 : 
	`_·ddr
(0), 
	`_size
(0), 
	`_ma¡”Id
(
švldMa¡”Id
), 
	`_time
(0),

409 
	`_skId
(
CÚ‹xtSw™chTaskId
::
Unknown
), 
	`_asid
(0), 
	`_vaddr
(0),

410 
	`_exŒaD©a
(0), 
	`_cÚ‹xtId
(0), 
	`_pc
(
pc
),

411 
	`_»qIn¡SeqNum
(0), 
	`©omicOpFunùÜ
(
nuÎ±r
), 
	`Œª¦©eD–
(0),

412 
	`acûssD–
(0), 
	$d•th
(0)

414 
	`£tPhys
(
·ddr
, 
size
, 
æags
, 
mid
, 
time
);

415 
´iv©eFÏgs
.
	`£t
(
VALID_PC
);

416 
	}
}

418 
	$Reque¡
(
asid
, 
Addr
 
vaddr
, 
size
, 
FÏgs
 
æags
, 
Ma¡”ID
 
mid
,

419 
Addr
 
pc
, 
CÚ‹xtID
 
cid
)

420 : 
	`_·ddr
(0), 
	`_size
(0), 
	`_ma¡”Id
(
švldMa¡”Id
), 
	`_time
(0),

421 
	`_skId
(
CÚ‹xtSw™chTaskId
::
Unknown
), 
	`_asid
(0), 
	`_vaddr
(0),

422 
	`_exŒaD©a
(0), 
	`_cÚ‹xtId
(0), 
	`_pc
(0),

423 
	`_»qIn¡SeqNum
(0), 
	`©omicOpFunùÜ
(
nuÎ±r
), 
	`Œª¦©eD–
(0),

424 
	`acûssD–
(0), 
	$d•th
(0)

426 
	`£tVœt
(
asid
, 
vaddr
, 
size
, 
æags
, 
mid
, 
pc
);

427 
	`£tCÚ‹xt
(
cid
);

428 
	}
}

430 
	$Reque¡
(
asid
, 
Addr
 
vaddr
, 
size
, 
FÏgs
 
æags
, 
Ma¡”ID
 
mid
,

431 
Addr
 
pc
, 
CÚ‹xtID
 
cid
, 
AtomicOpFunùÜ
 *
©omic_İ
)

432 : 
	$©omicOpFunùÜ
(
©omic_İ
)

434 
	`£tVœt
(
asid
, 
vaddr
, 
size
, 
æags
, 
mid
, 
pc
);

435 
	`£tCÚ‹xt
(
cid
);

436 
	}
}

438 ~
	$Reque¡
()

440 ià(
	`hasAtomicOpFunùÜ
()) {

441 
d–‘e
 
©omicOpFunùÜ
;

443 
	}
}

449 
	$£tCÚ‹xt
(
CÚ‹xtID
 
cÚ‹xt_id
)

451 
_cÚ‹xtId
 = 
cÚ‹xt_id
;

452 
´iv©eFÏgs
.
	`£t
(
VALID_CONTEXT_ID
);

453 
	}
}

460 
	$£tVœt
(
asid
, 
Addr
 
vaddr
, 
size
, 
FÏgs
 
æags
, 
Ma¡”ID
 
mid
,

461 
Addr
 
pc
)

463 
_asid
 = 
asid
;

464 
_vaddr
 = 
vaddr
;

465 
_size
 = 
size
;

466 
_ma¡”Id
 = 
mid
;

467 
_pc
 = 
pc
;

468 
_time
 = 
	`curTick
();

470 
_æags
.
	`ş—r
(~
STICKY_FLAGS
);

471 
_æags
.
	`£t
(
æags
);

472 
´iv©eFÏgs
.
	`ş—r
(~
STICKY_PRIVATE_FLAGS
);

473 
´iv©eFÏgs
.
	`£t
(
VALID_VADDR
|
VALID_SIZE
|
VALID_PC
);

474 
d•th
 = 0;

475 
acûssD–
 = 0;

476 
Œª¦©eD–
 = 0;

477 
	}
}

487 
	$£tPaddr
(
Addr
 
·ddr
)

489 
_·ddr
 = 
·ddr
;

490 
´iv©eFÏgs
.
	`£t
(
VALID_PADDR
);

491 
	}
}

497 
	$¥l™OnVaddr
(
Addr
 
¥l™_addr
, 
Reque¡PŒ
 &
»q1
, Reque¡PŒ &
»q2
)

499 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_VADDR
));

500 
	`as£¹
(
´iv©eFÏgs
.
	`nÚeS‘
(
VALID_PADDR
));

501 
	`as£¹
(
¥l™_addr
 > 
_vaddr
 && s¶™_add¸< _vadd¸+ 
_size
);

502 
»q1
 = 
Ãw
 
	`Reque¡
(*
this
);

503 
»q2
 = 
Ãw
 
	`Reque¡
(*
this
);

504 
»q1
->
_size
 = 
¥l™_addr
 - 
_vaddr
;

505 
»q2
->
_vaddr
 = 
¥l™_addr
;

506 
»q2
->
_size
 = _siz- 
»q1
->_size;

507 
	}
}

512 
boŞ


513 
	$hasPaddr
() const

515  
´iv©eFÏgs
.
	`isS‘
(
VALID_PADDR
);

516 
	}
}

518 
Addr


519 
	$g‘Paddr
() const

521 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_PADDR
));

522  
_·ddr
;

523 
	}
}

528 
Tick
 
	gŒª¦©eD–
;

534 
Tick
 
	gacûssD–
;

540 
mubË
 
	gd•th
;

545 
boŞ


546 
	$hasSize
() const

548  
´iv©eFÏgs
.
	`isS‘
(
VALID_SIZE
);

549 
	}
}

552 
	$g‘Size
() const

554 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_SIZE
));

555  
_size
;

556 
	}
}

559 
Tick


560 
	$time
() const

562 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_PADDR
|
VALID_VADDR
));

563  
_time
;

564 
	}
}

569 
boŞ


570 
	$hasAtomicOpFunùÜ
()

572  
©omicOpFunùÜ
 !ğ
NULL
;

573 
	}
}

575 
AtomicOpFunùÜ
 *

576 
	$g‘AtomicOpFunùÜ
()

578 
	`as£¹
(
©omicOpFunùÜ
 !ğ
NULL
);

579  
©omicOpFunùÜ
;

580 
	}
}

583 
FÏgs


584 
	$g‘FÏgs
()

586 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_PADDR
|
VALID_VADDR
));

587  
_æags
;

588 
	}
}

595 
	$£tFÏgs
(
FÏgs
 
æags
)

597 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_PADDR
|
VALID_VADDR
));

598 
_æags
.
	`£t
(
æags
);

599 
	}
}

602 
	$£tMemS·ûCÚfigFÏgs
(
MemS·ûCÚfigFÏgs
 
exŒaFÏgs
)

604 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_PADDR
 | 
VALID_VADDR
));

605 
_memS·ûCÚfigFÏgs
.
	`£t
(
exŒaFÏgs
);

606 
	}
}

609 
boŞ


610 
	$hasVaddr
() const

612  
´iv©eFÏgs
.
	`isS‘
(
VALID_VADDR
);

613 
	}
}

615 
Addr


616 
	$g‘Vaddr
() const

618 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_VADDR
));

619  
_vaddr
;

620 
	}
}

623 
Ma¡”ID


624 
	$ma¡”Id
() const

626  
_ma¡”Id
;

627 
	}
}

629 
ušt32_t


630 
	$skId
() const

632  
_skId
;

633 
	}
}

636 
	$skId
(
ušt32_t
 
id
) {

637 
_skId
 = 
id
;

638 
	}
}

642 
	$g‘Asid
() const

644 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_VADDR
));

645  
_asid
;

646 
	}
}

650 
	$£tAsid
(
asid
)

652 
_asid
 = 
asid
;

653 
	}
}

656 
ArchFÏgsTy³


657 
	$g‘ArchFÏgs
() const

659 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_PADDR
|
VALID_VADDR
));

660  
_æags
 & 
ARCH_BITS
;

661 
	}
}

664 
boŞ


665 
	$exŒaD©aV®id
() const

667  
´iv©eFÏgs
.
	`isS‘
(
VALID_EXTRA_DATA
);

668 
	}
}

671 
ušt64_t


672 
	$g‘ExŒaD©a
() const

674 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_EXTRA_DATA
));

675  
_exŒaD©a
;

676 
	}
}

680 
	$£tExŒaD©a
(
ušt64_t
 
exŒaD©a
)

682 
_exŒaD©a
 = 
exŒaD©a
;

683 
´iv©eFÏgs
.
	`£t
(
VALID_EXTRA_DATA
);

684 
	}
}

686 
boŞ


687 
	$hasCÚ‹xtId
() const

689  
´iv©eFÏgs
.
	`isS‘
(
VALID_CONTEXT_ID
);

690 
	}
}

693 
CÚ‹xtID


694 
	$cÚ‹xtId
() const

696 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_CONTEXT_ID
));

697  
_cÚ‹xtId
;

698 
	}
}

701 
	$£tPC
(
Addr
 
pc
)

703 
´iv©eFÏgs
.
	`£t
(
VALID_PC
);

704 
_pc
 = 
pc
;

705 
	}
}

707 
boŞ


708 
	$hasPC
() const

710  
´iv©eFÏgs
.
	`isS‘
(
VALID_PC
);

711 
	}
}

714 
Addr


715 
	$g‘PC
() const

717 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_PC
));

718  
_pc
;

719 
	}
}

725 
	$šcAcûssD•th
(ècÚ¡ { 
d•th
++; 
	}
}

726 
	$g‘AcûssD•th
(ècÚ¡ {  
d•th
; 
	}
}

731 
	$£tT¿n¦©eL©’cy
(è{ 
Œª¦©eD–
 = 
	`curTick
(è- 
_time
; 
	}
}

732 
Tick
 
	$g‘T¿n¦©eL©’cy
(ècÚ¡ {  
Œª¦©eD–
; 
	}
}

738 
	$£tAcûssL©’cy
(è{ 
acûssD–
 = 
	`curTick
(è- 
_time
 - 
Œª¦©eD–
; 
	}
}

739 
Tick
 
	$g‘AcûssL©’cy
(ècÚ¡ {  
acûssD–
; 
	}
}

745 
boŞ


746 
	$hasIn¡SeqNum
() const

748  
´iv©eFÏgs
.
	`isS‘
(
VALID_INST_SEQ_NUM
);

749 
	}
}

751 
In¡SeqNum


752 
	$g‘ReqIn¡SeqNum
() const

754 
	`as£¹
(
´iv©eFÏgs
.
	`isS‘
(
VALID_INST_SEQ_NUM
));

755  
_»qIn¡SeqNum
;

756 
	}
}

759 
	$£tReqIn¡SeqNum
(cÚ¡ 
In¡SeqNum
 
£q_num
)

761 
´iv©eFÏgs
.
	`£t
(
VALID_INST_SEQ_NUM
);

762 
_»qIn¡SeqNum
 = 
£q_num
;

763 
	}
}

767 
boŞ
 
	$isUnÿch—bË
(ècÚ¡ {  
_æags
.
	`isS‘
(
UNCACHEABLE
); 
	}
}

768 
boŞ
 
	$isSŒiùlyOrd”ed
(ècÚ¡ {  
_æags
.
	`isS‘
(
STRICT_ORDER
); 
	}
}

769 
boŞ
 
	$isIn¡F‘ch
(ècÚ¡ {  
_æags
.
	`isS‘
(
INST_FETCH
); 
	}
}

770 
boŞ
 
	$isP»ãtch
(ècÚ¡ {  
_æags
.
	`isS‘
(
PREFETCH
); 
	}
}

771 
boŞ
 
	$isLLSC
(ècÚ¡ {  
_æags
.
	`isS‘
(
LLSC
); 
	}
}

772 
boŞ
 
	$isPriv
(ècÚ¡ {  
_æags
.
	`isS‘
(
PRIVILEGED
); 
	}
}

773 
boŞ
 
	$isLockedRMW
(ècÚ¡ {  
_æags
.
	`isS‘
(
LOCKED_RMW
); 
	}
}

774 
boŞ
 
	$isSw­
(ècÚ¡ {  
_æags
.
	`isS‘
(
MEM_SWAP
|
MEM_SWAP_COND
); 
	}
}

775 
boŞ
 
	$isCÚdSw­
(ècÚ¡ {  
_æags
.
	`isS‘
(
MEM_SWAP_COND
); 
	}
}

776 
boŞ
 
	$isMm­³dI´
(ècÚ¡ {  
_æags
.
	`isS‘
(
MMAPPED_IPR
); 
	}
}

777 
boŞ
 
	$isSecu»
(ècÚ¡ {  
_æags
.
	`isS‘
(
SECURE
); 
	}
}

778 
boŞ
 
	$isPTW®k
(ècÚ¡ {  
_æags
.
	`isS‘
(
PT_WALK
); 
	}
}

779 
boŞ
 
	$isAcquœe
(ècÚ¡ {  
_æags
.
	`isS‘
(
ACQUIRE
); 
	}
}

780 
boŞ
 
	$isR–—£
(ècÚ¡ {  
_æags
.
	`isS‘
(
RELEASE
); 
	}
}

781 
boŞ
 
	$isK”Ãl
(ècÚ¡ {  
_æags
.
	`isS‘
(
KERNEL
); 
	}
}

782 
boŞ
 
	$isAtomicR‘uº
(ècÚ¡ {  
_æags
.
	`isS‘
(
ATOMIC_RETURN_OP
); 
	}
}

783 
boŞ
 
	$isAtomicNoR‘uº
(ècÚ¡ {  
_æags
.
	`isS‘
(
ATOMIC_NO_RETURN_OP
); 
	}
}

785 
boŞ


786 
	$isAtomic
() const

788  
_æags
.
	`isS‘
(
ATOMIC_RETURN_OP
) ||

789 
_æags
.
	`isS‘
(
ATOMIC_NO_RETURN_OP
);

790 
	}
}

798 
boŞ
 
	$isScİed
(ècÚ¡ {  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
SCOPE_VALID
); 
	}
}

800 
boŞ


801 
	$isWaveäÚtScİe
() const

803 
	`as£¹
(
	`isScİed
());

804  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
WAVEFRONT_SCOPE
);

805 
	}
}

807 
boŞ


808 
	$isWÜkgroupScİe
() const

810 
	`as£¹
(
	`isScİed
());

811  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
WORKGROUP_SCOPE
);

812 
	}
}

814 
boŞ


815 
	$isDeviûScİe
() const

817 
	`as£¹
(
	`isScİed
());

818  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
DEVICE_SCOPE
);

819 
	}
}

821 
boŞ


822 
	$isSy¡emScİe
() const

824 
	`as£¹
(
	`isScİed
());

825  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
SYSTEM_SCOPE
);

826 
	}
}

828 
boŞ


829 
	$isGlob®Segm’t
() const

831  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
GLOBAL_SEGMENT
) ||

832 (!
	`isGroupSegm’t
(è&& !
	`isPriv©eSegm’t
() &&

833 !
	`isK”ÇrgSegm’t
(è&& !
	`isR—dÚlySegm’t
() &&

834 !
	`isSplSegm’t
(è&& !
	`isArgSegm’t
());

835 
	}
}

837 
boŞ


838 
	$isGroupSegm’t
() const

840  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
GROUP_SEGMENT
);

841 
	}
}

843 
boŞ


844 
	$isPriv©eSegm’t
() const

846  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
PRIVATE_SEGMENT
);

847 
	}
}

849 
boŞ


850 
	$isK”ÇrgSegm’t
() const

852  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
KERNARG_SEGMENT
);

853 
	}
}

855 
boŞ


856 
	$isR—dÚlySegm’t
() const

858  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
READONLY_SEGMENT
);

859 
	}
}

861 
boŞ


862 
	$isSplSegm’t
() const

864  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
SPILL_SEGMENT
);

865 
	}
}

867 
boŞ


868 
	$isArgSegm’t
() const

870  
_memS·ûCÚfigFÏgs
.
	`isS‘
(
ARG_SEGMENT
);

871 
	}
}

	@ruby/common/Address.cc

29 
	~"mem/ruby/commÚ/Add»ss.hh
"

31 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

33 
Addr


34 
	$b™S–eù
(
Addr
 
addr
, 
sm®l
, 
big
)

36 
	`as£¹
(
big
 >ğ
sm®l
);

38 ià(
big
 >ğ
ADDRESS_WIDTH
 - 1) {

39  (
addr
 >> 
sm®l
);

41 
Addr
 
mask
 = ~((Addr)~0 << (
big
 + 1));

43 
Addr
 
·¹Ÿl
 = (
addr
 & 
mask
);

44  (
·¹Ÿl
 >> 
sm®l
);

46 
	}
}

48 
Addr


49 
	$b™Remove
(
Addr
 
addr
, 
sm®l
, 
big
)

51 
	`as£¹
(
big
 >ğ
sm®l
);

53 ià(
sm®l
 >ğ
ADDRESS_WIDTH
 - 1) {

54  
addr
;

55 } ià(
big
 >ğ
ADDRESS_WIDTH
 - 1) {

56 
Addr
 
mask
 = (Addr)~0 >> 
sm®l
;

57  (
addr
 & 
mask
);

58 } ià(
sm®l
 == 0) {

59 
Addr
 
mask
 = (Addr)~0 << 
big
;

60  (
addr
 & 
mask
);

62 
Addr
 
mask
 = ~((Addr)~0 << 
sm®l
);

63 
Addr
 
low”_b™s
 = 
addr
 & 
mask
;

64 
mask
 = (
Addr
)~0 << (
big
 + 1);

65 
Addr
 
high”_b™s
 = 
addr
 & 
mask
;

68 
high”_b™s
 = high”_b™ >> (
big
 - 
sm®l
 + 1);

69  (
high”_b™s
 | 
low”_b™s
);

71 
	}
}

73 
Addr


74 
	$maskLowOrd”B™s
(
Addr
 
addr
, 
numb”
)

76 
Addr
 
mask
;

78 ià(
numb”
 >ğ
ADDRESS_WIDTH
 - 1) {

79 
mask
 = ~0;

81 
mask
 = (
Addr
)~0 << 
numb”
;

83  (
addr
 & 
mask
);

84 
	}
}

86 
Addr


87 
	$maskHighOrd”B™s
(
Addr
 
addr
, 
numb”
)

89 
Addr
 
mask
;

91 ià(
numb”
 >ğ
ADDRESS_WIDTH
 - 1) {

92 
mask
 = ~0;

94 
mask
 = (
Addr
)~0 >> 
numb”
;

96  (
addr
 & 
mask
);

97 
	}
}

99 
Addr


100 
	$shiáLowOrd”B™s
(
Addr
 
addr
, 
numb”
)

102  (
addr
 >> 
numb”
);

103 
	}
}

105 
Addr


106 
	$g‘Off£t
(
Addr
 
addr
)

108  
	`b™S–eù
(
addr
, 0, 
RubySy¡em
::
	`g‘BlockSizeB™s
() - 1);

109 
	}
}

111 
Addr


112 
	$makeLšeAdd»ss
(
Addr
 
addr
)

114  
	`maskLowOrd”B™s
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeB™s
());

115 
	}
}

118 
Addr


119 
	$makeNextSŒideAdd»ss
(
Addr
 
addr
, 
¡ride
)

121  
	`maskLowOrd”B™s
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeB™s
())

122 + 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(è* 
¡ride
;

123 
	}
}

125 
	g¡d
::
¡ršg


126 
	$´štAdd»ss
(
Addr
 
addr
)

128 
¡d
::
¡ršg¡»am
 
out
;

129 
out
 << "[" << 
¡d
::
hex
 << "0x" << 
addr
 << "," << "†ine 0x"

130 << 
	`maskLowOrd”B™s
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeB™s
())

131 << 
¡d
::
dec
 << "]";

132  
out
.
	`¡r
();

133 
	}
}

	@ruby/common/Address.hh

29 #iâdeà
__MEM_RUBY_COMMON_ADDRESS_HH__


30 
	#__MEM_RUBY_COMMON_ADDRESS_HH__


	)

32 
	~<ÿs£¹
>

33 
	~<iomª
>

34 
	~<io¡»am
>

36 
	~"ba£/ty³s.hh
"

38 cÚ¡ 
ušt32_t
 
	gADDRESS_WIDTH
 = 64;

41 
Addr
 
b™S–eù
(Add¸
addr
, 
sm®l
, 
big
);

42 
Addr
 
b™Remove
(Add¸
addr
, 
sm®l
, 
big
);

43 
Addr
 
maskLowOrd”B™s
(Add¸
addr
, 
numb”
);

44 
Addr
 
maskHighOrd”B™s
(Add¸
addr
, 
numb”
);

45 
Addr
 
shiáLowOrd”B™s
(Add¸
addr
, 
numb”
);

46 
Addr
 
g‘Off£t
(Add¸
addr
);

47 
Addr
 
makeLšeAdd»ss
(Add¸
addr
);

48 
Addr
 
makeNextSŒideAdd»ss
(Add¸
addr
, 
¡ride
);

49 
	g¡d
::
¡ršg
 
´štAdd»ss
(
Addr
 
addr
);

	@ruby/common/BoolVec.cc

40 
	~"mem/ruby/commÚ/BoŞVec.hh
"

42 
	~<io¡»am
>

43 
	~<veùÜ
>

45 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gBoŞVec
& 
	gmyveùÜ
) {

46 cÚ¡‡uto& 
	g™
: 
myveùÜ
) {

47 
os
 << " " << 
™
;

49  
	gos
;

	@ruby/common/BoolVec.hh

40 
	~<o¡»am
>

41 
	~<veùÜ
>

43 
	g¡d
::
	tveùÜ
<
	tboŞ
> 
	tBoŞVec
;

45 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ std::
veùÜ
<
boŞ
>& 
myveùÜ
);

	@ruby/common/Consumer.cc

29 
	~"mem/ruby/commÚ/CÚsum”.hh
"

31 
usšg
 
Çme¥aû
 
	g¡d
;

34 
	gCÚsum”
::
	$scheduËEv’t
(
Cyşes
 
timeD–
)

36 
	`scheduËEv’tAbsŞu‹
(
em
->
	`şockEdge
(
timeD–
));

37 
	}
}

40 
	gCÚsum”
::
	$scheduËEv’tAbsŞu‹
(
Tick
 
evt_time
)

42 ià(!
	`®»adyScheduËd
(
evt_time
)) {

44 
CÚsum”Ev’t
 *
evt
 = 
Ãw
 
	`CÚsum”Ev’t
(
this
);

45 
em
->
	`scheduË
(
evt
, 
evt_time
);

46 
	`š£¹ScheduËdWakeupTime
(
evt_time
);

49 
Tick
 
t
 = 
em
->
	`şockEdge
();

50 
£t
<
Tick
>::
™”©Ü
 
b™
 = 
m_scheduËd_wakeups
.
	`begš
();

51 
£t
<
Tick
>::
™”©Ü
 
e™
 = 
m_scheduËd_wakeups
.
	`low”_bound
(
t
);

52 
m_scheduËd_wakeups
.
	`”a£
(
b™
,
e™
);

53 
	}
}

	@ruby/common/Consumer.hh

35 #iâdeà
__MEM_RUBY_COMMON_CONSUMER_HH__


36 
	#__MEM_RUBY_COMMON_CONSUMER_HH__


	)

38 
	~<io¡»am
>

39 
	~<£t
>

41 
	~"sim/şocked_objeù.hh
"

43 şas 
	cCÚsum”


45 
	mpublic
:

46 
	$CÚsum”
(
ClockedObjeù
 *
_em
)

47 : 
	$em
(
_em
)

51 
vœtu®


52 ~
	$CÚsum”
()

53 { 
	}
}

55 
vœtu®
 
wakeup
() = 0;

56 
vœtu®
 
	$´št
(
¡d
::
o¡»am
& 
out
) const = 0;

57 
vœtu®
 
	$¡ÜeEv’tInfo
(
šfo
è{
	}
}

59 
boŞ


60 
	$®»adyScheduËd
(
Tick
 
time
)

62  
m_scheduËd_wakeups
.
	`fšd
(
time
è!ğm_scheduËd_wakeups.
	`’d
();

63 
	}
}

66 
	$š£¹ScheduËdWakeupTime
(
Tick
 
time
)

68 
m_scheduËd_wakeups
.
	`š£¹
(
time
);

69 
	}
}

71 
scheduËEv’tAbsŞu‹
(
Tick
 
timeAbs
);

73 
	g´Ùeùed
:

74 
scheduËEv’t
(
Cyşes
 
timeD–
);

76 
	g´iv©e
:

77 
¡d
::
£t
<
Tick
> 
m_scheduËd_wakeups
;

78 
ClockedObjeù
 *
	gem
;

80 şas 
	cCÚsum”Ev’t
 : 
public
 
Ev’t


82 
public
:

83 
CÚsum”Ev’t
(
CÚsum”
* 
_cÚsum”
)

84 : 
Ev’t
(
DeçuÉ_Pri
, 
AutoD–‘e
), 
m_cÚsum”_±r
(
_cÚsum”
)

88 
´oûss
(è{ 
	gm_cÚsum”_±r
->
wakeup
(); }

90 
	g´iv©e
:

91 
CÚsum”
* 
m_cÚsum”_±r
;

95 
šlše
 
	g¡d
::
o¡»am
&

96 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gCÚsum”
& 
	gobj
)

98 
	gobj
.
´št
(
out
);

99 
	gout
 << 
	g¡d
::
æush
;

100  
	gout
;

	@ruby/common/DataBlock.cc

29 
	~"mem/ruby/commÚ/D©aBlock.hh
"

31 
	~"mem/ruby/commÚ/Wr™eMask.hh
"

32 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

34 
	gD©aBlock
::
	$D©aBlock
(cÚ¡ 
D©aBlock
 &
ı
)

36 
m_d©a
 = 
Ãw
 
ušt8_t
[
RubySy¡em
::
	`g‘BlockSizeBy‹s
()];

37 
	`memıy
(
m_d©a
, 
ı
.m_d©a, 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

38 
m_®loc
 = 
Œue
;

39 
	}
}

42 
	gD©aBlock
::
	$®loc
()

44 
m_d©a
 = 
Ãw
 
ušt8_t
[
RubySy¡em
::
	`g‘BlockSizeBy‹s
()];

45 
m_®loc
 = 
Œue
;

46 
	`ş—r
();

47 
	}
}

50 
	gD©aBlock
::
	$ş—r
()

52 
	`mem£t
(
m_d©a
, 0, 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

53 
	}
}

55 
boŞ


56 
	gD©aBlock
::
	$equ®
(cÚ¡ 
D©aBlock
& 
obj
) const

58  !
	`memcmp
(
m_d©a
, 
obj
.m_d©a, 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

59 
	}
}

62 
	gD©aBlock
::
	$cİyP¬tŸl
(cÚ¡ 
D©aBlock
 &
dblk
, cÚ¡ 
Wr™eMask
 &
mask
)

64 
i
 = 0; i < 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(); i++) {

65 ià(
mask
.
	`g‘Mask
(
i
, 1)) {

66 
m_d©a
[
i
] = 
dblk
.m_data[i];

69 
	}
}

72 
	gD©aBlock
::
	$©omicP¬tŸl
(cÚ¡ 
D©aBlock
 &
dblk
, cÚ¡ 
Wr™eMask
 &
mask
)

74 
i
 = 0; i < 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(); i++) {

75 
m_d©a
[
i
] = 
dblk
.m_data[i];

77 
mask
.
	`³rfÜmAtomic
(
m_d©a
);

78 
	}
}

81 
	gD©aBlock
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

83 
usšg
 
Çme¥aû
 
¡d
;

85 
size
 = 
RubySy¡em
::
	`g‘BlockSizeBy‹s
();

86 
out
 << "[ ";

87 
i
 = 0; i < 
size
; i++) {

88 
out
 << 
	`£tw
(2è<< 
	`£tfl
('0'è<< 
hex
 << "0x" << ()
m_d©a
[
i
] << " ";

89 
out
 << 
	`£tfl
(' ');

91 
out
 << 
dec
 << "]" << 
æush
;

92 
	}
}

94 cÚ¡ 
ušt8_t
*

95 
	gD©aBlock
::
	$g‘D©a
(
off£t
, 
Ën
) const

97 
	`as£¹
(
off£t
 + 
Ën
 <ğ
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

98  &
m_d©a
[
off£t
];

99 
	}
}

101 
ušt8_t
*

102 
	gD©aBlock
::
	$g‘D©aMod
(
off£t
)

104  &
m_d©a
[
off£t
];

105 
	}
}

108 
	gD©aBlock
::
	$£tD©a
(cÚ¡ 
ušt8_t
 *
d©a
, 
off£t
, 
Ën
)

110 
	`as£¹
(
off£t
 + 
Ën
 <ğ
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

111 
	`memıy
(&
m_d©a
[
off£t
], 
d©a
, 
Ën
);

112 
	}
}

114 
	gD©aBlock
 &

115 
	gD©aBlock
::
İ”©Ü
=(cÚ¡ 
D©aBlock
 & 
obj
)

117 
memıy
(
m_d©a
, 
obj
.m_d©a, 
RubySy¡em
::
g‘BlockSizeBy‹s
());

118  *
	gthis
;

	@ruby/common/DataBlock.hh

29 #iâdeà
__MEM_RUBY_COMMON_DATABLOCK_HH__


30 
	#__MEM_RUBY_COMMON_DATABLOCK_HH__


	)

32 
	~<š‰y³s.h
>

34 
	~<ÿs£¹
>

35 
	~<iomª
>

36 
	~<io¡»am
>

38 
şass
 
	gWr™eMask
;

40 şas 
	cD©aBlock


42 
	mpublic
:

43 
	$D©aBlock
()

45 
	`®loc
();

48 
	`D©aBlock
(cÚ¡ 
D©aBlock
 &
ı
);

50 ~
	$D©aBlock
()

52 ià(
m_®loc
)

53 
d–‘e
 [] 
m_d©a
;

54 
	}
}

56 
	gD©aBlock
& 
	gİ”©Ü
=(cÚ¡ 
D©aBlock
& 
obj
);

58 
assign
(
ušt8_t
 *
d©a
);

60 
ş—r
();

61 
ušt8_t
 
	$g‘By‹
(
whichBy‹
) const;

62 cÚ¡ 
ušt8_t
 *
	$g‘D©a
(
off£t
, 
Ën
) const;

63 
ušt8_t
 *
	`g‘D©aMod
(
off£t
);

64 
	`£tBy‹
(
whichBy‹
, 
ušt8_t
 
d©a
);

65 
	`£tD©a
(cÚ¡ 
ušt8_t
 *
d©a
, 
off£t
, 
Ën
);

66 
	`cİyP¬tŸl
(cÚ¡ 
D©aBlock
 &
dblk
, 
off£t
, 
Ën
);

67 
	`cİyP¬tŸl
(cÚ¡ 
D©aBlock
 &
dblk
, cÚ¡ 
Wr™eMask
 &
mask
);

68 
	`©omicP¬tŸl
(cÚ¡ 
D©aBlock
 & 
dblk
, cÚ¡ 
Wr™eMask
 & 
mask
);

69 
boŞ
 
	$equ®
(cÚ¡ 
D©aBlock
& 
obj
) const;

70 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

72 
´iv©e
:

73 
	`®loc
();

74 
ušt8_t
 *
m_d©a
;

75 
boŞ
 
m_®loc
;

76 
	}
};

78 
šlše
 

79 
	gD©aBlock
::
	$assign
(
ušt8_t
 *
d©a
)

81 
	`as£¹
(
d©a
 !ğ
NULL
);

82 ià(
m_®loc
) {

83 
d–‘e
 [] 
m_d©a
;

85 
m_d©a
 = 
d©a
;

86 
m_®loc
 = 
çl£
;

87 
	}
}

89 
šlše
 
ušt8_t


90 
	gD©aBlock
::
	$g‘By‹
(
whichBy‹
) const

92  
m_d©a
[
whichBy‹
];

93 
	}
}

95 
šlše
 

96 
	gD©aBlock
::
	$£tBy‹
(
whichBy‹
, 
ušt8_t
 
d©a
)

98 
m_d©a
[
whichBy‹
] = 
d©a
;

99 
	}
}

101 
šlše
 

102 
	gD©aBlock
::
	$cİyP¬tŸl
(cÚ¡ 
D©aBlock
 & 
dblk
, 
off£t
, 
Ën
)

104 
	`£tD©a
(&
dblk
.
m_d©a
[
off£t
], off£t, 
Ën
);

105 
	}
}

107 
šlše
 
	g¡d
::
o¡»am
&

108 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gD©aBlock
& 
	gobj
)

110 
	gobj
.
´št
(
out
);

111 
	gout
 << 
	g¡d
::
æush
;

112  
	gout
;

115 
šlše
 
boŞ


116 
	gİ”©Ü
==(cÚ¡ 
D©aBlock
& 
obj1
,cÚ¡ 
	gD©aBlock
& 
	gobj2
)

118  
	gobj1
.
equ®
(
obj2
);

	@ruby/common/Histogram.cc

29 
	~<cm©h
>

30 
	~<iomª
>

32 
	~"ba£/štm©h.hh
"

33 
	~"mem/ruby/commÚ/Hi¡og¿m.hh
"

35 
usšg
 
Çme¥aû
 
	g¡d
;

37 
	gHi¡og¿m
::
	$Hi¡og¿m
(
bšsize
, 
ušt32_t
 
bšs
)

39 
m_bšsize
 = 
bšsize
;

40 
	`ş—r
(
bšs
);

41 
	}
}

43 
	gHi¡og¿m
::~
	$Hi¡og¿m
()

45 
	}
}

48 
Hi¡og¿m
::
	$ş—r
(
bšsize
, 
ušt32_t
 
bšs
)

50 
m_bšsize
 = 
bšsize
;

51 
	`ş—r
(
bšs
);

52 
	}
}

55 
	gHi¡og¿m
::
	$ş—r
(
ušt32_t
 
bšs
)

57 
m_Ïrge¡_bš
 = 0;

58 
m_max
 = 0;

59 
m_d©a
.
	`»size
(
bšs
);

60 
ušt32_t
 
i
 = 0; i < 
bšs
; i++) {

61 
m_d©a
[
i
] = 0;

64 
m_couÁ
 = 0;

65 
m_max
 = 0;

66 
m_sumSam¶es
 = 0;

67 
m_sumSqu¬edSam¶es
 = 0;

68 
	}
}

71 
	gHi¡og¿m
::
	$doubËBšSize
()

73 
	`as£¹
(
m_bšsize
 != -1);

74 
ušt32_t
 
t_bšs
 = 
m_d©a
.
	`size
();

76 
ušt32_t
 
i
 = 0; i < 
t_bšs
/2; i++) {

77 
m_d©a
[
i
] = m_data[i*2] + m_data[i*2 + 1];

79 
ušt32_t
 
i
 = 
t_bšs
/2; i <_bins; i++) {

80 
m_d©a
[
i
] = 0;

83 
m_bšsize
 *= 2;

84 
	}
}

87 
	gHi¡og¿m
::
	$add
(
št64_t
 
v®ue
)

89 
	`as£¹
(
v®ue
 >= 0);

90 
m_max
 = 
	`max
(m_max, 
v®ue
);

91 
m_couÁ
++;

93 
m_sumSam¶es
 +ğ
v®ue
;

94 
m_sumSqu¬edSam¶es
 +ğ(
v®ue
*value);

96 
ušt32_t
 
šdex
;

98 ià(
m_bšsize
 == -1) {

100 ià(
v®ue
 == 0) {

101 
šdex
 = 0;

103 
šdex
 = 
	`æoÜLog2
(
v®ue
) + 1;

104 ià(
šdex
 >ğ
m_d©a
.
	`size
()) {

105 
šdex
 = 
m_d©a
.
	`size
() - 1;

110 
ušt32_t
 
t_bšs
 = 
m_d©a
.
	`size
();

112 
m_max
 >ğ(
t_bšs
 * 
m_bšsize
)è
	`doubËBšSize
();

113 
šdex
 = 
v®ue
/
m_bšsize
;

116 
	`as£¹
(
šdex
 < 
m_d©a
.
	`size
());

117 
m_d©a
[
šdex
]++;

118 
m_Ïrge¡_bš
 = 
	`max
(m_Ïrge¡_bš, 
šdex
);

119 
	}
}

122 
	gHi¡og¿m
::
	$add
(
Hi¡og¿m
& 
hi¡
)

124 
ušt32_t
 
t_bšs
 = 
m_d©a
.
	`size
();

126 ià(
hi¡
.
	`g‘Bšs
(è!ğ
t_bšs
) {

127 ià(
m_couÁ
 == 0) {

128 
m_d©a
.
	`»size
(
hi¡
.
	`g‘Bšs
());

130 
	`çl
("Histograms with different‚umber of bins "

135 
m_max
 = 
	`max
(m_max, 
hi¡
.
	`g‘Max
());

136 
m_couÁ
 +ğ
hi¡
.
	`size
();

137 
m_sumSam¶es
 +ğ
hi¡
.
	`g‘TÙ®
();

138 
m_sumSqu¬edSam¶es
 +ğ
hi¡
.
	`g‘Squ¬edTÙ®
();

141 ià(
hi¡
.
	`g‘BšSize
(è=ğ-1 && 
m_bšsize
 == -1) {

142 
j
 = 0; j < 
hi¡
.
	`g‘D©a
(0); j++) {

143 
	`add
(0);

146 
ušt32_t
 
i
 = 1; i < 
t_bšs
; i++) {

147 
j
 = 0; j < 
hi¡
.
	`g‘D©a
(
i
); j++) {

148 
	`add
(1<<(
i
-1));

151 } ià(
hi¡
.
	`g‘BšSize
(è>ğ1 && 
m_bšsize
 >= 1) {

156 
m_bšsize
 > 
hi¡
.
	`g‘BšSize
()èhi¡.
	`doubËBšSize
();

157 
hi¡
.
	`g‘BšSize
(è> 
m_bšsize
è
	`doubËBšSize
();

159 
	`as£¹
(
m_bšsize
 =ğ
hi¡
.
	`g‘BšSize
());

161 
ušt32_t
 
i
 = 0; i < 
t_bšs
; i++) {

162 
m_d©a
[
i
] +ğ
hi¡
.
	`g‘D©a
(i);

164 ià(
m_d©a
[
i
] > 0è
m_Ïrge¡_bš
 = i;

167 
	`çl
("Don't know howo combine†og‡nd†inear histograms!");

169 
	}
}

175 
	gHi¡og¿m
::
	$g‘Snd¬dDevŸtiÚ
() const

177 ià(
m_couÁ
 <= 1)

180 
v¬Ÿnû
 =

181 ()(
m_sumSqu¬edSam¶es
 - 
m_sumSam¶es
 * m_sumSam¶e / 
m_couÁ
)

182 / (
m_couÁ
 - 1);

183  
	`sq¹
(
v¬Ÿnû
);

184 
	}
}

187 
	gHi¡og¿m
::
	$´št
(
o¡»am
& 
out
) const

189 
	`´štW™hMuÉl›r
(
out
, 1.0);

190 
	}
}

193 
	gHi¡og¿m
::
	$´štP”ûÁ
(
o¡»am
& 
out
) const

195 ià(
m_couÁ
 == 0) {

196 
	`´štW™hMuÉl›r
(
out
, 0.0);

198 
	`´štW™hMuÉl›r
(
out
, 100.0 / (
m_couÁ
));

200 
	}
}

203 
	gHi¡og¿m
::
	$´štW™hMuÉl›r
(
o¡»am
& 
out
, 
muÉl›r
) const

205 ià(
m_bšsize
 == -1) {

206 
out
 << "[binsize:†og2 ";

208 
out
 << "[bšsize: " << 
m_bšsize
 << " ";

210 
out
 << "max: " << 
m_max
 << " ";

211 
out
 << "couÁ: " << 
m_couÁ
 << " ";

213 ià(
m_couÁ
 == 0) {

214 
out
 << "average: NaN |";

215 
out
 << "standard deviation: NaN |";

217 
out
 << "av”age: " << 
	`£tw
(5è<< ((è
m_sumSam¶es
)/
m_couÁ


219 
out
 << "¡ªd¬d devŸtiÚ: " << 
	`g‘Snd¬dDevŸtiÚ
() << " |";

222 
ušt32_t
 
i
 = 0; i <ğ
m_Ïrge¡_bš
; i++) {

223 ià(
muÉl›r
 == 1.0) {

224 
out
 << " " << 
m_d©a
[
i
];

226 
out
 << " " << (
m_d©a
[
i
]è* 
muÉl›r
;

229 
out
 << " ]";

230 
	}
}

232 
boŞ


233 
	$node_Ëss_th’_eq
(cÚ¡ 
Hi¡og¿m
* 
n1
, cÚ¡ Hi¡og¿m* 
n2
)

235  (
n1
->
	`size
(è> 
n2
->size());

236 
	}
}

	@ruby/common/Histogram.hh

29 #iâdeà
__MEM_RUBY_COMMON_HISTOGRAM_HH__


30 
	#__MEM_RUBY_COMMON_HISTOGRAM_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

37 şas 
	cHi¡og¿m


39 
	mpublic
:

40 
Hi¡og¿m
(
bšsize
 = 1, 
ušt32_t
 
bšs
 = 50);

41 ~
Hi¡og¿m
();

43 
add
(
št64_t
 
v®ue
);

44 
add
(
Hi¡og¿m
& 
hi¡
);

45 
doubËBšSize
();

47 
	$ş—r
(è{ 
	`ş—r
(
m_d©a
.
	`size
()); }

48 
	`ş—r
(
ušt32_t
 
bšs
);

49 
	`ş—r
(
bšsize
, 
ušt32_t
 
bšs
);

51 
ušt64_t
 
	$size
(ècÚ¡ {  
m_couÁ
; 
	}
}

52 
ušt32_t
 
	$g‘Bšs
(ècÚ¡ {  
m_d©a
.
	`size
(); 
	}
}

53 
	$g‘BšSize
(ècÚ¡ {  
m_bšsize
; 
	}
}

54 
št64_t
 
	$g‘TÙ®
(ècÚ¡ {  
m_sumSam¶es
; 
	}
}

55 
ušt64_t
 
	$g‘Squ¬edTÙ®
(ècÚ¡ {  
m_sumSqu¬edSam¶es
; 
	}
}

56 
ušt64_t
 
	$g‘D©a
(
šdex
ècÚ¡ {  
m_d©a
[šdex]; 
	}
}

57 
št64_t
 
	$g‘Max
(ècÚ¡ {  
m_max
; 
	}
}

59 
	$´štW™hMuÉl›r
(
¡d
::
o¡»am
& 
out
, 
muÉl›r
) const;

60 
	$´štP”ûÁ
(
¡d
::
o¡»am
& 
out
) const;

61 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

63 
´iv©e
:

64 
¡d
::
veùÜ
<
ušt64_t
> 
m_d©a
;

65 
št64_t
 
m_max
;

66 
ušt64_t
 
m_couÁ
;

67 
m_bšsize
;

68 
ušt32_t
 
m_Ïrge¡_bš
;

70 
št64_t
 
m_sumSam¶es
;

71 
ušt64_t
 
m_sumSqu¬edSam¶es
;

73 
	$g‘Snd¬dDevŸtiÚ
() const;

74 
	}
};

76 
boŞ
 
node_Ëss_th’_eq
(cÚ¡ 
Hi¡og¿m
* 
n1
, cÚ¡ Hi¡og¿m* 
n2
);

78 
šlše
 
	g¡d
::
o¡»am
&

79 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gHi¡og¿m
& 
	gobj
)

81 
	gobj
.
´št
(
out
);

82 
	gout
 << 
	g¡d
::
æush
;

83  
	gout
;

	@ruby/common/IntVec.cc

36 
	~"mem/ruby/commÚ/IÁVec.hh
"

38 
	~<o¡»am
>

39 
	~<veùÜ
>

41 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ 
	gIÁVec
& 
	gmyveùÜ
) {

42 auto& 
	g™
 : 
myveùÜ
)

43 
os
 << " " << 
™
;

44  
	gos
;

	@ruby/common/IntVec.hh

36 
	~<o¡»am
>

37 
	~<veùÜ
>

39 
	g¡d
::
	tveùÜ
<> 
	tIÁVec
;

41 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
os
, cÚ¡ std::
veùÜ
<>& 
myveùÜ
);

	@ruby/common/MachineID.hh

29 #iâdeà
__MEM_RUBY_SYSTEM_MACHINEID_HH__


30 
	#__MEM_RUBY_SYSTEM_MACHINEID_HH__


	)

32 
	~<io¡»am
>

33 
	~<¡ršg
>

35 
	~"ba£/ırštf.hh
"

36 
	~"mem/´ÙocŞ/MachšeTy³.hh
"

38 
	sMachšeID


40 
MachšeTy³
 
	mty³
;

42 
NodeID
 
	mnum
;

44 
MachšeTy³
 
g‘Ty³
(ècÚ¡ {  
	mty³
; }

45 
NodeID
 
g‘Num
(ècÚ¡ {  
	mnum
; }

48 
šlše
 
	g¡d
::
¡ršg


49 
	$MachšeIDToSŒšg
(
MachšeID
 
machše
)

51  
	`c¥rštf
("%s_%d", 
	`MachšeTy³_to_¡ršg
(
machše
.
ty³
), machše.
num
);

52 
	}
}

54 
šlše
 
boŞ


55 
	gİ”©Ü
==(cÚ¡ 
MachšeID
 & 
obj1
, cÚ¡ 
	gMachšeID
 & 
	gobj2
)

57  (
	gobj1
.
	gty³
 =ğ
obj2
.
ty³
 && 
obj1
.
num
 == obj2.num);

60 
šlše
 
boŞ


61 
	gİ”©Ü
!=(cÚ¡ 
MachšeID
 & 
obj1
, cÚ¡ 
	gMachšeID
 & 
	gobj2
)

63  (
	gobj1
.
	gty³
 !ğ
obj2
.
ty³
 || 
obj1
.
num
 != obj2.num);

67 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gMachšeID
& 
	gobj
);

69 
šlše
 
	g¡d
::
o¡»am
&

70 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gMachšeID
& 
	gobj
)

72 ià((
	gobj
.
	gty³
 < 
	gMachšeTy³_NUM
è&& (obj.ty³ >ğ
MachšeTy³_FIRST
)) {

73 
out
 << 
MachšeTy³_to_¡ršg
(
obj
.
ty³
);

75 
	gout
 << "NULL";

77 
	gout
 << "-";

78 
	gout
 << 
	gobj
.
	gnum
;

79 
	gout
 << 
	g¡d
::
æush
;

80  
	gout
;

	@ruby/common/NetDest.cc

29 
	~<®gÜ™hm
>

31 
	~"mem/ruby/commÚ/N‘De¡.hh
"

33 
	gN‘De¡
::
	$N‘De¡
()

35 
	`»size
();

36 
	}
}

39 
	gN‘De¡
::
	$add
(
MachšeID
 
ÃwEËm’t
)

41 
	`as£¹
(
	`b™Index
(
ÃwEËm’t
.
num
è< 
m_b™s
[
	`vecIndex
ÒewEËm’t)].
	`g‘Size
());

42 
m_b™s
[
	`vecIndex
(
ÃwEËm’t
)].
	`add
(
	`b™Index
ÒewEËm’t.
num
));

43 
	}
}

46 
	gN‘De¡
::
	$addN‘De¡
(cÚ¡ 
N‘De¡
& 
ÃtDe¡
)

48 
	`as£¹
(
m_b™s
.
	`size
(è=ğ
ÃtDe¡
.
	`g‘Size
());

49 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

50 
m_b™s
[
i
].
	`addS‘
(
ÃtDe¡
.m_bits[i]);

52 
	}
}

55 
	gN‘De¡
::
	$£tN‘De¡
(
MachšeTy³
 
machše
, cÚ¡ 
S‘
& 
£t
)

58 
	`as£¹
(
	`MachšeTy³_ba£_Ëv–
((
MachšeTy³
)(
machše
 + 1)) -

59 
	`MachšeTy³_ba£_Ëv–
(
machše
) == 1);

60 
m_b™s
[
	`MachšeTy³_ba£_Ëv–
(
machše
)] = 
£t
;

61 
	}
}

64 
	gN‘De¡
::
	$»move
(
MachšeID
 
ŞdEËm’t
)

66 
m_b™s
[
	`vecIndex
(
ŞdEËm’t
)].
	`»move
(
	`b™Index
(ŞdEËm’t.
num
));

67 
	}
}

70 
	gN‘De¡
::
	$»moveN‘De¡
(cÚ¡ 
N‘De¡
& 
ÃtDe¡
)

72 
	`as£¹
(
m_b™s
.
	`size
(è=ğ
ÃtDe¡
.
	`g‘Size
());

73 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

74 
m_b™s
[
i
].
	`»moveS‘
(
ÃtDe¡
.m_bits[i]);

76 
	}
}

79 
	gN‘De¡
::
	$ş—r
()

81 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

82 
m_b™s
[
i
].
	`ş—r
();

84 
	}
}

87 
	gN‘De¡
::
	$brßdÿ¡
()

89 
MachšeTy³
 
machše
 = 
MachšeTy³_FIRST
;

90 
machše
 < 
MachšeTy³_NUM
; ++machine) {

91 
	`brßdÿ¡
(
machše
);

93 
	}
}

96 
	gN‘De¡
::
	$brßdÿ¡
(
MachšeTy³
 
machšeTy³
)

98 
NodeID
 
i
 = 0; i < 
	`MachšeTy³_ba£_couÁ
(
machšeTy³
); i++) {

99 
MachšeID
 
mach
 = {
machšeTy³
, 
i
};

100 
	`add
(
mach
);

102 
	}
}

105 
	g¡d
::
veùÜ
<
NodeID
>

106 
N‘De¡
::
	$g‘AÎDe¡
()

108 
¡d
::
veùÜ
<
NodeID
> 
de¡
;

109 
de¡
.
	`ş—r
();

110 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

111 
j
 = 0; j < 
m_b™s
[
i
].
	`g‘Size
(); j++) {

112 ià(
m_b™s
[
i
].
	`isEËm’t
(
j
)) {

113 
id
 = 
	`MachšeTy³_ba£_numb”
((
MachšeTy³
)
i
è+ 
j
;

114 
de¡
.
	`push_back
((
NodeID
)
id
);

118  
de¡
;

119 
	}
}

122 
	gN‘De¡
::
	$couÁ
() const

124 
couÁ”
 = 0;

125 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

126 
couÁ”
 +ğ
m_b™s
[
i
].
	`couÁ
();

128  
couÁ”
;

129 
	}
}

131 
NodeID


132 
	gN‘De¡
::
	$–em’tAt
(
MachšeID
 
šdex
)

134  
m_b™s
[
	`vecIndex
(
šdex
)].
	`–em’tAt
(
	`b™Index
(šdex.
num
));

135 
	}
}

137 
MachšeID


138 
	gN‘De¡
::
	$sm®Ë¡EËm’t
() const

140 
	`as£¹
(
	`couÁ
() > 0);

141 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

142 
NodeID
 
j
 = 0; j < 
m_b™s
[
i
].
	`g‘Size
(); j++) {

143 ià(
m_b™s
[
i
].
	`isEËm’t
(
j
)) {

144 
MachšeID
 
mach
 = {
	`MachšeTy³_äom_ba£_Ëv–
(
i
), 
j
};

145  
mach
;

149 
	`·nic
("No smallestƒlement of‡nƒmpty set.");

150 
	}
}

152 
MachšeID


153 
	gN‘De¡
::
	$sm®Ë¡EËm’t
(
MachšeTy³
 
machše
) const

155 
size
 = 
m_b™s
[
	`MachšeTy³_ba£_Ëv–
(
machše
)].
	`g‘Size
();

156 
NodeID
 
j
 = 0; j < 
size
; j++) {

157 ià(
m_b™s
[
	`MachšeTy³_ba£_Ëv–
(
machše
)].
	`isEËm’t
(
j
)) {

158 
MachšeID
 
mach
 = {
machše
, 
j
};

159  
mach
;

163 
	`·nic
("No smallestƒlement of given MachineType.");

164 
	}
}

167 
boŞ


168 
	gN‘De¡
::
	$isBrßdÿ¡
() const

170 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

171 ià(!
m_b™s
[
i
].
	`isBrßdÿ¡
()) {

172  
çl£
;

175  
Œue
;

176 
	}
}

179 
boŞ


180 
	gN‘De¡
::
	$isEm±y
() const

182 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

183 ià(!
m_b™s
[
i
].
	`isEm±y
()) {

184  
çl£
;

187  
Œue
;

188 
	}
}

191 
N‘De¡


192 
	gN‘De¡
::
	$OR
(cÚ¡ 
N‘De¡
& 
ÜN‘De¡
) const

194 
	`as£¹
(
m_b™s
.
	`size
(è=ğ
ÜN‘De¡
.
	`g‘Size
());

195 
N‘De¡
 
»suÉ
;

196 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

197 
»suÉ
.
m_b™s
[
i
] = m_b™s[i].
	`OR
(
ÜN‘De¡
.m_bits[i]);

199  
»suÉ
;

200 
	}
}

203 
N‘De¡


204 
	gN‘De¡
::
	$AND
(cÚ¡ 
N‘De¡
& 
ªdN‘De¡
) const

206 
	`as£¹
(
m_b™s
.
	`size
(è=ğ
ªdN‘De¡
.
	`g‘Size
());

207 
N‘De¡
 
»suÉ
;

208 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

209 
»suÉ
.
m_b™s
[
i
] = m_b™s[i].
	`AND
(
ªdN‘De¡
.m_bits[i]);

211  
»suÉ
;

212 
	}
}

215 
boŞ


216 
	gN‘De¡
::
	$š‹r£ùiÚIsNÙEm±y
(cÚ¡ 
N‘De¡
& 
Ùh”_ÃtDe¡
) const

218 
	`as£¹
(
m_b™s
.
	`size
(è=ğ
Ùh”_ÃtDe¡
.
	`g‘Size
());

219 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

220 ià(!
m_b™s
[
i
].
	`š‹r£ùiÚIsEm±y
(
Ùh”_ÃtDe¡
.m_bits[i])) {

221  
Œue
;

224  
çl£
;

225 
	}
}

227 
boŞ


228 
	gN‘De¡
::
	$isSu³r£t
(cÚ¡ 
N‘De¡
& 
‹¡
) const

230 
	`as£¹
(
m_b™s
.
	`size
(è=ğ
‹¡
.
	`g‘Size
());

232 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

233 ià(!
m_b™s
[
i
].
	`isSu³r£t
(
‹¡
.m_bits[i])) {

234  
çl£
;

237  
Œue
;

238 
	}
}

240 
boŞ


241 
	gN‘De¡
::
	$isEËm’t
(
MachšeID
 
–em’t
) const

243  ((
m_b™s
[
	`vecIndex
(
–em’t
)])).
	`isEËm’t
(
	`b™Index
ÓËm’t.
num
));

244 
	}
}

247 
	gN‘De¡
::
	$»size
()

249 
m_b™s
.
	`»size
(
	`MachšeTy³_ba£_Ëv–
(
MachšeTy³_NUM
));

250 
	`as£¹
(
m_b™s
.
	`size
(è=ğ
MachšeTy³_NUM
);

252 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

253 
m_b™s
[
i
].
	`£tSize
(
	`MachšeTy³_ba£_couÁ
((
MachšeTy³
)i));

255 
	}
}

258 
	gN‘De¡
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

260 
out
 << "[N‘De¡ (" << 
m_b™s
.
	`size
() << ") ";

262 
i
 = 0; i < 
m_b™s
.
	`size
(); i++) {

263 
j
 = 0; j < 
m_b™s
[
i
].
	`g‘Size
(); j++) {

264 
out
 << (
boŞ
è
m_b™s
[
i
].
	`isEËm’t
(
j
) << " ";

266 
out
 << " - ";

268 
out
 << "]";

269 
	}
}

271 
boŞ


272 
	gN‘De¡
::
	$isEqu®
(cÚ¡ 
N‘De¡
& 
n
) const

274 
	`as£¹
(
m_b™s
.
	`size
(è=ğ
n
.m_bits.size());

275 
i
 = 0; i < 
m_b™s
.
	`size
(); ++i) {

276 ià(!
m_b™s
[
i
].
	`isEqu®
(
n
.m_bits[i]))

277  
çl£
;

279  
Œue
;

280 
	}
}

	@ruby/common/NetDest.hh

29 #iâdeà
__MEM_RUBY_COMMON_NETDEST_HH__


30 
	#__MEM_RUBY_COMMON_NETDEST_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/S‘.hh
"

36 
	~"mem/ruby/commÚ/MachšeID.hh
"

39 şas 
	cN‘De¡


41 
	mpublic
:

44 
N‘De¡
();

45 
ex¶ic™
 
N‘De¡
(
b™_size
);

47 
	mN‘De¡
& 
	mİ”©Ü
=(cÚ¡ 
S‘
& 
obj
);

49 ~
	$N‘De¡
()

52 
	`add
(
MachšeID
 
ÃwEËm’t
);

53 
	`addN‘De¡
(cÚ¡ 
N‘De¡
& 
ÃtDe¡
);

54 
	`£tN‘De¡
(
MachšeTy³
 
machše
, cÚ¡ 
S‘
& 
£t
);

55 
	`»move
(
MachšeID
 
ŞdEËm’t
);

56 
	`»moveN‘De¡
(cÚ¡ 
N‘De¡
& 
ÃtDe¡
);

57 
	`ş—r
();

58 
	`brßdÿ¡
();

59 
	`brßdÿ¡
(
MachšeTy³
 
machše
);

60 
	$couÁ
() const;

61 
boŞ
 
	$isEqu®
(cÚ¡ 
N‘De¡
& 
ÃtDe¡
) const;

64 
N‘De¡
 
	$OR
(cÚ¡ 
N‘De¡
& 
ÜN‘De¡
) const;

67 
N‘De¡
 
	$AND
(cÚ¡ 
N‘De¡
& 
ªdN‘De¡
) const;

70 
boŞ
 
	$š‹r£ùiÚIsNÙEm±y
(cÚ¡ 
N‘De¡
& 
Ùh”_ÃtDe¡
) const;

73 
boŞ
 
	$š‹r£ùiÚIsEm±y
(cÚ¡ 
N‘De¡
& 
Ùh”_ÃtDe¡
) const;

75 
boŞ
 
	$isSu³r£t
(cÚ¡ 
N‘De¡
& 
‹¡
) const;

76 
boŞ
 
	$isSub£t
(cÚ¡ 
N‘De¡
& 
‹¡
ècÚ¡ { e¡.
	`isSu³r£t
(*
this
); 
	}
}

77 
boŞ
 
	$isEËm’t
(
MachšeID
 
–em’t
) const;

78 
boŞ
 
	$isBrßdÿ¡
() const;

79 
boŞ
 
	$isEm±y
() const;

82 
¡d
::
veùÜ
<
NodeID
> 
	`g‘AÎDe¡
();

84 
MachšeID
 
	$sm®Ë¡EËm’t
() const;

85 
MachšeID
 
	$sm®Ë¡EËm’t
(
MachšeTy³
 
machše
) const;

87 
	`»size
();

88 
	$g‘Size
(ècÚ¡ {  
m_b™s
.
	`size
(); 
	}
}

91 
NodeID
 
–em’tAt
(
MachšeID
 
šdex
);

93 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

95 
´iv©e
:

99 
	$vecIndex
(
MachšeID
 
m
) const

101 
vec_šdex
 = 
	`MachšeTy³_ba£_Ëv–
(
m
.
ty³
);

102 
	`as£¹
(
vec_šdex
 < 
m_b™s
.
	`size
());

103  
vec_šdex
;

104 
	}
}

106 
NodeID
 
	$b™Index
(
NodeID
 
šdex
ècÚ¡ {  index; 
	}
}

108 
	g¡d
::
veùÜ
<
S‘
> 
m_b™s
;

111 
šlše
 
	g¡d
::
o¡»am
&

112 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gN‘De¡
& 
	gobj
)

114 
	gobj
.
´št
(
out
);

115 
	gout
 << 
	g¡d
::
æush
;

116  
	gout
;

	@ruby/common/Set.hh

32 #iâdeà
__MEM_RUBY_COMMON_SET_HH__


33 
	#__MEM_RUBY_COMMON_SET_HH__


	)

35 
	~<b™£t
>

36 
	~<ÿs£¹
>

37 
	~<io¡»am
>

39 
	~"ba£/misc.hh
"

40 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

43 cÚ¡ 
	gNUMBER_BITS_PER_SET
 = 64;

45 şas 
	cS‘


47 
	m´iv©e
:

49 
m_nSize
;

50 
	m¡d
::
b™£t
<
NUMBER_BITS_PER_SET
> 
b™s
;

52 
	mpublic
:

53 
	$S‘
(è: 
	$m_nSize
(0) {}

55 
	$S‘
(
size
è: 
	$m_nSize
(
size
)

57 ià(
size
 > 
NUMBER_BITS_PER_SET
)

58 
	`çl
("Number of bits(%d) < size specified(%d). "

60 
NUMBER_BITS_PER_SET
, 
size
);

61 
	}
}

63 
	$S‘
(cÚ¡ 
S‘
& 
obj
è: 
	`m_nSize
(obj.
m_nSize
), 
	$b™s
(
obj
.
b™s
è{
	}
}

64 ~
	$S‘
(è{
	}
}

66 
	gS‘
& 
	gİ”©Ü
=(cÚ¡ 
S‘
& 
obj
)

68 
m_nSize
 = 
obj
.m_nSize;

69 
	gb™s
 = 
obj
.
b™s
;

70  *
	gthis
;

74 
	$add
(
NodeID
 
šdex
)

76 
b™s
.
	`£t
(
šdex
);

77 
	}
}

84 
	$addS‘
(cÚ¡ 
S‘
& 
obj
)

86 
	`as£¹
(
m_nSize
 =ğ
obj
.m_nSize);

87 
b™s
 |ğ
obj
.bits;

88 
	}
}

94 
	$»move
(
NodeID
 
šdex
)

96 
b™s
.
	`»£t
(
šdex
);

97 
	}
}

103 
	$»moveS‘
(cÚ¡ 
S‘
& 
obj
)

105 
	`as£¹
(
m_nSize
 =ğ
obj
.m_nSize);

106 
b™s
 &ğ(~
obj
.bits);

107 
	}
}

109 
	$ş—r
(è{ 
b™s
.
	`»£t
(); 
	}
}

114 
	$brßdÿ¡
()

116 
b™s
.
	`£t
();

117 
j
 = 
m_nSize
; j < 
NUMBER_BITS_PER_SET
; ++j) {

118 
b™s
.
	`»£t
(
j
);

120 
	}
}

125 
	$couÁ
(ècÚ¡ {  
b™s
.
	`couÁ
(); 
	}
}

130 
boŞ


131 
	$isEqu®
(cÚ¡ 
S‘
& 
obj
) const

133 
	`as£¹
(
m_nSize
 =ğ
obj
.m_nSize);

134  
b™s
 =ğ
obj
.bits;

135 
	}
}

138 
S‘


139 
	$OR
(cÚ¡ 
S‘
& 
obj
) const

141 
	`as£¹
(
m_nSize
 =ğ
obj
.m_nSize);

142 
S‘
 
	`r
(
m_nSize
);

143 
r
.
b™s
 = b™ | 
obj
.bits;

144  
r
;

145 
	}
};

148 
S‘


149 
	$AND
(cÚ¡ 
S‘
& 
obj
) const

151 
	`as£¹
(
m_nSize
 =ğ
obj
.m_nSize);

152 
S‘
 
	`r
(
m_nSize
);

153 
r
.
b™s
 = b™ & 
obj
.bits;

154  
r
;

155 
	}
}

158 
boŞ


159 
	$š‹r£ùiÚIsEm±y
(cÚ¡ 
S‘
& 
obj
) const

161 
¡d
::
b™£t
<
NUMBER_BITS_PER_SET
> 
r
 = 
b™s
 & 
obj
.bits;

162  
r
.
	`nÚe
();

163 
	}
}

169 
boŞ


170 
	$isSu³r£t
(cÚ¡ 
S‘
& 
‹¡
) const

172 
	`as£¹
(
m_nSize
 =ğ
‹¡
.m_nSize);

173 
¡d
::
b™£t
<
NUMBER_BITS_PER_SET
> 
r
 = 
b™s
 | 
‹¡
.bits;

174  (
r
 =ğ
b™s
);

175 
	}
}

177 
boŞ
 
	$isSub£t
(cÚ¡ 
S‘
& 
‹¡
ècÚ¡ { e¡.
	`isSu³r£t
(*
this
); 
	}
}

179 
boŞ
 
	$isEËm’t
(
NodeID
 
–em’t
ècÚ¡ {  
b™s
.
	`‹¡
ÓËm’t); 
	}
}

184 
boŞ


185 
	$isBrßdÿ¡
() const

187  (
b™s
.
	`couÁ
(è=ğ
m_nSize
);

188 
	}
}

190 
boŞ
 
	$isEm±y
(ècÚ¡ {  
b™s
.
	`nÚe
(); 
	}
}

192 
NodeID
 
	$sm®Ë¡EËm’t
() const

194 
i
 = 0; i < 
m_nSize
; ++i) {

195 ià(
b™s
.
	`‹¡
(
i
)) {

196  
i
;

199 
	`·nic
("No smallestƒlement of‡nƒmpty set.");

200 
	}
}

202 
boŞ
 
	$–em’tAt
(
šdex
ècÚ¡ {  
b™s
[šdex]; 
	}
}

204 
	$g‘Size
(ècÚ¡ {  
m_nSize
; 
	}
}

207 
	$£tSize
(
size
)

209 ià(
size
 > 
NUMBER_BITS_PER_SET
)

210 
	`çl
("Number of bits(%d) < size specified(%d). "

212 
NUMBER_BITS_PER_SET
, 
size
);

213 
m_nSize
 = 
size
;

214 
b™s
.
	`»£t
();

215 
	}
}

217 
	$´št
(
¡d
::
o¡»am
& 
out
) const

219 
out
 << "[S‘ (" << 
m_nSize
 << "): " << 
b™s
 << "]";

220 
	}
}

223 
šlše
 
	g¡d
::
o¡»am
&

224 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gS‘
& 
	gobj
)

226 
	gobj
.
´št
(
out
);

227 
	gout
 << 
	g¡d
::
æush
;

228  
	gout
;

	@ruby/common/SubBlock.cc

29 
	~"ba£/¡l_h–³rs.hh
"

30 
	~"mem/ruby/commÚ/SubBlock.hh
"

32 
usšg
 
	gm5
::
¡l_h–³rs
::
İ”©Ü
<<;

34 
	gSubBlock
::
	$SubBlock
(
Addr
 
addr
, 
size
)

36 
m_add»ss
 = 
addr
;

37 
	`»size
(
size
);

38 
i
 = 0; i < 
size
; i++) {

39 
	`£tBy‹
(
i
, 0);

41 
	}
}

44 
	gSubBlock
::
	$š‹º®M”geFrom
(cÚ¡ 
D©aBlock
& 
d©a
)

46 
size
 = 
	`g‘Size
();

47 
	`as£¹
(
size
 > 0);

48 
off£t
 = 
	`g‘Off£t
(
m_add»ss
);

49 
i
 = 0; i < 
size
; i++) {

50 
this
->
	`£tBy‹
(
i
, 
d©a
.
	`g‘By‹
(
off£t
 + i));

52 
	}
}

55 
	gSubBlock
::
	$š‹º®M”geTo
(
D©aBlock
& 
d©a
) const

57 
size
 = 
	`g‘Size
();

58 
	`as£¹
(
size
 > 0);

59 
off£t
 = 
	`g‘Off£t
(
m_add»ss
);

60 
i
 = 0; i < 
size
; i++) {

62 
d©a
.
	`£tBy‹
(
off£t
 + 
i
, 
this
->
	`g‘By‹
(i));

64 
	}
}

67 
	gSubBlock
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

69 
out
 << "[" << 
m_add»ss
 << ", " << 
	`g‘Size
(è<< ", " << 
m_d©a
 << "]";

70 
	}
}

	@ruby/common/SubBlock.hh

29 #iâdeà
__MEM_RUBY_COMMON_SUBBLOCK_HH__


30 
	#__MEM_RUBY_COMMON_SUBBLOCK_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 
	~"mem/ruby/commÚ/D©aBlock.hh
"

38 şas 
	cSubBlock


40 
	mpublic
:

41 
	$SubBlock
() { }

42 
	`SubBlock
(
Addr
 
addr
, 
size
);

43 ~
	$SubBlock
(è{ 
	}
}

45 
Addr
 
	$g‘Add»ss
(ècÚ¡ {  
m_add»ss
; 
	}
}

46 
	$£tAdd»ss
(
Addr
 
addr
è{ 
m_add»ss
 =‡ddr; 
	}
}

48 
	$g‘Size
(ècÚ¡ {  
m_d©a
.
	`size
(); 
	}
}

49 
	$»size
(
size
è{ 
m_d©a
.
	`»size
(size); 
	}
}

50 
ušt8_t
 
	$g‘By‹
(
off£t
ècÚ¡ {  
m_d©a
[off£t]; 
	}
}

51 
	$£tBy‹
(
off£t
, 
ušt8_t
 
d©a
è{ 
m_d©a
[off£t] = d©a; 
	}
}

54 
ušt8_t
 
	$»adBy‹
(ècÚ¡ {  
	`g‘By‹
(0); 
	}
}

55 
	$wr™eBy‹
(
ušt8_t
 
d©a
è{ 
	`£tBy‹
(0, d©a); 
	}
}

59 
	$m”geTo
(
D©aBlock
& 
d©a
ècÚ¡ { 
	`š‹º®M”geTo
(d©a); 
	}
}

60 
	$m”geFrom
(cÚ¡ 
D©aBlock
& 
d©a
è{ 
	`š‹º®M”geFrom
(d©a); 
	}
}

62 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

64 
´iv©e
:

65 
	$š‹º®M”geTo
(
D©aBlock
& 
d©a
) const;

66 
	`š‹º®M”geFrom
(cÚ¡ 
D©aBlock
& 
d©a
);

69 
Addr
 
m_add»ss
;

70 
¡d
::
veùÜ
<
ušt8_t
> 
m_d©a
;

71 
	}
};

73 
šlše
 
	g¡d
::
o¡»am
&

74 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gSubBlock
& 
	gobj
)

76 
	gobj
.
´št
(
out
);

77 
	gout
 << 
	g¡d
::
æush
;

78  
	gout
;

	@ruby/common/TypeDefines.hh

30 #iâdeà
TYPEDEFINES_H


31 
	#TYPEDEFINES_H


	)

33 
	tLškID
;

34 
	tNodeID
;

35 
	tSw™chID
;

	@ruby/common/WriteMask.cc

29 
	~"mem/ruby/commÚ/Wr™eMask.hh
"

31 
	~<¡ršg
>

33 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

36 
	gWr™eMask
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

38 
¡d
::
¡ršg
 
	`¡r
(
mSize
,'0');

39 
i
 = 0; i < 
mSize
; i++) {

40 
¡r
[
i
] = 
mMask
[i] ? ('1') : ('0');

42 
out
 << "dirty mask="

43 << 
¡r


44 << 
¡d
::
æush
;

45 
	}
}

	@ruby/common/WriteMask.hh

29 #iâdeà
__MEM_RUBY_COMMON_WRITEMASK_HH__


30 
	#__MEM_RUBY_COMMON_WRITEMASK_HH__


	)

32 
	~<ÿs£¹
>

33 
	~<iomª
>

34 
	~<io¡»am
>

35 
	~<veùÜ
>

37 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

38 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

40 şas 
	cWr™eMask


42 
	mpublic
:

43 
	$Wr™eMask
()

44 : 
	`mSize
(
RubySy¡em
::
	`g‘BlockSizeBy‹s
()), 
	`mMask
(
mSize
, 
çl£
),

45 
	$mAtomic
(
çl£
)

48 
	$Wr™eMask
(
size
)

49 : 
	`mSize
(
size
), 
	`mMask
(size, 
çl£
), 
	$mAtomic
(
çl£
)

50 {
	}
}

52 
Wr™eMask
(
size
, 
¡d
::
veùÜ
<
boŞ
> & 
mask
)

53 : 
mSize
(
size
), 
mMask
(
mask
), 
	$mAtomic
(
çl£
)

54 {
	}
}

56 
Wr™eMask
(
size
, 
¡d
::
veùÜ
<
boŞ
> &
mask
,

57 
¡d
::
veùÜ
<¡d::
·œ
<, 
AtomicOpFunùÜ
*> > 
©omicOp
)

58 : 
mSize
(
size
), 
mMask
(
mask
), 
mAtomic
(
Œue
), 
	$mAtomicOp
(
©omicOp
)

59 {
	}
}

61 ~
	$Wr™eMask
()

62 {
	}
}

65 
	$ş—r
()

67 
mMask
 = 
¡d
::
veùÜ
<
boŞ
>(
mSize
, 
çl£
);

68 
	}
}

70 
boŞ


71 
	$‹¡
(
off£t
)

73 
	`as£¹
(
off£t
 < 
mSize
);

74  
mMask
[
off£t
];

75 
	}
}

78 
	$£tMask
(
off£t
, 
Ën
)

80 
	`as£¹
(
mSize
 >ğ(
off£t
 + 
Ën
));

81 
i
 = 0; i < 
Ën
; i++) {

82 
mMask
[
off£t
 + 
i
] = 
Œue
;

84 
	}
}

86 
	$flMask
()

88 
i
 = 0; i < 
mSize
; i++) {

89 
mMask
[
i
] = 
Œue
;

91 
	}
}

93 
boŞ


94 
	$g‘Mask
(
off£t
, 
Ën
) const

96 
boŞ
 
tmp
 = 
Œue
;

97 
	`as£¹
(
mSize
 >ğ(
off£t
 + 
Ën
));

98 
i
 = 0; i < 
Ën
; i++) {

99 
tmp
 =m°& 
mMask
.
	`©
(
off£t
 + 
i
);

101  
tmp
;

102 
	}
}

104 
boŞ


105 
	$isOv”Ïp
(cÚ¡ 
Wr™eMask
 &
»adMask
) const

107 
boŞ
 
tmp
 = 
çl£
;

108 
	`as£¹
(
mSize
 =ğ
»adMask
.mSize);

109 
i
 = 0; i < 
mSize
; i++) {

110 ià(
»adMask
.
mMask
.
	`©
(
i
)) {

111 
tmp
 =m°| 
mMask
.
	`©
(
i
);

114  
tmp
;

115 
	}
}

117 
boŞ


118 
	$cmpMask
(cÚ¡ 
Wr™eMask
 &
»adMask
) const

120 
boŞ
 
tmp
 = 
Œue
;

121 
	`as£¹
(
mSize
 =ğ
»adMask
.mSize);

122 
i
 = 0; i < 
mSize
; i++) {

123 ià(
»adMask
.
mMask
.
	`©
(
i
)) {

124 
tmp
 =m°& 
mMask
.
	`©
(
i
);

127  
tmp
;

128 
	}
}

130 
boŞ
 
	$isEm±y
() const

132 
i
 = 0; i < 
mSize
; i++) {

133 ià(
mMask
.
	`©
(
i
)) {

134  
çl£
;

137  
Œue
;

138 
	}
}

140 
boŞ


141 
	$isFuÎ
() const

143 
i
 = 0; i < 
mSize
; i++) {

144 ià(!
mMask
.
	`©
(
i
)) {

145  
çl£
;

148  
Œue
;

149 
	}
}

152 
	$ÜMask
(cÚ¡ 
Wr™eMask
 & 
wr™eMask
)

154 
	`as£¹
(
mSize
 =ğ
wr™eMask
.mSize);

155 
i
 = 0; i < 
mSize
; i++) {

156 
mMask
[
i
] = (mMask.
	`©
(i)è| (
wr™eMask
.mMask.at(i));

159 ià(
wr™eMask
.
mAtomic
) {

160 
mAtomic
 = 
Œue
;

161 
mAtomicOp
 = 
wr™eMask
.mAtomicOp;

163 
	}
}

165 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

168 
	$³rfÜmAtomic
(
ušt8_t
 * 
p
) const

170 
i
 = 0; i < 
mAtomicOp
.
	`size
(); i++) {

171 
off£t
 = 
mAtomicOp
[
i
].
fœ¡
;

172 
AtomicOpFunùÜ
 *
âùr
 = 
mAtomicOp
[
i
].
£cÚd
;

173 (*
âùr
)(&
p
[
off£t
]);

175 
	}
}

178 
	$³rfÜmAtomic
(
D©aBlock
 & 
blk
) const

180 
i
 = 0; i < 
mAtomicOp
.
	`size
(); i++) {

181 
off£t
 = 
mAtomicOp
[
i
].
fœ¡
;

182 
ušt8_t
 *
p
 = 
blk
.
	`g‘D©aMod
(
off£t
);

183 
AtomicOpFunùÜ
 *
âùr
 = 
mAtomicOp
[
i
].
£cÚd
;

184 (*
âùr
)(
p
);

186 
	}
}

187 
	g´iv©e
:

188 
mSize
;

189 
	g¡d
::
veùÜ
<
boŞ
> 
mMask
;

190 
boŞ
 
	gmAtomic
;

191 
	g¡d
::
veùÜ
<
¡d
::
·œ
<, 
	gAtomicOpFunùÜ
*> > 
	gmAtomicOp
;

194 
šlše
 
	g¡d
::
o¡»am
&

195 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gWr™eMask
& 
	gobj
)

197 
	gobj
.
´št
(
out
);

198 
	gout
 << 
	g¡d
::
æush
;

199  
	gout
;

	@ruby/filters/AbstractBloomFilter.hh

29 #iâdeà
__MEM_RUBY_FILTERS_ABSTRACTBLOOMFILTER_HH__


30 
	#__MEM_RUBY_FILTERS_ABSTRACTBLOOMFILTER_HH__


	)

32 
	~<io¡»am
>

34 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 şas 
	cAb¡¿ùBloomF‹r


38 
	mpublic
:

39 
vœtu®
 ~
	$Ab¡¿ùBloomF‹r
() {};

40 
vœtu®
 
	`ş—r
() = 0;

41 
vœtu®
 
	`šüem’t
(
Addr
 
addr
) = 0;

42 
vœtu®
 
	`deüem’t
(
Addr
 
addr
) = 0;

43 
vœtu®
 
	`m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
) = 0;

44 
vœtu®
 
	`£t
(
Addr
 
addr
) = 0;

45 
vœtu®
 
	`un£t
(
Addr
 
addr
) = 0;

47 
vœtu®
 
boŞ
 
	`isS‘
(
Addr
 
addr
) = 0;

48 
vœtu®
 
	`g‘CouÁ
(
Addr
 
addr
) = 0;

49 
vœtu®
 
	`g‘TÙ®CouÁ
() = 0;

51 
vœtu®
 
	$´št
(
¡d
::
o¡»am
& 
out
) const = 0;

53 
vœtu®
 
	`g‘Index
(
Addr
 
addr
) = 0;

54 
vœtu®
 
	`»adB™
(cÚ¡ 
šdex
) = 0;

55 
vœtu®
 
	`wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
) = 0;

56 
	}
};

	@ruby/filters/BlockBloomFilter.cc

29 
	~"ba£/štm©h.hh
"

30 
	~"ba£/¡r.hh
"

31 
	~"mem/ruby/f‹rs/BlockBloomF‹r.hh
"

32 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

34 
usšg
 
Çme¥aû
 
	g¡d
;

36 
	gBlockBloomF‹r
::
	$BlockBloomF‹r
(
size
)

38 
m_f‹r_size
 = 
size
;

39 
m_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_f‹r_size
);

41 
m_f‹r
.
	`»size
(
m_f‹r_size
);

43 
	`ş—r
();

44 
	}
}

46 
	gBlockBloomF‹r
::~
	$BlockBloomF‹r
()

48 
	}
}

51 
BlockBloomF‹r
::
	$ş—r
()

53 
i
 = 0; i < 
m_f‹r_size
; i++) {

54 
m_f‹r
[
i
] = 0;

56 
	}
}

59 
	gBlockBloomF‹r
::
	$šüem’t
(
Addr
 
addr
)

62 
	}
}

65 
BlockBloomF‹r
::
	$deüem’t
(
Addr
 
addr
)

68 
	}
}

71 
BlockBloomF‹r
::
	$m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
)

74 
	}
}

77 
BlockBloomF‹r
::
	$£t
(
Addr
 
addr
)

79 
i
 = 
	`g‘_šdex
(
addr
);

80 
m_f‹r
[
i
] = 1;

81 
	}
}

84 
	gBlockBloomF‹r
::
	$un£t
(
Addr
 
addr
)

86 
i
 = 
	`g‘_šdex
(
addr
);

87 
m_f‹r
[
i
] = 0;

88 
	}
}

90 
boŞ


91 
	gBlockBloomF‹r
::
	$isS‘
(
Addr
 
addr
)

93 
i
 = 
	`g‘_šdex
(
addr
);

94  (
m_f‹r
[
i
]);

95 
	}
}

98 
	gBlockBloomF‹r
::
	$g‘CouÁ
(
Addr
 
addr
)

100  
m_f‹r
[
	`g‘_šdex
(
addr
)];

101 
	}
}

104 
	gBlockBloomF‹r
::
	$g‘TÙ®CouÁ
()

106 
couÁ
 = 0;

108 
i
 = 0; i < 
m_f‹r_size
; i++) {

109 ià(
m_f‹r
[
i
]) {

110 
couÁ
++;

113  
couÁ
;

114 
	}
}

117 
	gBlockBloomF‹r
::
	$g‘Index
(
Addr
 
addr
)

119  
	`g‘_šdex
(
addr
);

120 
	}
}

123 
	gBlockBloomF‹r
::
	$´št
(
o¡»am
& 
out
) const

125 
	}
}

128 
BlockBloomF‹r
::
	$»adB™
(cÚ¡ 
šdex
)

130  
m_f‹r
[
šdex
];

131 
	}
}

134 
	gBlockBloomF‹r
::
	$wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
)

136 
m_f‹r
[
šdex
] = 
v®ue
;

137 
	}
}

140 
	gBlockBloomF‹r
::
	$g‘_šdex
(
Addr
 
addr
)

145 
Addr
 
block_b™s
 = 
	`b™S–eù
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeB™s
(),

146 2 * 
RubySy¡em
::
	`g‘BlockSizeB™s
() - 1);

147 
off£t
 = 5;

148 
Addr
 
Ùh”_b™s
 = 
	`b™S–eù
(
addr
,

149 2 * 
RubySy¡em
::
	`g‘BlockSizeB™s
(è+ 
off£t
,

150 2 * 
RubySy¡em
::
	`g‘BlockSizeB™s
(è+ 
off£t
 +

151 
m_f‹r_size_b™s
 - 1);

152 
šdex
 = 
block_b™s
 ^ 
Ùh”_b™s
;

153 
	`as£¹
(
šdex
 < 
m_f‹r_size
);

154  
šdex
;

155 
	}
}

	@ruby/filters/BlockBloomFilter.hh

29 #iâdeà
__MEM_RUBY_FILTERS_BLOCKBLOOMFILTER_HH__


30 
	#__MEM_RUBY_FILTERS_BLOCKBLOOMFILTER_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 
	~"mem/ruby/f‹rs/Ab¡¿ùBloomF‹r.hh
"

38 şas 
	cBlockBloomF‹r
 : 
public
 
Ab¡¿ùBloomF‹r


40 
public
:

41 
BlockBloomF‹r
(
size
);

42 ~
BlockBloomF‹r
();

44 
ş—r
();

45 
šüem’t
(
Addr
 
addr
);

46 
deüem’t
(
Addr
 
addr
);

47 
m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
);

48 
£t
(
Addr
 
addr
);

49 
un£t
(
Addr
 
addr
);

51 
boŞ
 
isS‘
(
Addr
 
addr
);

52 
g‘CouÁ
(
Addr
 
addr
);

53 
g‘TÙ®CouÁ
();

54 
g‘Index
(
Addr
 
addr
);

55 
»adB™
(cÚ¡ 
šdex
);

56 
wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
);

58 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

60 
´iv©e
:

61 
	`g‘_šdex
(
Addr
 
addr
);

63 
¡d
::
veùÜ
<> 
m_f‹r
;

64 
m_f‹r_size
;

65 
m_f‹r_size_b™s
;

	@ruby/filters/BulkBloomFilter.cc

29 
	~<ÿs£¹
>

31 
	~"ba£/štm©h.hh
"

32 
	~"ba£/¡r.hh
"

33 
	~"mem/ruby/f‹rs/BulkBloomF‹r.hh
"

34 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

36 
usšg
 
Çme¥aû
 
	g¡d
;

38 
	gBulkBloomF‹r
::
	$BulkBloomF‹r
(
size
)

40 
m_f‹r_size
 = 
size
;

41 
m_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_f‹r_size
);

43 
m_£ùÜ_b™s
 = 
m_f‹r_size_b™s
 - 1;

45 
m_‹mp_f‹r
.
	`»size
(
m_f‹r_size
);

46 
m_f‹r
.
	`»size
(
m_f‹r_size
);

47 
	`ş—r
();

50 
i
 = 0; i < 
m_f‹r_size
; ++i) {

51 
m_‹mp_f‹r
[
i
] = 0;

53 
	}
}

55 
	gBulkBloomF‹r
::~
	$BulkBloomF‹r
()

57 
	}
}

60 
BulkBloomF‹r
::
	$ş—r
()

62 
i
 = 0; i < 
m_f‹r_size
; i++) {

63 
m_f‹r
[
i
] = 0;

65 
	}
}

68 
	gBulkBloomF‹r
::
	$šüem’t
(
Addr
 
addr
)

71 
	}
}

74 
BulkBloomF‹r
::
	$deüem’t
(
Addr
 
addr
)

77 
	}
}

80 
BulkBloomF‹r
::
	$m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
)

83 
	}
}

86 
BulkBloomF‹r
::
	$£t
(
Addr
 
addr
)

89 
£t_b™s
 = 
m_£ùÜ_b™s
;

90 
block_b™s
 = 
RubySy¡em
::
	`g‘BlockSizeB™s
();

91 
c0
 = 
	`b™S–eù
(
addr
, 
block_b™s
, block_b™ + 
£t_b™s
 - 1);

95 
c1
 = 
	`b™S–eù
(
addr
, 
block_b™s
+
£t_b™s
, (block_bits+2*set_bits) - 1);

100 
m_f‹r
[
c0
 + (
m_f‹r_size
/2)] = 1;

102 
m_f‹r
[
c1
] = 1;

103 
	}
}

106 
	gBulkBloomF‹r
::
	$un£t
(
Addr
 
addr
)

109 
	}
}

111 
boŞ


112 
BulkBloomF‹r
::
	$isS‘
(
Addr
 
addr
)

115 
£t_b™s
 = 
m_£ùÜ_b™s
;

116 
block_b™s
 = 
RubySy¡em
::
	`g‘BlockSizeB™s
();

117 
c0
 = 
	`b™S–eù
(
addr
, 
block_b™s
, block_b™ + 
£t_b™s
 - 1);

121 
c1
 = 
	`b™S–eù
(
addr
, 
block_b™s
+
£t_b™s
, (block_bits+2*set_bits) - 1);

126 
m_‹mp_f‹r
[
c0
 + (
m_f‹r_size
/2)] = 1;

128 
m_‹mp_f‹r
[
c1
] = 1;

132 
boŞ
 
z”o
 = 
çl£
;

133 
i
 = 0; i < 
m_f‹r_size
/2; ++i){

135 
m_‹mp_f‹r
[
i
] = m_‹mp_f‹r[i] && 
m_f‹r
[i];

136 
z”o
 = z”Ø|| 
m_‹mp_f‹r
[
i
];

138 
z”o
 = !zero;

139 ià(
z”o
) {

142 
m_‹mp_f‹r
[
c0
 + (
m_f‹r_size
 / 2)] = 0;

143 
m_‹mp_f‹r
[
c1
] = 0;

144  
çl£
;

148 
z”o
 = 
çl£
;

149 
i
 = 
m_f‹r_size
 / 2; i < m_filter_size; ++i) {

151 
m_‹mp_f‹r
[
i
] = m_‹mp_f‹r[i] && 
m_f‹r
[i];

152 
z”o
 = z”Ø|| 
m_‹mp_f‹r
[
i
];

154 
z”o
 = !zero;

155 ià(
z”o
) {

157 
m_‹mp_f‹r
[
c0
 + (
m_f‹r_size
 / 2)] = 0;

158 
m_‹mp_f‹r
[
c1
] = 0;

159  
çl£
;

162 
m_‹mp_f‹r
[
c0
 + (
m_f‹r_size
 / 2)] = 0;

163 
m_‹mp_f‹r
[
c1
] = 0;

164  
Œue
;

165 
	}
}

168 
	gBulkBloomF‹r
::
	$g‘CouÁ
(
Addr
 
addr
)

172 
	}
}

175 
	gBulkBloomF‹r
::
	$g‘TÙ®CouÁ
()

177 
couÁ
 = 0;

178 
i
 = 0; i < 
m_f‹r_size
; i++) {

179 ià(
m_f‹r
[
i
]) {

180 
couÁ
++;

183  
couÁ
;

184 
	}
}

187 
	gBulkBloomF‹r
::
	$g‘Index
(
Addr
 
addr
)

189  
	`g‘_šdex
(
addr
);

190 
	}
}

193 
	gBulkBloomF‹r
::
	$»adB™
(cÚ¡ 
šdex
)

197 
	}
}

200 
	gBulkBloomF‹r
::
	$wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
)

203 
	}
}

206 
	gBulkBloomF‹r
::
	$´št
(
o¡»am
& 
out
) const

208 
	}
}

211 
BulkBloomF‹r
::
	$g‘_šdex
(
Addr
 
addr
)

213  
	`b™S–eù
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeB™s
(),

214 
RubySy¡em
::
	`g‘BlockSizeB™s
() +

215 
m_f‹r_size_b™s
 - 1);

216 
	}
}

218 
Addr


219 
	gBulkBloomF‹r
::
	$³rmu‹
(
Addr
 
addr
)

222 
block_off£t
 = 
RubySy¡em
::
	`g‘BlockSizeB™s
();

223 
Addr
 
·¹1
 = 
	`b™S–eù
(
addr
, 
block_off£t
, block_offset + 6),

224 
·¹2
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 9, block_offset + 9),

225 
·¹3
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 11, block_offset + 11),

226 
·¹4
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 17, block_offset + 17),

227 
·¹5
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 7, block_offset + 8),

228 
·¹6
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 10, block_offset + 10),

229 
·¹7
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 12, block_offset + 12),

230 
·¹8
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 13, block_offset + 13),

231 
·¹9
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 15, block_offset + 16),

232 
·¹10
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 18, block_offset + 20),

233 
·¹11
 = 
	`b™S–eù
(
addr
, 
block_off£t
 + 14, block_offset + 14);

235 
Addr
 
»suÉ
 =

236 (
·¹1
 << 14è| (
·¹2
 << 13è| (
·¹3
 << 12è| (
·¹4
 << 11) |

237 (
·¹5
 << 9è| (
·¹6
 << 8è| (
·¹7
 << 7è| (
·¹8
 << 6) |

238 (
·¹9
 << 4è| (
·¹10
 << 1è| (
·¹11
);

242 
Addr
 
»maššg_b™s
 =

243 
	`b™S–eù
(
addr
, 
block_off£t
 + 21, 31) << 21;

244 
»suÉ
 =„esuÉ | 
»maššg_b™s
;

246  
»suÉ
;

247 
	}
}

	@ruby/filters/BulkBloomFilter.hh

29 #iâdeà
__MEM_RUBY_FILTERS_BULKBLOOMFILTER_HH__


30 
	#__MEM_RUBY_FILTERS_BULKBLOOMFILTER_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 
	~"mem/ruby/f‹rs/Ab¡¿ùBloomF‹r.hh
"

38 şas 
	cBulkBloomF‹r
 : 
public
 
Ab¡¿ùBloomF‹r


40 
public
:

41 
BulkBloomF‹r
(
size
);

42 ~
BulkBloomF‹r
();

44 
ş—r
();

45 
šüem’t
(
Addr
 
addr
);

46 
deüem’t
(
Addr
 
addr
);

47 
m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
);

48 
£t
(
Addr
 
addr
);

49 
un£t
(
Addr
 
addr
);

51 
boŞ
 
isS‘
(
Addr
 
addr
);

52 
g‘CouÁ
(
Addr
 
addr
);

53 
g‘TÙ®CouÁ
();

54 
g‘Index
(
Addr
 
addr
);

55 
»adB™
(cÚ¡ 
šdex
);

56 
wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
);

58 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

60 
´iv©e
:

61 
	`g‘_šdex
(
Addr
 
addr
);

62 
Addr
 
	`³rmu‹
(Add¸
addr
);

64 
¡d
::
veùÜ
<> 
m_f‹r
;

65 
¡d
::
veùÜ
<> 
m_‹mp_f‹r
;

67 
m_f‹r_size
;

68 
m_f‹r_size_b™s
;

70 
m_£ùÜ_b™s
;

	@ruby/filters/H3BloomFilter.cc

29 
	~"ba£/štm©h.hh
"

30 
	~"mem/ruby/f‹rs/H3BloomF‹r.hh
"

32 
usšg
 
Çme¥aû
 
	g¡d
;

34 
	gH3
[64][16] = {

356 
	gH3BloomF‹r
::
	$H3BloomF‹r
(
size
, 
hashes
, 
boŞ
 
·¿Î–
)

359 
´imes_li¡
[0] = 9323;

360 
´imes_li¡
[1] = 11279;

361 
´imes_li¡
[2] = 10247;

362 
´imes_li¡
[3] = 30637;

363 
´imes_li¡
[4] = 25717;

364 
´imes_li¡
[5] = 43711;

366 
muÉs_li¡
[0] = 255;

367 
muÉs_li¡
[1] = 29;

368 
muÉs_li¡
[2] = 51;

369 
muÉs_li¡
[3] = 3;

370 
muÉs_li¡
[4] = 77;

371 
muÉs_li¡
[5] = 43;

373 
adds_li¡
[0] = 841;

374 
adds_li¡
[1] = 627;

375 
adds_li¡
[2] = 1555;

376 
adds_li¡
[3] = 241;

377 
adds_li¡
[4] = 7777;

378 
adds_li¡
[5] = 65931;

380 
m_f‹r_size
 = 
size
;

381 
m_num_hashes
 = 
hashes
;

382 
isP¬®Ël
 = 
·¿Î–
;

384 
m_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_f‹r_size
);

386 
m_·r_f‹r_size
 = 
m_f‹r_size
 / 
m_num_hashes
;

387 
m_·r_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_·r_f‹r_size
);

389 
m_f‹r
.
	`»size
(
m_f‹r_size
);

390 
	`ş—r
();

391 
	}
}

393 
	gH3BloomF‹r
::~
	$H3BloomF‹r
()

395 
	}
}

398 
H3BloomF‹r
::
	$ş—r
()

400 
i
 = 0; i < 
m_f‹r_size
; i++) {

401 
m_f‹r
[
i
] = 0;

403 
	}
}

406 
	gH3BloomF‹r
::
	$šüem’t
(
Addr
 
addr
)

409 
	}
}

412 
H3BloomF‹r
::
	$deüem’t
(
Addr
 
addr
)

415 
	}
}

418 
H3BloomF‹r
::
	$m”ge
(
Ab¡¿ùBloomF‹r
 *
Ùh”_f‹r
)

421 
H3BloomF‹r
 * 
‹mp
 = (H3BloomF‹r*è
Ùh”_f‹r
;

422 
i
 = 0; i < 
m_f‹r_size
; ++i){

423 
m_f‹r
[
i
] |ğ(*
‹mp
)[i];

425 
	}
}

428 
	gH3BloomF‹r
::
	$£t
(
Addr
 
addr
)

430 
i
 = 0; i < 
m_num_hashes
; i++) {

431 
idx
 = 
	`g‘_šdex
(
addr
, 
i
);

432 
m_f‹r
[
idx
] = 1;

434 
	}
}

437 
	gH3BloomF‹r
::
	$un£t
(
Addr
 
addr
)

439 
cout
 << "ERROR: Unset should‚ever be called in‡ Bloom filter";

440 
	`as£¹
(0);

441 
	}
}

443 
boŞ


444 
	gH3BloomF‹r
::
	$isS‘
(
Addr
 
addr
)

446 
boŞ
 
»s
 = 
Œue
;

448 
i
 = 0; i < 
m_num_hashes
; i++) {

449 
idx
 = 
	`g‘_šdex
(
addr
, 
i
);

450 
»s
 =„e && 
m_f‹r
[
idx
];

452  
»s
;

453 
	}
}

456 
	gH3BloomF‹r
::
	$g‘CouÁ
(
Addr
 
addr
)

458  
	`isS‘
(
addr
)? 1: 0;

459 
	}
}

462 
	gH3BloomF‹r
::
	$g‘Index
(
Addr
 
addr
)

465 
	}
}

468 
	gH3BloomF‹r
::
	$»adB™
(cÚ¡ 
šdex
)

471 
	}
}

474 
	gH3BloomF‹r
::
	$wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
)

476 
	}
}

479 
	gH3BloomF‹r
::
	$g‘TÙ®CouÁ
()

481 
couÁ
 = 0;

483 
i
 = 0; i < 
m_f‹r_size
; i++) {

484 
couÁ
 +ğ
m_f‹r
[
i
];

486  
couÁ
;

487 
	}
}

490 
	gH3BloomF‹r
::
	$´št
(
o¡»am
& 
out
) const

492 
	}
}

495 
H3BloomF‹r
::
	$g‘_šdex
(
Addr
 
addr
, 
i
)

497 
ušt64_t
 
x
 = 
	`makeLšeAdd»ss
(
addr
);

499 
y
 = 
	`hash_H3
(
x
,
i
);

501 ià(
isP¬®Ël
) {

502  (
y
 % 
m_·r_f‹r_size
è+ 
i
*m_par_filter_size;

504  
y
 % 
m_f‹r_size
;

506 
	}
}

509 
	gH3BloomF‹r
::
	$hash_H3
(
ušt64_t
 
v®ue
, 
šdex
)

511 
ušt64_t
 
mask
 = 1;

512 
ušt64_t
 
v®
 = 
v®ue
;

513 
»suÉ
 = 0;

515 
i
 = 0; i < 64; i++) {

516 ià(
v®
&
mask
è
»suÉ
 ^ğ
H3
[
i
][
šdex
];

517 
v®
 = val >> 1;

519  
»suÉ
;

520 
	}
}

	@ruby/filters/H3BloomFilter.hh

29 #iâdeà
__MEM_RUBY_FILTERS_H3BLOOMFILTER_HH__


30 
	#__MEM_RUBY_FILTERS_H3BLOOMFILTER_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 
	~"mem/ruby/f‹rs/Ab¡¿ùBloomF‹r.hh
"

38 şas 
	cH3BloomF‹r
 : 
public
 
Ab¡¿ùBloomF‹r


40 
public
:

41 
H3BloomF‹r
(
size
, 
hashes
, 
boŞ
 
·¿Î–
);

42 ~
H3BloomF‹r
();

44 
ş—r
();

45 
šüem’t
(
Addr
 
addr
);

46 
deüem’t
(
Addr
 
addr
);

47 
m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
);

48 
£t
(
Addr
 
addr
);

49 
un£t
(
Addr
 
addr
);

51 
boŞ
 
isS‘
(
Addr
 
addr
);

52 
g‘CouÁ
(
Addr
 
addr
);

53 
g‘TÙ®CouÁ
();

54 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

56 
	`g‘Index
(
Addr
 
addr
);

57 
	`»adB™
(cÚ¡ 
šdex
);

58 
	`wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
);

61 
İ”©Ü
[](cÚ¡ 
šdex
) const

63  
this
->
m_f‹r
[
šdex
];

66 
´iv©e
:

67 
	`g‘_šdex
(
Addr
 
addr
, 
hashNumb”
);

69 
	`hash_H3
(
ušt64_t
 
v®ue
, 
šdex
);

71 
¡d
::
veùÜ
<> 
m_f‹r
;

72 
m_f‹r_size
;

73 
m_num_hashes
;

74 
m_f‹r_size_b™s
;

76 
m_·r_f‹r_size
;

77 
m_·r_f‹r_size_b™s
;

79 
´imes_li¡
[6];

80 
muÉs_li¡
[6];

81 
adds_li¡
[6];

83 
boŞ
 
isP¬®Ël
;

84 
	}
};

	@ruby/filters/LSB_CountingBloomFilter.cc

29 
	~"ba£/štm©h.hh
"

30 
	~"mem/ruby/f‹rs/LSB_CouÁšgBloomF‹r.hh
"

31 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

33 
usšg
 
Çme¥aû
 
	g¡d
;

35 
	gLSB_CouÁšgBloomF‹r
::
	$LSB_CouÁšgBloomF‹r
(
h—d
, 

)

37 
m_f‹r_size
 = 
h—d
;

38 
m_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_f‹r_size
);

40 
m_couÁ
 = 

;

41 
m_couÁ_b™s
 = 
	`æoÜLog2
(
m_couÁ
);

43 
m_f‹r
.
	`»size
(
m_f‹r_size
);

44 
	`ş—r
();

45 
	}
}

47 
	gLSB_CouÁšgBloomF‹r
::~
	$LSB_CouÁšgBloomF‹r
()

49 
	}
}

52 
LSB_CouÁšgBloomF‹r
::
	$ş—r
()

54 
i
 = 0; i < 
m_f‹r_size
; i++) {

55 
m_f‹r
[
i
] = 0;

57 
	}
}

60 
	gLSB_CouÁšgBloomF‹r
::
	$šüem’t
(
Addr
 
addr
)

62 
i
 = 
	`g‘_šdex
(
addr
);

63 ià(
m_f‹r
[
i
] < 
m_couÁ
)

64 
m_f‹r
[
i
] += 1;

65 
	}
}

69 
	gLSB_CouÁšgBloomF‹r
::
	$deüem’t
(
Addr
 
addr
)

71 
i
 = 
	`g‘_šdex
(
addr
);

72 ià(
m_f‹r
[
i
] > 0)

73 
m_f‹r
[
i
] -= 1;

74 
	}
}

77 
	gLSB_CouÁšgBloomF‹r
::
	$m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
)

80 
	}
}

83 
LSB_CouÁšgBloomF‹r
::
	$£t
(
Addr
 
addr
)

86 
	}
}

89 
LSB_CouÁšgBloomF‹r
::
	$un£t
(
Addr
 
addr
)

92 
	}
}

94 
boŞ


95 
LSB_CouÁšgBloomF‹r
::
	$isS‘
(
Addr
 
addr
)

98  
çl£
;

99 
	}
}

102 
	gLSB_CouÁšgBloomF‹r
::
	$g‘CouÁ
(
Addr
 
addr
)

104  
m_f‹r
[
	`g‘_šdex
(
addr
)];

105 
	}
}

108 
	gLSB_CouÁšgBloomF‹r
::
	$g‘TÙ®CouÁ
()

110 
couÁ
 = 0;

112 
i
 = 0; i < 
m_f‹r_size
; i++) {

113 
couÁ
 +ğ
m_f‹r
[
i
];

115  
couÁ
;

116 
	}
}

119 
	gLSB_CouÁšgBloomF‹r
::
	$g‘Index
(
Addr
 
addr
)

121  
	`g‘_šdex
(
addr
);

122 
	}
}

125 
	gLSB_CouÁšgBloomF‹r
::
	$´št
(
o¡»am
& 
out
) const

127 
	}
}

130 
LSB_CouÁšgBloomF‹r
::
	$»adB™
(cÚ¡ 
šdex
)

134 
	}
}

137 
	gLSB_CouÁšgBloomF‹r
::
	$wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
)

140 
	}
}

143 
	gLSB_CouÁšgBloomF‹r
::
	$g‘_šdex
(
Addr
 
addr
)

145  
	`b™S–eù
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeB™s
(),

146 
RubySy¡em
::
	`g‘BlockSizeB™s
() +

147 
m_f‹r_size_b™s
 - 1);

148 
	}
}

	@ruby/filters/LSB_CountingBloomFilter.hh

29 #iâdeà
__MEM_RUBY_FILTERS_LSBCOUNTINGBLOOMFILTER_HH__


30 
	#__MEM_RUBY_FILTERS_LSBCOUNTINGBLOOMFILTER_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 
	~"mem/ruby/f‹rs/Ab¡¿ùBloomF‹r.hh
"

38 şas 
	cLSB_CouÁšgBloomF‹r
 : 
public
 
Ab¡¿ùBloomF‹r


40 
public
:

41 
LSB_CouÁšgBloomF‹r
(
h—d
, 

);

42 ~
LSB_CouÁšgBloomF‹r
();

44 
ş—r
();

45 
šüem’t
(
Addr
 
addr
);

46 
deüem’t
(
Addr
 
addr
);

47 
m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
);

48 
£t
(
Addr
 
addr
);

49 
un£t
(
Addr
 
addr
);

51 
boŞ
 
isS‘
(
Addr
 
addr
);

52 
g‘CouÁ
(
Addr
 
addr
);

53 
g‘TÙ®CouÁ
();

54 
g‘Index
(
Addr
 
addr
);

55 
»adB™
(cÚ¡ 
šdex
);

56 
wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
);

58 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

60 
´iv©e
:

61 
	`g‘_šdex
(
Addr
 
addr
);

63 
¡d
::
veùÜ
<> 
m_f‹r
;

64 
m_f‹r_size
;

65 
m_f‹r_size_b™s
;

67 
m_couÁ_b™s
;

68 
m_couÁ
;

	@ruby/filters/MultiBitSelBloomFilter.cc

29 
	~<veùÜ
>

31 
	~"ba£/štm©h.hh
"

32 
	~"ba£/¡r.hh
"

33 
	~"mem/ruby/f‹rs/MuÉiB™S–BloomF‹r.hh
"

35 
usšg
 
Çme¥aû
 
	g¡d
;

37 
	gMuÉiB™S–BloomF‹r
::
	$MuÉiB™S–BloomF‹r
(
¡ršg
 
¡r
)

39 
veùÜ
<
¡ršg
> 
™ems
;

40 
	`tok’ize
(
™ems
, 
¡r
, '_');

41 
	`as£¹
(
™ems
.
	`size
() == 4);

44 
m_f‹r_size
 = 
	`©oi
(
™ems
[0].
	`c_¡r
());

45 
m_num_hashes
 = 
	`©oi
(
™ems
[1].
	`c_¡r
());

46 
m_sk_b™s
 = 
	`©oi
(
™ems
[2].
	`c_¡r
());

48 ià(
™ems
[3] == "Regular") {

49 
isP¬®Ël
 = 
çl£
;

50 } ià(
™ems
[3] == "Parallel") {

51 
isP¬®Ël
 = 
Œue
;

53 
	`·nic
("ERROR: Incorrect config string for MultiBitSel Bloom! :%s",

54 
¡r
);

57 
m_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_f‹r_size
);

59 
m_·r_f‹r_size
 = 
m_f‹r_size
 / 
m_num_hashes
;

60 
m_·r_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_·r_f‹r_size
);

62 
m_f‹r
.
	`»size
(
m_f‹r_size
);

63 
	`ş—r
();

64 
	}
}

66 
	gMuÉiB™S–BloomF‹r
::~
	$MuÉiB™S–BloomF‹r
()

68 
	}
}

71 
MuÉiB™S–BloomF‹r
::
	$ş—r
()

73 
i
 = 0; i < 
m_f‹r_size
; i++) {

74 
m_f‹r
[
i
] = 0;

76 
	}
}

79 
	gMuÉiB™S–BloomF‹r
::
	$šüem’t
(
Addr
 
addr
)

82 
	}
}

86 
MuÉiB™S–BloomF‹r
::
	$deüem’t
(
Addr
 
addr
)

89 
	}
}

92 
MuÉiB™S–BloomF‹r
::
	$m”ge
(
Ab¡¿ùBloomF‹r
 *
Ùh”_f‹r
)

95 
MuÉiB™S–BloomF‹r
 * 
‹mp
 = (MuÉiB™S–BloomF‹r*è
Ùh”_f‹r
;

96 
i
 = 0; i < 
m_f‹r_size
; ++i){

97 
m_f‹r
[
i
] |ğ(*
‹mp
)[i];

99 
	}
}

102 
	gMuÉiB™S–BloomF‹r
::
	$£t
(
Addr
 
addr
)

104 
i
 = 0; i < 
m_num_hashes
; i++) {

105 
idx
 = 
	`g‘_šdex
(
addr
, 
i
);

106 
m_f‹r
[
idx
] = 1;

108 
	}
}

111 
	gMuÉiB™S–BloomF‹r
::
	$un£t
(
Addr
 
addr
)

113 
cout
 << "ERROR: Unset should‚ever be called in‡ Bloom filter";

114 
	`as£¹
(0);

115 
	}
}

117 
boŞ


118 
	gMuÉiB™S–BloomF‹r
::
	$isS‘
(
Addr
 
addr
)

120 
boŞ
 
»s
 = 
Œue
;

122 
i
=0; i < 
m_num_hashes
; i++) {

123 
idx
 = 
	`g‘_šdex
(
addr
, 
i
);

124 
»s
 =„e && 
m_f‹r
[
idx
];

126  
»s
;

127 
	}
}

130 
	gMuÉiB™S–BloomF‹r
::
	$g‘CouÁ
(
Addr
 
addr
)

132  
	`isS‘
(
addr
)? 1: 0;

133 
	}
}

136 
	gMuÉiB™S–BloomF‹r
::
	$g‘Index
(
Addr
 
addr
)

139 
	}
}

142 
	gMuÉiB™S–BloomF‹r
::
	$»adB™
(cÚ¡ 
šdex
)

145 
	}
}

148 
	gMuÉiB™S–BloomF‹r
::
	$wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
)

150 
	}
}

153 
	gMuÉiB™S–BloomF‹r
::
	$g‘TÙ®CouÁ
()

155 
couÁ
 = 0;

157 
i
 = 0; i < 
m_f‹r_size
; i++) {

158 
couÁ
 +ğ
m_f‹r
[
i
];

160  
couÁ
;

161 
	}
}

164 
	gMuÉiB™S–BloomF‹r
::
	$´št
(
o¡»am
& 
out
) const

166 
	}
}

169 
MuÉiB™S–BloomF‹r
::
	$g‘_šdex
(
Addr
 
addr
, 
i
)

174 
ušt64_t
 
x
 = (
	`makeLšeAdd»ss
(
addr
è>> 
m_sk_b™s
);

175 
y
 = 
	`hash_b™£l
(
x
, 
i
, 
m_num_hashes
, 30, 
m_f‹r_size_b™s
);

178 ià(
isP¬®Ël
) {

179  (
y
 % 
m_·r_f‹r_size
è+ 
i
*m_par_filter_size;

181  
y
 % 
m_f‹r_size
;

183 
	}
}

186 
	gMuÉiB™S–BloomF‹r
::
	$hash_b™£l
(
ušt64_t
 
v®ue
, 
šdex
, 
jump
,

187 
maxB™s
, 
numB™s
)

189 
ušt64_t
 
mask
 = 1;

190 
»suÉ
 = 0;

191 
b™
, 
i
;

193 
i
 = 0; i < 
numB™s
; i++) {

194 
b™
 = (
šdex
 + 
jump
*
i
è% 
maxB™s
;

195 ià(
v®ue
 & (
mask
 << 
b™
)è
»suÉ
 +ğmask << 
i
;

197  
»suÉ
;

198 
	}
}

	@ruby/filters/MultiBitSelBloomFilter.hh

29 #iâdeà
__MEM_RUBY_FILTERS_MULTIBITSELBLOOMFILTER_HH__


30 
	#__MEM_RUBY_FILTERS_MULTIBITSELBLOOMFILTER_HH__


	)

32 
	~<io¡»am
>

33 
	~<¡ršg
>

34 
	~<veùÜ
>

36 
	~"mem/ruby/commÚ/Add»ss.hh
"

37 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

38 
	~"mem/ruby/f‹rs/Ab¡¿ùBloomF‹r.hh
"

40 şas 
	cMuÉiB™S–BloomF‹r
 : 
public
 
Ab¡¿ùBloomF‹r


42 
public
:

43 
MuÉiB™S–BloomF‹r
(
¡d
::
¡ršg
 
cÚfig
);

44 ~
MuÉiB™S–BloomF‹r
();

46 
ş—r
();

47 
šüem’t
(
Addr
 
addr
);

48 
deüem’t
(
Addr
 
addr
);

49 
m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
);

50 
£t
(
Addr
 
addr
);

51 
un£t
(
Addr
 
addr
);

53 
boŞ
 
isS‘
(
Addr
 
addr
);

54 
g‘CouÁ
(
Addr
 
addr
);

55 
g‘TÙ®CouÁ
();

56 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

58 
	`g‘Index
(
Addr
 
addr
);

59 
	`»adB™
(cÚ¡ 
šdex
);

60 
	`wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
);

63 
İ”©Ü
[](cÚ¡ 
šdex
) const

65  
this
->
m_f‹r
[
šdex
];

68 
´iv©e
:

69 
	`g‘_šdex
(
Addr
 
addr
, 
hashNumb”
);

71 
	`hash_b™£l
(
ušt64_t
 
v®ue
, 
šdex
, 
jump
, 
maxB™s
,

72 
numB™s
);

74 
¡d
::
veùÜ
<> 
m_f‹r
;

75 
m_f‹r_size
;

76 
m_num_hashes
;

77 
m_f‹r_size_b™s
;

78 
m_sk_b™s
;

80 
m_·r_f‹r_size
;

81 
m_·r_f‹r_size_b™s
;

83 
boŞ
 
isP¬®Ël
;

84 
	}
};

	@ruby/filters/MultiGrainBloomFilter.cc

29 
	~"ba£/štm©h.hh
"

30 
	~"ba£/¡r.hh
"

31 
	~"mem/ruby/f‹rs/MuÉiG¿šBloomF‹r.hh
"

32 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

34 
usšg
 
Çme¥aû
 
	g¡d
;

36 
	gMuÉiG¿šBloomF‹r
::
	$MuÉiG¿šBloomF‹r
(
h—d
, 

)

40 
m_f‹r_size
 = 
h—d
;

41 
m_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_f‹r_size
);

43 
m_·ge_f‹r_size
 = 

;

44 
m_·ge_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_·ge_f‹r_size
);

46 
m_f‹r
.
	`»size
(
m_f‹r_size
);

47 
m_·ge_f‹r
.
	`»size
(
m_·ge_f‹r_size
);

48 
	`ş—r
();

49 
	}
}

51 
	gMuÉiG¿šBloomF‹r
::~
	$MuÉiG¿šBloomF‹r
()

53 
	}
}

56 
MuÉiG¿šBloomF‹r
::
	$ş—r
()

58 
i
 = 0; i < 
m_f‹r_size
; i++) {

59 
m_f‹r
[
i
] = 0;

61 
i
=0; i < 
m_·ge_f‹r_size
; ++i){

62 
m_·ge_f‹r
[
i
] = 0;

64 
	}
}

67 
	gMuÉiG¿šBloomF‹r
::
	$šüem’t
(
Addr
 
addr
)

70 
	}
}

74 
MuÉiG¿šBloomF‹r
::
	$deüem’t
(
Addr
 
addr
)

77 
	}
}

80 
MuÉiG¿šBloomF‹r
::
	$m”ge
(
Ab¡¿ùBloomF‹r
 *
Ùh”_f‹r
)

83 
	}
}

86 
MuÉiG¿šBloomF‹r
::
	$£t
(
Addr
 
addr
)

88 
i
 = 
	`g‘_block_šdex
(
addr
);

89 
	`as£¹
(
i
 < 
m_f‹r_size
);

90 
	`as£¹
(
	`g‘_·ge_šdex
(
addr
è< 
m_·ge_f‹r_size
);

91 
m_f‹r
[
i
] = 1;

92 
m_·ge_f‹r
[
i
] = 1;

94 
	}
}

97 
	gMuÉiG¿šBloomF‹r
::
	$un£t
(
Addr
 
addr
)

100 
	}
}

102 
boŞ


103 
MuÉiG¿šBloomF‹r
::
	$isS‘
(
Addr
 
addr
)

105 
i
 = 
	`g‘_block_šdex
(
addr
);

106 
	`as£¹
(
i
 < 
m_f‹r_size
);

107 
	`as£¹
(
	`g‘_·ge_šdex
(
addr
è< 
m_·ge_f‹r_size
);

109  (
m_f‹r
[
i
] && 
m_·ge_f‹r
[i]);

110 
	}
}

113 
	gMuÉiG¿šBloomF‹r
::
	$g‘CouÁ
(
Addr
 
addr
)

117 
	}
}

120 
	gMuÉiG¿šBloomF‹r
::
	$g‘TÙ®CouÁ
()

122 
couÁ
 = 0;

124 
i
 = 0; i < 
m_f‹r_size
; i++) {

125 
couÁ
 +ğ
m_f‹r
[
i
];

128 
i
=0; i < 
m_·ge_f‹r_size
; ++i) {

129 
couÁ
 +ğ
m_·ge_f‹r
[
i
] = 0;

132  
couÁ
;

133 
	}
}

136 
	gMuÉiG¿šBloomF‹r
::
	$g‘Index
(
Addr
 
addr
)

140 
	}
}

143 
	gMuÉiG¿šBloomF‹r
::
	$»adB™
(cÚ¡ 
šdex
)

147 
	}
}

150 
	gMuÉiG¿šBloomF‹r
::
	$wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
)

153 
	}
}

156 
	gMuÉiG¿šBloomF‹r
::
	$´št
(
o¡»am
& 
out
) const

158 
	}
}

161 
MuÉiG¿šBloomF‹r
::
	$g‘_block_šdex
(
Addr
 
addr
)

164  
	`b™S–eù
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeB™s
(),

165 
RubySy¡em
::
	`g‘BlockSizeB™s
() +

166 
m_f‹r_size_b™s
 - 1);

167 
	}
}

170 
	gMuÉiG¿šBloomF‹r
::
	$g‘_·ge_šdex
(
Addr
 
addr
)

172 
b™s
 = 
RubySy¡em
::
	`g‘BlockSizeB™s
(è+ 
m_f‹r_size_b™s
 - 1;

175  
	`b™S–eù
(
addr
, 
b™s
, b™ + 
m_·ge_f‹r_size_b™s
 - 1);

176 
	}
}

	@ruby/filters/MultiGrainBloomFilter.hh

29 #iâdeà
__MEM_RUBY_FILTERS_MULTIGRAINBLOOMFILTER_HH__


30 
	#__MEM_RUBY_FILTERS_MULTIGRAINBLOOMFILTER_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 
	~"mem/ruby/f‹rs/Ab¡¿ùBloomF‹r.hh
"

38 şas 
	cMuÉiG¿šBloomF‹r
 : 
public
 
Ab¡¿ùBloomF‹r


40 
public
:

41 
MuÉiG¿šBloomF‹r
(
h—d
, 

);

42 ~
MuÉiG¿šBloomF‹r
();

44 
ş—r
();

45 
šüem’t
(
Addr
 
addr
);

46 
deüem’t
(
Addr
 
addr
);

47 
m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
);

48 
£t
(
Addr
 
addr
);

49 
un£t
(
Addr
 
addr
);

51 
boŞ
 
isS‘
(
Addr
 
addr
);

52 
g‘CouÁ
(
Addr
 
addr
);

53 
g‘TÙ®CouÁ
();

54 
g‘Index
(
Addr
 
addr
);

55 
»adB™
(cÚ¡ 
šdex
);

56 
wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
);

58 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

60 
´iv©e
:

61 
	`g‘_block_šdex
(
Addr
 
addr
);

62 
	`g‘_·ge_šdex
(
Addr
 
addr
);

65 
¡d
::
veùÜ
<> 
m_f‹r
;

66 
m_f‹r_size
;

67 
m_f‹r_size_b™s
;

69 
¡d
::
veùÜ
<> 
m_·ge_f‹r
;

70 
m_·ge_f‹r_size
;

71 
m_·ge_f‹r_size_b™s
;

	@ruby/filters/NonCountingBloomFilter.cc

29 
	~"ba£/štm©h.hh
"

30 
	~"ba£/¡r.hh
"

31 
	~"mem/ruby/f‹rs/NÚCouÁšgBloomF‹r.hh
"

32 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

34 
usšg
 
Çme¥aû
 
	g¡d
;

36 
	gNÚCouÁšgBloomF‹r
::
	$NÚCouÁšgBloomF‹r
(
h—d
, 

)

39 
m_f‹r_size
 = 
h—d
;

40 
m_off£t
 = 

;

41 
m_f‹r_size_b™s
 = 
	`æoÜLog2
(
m_f‹r_size
);

43 
m_f‹r
.
	`»size
(
m_f‹r_size
);

44 
	`ş—r
();

45 
	}
}

47 
	gNÚCouÁšgBloomF‹r
::~
	$NÚCouÁšgBloomF‹r
()

49 
	}
}

52 
NÚCouÁšgBloomF‹r
::
	$ş—r
()

54 
i
 = 0; i < 
m_f‹r_size
; i++) {

55 
m_f‹r
[
i
] = 0;

57 
	}
}

60 
	gNÚCouÁšgBloomF‹r
::
	$šüem’t
(
Addr
 
addr
)

63 
	}
}

66 
NÚCouÁšgBloomF‹r
::
	$deüem’t
(
Addr
 
addr
)

69 
	}
}

72 
NÚCouÁšgBloomF‹r
::
	$m”ge
(
Ab¡¿ùBloomF‹r
 *
Ùh”_f‹r
)

75 
NÚCouÁšgBloomF‹r
 * 
‹mp
 = (NÚCouÁšgBloomF‹r*è
Ùh”_f‹r
;

76 
i
 = 0; i < 
m_f‹r_size
; ++i){

77 
m_f‹r
[
i
] |ğ(*
‹mp
)[i];

79 
	}
}

82 
	gNÚCouÁšgBloomF‹r
::
	$£t
(
Addr
 
addr
)

84 
i
 = 
	`g‘_šdex
(
addr
);

85 
m_f‹r
[
i
] = 1;

86 
	}
}

89 
	gNÚCouÁšgBloomF‹r
::
	$un£t
(
Addr
 
addr
)

91 
i
 = 
	`g‘_šdex
(
addr
);

92 
m_f‹r
[
i
] = 0;

93 
	}
}

95 
boŞ


96 
	gNÚCouÁšgBloomF‹r
::
	$isS‘
(
Addr
 
addr
)

98 
i
 = 
	`g‘_šdex
(
addr
);

99  (
m_f‹r
[
i
]);

100 
	}
}

104 
	gNÚCouÁšgBloomF‹r
::
	$g‘CouÁ
(
Addr
 
addr
)

106  
m_f‹r
[
	`g‘_šdex
(
addr
)];

107 
	}
}

110 
	gNÚCouÁšgBloomF‹r
::
	$g‘TÙ®CouÁ
()

112 
couÁ
 = 0;

114 
i
 = 0; i < 
m_f‹r_size
; i++) {

115 
couÁ
 +ğ
m_f‹r
[
i
];

117  
couÁ
;

118 
	}
}

121 
	gNÚCouÁšgBloomF‹r
::
	$´št
(
o¡»am
& 
out
) const

123 
	}
}

126 
NÚCouÁšgBloomF‹r
::
	$g‘Index
(
Addr
 
addr
)

128  
	`g‘_šdex
(
addr
);

129 
	}
}

132 
	gNÚCouÁšgBloomF‹r
::
	$»adB™
(cÚ¡ 
šdex
)

134  
m_f‹r
[
šdex
];

135 
	}
}

138 
	gNÚCouÁšgBloomF‹r
::
	$wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
)

140 
m_f‹r
[
šdex
] = 
v®ue
;

141 
	}
}

144 
	gNÚCouÁšgBloomF‹r
::
	$g‘_šdex
(
Addr
 
addr
)

146  
	`b™S–eù
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeB™s
(è+ 
m_off£t
,

147 
RubySy¡em
::
	`g‘BlockSizeB™s
(è+ 
m_off£t
 +

148 
m_f‹r_size_b™s
 - 1);

149 
	}
}

	@ruby/filters/NonCountingBloomFilter.hh

29 #iâdeà
__MEM_RUBY_FILTERS_NONCOUNTINGBLOOMFILTER_HH__


30 
	#__MEM_RUBY_FILTERS_NONCOUNTINGBLOOMFILTER_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 
	~"mem/ruby/f‹rs/Ab¡¿ùBloomF‹r.hh
"

38 şas 
	cNÚCouÁšgBloomF‹r
 : 
public
 
Ab¡¿ùBloomF‹r


40 
public
:

41 
NÚCouÁšgBloomF‹r
(
h—d
, 

);

42 ~
NÚCouÁšgBloomF‹r
();

44 
ş—r
();

45 
šüem’t
(
Addr
 
addr
);

46 
deüem’t
(
Addr
 
addr
);

47 
m”ge
(
Ab¡¿ùBloomF‹r
 * 
Ùh”_f‹r
);

48 
£t
(
Addr
 
addr
);

49 
un£t
(
Addr
 
addr
);

51 
boŞ
 
isS‘
(
Addr
 
addr
);

52 
g‘CouÁ
(
Addr
 
addr
);

53 
g‘TÙ®CouÁ
();

55 
g‘Index
(
Addr
 
addr
);

56 
»adB™
(cÚ¡ 
šdex
);

57 
wr™eB™
(cÚ¡ 
šdex
, cÚ¡ 
v®ue
);

59 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

62 
İ”©Ü
[](cÚ¡ 
šdex
) const

64  
this
->
m_f‹r
[
šdex
];

67 
´iv©e
:

68 
	`g‘_šdex
(
Addr
 
addr
);

70 
¡d
::
veùÜ
<> 
m_f‹r
;

71 
m_f‹r_size
;

72 
m_off£t
;

73 
m_f‹r_size_b™s
;

74 
	}
};

	@ruby/network/BasicLink.cc

29 
	~"mem/ruby/ÃtwÜk/BasicLšk.hh
"

31 
	gBasicLšk
::
	$BasicLšk
(cÚ¡ 
P¬ams
 *
p
)

32 : 
	$SimObjeù
(
p
)

34 
m_Ï‹ncy
 = 
p
->
Ï‹ncy
;

35 
m_bªdwidth_çùÜ
 = 
p
->
bªdwidth_çùÜ
;

36 
m_weight
 = 
p
->
weight
;

37 
	}
}

40 
	gBasicLšk
::
	$š™
()

42 
	}
}

45 
BasicLšk
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

47 
out
 << 
	`Çme
();

48 
	}
}

50 
BasicLšk
 *

51 
	gBasicLškP¬ams
::
	$ü—‹
()

53  
Ãw
 
	`BasicLšk
(
this
);

54 
	}
}

56 
	gBasicExtLšk
::
	$BasicExtLšk
(cÚ¡ 
P¬ams
 *
p
)

57 : 
	$BasicLšk
(
p
)

59 
	}
}

61 
BasicExtLšk
 *

62 
BasicExtLškP¬ams
::
	$ü—‹
()

64  
Ãw
 
	`BasicExtLšk
(
this
);

65 
	}
}

67 
	gBasicIÁLšk
::
	$BasicIÁLšk
(cÚ¡ 
P¬ams
 *
p
)

68 : 
	$BasicLšk
(
p
)

70 
	}
}

72 
BasicIÁLšk
 *

73 
BasicIÁLškP¬ams
::
	$ü—‹
()

75  
Ãw
 
	`BasicIÁLšk
(
this
);

76 
	}
}

	@ruby/network/BasicLink.hh

29 #iâdeà
__MEM_RUBY_NETWORK_BASIC_LINK_HH__


30 
	#__MEM_RUBY_NETWORK_BASIC_LINK_HH__


	)

32 
	~<io¡»am
>

33 
	~<¡ršg
>

34 
	~<veùÜ
>

36 
	~"·¿ms/BasicExtLšk.hh
"

37 
	~"·¿ms/BasicIÁLšk.hh
"

38 
	~"·¿ms/BasicLšk.hh
"

39 
	~"mem/ruby/ÃtwÜk/BasicRou‹r.hh
"

40 
	~"mem/ruby/ÃtwÜk/TİŞogy.hh
"

41 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCÚŒŞËr.hh
"

42 
	~"sim/sim_objeù.hh
"

44 şas 
	cBasicLšk
 : 
public
 
SimObjeù


46 
public
:

47 
BasicLškP¬ams
 
	tP¬ams
;

48 
BasicLšk
(cÚ¡ 
P¬ams
 *
p
);

49 cÚ¡ 
P¬ams
 *
	$·¿ms
(ècÚ¡ {  (cÚ¡ 
P¬ams
 *)
_·¿ms
; }

51 
	`š™
();

53 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

55 
Cyşes
 
m_Ï‹ncy
;

56 
m_bªdwidth_çùÜ
;

57 
m_weight
;

58 
	}
};

60 
šlše
 
	g¡d
::
o¡»am
&

61 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gBasicLšk
& 
	gobj
)

63 
	gobj
.
´št
(
out
);

64 
	gout
 << 
	g¡d
::
æush
;

65  
	gout
;

68 şas 
	cBasicExtLšk
 : 
public
 
BasicLšk


70 
public
:

71 
BasicExtLškP¬ams
 
	tP¬ams
;

72 
BasicExtLšk
(cÚ¡ 
P¬ams
 *
p
);

73 cÚ¡ 
P¬ams
 *
	$·¿ms
(ècÚ¡ {  (cÚ¡ 
P¬ams
 *)
_·¿ms
; }

75 
ä›nd
 
şass
 
TİŞogy
;

76 
	}
};

78 şas 
	cBasicIÁLšk
 : 
public
 
BasicLšk


80 
public
:

81 
BasicIÁLškP¬ams
 
	tP¬ams
;

82 
BasicIÁLšk
(cÚ¡ 
P¬ams
 *
p
);

83 cÚ¡ 
P¬ams
 *
	$·¿ms
(ècÚ¡ {  (cÚ¡ 
P¬ams
 *)
_·¿ms
; }

85 
ä›nd
 
şass
 
TİŞogy
;

86 
	}
};

	@ruby/network/BasicRouter.cc

29 
	~"mem/ruby/ÃtwÜk/BasicRou‹r.hh
"

31 
	gBasicRou‹r
::
	$BasicRou‹r
(cÚ¡ 
P¬ams
 *
p
)

32 : 
	$ClockedObjeù
(
p
)

34 
m_id
 = 
p
->
rou‹r_id
;

35 
m_Ï‹ncy
 = 
p
->
Ï‹ncy
;

36 
	}
}

39 
	gBasicRou‹r
::
	$š™
()

41 
	}
}

44 
BasicRou‹r
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

46 
out
 << 
	`Çme
();

47 
	}
}

49 
BasicRou‹r
 *

50 
	gBasicRou‹rP¬ams
::
	$ü—‹
()

52  
Ãw
 
	`BasicRou‹r
(
this
);

53 
	}
}

	@ruby/network/BasicRouter.hh

29 #iâdeà
__MEM_RUBY_NETWORK_BASIC_ROUTER_HH__


30 
	#__MEM_RUBY_NETWORK_BASIC_ROUTER_HH__


	)

32 
	~<io¡»am
>

33 
	~<¡ršg
>

34 
	~<veùÜ
>

36 
	~"·¿ms/BasicRou‹r.hh
"

37 
	~"sim/şocked_objeù.hh
"

39 şas 
	cBasicRou‹r
 : 
public
 
ClockedObjeù


41 
public
:

42 
BasicRou‹rP¬ams
 
	tP¬ams
;

43 
BasicRou‹r
(cÚ¡ 
P¬ams
 *
p
);

44 cÚ¡ 
P¬ams
 *
	$·¿ms
(ècÚ¡ {  (cÚ¡ 
P¬ams
 *)
_·¿ms
; }

46 
	`š™
();

48 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

49 
´Ùeùed
:

53 
ušt32_t
 
m_id
;

54 
ušt32_t
 
m_Ï‹ncy
;

55 
	}
};

57 
šlše
 
	g¡d
::
o¡»am
&

58 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gBasicRou‹r
& 
	gobj
)

60 
	gobj
.
´št
(
out
);

61 
	gout
 << 
	g¡d
::
æush
;

62  
	gout
;

	@ruby/network/MessageBuffer.cc

29 
	~<ÿs£¹
>

31 
	~"ba£/ırštf.hh
"

32 
	~"ba£/misc.hh
"

33 
	~"ba£/¿ndom.hh
"

34 
	~"ba£/¡l_h–³rs.hh
"

35 
	~"debug/RubyQueue.hh
"

36 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

37 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

39 
usšg
 
Çme¥aû
 
	g¡d
;

40 
usšg
 
	gm5
::
¡l_h–³rs
::
İ”©Ü
<<;

42 
	gMes§geBufãr
::
	$Mes§geBufãr
(cÚ¡ 
P¬ams
 *
p
)

43 : 
	`SimObjeù
(
p
),

44 
	`m_max_size
(
p
->
bufãr_size
), 
	`m_time_Ï¡_time_size_checked
(0),

45 
	`m_time_Ï¡_time_’queue
(0), 
	`m_time_Ï¡_time_pİ
(0),

46 
	`m_Ï¡_¬riv®_time
(0), 
	`m_¡riù_fifo
(
p
->
Üd”ed
),

47 
	`m_¿ndomiz©iÚ
(
p
->
¿ndomiz©iÚ
)

49 
m_msg_couÁ”
 = 0;

50 
m_cÚsum”
 = 
NULL
;

51 
m_size_Ï¡_time_size_checked
 = 0;

52 
m_size_©_cyşe_¡¬t
 = 0;

53 
m_msgs_this_cyşe
 = 0;

54 
m_nÙ_ava_couÁ
 = 0;

55 
m_´iÜ™y_¿nk
 = 0;

57 
m_¡®l_msg_m­
.
	`ş—r
();

58 
m_šput_lšk_id
 = 0;

59 
m_vÃt_id
 = 0;

60 
	}
}

63 
	gMes§geBufãr
::
	$g‘Size
(
Tick
 
curTime
)

65 ià(
m_time_Ï¡_time_size_checked
 !ğ
curTime
) {

66 
m_time_Ï¡_time_size_checked
 = 
curTime
;

67 
m_size_Ï¡_time_size_checked
 = 
m_´io_h—p
.
	`size
();

70  
m_size_Ï¡_time_size_checked
;

71 
	}
}

73 
boŞ


74 
	gMes§geBufãr
::
	$¬eNSlÙsAvaabË
(
n
, 
Tick
 
cu¼’t_time
)

78 ià(
m_max_size
 == 0) {

79  
Œue
;

86 
cu¼’t_size
 = 0;

88 ià(
m_time_Ï¡_time_pİ
 < 
cu¼’t_time
) {

90 
cu¼’t_size
 = 
m_´io_h—p
.
	`size
();

92 ià(
m_time_Ï¡_time_’queue
 < 
cu¼’t_time
) {

94 
cu¼’t_size
 = 
m_size_©_cyşe_¡¬t
;

98 
cu¼’t_size
 = 
m_size_©_cyşe_¡¬t
 + 
m_msgs_this_cyşe
;

103 ià(
cu¼’t_size
 + 
n
 <ğ
m_max_size
) {

104  
Œue
;

106 
	`DPRINTF
(
RubyQueue
, "n: %d, current_size: %d, heap size: %d, "

108 
n
, 
cu¼’t_size
, 
m_´io_h—p
.
	`size
(), 
m_max_size
);

109 
m_nÙ_ava_couÁ
++;

110  
çl£
;

112 
	}
}

114 cÚ¡ 
Mes§ge
*

115 
	gMes§geBufãr
::
	$³ek
() const

117 
	`DPRINTF
(
RubyQueue
, "Peeking‡t head of queue.\n");

118 cÚ¡ 
Mes§ge
* 
msg_±r
 = 
m_´io_h—p
.
	`äÚt
().
	`g‘
();

119 
	`as£¹
(
msg_±r
);

121 
	`DPRINTF
(
RubyQueue
, "Mes§ge: %s\n", (*
msg_±r
));

122  
msg_±r
;

123 
	}
}

126 
Tick


127 
	$¿ndom_time
()

129 
Tick
 
time
 = 1;

130 
time
 +ğ
¿ndom_mt
.
	`¿ndom
(0, 3);

131 ià(
¿ndom_mt
.
	`¿ndom
(0, 7) == 0) {

132 
time
 +ğ100 + 
¿ndom_mt
.
	`¿ndom
(1, 15);

134  
time
;

135 
	}
}

138 
	gMes§geBufãr
::
	$’queue
(
MsgPŒ
 
mes§ge
, 
Tick
 
cu¼’t_time
, Tick 
d–
)

141 ià(
m_time_Ï¡_time_’queue
 < 
cu¼’t_time
) {

142 
m_msgs_this_cyşe
 = 0;

143 
m_time_Ï¡_time_’queue
 = 
cu¼’t_time
;

146 
m_msg_couÁ”
++;

147 
m_msgs_this_cyşe
++;

151 
	`as£¹
(
d–
 > 0);

152 
Tick
 
¬riv®_time
 = 0;

154 ià(!
RubySy¡em
::
	`g‘Rªdomiz©iÚ
(è|| !
m_¿ndomiz©iÚ
) {

156 
¬riv®_time
 = 
cu¼’t_time
 + 
d–
;

159 ià(
m_¡riù_fifo
) {

160 ià(
m_Ï¡_¬riv®_time
 < 
cu¼’t_time
) {

161 
m_Ï¡_¬riv®_time
 = 
cu¼’t_time
;

163 
¬riv®_time
 = 
m_Ï¡_¬riv®_time
 + 
	`¿ndom_time
();

165 
¬riv®_time
 = 
cu¼’t_time
 + 
	`¿ndom_time
();

170 
	`as£¹
(
¬riv®_time
 > 
cu¼’t_time
);

171 ià(
m_¡riù_fifo
) {

172 ià(
¬riv®_time
 < 
m_Ï¡_¬riv®_time
) {

173 
	`·nic
("FIFO ordering violated: %s‚ame: %s currentime: %d "

175 *
this
, 
	`Çme
(), 
cu¼’t_time
, 
d–
, 
¬riv®_time
,

176 
m_Ï¡_¬riv®_time
);

181 ià(!
RubySy¡em
::
	`g‘W¬mupEÇbËd
()) {

182 
m_Ï¡_¬riv®_time
 = 
¬riv®_time
;

186 
Mes§ge
* 
msg_±r
 = 
mes§ge
.
	`g‘
();

187 
	`as£¹
(
msg_±r
 !ğ
NULL
);

189 
	`as£¹
(
cu¼’t_time
 >ğ
msg_±r
->
	`g‘La¡EnqueueTime
() &&

192 
msg_±r
->
	`upd©eD–ayedTicks
(
cu¼’t_time
);

193 
msg_±r
->
	`£tLa¡EnqueueTime
(
¬riv®_time
);

194 
msg_±r
->
	`£tMsgCouÁ”
(
m_msg_couÁ”
);

197 
m_´io_h—p
.
	`push_back
(
mes§ge
);

198 
	`push_h—p
(
m_´io_h—p
.
	`begš
(), m_´io_h—p.
	`’d
(), 
g»©”
<
MsgPŒ
>());

200 
	`DPRINTF
(
RubyQueue
, "Enqueue‡rrival_time: %lld, Message: %s\n",

201 
¬riv®_time
, *(
mes§ge
.
	`g‘
()));

204 
	`as£¹
(
m_cÚsum”
 !ğ
NULL
);

205 
m_cÚsum”
->
	`scheduËEv’tAbsŞu‹
(
¬riv®_time
);

206 
m_cÚsum”
->
	`¡ÜeEv’tInfo
(
m_vÃt_id
);

207 
	}
}

209 
Tick


210 
	gMes§geBufãr
::
	$dequeue
(
Tick
 
cu¼’t_time
)

212 
	`DPRINTF
(
RubyQueue
, "Popping\n");

213 
	`as£¹
(
	`isR—dy
(
cu¼’t_time
));

216 
MsgPŒ
 
mes§ge
 = 
m_´io_h—p
.
	`äÚt
();

219 
mes§ge
->
	`upd©eD–ayedTicks
(
cu¼’t_time
);

220 
Tick
 
d–ay
 = 
mes§ge
->
	`g‘D–ayedTicks
();

224 ià(
m_time_Ï¡_time_pİ
 < 
cu¼’t_time
) {

225 
m_size_©_cyşe_¡¬t
 = 
m_´io_h—p
.
	`size
();

226 
m_time_Ï¡_time_pİ
 = 
cu¼’t_time
;

229 
	`pİ_h—p
(
m_´io_h—p
.
	`begš
(), m_´io_h—p.
	`’d
(), 
g»©”
<
MsgPŒ
>());

230 
m_´io_h—p
.
	`pİ_back
();

232  
d–ay
;

233 
	}
}

236 
	gMes§geBufãr
::
	$ş—r
()

238 
m_´io_h—p
.
	`ş—r
();

240 
m_msg_couÁ”
 = 0;

241 
m_time_Ï¡_time_’queue
 = 0;

242 
m_time_Ï¡_time_pİ
 = 0;

243 
m_size_©_cyşe_¡¬t
 = 0;

244 
m_msgs_this_cyşe
 = 0;

245 
	}
}

248 
	gMes§geBufãr
::
	$»cyşe
(
Tick
 
cu¼’t_time
, Tick 
»cyşe_Ï‹ncy
)

250 
	`DPRINTF
(
RubyQueue
, "Recycling.\n");

251 
	`as£¹
(
	`isR—dy
(
cu¼’t_time
));

252 
MsgPŒ
 
node
 = 
m_´io_h—p
.
	`äÚt
();

253 
	`pİ_h—p
(
m_´io_h—p
.
	`begš
(), m_´io_h—p.
	`’d
(), 
g»©”
<
MsgPŒ
>());

255 
Tick
 
futu»_time
 = 
cu¼’t_time
 + 
»cyşe_Ï‹ncy
;

256 
node
->
	`£tLa¡EnqueueTime
(
futu»_time
);

258 
m_´io_h—p
.
	`back
(èğ
node
;

259 
	`push_h—p
(
m_´io_h—p
.
	`begš
(), m_´io_h—p.
	`’d
(), 
g»©”
<
MsgPŒ
>());

260 
m_cÚsum”
->
	`scheduËEv’tAbsŞu‹
(
futu»_time
);

261 
	}
}

264 
	gMes§geBufãr
::
»ª®yzeLi¡
(
li¡
<
MsgPŒ
> &
É
, 
Tick
 
schdTick
)

266 !
	gÉ
.
em±y
()) {

267 
	gm_msg_couÁ”
++;

268 
MsgPŒ
 
	gm
 = 
É
.
äÚt
();

269 
	gm
->
£tLa¡EnqueueTime
(
schdTick
);

270 
	gm
->
£tMsgCouÁ”
(
m_msg_couÁ”
);

272 
	gm_´io_h—p
.
push_back
(
m
);

273 
push_h—p
(
m_´io_h—p
.
begš
(), m_´io_h—p.
’d
(),

274 
g»©”
<
MsgPŒ
>());

276 
	gm_cÚsum”
->
scheduËEv’tAbsŞu‹
(
schdTick
);

277 
	gÉ
.
pİ_äÚt
();

282 
	gMes§geBufãr
::
	$»ª®yzeMes§ges
(
Addr
 
addr
, 
Tick
 
cu¼’t_time
)

284 
	`DPRINTF
(
RubyQueue
, "R—ÇlyzeMes§ge %#x\n", 
addr
);

285 
	`as£¹
(
m_¡®l_msg_m­
.
	`couÁ
(
addr
) > 0);

293 
	`»ª®yzeLi¡
(
m_¡®l_msg_m­
[
addr
], 
cu¼’t_time
);

294 
m_¡®l_msg_m­
.
	`”a£
(
addr
);

295 
	}
}

298 
	gMes§geBufãr
::
	$»ª®yzeAÎMes§ges
(
Tick
 
cu¼’t_time
)

300 
	`DPRINTF
(
RubyQueue
, "ReanalyzeAllMessages\n");

308 
SÎMsgM­Ty³
::
™”©Ü
 
m­_™”
 = 
m_¡®l_msg_m­
.
	`begš
();

309 
m­_™”
 !ğ
m_¡®l_msg_m­
.
	`’d
(); ++map_iter) {

310 
	`»ª®yzeLi¡
(
m­_™”
->
£cÚd
, 
cu¼’t_time
);

312 
m_¡®l_msg_m­
.
	`ş—r
();

313 
	}
}

316 
	gMes§geBufãr
::
	$¡®lMes§ge
(
Addr
 
addr
, 
Tick
 
cu¼’t_time
)

318 
	`DPRINTF
(
RubyQueue
, "SÎšg dutØ%#x\n", 
addr
);

319 
	`as£¹
(
	`isR—dy
(
cu¼’t_time
));

320 
	`as£¹
(
	`g‘Off£t
(
addr
) == 0);

321 
MsgPŒ
 
mes§ge
 = 
m_´io_h—p
.
	`äÚt
();

323 
	`dequeue
(
cu¼’t_time
);

330 (
m_¡®l_msg_m­
[
addr
]).
	`push_back
(
mes§ge
);

331 
	}
}

334 
	gMes§geBufãr
::
	$´št
(
o¡»am
& 
out
) const

336 
	`cırštf
(
out
, "[MessageBuffer: ");

337 ià(
m_cÚsum”
 !ğ
NULL
) {

338 
	`cırštf
(
out
, " consumer-yes ");

341 
veùÜ
<
MsgPŒ
> 
	`cİy
(
m_´io_h—p
);

342 
	`sÜt_h—p
(
cİy
.
	`begš
(), cİy.
	`’d
(), 
g»©”
<
MsgPŒ
>());

343 
	`cırštf
(
out
, "%s] %s", 
cİy
, 
	`Çme
());

344 
	}
}

346 
boŞ


347 
	gMes§geBufãr
::
	$isR—dy
(
Tick
 
cu¼’t_time
) const

349  ((
m_´io_h—p
.
	`size
() > 0) &&

350 (
m_´io_h—p
.
	`äÚt
()->
	`g‘La¡EnqueueTime
(è<ğ
cu¼’t_time
));

351 
	}
}

353 
ušt32_t


354 
	gMes§geBufãr
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

356 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

360 
i
 = 0; i < 
m_´io_h—p
.
	`size
(); ++i) {

361 
Mes§ge
 *
msg
 = 
m_´io_h—p
[
i
].
	`g‘
();

362 ià(
msg
->
	`funùiÚ®Wr™e
(
pkt
)) {

363 
num_funùiÚ®_wr™es
++;

369 
SÎMsgM­Ty³
::
™”©Ü
 
m­_™”
 = 
m_¡®l_msg_m­
.
	`begš
();

370 
m­_™”
 !ğ
m_¡®l_msg_m­
.
	`’d
();

371 ++
m­_™”
) {

373 
¡d
::
li¡
<
MsgPŒ
>::
™”©Ü
 
™
 = (
m­_™”
->
£cÚd
).
	`begš
();

374 
™
 !ğ(
m­_™”
->
£cÚd
).
	`’d
(); ++it) {

376 
Mes§ge
 *
msg
 = (*
™
).
	`g‘
();

377 ià(
msg
->
	`funùiÚ®Wr™e
(
pkt
)) {

378 
num_funùiÚ®_wr™es
++;

383  
num_funùiÚ®_wr™es
;

384 
	}
}

386 
Mes§geBufãr
 *

387 
	gMes§geBufãrP¬ams
::
	$ü—‹
()

389  
Ãw
 
	`Mes§geBufãr
(
this
);

390 
	}
}

	@ruby/network/MessageBuffer.hh

34 #iâdeà
__MEM_RUBY_BUFFERS_MESSAGEBUFFER_HH__


35 
	#__MEM_RUBY_BUFFERS_MESSAGEBUFFER_HH__


	)

37 
	~<®gÜ™hm
>

38 
	~<ÿs£¹
>

39 
	~<funùiÚ®
>

40 
	~<io¡»am
>

41 
	~<¡ršg
>

42 
	~<veùÜ
>

44 
	~"debug/RubyQueue.hh
"

45 
	~"mem/ruby/commÚ/Add»ss.hh
"

46 
	~"mem/ruby/commÚ/CÚsum”.hh
"

47 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

48 
	~"mem/·ck‘.hh
"

49 
	~"·¿ms/Mes§geBufãr.hh
"

50 
	~"sim/sim_objeù.hh
"

52 şas 
	cMes§geBufãr
 : 
public
 
SimObjeù


54 
public
:

55 
Mes§geBufãrP¬ams
 
	tP¬ams
;

56 
Mes§geBufãr
(cÚ¡ 
P¬ams
 *
p
);

58 
»ª®yzeMes§ges
(
Addr
 
addr
, 
Tick
 
cu¼’t_time
);

59 
»ª®yzeAÎMes§ges
(
Tick
 
cu¼’t_time
);

60 
¡®lMes§ge
(
Addr
 
addr
, 
Tick
 
cu¼’t_time
);

63 
boŞ
 
	$isR—dy
(
Tick
 
cu¼’t_time
) const;

66 
	$d–ayH—d
(
Tick
 
cu¼’t_time
, Tick 
d–
)

68 
MsgPŒ
 
m
 = 
m_´io_h—p
.
	`äÚt
();

69 
¡d
::
	`pİ_h—p
(
m_´io_h—p
.
	`begš
(), m_´io_h—p.
	`’d
(),

70 
¡d
::
g»©”
<
MsgPŒ
>());

71 
m_´io_h—p
.
	`pİ_back
();

72 
	`’queue
(
m
, 
cu¼’t_time
, 
d–
);

75 
boŞ
 
	`¬eNSlÙsAvaabË
(
n
, 
Tick
 
curTime
);

76 
	$g‘PriÜ™y
(è{  
m_´iÜ™y_¿nk
; 
	}
}

77 
	$£tPriÜ™y
(
¿nk
è{ 
m_´iÜ™y_¿nk
 =„ªk; 
	}
}

78 
	$£tCÚsum”
(
CÚsum”
* 
cÚsum”
)

80 
	`DPRINTF
(
RubyQueue
, "S‘tšg cÚsum”: %s\n", *
cÚsum”
);

81 ià(
m_cÚsum”
 !ğ
NULL
) {

82 
	`çl
("Tryingo connect %so MessageBuffer %s. \
\n%s‡lready connected. Checkhe cntrl_id's.\n",

84 *
cÚsum”
, *
this
, *
m_cÚsum”
);

86 
m_cÚsum”
 = 
cÚsum”
;

87 
	}
}

89 
CÚsum”
* 
	$g‘CÚsum”
(è{  
m_cÚsum”
; 
	}
}

91 
boŞ
 
	$g‘Ord”ed
(è{  
m_¡riù_fifo
; 
	}
}

95 cÚ¡ 
Mes§ge
* 
	$³ek
() const;

97 cÚ¡ 
MsgPŒ
 &
	$³ekMsgPŒ
(ècÚ¡ {  
m_´io_h—p
.
	`äÚt
(); 
	}
}

99 
’queue
(
MsgPŒ
 
mes§ge
, 
Tick
 
curTime
, Tick 
d–
);

103 
Tick
 
dequeue
(Tick 
cu¼’t_time
);

105 
»cyşe
(
Tick
 
cu¼’t_time
, Tick 
»cyşe_Ï‹ncy
);

106 
boŞ
 
	$isEm±y
(ècÚ¡ {  
m_´io_h—p
.
	`size
(è=ğ0; 
	}
}

107 
boŞ
 
	$isSÎM­Em±y
(è{  
m_¡®l_msg_m­
.
	`size
(è=ğ0; 
	}
}

108 
	$g‘SÎM­Size
(è{  
m_¡®l_msg_m­
.
	`size
(); 
	}
}

110 
g‘Size
(
Tick
 
curTime
);

112 
ş—r
();

113 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

114 
	$ş—rSts
(è{ 
m_nÙ_ava_couÁ
 = 0; 
m_msg_couÁ”
 = 0; 
	}
}

116 
	$£tIncomšgLšk
(
lšk_id
è{ 
m_šput_lšk_id
 =†šk_id; 
	}
}

117 
	$£tVÃt
(
Ãt
è{ 
m_vÃt_id
 =‚‘; 
	}
}

123 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

125 
	g´iv©e
:

126 
»ª®yzeLi¡
(
¡d
::
li¡
<
MsgPŒ
> &, 
Tick
);

128 
	g´iv©e
:

131 
CÚsum”
* 
m_cÚsum”
;

132 
	g¡d
::
veùÜ
<
MsgPŒ
> 
m_´io_h—p
;

136 
	g¡d
::
	tm­
<
	tAddr
, 
	t¡d
::
	tli¡
<
	tMsgPŒ
> > 
	tSÎMsgM­Ty³
;

138 
SÎMsgM­Ty³
 
	gm_¡®l_msg_m­
;

140 cÚ¡ 
	gm_max_size
;

141 
Tick
 
	gm_time_Ï¡_time_size_checked
;

142 
	gm_size_Ï¡_time_size_checked
;

146 
Tick
 
	gm_time_Ï¡_time_’queue
;

147 
Tick
 
	gm_time_Ï¡_time_pİ
;

148 
Tick
 
	gm_Ï¡_¬riv®_time
;

150 
	gm_size_©_cyşe_¡¬t
;

151 
	gm_msgs_this_cyşe
;

153 
	gm_nÙ_ava_couÁ
;

155 
ušt64_t
 
	gm_msg_couÁ”
;

156 
	gm_´iÜ™y_¿nk
;

157 cÚ¡ 
boŞ
 
	gm_¡riù_fifo
;

158 cÚ¡ 
boŞ
 
	gm_¿ndomiz©iÚ
;

160 
	gm_šput_lšk_id
;

161 
	gm_vÃt_id
;

164 
Tick
 
¿ndom_time
();

166 
šlše
 
	g¡d
::
o¡»am
&

167 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gMes§geBufãr
& 
	gobj
)

169 
	gobj
.
´št
(
out
);

170 
	gout
 << 
	g¡d
::
æush
;

171  
	gout
;

	@ruby/network/Network.cc

29 
	~"ba£/misc.hh
"

30 
	~"mem/ruby/ÃtwÜk/BasicLšk.hh
"

31 
	~"mem/ruby/ÃtwÜk/N‘wÜk.hh
"

32 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

34 
ušt32_t
 
	gN‘wÜk
::
m_vœtu®_ÃtwÜks
;

35 
ušt32_t
 
	gN‘wÜk
::
m_cÚŒŞ_msg_size
;

36 
ušt32_t
 
	gN‘wÜk
::
m_d©a_msg_size
;

38 
	gN‘wÜk
::
	$N‘wÜk
(cÚ¡ 
P¬ams
 *
p
)

39 : 
	$ClockedObjeù
(
p
)

41 
m_vœtu®_ÃtwÜks
 = 
p
->
numb”_of_vœtu®_ÃtwÜks
;

42 
m_cÚŒŞ_msg_size
 = 
p
->
cÚŒŞ_msg_size
;

46 
m_nodes
 = 
	`MachšeTy³_ba£_numb”
(
MachšeTy³_NUM
);

47 
	`as£¹
(
m_nodes
 != 0);

48 
	`as£¹
(
m_vœtu®_ÃtwÜks
 != 0);

50 
m_tİŞogy_±r
 = 
Ãw
 
	`TİŞogy
(
p
->
rou‹rs
.
	`size
(),…->
ext_lšks
,

51 
p
->
št_lšks
);

55 
m_toN‘Queues
.
	`»size
(
m_nodes
);

58 
m_äomN‘Queues
.
	`»size
(
m_nodes
);

60 
m_Üd”ed
.
	`»size
(
m_vœtu®_ÃtwÜks
);

61 
m_vÃt_ty³_Çmes
.
	`»size
(
m_vœtu®_ÃtwÜks
);

63 
i
 = 0; i < 
m_vœtu®_ÃtwÜks
; i++) {

64 
m_Üd”ed
[
i
] = 
çl£
;

67 
	`·¿ms
()->
ruby_sy¡em
->
	`»gi¡”N‘wÜk
(
this
);

70 
¡d
::
veùÜ
<
BasicExtLšk
*>::
cÚ¡_™”©Ü
 
i
 = 
p
->
ext_lšks
.
	`begš
();

71 
i
 !ğ
p
->
ext_lšks
.
	`’d
(); ++i) {

72 
BasicExtLšk
 *
ext_lšk
 = (*
i
);

73 
Ab¡¿ùCÚŒŞËr
 *
abs_úŒl
 = 
ext_lšk
->
	`·¿ms
()->
ext_node
;

74 
abs_úŒl
->
	`š™N‘wÜkPŒ
(
this
);

78 
Sts
::
	`»gi¡”DumpC®lback
(
Ãw
 
	`StsC®lback
(
this
));

80 autØ&
™
 : 
dyÇmic_ÿ¡
<
N‘wÜk
 *>(
this
)->
	`·¿ms
()->
ext_lšks
) {

81 
™
->
	`·¿ms
()->
ext_node
->
	`š™N‘Queues
();

83 
	}
}

85 
	gN‘wÜk
::~
	$N‘wÜk
()

87 
node
 = 0;‚od< 
m_nodes
;‚ode++) {

90 auto& 
™
 : 
m_toN‘Queues
[
node
]) {

91 
d–‘e
 
™
;

94 auto& 
™
 : 
m_äomN‘Queues
[
node
]) {

95 
d–‘e
 
™
;

99 
d–‘e
 
m_tİŞogy_±r
;

100 
	}
}

103 
	gN‘wÜk
::
	$š™
()

105 
m_d©a_msg_size
 = 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(è+ 
m_cÚŒŞ_msg_size
;

106 
	}
}

108 
ušt32_t


109 
	gN‘wÜk
::
	$Mes§geSizeTy³_to_št
(
Mes§geSizeTy³
 
size_ty³
)

111 
size_ty³
) {

112 
Mes§geSizeTy³_CÚŒŞ
:

113 
Mes§geSizeTy³_Reque¡_CÚŒŞ
:

114 
Mes§geSizeTy³_Reissue_CÚŒŞ
:

115 
Mes§geSizeTy³_Re¥Ú£_CÚŒŞ
:

116 
Mes§geSizeTy³_Wr™eback_CÚŒŞ
:

117 
Mes§geSizeTy³_Brßdÿ¡_CÚŒŞ
:

118 
Mes§geSizeTy³_MuÉiÿ¡_CÚŒŞ
:

119 
Mes§geSizeTy³_FÜw¬ded_CÚŒŞ
:

120 
Mes§geSizeTy³_Inv®id©e_CÚŒŞ
:

121 
Mes§geSizeTy³_Unblock_CÚŒŞ
:

122 
Mes§geSizeTy³_P”si¡’t_CÚŒŞ
:

123 
Mes§geSizeTy³_Com¶‘iÚ_CÚŒŞ
:

124  
m_cÚŒŞ_msg_size
;

125 
Mes§geSizeTy³_D©a
:

126 
Mes§geSizeTy³_Re¥Ú£_D©a
:

127 
Mes§geSizeTy³_Re¥Ú£Loÿl_D©a
:

128 
Mes§geSizeTy³_Re¥Ú£L2h™_D©a
:

129 
Mes§geSizeTy³_Wr™eback_D©a
:

130  
m_d©a_msg_size
;

132 
	`·nic
("Invalid„ange forype MessageSizeType");

135 
	}
}

138 
	gN‘wÜk
::
	$checkN‘wÜkAÎoÿtiÚ
(
NodeID
 
id
, 
boŞ
 
Üd”ed
,

139 
ÃtwÜk_num
,

140 
¡d
::
¡ršg
 
vÃt_ty³
)

142 
	`çl_if
(
id
 >ğ
m_nodes
, "Node ID is out of„ange");

143 
	`çl_if
(
ÃtwÜk_num
 >ğ
m_vœtu®_ÃtwÜks
, "Network id is out of„ange");

145 ià(
Üd”ed
) {

146 
m_Üd”ed
[
ÃtwÜk_num
] = 
Œue
;

149 
m_vÃt_ty³_Çmes
[
ÃtwÜk_num
] = 
vÃt_ty³
;

150 
	}
}

154 
	gN‘wÜk
::
	$£tToN‘Queue
(
NodeID
 
id
, 
boŞ
 
Üd”ed
, 
ÃtwÜk_num
,

155 
¡d
::
¡ršg
 
vÃt_ty³
, 
Mes§geBufãr
 *
b
)

157 
	`checkN‘wÜkAÎoÿtiÚ
(
id
, 
Üd”ed
, 
ÃtwÜk_num
, 
vÃt_ty³
);

158 
m_toN‘Queues
[
id
].
	`size
(è<ğ
ÃtwÜk_num
) {

159 
m_toN‘Queues
[
id
].
	`push_back
(
nuÎ±r
);

161 
m_toN‘Queues
[
id
][
ÃtwÜk_num
] = 
b
;

162 
	}
}

165 
	gN‘wÜk
::
	$£tFromN‘Queue
(
NodeID
 
id
, 
boŞ
 
Üd”ed
, 
ÃtwÜk_num
,

166 
¡d
::
¡ršg
 
vÃt_ty³
, 
Mes§geBufãr
 *
b
)

168 
	`checkN‘wÜkAÎoÿtiÚ
(
id
, 
Üd”ed
, 
ÃtwÜk_num
, 
vÃt_ty³
);

169 
m_äomN‘Queues
[
id
].
	`size
(è<ğ
ÃtwÜk_num
) {

170 
m_äomN‘Queues
[
id
].
	`push_back
(
nuÎ±r
);

172 
m_äomN‘Queues
[
id
][
ÃtwÜk_num
] = 
b
;

173 
	}
}

	@ruby/network/Network.hh

40 #iâdeà
__MEM_RUBY_NETWORK_NETWORK_HH__


41 
	#__MEM_RUBY_NETWORK_NETWORK_HH__


	)

43 
	~<io¡»am
>

44 
	~<¡ršg
>

45 
	~<veùÜ
>

47 
	~"mem/´ÙocŞ/LškDœeùiÚ.hh
"

48 
	~"mem/´ÙocŞ/Mes§geSizeTy³.hh
"

49 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

50 
	~"mem/ruby/ÃtwÜk/TİŞogy.hh
"

51 
	~"mem/·ck‘.hh
"

52 
	~"·¿ms/RubyN‘wÜk.hh
"

53 
	~"sim/şocked_objeù.hh
"

55 
şass
 
	gN‘De¡
;

56 
şass
 
	gMes§geBufãr
;

58 şas 
	cN‘wÜk
 : 
public
 
ClockedObjeù


60 
public
:

61 
RubyN‘wÜkP¬ams
 
	tP¬ams
;

62 
N‘wÜk
(cÚ¡ 
P¬ams
 *
p
);

63 cÚ¡ 
P¬ams
 * 
	$·¿ms
() const

64 {  
dyÇmic_ÿ¡
<cÚ¡ 
P¬ams
 *>(
_·¿ms
); }

66 
vœtu®
 ~
	`N‘wÜk
();

67 
vœtu®
 
	`š™
();

69 
ušt32_t
 
	$g‘Numb”OfVœtu®N‘wÜks
(è{  
m_vœtu®_ÃtwÜks
; 
	}
}

70 
	$g‘NumNodes
(ècÚ¡ {  
m_nodes
; 
	}
}

72 
ušt32_t
 
Mes§geSizeTy³_to_št
(
Mes§geSizeTy³
 
size_ty³
);

75 
£tToN‘Queue
(
NodeID
 
id
, 
boŞ
 
Üd”ed
, 
ÃtNumb”
,

76 
¡d
::
¡ršg
 
vÃt_ty³
, 
Mes§geBufãr
 *
b
);

77 
vœtu®
 
£tFromN‘Queue
(
NodeID
 
id
, 
boŞ
 
Üd”ed
, 
ÃtNumb”
,

78 
¡d
::
¡ršg
 
vÃt_ty³
, 
Mes§geBufãr
 *
b
);

80 
vœtu®
 
checkN‘wÜkAÎoÿtiÚ
(
NodeID
 
id
, 
boŞ
 
Üd”ed
,

81 
ÃtwÜk_num
, 
¡d
::
¡ršg
 
vÃt_ty³
);

83 
vœtu®
 
makeExtOutLšk
(
Sw™chID
 
¤c
, 
NodeID
 
de¡
, 
BasicLšk
* 
lšk
,

84 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
) = 0;

85 
vœtu®
 
makeExtInLšk
(
NodeID
 
¤c
, 
Sw™chID
 
de¡
, 
BasicLšk
* 
lšk
,

86 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
) = 0;

87 
vœtu®
 
makeIÁ”ÇlLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
, 
BasicLšk
* 
lšk
,

88 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
,

89 
PÜtDœeùiÚ
 
¤c_ouÜt
,

90 
PÜtDœeùiÚ
 
d¡_špÜt
) = 0;

92 
vœtu®
 
cŞÏ‹Sts
() = 0;

93 
vœtu®
 
	$´št
(
¡d
::
o¡»am
& 
out
) const = 0;

100 
vœtu®
 
boŞ
 
	$funùiÚ®R—d
(
Pack‘
 *
pkt
)

101 { 
	`çl
("FunùiÚ®„—d‚Ù im¶em’‹d.\n"); 
	}
}

102 
vœtu®
 
ušt32_t
 
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

103 { 
	`çl
("FunùiÚ® wr™nÙ im¶em’‹d.\n"); 
	}
}

105 
	g´Ùeùed
:

107 
N‘wÜk
(cÚ¡ N‘wÜk& 
obj
);

108 
	gN‘wÜk
& 
	gİ”©Ü
=(cÚ¡ 
N‘wÜk
& 
obj
);

110 
ušt32_t
 
	gm_nodes
;

111 
ušt32_t
 
	gm_vœtu®_ÃtwÜks
;

112 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
m_vÃt_ty³_Çmes
;

113 
TİŞogy
* 
	gm_tİŞogy_±r
;

114 
ušt32_t
 
	gm_cÚŒŞ_msg_size
;

115 
ušt32_t
 
	gm_d©a_msg_size
;

118 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
Mes§geBufãr
*> > 
m_toN‘Queues
;

119 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
Mes§geBufãr
*> > 
m_äomN‘Queues
;

120 
	g¡d
::
veùÜ
<
boŞ
> 
m_Üd”ed
;

122 
	g´iv©e
:

125 şas 
	cStsC®lback
 : 
public
 
C®lback


127 
´iv©e
:

128 
N‘wÜk
 *
ùr
;

130 
	gpublic
:

131 
vœtu®
 ~
StsC®lback
() {}

133 
StsC®lback
(
N‘wÜk
 *
_ùr
)

134 : 
ùr
(
_ùr
)

138 
´oûss
(è{
ùr
->
cŞÏ‹Sts
();}

142 
šlše
 
	g¡d
::
o¡»am
&

143 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gN‘wÜk
& 
	gobj
)

145 
	gobj
.
´št
(
out
);

146 
	gout
 << 
	g¡d
::
æush
;

147  
	gout
;

	@ruby/network/Topology.cc

29 
	~<ÿs£¹
>

31 
	~"ba£/Œaû.hh
"

32 
	~"debug/RubyN‘wÜk.hh
"

33 
	~"mem/ruby/commÚ/N‘De¡.hh
"

34 
	~"mem/ruby/ÃtwÜk/BasicLšk.hh
"

35 
	~"mem/ruby/ÃtwÜk/TİŞogy.hh
"

36 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCÚŒŞËr.hh
"

38 
usšg
 
Çme¥aû
 
	g¡d
;

40 cÚ¡ 
	gINFINITE_LATENCY
 = 10000;

49 
	gTİŞogy
::
TİŞogy
(
ušt32_t
 
num_rou‹rs
,

50 cÚ¡ 
veùÜ
<
BasicExtLšk
 *> &
ext_lšks
,

51 cÚ¡ 
veùÜ
<
BasicIÁLšk
 *> &
št_lšks
)

52 : 
m_nodes
(
ext_lšks
.
size
()), 
m_numb”_of_sw™ches
(
num_rou‹rs
),

53 
m_ext_lšk_veùÜ
(
ext_lšks
), 
	$m_št_lšk_veùÜ
(
št_lšks
)

56 
	`as£¹
(
m_nodes
 > 1);

66 
veùÜ
<
BasicExtLšk
*>::
cÚ¡_™”©Ü
 
i
 = 
ext_lšks
.
	`begš
();

67 
i
 !ğ
ext_lšks
.
	`’d
(); ++i) {

68 
BasicExtLšk
 *
ext_lšk
 = (*
i
);

69 
Ab¡¿ùCÚŒŞËr
 *
abs_úŒl
 = 
ext_lšk
->
	`·¿ms
()->
ext_node
;

70 
BasicRou‹r
 *
rou‹r
 = 
ext_lšk
->
	`·¿ms
()->
št_node
;

72 
machše_ba£_idx
 = 
	`MachšeTy³_ba£_numb”
(
abs_úŒl
->
	`g‘Ty³
());

73 
ext_idx1
 = 
machše_ba£_idx
 + 
abs_úŒl
->
	`g‘V”siÚ
();

74 
ext_idx2
 = 
ext_idx1
 + 
m_nodes
;

75 
št_idx
 = 
rou‹r
->
	`·¿ms
()->
rou‹r_id
 + 2*
m_nodes
;

79 
	`addLšk
(
ext_idx1
, 
št_idx
, 
ext_lšk
);

81 
	`addLšk
(
št_idx
, 
ext_idx2
, 
ext_lšk
);

85 
veùÜ
<
BasicIÁLšk
*>::
cÚ¡_™”©Ü
 
i
 = 
št_lšks
.
	`begš
();

86 
i
 !ğ
št_lšks
.
	`’d
(); ++i) {

87 
BasicIÁLšk
 *
št_lšk
 = (*
i
);

88 
BasicRou‹r
 *
rou‹r_¤c
 = 
št_lšk
->
	`·¿ms
()->
¤c_node
;

89 
BasicRou‹r
 *
rou‹r_d¡
 = 
št_lšk
->
	`·¿ms
()->
d¡_node
;

91 
PÜtDœeùiÚ
 
¤c_ouÜt
 = 
št_lšk
->
	`·¿ms
()->src_outport;

92 
PÜtDœeùiÚ
 
d¡_špÜt
 = 
št_lšk
->
	`·¿ms
()->dst_inport;

95 
m_št_lšk_veùÜ
.
	`push_back
(
št_lšk
);

97 
¤c
 = 
rou‹r_¤c
->
	`·¿ms
()->
rou‹r_id
 + 2*
m_nodes
;

98 
d¡
 = 
rou‹r_d¡
->
	`·¿ms
()->
rou‹r_id
 + 2*
m_nodes
;

101 
	`addLšk
(
¤c
, 
d¡
, 
št_lšk
, 
¤c_ouÜt
, 
d¡_špÜt
);

103 
	}
}

106 
	gTİŞogy
::
	$ü—‹Lšks
(
N‘wÜk
 *
Ãt
)

109 
Sw™chID
 
max_sw™ch_id
 = 0;

110 
LškM­
::
cÚ¡_™”©Ü
 
i
 = 
m_lšk_m­
.
	`begš
();

111 
i
 !ğ
m_lšk_m­
.
	`’d
(); ++i) {

112 
¡d
::
·œ
<
Sw™chID
, Sw™chID> 
¤c_de¡
 = (*
i
).
fœ¡
;

113 
max_sw™ch_id
 = 
	`max
(max_sw™ch_id, 
¤c_de¡
.
fœ¡
);

114 
max_sw™ch_id
 = 
	`max
(max_sw™ch_id, 
¤c_de¡
.
£cÚd
);

118 
num_sw™ches
 = 
max_sw™ch_id
+1;

119 
M©rix
 
	`tİŞogy_weights
(
num_sw™ches
,

120 
veùÜ
<>(
num_sw™ches
, 
INFINITE_LATENCY
));

121 
M©rix
 
	`compÚ’t_Ï‹nc›s
(
num_sw™ches
,

122 
veùÜ
<>(
num_sw™ches
, -1));

123 
M©rix
 
	`compÚ’t_š‹r_sw™ches
(
num_sw™ches
,

124 
veùÜ
<>(
num_sw™ches
, 0));

127 
i
 = 0; i < 
tİŞogy_weights
.
	`size
(); i++) {

128 
tİŞogy_weights
[
i
][i] = 0;

132 
LškM­
::
cÚ¡_™”©Ü
 
i
 = 
m_lšk_m­
.
	`begš
();

133 
i
 !ğ
m_lšk_m­
.
	`’d
(); ++i) {

134 
¡d
::
·œ
<, > 
¤c_de¡
 = (*
i
).
fœ¡
;

135 
BasicLšk
* 
lšk
 = (*
i
).
£cÚd
.link;

136 
¤c
 = 
¤c_de¡
.
fœ¡
;

137 
d¡
 = 
¤c_de¡
.
£cÚd
;

138 
compÚ’t_Ï‹nc›s
[
¤c
][
d¡
] = 
lšk
->
m_Ï‹ncy
;

139 
tİŞogy_weights
[
¤c
][
d¡
] = 
lšk
->
m_weight
;

143 
M©rix
 
di¡
 = 
	`shÜ‹¡_·th
(
tİŞogy_weights
, 
compÚ’t_Ï‹nc›s
,

144 
compÚ’t_š‹r_sw™ches
);

146 
i
 = 0; i < 
tİŞogy_weights
.
	`size
(); i++) {

147 
j
 = 0; j < 
tİŞogy_weights
[
i
].
	`size
(); j++) {

148 
weight
 = 
tİŞogy_weights
[
i
][
j
];

149 ià(
weight
 > 0 && weighˆ!ğ
INFINITE_LATENCY
) {

150 
N‘De¡
 
de¡š©iÚ_£t
 =

151 
	`shÜ‹¡_·th_to_node
(
i
, 
j
, 
tİŞogy_weights
, 
di¡
);

152 
	`makeLšk
(
Ãt
, 
i
, 
j
, 
de¡š©iÚ_£t
);

156 
	}
}

159 
	gTİŞogy
::
	$addLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
, 
BasicLšk
* 
lšk
,

160 
PÜtDœeùiÚ
 
¤c_ouÜt_dœn
,

161 
PÜtDœeùiÚ
 
d¡_špÜt_dœn
)

163 
	`as£¹
(
¤c
 <ğ
m_numb”_of_sw™ches
+
m_nodes
+m_nodes);

164 
	`as£¹
(
de¡
 <ğ
m_numb”_of_sw™ches
+
m_nodes
+m_nodes);

166 
¡d
::
·œ
<, > 
¤c_de¡_·œ
;

167 
LškEÁry
 
lšk_’Œy
;

169 
¤c_de¡_·œ
.
fœ¡
 = 
¤c
;

170 
¤c_de¡_·œ
.
£cÚd
 = 
de¡
;

171 
lšk_’Œy
.
lšk
 =†ink;

172 
lšk_’Œy
.
¤c_ouÜt_dœn
 = src_outport_dirn;

173 
lšk_’Œy
.
d¡_špÜt_dœn
 = dst_inport_dirn;

174 
m_lšk_m­
[
¤c_de¡_·œ
] = 
lšk_’Œy
;

175 
	}
}

178 
	gTİŞogy
::
	$makeLšk
(
N‘wÜk
 *
Ãt
, 
Sw™chID
 
¤c
, Sw™chID 
de¡
,

179 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
)

183 
	`as£¹
(
¤c
 >ğ2 * 
m_nodes
 || 
de¡
 >= 2 * m_nodes);

185 
¡d
::
·œ
<, > 
¤c_de¡
;

186 
LškEÁry
 
lšk_’Œy
;

188 ià(
¤c
 < 
m_nodes
) {

189 
¤c_de¡
.
fœ¡
 = 
¤c
;

190 
¤c_de¡
.
£cÚd
 = 
de¡
;

191 
lšk_’Œy
 = 
m_lšk_m­
[
¤c_de¡
];

192 
Ãt
->
	`makeExtInLšk
(
¤c
, 
de¡
 - (2 * 
m_nodes
), 
lšk_’Œy
.
lšk
,

193 
routšg_bË_’Œy
);

194 } ià(
de¡
 < 2*
m_nodes
) {

195 
	`as£¹
(
de¡
 >ğ
m_nodes
);

196 
NodeID
 
node
 = 
de¡
 - 
m_nodes
;

197 
¤c_de¡
.
fœ¡
 = 
¤c
;

198 
¤c_de¡
.
£cÚd
 = 
de¡
;

199 
lšk_’Œy
 = 
m_lšk_m­
[
¤c_de¡
];

200 
Ãt
->
	`makeExtOutLšk
(
¤c
 - (2 * 
m_nodes
), 
node
, 
lšk_’Œy
.
lšk
,

201 
routšg_bË_’Œy
);

203 
	`as£¹
((
¤c
 >ğ2 * 
m_nodes
è&& (
de¡
 >= 2 * m_nodes));

204 
¤c_de¡
.
fœ¡
 = 
¤c
;

205 
¤c_de¡
.
£cÚd
 = 
de¡
;

206 
lšk_’Œy
 = 
m_lšk_m­
[
¤c_de¡
];

207 
Ãt
->
	`makeIÁ”ÇlLšk
(
¤c
 - (2 * 
m_nodes
), 
de¡
 - (2 * m_nodes),

208 
lšk_’Œy
.
lšk
,

209 
routšg_bË_’Œy
,

210 
lšk_’Œy
.
¤c_ouÜt_dœn
,

211 
lšk_’Œy
.
d¡_špÜt_dœn
);

213 
	}
}

218 
	gTİŞogy
::
	$ex‹nd_shÜ‹¡_·th
(
M©rix
 &
cu¼’t_di¡
, M©rix &
Ï‹nc›s
,

219 
M©rix
 &
š‹r_sw™ches
)

221 
boŞ
 
chªge
 = 
Œue
;

222 
nodes
 = 
cu¼’t_di¡
.
	`size
();

224 
chªge
) {

225 
chªge
 = 
çl£
;

226 
i
 = 0; i < 
nodes
; i++) {

227 
j
 = 0; j < 
nodes
; j++) {

228 
mšimum
 = 
cu¼’t_di¡
[
i
][
j
];

229 
´evious_mšimum
 = 
mšimum
;

230 
š‹rmedŸ‹_sw™ch
 = -1;

231 
k
 = 0; k < 
nodes
; k++) {

232 
mšimum
 = 
	`mš
(minimum,

233 
cu¼’t_di¡
[
i
][
k
] + cu¼’t_di¡[k][
j
]);

234 ià(
´evious_mšimum
 !ğ
mšimum
) {

235 
š‹rmedŸ‹_sw™ch
 = 
k
;

236 
š‹r_sw™ches
[
i
][
j
] =

237 
š‹r_sw™ches
[
i
][
k
] +

238 
š‹r_sw™ches
[
k
][
j
] + 1;

240 
´evious_mšimum
 = 
mšimum
;

242 ià(
cu¼’t_di¡
[
i
][
j
] !ğ
mšimum
) {

243 
chªge
 = 
Œue
;

244 
cu¼’t_di¡
[
i
][
j
] = 
mšimum
;

245 
	`as£¹
(
š‹rmedŸ‹_sw™ch
 >= 0);

246 
	`as£¹
(
š‹rmedŸ‹_sw™ch
 < 
Ï‹nc›s
[
i
].
	`size
());

247 
Ï‹nc›s
[
i
][
j
] =†©’c›s[i][
š‹rmedŸ‹_sw™ch
] +

248 
Ï‹nc›s
[
š‹rmedŸ‹_sw™ch
][
j
];

253 
	}
}

255 
M©rix


256 
	gTİŞogy
::
	$shÜ‹¡_·th
(cÚ¡ 
M©rix
 &
weights
, M©rix &
Ï‹nc›s
,

257 
M©rix
 &
š‹r_sw™ches
)

259 
M©rix
 
di¡
 = 
weights
;

260 
	`ex‹nd_shÜ‹¡_·th
(
di¡
, 
Ï‹nc›s
, 
š‹r_sw™ches
);

261  
di¡
;

262 
	}
}

264 
boŞ


265 
	gTİŞogy
::
	$lšk_is_shÜ‹¡_·th_to_node
(
Sw™chID
 
¤c
, Sw™chID 
Ãxt
,

266 
Sw™chID
 
fš®
, cÚ¡ 
M©rix
 &
weights
,

267 cÚ¡ 
M©rix
 &
di¡
)

269  
weights
[
¤c
][
Ãxt
] + 
di¡
[Ãxt][
fš®
] == dist[src][final];

270 
	}
}

272 
N‘De¡


273 
	gTİŞogy
::
	$shÜ‹¡_·th_to_node
(
Sw™chID
 
¤c
, Sw™chID 
Ãxt
,

274 cÚ¡ 
M©rix
 &
weights
, cÚ¡ M©rix &
di¡
)

276 
N‘De¡
 
»suÉ
;

277 
d
 = 0;

278 
machšes
;

279 
max_machšes
;

281 
machšes
 = 
MachšeTy³_NUM
;

282 
max_machšes
 = 
	`MachšeTy³_ba£_numb”
(
MachšeTy³_NUM
);

284 
m
 = 0; m < 
machšes
; m++) {

285 
NodeID
 
i
 = 0; i < 
	`MachšeTy³_ba£_couÁ
((
MachšeTy³
)
m
); i++) {

291 ià(
	`lšk_is_shÜ‹¡_·th_to_node
(
¤c
, 
Ãxt
, 
d
 + 
max_machšes
,

292 
weights
, 
di¡
)) {

293 
MachšeID
 
mach
 = {(
MachšeTy³
)
m
, 
i
};

294 
»suÉ
.
	`add
(
mach
);

296 
d
++;

300 
	`DPRINTF
(
RubyN‘wÜk
, "Returning shortest…ath\n"

303 (
¤c
-(2*
max_machšes
)), (
Ãxt
-(2*max_machines)),

304 
¤c
, 
Ãxt
, 
»suÉ
);

306  
»suÉ
;

307 
	}
}

	@ruby/network/Topology.hh

40 #iâdeà
__MEM_RUBY_NETWORK_TOPOLOGY_HH__


41 
	#__MEM_RUBY_NETWORK_TOPOLOGY_HH__


	)

43 
	~<io¡»am
>

44 
	~<¡ršg
>

45 
	~<veùÜ
>

47 
	~"mem/´ÙocŞ/LškDœeùiÚ.hh
"

48 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

49 
	~"mem/ruby/ÃtwÜk/BasicLšk.hh
"

51 
şass
 
	gN‘De¡
;

52 
şass
 
	gN‘wÜk
;

54 
	g¡d
::
	tveùÜ
<
	t¡d
::veùÜ<> > 
	tM©rix
;

55 
	g¡d
::
	t¡ršg
 
	tPÜtDœeùiÚ
;

57 
	sLškEÁry


59 
BasicLšk
 *
	mlšk
;

60 
LškDœeùiÚ
 
	mdœeùiÚ
;

61 
PÜtDœeùiÚ
 
	m¤c_ouÜt_dœn
;

62 
PÜtDœeùiÚ
 
	md¡_špÜt_dœn
;

65 
	g¡d
::
	tm­
<
	t¡d
::
	t·œ
<
	tSw™chID
, Sw™chID>, 
	tLškEÁry
> 
	tLškM­
;

67 şas 
	cTİŞogy


69 
	mpublic
:

70 
TİŞogy
(
ušt32_t
 
num_rou‹rs
, cÚ¡ 
¡d
::
veùÜ
<
BasicExtLšk
 *> &
ext_lšks
,

71 cÚ¡ 
¡d
::
veùÜ
<
BasicIÁLšk
 *> &
št_lšks
);

73 
ušt32_t
 
	$numSw™ches
(ècÚ¡ {  
m_numb”_of_sw™ches
; }

74 
	`ü—‹Lšks
(
N‘wÜk
 *
Ãt
);

75 
	$´št
(
¡d
::
o¡»am
& 
out
ècÚ¡ { ouˆ<< "[TİŞogy]"; 
	}
}

77 
	g´iv©e
:

78 
addLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
, 
BasicLšk
* 
lšk
,

79 
PÜtDœeùiÚ
 
¤c_ouÜt_dœn
 = "",

80 
PÜtDœeùiÚ
 
de¡_špÜt_dœn
 = "");

81 
makeLšk
(
N‘wÜk
 *
Ãt
, 
Sw™chID
 
¤c
, Sw™chID 
de¡
,

82 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
);

85 
ex‹nd_shÜ‹¡_·th
(
M©rix
 &
cu¼’t_di¡
, M©rix &
Ï‹nc›s
,

86 
M©rix
 &
š‹r_sw™ches
);

88 
	g¡d
::
veùÜ
<
¡d
::veùÜ<>> 
shÜ‹¡_·th
(cÚ¡ 
M©rix
 &
weights
,

89 
M©rix
 &
Ï‹nc›s
, M©rix &
š‹r_sw™ches
);

91 
boŞ
 
lšk_is_shÜ‹¡_·th_to_node
(
Sw™chID
 
¤c
, Sw™chID 
Ãxt
,

92 
Sw™chID
 
fš®
, cÚ¡ 
M©rix
 &
weights
, cÚ¡ M©rix &
di¡
);

94 
N‘De¡
 
shÜ‹¡_·th_to_node
(
Sw™chID
 
¤c
, Sw™chID 
Ãxt
,

95 cÚ¡ 
M©rix
 &
weights
, cÚ¡ M©rix &
di¡
);

97 cÚ¡ 
ušt32_t
 
	gm_nodes
;

98 cÚ¡ 
ušt32_t
 
	gm_numb”_of_sw™ches
;

100 
	g¡d
::
veùÜ
<
BasicExtLšk
*> 
m_ext_lšk_veùÜ
;

101 
	g¡d
::
veùÜ
<
BasicIÁLšk
*> 
m_št_lšk_veùÜ
;

103 
LškM­
 
	gm_lšk_m­
;

106 
šlše
 
	g¡d
::
o¡»am
&

107 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gTİŞogy
& 
	gobj
)

109 
	gobj
.
´št
(
out
);

110 
	gout
 << 
	g¡d
::
æush
;

111  
	gout
;

	@ruby/network/fault_model/FaultModel.cc

41 
	~<ÿs£¹
>

42 
	~<f¡»am
>

43 
	~<io¡»am
>

44 
	~<veùÜ
>

47 
	~"FauÉMod–.hh
"

48 
	~"ba£/misc.hh
"

50 
usšg
 
Çme¥aû
 
	g¡d
;

52 
	#MAX
(
a
,
b
è(× > bè? (aè: (b))

	)

55 
	gFauÉMod–
::
	$FauÉMod–
(cÚ¡ 
P¬ams
 *
p
è: 
	$SimObjeù
(
p
)

59 
boŞ
 
mÜe_»cÜds
 = 
Œue
;

60 
i
 = 0; 
mÜe_»cÜds
; i +ğ(
f›lds_³r_cÚf_»cÜd
)){

61 
sy¡em_cÚf
 
cÚfigu¿tiÚ
;

62 
cÚfigu¿tiÚ
.
buff_³r_vc
 =

63 
p
->
ba£lše_çuÉ_veùÜ_d©aba£
[
i
 + 
cÚf_»cÜd_buff_³r_vc
];

64 
cÚfigu¿tiÚ
.
vcs
 =

65 
p
->
ba£lše_çuÉ_veùÜ_d©aba£
[
i
 + 
cÚf_»cÜd_vcs
];

66 
çuÉ_šdex
 = 0; fauÉ_šdex < 
numb”_of_çuÉ_ty³s
;

67 
çuÉ_šdex
++){

68 
cÚfigu¿tiÚ
.
çuÉ_ty³
[
çuÉ_šdex
] =

69 
p
->
ba£lše_çuÉ_veùÜ_d©aba£
[
i
 +

70 
cÚf_»cÜd_fœ¡_çuÉ_ty³
 + 
çuÉ_šdex
] / 100;

72 
cÚfigu¿tiÚs
.
	`push_back
(
cÚfigu¿tiÚ
);

73 ià(
p
->
ba£lše_çuÉ_veùÜ_d©aba£
[
i
+
f›lds_³r_cÚf_»cÜd
] < 0){

74 
mÜe_»cÜds
 = 
çl£
;

80 
mÜe_»cÜds
 = 
Œue
;

81 
i
 = 0; 
mÜe_»cÜds
; i +ğ(
f›lds_³r_‹m³¿tu»_»cÜd
)){

82 
»cÜd_‹m³¿tu»
 =

83 
p
->
‹m³¿tu»_weights_d©aba£
[
i
 + 
‹m³¿tu»_»cÜd_‹mp
];

84 
»cÜd_weight
 =

85 
p
->
‹m³¿tu»_weights_d©aba£
[
i
 + 
‹m³¿tu»_»cÜd_weight
];

86 
fœ¡_»cÜd
 = 
Œue
;

87 ià(
fœ¡_»cÜd
){

88 
‹m³¿tu»
 = 0;em³¿tu» < 
»cÜd_‹m³¿tu»
;

89 
‹m³¿tu»
++){

90 
‹m³¿tu»_weights
.
	`push_back
(0);

92 
fœ¡_»cÜd
 = 
çl£
;

94 
	`as£¹
(
»cÜd_‹m³¿tu»
 =ğ
‹m³¿tu»_weights
.
	`size
());

95 
‹m³¿tu»_weights
.
	`push_back
(
»cÜd_weight
);

96 ià(
p
->
‹m³¿tu»_weights_d©aba£
[
i
 +

97 
f›lds_³r_‹m³¿tu»_»cÜd
] < 0){

98 
mÜe_»cÜds
 = 
çl£
;

101 
	}
}

103 
¡ršg


104 
	gFauÉMod–
::
	$çuÉ_ty³_to_¡ršg
(
á
)

106 ià(
á
 =ğ
d©a_cÜru±iÚ__ãw_b™s
){

108 } ià(
á
 =ğ
d©a_cÜru±iÚ__®l_b™s
){

110 } ià(
á
 =ğ
æ™_cÚ£rv©iÚ__æ™_du¶iÿtiÚ
){

112 } ià(
á
 =ğ
æ™_cÚ£rv©iÚ__æ™_loss_Ü_¥l™
){

114 } ià(
á
 =ğ
mi¤outšg
){

116 } ià(
á
 =ğ
üed™_cÚ£rv©iÚ__üed™_g’”©iÚ
){

118 } ià(
á
 =ğ
üed™_cÚ£rv©iÚ__üed™_loss
){

120 } ià(
á
 =ğ
”rÚeous_®loÿtiÚ__VC
){

122 } ià(
á
 =ğ
”rÚeous_®loÿtiÚ__sw™ch
){

124 } ià(
á
 =ğ
unçœ_¬b™¿tiÚ
){

126 } ià(
á
 =ğ
numb”_of_çuÉ_ty³s
){

131 
	}
}

135 
	gFauÉMod–
::
	$deş¬e_rou‹r
(
numb”_of_šputs
,

136 
numb”_of_ouuts
,

137 
numb”_of_vcs_³r_šput
,

138 
numb”_of_buff_³r_d©a_vc
,

139 
numb”_of_buff_³r_ù¾_vc
)

142 ià(
numb”_of_šputs
 <ğ0 || 
numb”_of_ouuts
 <= 0 ||

143 
numb”_of_vcs_³r_šput
 <ğ0 || 
numb”_of_buff_³r_d©a_vc
 <= 0 ||

144 
numb”_of_buff_³r_ù¾_vc
 <= 0){

145 
	`çl
("Fault Model: ERROR in‡rgument of FaultModel_declare_router!");

147 
numb”_of_bufãrs_³r_vc
 = 
	`MAX
(
numb”_of_buff_³r_d©a_vc
,

148 
numb”_of_buff_³r_ù¾_vc
);

149 
tÙ®_vcs
 = 
numb”_of_šputs
 * 
numb”_of_vcs_³r_šput
;

150 ià(
tÙ®_vcs
 > 
MAX_VCs
){

151 
	`çl
("Fault Model: ERROR! Number inputs*VCs (MAX_VCs) unsupported");

153 ià(
numb”_of_bufãrs_³r_vc
 > 
MAX_BUFFERS_³r_VC
){

154 
	`çl
("Fault Model: ERROR! buffers/VC (MAX_BUFFERS_per_VC)oo high");

158 
»cÜd_h™
 = -1;

159 
»cÜd
 = 0;„ecÜd < 
cÚfigu¿tiÚs
.
	`size
();„ecord++){

160 ià((
cÚfigu¿tiÚs
[
»cÜd
].
buff_³r_vc
 =ğ
numb”_of_bufãrs_³r_vc
)&&

161 (
cÚfigu¿tiÚs
[
»cÜd
].
vcs
 =ğ
tÙ®_vcs
)){

162 
»cÜd_h™
 = 
»cÜd
;

165 ià(
»cÜd_h™
 == -1){

166 
	`·nic
("Fault Model: ERROR! configuration‚ot found in DB. BUG?");

170 
rou‹rs
.
	`push_back
(
cÚfigu¿tiÚs
[
»cÜd_h™
]);

171 
rou‹r_šdex
 = 0;

172  
rou‹r_šdex
++;

173 
	}
}

175 
boŞ


176 
	gFauÉMod–
::
	$çuÉ_veùÜ
(
rou‹rID
,

177 
‹m³¿tu»_šput
,

178 
çuÉ_veùÜ
[])

180 
boŞ
 
ok
 = 
Œue
;

183 ià(
rou‹rID
 < 0 ||„ou‹rID >ğ((è
rou‹rs
.
	`size
())){

184 
	`w¬n
("Fault Model: ERROR! unknown„outer ID‡rgument.");

185 
	`çl
("Fault Model: Did youƒnablehe fault model flag)?");

189 
‹m³¿tu»
 = 
‹m³¿tu»_šput
;

190 ià(
‹m³¿tu»_šput
 >ğ((è
‹m³¿tu»_weights
.
	`size
())){

191 
ok
 = 
çl£
;

192 
	`w¬n_Úû
("Fault Model: Temperatureƒxceeded simulated upper bound.");

193 
	`w¬n_Úû
("Fault Model: The fault model is‚ot‡ccurate‡ny more.");

194 
‹m³¿tu»
 = (
‹m³¿tu»_weights
.
	`size
() - 1);

195 } ià(
‹m³¿tu»_šput
 < 0){

196 
ok
 = 
çl£
;

197 
	`w¬n_Úû
("Fault Model: Temperatureƒxceeded simulated†ower bound.");

198 
	`w¬n_Úû
("Fault Model: The fault model is‚ot‡ccurate‡ny more.");

199 
‹m³¿tu»
 = 0;

203 
i
 = 0; i < 
numb”_of_çuÉ_ty³s
; i++){

204 
çuÉ_veùÜ
[
i
] = 
rou‹rs
[
rou‹rID
].
çuÉ_ty³
[i] *

205 (()
‹m³¿tu»_weights
[
‹m³¿tu»
]);

207  
ok
;

208 
	}
}

210 
boŞ


211 
	gFauÉMod–
::
	$çuÉ_´ob
(
rou‹rID
,

212 
‹m³¿tu»_šput
,

213 *
agg»g©e_çuÉ_´ob
)

215 *
agg»g©e_çuÉ_´ob
 = 1.0;

216 
boŞ
 
ok
 = 
Œue
;

219 ià(
rou‹rID
 < 0 ||„ou‹rID >ğ((è
rou‹rs
.
	`size
())){

220 
	`w¬n
("Fault Model: ERROR! unknown„outer ID‡rgument.");

221 
	`çl
("Fault Model: Did youƒnablehe fault model flag)?");

225 
‹m³¿tu»
 = 
‹m³¿tu»_šput
;

226 ià(
‹m³¿tu»_šput
 >ğ((è
‹m³¿tu»_weights
.
	`size
()) ){

227 
ok
 = 
çl£
;

228 
	`w¬n_Úû
("Fault Model: Temperatureƒxceeded simulated upper bound.");

229 
	`w¬n_Úû
("Fault Model: The fault model is‚ot‡ccurate‡ny more.");

230 
‹m³¿tu»
 = (
‹m³¿tu»_weights
.
	`size
()-1);

231 } ià(
‹m³¿tu»_šput
 < 0){

232 
ok
 = 
çl£
;

233 
	`w¬n_Úû
("Fault Model: Temperatureƒxceeded simulated†ower bound.");

234 
	`w¬n_Úû
("Fault Model: The fault model is‚ot‡ccurate‡ny more.");

235 
‹m³¿tu»
 = 0;

239 
i
 = 0; i < 
numb”_of_çuÉ_ty³s
; i++){

240 *
agg»g©e_çuÉ_´ob
= *aggregate_fault_prob *

241 Ğ1.0 - (
rou‹rs
[
rou‹rID
].
çuÉ_ty³
[
i
] *

242 (()
‹m³¿tu»_weights
[
‹m³¿tu»
])) );

244 *
agg»g©e_çuÉ_´ob
 = 1.0 - *aggregate_fault_prob;

245  
ok
;

246 
	}
}

250 
	gFauÉMod–
::
	$´št
()

252 
cout
 << "--- PRINTING configurations ---\n";

253 
»cÜd
 = 0;„ecÜd < 
cÚfigu¿tiÚs
.
	`size
();„ecord++){

254 
cout
 << "(" << 
»cÜd
 << ") ";

255 
cout
 << "VCs=" << 
cÚfigu¿tiÚs
[
»cÜd
].
vcs
 << " ";

256 
cout
 << "Buff/VC=" << 
cÚfigu¿tiÚs
[
»cÜd
].
buff_³r_vc
 << " [";

257 
çuÉ_ty³_num
 = 0;

258 
çuÉ_ty³_num
 < 
numb”_of_çuÉ_ty³s
;

259 
çuÉ_ty³_num
++){

260 
cout
 << (100 * 
cÚfigu¿tiÚs
[
»cÜd
].
çuÉ_ty³
[
çuÉ_ty³_num
]);

261 
cout
 << "% ";

263 
cout
 << "]\n";

265 
cout
 << "--- PRINTINGemperature weights ---\n";

266 
»cÜd
 = 0;„ecÜd < 
‹m³¿tu»_weights
.
	`size
();„ecord++){

267 
cout
 << "‹m³¿tu»=" << 
»cÜd
 << " => ";

268 
cout
 << "weight=" << 
‹m³¿tu»_weights
[
»cÜd
];

269 
cout
 << "\n";

271 
	}
}

273 
FauÉMod–
 *

274 
	gFauÉMod–P¬ams
::
	$ü—‹
()

276  
Ãw
 
	`FauÉMod–
(
this
);

277 
	}
}

	@ruby/network/fault_model/FaultModel.hh

40 #iâdeà
__MEM_RUBY_NETWORK_FAULT_MODEL_HH__


41 
	#__MEM_RUBY_NETWORK_FAULT_MODEL_HH__


	)

44 
	#MAX_VCs
 40

	)

45 
	#MAX_BUFFERS_³r_VC
 5

	)

46 
	#BASELINE_TEMPERATURE_CELCIUS
 71

	)

49 
	~<¡ršg
>

52 
	~"·¿ms/FauÉMod–.hh
"

53 
	~"sim/sim_objeù.hh
"

55 şas 
	cFauÉMod–
 : 
public
 
SimObjeù


57 
public
:

58 
FauÉMod–P¬ams
 
	tP¬ams
;

59 
FauÉMod–
(cÚ¡ 
P¬ams
 *
p
);

60 cÚ¡ 
P¬ams
 *
	$·¿ms
(ècÚ¡ {  (cÚ¡ 
P¬ams
 *)
_·¿ms
; }

66 
	eçuÉ_ty³


68 
d©a_cÜru±iÚ__ãw_b™s
,

69 
d©a_cÜru±iÚ__®l_b™s
,

70 
æ™_cÚ£rv©iÚ__æ™_du¶iÿtiÚ
,

71 
æ™_cÚ£rv©iÚ__æ™_loss_Ü_¥l™
,

72 
mi¤outšg
,

73 
üed™_cÚ£rv©iÚ__üed™_g’”©iÚ
,

74 
üed™_cÚ£rv©iÚ__üed™_loss
,

75 
”rÚeous_®loÿtiÚ__VC
,

76 
”rÚeous_®loÿtiÚ__sw™ch
,

77 
unçœ_¬b™¿tiÚ
,

78 
numb”_of_çuÉ_ty³s


79 
	}
};

85 
	ecÚf_»cÜd_fÜm©


87 
	gcÚf_»cÜd_buff_³r_vc
,

88 
	gcÚf_»cÜd_vcs
,

89 
	gcÚf_»cÜd_fœ¡_çuÉ_ty³
,

90 
	gcÚf_»cÜd_Ï¡_çuÉ_ty³
 = 
cÚf_»cÜd_fœ¡_çuÉ_ty³
 + 
numb”_of_çuÉ_ty³s
 - 1,

91 
	gf›lds_³r_cÚf_»cÜd


94 
	e‹m³¿tu»_»cÜd_fÜm©


96 
	g‹m³¿tu»_»cÜd_‹mp
,

97 
	g‹m³¿tu»_»cÜd_weight
,

98 
	gf›lds_³r_‹m³¿tu»_»cÜd


101 
	ssy¡em_cÚf


103 
	gvcs
;

104 
	gbuff_³r_vc
;

105 
	gçuÉ_ty³
[
numb”_of_çuÉ_ty³s
];

108 
deş¬e_rou‹r
(
numb”_of_šputs
,

109 
numb”_of_ouuts
,

110 
numb”_of_vcs_³r_vÃt
,

111 
numb”_of_buff_³r_d©a_vc
,

112 
numb”_of_buff_³r_ù¾_vc
);

114 
	g¡d
::
¡ršg
 
çuÉ_ty³_to_¡ršg
(
çuÉ_ty³_šdex
);

123 
boŞ
 
çuÉ_veùÜ
(
rou‹rID
,

124 
‹m³¿tu»
,

125 
çuÉ_veùÜ
[]);

127 
boŞ
 
çuÉ_´ob
(
rou‹rID
,

128 
‹m³¿tu»
,

129 *
agg»g©e_çuÉ_´ob
);

133 
´št
();

135 
	g´iv©e
:

136 
¡d
::
veùÜ
 <
sy¡em_cÚf
> 
cÚfigu¿tiÚs
;

137 
	g¡d
::
veùÜ
 <
sy¡em_cÚf
> 
rou‹rs
;

138 
	g¡d
::
veùÜ
 <> 
‹m³¿tu»_weights
;

	@ruby/network/garnet2.0/CommonTypes.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_COMMONTYPES_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_COMMONTYPES_HH__


	)

37 
	~"mem/ruby/commÚ/N‘De¡.hh
"

41 
	eæ™_ty³
 {
	mHEAD_
, 
	mBODY_
, 
	mTAIL_
, 
	mHEAD_TAIL_
, 
	mNUM_FLIT_TYPE_
};

42 
	eVC_¡©e_ty³
 {
	mIDLE_
, 
	mVC_AB_
, 
	mACTIVE_
, 
	mNUM_VC_STATE_TYPE_
};

43 
	eVNET_ty³
 {
	mCTRL_VNET_
, 
	mDATA_VNET_
, 
	mNULL_VNET_
, 
	mNUM_VNET_TYPE_
};

44 
	eæ™_¡age
 {
	mI_
, 
	mVA_
, 
	mSA_
, 
	mST_
, 
	mLT_
, 
	mNUM_FLIT_STAGE_
};

45 
	elšk_ty³
 { 
	mEXT_IN_
, 
	mEXT_OUT_
, 
	mINT_
, 
	mNUM_LINK_TYPES_
 };

46 
	eRoutšgAlgÜ™hm
 { 
	mTABLE_
 = 0, 
	mXY_
 = 1, 
	mCUSTOM_
 = 2,

47 
	mNUM_ROUTING_ALGORITHM_
};

49 
	sRou‹Info


52 
	mvÃt
;

53 
N‘De¡
 
	mÃt_de¡
;

56 
	m¤c_ni
;

57 
	m¤c_rou‹r
;

58 
	mde¡_ni
;

59 
	mde¡_rou‹r
;

60 
	mhİs_Œav”£d
;

63 
	#INFINITE_
 10000

	)

	@ruby/network/garnet2.0/Credit.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™.hh
"

40 
	gC»d™
::
	$C»d™
(
vc
, 
boŞ
 
is_ä“_sigÇl
, 
Cyşes
 
curTime
)

42 
m_id
 = 0;

43 
m_vc
 = 
vc
;

44 
m_is_ä“_sigÇl
 = 
is_ä“_sigÇl
;

45 
m_time
 = 
curTime
;

46 
	}
}

	@ruby/network/garnet2.0/Credit.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_CREDIT_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_CREDIT_HH__


	)

37 
	~<ÿs£¹
>

38 
	~<io¡»am
>

40 
	~"ba£/ty³s.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™.hh
"

48 şas 
	cC»d™
 : 
public
 
æ™


50 
public
:

51 
	$C»d™
() {};

52 
	`C»d™
(
vc
, 
boŞ
 
is_ä“_sigÇl
, 
Cyşes
 
curTime
);

54 
boŞ
 
	$is_ä“_sigÇl
(è{  
m_is_ä“_sigÇl
; 
	}
}

56 
	g´iv©e
:

57 
boŞ
 
m_is_ä“_sigÇl
;

	@ruby/network/garnet2.0/CreditLink.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_CREDIT_LINK_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_CREDIT_LINK_HH__


	)

37 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

38 
	~"·¿ms/C»d™Lšk.hh
"

40 şas 
	cC»d™Lšk
 : 
public
 
N‘wÜkLšk


42 
public
:

43 
C»d™LškP¬ams
 
	tP¬ams
;

44 
	$C»d™Lšk
(cÚ¡ 
P¬ams
 *
p
è: 
	$N‘wÜkLšk
(
p
) {}

45 
	}
};

	@ruby/network/garnet2.0/CrossbarSwitch.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Crossb¬Sw™ch.hh
"

36 
	~"ba£/¡l_h–³rs.hh
"

37 
	~"debug/RubyN‘wÜk.hh
"

38 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/OuutUn™.hh
"

39 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

41 
usšg
 
	gm5
::
¡l_h–³rs
::
d–‘ePoš‹rs
;

43 
	gCrossb¬Sw™ch
::
	$Crossb¬Sw™ch
(
Rou‹r
 *
rou‹r
)

44 : 
	$CÚsum”
(
rou‹r
)

46 
m_rou‹r
 = 
rou‹r
;

47 
m_num_vcs
 = 
m_rou‹r
->
	`g‘_num_vcs
();

48 
m_üossb¬_aùiv™y
 = 0;

49 
	}
}

51 
	gCrossb¬Sw™ch
::~
	$Crossb¬Sw™ch
()

53 
	`d–‘ePoš‹rs
(
m_sw™ch_bufãr
);

54 
	}
}

57 
	gCrossb¬Sw™ch
::
	$š™
()

59 
m_ouut_un™
 = 
m_rou‹r
->
	`g‘_ouutUn™_»f
();

61 
m_num_špÜts
 = 
m_rou‹r
->
	`g‘_num_špÜts
();

62 
m_sw™ch_bufãr
.
	`»size
(
m_num_špÜts
);

63 
i
 = 0; i < 
m_num_špÜts
; i++) {

64 
m_sw™ch_bufãr
[
i
] = 
Ãw
 
	`æ™Bufãr
();

66 
	}
}

75 
	gCrossb¬Sw™ch
::
	$wakeup
()

77 
	`DPRINTF
(
RubyN‘wÜk
, "CrossbarSwitch‡t Router %d woke up "

79 
m_rou‹r
->
	`g‘_id
(), m_rou‹r->
	`curCyşe
());

81 
špÜt
 = 0; iÅÜˆ< 
m_num_špÜts
; inport++) {

82 ià(!
m_sw™ch_bufãr
[
špÜt
]->
	`isR—dy
(
m_rou‹r
->
	`curCyşe
()))

85 
æ™
 *
t_æ™
 = 
m_sw™ch_bufãr
[
špÜt
]->
	`³ekTİFl™
();

86 ià(
t_æ™
->
	`is_¡age
(
ST_
, 
m_rou‹r
->
	`curCyşe
())) {

87 
ouÜt
 = 
t_æ™
->
	`g‘_ouÜt
();

90 
t_æ™
->
	`advªû_¡age
(
LT_
, 
m_rou‹r
->
	`curCyşe
(è+ 
	`Cyşes
(1));

91 
t_æ™
->
	`£t_time
(
m_rou‹r
->
	`curCyşe
(è+ 
	`Cyşes
(1));

95 
m_ouut_un™
[
ouÜt
]->
	`š£¹_æ™
(
t_æ™
);

96 
m_sw™ch_bufãr
[
špÜt
]->
	`g‘TİFl™
();

97 
m_üossb¬_aùiv™y
++;

100 
	}
}

102 
ušt32_t


103 
	gCrossb¬Sw™ch
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

105 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

107 
ušt32_t
 
i
 = 0; i < 
m_sw™ch_bufãr
.
	`size
(); ++i) {

108 
num_funùiÚ®_wr™es
 +ğ
m_sw™ch_bufãr
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

111  
num_funùiÚ®_wr™es
;

112 
	}
}

	@ruby/network/garnet2.0/CrossbarSwitch.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_CROSSBAR_SWITCH_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_CROSSBAR_SWITCH_HH__


	)

37 
	~<io¡»am
>

38 
	~<veùÜ
>

40 
	~"mem/ruby/commÚ/CÚsum”.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™Bufãr.hh
"

44 
şass
 
	gRou‹r
;

45 
şass
 
	gOuutUn™
;

47 şas 
	cCrossb¬Sw™ch
 : 
public
 
CÚsum”


49 
public
:

50 
Crossb¬Sw™ch
(
Rou‹r
 *
rou‹r
);

51 ~
Crossb¬Sw™ch
();

52 
wakeup
();

53 
š™
();

54 
	$´št
(
¡d
::
o¡»am
& 
out
) const {};

56 
šlše
 
	$upd©e_sw_wšÃr
(
špÜt
, 
æ™
 *
t_æ™
)

57 { 
m_sw™ch_bufãr
[
špÜt
]->
	`š£¹
(
t_æ™
); 
	}
}

59 
šlše
 
	$g‘_üossb¬_aùiv™y
(è{  
m_üossb¬_aùiv™y
; 
	}
}

61 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

63 
	g´iv©e
:

64 
m_num_vcs
;

65 
	gm_num_špÜts
;

66 
	gm_üossb¬_aùiv™y
;

67 
Rou‹r
 *
	gm_rou‹r
;

68 
	g¡d
::
veùÜ
<
æ™Bufãr
 *> 
m_sw™ch_bufãr
;

69 
	g¡d
::
veùÜ
<
OuutUn™
 *> 
m_ouut_un™
;

	@ruby/network/garnet2.0/GarnetLink.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtLšk.hh
"

36 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™Lšk.hh
"

37 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

39 
	gG¬ÃtIÁLšk
::
	$G¬ÃtIÁLšk
(cÚ¡ 
P¬ams
 *
p
)

40 : 
	$BasicLšk
(
p
)

44 
m_ÃtwÜk_lšk
 = 
p
->
ÃtwÜk_lšk
;

45 
m_üed™_lšk
 = 
p
->
üed™_lšk
;

46 
	}
}

49 
	gG¬ÃtIÁLšk
::
	$š™
()

51 
	}
}

54 
G¬ÃtIÁLšk
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

56 
out
 << 
	`Çme
();

57 
	}
}

59 
G¬ÃtIÁLšk
 *

60 
	gG¬ÃtIÁLškP¬ams
::
	$ü—‹
()

62  
Ãw
 
	`G¬ÃtIÁLšk
(
this
);

63 
	}
}

65 
	gG¬ÃtExtLšk
::
	$G¬ÃtExtLšk
(cÚ¡ 
P¬ams
 *
p
)

66 : 
	$BasicLšk
(
p
)

71 
m_ÃtwÜk_lšks
[0] = 
p
->
ÃtwÜk_lšks
[0];

72 
m_üed™_lšks
[0] = 
p
->
üed™_lšks
[0];

75 
m_ÃtwÜk_lšks
[1] = 
p
->
ÃtwÜk_lšks
[1];

76 
m_üed™_lšks
[1] = 
p
->
üed™_lšks
[1];

77 
	}
}

80 
	gG¬ÃtExtLšk
::
	$š™
()

82 
	}
}

85 
G¬ÃtExtLšk
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

87 
out
 << 
	`Çme
();

88 
	}
}

90 
G¬ÃtExtLšk
 *

91 
	gG¬ÃtExtLškP¬ams
::
	$ü—‹
()

93  
Ãw
 
	`G¬ÃtExtLšk
(
this
);

94 
	}
}

	@ruby/network/garnet2.0/GarnetLink.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_LINK_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_LINK_HH__


	)

37 
	~<io¡»am
>

38 
	~<¡ršg
>

39 
	~<veùÜ
>

41 
	~"mem/ruby/ÃtwÜk/BasicLšk.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™Lšk.hh
"

43 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

44 
	~"·¿ms/G¬ÃtExtLšk.hh
"

45 
	~"·¿ms/G¬ÃtIÁLšk.hh
"

47 şas 
	cG¬ÃtIÁLšk
 : 
public
 
BasicLšk


49 
public
:

50 
G¬ÃtIÁLškP¬ams
 
	tP¬ams
;

51 
G¬ÃtIÁLšk
(cÚ¡ 
P¬ams
 *
p
);

53 
š™
();

55 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

57 
ä›nd
 
şass
 
G¬ÃtN‘wÜk
;

59 
´Ùeùed
:

60 
N‘wÜkLšk
* 
m_ÃtwÜk_lšk
;

61 
C»d™Lšk
* 
m_üed™_lšk
;

64 
šlše
 
¡d
::
o¡»am
&

65 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
G¬ÃtIÁLšk
& 
obj
)

67 
obj
.
	`´št
(
out
);

68 
out
 << 
¡d
::
æush
;

69  
out
;

70 
	}
}

72 şas 
	cG¬ÃtExtLšk
 : 
public
 
BasicLšk


74 
public
:

75 
G¬ÃtExtLškP¬ams
 
	tP¬ams
;

76 
G¬ÃtExtLšk
(cÚ¡ 
P¬ams
 *
p
);

78 
š™
();

80 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

82 
ä›nd
 
şass
 
G¬ÃtN‘wÜk
;

84 
´Ùeùed
:

85 
N‘wÜkLšk
* 
m_ÃtwÜk_lšks
[2];

86 
C»d™Lšk
* 
m_üed™_lšks
[2];

89 
šlše
 
¡d
::
o¡»am
&

90 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
G¬ÃtExtLšk
& 
obj
)

92 
obj
.
	`´št
(
out
);

93 
out
 << 
¡d
::
æush
;

94  
out
;

95 
	}
}

	@ruby/network/garnet2.0/GarnetNetwork.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtN‘wÜk.hh
"

36 
	~<ÿs£¹
>

38 
	~"ba£/ÿ¡.hh
"

39 
	~"ba£/¡l_h–³rs.hh
"

40 
	~"mem/ruby/commÚ/N‘De¡.hh
"

41 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

43 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™Lšk.hh
"

44 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtLšk.hh
"

45 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkIÁ”çû.hh
"

46 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

47 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

48 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

50 
usšg
 
Çme¥aû
 
	g¡d
;

51 
usšg
 
	gm5
::
¡l_h–³rs
::
d–‘ePoš‹rs
;

59 
	gG¬ÃtN‘wÜk
::
	$G¬ÃtN‘wÜk
(cÚ¡ 
P¬ams
 *
p
)

60 : 
	$N‘wÜk
(
p
)

62 
m_num_rows
 = 
p
->
num_rows
;

63 
m_ni_æ™_size
 = 
p
->
ni_æ™_size
;

64 
m_vcs_³r_vÃt
 = 
p
->
vcs_³r_vÃt
;

65 
m_bufãrs_³r_d©a_vc
 = 
p
->
bufãrs_³r_d©a_vc
;

66 
m_bufãrs_³r_ù¾_vc
 = 
p
->
bufãrs_³r_ù¾_vc
;

67 
m_routšg_®gÜ™hm
 = 
p
->
routšg_®gÜ™hm
;

69 
m_’abË_çuÉ_mod–
 = 
p
->
’abË_çuÉ_mod–
;

70 ià(
m_’abË_çuÉ_mod–
)

71 
çuÉ_mod–
 = 
p
->fault_model;

73 
m_vÃt_ty³
.
	`»size
(
m_vœtu®_ÃtwÜks
);

75 
i
 = 0 ; i < 
m_vœtu®_ÃtwÜks
 ; i++) {

76 ià(
m_vÃt_ty³_Çmes
[
i
] == "response")

77 
m_vÃt_ty³
[
i
] = 
DATA_VNET_
;

79 
m_vÃt_ty³
[
i
] = 
CTRL_VNET_
;

83 
veùÜ
<
BasicRou‹r
*>::
cÚ¡_™”©Ü
 
i
 = 
p
->
rou‹rs
.
	`begš
();

84 
i
 !ğ
p
->
rou‹rs
.
	`’d
(); ++i) {

85 
Rou‹r
* 
rou‹r
 = 
§ã_ÿ¡
<Rou‹r*>(*
i
);

86 
m_rou‹rs
.
	`push_back
(
rou‹r
);

89 
rou‹r
->
	`š™_Ãt_±r
(
this
);

93 
veùÜ
<
ClockedObjeù
*>::
cÚ¡_™”©Ü
 
i
 = 
p
->
Ãtifs
.
	`begš
();

94 
i
 !ğ
p
->
Ãtifs
.
	`’d
(); ++i) {

95 
N‘wÜkIÁ”çû
 *
ni
 = 
§ã_ÿ¡
<N‘wÜkIÁ”çû *>(*
i
);

96 
m_nis
.
	`push_back
(
ni
);

97 
ni
->
	`š™_Ãt_±r
(
this
);

99 
	}
}

102 
	gG¬ÃtN‘wÜk
::
	$š™
()

104 
N‘wÜk
::
	`š™
();

106 
i
=0; i < 
m_nodes
; i++) {

107 
m_nis
[
i
]->
	`addNode
(
m_toN‘Queues
[i], 
m_äomN‘Queues
[i]);

112 
	`as£¹
(
m_tİŞogy_±r
 !ğ
NULL
);

113 
m_tİŞogy_±r
->
	`ü—‹Lšks
(
this
);

116 ià(
	`g‘NumRows
() > 0) {

120 
m_num_rows
 = 
	`g‘NumRows
();

121 
m_num_cŞs
 = 
m_rou‹rs
.
	`size
(è/ 
m_num_rows
;

122 
	`as£¹
(
m_num_rows
 * 
m_num_cŞs
 =ğ
m_rou‹rs
.
	`size
());

124 
m_num_rows
 = -1;

125 
m_num_cŞs
 = -1;

129 ià(
	`isFauÉMod–EÇbËd
()) {

130 
veùÜ
<
Rou‹r
*>::
cÚ¡_™”©Ü
 
i
ğ
m_rou‹rs
.
	`begš
();

131 
i
 !ğ
m_rou‹rs
.
	`’d
(); ++i) {

132 
Rou‹r
* 
rou‹r
 = 
§ã_ÿ¡
<Rou‹r*>(*
i
);

133 
rou‹r_id
 
M5_VAR_USED
 =

134 
çuÉ_mod–
->
	`deş¬e_rou‹r
(
rou‹r
->
	`g‘_num_špÜts
(),

135 
rou‹r
->
	`g‘_num_ouÜts
(),

136 
rou‹r
->
	`g‘_vc_³r_vÃt
(),

137 
	`g‘BufãrsP”D©aVC
(),

138 
	`g‘BufãrsP”CŒlVC
());

139 
	`as£¹
(
rou‹r_id
 =ğ
rou‹r
->
	`g‘_id
());

140 
rou‹r
->
	`´štAgg»g©eFauÉProbab™y
(
cout
);

141 
rou‹r
->
	`´štFauÉVeùÜ
(
cout
);

144 
	}
}

146 
	gG¬ÃtN‘wÜk
::~
	$G¬ÃtN‘wÜk
()

148 
	`d–‘ePoš‹rs
(
m_rou‹rs
);

149 
	`d–‘ePoš‹rs
(
m_nis
);

150 
	`d–‘ePoš‹rs
(
m_ÃtwÜklšks
);

151 
	`d–‘ePoš‹rs
(
m_üed™lšks
);

152 
	}
}

162 
	gG¬ÃtN‘wÜk
::
	$makeExtInLšk
(
NodeID
 
¤c
, 
Sw™chID
 
de¡
, 
BasicLšk
* 
lšk
,

163 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
)

165 
	`as£¹
(
¤c
 < 
m_nodes
);

167 
G¬ÃtExtLšk
* 
g¬Ãt_lšk
 = 
§ã_ÿ¡
<G¬ÃtExtLšk*>(
lšk
);

170 
N‘wÜkLšk
* 
Ãt_lšk
 = 
g¬Ãt_lšk
->
m_ÃtwÜk_lšks
[
LškDœeùiÚ_In
];

171 
Ãt_lšk
->
	`£tTy³
(
EXT_IN_
);

172 
C»d™Lšk
* 
üed™_lšk
 = 
g¬Ãt_lšk
->
m_üed™_lšks
[
LškDœeùiÚ_In
];

174 
m_ÃtwÜklšks
.
	`push_back
(
Ãt_lšk
);

175 
m_üed™lšks
.
	`push_back
(
üed™_lšk
);

177 
PÜtDœeùiÚ
 
d¡_špÜt_dœn
 = "Local";

178 
m_rou‹rs
[
de¡
]->
	`addInPÜt
(
d¡_špÜt_dœn
, 
Ãt_lšk
, 
üed™_lšk
);

179 
m_nis
[
¤c
]->
	`addOutPÜt
(
Ãt_lšk
, 
üed™_lšk
, 
de¡
);

180 
	}
}

189 
	gG¬ÃtN‘wÜk
::
	$makeExtOutLšk
(
Sw™chID
 
¤c
, 
NodeID
 
de¡
, 
BasicLšk
* 
lšk
,

190 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
)

192 
	`as£¹
(
de¡
 < 
m_nodes
);

193 
	`as£¹
(
¤c
 < 
m_rou‹rs
.
	`size
());

194 
	`as£¹
(
m_rou‹rs
[
¤c
] !ğ
NULL
);

196 
G¬ÃtExtLšk
* 
g¬Ãt_lšk
 = 
§ã_ÿ¡
<G¬ÃtExtLšk*>(
lšk
);

199 
N‘wÜkLšk
* 
Ãt_lšk
 = 
g¬Ãt_lšk
->
m_ÃtwÜk_lšks
[
LškDœeùiÚ_Out
];

200 
Ãt_lšk
->
	`£tTy³
(
EXT_OUT_
);

201 
C»d™Lšk
* 
üed™_lšk
 = 
g¬Ãt_lšk
->
m_üed™_lšks
[
LškDœeùiÚ_Out
];

203 
m_ÃtwÜklšks
.
	`push_back
(
Ãt_lšk
);

204 
m_üed™lšks
.
	`push_back
(
üed™_lšk
);

206 
PÜtDœeùiÚ
 
¤c_ouÜt_dœn
 = "Local";

207 
m_rou‹rs
[
¤c
]->
	`addOutPÜt
(
¤c_ouÜt_dœn
, 
Ãt_lšk
,

208 
routšg_bË_’Œy
,

209 
lšk
->
m_weight
, 
üed™_lšk
);

210 
m_nis
[
de¡
]->
	`addInPÜt
(
Ãt_lšk
, 
üed™_lšk
);

211 
	}
}

219 
	gG¬ÃtN‘wÜk
::
	$makeIÁ”ÇlLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
, 
BasicLšk
* 
lšk
,

220 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
,

221 
PÜtDœeùiÚ
 
¤c_ouÜt_dœn
,

222 
PÜtDœeùiÚ
 
d¡_špÜt_dœn
)

224 
G¬ÃtIÁLšk
* 
g¬Ãt_lšk
 = 
§ã_ÿ¡
<G¬ÃtIÁLšk*>(
lšk
);

227 
N‘wÜkLšk
* 
Ãt_lšk
 = 
g¬Ãt_lšk
->
m_ÃtwÜk_lšk
;

228 
Ãt_lšk
->
	`£tTy³
(
INT_
);

229 
C»d™Lšk
* 
üed™_lšk
 = 
g¬Ãt_lšk
->
m_üed™_lšk
;

231 
m_ÃtwÜklšks
.
	`push_back
(
Ãt_lšk
);

232 
m_üed™lšks
.
	`push_back
(
üed™_lšk
);

234 
m_rou‹rs
[
de¡
]->
	`addInPÜt
(
d¡_špÜt_dœn
, 
Ãt_lšk
, 
üed™_lšk
);

235 
m_rou‹rs
[
¤c
]->
	`addOutPÜt
(
¤c_ouÜt_dœn
, 
Ãt_lšk
,

236 
routšg_bË_’Œy
,

237 
lšk
->
m_weight
, 
üed™_lšk
);

238 
	}
}

242 
	gG¬ÃtN‘wÜk
::
	$g‘NumRou‹rs
()

244  
m_rou‹rs
.
	`size
();

245 
	}
}

249 
	gG¬ÃtN‘wÜk
::
	$g‘_rou‹r_id
(
ni
)

251  
m_nis
[
ni
]->
	`g‘_rou‹r_id
();

252 
	}
}

255 
	gG¬ÃtN‘wÜk
::
	$»gSts
()

257 
N‘wÜk
::
	`»gSts
();

260 
m_·ck‘s_»ûived


261 .
	`š™
(
m_vœtu®_ÃtwÜks
)

262 .
	`Çme
(name() + ".packets_received")

263 .
	`æags
(
Sts
::
pdf
 | Sts::
tÙ®
 | Sts::
noz”o
 | Sts::
Ú–še
)

266 
m_·ck‘s_šjeùed


267 .
	`š™
(
m_vœtu®_ÃtwÜks
)

268 .
	`Çme
(name() + ".packets_injected")

269 .
	`æags
(
Sts
::
pdf
 | Sts::
tÙ®
 | Sts::
noz”o
 | Sts::
Ú–še
)

272 
m_·ck‘_ÃtwÜk_Ï‹ncy


273 .
	`š™
(
m_vœtu®_ÃtwÜks
)

274 .
	`Çme
(name() + ".packet_network_latency")

275 .
	`æags
(
Sts
::
Ú–še
)

278 
m_·ck‘_queuešg_Ï‹ncy


279 .
	`š™
(
m_vœtu®_ÃtwÜks
)

280 .
	`Çme
(name() + ".packet_queueing_latency")

281 .
	`æags
(
Sts
::
Ú–še
)

284 
i
 = 0; i < 
m_vœtu®_ÃtwÜks
; i++) {

285 
m_·ck‘s_»ûived
.
	`subÇme
(
i
, 
	`c¥rštf
("vnet-%i", i));

286 
m_·ck‘s_šjeùed
.
	`subÇme
(
i
, 
	`c¥rštf
("vnet-%i", i));

287 
m_·ck‘_ÃtwÜk_Ï‹ncy
.
	`subÇme
(
i
, 
	`c¥rštf
("vnet-%i", i));

288 
m_·ck‘_queuešg_Ï‹ncy
.
	`subÇme
(
i
, 
	`c¥rštf
("vnet-%i", i));

291 
m_avg_·ck‘_vÃt_Ï‹ncy


292 .
	`Çme
(name() + ".average_packet_vnet_latency")

293 .
	`æags
(
Sts
::
Ú–še
);

294 
m_avg_·ck‘_vÃt_Ï‹ncy
 =

295 
m_·ck‘_ÃtwÜk_Ï‹ncy
 / 
m_·ck‘s_»ûived
;

297 
m_avg_·ck‘_vqueue_Ï‹ncy


298 .
	`Çme
(name() + ".average_packet_vqueue_latency")

299 .
	`æags
(
Sts
::
Ú–še
);

300 
m_avg_·ck‘_vqueue_Ï‹ncy
 =

301 
m_·ck‘_queuešg_Ï‹ncy
 / 
m_·ck‘s_»ûived
;

303 
m_avg_·ck‘_ÃtwÜk_Ï‹ncy


304 .
	`Çme
(name() + ".average_packet_network_latency");

305 
m_avg_·ck‘_ÃtwÜk_Ï‹ncy
 =

306 
	`sum
(
m_·ck‘_ÃtwÜk_Ï‹ncy
è/ sum(
m_·ck‘s_»ûived
);

308 
m_avg_·ck‘_queuešg_Ï‹ncy


309 .
	`Çme
(name() + ".average_packet_queueing_latency");

310 
m_avg_·ck‘_queuešg_Ï‹ncy


311 ğ
	`sum
(
m_·ck‘_queuešg_Ï‹ncy
è/ sum(
m_·ck‘s_»ûived
);

313 
m_avg_·ck‘_Ï‹ncy


314 .
	`Çme
(name() + ".average_packet_latency");

315 
m_avg_·ck‘_Ï‹ncy


316 ğ
m_avg_·ck‘_ÃtwÜk_Ï‹ncy
 + 
m_avg_·ck‘_queuešg_Ï‹ncy
;

319 
m_æ™s_»ûived


320 .
	`š™
(
m_vœtu®_ÃtwÜks
)

321 .
	`Çme
(name() + ".flits_received")

322 .
	`æags
(
Sts
::
pdf
 | Sts::
tÙ®
 | Sts::
noz”o
 | Sts::
Ú–še
)

325 
m_æ™s_šjeùed


326 .
	`š™
(
m_vœtu®_ÃtwÜks
)

327 .
	`Çme
(name() + ".flits_injected")

328 .
	`æags
(
Sts
::
pdf
 | Sts::
tÙ®
 | Sts::
noz”o
 | Sts::
Ú–še
)

331 
m_æ™_ÃtwÜk_Ï‹ncy


332 .
	`š™
(
m_vœtu®_ÃtwÜks
)

333 .
	`Çme
(name() + ".flit_network_latency")

334 .
	`æags
(
Sts
::
Ú–še
)

337 
m_æ™_queuešg_Ï‹ncy


338 .
	`š™
(
m_vœtu®_ÃtwÜks
)

339 .
	`Çme
(name() + ".flit_queueing_latency")

340 .
	`æags
(
Sts
::
Ú–še
)

343 
i
 = 0; i < 
m_vœtu®_ÃtwÜks
; i++) {

344 
m_æ™s_»ûived
.
	`subÇme
(
i
, 
	`c¥rštf
("vnet-%i", i));

345 
m_æ™s_šjeùed
.
	`subÇme
(
i
, 
	`c¥rštf
("vnet-%i", i));

346 
m_æ™_ÃtwÜk_Ï‹ncy
.
	`subÇme
(
i
, 
	`c¥rštf
("vnet-%i", i));

347 
m_æ™_queuešg_Ï‹ncy
.
	`subÇme
(
i
, 
	`c¥rštf
("vnet-%i", i));

350 
m_avg_æ™_vÃt_Ï‹ncy


351 .
	`Çme
(name() + ".average_flit_vnet_latency")

352 .
	`æags
(
Sts
::
Ú–še
);

353 
m_avg_æ™_vÃt_Ï‹ncy
 = 
m_æ™_ÃtwÜk_Ï‹ncy
 / 
m_æ™s_»ûived
;

355 
m_avg_æ™_vqueue_Ï‹ncy


356 .
	`Çme
(name() + ".average_flit_vqueue_latency")

357 .
	`æags
(
Sts
::
Ú–še
);

358 
m_avg_æ™_vqueue_Ï‹ncy
 =

359 
m_æ™_queuešg_Ï‹ncy
 / 
m_æ™s_»ûived
;

361 
m_avg_æ™_ÃtwÜk_Ï‹ncy


362 .
	`Çme
(name() + ".average_flit_network_latency");

363 
m_avg_æ™_ÃtwÜk_Ï‹ncy
 =

364 
	`sum
(
m_æ™_ÃtwÜk_Ï‹ncy
è/ sum(
m_æ™s_»ûived
);

366 
m_avg_æ™_queuešg_Ï‹ncy


367 .
	`Çme
(name() + ".average_flit_queueing_latency");

368 
m_avg_æ™_queuešg_Ï‹ncy
 =

369 
	`sum
(
m_æ™_queuešg_Ï‹ncy
è/ sum(
m_æ™s_»ûived
);

371 
m_avg_æ™_Ï‹ncy


372 .
	`Çme
(name() + ".average_flit_latency");

373 
m_avg_æ™_Ï‹ncy
 =

374 
m_avg_æ™_ÃtwÜk_Ï‹ncy
 + 
m_avg_æ™_queuešg_Ï‹ncy
;

378 
m_avg_hİs
.
	`Çme
(name() + ".average_hops");

379 
m_avg_hİs
 = 
m_tÙ®_hİs
 / 
	`sum
(
m_æ™s_»ûived
);

382 
m_tÙ®_ext_š_lšk_utiz©iÚ


383 .
	`Çme
(name() + ".ext_in_link_utilization");

384 
m_tÙ®_ext_out_lšk_utiz©iÚ


385 .
	`Çme
(name() + ".ext_out_link_utilization");

386 
m_tÙ®_št_lšk_utiz©iÚ


387 .
	`Çme
(name() + ".int_link_utilization");

388 
m_av”age_lšk_utiz©iÚ


389 .
	`Çme
(name() + ".avg_link_utilization");

391 
m_av”age_vc_lßd


392 .
	`š™
(
m_vœtu®_ÃtwÜks
 * 
m_vcs_³r_vÃt
)

393 .
	`Çme
(name() + ".avg_vc_load")

394 .
	`æags
(
Sts
::
pdf
 | Sts::
tÙ®
 | Sts::
noz”o
 | Sts::
Ú–še
)

396 
	}
}

399 
	gG¬ÃtN‘wÜk
::
	$cŞÏ‹Sts
()

401 
RubySy¡em
 *
rs
 = 
	`·¿ms
()->
ruby_sy¡em
;

402 
time_d–
 = (
	`curCyşe
(è- 
rs
->
	`g‘S¹Cyşe
());

404 
i
 = 0; i < 
m_ÃtwÜklšks
.
	`size
(); i++) {

405 
lšk_ty³
 
ty³
 = 
m_ÃtwÜklšks
[
i
]->
	`g‘Ty³
();

406 
aùiv™y
 = 
m_ÃtwÜklšks
[
i
]->
	`g‘LškUtiz©iÚ
();

408 ià(
ty³
 =ğ
EXT_IN_
)

409 
m_tÙ®_ext_š_lšk_utiz©iÚ
 +ğ
aùiv™y
;

410 ià(
ty³
 =ğ
EXT_OUT_
)

411 
m_tÙ®_ext_out_lšk_utiz©iÚ
 +ğ
aùiv™y
;

412 ià(
ty³
 =ğ
INT_
)

413 
m_tÙ®_št_lšk_utiz©iÚ
 +ğ
aùiv™y
;

415 
m_av”age_lšk_utiz©iÚ
 +=

416 ((
aùiv™y
è/ 
time_d–
);

418 
veùÜ
<> 
vc_lßd
 = 
m_ÃtwÜklšks
[
i
]->
	`g‘VcLßd
();

419 
j
 = 0; j < 
vc_lßd
.
	`size
(); j++) {

420 
m_av”age_vc_lßd
[
j
] +ğ(()
vc_lßd
[j] / 
time_d–
);

425 
i
 = 0; i < 
m_rou‹rs
.
	`size
(); i++) {

426 
m_rou‹rs
[
i
]->
	`cŞÏ‹Sts
();

428 
	}
}

431 
	gG¬ÃtN‘wÜk
::
	$´št
(
o¡»am
& 
out
) const

433 
out
 << "[GarnetNetwork]";

434 
	}
}

436 
G¬ÃtN‘wÜk
 *

437 
	gG¬ÃtN‘wÜkP¬ams
::
	$ü—‹
()

439  
Ãw
 
	`G¬ÃtN‘wÜk
(
this
);

440 
	}
}

442 
ušt32_t


443 
	gG¬ÃtN‘wÜk
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

445 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

447 
i
 = 0; i < 
m_rou‹rs
.
	`size
(); i++) {

448 
num_funùiÚ®_wr™es
 +ğ
m_rou‹rs
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

451 
i
 = 0; i < 
m_nis
.
	`size
(); ++i) {

452 
num_funùiÚ®_wr™es
 +ğ
m_nis
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

455 
i
 = 0; i < 
m_ÃtwÜklšks
.
	`size
(); ++i) {

456 
num_funùiÚ®_wr™es
 +ğ
m_ÃtwÜklšks
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

459  
num_funùiÚ®_wr™es
;

460 
	}
}

	@ruby/network/garnet2.0/GarnetNetwork.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_NETWORK_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_NETWORK_HH__


	)

37 
	~<io¡»am
>

38 
	~<veùÜ
>

40 
	~"mem/ruby/ÃtwÜk/N‘wÜk.hh
"

41 
	~"mem/ruby/ÃtwÜk/çuÉ_mod–/FauÉMod–.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

43 
	~"·¿ms/G¬ÃtN‘wÜk.hh
"

45 
şass
 
	gFauÉMod–
;

46 
şass
 
	gN‘wÜkIÁ”çû
;

47 
şass
 
	gRou‹r
;

48 
şass
 
	gN‘De¡
;

49 
şass
 
	gN‘wÜkLšk
;

50 
şass
 
	gC»d™Lšk
;

52 şas 
	cG¬ÃtN‘wÜk
 : 
public
 
N‘wÜk


54 
public
:

55 
G¬ÃtN‘wÜkP¬ams
 
	tP¬ams
;

56 
G¬ÃtN‘wÜk
(cÚ¡ 
P¬ams
 *
p
);

58 ~
G¬ÃtN‘wÜk
();

59 
š™
();

64 
	$g‘NumRows
(ècÚ¡ {  
m_num_rows
; }

65 
	$g‘NumCŞs
(è{  
m_num_cŞs
; 
	}
}

68 
ušt32_t
 
	$g‘NiFl™Size
(ècÚ¡ {  
m_ni_æ™_size
; 
	}
}

69 
ušt32_t
 
	$g‘VCsP”VÃt
(ècÚ¡ {  
m_vcs_³r_vÃt
; 
	}
}

70 
ušt32_t
 
	$g‘BufãrsP”D©aVC
(è{  
m_bufãrs_³r_d©a_vc
; 
	}
}

71 
ušt32_t
 
	$g‘BufãrsP”CŒlVC
(è{  
m_bufãrs_³r_ù¾_vc
; 
	}
}

72 
	$g‘RoutšgAlgÜ™hm
(ècÚ¡ {  
m_routšg_®gÜ™hm
; 
	}
}

74 
boŞ
 
	$isFauÉMod–EÇbËd
(ècÚ¡ {  
m_’abË_çuÉ_mod–
; 
	}
}

75 
FauÉMod–
* 
	gçuÉ_mod–
;

79 
boŞ
 
	$isVN‘Ord”ed
(
vÃt
ècÚ¡ {  
m_Üd”ed
[vÃt]; 
	}
}

80 
VNET_ty³


81 
	$g‘_vÃt_ty³
(
vc
)

83 
vÃt
 = 
vc
/
	`g‘VCsP”VÃt
();

84  
m_vÃt_ty³
[
vÃt
];

85 
	}
}

86 
g‘NumRou‹rs
();

87 
g‘_rou‹r_id
(
ni
);

91 
makeExtOutLšk
(
Sw™chID
 
¤c
, 
NodeID
 
de¡
, 
BasicLšk
* 
lšk
,

92 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
);

93 
makeExtInLšk
(
NodeID
 
¤c
, 
Sw™chID
 
de¡
, 
BasicLšk
* 
lšk
,

94 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
);

95 
makeIÁ”ÇlLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
, 
BasicLšk
* 
lšk
,

96 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
,

97 
PÜtDœeùiÚ
 
¤c_ouÜt_dœn
,

98 
PÜtDœeùiÚ
 
de¡_špÜt_dœn
);

102 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

105 
cŞÏ‹Sts
();

106 
»gSts
();

107 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

110 
	$šüem’t_šjeùed_·ck‘s
(
vÃt
è{ 
m_·ck‘s_šjeùed
[vÃt]++; 
	}
}

111 
	$šüem’t_»ûived_·ck‘s
(
vÃt
è{ 
m_·ck‘s_»ûived
[vÃt]++; 
	}
}

114 
	$šüem’t_·ck‘_ÃtwÜk_Ï‹ncy
(
Cyşes
 
Ï‹ncy
, 
vÃt
)

116 
m_·ck‘_ÃtwÜk_Ï‹ncy
[
vÃt
] +ğ
Ï‹ncy
;

117 
	}
}

120 
	$šüem’t_·ck‘_queuešg_Ï‹ncy
(
Cyşes
 
Ï‹ncy
, 
vÃt
)

122 
m_·ck‘_queuešg_Ï‹ncy
[
vÃt
] +ğ
Ï‹ncy
;

123 
	}
}

125 
	$šüem’t_šjeùed_æ™s
(
vÃt
è{ 
m_æ™s_šjeùed
[vÃt]++; 
	}
}

126 
	$šüem’t_»ûived_æ™s
(
vÃt
è{ 
m_æ™s_»ûived
[vÃt]++; 
	}
}

129 
	$šüem’t_æ™_ÃtwÜk_Ï‹ncy
(
Cyşes
 
Ï‹ncy
, 
vÃt
)

131 
m_æ™_ÃtwÜk_Ï‹ncy
[
vÃt
] +ğ
Ï‹ncy
;

132 
	}
}

135 
	$šüem’t_æ™_queuešg_Ï‹ncy
(
Cyşes
 
Ï‹ncy
, 
vÃt
)

137 
m_æ™_queuešg_Ï‹ncy
[
vÃt
] +ğ
Ï‹ncy
;

138 
	}
}

141 
	$šüem’t_tÙ®_hİs
(
hİs
)

143 
m_tÙ®_hİs
 +ğ
hİs
;

144 
	}
}

146 
	g´Ùeùed
:

148 
m_num_rows
;

149 
	gm_num_cŞs
;

150 
ušt32_t
 
	gm_ni_æ™_size
;

151 
ušt32_t
 
	gm_vcs_³r_vÃt
;

152 
ušt32_t
 
	gm_bufãrs_³r_ù¾_vc
;

153 
ušt32_t
 
	gm_bufãrs_³r_d©a_vc
;

154 
	gm_routšg_®gÜ™hm
;

155 
boŞ
 
	gm_’abË_çuÉ_mod–
;

158 
	gSts
::
VeùÜ
 
m_·ck‘s_»ûived
;

159 
	gSts
::
VeùÜ
 
m_·ck‘s_šjeùed
;

160 
	gSts
::
VeùÜ
 
m_·ck‘_ÃtwÜk_Ï‹ncy
;

161 
	gSts
::
VeùÜ
 
m_·ck‘_queuešg_Ï‹ncy
;

163 
	gSts
::
FÜmuÏ
 
m_avg_·ck‘_vÃt_Ï‹ncy
;

164 
	gSts
::
FÜmuÏ
 
m_avg_·ck‘_vqueue_Ï‹ncy
;

165 
	gSts
::
FÜmuÏ
 
m_avg_·ck‘_ÃtwÜk_Ï‹ncy
;

166 
	gSts
::
FÜmuÏ
 
m_avg_·ck‘_queuešg_Ï‹ncy
;

167 
	gSts
::
FÜmuÏ
 
m_avg_·ck‘_Ï‹ncy
;

169 
	gSts
::
VeùÜ
 
m_æ™s_»ûived
;

170 
	gSts
::
VeùÜ
 
m_æ™s_šjeùed
;

171 
	gSts
::
VeùÜ
 
m_æ™_ÃtwÜk_Ï‹ncy
;

172 
	gSts
::
VeùÜ
 
m_æ™_queuešg_Ï‹ncy
;

174 
	gSts
::
FÜmuÏ
 
m_avg_æ™_vÃt_Ï‹ncy
;

175 
	gSts
::
FÜmuÏ
 
m_avg_æ™_vqueue_Ï‹ncy
;

176 
	gSts
::
FÜmuÏ
 
m_avg_æ™_ÃtwÜk_Ï‹ncy
;

177 
	gSts
::
FÜmuÏ
 
m_avg_æ™_queuešg_Ï‹ncy
;

178 
	gSts
::
FÜmuÏ
 
m_avg_æ™_Ï‹ncy
;

180 
	gSts
::
SÿÏr
 
m_tÙ®_ext_š_lšk_utiz©iÚ
;

181 
	gSts
::
SÿÏr
 
m_tÙ®_ext_out_lšk_utiz©iÚ
;

182 
	gSts
::
SÿÏr
 
m_tÙ®_št_lšk_utiz©iÚ
;

183 
	gSts
::
SÿÏr
 
m_av”age_lšk_utiz©iÚ
;

184 
	gSts
::
VeùÜ
 
m_av”age_vc_lßd
;

186 
	gSts
::
SÿÏr
 
m_tÙ®_hİs
;

187 
	gSts
::
FÜmuÏ
 
m_avg_hİs
;

189 
	g´iv©e
:

190 
G¬ÃtN‘wÜk
(cÚ¡ G¬ÃtN‘wÜk& 
obj
);

191 
	gG¬ÃtN‘wÜk
& 
	gİ”©Ü
=(cÚ¡ 
G¬ÃtN‘wÜk
& 
obj
);

193 
	g¡d
::
veùÜ
<
VNET_ty³
 > 
m_vÃt_ty³
;

194 
	g¡d
::
veùÜ
<
Rou‹r
 *> 
m_rou‹rs
;

195 
	g¡d
::
veùÜ
<
N‘wÜkLšk
 *> 
m_ÃtwÜklšks
;

196 
	g¡d
::
veùÜ
<
C»d™Lšk
 *> 
m_üed™lšks
;

197 
	g¡d
::
veùÜ
<
N‘wÜkIÁ”çû
 *> 
m_nis
;

200 
šlše
 
	g¡d
::
o¡»am
&

201 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gG¬ÃtN‘wÜk
& 
	gobj
)

203 
	gobj
.
´št
(
out
);

204 
	gout
 << 
	g¡d
::
æush
;

205  
	gout
;

	@ruby/network/garnet2.0/InputUnit.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/IÅutUn™.hh
"

36 
	~"ba£/¡l_h–³rs.hh
"

37 
	~"debug/RubyN‘wÜk.hh
"

38 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™.hh
"

39 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

41 
usšg
 
Çme¥aû
 
	g¡d
;

42 
usšg
 
	gm5
::
¡l_h–³rs
::
d–‘ePoš‹rs
;

44 
	gIÅutUn™
::
	$IÅutUn™
(
id
, 
PÜtDœeùiÚ
 
dœeùiÚ
, 
Rou‹r
 *
rou‹r
)

45 : 
	$CÚsum”
(
rou‹r
)

47 
m_id
 = 
id
;

48 
m_dœeùiÚ
 = 
dœeùiÚ
;

49 
m_rou‹r
 = 
rou‹r
;

50 
m_num_vcs
 = 
m_rou‹r
->
	`g‘_num_vcs
();

51 
m_vc_³r_vÃt
 = 
m_rou‹r
->
	`g‘_vc_³r_vÃt
();

53 
m_num_bufãr_»ads
.
	`»size
(
m_num_vcs
/
m_vc_³r_vÃt
);

54 
m_num_bufãr_wr™es
.
	`»size
(
m_num_vcs
/
m_vc_³r_vÃt
);

55 
i
 = 0; i < 
m_num_bufãr_»ads
.
	`size
(); i++) {

56 
m_num_bufãr_»ads
[
i
] = 0;

57 
m_num_bufãr_wr™es
[
i
] = 0;

60 
üed™Queue
 = 
Ãw
 
	`æ™Bufãr
();

62 
m_vcs
.
	`»size
(
m_num_vcs
);

63 
i
=0; i < 
m_num_vcs
; i++) {

64 
m_vcs
[
i
] = 
Ãw
 
	`Vœtu®ChªÃl
(i);

66 
	}
}

68 
	gIÅutUn™
::~
	$IÅutUn™
()

70 
d–‘e
 
üed™Queue
;

71 
	`d–‘ePoš‹rs
(
m_vcs
);

72 
	}
}

85 
	gIÅutUn™
::
	$wakeup
()

87 
æ™
 *
t_æ™
;

88 ià(
m_š_lšk
->
	`isR—dy
(
m_rou‹r
->
	`curCyşe
())) {

90 
t_æ™
 = 
m_š_lšk
->
	`cÚsumeLšk
();

91 
vc
 = 
t_æ™
->
	`g‘_vc
();

92 
t_æ™
->
	`šüem’t_hİs
();

94 ià((
t_æ™
->
	`g‘_ty³
(è=ğ
HEAD_
) ||

95 (
t_æ™
->
	`g‘_ty³
(è=ğ
HEAD_TAIL_
)) {

97 
	`as£¹
(
m_vcs
[
vc
]->
	`g‘_¡©e
(è=ğ
IDLE_
);

98 
	`£t_vc_aùive
(
vc
, 
m_rou‹r
->
	`curCyşe
());

101 
ouÜt
 = 
m_rou‹r
->
	`rou‹_compu‹
(
t_æ™
->
	`g‘_rou‹
(),

102 
m_id
, 
m_dœeùiÚ
);

107 
	`g¿Á_ouÜt
(
vc
, 
ouÜt
);

110 
	`as£¹
(
m_vcs
[
vc
]->
	`g‘_¡©e
(è=ğ
ACTIVE_
);

115 
m_vcs
[
vc
]->
	`š£¹Fl™
(
t_æ™
);

117 
vÃt
 = 
vc
/
m_vc_³r_vÃt
;

120 
m_num_bufãr_wr™es
[
vÃt
]++;

121 
m_num_bufãr_»ads
[
vÃt
]++;

123 
Cyşes
 
pe_¡ages
 = 
m_rou‹r
->
	`g‘_pe_¡ages
();

124 ià(
pe_¡ages
 == 1) {

127 
t_æ™
->
	`advªû_¡age
(
SA_
, 
m_rou‹r
->
	`curCyşe
());

129 
	`as£¹
(
pe_¡ages
 > 1);

133 
Cyşes
 
wa™_time
 = 
pe_¡ages
 - 
	`Cyşes
(1);

134 
t_æ™
->
	`advªû_¡age
(
SA_
, 
m_rou‹r
->
	`curCyşe
(è+ 
wa™_time
);

137 
m_rou‹r
->
	`scheduË_wakeup
(
	`Cyşes
(
wa™_time
));

140 
	}
}

145 
	gIÅutUn™
::
	$šüem’t_üed™
(
š_vc
, 
boŞ
 
ä“_sigÇl
, 
Cyşes
 
curTime
)

147 
C»d™
 *
t_üed™
 = 
Ãw
 
	`C»d™
(
š_vc
, 
ä“_sigÇl
, 
curTime
);

148 
üed™Queue
->
	`š£¹
(
t_üed™
);

149 
m_üed™_lšk
->
	`scheduËEv’tAbsŞu‹
(
m_rou‹r
->
	`şockEdge
(
	`Cyşes
(1)));

150 
	}
}

153 
ušt32_t


154 
	gIÅutUn™
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

156 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

157 
i
=0; i < 
m_num_vcs
; i++) {

158 
num_funùiÚ®_wr™es
 +ğ
m_vcs
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

161  
num_funùiÚ®_wr™es
;

162 
	}
}

165 
	gIÅutUn™
::
	$»£tSts
()

167 
j
 = 0; j < 
m_num_bufãr_»ads
.
	`size
(); j++) {

168 
m_num_bufãr_»ads
[
j
] = 0;

169 
m_num_bufãr_wr™es
[
j
] = 0;

171 
	}
}

	@ruby/network/garnet2.0/InputUnit.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_INPUT_UNIT_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_INPUT_UNIT_HH__


	)

37 
	~<io¡»am
>

38 
	~<veùÜ
>

40 
	~"mem/ruby/commÚ/CÚsum”.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™Lšk.hh
"

43 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

44 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

45 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Vœtu®ChªÃl.hh
"

46 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™Bufãr.hh
"

48 şas 
	cIÅutUn™
 : 
public
 
CÚsum”


50 
public
:

51 
IÅutUn™
(
id
, 
PÜtDœeùiÚ
 
dœeùiÚ
, 
Rou‹r
 *
rou‹r
);

52 ~
IÅutUn™
();

54 
wakeup
();

55 
	$´št
(
¡d
::
o¡»am
& 
out
) const {};

57 
šlše
 
PÜtDœeùiÚ
 
	$g‘_dœeùiÚ
(è{  
m_dœeùiÚ
; 
	}
}

59 
šlše
 

60 
	$£t_vc_idË
(
vc
, 
Cyşes
 
curTime
)

62 
m_vcs
[
vc
]->
	`£t_idË
(
curTime
);

63 
	}
}

65 
šlše
 

66 
	$£t_vc_aùive
(
vc
, 
Cyşes
 
curTime
)

68 
m_vcs
[
vc
]->
	`£t_aùive
(
curTime
);

69 
	}
}

71 
šlše
 

72 
	$g¿Á_ouÜt
(
vc
, 
ouÜt
)

74 
m_vcs
[
vc
]->
	`£t_ouÜt
(
ouÜt
);

75 
	}
}

77 
šlše
 

78 
	$g¿Á_outvc
(
vc
, 
outvc
)

80 
m_vcs
[
vc
]->
	`£t_outvc
(
outvc
);

81 
	}
}

83 
šlše
 

84 
	$g‘_ouÜt
(
švc
)

86  
m_vcs
[
švc
]->
	`g‘_ouÜt
();

87 
	}
}

89 
šlše
 

90 
	$g‘_outvc
(
švc
)

92  
m_vcs
[
švc
]->
	`g‘_outvc
();

93 
	}
}

95 
šlše
 
Cyşes


96 
	$g‘_’queue_time
(
švc
)

98  
m_vcs
[
švc
]->
	`g‘_’queue_time
();

99 
	}
}

101 
šüem’t_üed™
(
š_vc
, 
boŞ
 
ä“_sigÇl
, 
Cyşes
 
curTime
);

103 
šlše
 
æ™
*

104 
	$³ekTİFl™
(
vc
)

106  
m_vcs
[
vc
]->
	`³ekTİFl™
();

107 
	}
}

109 
šlše
 
æ™
*

110 
	$g‘TİFl™
(
vc
)

112  
m_vcs
[
vc
]->
	`g‘TİFl™
();

113 
	}
}

115 
šlše
 
boŞ


116 
	$Ãed_¡age
(
vc
, 
æ™_¡age
 
¡age
, 
Cyşes
 
time
)

118  
m_vcs
[
vc
]->
	`Ãed_¡age
(
¡age
, 
time
);

119 
	}
}

121 
šlše
 
boŞ


122 
	$isR—dy
(
švc
, 
Cyşes
 
curTime
)

124  
m_vcs
[
švc
]->
	`isR—dy
(
curTime
);

125 
	}
}

127 
æ™Bufãr
* 
	$g‘C»d™Queue
(è{  
üed™Queue
; 
	}
}

129 
šlše
 

130 
	$£t_š_lšk
(
N‘wÜkLšk
 *
lšk
)

132 
m_š_lšk
 = 
lšk
;

133 
	}
}

135 
šlše
 
	$g‘_šlšk_id
(è{  
m_š_lšk
->
	`g‘_id
(); 
	}
}

137 
šlše
 

138 
	$£t_üed™_lšk
(
C»d™Lšk
 *
üed™_lšk
)

140 
m_üed™_lšk
 = 
üed™_lšk
;

141 
	}
}

143 
	$g‘_buf_»ad_aùiv™y
(
vÃt
) const

144 {  
m_num_bufãr_»ads
[
vÃt
]; 
	}
}

145 
	$g‘_buf_wr™e_aùiv™y
(
vÃt
) const

146 {  
m_num_bufãr_wr™es
[
vÃt
]; 
	}
}

148 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

149 
»£tSts
();

151 
	g´iv©e
:

152 
m_id
;

153 
PÜtDœeùiÚ
 
	gm_dœeùiÚ
;

154 
	gm_num_vcs
;

155 
	gm_vc_³r_vÃt
;

157 
Rou‹r
 *
	gm_rou‹r
;

158 
N‘wÜkLšk
 *
	gm_š_lšk
;

159 
C»d™Lšk
 *
	gm_üed™_lšk
;

160 
æ™Bufãr
 *
	güed™Queue
;

163 
	g¡d
::
veùÜ
<
Vœtu®ChªÃl
 *> 
m_vcs
;

166 
	g¡d
::
veùÜ
<> 
m_num_bufãr_wr™es
;

167 
	g¡d
::
veùÜ
<> 
m_num_bufãr_»ads
;

	@ruby/network/garnet2.0/NetworkInterface.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkIÁ”çû.hh
"

36 
	~<ÿs£¹
>

37 
	~<cm©h
>

39 
	~"ba£/ÿ¡.hh
"

40 
	~"ba£/¡l_h–³rs.hh
"

41 
	~"debug/RubyN‘wÜk.hh
"

42 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

43 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™.hh
"

44 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™Bufãr.hh
"

45 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

47 
usšg
 
Çme¥aû
 
	g¡d
;

48 
usšg
 
	gm5
::
¡l_h–³rs
::
d–‘ePoš‹rs
;

50 
	gN‘wÜkIÁ”çû
::
	$N‘wÜkIÁ”çû
(cÚ¡ 
P¬ams
 *
p
)

51 : 
	`ClockedObjeù
(
p
), 
	`CÚsum”
(
this
), 
	`m_id
Õ->
id
),

52 
	`m_vœtu®_ÃtwÜks
(
p
->
vœt_Ãts
), 
	`m_vc_³r_vÃt
Õ->
vcs_³r_vÃt
),

53 
	$m_num_vcs
(
m_vc_³r_vÃt
 * 
m_vœtu®_ÃtwÜks
)

55 
m_rou‹r_id
 = -1;

56 
m_vc_round_robš
 = 0;

57 
m_ni_out_vcs
.
	`»size
(
m_num_vcs
);

58 
m_ni_out_vcs_’queue_time
.
	`»size
(
m_num_vcs
);

59 
outC»d™Queue
 = 
Ãw
 
	`æ™Bufãr
();

62 
i
 = 0; i < 
m_num_vcs
; i++) {

63 
m_ni_out_vcs
[
i
] = 
Ãw
 
	`æ™Bufãr
();

64 
m_ni_out_vcs_’queue_time
[
i
] = 
	`Cyşes
(
INFINITE_
);

67 
m_vc_®loÿtÜ
.
	`»size
(
m_vœtu®_ÃtwÜks
);

68 
i
 = 0; i < 
m_vœtu®_ÃtwÜks
; i++) {

69 
m_vc_®loÿtÜ
[
i
] = 0;

71 
	}
}

74 
	gN‘wÜkIÁ”çû
::
	$š™
()

76 
i
 = 0; i < 
m_num_vcs
; i++) {

77 
m_out_vc_¡©e
.
	`push_back
(
Ãw
 
	`OutVcS‹
(
i
, 
m_Ãt_±r
));

79 
	}
}

81 
	gN‘wÜkIÁ”çû
::~
	$N‘wÜkIÁ”çû
()

83 
	`d–‘ePoš‹rs
(
m_out_vc_¡©e
);

84 
	`d–‘ePoš‹rs
(
m_ni_out_vcs
);

85 
d–‘e
 
outC»d™Queue
;

86 
d–‘e
 
outFl™Queue
;

87 
	}
}

90 
	gN‘wÜkIÁ”çû
::
	$addInPÜt
(
N‘wÜkLšk
 *
š_lšk
,

91 
C»d™Lšk
 *
üed™_lšk
)

93 
šN‘Lšk
 = 
š_lšk
;

94 
š_lšk
->
	`£tLškCÚsum”
(
this
);

95 
outC»d™Lšk
 = 
üed™_lšk
;

96 
üed™_lšk
->
	`£tSourûQueue
(
outC»d™Queue
);

97 
	}
}

100 
	gN‘wÜkIÁ”çû
::
	$addOutPÜt
(
N‘wÜkLšk
 *
out_lšk
,

101 
C»d™Lšk
 *
üed™_lšk
,

102 
Sw™chID
 
rou‹r_id
)

104 
šC»d™Lšk
 = 
üed™_lšk
;

105 
üed™_lšk
->
	`£tLškCÚsum”
(
this
);

107 
outN‘Lšk
 = 
out_lšk
;

108 
outFl™Queue
 = 
Ãw
 
	`æ™Bufãr
();

109 
out_lšk
->
	`£tSourûQueue
(
outFl™Queue
);

111 
m_rou‹r_id
 = 
rou‹r_id
;

112 
	}
}

115 
	gN‘wÜkIÁ”çû
::
addNode
(
veùÜ
<
Mes§geBufãr
 *>& 
š
,

116 
veùÜ
<
Mes§geBufãr
 *>& 
out
)

118 
	gšNode_±r
 = 
š
;

119 
	goutNode_±r
 = 
out
;

121 auto& 
	g™
 : 
š
) {

122 ià(
™
 !ğ
nuÎ±r
) {

123 
™
->
£tCÚsum”
(
this
);

140 
	gN‘wÜkIÁ”çû
::
	$wakeup
()

142 
	`DPRINTF
(
RubyN‘wÜk
, "Network Interface %d connectedo„outer %d "

143 "woku°©ime: %Îd\n", 
m_id
, 
m_rou‹r_id
, 
	`curCyşe
());

145 
MsgPŒ
 
msg_±r
;

146 
Tick
 
curTime
 = 
	`şockEdge
();

150 
vÃt
 = 0; vÃˆ< 
šNode_±r
.
	`size
(); ++vnet) {

151 
Mes§geBufãr
 *
b
 = 
šNode_±r
[
vÃt
];

152 ià(
b
 =ğ
nuÎ±r
) {

156 ià(
b
->
	`isR—dy
(
curTime
)) {

157 
msg_±r
 = 
b
->
	`³ekMsgPŒ
();

158 ià(
	`æ™isizeMes§ge
(
msg_±r
, 
vÃt
)) {

159 
b
->
	`dequeue
(
curTime
);

166 
	`scheduËOuutLšk
();

167 
	`checkRescheduË
();

171 ià(
šN‘Lšk
->
	`isR—dy
(
	`curCyşe
())) {

172 
æ™
 *
t_æ™
 = 
šN‘Lšk
->
	`cÚsumeLšk
();

173 
boŞ
 
ä“_sigÇl
 = 
çl£
;

174 ià(
t_æ™
->
	`g‘_ty³
(è=ğ
TAIL_
 ||_æ™->g‘_ty³(è=ğ
HEAD_TAIL_
) {

175 
ä“_sigÇl
 = 
Œue
;

178 
outNode_±r
[
t_æ™
->
	`g‘_vÃt
()]->
	`’queue
(

179 
t_æ™
->
	`g‘_msg_±r
(), 
curTime
, 
	`cyşesToTicks
(
	`Cyşes
(1)));

183 
C»d™
 *
t_üed™
 = 
Ãw
 
	`C»d™
(
t_æ™
->
	`g‘_vc
(), 
ä“_sigÇl
,

184 
	`curCyşe
());

185 
outC»d™Queue
->
	`š£¹
(
t_üed™
);

186 
outC»d™Lšk
->

187 
	`scheduËEv’tAbsŞu‹
(
	`şockEdge
(
	`Cyşes
(1)));

189 
vÃt
 = 
t_æ™
->
	`g‘_vÃt
();

194 
m_Ãt_±r
->
	`šüem’t_»ûived_æ™s
(
vÃt
);

195 
Cyşes
 
ÃtwÜk_d–ay
 = 
	`curCyşe
(è- 
t_æ™
->
	`g‘_’queue_time
();

196 
Cyşes
 
queuešg_d–ay
 = 
t_æ™
->
	`g‘_¤c_d–ay
();

198 
m_Ãt_±r
->
	`šüem’t_æ™_ÃtwÜk_Ï‹ncy
(
ÃtwÜk_d–ay
, 
vÃt
);

199 
m_Ãt_±r
->
	`šüem’t_æ™_queuešg_Ï‹ncy
(
queuešg_d–ay
, 
vÃt
);

201 ià(
t_æ™
->
	`g‘_ty³
(è=ğ
TAIL_
 ||_æ™->g‘_ty³(è=ğ
HEAD_TAIL_
) {

202 
m_Ãt_±r
->
	`šüem’t_»ûived_·ck‘s
(
vÃt
);

203 
m_Ãt_±r
->
	`šüem’t_·ck‘_ÃtwÜk_Ï‹ncy
(
ÃtwÜk_d–ay
, 
vÃt
);

204 
m_Ãt_±r
->
	`šüem’t_·ck‘_queuešg_Ï‹ncy
(
queuešg_d–ay
, 
vÃt
);

208 
m_Ãt_±r
->
	`šüem’t_tÙ®_hİs
(
t_æ™
->
	`g‘_rou‹
().
hİs_Œav”£d
);

210 
d–‘e
 
t_æ™
;

215 ià(
šC»d™Lšk
->
	`isR—dy
(
	`curCyşe
())) {

216 
C»d™
 *
t_üed™
 = (C»d™*è
šC»d™Lšk
->
	`cÚsumeLšk
();

217 
m_out_vc_¡©e
[
t_üed™
->
	`g‘_vc
()]->
	`šüem’t_üed™
();

218 ià(
t_üed™
->
	`is_ä“_sigÇl
()) {

219 
m_out_vc_¡©e
[
t_üed™
->
	`g‘_vc
()]->
	`£tS‹
(
IDLE_
, 
	`curCyşe
());

221 
d–‘e
 
t_üed™
;

223 
	}
}

227 
boŞ


228 
	gN‘wÜkIÁ”çû
::
	$æ™isizeMes§ge
(
MsgPŒ
 
msg_±r
, 
vÃt
)

230 
Mes§ge
 *
Ãt_msg_±r
 = 
msg_±r
.
	`g‘
();

231 
N‘De¡
 
Ãt_msg_de¡
 = 
Ãt_msg_±r
->
	`g‘De¡š©iÚ
();

234 
veùÜ
<
NodeID
> 
de¡_nodes
 = 
Ãt_msg_de¡
.
	`g‘AÎDe¡
();

238 
num_æ™s
 = (è
	`û
((è
m_Ãt_±r
->
	`Mes§geSizeTy³_to_št
(

239 
Ãt_msg_±r
->
	`g‘Mes§geSize
())/
m_Ãt_±r
->
	`g‘NiFl™Size
());

242 
ùr
 = 0; cŒ < 
de¡_nodes
.
	`size
(); ctr++) {

245 
vc
 = 
	`ÿlcuÏ‹VC
(
vÃt
);

247 ià(
vc
 == -1) {

248  
çl£
 ;

250 
MsgPŒ
 
Ãw_msg_±r
 = 
msg_±r
->
	`şÚe
();

251 
NodeID
 
de¡ID
 = 
de¡_nodes
[
ùr
];

253 
Mes§ge
 *
Ãw_Ãt_msg_±r
 = 
Ãw_msg_±r
.
	`g‘
();

254 ià(
de¡_nodes
.
	`size
() > 1) {

255 
N‘De¡
 
³rsÚ®_de¡
;

256 
m
 = 0; m < (è
MachšeTy³_NUM
; m++) {

257 ià((
de¡ID
 >ğ
	`MachšeTy³_ba£_numb”
((
MachšeTy³
è
m
)) &&

258 
de¡ID
 < 
	`MachšeTy³_ba£_numb”
((
MachšeTy³
è(
m
+1))) {

260 
³rsÚ®_de¡
.
	`ş—r
();

261 
³rsÚ®_de¡
.
	`add
((
MachšeID
è{(
MachšeTy³
è
m
, (
de¡ID
 -

262 
	`MachšeTy³_ba£_numb”
((
MachšeTy³
è
m
))});

263 
Ãw_Ãt_msg_±r
->
	`g‘De¡š©iÚ
(èğ
³rsÚ®_de¡
;

267 
Ãt_msg_de¡
.
	`»moveN‘De¡
(
³rsÚ®_de¡
);

271 
Ãt_msg_±r
->
	`g‘De¡š©iÚ
().
	`»moveN‘De¡
(
³rsÚ®_de¡
);

277 
Rou‹Info
 
rou‹
;

278 
rou‹
.
vÃt
 = vnet;

279 
rou‹
.
Ãt_de¡
 = 
Ãw_Ãt_msg_±r
->
	`g‘De¡š©iÚ
();

280 
rou‹
.
¤c_ni
 = 
m_id
;

281 
rou‹
.
¤c_rou‹r
 = 
m_rou‹r_id
;

282 
rou‹
.
de¡_ni
 = 
de¡ID
;

283 
rou‹
.
de¡_rou‹r
 = 
m_Ãt_±r
->
	`g‘_rou‹r_id
(
de¡ID
);

287 
rou‹
.
hİs_Œav”£d
 = -1;

289 
m_Ãt_±r
->
	`šüem’t_šjeùed_·ck‘s
(
vÃt
);

290 
i
 = 0; i < 
num_æ™s
; i++) {

291 
m_Ãt_±r
->
	`šüem’t_šjeùed_æ™s
(
vÃt
);

292 
æ™
 *
æ
 = 
Ãw
 
	`æ™
(
i
, 
vc
, 
vÃt
, 
rou‹
, 
num_æ™s
, 
Ãw_msg_±r
,

293 
	`curCyşe
());

295 
æ
->
	`£t_¤c_d–ay
(
	`curCyşe
(è- 
	`ticksToCyşes
(
msg_±r
->
	`g‘Time
()));

296 
m_ni_out_vcs
[
vc
]->
	`š£¹
(
æ
);

299 
m_ni_out_vcs_’queue_time
[
vc
] = 
	`curCyşe
();

300 
m_out_vc_¡©e
[
vc
]->
	`£tS‹
(
ACTIVE_
, 
	`curCyşe
());

302  
Œue
 ;

303 
	}
}

307 
	gN‘wÜkIÁ”çû
::
	$ÿlcuÏ‹VC
(
vÃt
)

309 
i
 = 0; i < 
m_vc_³r_vÃt
; i++) {

310 
d–
 = 
m_vc_®loÿtÜ
[
vÃt
];

311 
m_vc_®loÿtÜ
[
vÃt
]++;

312 ià(
m_vc_®loÿtÜ
[
vÃt
] =ğ
m_vc_³r_vÃt
)

313 
m_vc_®loÿtÜ
[
vÃt
] = 0;

315 ià(
m_out_vc_¡©e
[(
vÃt
*
m_vc_³r_vÃt
è+ 
d–
]->
	`isInS‹
(

316 
IDLE_
, 
	`curCyşe
())) {

317  ((
vÃt
*
m_vc_³r_vÃt
è+ 
d–
);

321 
	}
}

331 
	gN‘wÜkIÁ”çû
::
	$scheduËOuutLšk
()

333 
vc
 = 
m_vc_round_robš
;

334 
m_vc_round_robš
++;

335 ià(
m_vc_round_robš
 =ğ
m_num_vcs
)

336 
m_vc_round_robš
 = 0;

338 
i
 = 0; i < 
m_num_vcs
; i++) {

339 
vc
++;

340 ià(
vc
 =ğ
m_num_vcs
)

341 
vc
 = 0;

344 ià(
m_ni_out_vcs
[
vc
]->
	`isR—dy
(
	`curCyşe
()) &&

345 
m_out_vc_¡©e
[
vc
]->
	`has_üed™
()) {

347 
boŞ
 
is_ÿndid©e_vc
 = 
Œue
;

348 
t_vÃt
 = 
	`g‘_vÃt
(
vc
);

349 
vc_ba£
 = 
t_vÃt
 * 
m_vc_³r_vÃt
;

351 ià(
m_Ãt_±r
->
	`isVN‘Ord”ed
(
t_vÃt
)) {

352 
vc_off£t
 = 0; vc_off£ˆ< 
m_vc_³r_vÃt
;

353 
vc_off£t
++) {

354 
t_vc
 = 
vc_ba£
 + 
vc_off£t
;

355 ià(
m_ni_out_vcs
[
t_vc
]->
	`isR—dy
(
	`curCyşe
())) {

356 ià(
m_ni_out_vcs_’queue_time
[
t_vc
] <

357 
m_ni_out_vcs_’queue_time
[
vc
]) {

358 
is_ÿndid©e_vc
 = 
çl£
;

364 ià(!
is_ÿndid©e_vc
)

367 
m_out_vc_¡©e
[
vc
]->
	`deüem’t_üed™
();

369 
æ™
 *
t_æ™
 = 
m_ni_out_vcs
[
vc
]->
	`g‘TİFl™
();

370 
t_æ™
->
	`£t_time
(
	`curCyşe
(è+ 
	`Cyşes
(1));

371 
outFl™Queue
->
	`š£¹
(
t_æ™
);

373 
outN‘Lšk
->
	`scheduËEv’tAbsŞu‹
(
	`şockEdge
(
	`Cyşes
(1)));

375 ià(
t_æ™
->
	`g‘_ty³
(è=ğ
TAIL_
 ||

376 
t_æ™
->
	`g‘_ty³
(è=ğ
HEAD_TAIL_
) {

377 
m_ni_out_vcs_’queue_time
[
vc
] = 
	`Cyşes
(
INFINITE_
);

382 
	}
}

385 
	gN‘wÜkIÁ”çû
::
	$g‘_vÃt
(
vc
)

387 
i
 = 0; i < 
m_vœtu®_ÃtwÜks
; i++) {

388 ià(
vc
 >ğ(
i
*
m_vc_³r_vÃt
) && vc < ((i+1)*m_vc_per_vnet)) {

389  
i
;

392 
	`çl
("Could‚ot determine vc");

393 
	}
}

400 
	gN‘wÜkIÁ”çû
::
	$checkRescheduË
()

402 cÚ¡‡uto& 
™
 : 
šNode_±r
) {

403 ià(
™
 =ğ
nuÎ±r
) {

407 
™
->
	`isR—dy
(
	`şockEdge
())) {

408 
	`scheduËEv’t
(
	`Cyşes
(1));

413 
vc
 = 0; vø< 
m_num_vcs
; vc++) {

414 ià(
m_ni_out_vcs
[
vc
]->
	`isR—dy
(
	`curCyşe
(è+ 
	`Cyşes
(1))) {

415 
	`scheduËEv’t
(
	`Cyşes
(1));

419 
	}
}

422 
	gN‘wÜkIÁ”çû
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

424 
out
 << "[Network Interface]";

425 
	}
}

427 
ušt32_t


428 
	gN‘wÜkIÁ”çû
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

430 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

431 
i
 = 0; i < 
m_num_vcs
; ++i) {

432 
num_funùiÚ®_wr™es
 +ğ
m_ni_out_vcs
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

435 
num_funùiÚ®_wr™es
 +ğ
outFl™Queue
->
	`funùiÚ®Wr™e
(
pkt
);

436  
num_funùiÚ®_wr™es
;

437 
	}
}

439 
N‘wÜkIÁ”çû
 *

440 
	gG¬ÃtN‘wÜkIÁ”çûP¬ams
::
	$ü—‹
()

442  
Ãw
 
	`N‘wÜkIÁ”çû
(
this
);

443 
	}
}

	@ruby/network/garnet2.0/NetworkInterface.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_NETWORK_INTERFACE_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_NETWORK_INTERFACE_HH__


	)

37 
	~<io¡»am
>

38 
	~<veùÜ
>

40 
	~"mem/ruby/commÚ/CÚsum”.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™Lšk.hh
"

43 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtN‘wÜk.hh
"

44 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

45 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/OutVcS‹.hh
"

46 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

47 
	~"·¿ms/G¬ÃtN‘wÜkIÁ”çû.hh
"

49 
şass
 
	gMes§geBufãr
;

50 
şass
 
	gæ™Bufãr
;

52 
şass
 
	gN‘wÜkIÁ”çû
 : 
public
 
ClockedObjeù
,…ubliø
	gCÚsum”


54 
	gpublic
:

55 
G¬ÃtN‘wÜkIÁ”çûP¬ams
 
	tP¬ams
;

56 
N‘wÜkIÁ”çû
(cÚ¡ 
P¬ams
 *
p
);

57 ~
N‘wÜkIÁ”çû
();

59 
š™
();

61 
addInPÜt
(
N‘wÜkLšk
 *
š_lšk
, 
C»d™Lšk
 *
üed™_lšk
);

62 
addOutPÜt
(
N‘wÜkLšk
 *
out_lšk
, 
C»d™Lšk
 *
üed™_lšk
,

63 
Sw™chID
 
rou‹r_id
);

65 
wakeup
();

66 
addNode
(
¡d
::
veùÜ
<
Mes§geBufãr
 *> &
šNode
,

67 
¡d
::
veùÜ
<
Mes§geBufãr
 *> &
outNode
);

69 
´št
(
¡d
::
o¡»am
& 
out
) const;

70 
g‘_vÃt
(
vc
);

71 
g‘_rou‹r_id
(è{  
	gm_rou‹r_id
; }

72 
š™_Ãt_±r
(
G¬ÃtN‘wÜk
 *
Ãt_±r
è{ 
	gm_Ãt_±r
 =‚et_ptr; }

74 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *);

76 
	g´iv©e
:

77 
G¬ÃtN‘wÜk
 *
m_Ãt_±r
;

78 cÚ¡ 
NodeID
 
	gm_id
;

79 cÚ¡ 
	gm_vœtu®_ÃtwÜks
, 
	gm_vc_³r_vÃt
, 
	gm_num_vcs
;

80 
	gm_rou‹r_id
;

81 
	g¡d
::
veùÜ
<
OutVcS‹
 *> 
m_out_vc_¡©e
;

82 
	g¡d
::
veùÜ
<> 
m_vc_®loÿtÜ
;

83 
	gm_vc_round_robš
;

84 
æ™Bufãr
 *
	goutFl™Queue
;

85 
æ™Bufãr
 *
	goutC»d™Queue
;

87 
N‘wÜkLšk
 *
	gšN‘Lšk
;

88 
N‘wÜkLšk
 *
	goutN‘Lšk
;

89 
C»d™Lšk
 *
	gšC»d™Lšk
;

90 
C»d™Lšk
 *
	goutC»d™Lšk
;

94 
	g¡d
::
veùÜ
<
æ™Bufãr
 *> 
m_ni_out_vcs
;

95 
	g¡d
::
veùÜ
<
Cyşes
> 
m_ni_out_vcs_’queue_time
;

98 
	g¡d
::
veùÜ
<
Mes§geBufãr
 *> 
šNode_±r
;

100 
	g¡d
::
veùÜ
<
Mes§geBufãr
 *> 
outNode_±r
;

102 
boŞ
 
æ™isizeMes§ge
(
MsgPŒ
 
msg_±r
, 
vÃt
);

103 
ÿlcuÏ‹VC
(
vÃt
);

104 
scheduËOuutLšk
();

105 
checkRescheduË
();

	@ruby/network/garnet2.0/NetworkLink.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

36 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™Lšk.hh
"

38 
	gN‘wÜkLšk
::
	$N‘wÜkLšk
(cÚ¡ 
P¬ams
 *
p
)

39 : 
	`ClockedObjeù
(
p
), 
	`CÚsum”
(
this
), 
	`m_id
Õ->
lšk_id
),

40 
	`m_ty³
(
NUM_LINK_TYPES_
),

41 
	`m_Ï‹ncy
(
p
->
lšk_Ï‹ncy
),

42 
	`lškBufãr
(
Ãw
 
	`æ™Bufãr
()), 
	`lšk_cÚsum”
(
nuÎ±r
),

43 
	`lšk_¤cQueue
(
nuÎ±r
), 
	`m_lšk_utized
(0),

44 
	`m_vc_lßd
(
p
->
vcs_³r_vÃt
 *…->
vœt_Ãts
)

46 
	}
}

48 
	gN‘wÜkLšk
::~
	$N‘wÜkLšk
()

50 
d–‘e
 
lškBufãr
;

51 
	}
}

54 
	gN‘wÜkLšk
::
	$£tLškCÚsum”
(
CÚsum”
 *
cÚsum”
)

56 
lšk_cÚsum”
 = 
cÚsum”
;

57 
	}
}

60 
	gN‘wÜkLšk
::
	$£tSourûQueue
(
æ™Bufãr
 *
¤cQueue
)

62 
lšk_¤cQueue
 = 
¤cQueue
;

63 
	}
}

66 
	gN‘wÜkLšk
::
	$wakeup
()

68 ià(
lšk_¤cQueue
->
	`isR—dy
(
	`curCyşe
())) {

69 
æ™
 *
t_æ™
 = 
lšk_¤cQueue
->
	`g‘TİFl™
();

70 
t_æ™
->
	`£t_time
(
	`curCyşe
(è+ 
m_Ï‹ncy
);

71 
lškBufãr
->
	`š£¹
(
t_æ™
);

72 
lšk_cÚsum”
->
	`scheduËEv’tAbsŞu‹
(
	`şockEdge
(
m_Ï‹ncy
));

73 
m_lšk_utized
++;

74 
m_vc_lßd
[
t_æ™
->
	`g‘_vc
()]++;

76 
	}
}

78 
N‘wÜkLšk
 *

79 
	gN‘wÜkLškP¬ams
::
	$ü—‹
()

81  
Ãw
 
	`N‘wÜkLšk
(
this
);

82 
	}
}

84 
C»d™Lšk
 *

85 
	gC»d™LškP¬ams
::
	$ü—‹
()

87  
Ãw
 
	`C»d™Lšk
(
this
);

88 
	}
}

90 
ušt32_t


91 
	gN‘wÜkLšk
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

93  
lškBufãr
->
	`funùiÚ®Wr™e
(
pkt
);

94 
	}
}

	@ruby/network/garnet2.0/NetworkLink.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_NETWORK_LINK_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_NETWORK_LINK_HH__


	)

37 
	~<io¡»am
>

38 
	~<veùÜ
>

40 
	~"mem/ruby/commÚ/CÚsum”.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™Bufãr.hh
"

43 
	~"·¿ms/N‘wÜkLšk.hh
"

44 
	~"sim/şocked_objeù.hh
"

46 
şass
 
	gG¬ÃtN‘wÜk
;

48 
şass
 
	gN‘wÜkLšk
 : 
public
 
ClockedObjeù
,…ubliø
	gCÚsum”


50 
	gpublic
:

51 
N‘wÜkLškP¬ams
 
	tP¬ams
;

52 
N‘wÜkLšk
(cÚ¡ 
P¬ams
 *
p
);

53 ~
N‘wÜkLšk
();

55 
£tLškCÚsum”
(
CÚsum”
 *
cÚsum”
);

56 
£tSourûQueue
(
æ™Bufãr
 *
¤cQueue
);

57 
£tTy³
(
lšk_ty³
 
ty³
è{ 
	gm_ty³
 =ype; }

58 
lšk_ty³
 
g‘Ty³
(è{  
	gm_ty³
; }

59 
´št
(
¡d
::
o¡»am
& 
out
) const {}

60 
g‘_id
(ècÚ¡ {  
m_id
; }

61 
wakeup
();

63 
g‘LškUtiz©iÚ
(ècÚ¡ {  
	gm_lšk_utized
; }

64 cÚ¡ 
	g¡d
::
veùÜ
<> & 
g‘VcLßd
(ècÚ¡ {  
m_vc_lßd
; }

66 
šlše
 
boŞ
 
isR—dy
(
Cyşes
 
curTime
)

67 {  
	glškBufãr
->
isR—dy
(
curTime
); }

69 
šlše
 
æ™
* 
³ekLšk
(è{  
	glškBufãr
->
³ekTİFl™
(); }

70 
šlše
 
æ™
* 
cÚsumeLšk
(è{  
	glškBufãr
->
g‘TİFl™
(); }

72 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *);

74 
	g´iv©e
:

75 cÚ¡ 
m_id
;

76 
lšk_ty³
 
	gm_ty³
;

77 cÚ¡ 
Cyşes
 
	gm_Ï‹ncy
;

79 
æ™Bufãr
 *
	glškBufãr
;

80 
CÚsum”
 *
	glšk_cÚsum”
;

81 
æ™Bufãr
 *
	glšk_¤cQueue
;

84 
	gm_lšk_utized
;

85 
	g¡d
::
veùÜ
<> 
m_vc_lßd
;

	@ruby/network/garnet2.0/OutVcState.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/OutVcS‹.hh
"

36 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

38 
	gOutVcS‹
::
	$OutVcS‹
(
id
, 
G¬ÃtN‘wÜk
 *
ÃtwÜk_±r
)

39 : 
	$m_time
(0)

41 
m_id
 = 
id
;

42 
m_vc_¡©e
 = 
IDLE_
;

44 ià(
ÃtwÜk_±r
->
	`g‘_vÃt_ty³
(
id
è=ğ
DATA_VNET_
)

45 
m_max_üed™_couÁ
 = 
ÃtwÜk_±r
->
	`g‘BufãrsP”D©aVC
();

47 
m_max_üed™_couÁ
 = 
ÃtwÜk_±r
->
	`g‘BufãrsP”CŒlVC
();

49 
m_üed™_couÁ
 = 
m_max_üed™_couÁ
;

50 
	`as£¹
(
m_üed™_couÁ
 >= 1);

51 
	}
}

54 
	gOutVcS‹
::
	$šüem’t_üed™
()

56 
m_üed™_couÁ
++;

57 
	`as£¹
(
m_üed™_couÁ
 <ğ
m_max_üed™_couÁ
);

58 
	}
}

61 
	gOutVcS‹
::
	$deüem’t_üed™
()

63 
m_üed™_couÁ
--;

64 
	`as£¹
(
m_üed™_couÁ
 >= 0);

65 
	}
}

	@ruby/network/garnet2.0/OutVcState.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_OUTVC_STATE_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_OUTVC_STATE_HH__


	)

37 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

38 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtN‘wÜk.hh
"

40 şas 
	cOutVcS‹


42 
	mpublic
:

43 
OutVcS‹
(
id
, 
G¬ÃtN‘wÜk
 *
ÃtwÜk_±r
);

45 
	$g‘_üed™_couÁ
(è{  
m_üed™_couÁ
; }

46 
šlše
 
boŞ
 
	$has_üed™
(è{  (
m_üed™_couÁ
 > 0); 
	}
}

47 
šüem’t_üed™
();

48 
deüem’t_üed™
();

50 
šlše
 
boŞ


51 
	$isInS‹
(
VC_¡©e_ty³
 
¡©e
, 
Cyşes
 
»que¡_time
)

53  ((
m_vc_¡©e
 =ğ
¡©e
è&& (
»que¡_time
 >ğ
m_time
) );

54 
	}
}

55 
šlše
 

56 
	$£tS‹
(
VC_¡©e_ty³
 
¡©e
, 
Cyşes
 
time
)

58 
m_vc_¡©e
 = 
¡©e
;

59 
m_time
 = 
time
;

60 
	}
}

62 
	g´iv©e
:

63 
m_id
 ;

64 
Cyşes
 
	gm_time
;

65 
VC_¡©e_ty³
 
	gm_vc_¡©e
;

66 
	gm_üed™_couÁ
;

67 
	gm_max_üed™_couÁ
;

	@ruby/network/garnet2.0/OutputUnit.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/OuutUn™.hh
"

36 
	~"ba£/¡l_h–³rs.hh
"

37 
	~"debug/RubyN‘wÜk.hh
"

38 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™.hh
"

39 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

41 
usšg
 
Çme¥aû
 
	g¡d
;

42 
usšg
 
	gm5
::
¡l_h–³rs
::
d–‘ePoš‹rs
;

44 
	gOuutUn™
::
	$OuutUn™
(
id
, 
PÜtDœeùiÚ
 
dœeùiÚ
, 
Rou‹r
 *
rou‹r
)

45 : 
	$CÚsum”
(
rou‹r
)

47 
m_id
 = 
id
;

48 
m_dœeùiÚ
 = 
dœeùiÚ
;

49 
m_rou‹r
 = 
rou‹r
;

50 
m_num_vcs
 = 
m_rou‹r
->
	`g‘_num_vcs
();

51 
m_vc_³r_vÃt
 = 
m_rou‹r
->
	`g‘_vc_³r_vÃt
();

52 
m_out_bufãr
 = 
Ãw
 
	`æ™Bufãr
();

54 
i
 = 0; i < 
m_num_vcs
; i++) {

55 
m_outvc_¡©e
.
	`push_back
(
Ãw
 
	`OutVcS‹
(
i
, 
m_rou‹r
->
	`g‘_Ãt_±r
()));

57 
	}
}

59 
	gOuutUn™
::~
	$OuutUn™
()

61 
d–‘e
 
m_out_bufãr
;

62 
	`d–‘ePoš‹rs
(
m_outvc_¡©e
);

63 
	}
}

66 
	gOuutUn™
::
	$deüem’t_üed™
(
out_vc
)

68 
	`DPRINTF
(
RubyN‘wÜk
, "Router %d OutputUnit %d decrementing credit for "

70 
m_rou‹r
->
	`g‘_id
(), 
m_id
, 
out_vc
, m_rou‹r->
	`curCyşe
());

72 
m_outvc_¡©e
[
out_vc
]->
	`deüem’t_üed™
();

73 
	}
}

76 
	gOuutUn™
::
	$šüem’t_üed™
(
out_vc
)

78 
	`DPRINTF
(
RubyN‘wÜk
, "Router %d OutputUnit %d incrementing credit for "

80 
m_rou‹r
->
	`g‘_id
(), 
m_id
, 
out_vc
, m_rou‹r->
	`curCyşe
());

82 
m_outvc_¡©e
[
out_vc
]->
	`šüem’t_üed™
();

83 
	}
}

88 
boŞ


89 
	gOuutUn™
::
	$has_üed™
(
out_vc
)

91 
	`as£¹
(
m_outvc_¡©e
[
out_vc
]->
	`isInS‹
(
ACTIVE_
, 
m_rou‹r
->
	`curCyşe
()));

92  
m_outvc_¡©e
[
out_vc
]->
	`has_üed™
();

93 
	}
}

97 
boŞ


98 
	gOuutUn™
::
	$has_ä“_vc
(
vÃt
)

100 
vc_ba£
 = 
vÃt
*
m_vc_³r_vÃt
;

101 
vc
 = 
vc_ba£
; vø< vc_ba£ + 
m_vc_³r_vÃt
; vc++) {

102 ià(
	`is_vc_idË
(
vc
, 
m_rou‹r
->
	`curCyşe
()))

103  
Œue
;

106  
çl£
;

107 
	}
}

111 
	gOuutUn™
::
	$£Ëù_ä“_vc
(
vÃt
)

113 
vc_ba£
 = 
vÃt
*
m_vc_³r_vÃt
;

114 
vc
 = 
vc_ba£
; vø< vc_ba£ + 
m_vc_³r_vÃt
; vc++) {

115 ià(
	`is_vc_idË
(
vc
, 
m_rou‹r
->
	`curCyşe
())) {

116 
m_outvc_¡©e
[
vc
]->
	`£tS‹
(
ACTIVE_
, 
m_rou‹r
->
	`curCyşe
());

117  
vc
;

122 
	}
}

133 
	gOuutUn™
::
	$wakeup
()

135 ià(
m_üed™_lšk
->
	`isR—dy
(
m_rou‹r
->
	`curCyşe
())) {

136 
C»d™
 *
t_üed™
 = (C»d™*è
m_üed™_lšk
->
	`cÚsumeLšk
();

137 
	`šüem’t_üed™
(
t_üed™
->
	`g‘_vc
());

139 ià(
t_üed™
->
	`is_ä“_sigÇl
())

140 
	`£t_vc_¡©e
(
IDLE_
, 
t_üed™
->
	`g‘_vc
(), 
m_rou‹r
->
	`curCyşe
());

142 
d–‘e
 
t_üed™
;

144 
	}
}

146 
æ™Bufãr
*

147 
	gOuutUn™
::
	$g‘OutQueue
()

149  
m_out_bufãr
;

150 
	}
}

153 
	gOuutUn™
::
	$£t_out_lšk
(
N‘wÜkLšk
 *
lšk
)

155 
m_out_lšk
 = 
lšk
;

156 
	}
}

159 
	gOuutUn™
::
	$£t_üed™_lšk
(
C»d™Lšk
 *
üed™_lšk
)

161 
m_üed™_lšk
 = 
üed™_lšk
;

162 
	}
}

164 
ušt32_t


165 
	gOuutUn™
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

167  
m_out_bufãr
->
	`funùiÚ®Wr™e
(
pkt
);

168 
	}
}

	@ruby/network/garnet2.0/OutputUnit.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_OUTPUT_UNIT_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_OUTPUT_UNIT_HH__


	)

37 
	~<io¡»am
>

38 
	~<veùÜ
>

40 
	~"mem/ruby/commÚ/CÚsum”.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™Lšk.hh
"

43 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

44 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/OutVcS‹.hh
"

45 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

46 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™Bufãr.hh
"

48 şas 
	cOuutUn™
 : 
public
 
CÚsum”


50 
public
:

51 
OuutUn™
(
id
, 
PÜtDœeùiÚ
 
dœeùiÚ
, 
Rou‹r
 *
rou‹r
);

52 ~
OuutUn™
();

53 
£t_out_lšk
(
N‘wÜkLšk
 *
lšk
);

54 
£t_üed™_lšk
(
C»d™Lšk
 *
üed™_lšk
);

55 
wakeup
();

56 
æ™Bufãr
* 
g‘OutQueue
();

57 
	$´št
(
¡d
::
o¡»am
& 
out
) const {};

58 
	`deüem’t_üed™
(
out_vc
);

59 
	`šüem’t_üed™
(
out_vc
);

60 
boŞ
 
	`has_üed™
(
out_vc
);

61 
boŞ
 
	`has_ä“_vc
(
vÃt
);

62 
	`£Ëù_ä“_vc
(
vÃt
);

64 
šlše
 
PÜtDœeùiÚ
 
	$g‘_dœeùiÚ
(è{  
m_dœeùiÚ
; 
	}
}

67 
	$g‘_üed™_couÁ
(
vc
)

69  
m_outvc_¡©e
[
vc
]->
	`g‘_üed™_couÁ
();

70 
	}
}

72 
šlše
 

73 
	$g‘_oušk_id
()

75  
m_out_lšk
->
	`g‘_id
();

76 
	}
}

78 
šlše
 

79 
	$£t_vc_¡©e
(
VC_¡©e_ty³
 
¡©e
, 
vc
, 
Cyşes
 
curTime
)

81 
m_outvc_¡©e
[
vc
]->
	`£tS‹
(
¡©e
, 
curTime
);

82 
	}
}

84 
šlše
 
boŞ


85 
	$is_vc_idË
(
vc
, 
Cyşes
 
curTime
)

87  (
m_outvc_¡©e
[
vc
]->
	`isInS‹
(
IDLE_
, 
curTime
));

88 
	}
}

90 
šlše
 

91 
	$š£¹_æ™
(
æ™
 *
t_æ™
)

93 
m_out_bufãr
->
	`š£¹
(
t_æ™
);

94 
m_out_lšk
->
	`scheduËEv’tAbsŞu‹
(
m_rou‹r
->
	`şockEdge
(
	`Cyşes
(1)));

95 
	}
}

97 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

99 
	g´iv©e
:

100 
m_id
;

101 
PÜtDœeùiÚ
 
	gm_dœeùiÚ
;

102 
	gm_num_vcs
;

103 
	gm_vc_³r_vÃt
;

104 
Rou‹r
 *
	gm_rou‹r
;

105 
N‘wÜkLšk
 *
	gm_out_lšk
;

106 
C»d™Lšk
 *
	gm_üed™_lšk
;

108 
æ™Bufãr
 *
	gm_out_bufãr
;

109 
	g¡d
::
veùÜ
<
OutVcS‹
 *> 
m_outvc_¡©e
;

	@ruby/network/garnet2.0/Router.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

36 
	~"ba£/¡l_h–³rs.hh
"

37 
	~"debug/RubyN‘wÜk.hh
"

38 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/C»d™Lšk.hh
"

39 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Crossb¬Sw™ch.hh
"

40 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtN‘wÜk.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/IÅutUn™.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/N‘wÜkLšk.hh
"

43 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/OuutUn™.hh
"

44 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/RoutšgUn™.hh
"

45 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Sw™chAÎoÿtÜ.hh
"

47 
usšg
 
Çme¥aû
 
	g¡d
;

48 
usšg
 
	gm5
::
¡l_h–³rs
::
d–‘ePoš‹rs
;

50 
	gRou‹r
::
	$Rou‹r
(cÚ¡ 
P¬ams
 *
p
)

51 : 
	`BasicRou‹r
(
p
), 
	$CÚsum”
(
this
)

53 
m_Ï‹ncy
 = 
p
->
Ï‹ncy
;

54 
m_vœtu®_ÃtwÜks
 = 
p
->
vœt_Ãts
;

55 
m_vc_³r_vÃt
 = 
p
->
vcs_³r_vÃt
;

56 
m_num_vcs
 = 
m_vœtu®_ÃtwÜks
 * 
m_vc_³r_vÃt
;

58 
m_routšg_un™
 = 
Ãw
 
	`RoutšgUn™
(
this
);

59 
m_sw_®loc
 = 
Ãw
 
	`Sw™chAÎoÿtÜ
(
this
);

60 
m_sw™ch
 = 
Ãw
 
	`Crossb¬Sw™ch
(
this
);

62 
m_šput_un™
.
	`ş—r
();

63 
m_ouut_un™
.
	`ş—r
();

64 
	}
}

66 
	gRou‹r
::~
	$Rou‹r
()

68 
	`d–‘ePoš‹rs
(
m_šput_un™
);

69 
	`d–‘ePoš‹rs
(
m_ouut_un™
);

70 
d–‘e
 
m_routšg_un™
;

71 
d–‘e
 
m_sw_®loc
;

72 
d–‘e
 
m_sw™ch
;

73 
	}
}

76 
	gRou‹r
::
	$š™
()

78 
BasicRou‹r
::
	`š™
();

80 
m_sw_®loc
->
	`š™
();

81 
m_sw™ch
->
	`š™
();

82 
	}
}

85 
	gRou‹r
::
	$wakeup
()

87 
	`DPRINTF
(
RubyN‘wÜk
, "Rou‹¸%d wokup\n", 
m_id
);

90 
špÜt
 = 0; iÅÜˆ< 
m_šput_un™
.
	`size
(); inport++) {

91 
m_šput_un™
[
špÜt
]->
	`wakeup
();

100 
ouÜt
 = 0; ouÜˆ< 
m_ouut_un™
.
	`size
(); outport++) {

101 
m_ouut_un™
[
ouÜt
]->
	`wakeup
();

105 
m_sw_®loc
->
	`wakeup
();

108 
m_sw™ch
->
	`wakeup
();

109 
	}
}

112 
	gRou‹r
::
	$addInPÜt
(
PÜtDœeùiÚ
 
špÜt_dœn
,

113 
N‘wÜkLšk
 *
š_lšk
, 
C»d™Lšk
 *
üed™_lšk
)

115 
pÜt_num
 = 
m_šput_un™
.
	`size
();

116 
IÅutUn™
 *
šput_un™
 = 
Ãw
 
	`IÅutUn™
(
pÜt_num
, 
špÜt_dœn
, 
this
);

118 
šput_un™
->
	`£t_š_lšk
(
š_lšk
);

119 
šput_un™
->
	`£t_üed™_lšk
(
üed™_lšk
);

120 
š_lšk
->
	`£tLškCÚsum”
(
this
);

121 
üed™_lšk
->
	`£tSourûQueue
(
šput_un™
->
	`g‘C»d™Queue
());

123 
m_šput_un™
.
	`push_back
(
šput_un™
);

125 
m_routšg_un™
->
	`addInDœeùiÚ
(
špÜt_dœn
, 
pÜt_num
);

126 
	}
}

129 
	gRou‹r
::
	$addOutPÜt
(
PÜtDœeùiÚ
 
ouÜt_dœn
,

130 
N‘wÜkLšk
 *
out_lšk
,

131 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
, 
lšk_weight
,

132 
C»d™Lšk
 *
üed™_lšk
)

134 
pÜt_num
 = 
m_ouut_un™
.
	`size
();

135 
OuutUn™
 *
ouut_un™
 = 
Ãw
 
	`OuutUn™
(
pÜt_num
, 
ouÜt_dœn
, 
this
);

137 
ouut_un™
->
	`£t_out_lšk
(
out_lšk
);

138 
ouut_un™
->
	`£t_üed™_lšk
(
üed™_lšk
);

139 
üed™_lšk
->
	`£tLškCÚsum”
(
this
);

140 
out_lšk
->
	`£tSourûQueue
(
ouut_un™
->
	`g‘OutQueue
());

142 
m_ouut_un™
.
	`push_back
(
ouut_un™
);

144 
m_routšg_un™
->
	`addRou‹
(
routšg_bË_’Œy
);

145 
m_routšg_un™
->
	`addWeight
(
lšk_weight
);

146 
m_routšg_un™
->
	`addOutDœeùiÚ
(
ouÜt_dœn
, 
pÜt_num
);

147 
	}
}

149 
PÜtDœeùiÚ


150 
	gRou‹r
::
	$g‘OuÜtDœeùiÚ
(
ouÜt
)

152  
m_ouut_un™
[
ouÜt
]->
	`g‘_dœeùiÚ
();

153 
	}
}

155 
PÜtDœeùiÚ


156 
	gRou‹r
::
	$g‘IÅÜtDœeùiÚ
(
špÜt
)

158  
m_šput_un™
[
špÜt
]->
	`g‘_dœeùiÚ
();

159 
	}
}

162 
	gRou‹r
::
	$rou‹_compu‹
(
Rou‹Info
 
rou‹
, 
špÜt
, 
PÜtDœeùiÚ
 
špÜt_dœn
)

164  
m_routšg_un™
->
	`ouÜtCompu‹
(
rou‹
, 
špÜt
, 
špÜt_dœn
);

165 
	}
}

168 
	gRou‹r
::
	$g¿Á_sw™ch
(
špÜt
, 
æ™
 *
t_æ™
)

170 
m_sw™ch
->
	`upd©e_sw_wšÃr
(
špÜt
, 
t_æ™
);

171 
	}
}

174 
	gRou‹r
::
	$scheduË_wakeup
(
Cyşes
 
time
)

177 
	`scheduËEv’t
(
time
);

178 
	}
}

180 
	g¡d
::
¡ršg


181 
Rou‹r
::
	$g‘PÜtDœeùiÚName
(
PÜtDœeùiÚ
 
dœeùiÚ
)

187  
dœeùiÚ
;

188 
	}
}

191 
	gRou‹r
::
	$»gSts
()

193 
BasicRou‹r
::
	`»gSts
();

195 
m_bufãr_»ads


196 .
	`Çme
(name() + ".buffer_reads")

197 .
	`æags
(
Sts
::
noz”o
)

200 
m_bufãr_wr™es


201 .
	`Çme
(name() + ".buffer_writes")

202 .
	`æags
(
Sts
::
noz”o
)

205 
m_üossb¬_aùiv™y


206 .
	`Çme
(name() + ".crossbar_activity")

207 .
	`æags
(
Sts
::
noz”o
)

210 
m_sw_šput_¬b™”_aùiv™y


211 .
	`Çme
(name() + ".sw_input_arbiter_activity")

212 .
	`æags
(
Sts
::
noz”o
)

215 
m_sw_ouut_¬b™”_aùiv™y


216 .
	`Çme
(name() + ".sw_output_arbiter_activity")

217 .
	`æags
(
Sts
::
noz”o
)

219 
	}
}

222 
	gRou‹r
::
	$cŞÏ‹Sts
()

224 
j
 = 0; j < 
m_vœtu®_ÃtwÜks
; j++) {

225 
i
 = 0; i < 
m_šput_un™
.
	`size
(); i++) {

226 
m_bufãr_»ads
 +ğ
m_šput_un™
[
i
]->
	`g‘_buf_»ad_aùiv™y
(
j
);

227 
m_bufãr_wr™es
 +ğ
m_šput_un™
[
i
]->
	`g‘_buf_wr™e_aùiv™y
(
j
);

231 
m_sw_šput_¬b™”_aùiv™y
 = 
m_sw_®loc
->
	`g‘_šput_¬b™”_aùiv™y
();

232 
m_sw_ouut_¬b™”_aùiv™y
 = 
m_sw_®loc
->
	`g‘_ouut_¬b™”_aùiv™y
();

233 
m_üossb¬_aùiv™y
 = 
m_sw™ch
->
	`g‘_üossb¬_aùiv™y
();

234 
	}
}

237 
	gRou‹r
::
	$»£tSts
()

239 
j
 = 0; j < 
m_vœtu®_ÃtwÜks
; j++) {

240 
i
 = 0; i < 
m_šput_un™
.
	`size
(); i++) {

241 
m_šput_un™
[
i
]->
	`»£tSts
();

244 
	}
}

247 
	gRou‹r
::
	$´štFauÉVeùÜ
(
o¡»am
& 
out
)

249 
‹m³¿tu»_ûlcius
 = 
BASELINE_TEMPERATURE_CELCIUS
;

250 
num_çuÉ_ty³s
 = 
m_ÃtwÜk_±r
->
çuÉ_mod–
->
numb”_of_çuÉ_ty³s
;

251 
çuÉ_veùÜ
[
num_çuÉ_ty³s
];

252 
	`g‘_çuÉ_veùÜ
(
‹m³¿tu»_ûlcius
, 
çuÉ_veùÜ
);

253 
out
 << "Rou‹r-" << 
m_id
 << " fauÉ veùÜ: " << 
’dl
;

254 
çuÉ_ty³_šdex
 = 0; fauÉ_ty³_šdex < 
num_çuÉ_ty³s
;

255 
çuÉ_ty³_šdex
++) {

256 
out
 << " -…robability of (";

257 
out
 <<

258 
m_ÃtwÜk_±r
->
çuÉ_mod–
->
	`çuÉ_ty³_to_¡ršg
(
çuÉ_ty³_šdex
);

259 
out
 << ") = ";

260 
out
 << 
çuÉ_veùÜ
[
çuÉ_ty³_šdex
] << 
’dl
;

262 
	}
}

265 
	gRou‹r
::
	$´štAgg»g©eFauÉProbab™y
(
¡d
::
o¡»am
& 
out
)

267 
‹m³¿tu»_ûlcius
 = 
BASELINE_TEMPERATURE_CELCIUS
;

268 
agg»g©e_çuÉ_´ob
;

269 
	`g‘_agg»g©e_çuÉ_´obab™y
(
‹m³¿tu»_ûlcius
,

270 &
agg»g©e_çuÉ_´ob
);

271 
out
 << "Rou‹r-" << 
m_id
 << " fault…robability: ";

272 
out
 << 
agg»g©e_çuÉ_´ob
 << 
’dl
;

273 
	}
}

275 
ušt32_t


276 
	gRou‹r
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

278 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

279 
num_funùiÚ®_wr™es
 +ğ
m_sw™ch
->
	`funùiÚ®Wr™e
(
pkt
);

281 
ušt32_t
 
i
 = 0; i < 
m_šput_un™
.
	`size
(); i++) {

282 
num_funùiÚ®_wr™es
 +ğ
m_šput_un™
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

285 
ušt32_t
 
i
 = 0; i < 
m_ouut_un™
.
	`size
(); i++) {

286 
num_funùiÚ®_wr™es
 +ğ
m_ouut_un™
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

289  
num_funùiÚ®_wr™es
;

290 
	}
}

292 
Rou‹r
 *

293 
	gG¬ÃtRou‹rP¬ams
::
	$ü—‹
()

295  
Ãw
 
	`Rou‹r
(
this
);

296 
	}
}

	@ruby/network/garnet2.0/Router.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_ROUTER_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_ROUTER_HH__


	)

37 
	~<io¡»am
>

38 
	~<veùÜ
>

40 
	~"mem/ruby/commÚ/CÚsum”.hh
"

41 
	~"mem/ruby/commÚ/N‘De¡.hh
"

42 
	~"mem/ruby/ÃtwÜk/BasicRou‹r.hh
"

43 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

44 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtN‘wÜk.hh
"

45 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™.hh
"

46 
	~"·¿ms/G¬ÃtRou‹r.hh
"

48 
şass
 
	gN‘wÜkLšk
;

49 
şass
 
	gC»d™Lšk
;

50 
şass
 
	gIÅutUn™
;

51 
şass
 
	gOuutUn™
;

52 
şass
 
	gRoutšgUn™
;

53 
şass
 
	gSw™chAÎoÿtÜ
;

54 
şass
 
	gCrossb¬Sw™ch
;

55 
şass
 
	gFauÉMod–
;

57 
şass
 
	gRou‹r
 : 
public
 
BasicRou‹r
,…ubliø
	gCÚsum”


59 
	gpublic
:

60 
G¬ÃtRou‹rP¬ams
 
	tP¬ams
;

61 
Rou‹r
(cÚ¡ 
P¬ams
 *
p
);

63 ~
Rou‹r
();

65 
wakeup
();

66 
´št
(
¡d
::
o¡»am
& 
out
) const {};

68 
š™
();

69 
addInPÜt
(
PÜtDœeùiÚ
 
špÜt_dœn
, 
N‘wÜkLšk
 *
lšk
,

70 
C»d™Lšk
 *
üed™_lšk
);

71 
addOutPÜt
(
PÜtDœeùiÚ
 
ouÜt_dœn
, 
N‘wÜkLšk
 *
lšk
,

72 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
,

73 
lšk_weight
, 
C»d™Lšk
 *
üed™_lšk
);

75 
Cyşes
 
g‘_pe_¡ages
(){  
	gm_Ï‹ncy
; }

76 
g‘_num_vcs
(è{  
	gm_num_vcs
; }

77 
g‘_num_vÃts
(è{  
	gm_vœtu®_ÃtwÜks
; }

78 
g‘_vc_³r_vÃt
(è{  
	gm_vc_³r_vÃt
; }

79 
g‘_num_špÜts
(è{  
	gm_šput_un™
.
size
(); }

80 
g‘_num_ouÜts
(è{  
	gm_ouut_un™
.
size
(); }

81 
g‘_id
(è{  
	gm_id
; }

83 
š™_Ãt_±r
(
G¬ÃtN‘wÜk
* 
Ãt_±r
)

85 
	gm_ÃtwÜk_±r
 = 
Ãt_±r
;

88 
G¬ÃtN‘wÜk
* 
g‘_Ãt_±r
(è{  
	gm_ÃtwÜk_±r
; }

89 
	g¡d
::
veùÜ
<
IÅutUn™
 *>& 
g‘_šputUn™_»f
(è{  
m_šput_un™
; }

90 
	g¡d
::
veùÜ
<
OuutUn™
 *>& 
g‘_ouutUn™_»f
(è{  
m_ouut_un™
; }

91 
PÜtDœeùiÚ
 
g‘OuÜtDœeùiÚ
(
ouÜt
);

92 
PÜtDœeùiÚ
 
g‘IÅÜtDœeùiÚ
(
špÜt
);

94 
rou‹_compu‹
(
Rou‹Info
 
rou‹
, 
špÜt
, 
PÜtDœeùiÚ
 
dœeùiÚ
);

95 
g¿Á_sw™ch
(
špÜt
, 
æ™
 *
t_æ™
);

96 
scheduË_wakeup
(
Cyşes
 
time
);

98 
	g¡d
::
¡ršg
 
g‘PÜtDœeùiÚName
(
PÜtDœeùiÚ
 
dœeùiÚ
);

99 
´štFauÉVeùÜ
(
¡d
::
o¡»am
& 
out
);

100 
´štAgg»g©eFauÉProbab™y
(
¡d
::
o¡»am
& 
out
);

102 
»gSts
();

103 
cŞÏ‹Sts
();

104 
»£tSts
();

107 
boŞ
 
g‘_çuÉ_veùÜ
(
‹m³¿tu»
, 
çuÉ_veùÜ
[]) {

108  
	gm_ÃtwÜk_±r
->
	gçuÉ_mod–
->
çuÉ_veùÜ
(
m_id
, 
‹m³¿tu»
,

109 
çuÉ_veùÜ
);

111 
boŞ
 
g‘_agg»g©e_çuÉ_´obab™y
(
‹m³¿tu»
,

112 *
agg»g©e_çuÉ_´ob
) {

113  
	gm_ÃtwÜk_±r
->
	gçuÉ_mod–
->
çuÉ_´ob
(
m_id
, 
‹m³¿tu»
,

114 
agg»g©e_çuÉ_´ob
);

117 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *);

119 
	g´iv©e
:

120 
Cyşes
 
m_Ï‹ncy
;

121 
	gm_vœtu®_ÃtwÜks
, 
	gm_num_vcs
, 
	gm_vc_³r_vÃt
;

122 
G¬ÃtN‘wÜk
 *
	gm_ÃtwÜk_±r
;

124 
	g¡d
::
veùÜ
<
IÅutUn™
 *> 
m_šput_un™
;

125 
	g¡d
::
veùÜ
<
OuutUn™
 *> 
m_ouut_un™
;

126 
RoutšgUn™
 *
	gm_routšg_un™
;

127 
Sw™chAÎoÿtÜ
 *
	gm_sw_®loc
;

128 
Crossb¬Sw™ch
 *
	gm_sw™ch
;

131 
	gSts
::
SÿÏr
 
m_bufãr_»ads
;

132 
	gSts
::
SÿÏr
 
m_bufãr_wr™es
;

134 
	gSts
::
SÿÏr
 
m_sw_šput_¬b™”_aùiv™y
;

135 
	gSts
::
SÿÏr
 
m_sw_ouut_¬b™”_aùiv™y
;

137 
	gSts
::
SÿÏr
 
m_üossb¬_aùiv™y
;

	@ruby/network/garnet2.0/RoutingUnit.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/RoutšgUn™.hh
"

36 
	~"ba£/ÿ¡.hh
"

37 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/IÅutUn™.hh
"

38 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

39 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

41 
	gRoutšgUn™
::
	$RoutšgUn™
(
Rou‹r
 *
rou‹r
)

43 
m_rou‹r
 = 
rou‹r
;

44 
m_routšg_bË
.
	`ş—r
();

45 
m_weight_bË
.
	`ş—r
();

46 
	}
}

49 
	gRoutšgUn™
::
	$addRou‹
(cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
)

51 
m_routšg_bË
.
	`push_back
(
routšg_bË_’Œy
);

52 
	}
}

55 
	gRoutšgUn™
::
	$addWeight
(
lšk_weight
)

57 
m_weight_bË
.
	`push_back
(
lšk_weight
);

58 
	}
}

68 
	gRoutšgUn™
::
	$lookupRoutšgTabË
(
vÃt
, 
N‘De¡
 
msg_de¡š©iÚ
)

77 
ouut_lšk
 = -1;

78 
mš_weight
 = 
INFINITE_
;

79 
¡d
::
veùÜ
<> 
ouut_lšk_ÿndid©es
;

80 
num_ÿndid©es
 = 0;

83 
lšk
 = 0;†šk < 
m_routšg_bË
.
	`size
();†ink++) {

84 ià(
msg_de¡š©iÚ
.
	`š‹r£ùiÚIsNÙEm±y
(
m_routšg_bË
[
lšk
])) {

86 ià(
m_weight_bË
[
lšk
] <ğ
mš_weight
)

87 
mš_weight
 = 
m_weight_bË
[
lšk
];

92 
lšk
 = 0;†šk < 
m_routšg_bË
.
	`size
();†ink++) {

93 ià(
msg_de¡š©iÚ
.
	`š‹r£ùiÚIsNÙEm±y
(
m_routšg_bË
[
lšk
])) {

95 ià(
m_weight_bË
[
lšk
] =ğ
mš_weight
) {

97 
num_ÿndid©es
++;

98 
ouut_lšk_ÿndid©es
.
	`push_back
(
lšk
);

103 ià(
ouut_lšk_ÿndid©es
.
	`size
() == 0) {

104 
	`çl
("Fatal Error:: No Routeƒxists fromhis Router.");

105 
	`ex™
(0);

109 
ÿndid©e
 = 0;

110 ià(!(
m_rou‹r
->
	`g‘_Ãt_±r
())->
	`isVN‘Ord”ed
(
vÃt
))

111 
ÿndid©e
 = 
	`¿nd
(è% 
num_ÿndid©es
;

113 
ouut_lšk
 = 
ouut_lšk_ÿndid©es
.
	`©
(
ÿndid©e
);

114  
ouut_lšk
;

115 
	}
}

119 
	gRoutšgUn™
::
	$addInDœeùiÚ
(
PÜtDœeùiÚ
 
špÜt_dœn
, 
špÜt_idx
)

121 
m_špÜts_dœn2idx
[
špÜt_dœn
] = 
špÜt_idx
;

122 
m_špÜts_idx2dœn
[
špÜt_idx
] = 
špÜt_dœn
;

123 
	}
}

126 
	gRoutšgUn™
::
	$addOutDœeùiÚ
(
PÜtDœeùiÚ
 
ouÜt_dœn
, 
ouÜt_idx
)

128 
m_ouÜts_dœn2idx
[
ouÜt_dœn
] = 
ouÜt_idx
;

129 
m_ouÜts_idx2dœn
[
ouÜt_idx
] = 
ouÜt_dœn
;

130 
	}
}

139 
	gRoutšgUn™
::
	$ouÜtCompu‹
(
Rou‹Info
 
rou‹
, 
špÜt
,

140 
PÜtDœeùiÚ
 
špÜt_dœn
)

142 
ouÜt
 = -1;

144 ià(
rou‹
.
de¡_rou‹r
 =ğ
m_rou‹r
->
	`g‘_id
()) {

149 
ouÜt
 = 
	`lookupRoutšgTabË
(
rou‹
.
vÃt
,„ou‹.
Ãt_de¡
);

150  
ouÜt
;

155 
RoutšgAlgÜ™hm
 
routšg_®gÜ™hm
 =

156 (
RoutšgAlgÜ™hm
è
m_rou‹r
->
	`g‘_Ãt_±r
()->
	`g‘RoutšgAlgÜ™hm
();

158 
routšg_®gÜ™hm
) {

159 
TABLE_
: 
ouÜt
 =

160 
	`lookupRoutšgTabË
(
rou‹
.
vÃt
,„ou‹.
Ãt_de¡
); ;

161 
XY_
: 
ouÜt
 =

162 
	`ouÜtCompu‹XY
(
rou‹
, 
špÜt
, 
špÜt_dœn
); ;

164 
CUSTOM_
: 
ouÜt
 =

165 
	`ouÜtCompu‹Cu¡om
(
rou‹
, 
špÜt
, 
špÜt_dœn
); ;

166 : 
ouÜt
 =

167 
	`lookupRoutšgTabË
(
rou‹
.
vÃt
,„ou‹.
Ãt_de¡
); ;

170 
	`as£¹
(
ouÜt
 != -1);

171  
ouÜt
;

172 
	}
}

178 
	gRoutšgUn™
::
	$ouÜtCompu‹XY
(
Rou‹Info
 
rou‹
,

179 
špÜt
,

180 
PÜtDœeùiÚ
 
špÜt_dœn
)

182 
PÜtDœeùiÚ
 
ouÜt_dœn
 = "Unknown";

184 
M5_VAR_USED
 
num_rows
 = 
m_rou‹r
->
	`g‘_Ãt_±r
()->
	`g‘NumRows
();

185 
num_cŞs
 = 
m_rou‹r
->
	`g‘_Ãt_±r
()->
	`g‘NumCŞs
();

186 
	`as£¹
(
num_rows
 > 0 && 
num_cŞs
 > 0);

188 
my_id
 = 
m_rou‹r
->
	`g‘_id
();

189 
my_x
 = 
my_id
 % 
num_cŞs
;

190 
my_y
 = 
my_id
 / 
num_cŞs
;

192 
de¡_id
 = 
rou‹
.
de¡_rou‹r
;

193 
de¡_x
 = 
de¡_id
 % 
num_cŞs
;

194 
de¡_y
 = 
de¡_id
 / 
num_cŞs
;

196 
x_hİs
 = 
	`abs
(
de¡_x
 - 
my_x
);

197 
y_hİs
 = 
	`abs
(
de¡_y
 - 
my_y
);

199 
boŞ
 
x_dœn
 = (
de¡_x
 >ğ
my_x
);

200 
boŞ
 
y_dœn
 = (
de¡_y
 >ğ
my_y
);

203 
	`as£¹
(!(
x_hİs
 =ğ0 && 
y_hİs
 == 0));

205 ià(
x_hİs
 > 0) {

206 ià(
x_dœn
) {

207 
	`as£¹
(
špÜt_dœn
 == "Local" || inport_dirn == "West");

208 
ouÜt_dœn
 = "East";

210 
	`as£¹
(
špÜt_dœn
 == "Local" || inport_dirn == "East");

211 
ouÜt_dœn
 = "West";

213 } ià(
y_hİs
 > 0) {

214 ià(
y_dœn
) {

216 
	`as£¹
(
špÜt_dœn
 != "North");

217 
ouÜt_dœn
 = "North";

220 
	`as£¹
(
špÜt_dœn
 != "South");

221 
ouÜt_dœn
 = "South";

227 
	`as£¹
(0);

230  
m_ouÜts_dœn2idx
[
ouÜt_dœn
];

231 
	}
}

236 
	gRoutšgUn™
::
	$ouÜtCompu‹Cu¡om
(
Rou‹Info
 
rou‹
,

237 
špÜt
,

238 
PÜtDœeùiÚ
 
špÜt_dœn
)

240 
	`as£¹
(0);

242 
	}
}

	@ruby/network/garnet2.0/RoutingUnit.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_ROUTING_UNIT_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_ROUTING_UNIT_HH__


	)

37 
	~"mem/ruby/commÚ/CÚsum”.hh
"

38 
	~"mem/ruby/commÚ/N‘De¡.hh
"

39 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

40 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtN‘wÜk.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™.hh
"

43 
şass
 
	gIÅutUn™
;

44 
şass
 
	gRou‹r
;

46 şas 
	cRoutšgUn™


48 
	mpublic
:

49 
RoutšgUn™
(
Rou‹r
 *
rou‹r
);

50 
ouÜtCompu‹
(
Rou‹Info
 
rou‹
,

51 
špÜt
,

52 
PÜtDœeùiÚ
 
špÜt_dœn
);

55 
addRou‹
(cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
);

56 
addWeight
(
lšk_weight
);

59 
lookupRoutšgTabË
(
vÃt
, 
N‘De¡
 
Ãt_de¡
);

62 
addInDœeùiÚ
(
PÜtDœeùiÚ
 
špÜt_dœn
, 
špÜt
);

63 
addOutDœeùiÚ
(
PÜtDœeùiÚ
 
ouÜt_dœn
, 
ouÜt
);

66 
ouÜtCompu‹XY
(
Rou‹Info
 
rou‹
,

67 
špÜt
,

68 
PÜtDœeùiÚ
 
špÜt_dœn
);

71 
ouÜtCompu‹Cu¡om
(
Rou‹Info
 
rou‹
,

72 
špÜt
,

73 
PÜtDœeùiÚ
 
špÜt_dœn
);

75 
	m´iv©e
:

76 
Rou‹r
 *
m_rou‹r
;

79 
	m¡d
::
veùÜ
<
N‘De¡
> 
m_routšg_bË
;

80 
	m¡d
::
veùÜ
<> 
m_weight_bË
;

83 
	m¡d
::
m­
<
PÜtDœeùiÚ
, > 
	mm_špÜts_dœn2idx
;

84 
	m¡d
::
m­
<, 
	mPÜtDœeùiÚ
> 
	mm_špÜts_idx2dœn
;

85 
	m¡d
::
m­
<, 
	mPÜtDœeùiÚ
> 
	mm_ouÜts_idx2dœn
;

86 
	m¡d
::
m­
<
PÜtDœeùiÚ
, > 
	mm_ouÜts_dœn2idx
;

	@ruby/network/garnet2.0/SwitchAllocator.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Sw™chAÎoÿtÜ.hh
"

36 
	~"debug/RubyN‘wÜk.hh
"

37 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/G¬ÃtN‘wÜk.hh
"

38 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/IÅutUn™.hh
"

39 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/OuutUn™.hh
"

40 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Rou‹r.hh
"

42 
	gSw™chAÎoÿtÜ
::
	$Sw™chAÎoÿtÜ
(
Rou‹r
 *
rou‹r
)

43 : 
	$CÚsum”
(
rou‹r
)

45 
m_rou‹r
 = 
rou‹r
;

46 
m_num_vcs
 = 
m_rou‹r
->
	`g‘_num_vcs
();

47 
m_vc_³r_vÃt
 = 
m_rou‹r
->
	`g‘_vc_³r_vÃt
();

49 
m_šput_¬b™”_aùiv™y
 = 0;

50 
m_ouut_¬b™”_aùiv™y
 = 0;

51 
	}
}

54 
	gSw™chAÎoÿtÜ
::
	$š™
()

56 
m_šput_un™
 = 
m_rou‹r
->
	`g‘_šputUn™_»f
();

57 
m_ouut_un™
 = 
m_rou‹r
->
	`g‘_ouutUn™_»f
();

59 
m_num_špÜts
 = 
m_rou‹r
->
	`g‘_num_špÜts
();

60 
m_num_ouÜts
 = 
m_rou‹r
->
	`g‘_num_ouÜts
();

61 
m_round_robš_špÜt
.
	`»size
(
m_num_ouÜts
);

62 
m_round_robš_švc
.
	`»size
(
m_num_špÜts
);

63 
m_pÜt_»que¡s
.
	`»size
(
m_num_ouÜts
);

64 
m_vc_wšÃrs
.
	`»size
(
m_num_ouÜts
);

66 
i
 = 0; i < 
m_num_špÜts
; i++) {

67 
m_round_robš_švc
[
i
] = 0;

70 
i
 = 0; i < 
m_num_ouÜts
; i++) {

71 
m_pÜt_»que¡s
[
i
].
	`»size
(
m_num_špÜts
);

72 
m_vc_wšÃrs
[
i
].
	`»size
(
m_num_špÜts
);

74 
m_round_robš_špÜt
[
i
] = 0;

76 
j
 = 0; j < 
m_num_špÜts
; j++) {

77 
m_pÜt_»que¡s
[
i
][
j
] = 
çl£
;

80 
	}
}

92 
	gSw™chAÎoÿtÜ
::
	$wakeup
()

94 
	`¬b™¿‹_špÜts
();

95 
	`¬b™¿‹_ouÜts
();

97 
	`ş—r_»que¡_veùÜ
();

98 
	`check_fÜ_wakeup
();

99 
	}
}

112 
	gSw™chAÎoÿtÜ
::
	$¬b™¿‹_špÜts
()

116 
špÜt
 = 0; iÅÜˆ< 
m_num_špÜts
; inport++) {

117 
švc
 = 
m_round_robš_švc
[
špÜt
];

120 
Ãxt_round_robš_švc
 = 
švc
;

121 
Ãxt_round_robš_švc
++;

122 ià(
Ãxt_round_robš_švc
 >ğ
m_num_vcs
)

123 
Ãxt_round_robš_švc
 = 0;

124 
m_round_robš_švc
[
špÜt
] = 
Ãxt_round_robš_švc
;

126 
švc_™”
 = 0; invc_™” < 
m_num_vcs
; invc_iter++) {

128 ià(
m_šput_un™
[
špÜt
]->
	`Ãed_¡age
(
švc
, 
SA_
,

129 
m_rou‹r
->
	`curCyşe
())) {

133 
ouÜt
 = 
m_šput_un™
[
špÜt
]->
	`g‘_ouÜt
(
švc
);

134 
outvc
 = 
m_šput_un™
[
špÜt
]->
	`g‘_outvc
(
švc
);

138 
boŞ
 
make_»que¡
 =

139 
	`£nd_®lowed
(
špÜt
, 
švc
, 
ouÜt
, 
outvc
);

141 ià(
make_»que¡
) {

142 
m_šput_¬b™”_aùiv™y
++;

143 
m_pÜt_»que¡s
[
ouÜt
][
špÜt
] = 
Œue
;

144 
m_vc_wšÃrs
[
ouÜt
][
špÜt
]ğ
švc
;

149 
švc
++;

150 ià(
švc
 >ğ
m_num_vcs
)

151 
švc
 = 0;

154 
	}
}

171 
	gSw™chAÎoÿtÜ
::
	$¬b™¿‹_ouÜts
()

176 
ouÜt
 = 0; ouÜˆ< 
m_num_ouÜts
; outport++) {

177 
špÜt
 = 
m_round_robš_špÜt
[
ouÜt
];

178 
m_round_robš_špÜt
[
ouÜt
]++;

180 ià(
m_round_robš_špÜt
[
ouÜt
] >ğ
m_num_špÜts
)

181 
m_round_robš_špÜt
[
ouÜt
] = 0;

183 
špÜt_™”
 = 0; iÅÜt_™” < 
m_num_špÜts
;

184 
špÜt_™”
++) {

187 ià(
m_pÜt_»que¡s
[
ouÜt
][
špÜt
]) {

190 
švc
 = 
m_vc_wšÃrs
[
ouÜt
][
špÜt
];

192 
outvc
 = 
m_šput_un™
[
špÜt
]->
	`g‘_outvc
(
švc
);

193 ià(
outvc
 == -1) {

195 
outvc
 = 
	`vc_®loÿ‹
(
ouÜt
, 
špÜt
, 
švc
);

199 
æ™
 *
t_æ™
 = 
m_šput_un™
[
špÜt
]->
	`g‘TİFl™
(
švc
);

201 
	`DPRINTF
(
RubyN‘wÜk
, "SwitchAllocator‡t Router %d "

205 
m_rou‹r
->
	`g‘_id
(), 
outvc
,

206 
m_rou‹r
->
	`g‘PÜtDœeùiÚName
(

207 
m_ouut_un™
[
ouÜt
]->
	`g‘_dœeùiÚ
()),

208 
švc
,

209 
m_rou‹r
->
	`g‘PÜtDœeùiÚName
(

210 
m_šput_un™
[
špÜt
]->
	`g‘_dœeùiÚ
()),

211 *
t_æ™
,

212 
m_rou‹r
->
	`curCyşe
());

220 
t_æ™
->
	`£t_ouÜt
(
ouÜt
);

224 
t_æ™
->
	`£t_vc
(
outvc
);

227 
m_ouut_un™
[
ouÜt
]->
	`deüem’t_üed™
(
outvc
);

230 
t_æ™
->
	`advªû_¡age
(
ST_
, 
m_rou‹r
->
	`curCyşe
());

231 
m_rou‹r
->
	`g¿Á_sw™ch
(
špÜt
, 
t_æ™
);

232 
m_ouut_¬b™”_aùiv™y
++;

234 ià((
t_æ™
->
	`g‘_ty³
(è=ğ
TAIL_
) ||

235 
t_æ™
->
	`g‘_ty³
(è=ğ
HEAD_TAIL_
) {

238 
	`as£¹
(!(
m_šput_un™
[
špÜt
]->
	`isR—dy
(
švc
,

239 
m_rou‹r
->
	`curCyşe
())));

242 
m_šput_un™
[
špÜt
]->
	`£t_vc_idË
(
švc
,

243 
m_rou‹r
->
	`curCyşe
());

247 
m_šput_un™
[
špÜt
]->
	`šüem’t_üed™
(
švc
, 
Œue
,

248 
m_rou‹r
->
	`curCyşe
());

252 
m_šput_un™
[
špÜt
]->
	`šüem’t_üed™
(
švc
, 
çl£
,

253 
m_rou‹r
->
	`curCyşe
());

257 
m_pÜt_»que¡s
[
ouÜt
][
špÜt
] = 
çl£
;

262 
špÜt
++;

263 ià(
špÜt
 >ğ
m_num_špÜts
)

264 
špÜt
 = 0;

267 
	}
}

283 
boŞ


284 
	gSw™chAÎoÿtÜ
::
	$£nd_®lowed
(
špÜt
, 
švc
, 
ouÜt
, 
outvc
)

290 
vÃt
 = 
	`g‘_vÃt
(
švc
);

291 
boŞ
 
has_outvc
 = (
outvc
 != -1);

292 
boŞ
 
has_üed™
 = 
çl£
;

294 ià(!
has_outvc
) {

299 ià(
m_ouut_un™
[
ouÜt
]->
	`has_ä“_vc
(
vÃt
)) {

301 
has_outvc
 = 
Œue
;

305 
has_üed™
 = 
Œue
;

308 
has_üed™
 = 
m_ouut_un™
[
ouÜt
]->
	`has_üed™
(
outvc
);

312 ià(!
has_outvc
 || !
has_üed™
)

313  
çl£
;

317 ià((
m_rou‹r
->
	`g‘_Ãt_±r
())->
	`isVN‘Ord”ed
(
vÃt
)) {

320 
Cyşes
 
t_’queue_time
 = 
m_šput_un™
[
špÜt
]->
	`g‘_’queue_time
(
švc
);

324 
vc_ba£
 = 
vÃt
*
m_vc_³r_vÃt
;

325 
vc_off£t
 = 0; vc_off£ˆ< 
m_vc_³r_vÃt
; vc_offset++) {

326 
‹mp_vc
 = 
vc_ba£
 + 
vc_off£t
;

327 ià(
m_šput_un™
[
špÜt
]->
	`Ãed_¡age
(
‹mp_vc
, 
SA_
,

328 
m_rou‹r
->
	`curCyşe
()) &&

329 (
m_šput_un™
[
špÜt
]->
	`g‘_ouÜt
(
‹mp_vc
è=ğ
ouÜt
) &&

330 (
m_šput_un™
[
špÜt
]->
	`g‘_’queue_time
(
‹mp_vc
) <

331 
t_’queue_time
)) {

332  
çl£
;

337  
Œue
;

338 
	}
}

342 
	gSw™chAÎoÿtÜ
::
	$vc_®loÿ‹
(
ouÜt
, 
špÜt
, 
švc
)

345 
outvc
 = 
m_ouut_un™
[
ouÜt
]->
	`£Ëù_ä“_vc
(
	`g‘_vÃt
(
švc
));

348 
	`as£¹
(
outvc
 != -1);

349 
m_šput_un™
[
špÜt
]->
	`g¿Á_outvc
(
švc
, 
outvc
);

350  
outvc
;

351 
	}
}

356 
	gSw™chAÎoÿtÜ
::
	$check_fÜ_wakeup
()

358 
Cyşes
 
ÃxtCyşe
 = 
m_rou‹r
->
	`curCyşe
(è+ 
	`Cyşes
(1);

360 
i
 = 0; i < 
m_num_špÜts
; i++) {

361 
j
 = 0; j < 
m_num_vcs
; j++) {

362 ià(
m_šput_un™
[
i
]->
	`Ãed_¡age
(
j
, 
SA_
, 
ÃxtCyşe
)) {

363 
m_rou‹r
->
	`scheduË_wakeup
(
	`Cyşes
(1));

368 
	}
}

371 
	gSw™chAÎoÿtÜ
::
	$g‘_vÃt
(
švc
)

373 
vÃt
 = 
švc
/
m_vc_³r_vÃt
;

374 
	`as£¹
(
vÃt
 < 
m_rou‹r
->
	`g‘_num_vÃts
());

375  
vÃt
;

376 
	}
}

382 
	gSw™chAÎoÿtÜ
::
	$ş—r_»que¡_veùÜ
()

384 
i
 = 0; i < 
m_num_ouÜts
; i++) {

385 
j
 = 0; j < 
m_num_špÜts
; j++) {

386 
m_pÜt_»que¡s
[
i
][
j
] = 
çl£
;

389 
	}
}

	@ruby/network/garnet2.0/SwitchAllocator.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_SWITCH_ALLOCATOR_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_SWITCH_ALLOCATOR_HH__


	)

37 
	~<io¡»am
>

38 
	~<veùÜ
>

40 
	~"mem/ruby/commÚ/CÚsum”.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

43 
şass
 
	gRou‹r
;

44 
şass
 
	gIÅutUn™
;

45 
şass
 
	gOuutUn™
;

47 şas 
	cSw™chAÎoÿtÜ
 : 
public
 
CÚsum”


49 
public
:

50 
Sw™chAÎoÿtÜ
(
Rou‹r
 *
rou‹r
);

51 
wakeup
();

52 
š™
();

53 
ş—r_»que¡_veùÜ
();

54 
check_fÜ_wakeup
();

55 
g‘_vÃt
 (
švc
);

56 
	$´št
(
¡d
::
o¡»am
& 
out
) const {};

57 
	`¬b™¿‹_špÜts
();

58 
	`¬b™¿‹_ouÜts
();

59 
boŞ
 
	`£nd_®lowed
(
špÜt
, 
švc
, 
ouÜt
, 
outvc
);

60 
	`vc_®loÿ‹
(
ouÜt
, 
špÜt
, 
švc
);

62 
šlše
 

63 
	$g‘_šput_¬b™”_aùiv™y
()

65  
m_šput_¬b™”_aùiv™y
;

66 
	}
}

67 
šlše
 

68 
	$g‘_ouut_¬b™”_aùiv™y
()

70  
m_ouut_¬b™”_aùiv™y
;

71 
	}
}

73 
	g´iv©e
:

74 
m_num_špÜts
, 
	gm_num_ouÜts
;

75 
	gm_num_vcs
, 
	gm_vc_³r_vÃt
;

77 
	gm_šput_¬b™”_aùiv™y
, 
	gm_ouut_¬b™”_aùiv™y
;

79 
Rou‹r
 *
	gm_rou‹r
;

80 
	g¡d
::
veùÜ
<> 
m_round_robš_švc
;

81 
	g¡d
::
veùÜ
<> 
m_round_robš_špÜt
;

82 
	g¡d
::
veùÜ
<
¡d
::veùÜ<
boŞ
>> 
m_pÜt_»que¡s
;

83 
	g¡d
::
veùÜ
<
¡d
::veùÜ<>> 
m_vc_wšÃrs
;

84 
	g¡d
::
veùÜ
<
IÅutUn™
 *> 
m_šput_un™
;

85 
	g¡d
::
veùÜ
<
OuutUn™
 *> 
m_ouut_un™
;

	@ruby/network/garnet2.0/VirtualChannel.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/Vœtu®ChªÃl.hh
"

36 
	gVœtu®ChªÃl
::
	$Vœtu®ChªÃl
(
id
)

37 : 
	$m_’queue_time
(
INFINITE_
)

39 
m_id
 = 
id
;

40 
m_šput_bufãr
 = 
Ãw
 
	`æ™Bufãr
();

41 
m_vc_¡©e
.
fœ¡
 = 
IDLE_
;

42 
m_vc_¡©e
.
£cÚd
 = 
	`Cyşes
(0);

43 
m_ouut_vc
 = -1;

44 
m_ouut_pÜt
 = -1;

45 
	}
}

47 
	gVœtu®ChªÃl
::~
	$Vœtu®ChªÃl
()

49 
d–‘e
 
m_šput_bufãr
;

50 
	}
}

53 
	gVœtu®ChªÃl
::
	$£t_idË
(
Cyşes
 
curTime
)

55 
m_vc_¡©e
.
fœ¡
 = 
IDLE_
;

56 
m_vc_¡©e
.
£cÚd
 = 
curTime
;

57 
m_’queue_time
 = 
	`Cyşes
(
INFINITE_
);

58 
m_ouut_pÜt
 = -1;

59 
m_ouut_vc
 = -1;

60 
	}
}

63 
	gVœtu®ChªÃl
::
	$£t_aùive
(
Cyşes
 
curTime
)

65 
m_vc_¡©e
.
fœ¡
 = 
ACTIVE_
;

66 
m_vc_¡©e
.
£cÚd
 = 
curTime
;

67 
m_’queue_time
 = 
curTime
;

68 
	}
}

70 
boŞ


71 
	gVœtu®ChªÃl
::
	$Ãed_¡age
(
æ™_¡age
 
¡age
, 
Cyşes
 
time
)

73 ià(
m_šput_bufãr
->
	`isR—dy
(
time
)) {

74 
	`as£¹
(
m_vc_¡©e
.
fœ¡
 =ğ
ACTIVE_
 && m_vc_¡©e.
£cÚd
 <ğ
time
);

75 
æ™
 *
t_æ™
 = 
m_šput_bufãr
->
	`³ekTİFl™
();

76 (
t_æ™
->
	`is_¡age
(
¡age
, 
time
));

78  
çl£
;

79 
	}
}

81 
ušt32_t


82 
	gVœtu®ChªÃl
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

84  
m_šput_bufãr
->
	`funùiÚ®Wr™e
(
pkt
);

85 
	}
}

	@ruby/network/garnet2.0/VirtualChannel.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_VIRTUAL_CHANNEL_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_VIRTUAL_CHANNEL_HH__


	)

37 
	~<ut™y
>

39 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

40 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™Bufãr.hh
"

42 şas 
	cVœtu®ChªÃl


44 
	mpublic
:

45 
Vœtu®ChªÃl
(
id
);

46 ~
Vœtu®ChªÃl
();

48 
boŞ
 
Ãed_¡age
(
æ™_¡age
 
¡age
, 
Cyşes
 
time
);

49 
£t_idË
(
Cyşes
 
curTime
);

50 
£t_aùive
(
Cyşes
 
curTime
);

51 
	$£t_outvc
(
outvc
è{ 
m_ouut_vc
 = outvc; }

52 
šlše
 
	$g‘_outvc
(è{  
m_ouut_vc
; 
	}
}

53 
	$£t_ouÜt
(
ouÜt
è{ 
m_ouut_pÜt
 = ouÜt; 
	}
};

54 
šlše
 
	$g‘_ouÜt
(è{  
m_ouut_pÜt
; 
	}
}

56 
šlše
 
Cyşes
 
	$g‘_’queue_time
(è{  
m_’queue_time
; 
	}
}

57 
šlše
 
	$£t_’queue_time
(
Cyşes
 
time
è{ 
m_’queue_time
 =ime; 
	}
}

58 
šlše
 
VC_¡©e_ty³
 
	$g‘_¡©e
(è{  
m_vc_¡©e
.
fœ¡
; 
	}
}

60 
šlše
 
boŞ
 
	$isR—dy
(
Cyşes
 
curTime
)

62  
m_šput_bufãr
->
	`isR—dy
(
curTime
);

63 
	}
}

65 
šlše
 

66 
	$š£¹Fl™
(
æ™
 *
t_æ™
)

68 
m_šput_bufãr
->
	`š£¹
(
t_æ™
);

69 
	}
}

71 
šlše
 

72 
	$£t_¡©e
(
VC_¡©e_ty³
 
m_¡©e
, 
Cyşes
 
curTime
)

74 
m_vc_¡©e
.
fœ¡
 = 
m_¡©e
;

75 
m_vc_¡©e
.
£cÚd
 = 
curTime
;

76 
	}
}

78 
šlše
 
æ™
*

79 
	$³ekTİFl™
()

81  
m_šput_bufãr
->
	`³ekTİFl™
();

82 
	}
}

84 
šlše
 
æ™
*

85 
	$g‘TİFl™
()

87  
m_šput_bufãr
->
	`g‘TİFl™
();

88 
	}
}

90 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

92 
	g´iv©e
:

93 
m_id
;

94 
æ™Bufãr
 *
	gm_šput_bufãr
;

95 
	g¡d
::
·œ
<
VC_¡©e_ty³
, 
	gCyşes
> 
	gm_vc_¡©e
;

96 
	gm_ouut_pÜt
;

97 
Cyşes
 
	gm_’queue_time
;

98 
	gm_ouut_vc
;

	@ruby/network/garnet2.0/flit.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™.hh
"

37 
	gæ™
::
	$æ™
(
id
, 
vc
, 
vÃt
, 
Rou‹Info
 
rou‹
, 
size
,

38 
MsgPŒ
 
msg_±r
, 
Cyşes
 
curTime
)

40 
m_size
 = 
size
;

41 
m_msg_±r
 = 
msg_±r
;

42 
m_’queue_time
 = 
curTime
;

43 
m_time
 = 
curTime
;

44 
m_id
 = 
id
;

45 
m_vÃt
 = 
vÃt
;

46 
m_vc
 = 
vc
;

47 
m_rou‹
 = 
rou‹
;

48 
m_¡age
.
fœ¡
 = 
I_
;

49 
m_¡age
.
£cÚd
 = 
m_time
;

51 ià(
size
 == 1) {

52 
m_ty³
 = 
HEAD_TAIL_
;

55 ià(
id
 == 0)

56 
m_ty³
 = 
HEAD_
;

57 ià(
id
 =ğ(
size
 - 1))

58 
m_ty³
 = 
TAIL_
;

60 
m_ty³
 = 
BODY_
;

61 
	}
}

65 
	gæ™
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

67 
out
 << "[flit:: ";

68 
out
 << "Id=" << 
m_id
 << " ";

69 
out
 << "Ty³=" << 
m_ty³
 << " ";

70 
out
 << "VÃt=" << 
m_vÃt
 << " ";

71 
out
 << "VC=" << 
m_vc
 << " ";

72 
out
 << "SrøNI=" << 
m_rou‹
.
¤c_ni
 << " ";

73 
out
 << "SrøRou‹r=" << 
m_rou‹
.
¤c_rou‹r
 << " ";

74 
out
 << "De¡ NI=" << 
m_rou‹
.
de¡_ni
 << " ";

75 
out
 << "De¡ Rou‹r=" << 
m_rou‹
.
de¡_rou‹r
 << " ";

76 
out
 << "EnqueuTime=" << 
m_’queue_time
 << " ";

77 
out
 << "]";

78 
	}
}

80 
boŞ


81 
	gæ™
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

83 
Mes§ge
 *
msg
 = 
m_msg_±r
.
	`g‘
();

84  
msg
->
	`funùiÚ®Wr™e
(
pkt
);

85 
	}
}

	@ruby/network/garnet2.0/flit.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_FLIT_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_FLIT_HH__


	)

37 
	~<ÿs£¹
>

38 
	~<io¡»am
>

40 
	~"ba£/ty³s.hh
"

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

42 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

44 şas 
	cæ™


46 
	mpublic
:

47 
	$æ™
() {}

48 
	`æ™
(
id
, 
vc
, 
vÃt
, 
Rou‹Info
 
rou‹
, 
size
,

49 
MsgPŒ
 
msg_±r
, 
Cyşes
 
curTime
);

51 
	$g‘_ouÜt
(è{ 
m_ouÜt
; 
	}
}

52 
	$g‘_size
(è{  
m_size
; 
	}
}

53 
Cyşes
 
	$g‘_’queue_time
(è{  
m_’queue_time
; 
	}
}

54 
	$g‘_id
(è{  
m_id
; 
	}
}

55 
Cyşes
 
	$g‘_time
(è{  
m_time
; 
	}
}

56 
	$g‘_vÃt
(è{  
m_vÃt
; 
	}
}

57 
	$g‘_vc
(è{  
m_vc
; 
	}
}

58 
Rou‹Info
 
	$g‘_rou‹
(è{  
m_rou‹
; 
	}
}

59 
	gMsgPŒ
& 
	$g‘_msg_±r
(è{  
m_msg_±r
; 
	}
}

60 
æ™_ty³
 
	$g‘_ty³
(è{  
m_ty³
; 
	}
}

61 
	g¡d
::
·œ
<
æ™_¡age
, 
	gCyşes
> 
	$g‘_¡age
(è{  
m_¡age
; 
	}
}

62 
Cyşes
 
	$g‘_¤c_d–ay
(è{  
¤c_d–ay
; 
	}
}

64 
	$£t_ouÜt
(
pÜt
è{ 
m_ouÜt
 =…Üt; 
	}
}

65 
	$£t_time
(
Cyşes
 
time
è{ 
m_time
 =ime; 
	}
}

66 
	$£t_vc
(
vc
è{ 
m_vc
 = vc; 
	}
}

67 
	$£t_rou‹
(
Rou‹Info
 
rou‹
è{ 
m_rou‹
 =„ou‹; 
	}
}

68 
	$£t_¤c_d–ay
(
Cyşes
 
d–ay
è{ 
¤c_d–ay
 = d–ay; 
	}
}

70 
	$šüem’t_hİs
(è{ 
m_rou‹
.
hİs_Œav”£d
++; 
	}
}

71 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

73 
boŞ


74 
	$is_¡age
(
æ™_¡age
 
¡age
, 
Cyşes
 
time
)

76  (
¡age
 =ğ
m_¡age
.
fœ¡
 &&

77 
time
 >ğ
m_¡age
.
£cÚd
);

78 
	}
}

81 
	$advªû_¡age
(
æ™_¡age
 
t_¡age
, 
Cyşes
 
ÃwTime
)

83 
m_¡age
.
fœ¡
 = 
t_¡age
;

84 
m_¡age
.
£cÚd
 = 
ÃwTime
;

85 
	}
}

87 
boŞ


88 
	$g»©”
(
æ™
* 
n1
, fl™* 
n2
)

90 ià(
n1
->
	`g‘_time
(è=ğ
n2
->get_time()) {

92  (
n1
->
	`g‘_id
(è> 
n2
->get_id());

94  (
n1
->
	`g‘_time
(è> 
n2
->get_time());

96 
	}
}

98 
boŞ
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

100 
	g´Ùeùed
:

101 
m_id
;

102 
	gm_vÃt
;

103 
	gm_vc
;

104 
Rou‹Info
 
	gm_rou‹
;

105 
	gm_size
;

106 
Cyşes
 
	gm_’queue_time
, 
	gm_time
;

107 
æ™_ty³
 
	gm_ty³
;

108 
MsgPŒ
 
	gm_msg_±r
;

109 
	gm_ouÜt
;

110 
Cyşes
 
	g¤c_d–ay
;

111 
	g¡d
::
·œ
<
æ™_¡age
, 
	gCyşes
> 
	gm_¡age
;

114 
šlše
 
	g¡d
::
o¡»am
&

115 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gæ™
& 
	gobj
)

117 
	gobj
.
´št
(
out
);

118 
	gout
 << 
	g¡d
::
æush
;

119  
	gout
;

	@ruby/network/garnet2.0/flitBuffer.cc

34 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™Bufãr.hh
"

36 
	gæ™Bufãr
::
	$æ™Bufãr
()

38 
max_size
 = 
INFINITE_
;

39 
	}
}

41 
	gæ™Bufãr
::
	$æ™Bufãr
(
maximum_size
)

43 
max_size
 = 
maximum_size
;

44 
	}
}

46 
boŞ


47 
	gæ™Bufãr
::
	$isEm±y
()

49  (
m_bufãr
.
	`size
() == 0);

50 
	}
}

52 
boŞ


53 
	gæ™Bufãr
::
	$isR—dy
(
Cyşes
 
curTime
)

55 ià(
m_bufãr
.
	`size
() != 0 ) {

56 
æ™
 *
t_æ™
 = 
	`³ekTİFl™
();

57 ià(
t_æ™
->
	`g‘_time
(è<ğ
curTime
)

58  
Œue
;

60  
çl£
;

61 
	}
}

64 
	gæ™Bufãr
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

66 
out
 << "[æ™Bufãr: " << 
m_bufãr
.
	`size
(è<< "] " << 
¡d
::
’dl
;

67 
	}
}

69 
boŞ


70 
	gæ™Bufãr
::
	$isFuÎ
()

72  (
m_bufãr
.
	`size
(è>ğ
max_size
);

73 
	}
}

76 
	gæ™Bufãr
::
	$£tMaxSize
(
maximum
)

78 
max_size
 = 
maximum
;

79 
	}
}

81 
ušt32_t


82 
	gæ™Bufãr
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

84 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

86 
i
 = 0; i < 
m_bufãr
.
	`size
(); ++i) {

87 ià(
m_bufãr
[
i
]->
	`funùiÚ®Wr™e
(
pkt
)) {

88 
num_funùiÚ®_wr™es
++;

92  
num_funùiÚ®_wr™es
;

93 
	}
}

	@ruby/network/garnet2.0/flitBuffer.hh

34 #iâdeà
__MEM_RUBY_NETWORK_GARNET_FLIT_BUFFER_HH__


35 
	#__MEM_RUBY_NETWORK_GARNET_FLIT_BUFFER_HH__


	)

37 
	~<®gÜ™hm
>

38 
	~<io¡»am
>

39 
	~<veùÜ
>

41 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/CommÚTy³s.hh
"

42 
	~"mem/ruby/ÃtwÜk/g¬Ãt2.0/æ™.hh
"

44 şas 
	cæ™Bufãr


46 
	mpublic
:

47 
æ™Bufãr
();

48 
æ™Bufãr
(
maximum_size
);

50 
boŞ
 
isR—dy
(
Cyşes
 
curTime
);

51 
boŞ
 
isEm±y
();

52 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

53 
boŞ
 
	`isFuÎ
();

54 
	`£tMaxSize
(
maximum
);

56 
æ™
 *

57 
	$g‘TİFl™
()

59 
æ™
 *
f
 = 
m_bufãr
.
	`äÚt
();

60 
¡d
::
	`pİ_h—p
(
m_bufãr
.
	`begš
(), m_bufãr.
	`’d
(), 
æ™
::
g»©”
);

61 
m_bufãr
.
	`pİ_back
();

62  
f
;

65 
æ™
 *

66 
	$³ekTİFl™
()

68  
m_bufãr
.
	`äÚt
();

69 
	}
}

72 
	$š£¹
(
æ™
 *
æt
)

74 
m_bufãr
.
	`push_back
(
æt
);

75 
¡d
::
	`push_h—p
(
m_bufãr
.
	`begš
(), m_bufãr.
	`’d
(), 
æ™
::
g»©”
);

76 
	}
}

78 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

80 
	g´iv©e
:

81 
¡d
::
veùÜ
<
æ™
 *> 
m_bufãr
;

82 
	gmax_size
;

85 
šlše
 
	g¡d
::
o¡»am
&

86 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gæ™Bufãr
& 
	gobj
)

88 
	gobj
.
´št
(
out
);

89 
	gout
 << 
	g¡d
::
æush
;

90  
	gout
;

	@ruby/network/simple/PerfectSwitch.cc

29 
	~<®gÜ™hm
>

31 
	~"ba£/ÿ¡.hh
"

32 
	~"ba£/¿ndom.hh
"

33 
	~"debug/RubyN‘wÜk.hh
"

34 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

35 
	~"mem/ruby/ÃtwÜk/sim¶e/P”ãùSw™ch.hh
"

36 
	~"mem/ruby/ÃtwÜk/sim¶e/Sim¶eN‘wÜk.hh
"

37 
	~"mem/ruby/ÃtwÜk/sim¶e/Sw™ch.hh
"

38 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

40 
usšg
 
Çme¥aû
 
	g¡d
;

42 cÚ¡ 
	gPRIORITY_SWITCH_LIMIT
 = 128;

45 
boŞ


46 
	gİ”©Ü
<(cÚ¡ 
	gLškOrd”
& 
	gl1
, cÚ¡ LškOrd”& 
	gl2
)

48  (
	gl1
.
	gm_v®ue
 < 
	gl2
.m_value);

51 
	gP”ãùSw™ch
::
	$P”ãùSw™ch
(
Sw™chID
 
sid
, 
Sw™ch
 *
sw
, 
ušt32_t
 
vœt_Ãts
)

52 : 
	`CÚsum”
(
sw
), 
	`m_sw™ch_id
(
sid
), 
	$m_sw™ch
(
sw
)

54 
m_round_robš_¡¬t
 = 0;

55 
m_wakeups_wo_sw™ch
 = 0;

56 
m_vœtu®_ÃtwÜks
 = 
vœt_Ãts
;

57 
	}
}

60 
	gP”ãùSw™ch
::
	$š™
(
Sim¶eN‘wÜk
 *
ÃtwÜk_±r
)

62 
m_ÃtwÜk_±r
 = 
ÃtwÜk_±r
;

64 
i
 = 0;˜< 
m_vœtu®_ÃtwÜks
;++i) {

65 
m_³ndšg_mes§ge_couÁ
.
	`push_back
(0);

67 
	}
}

70 
	gP”ãùSw™ch
::
addInPÜt
(cÚ¡ 
veùÜ
<
Mes§geBufãr
*>& 
š
)

72 
NodeID
 
pÜt
 = 
m_š
.
size
();

73 
	gm_š
.
push_back
(
š
);

75 
	gi
 = 0; i < 
	gš
.
size
(); ++i) {

76 ià(
	gš
[
i
] !ğ
nuÎ±r
) {

77 
š
[
i
]->
£tCÚsum”
(
this
);

78 
	gš
[
i
]->
£tIncomšgLšk
(
pÜt
);

79 
	gš
[
i
]->
£tVÃt
(i);

85 
	gP”ãùSw™ch
::
addOutPÜt
(cÚ¡ 
veùÜ
<
Mes§geBufãr
*>& 
out
,

86 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
)

89 
LškOrd”
 
	gl
;

90 
	gl
.
	gm_v®ue
 = 0;

91 
	gl
.
	gm_lšk
 = 
m_out
.
size
();

92 
	gm_lšk_Üd”
.
push_back
(
l
);

95 
	gm_out
.
push_back
(
out
);

96 
	gm_routšg_bË
.
push_back
(
routšg_bË_’Œy
);

99 
	gP”ãùSw™ch
::~
	$P”ãùSw™ch
()

101 
	}
}

104 
P”ãùSw™ch
::
	$İ”©eVÃt
(
vÃt
)

107 
šcomšg
 = 
m_round_robš_¡¬t
;

108 
m_round_robš_¡¬t
++;

109 ià(
m_round_robš_¡¬t
 >ğ
m_š
.
	`size
()) {

110 
m_round_robš_¡¬t
 = 0;

113 ià(
m_³ndšg_mes§ge_couÁ
[
vÃt
] > 0) {

115 
couÁ”
 = 0; couÁ” < 
m_š
.
	`size
(); counter++) {

117 
šcomšg
++;

118 ià(
šcomšg
 >ğ
m_š
.
	`size
()) {

119 
šcomšg
 = 0;

123 ià(
m_š
[
šcomšg
].
	`size
(è<ğ
vÃt
) {

127 
Mes§geBufãr
 *
bufãr
 = 
m_š
[
šcomšg
][
vÃt
];

128 ià(
bufãr
 =ğ
nuÎ±r
) {

132 
	`İ”©eMes§geBufãr
(
bufãr
, 
šcomšg
, 
vÃt
);

135 
	}
}

138 
	gP”ãùSw™ch
::
	$İ”©eMes§geBufãr
(
Mes§geBufãr
 *
bufãr
, 
šcomšg
,

139 
vÃt
)

141 
MsgPŒ
 
msg_±r
;

142 
Mes§ge
 *
Ãt_msg_±r
 = 
NULL
;

145 
veùÜ
<
LškID
> 
ouut_lšks
;

146 
veùÜ
<
N‘De¡
> 
ouut_lšk_de¡š©iÚs
;

147 
Tick
 
cu¼’t_time
 = 
m_sw™ch
->
	`şockEdge
();

149 
bufãr
->
	`isR—dy
(
cu¼’t_time
)) {

150 
	`DPRINTF
(
RubyN‘wÜk
, "šcomšg: %d\n", 
šcomšg
);

153 
msg_±r
 = 
bufãr
->
	`³ekMsgPŒ
();

154 
Ãt_msg_±r
 = 
msg_±r
.
	`g‘
();

155 
	`DPRINTF
(
RubyN‘wÜk
, "Mes§ge: %s\n", (*
Ãt_msg_±r
));

157 
ouut_lšks
.
	`ş—r
();

158 
ouut_lšk_de¡š©iÚs
.
	`ş—r
();

159 
N‘De¡
 
msg_d¡s
 = 
Ãt_msg_±r
->
	`g‘De¡š©iÚ
();

165 
	`as£¹
(
m_lšk_Üd”
.
	`size
(è=ğ
m_routšg_bË
.size());

166 
	`as£¹
(
m_lšk_Üd”
.
	`size
(è=ğ
m_out
.size());

168 ià(
m_ÃtwÜk_±r
->
	`g‘Ad­tiveRoutšg
()) {

169 ià(
m_ÃtwÜk_±r
->
	`isVN‘Ord”ed
(
vÃt
)) {

171 
out
 = 0; ouˆ< 
m_out
.
	`size
(); out++) {

172 
m_lšk_Üd”
[
out
].
m_lšk
 = out;

173 
m_lšk_Üd”
[
out
].
m_v®ue
 = 0;

177 
out
 = 0; ouˆ< 
m_out
.
	`size
(); out++) {

178 
out_queue_Ëngth
 = 0;

179 
v
 = 0; v < 
m_vœtu®_ÃtwÜks
; v++) {

180 
out_queue_Ëngth
 +ğ
m_out
[
out
][
v
]->
	`g‘Size
(
cu¼’t_time
);

182 
v®ue
 =

183 (
out_queue_Ëngth
 << 8) |

184 
¿ndom_mt
.
	`¿ndom
(0, 0xff);

185 
m_lšk_Üd”
[
out
].
m_lšk
 = out;

186 
m_lšk_Üd”
[
out
].
m_v®ue
 = 
v®ue
;

190 
	`sÜt
(
m_lšk_Üd”
.
	`begš
(), m_lšk_Üd”.
	`’d
());

194 
i
 = 0; i < 
m_routšg_bË
.
	`size
(); i++) {

196 
lšk
 = 
m_lšk_Üd”
[
i
].
m_lšk
;

197 
N‘De¡
 
d¡
 = 
m_routšg_bË
[
lšk
];

198 
	`DPRINTF
(
RubyN‘wÜk
, "d¡: %s\n", 
d¡
);

200 ià(!
msg_d¡s
.
	`š‹r£ùiÚIsNÙEm±y
(
d¡
))

204 
ouut_lšks
.
	`push_back
(
lšk
);

210 
ouut_lšk_de¡š©iÚs
.
	`push_back
(
msg_d¡s
.
	`AND
(
d¡
));

214 
msg_d¡s
.
	`»moveN‘De¡
(
d¡
);

217 
	`as£¹
(
msg_d¡s
.
	`couÁ
() == 0);

220 
boŞ
 
’ough
 = 
Œue
;

221 
i
 = 0; i < 
ouut_lšks
.
	`size
(); i++) {

222 
outgošg
 = 
ouut_lšks
[
i
];

224 ià(!
m_out
[
outgošg
][
vÃt
]->
	`¬eNSlÙsAvaabË
(1, 
cu¼’t_time
))

225 
’ough
 = 
çl£
;

227 
	`DPRINTF
(
RubyN‘wÜk
, "Checking if‚ode is blocked ..."

229 
outgošg
, 
vÃt
, 
’ough
);

233 ià(!
’ough
) {

234 
	`scheduËEv’t
(
	`Cyşes
(1));

235 
	`DPRINTF
(
RubyN‘wÜk
, "Can't deliver message since‡‚ode "

237 
	`DPRINTF
(
RubyN‘wÜk
, "Mes§ge: %s\n", (*
Ãt_msg_±r
));

241 
MsgPŒ
 
unmodif›d_msg_±r
;

243 ià(
ouut_lšks
.
	`size
() > 1) {

251 
unmodif›d_msg_±r
 = 
msg_±r
->
	`şÚe
();

255 
bufãr
->
	`dequeue
(
cu¼’t_time
);

256 
m_³ndšg_mes§ge_couÁ
[
vÃt
]--;

259 
i
=0; i<
ouut_lšks
.
	`size
(); i++) {

260 
outgošg
 = 
ouut_lšks
[
i
];

262 ià(
i
 > 0) {

264 
msg_±r
 = 
unmodif›d_msg_±r
->
	`şÚe
();

269 
Ãt_msg_±r
 = 
msg_±r
.
	`g‘
();

270 
Ãt_msg_±r
->
	`g‘De¡š©iÚ
(èğ
ouut_lšk_de¡š©iÚs
[
i
];

273 
	`DPRINTF
(
RubyN‘wÜk
, "Enqueuing‚et msg from "

275 
šcomšg
, 
vÃt
, 
outgošg
, vnet);

277 
m_out
[
outgošg
][
vÃt
]->
	`’queue
(
msg_±r
, 
cu¼’t_time
,

278 
m_sw™ch
->
	`cyşesToTicks
(
	`Cyşes
(1)));

281 
	}
}

284 
	gP”ãùSw™ch
::
	$wakeup
()

287 
m_wakeups_wo_sw™ch
++;

288 
highe¡_´io_vÃt
 = 
m_vœtu®_ÃtwÜks
-1;

289 
lowe¡_´io_vÃt
 = 0;

290 
deüem’‹r
 = 1;

293 ià(
m_wakeups_wo_sw™ch
 > 
PRIORITY_SWITCH_LIMIT
) {

294 
m_wakeups_wo_sw™ch
 = 0;

295 
highe¡_´io_vÃt
 = 0;

296 
lowe¡_´io_vÃt
 = 
m_vœtu®_ÃtwÜks
-1;

297 
deüem’‹r
 = -1;

301 
vÃt
 = 
highe¡_´io_vÃt
;

302 (
vÃt
 * 
deüem’‹r
è>ğ(deüem’‹¸* 
lowe¡_´io_vÃt
);

303 
vÃt
 -ğ
deüem’‹r
) {

304 
	`İ”©eVÃt
(
vÃt
);

306 
	}
}

309 
	gP”ãùSw™ch
::
	$¡ÜeEv’tInfo
(
šfo
)

311 
m_³ndšg_mes§ge_couÁ
[
šfo
]++;

312 
	}
}

315 
	gP”ãùSw™ch
::
	$ş—rSts
()

317 
	}
}

319 
P”ãùSw™ch
::
	$cŞÏ‹Sts
()

321 
	}
}

325 
P”ãùSw™ch
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

327 
out
 << "[P”ãùSw™ch " << 
m_sw™ch_id
 << "]";

328 
	}
}

	@ruby/network/simple/PerfectSwitch.hh

36 #iâdeà
__MEM_RUBY_NETWORK_SIMPLE_PERFECTSWITCH_HH__


37 
	#__MEM_RUBY_NETWORK_SIMPLE_PERFECTSWITCH_HH__


	)

39 
	~<io¡»am
>

40 
	~<¡ršg
>

41 
	~<veùÜ
>

43 
	~"mem/ruby/commÚ/CÚsum”.hh
"

45 
şass
 
	gMes§geBufãr
;

46 
şass
 
	gN‘De¡
;

47 
şass
 
	gSim¶eN‘wÜk
;

48 
şass
 
	gSw™ch
;

50 
	sLškOrd”


52 
	mm_lšk
;

53 
	mm_v®ue
;

56 
boŞ
 
	gİ”©Ü
<(cÚ¡ 
	gLškOrd”
& 
	gl1
, cÚ¡ LškOrd”& 
	gl2
);

58 şas 
	cP”ãùSw™ch
 : 
public
 
CÚsum”


60 
public
:

61 
P”ãùSw™ch
(
Sw™chID
 
sid
, 
Sw™ch
 *, 
ušt32_t
);

62 ~
P”ãùSw™ch
();

64 
	m¡d
::
¡ršg
 
	$Çme
()

65 {  
	`c¥rštf
("P”ãùSw™ch-%i", 
m_sw™ch_id
); }

67 
	`š™
(
Sim¶eN‘wÜk
 *);

68 
	`addInPÜt
(cÚ¡ 
¡d
::
veùÜ
<
Mes§geBufãr
*>& 
š
);

69 
	`addOutPÜt
(cÚ¡ 
¡d
::
veùÜ
<
Mes§geBufãr
*>& 
out
,

70 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
);

72 
	$g‘InLšks
(ècÚ¡ {  
m_š
.
	`size
(); 
	}
}

73 
	$g‘OutLšks
(ècÚ¡ {  
m_out
.
	`size
(); 
	}
}

75 
wakeup
();

76 
¡ÜeEv’tInfo
(
šfo
);

78 
ş—rSts
();

79 
cŞÏ‹Sts
();

80 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

82 
´iv©e
:

84 
	`P”ãùSw™ch
(cÚ¡ 
P”ãùSw™ch
& 
obj
);

85 
P”ãùSw™ch
& 
İ”©Ü
=(cÚ¡ P”ãùSw™ch& 
obj
);

87 
	`İ”©eVÃt
(
vÃt
);

88 
	`İ”©eMes§geBufãr
(
Mes§geBufãr
 *
b
, 
šcomšg
, 
vÃt
);

90 cÚ¡ 
Sw™chID
 
m_sw™ch_id
;

91 
Sw™ch
 * cÚ¡ 
m_sw™ch
;

94 
¡d
::
veùÜ
<¡d::veùÜ<
Mes§geBufãr
*> > 
m_š
;

95 
¡d
::
veùÜ
<¡d::veùÜ<
Mes§geBufãr
*> > 
m_out
;

97 
¡d
::
veùÜ
<
N‘De¡
> 
m_routšg_bË
;

98 
¡d
::
veùÜ
<
LškOrd”
> 
m_lšk_Üd”
;

100 
ušt32_t
 
m_vœtu®_ÃtwÜks
;

101 
m_round_robš_¡¬t
;

102 
m_wakeups_wo_sw™ch
;

104 
Sim¶eN‘wÜk
* 
m_ÃtwÜk_±r
;

105 
¡d
::
veùÜ
<> 
m_³ndšg_mes§ge_couÁ
;

106 
	}
};

108 
šlše
 
	g¡d
::
o¡»am
&

109 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gP”ãùSw™ch
& 
	gobj
)

111 
	gobj
.
´št
(
out
);

112 
	gout
 << 
	g¡d
::
æush
;

113  
	gout
;

	@ruby/network/simple/SimpleLink.cc

29 
	~"mem/ruby/ÃtwÜk/sim¶e/Sim¶eLšk.hh
"

31 
	gSim¶eExtLšk
::
	$Sim¶eExtLšk
(cÚ¡ 
P¬ams
 *
p
)

32 : 
	$BasicExtLšk
(
p
)

38 
m_bw_muÉl›r
 = 
p
->
bªdwidth_çùÜ
;

39 
	}
}

42 
	gSim¶eExtLšk
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

44 
out
 << 
	`Çme
();

45 
	}
}

47 
Sim¶eExtLšk
 *

48 
	gSim¶eExtLškP¬ams
::
	$ü—‹
()

50  
Ãw
 
	`Sim¶eExtLšk
(
this
);

51 
	}
}

53 
	gSim¶eIÁLšk
::
	$Sim¶eIÁLšk
(cÚ¡ 
P¬ams
 *
p
)

54 : 
	$BasicIÁLšk
(
p
)

60 
m_bw_muÉl›r
 = 
p
->
bªdwidth_çùÜ
;

61 
	}
}

64 
	gSim¶eIÁLšk
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

66 
out
 << 
	`Çme
();

67 
	}
}

69 
Sim¶eIÁLšk
 *

70 
	gSim¶eIÁLškP¬ams
::
	$ü—‹
()

72  
Ãw
 
	`Sim¶eIÁLšk
(
this
);

73 
	}
}

	@ruby/network/simple/SimpleLink.hh

29 #iâdeà
__MEM_RUBY_NETWORK_SIMPLE_LINK_HH__


30 
	#__MEM_RUBY_NETWORK_SIMPLE_LINK_HH__


	)

32 
	~<io¡»am
>

33 
	~<¡ršg
>

34 
	~<veùÜ
>

36 
	~"·¿ms/Sim¶eExtLšk.hh
"

37 
	~"·¿ms/Sim¶eIÁLšk.hh
"

38 
	~"mem/ruby/ÃtwÜk/BasicLšk.hh
"

40 şas 
	cSim¶eExtLšk
 : 
public
 
BasicExtLšk


42 
public
:

43 
Sim¶eExtLškP¬ams
 
	tP¬ams
;

44 
Sim¶eExtLšk
(cÚ¡ 
P¬ams
 *
p
);

45 cÚ¡ 
P¬ams
 *
	$·¿ms
(ècÚ¡ {  (cÚ¡ 
P¬ams
 *)
_·¿ms
; }

47 
ä›nd
 
şass
 
TİŞogy
;

48 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

50 
m_bw_muÉl›r
;

51 
	}
};

53 
šlše
 
	g¡d
::
o¡»am
&

54 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gSim¶eExtLšk
& 
	gobj
)

56 
	gobj
.
´št
(
out
);

57 
	gout
 << 
	g¡d
::
æush
;

58  
	gout
;

61 şas 
	cSim¶eIÁLšk
 : 
public
 
BasicIÁLšk


63 
public
:

64 
Sim¶eIÁLškP¬ams
 
	tP¬ams
;

65 
Sim¶eIÁLšk
(cÚ¡ 
P¬ams
 *
p
);

66 cÚ¡ 
P¬ams
 *
	$·¿ms
(ècÚ¡ {  (cÚ¡ 
P¬ams
 *)
_·¿ms
; }

68 
ä›nd
 
şass
 
TİŞogy
;

69 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

71 
m_bw_muÉl›r
;

72 
	}
};

74 
šlše
 
	g¡d
::
o¡»am
&

75 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gSim¶eIÁLšk
& 
	gobj
)

77 
	gobj
.
´št
(
out
);

78 
	gout
 << 
	g¡d
::
æush
;

79  
	gout
;

	@ruby/network/simple/SimpleNetwork.cc

29 
	~<ÿs£¹
>

30 
	~<num”ic
>

32 
	~"ba£/ÿ¡.hh
"

33 
	~"ba£/¡l_h–³rs.hh
"

34 
	~"mem/ruby/commÚ/N‘De¡.hh
"

35 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

36 
	~"mem/ruby/ÃtwÜk/sim¶e/Sim¶eLšk.hh
"

37 
	~"mem/ruby/ÃtwÜk/sim¶e/Sim¶eN‘wÜk.hh
"

38 
	~"mem/ruby/ÃtwÜk/sim¶e/Sw™ch.hh
"

39 
	~"mem/ruby/ÃtwÜk/sim¶e/ThrÙe.hh
"

40 
	~"mem/ruby/´of”/Prof”.hh
"

42 
usšg
 
Çme¥aû
 
	g¡d
;

43 
usšg
 
	gm5
::
¡l_h–³rs
::
d–‘ePoš‹rs
;

45 
	gSim¶eN‘wÜk
::
	$Sim¶eN‘wÜk
(cÚ¡ 
P¬ams
 *
p
)

46 : 
	`N‘wÜk
(
p
), 
	`m_bufãr_size
Õ->
bufãr_size
),

47 
	`m_’dpošt_bªdwidth
(
p
->
’dpošt_bªdwidth
),

48 
	`m_ad­tive_routšg
(
p
->
ad­tive_routšg
)

51 
veùÜ
<
BasicRou‹r
*>::
cÚ¡_™”©Ü
 
i
 = 
p
->
rou‹rs
.
	`begš
();

52 
i
 !ğ
p
->
rou‹rs
.
	`’d
(); ++i) {

53 
Sw™ch
* 
s
 = 
§ã_ÿ¡
<Sw™ch*>(*
i
);

54 
m_sw™ches
.
	`push_back
(
s
);

55 
s
->
	`š™_Ãt_±r
(
this
);

58 
m_št_lšk_bufãrs
 = 
p
->
št_lšk_bufãrs
;

59 
m_num_cÚÃùed_bufãrs
 = 0;

60 
	}
}

63 
	gSim¶eN‘wÜk
::
	$š™
()

65 
N‘wÜk
::
	`š™
();

69 
	`as£¹
(
m_tİŞogy_±r
 !ğ
NULL
);

70 
m_tİŞogy_±r
->
	`ü—‹Lšks
(
this
);

71 
	}
}

73 
	gSim¶eN‘wÜk
::~
	$Sim¶eN‘wÜk
()

75 
	`d–‘ePoš‹rs
(
m_sw™ches
);

76 
	`d–‘ePoš‹rs
(
m_št_lšk_bufãrs
);

77 
	}
}

81 
	gSim¶eN‘wÜk
::
	$makeExtOutLšk
(
Sw™chID
 
¤c
, 
NodeID
 
de¡
, 
BasicLšk
* 
lšk
,

82 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
)

84 
	`as£¹
(
de¡
 < 
m_nodes
);

85 
	`as£¹
(
¤c
 < 
m_sw™ches
.
	`size
());

86 
	`as£¹
(
m_sw™ches
[
¤c
] !ğ
NULL
);

88 
Sim¶eExtLšk
 *
sim¶e_lšk
 = 
§ã_ÿ¡
<Sim¶eExtLšk*>(
lšk
);

90 
m_sw™ches
[
¤c
]->
	`addOutPÜt
(
m_äomN‘Queues
[
de¡
], 
routšg_bË_’Œy
,

91 
sim¶e_lšk
->
m_Ï‹ncy
,

92 
sim¶e_lšk
->
m_bw_muÉl›r
);

93 
	}
}

97 
	gSim¶eN‘wÜk
::
	$makeExtInLšk
(
NodeID
 
¤c
, 
Sw™chID
 
de¡
, 
BasicLšk
* 
lšk
,

98 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
)

100 
	`as£¹
(
¤c
 < 
m_nodes
);

101 
m_sw™ches
[
de¡
]->
	`addInPÜt
(
m_toN‘Queues
[
¤c
]);

102 
	}
}

106 
	gSim¶eN‘wÜk
::
	$makeIÁ”ÇlLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
, 
BasicLšk
* 
lšk
,

107 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
,

108 
PÜtDœeùiÚ
 
¤c_ouÜt
,

109 
PÜtDœeùiÚ
 
d¡_špÜt
)

112 
¡d
::
veùÜ
<
Mes§geBufãr
*> 
	`queues
(
m_vœtu®_ÃtwÜks
);

114 
i
 = 0; i < 
m_vœtu®_ÃtwÜks
; i++) {

116 
	`as£¹
(
m_num_cÚÃùed_bufãrs
 < 
m_št_lšk_bufãrs
.
	`size
());

117 
Mes§geBufãr
* 
bufãr_±r
 = 
m_št_lšk_bufãrs
[
m_num_cÚÃùed_bufãrs
];

118 
m_num_cÚÃùed_bufãrs
++;

119 
queues
[
i
] = 
bufãr_±r
;

123 
Sim¶eIÁLšk
 *
sim¶e_lšk
 = 
§ã_ÿ¡
<Sim¶eIÁLšk*>(
lšk
);

125 
m_sw™ches
[
de¡
]->
	`addInPÜt
(
queues
);

126 
m_sw™ches
[
¤c
]->
	`addOutPÜt
(
queues
, 
routšg_bË_’Œy
,

127 
sim¶e_lšk
->
m_Ï‹ncy
,

128 
sim¶e_lšk
->
m_bw_muÉl›r
);

129 
	}
}

132 
	gSim¶eN‘wÜk
::
	$»gSts
()

134 
N‘wÜk
::
	`»gSts
();

136 
Mes§geSizeTy³
 
ty³
 = 
Mes§geSizeTy³_FIRST
;

137 
ty³
 < 
Mes§geSizeTy³_NUM
; ++type) {

138 
m_msg_couÁs
[(è
ty³
]

139 .
	`Çme
Òame(è+ ".msg_couÁ." + 
	`Mes§geSizeTy³_to_¡ršg
(
ty³
))

140 .
	`æags
(
Sts
::
noz”o
)

142 
m_msg_by‹s
[(è
ty³
]

143 .
	`Çme
Òame(è+ ".msg_by‹." + 
	`Mes§geSizeTy³_to_¡ršg
(
ty³
))

144 .
	`æags
(
Sts
::
noz”o
)

148 
i
 = 0; i < 
m_sw™ches
.
	`size
(); i++) {

149 
m_msg_couÁs
[(è
ty³
] +=

150 
	`sum
(
m_sw™ches
[
i
]->
	`g‘MsgCouÁ
(
ty³
));

153 
m_msg_by‹s
[(è
ty³
] =

154 
m_msg_couÁs
[(è
ty³
] * 
Sts
::
	`cÚ¡ªt
(

155 
N‘wÜk
::
	`Mes§geSizeTy³_to_št
(
ty³
));

157 
	}
}

160 
	gSim¶eN‘wÜk
::
	$cŞÏ‹Sts
()

162 
i
 = 0; i < 
m_sw™ches
.
	`size
(); i++) {

163 
m_sw™ches
[
i
]->
	`cŞÏ‹Sts
();

165 
	}
}

168 
	gSim¶eN‘wÜk
::
	$´št
(
o¡»am
& 
out
) const

170 
out
 << "[SimpleNetwork]";

171 
	}
}

173 
Sim¶eN‘wÜk
 *

174 
	gSim¶eN‘wÜkP¬ams
::
	$ü—‹
()

176  
Ãw
 
	`Sim¶eN‘wÜk
(
this
);

177 
	}
}

184 
boŞ


185 
	gSim¶eN‘wÜk
::
	$funùiÚ®R—d
(
Pack‘
 *
pkt
)

187 
i
 = 0; i < 
m_sw™ches
.
	`size
(); i++) {

188 ià(
m_sw™ches
[
i
]->
	`funùiÚ®R—d
(
pkt
)) {

189  
Œue
;

193  
çl£
;

194 
	}
}

196 
ušt32_t


197 
	gSim¶eN‘wÜk
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

199 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

201 
i
 = 0; i < 
m_sw™ches
.
	`size
(); i++) {

202 
num_funùiÚ®_wr™es
 +ğ
m_sw™ches
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

205 
i
 = 0; i < 
m_št_lšk_bufãrs
.
	`size
(); ++i) {

206 
num_funùiÚ®_wr™es
 +ğ
m_št_lšk_bufãrs
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

208  
num_funùiÚ®_wr™es
;

209 
	}
}

	@ruby/network/simple/SimpleNetwork.hh

29 #iâdeà
__MEM_RUBY_NETWORK_SIMPLE_SIMPLENETWORK_HH__


30 
	#__MEM_RUBY_NETWORK_SIMPLE_SIMPLENETWORK_HH__


	)

32 
	~<io¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/ruby/ÃtwÜk/N‘wÜk.hh
"

36 
	~"·¿ms/Sim¶eN‘wÜk.hh
"

38 
şass
 
	gN‘De¡
;

39 
şass
 
	gMes§geBufãr
;

40 
şass
 
	gThrÙe
;

41 
şass
 
	gSw™ch
;

43 şas 
	cSim¶eN‘wÜk
 : 
public
 
N‘wÜk


45 
public
:

46 
Sim¶eN‘wÜkP¬ams
 
	tP¬ams
;

47 
Sim¶eN‘wÜk
(cÚ¡ 
P¬ams
 *
p
);

48 ~
Sim¶eN‘wÜk
();

50 
š™
();

52 
	$g‘BufãrSize
(è{  
m_bufãr_size
; }

53 
	$g‘EndpoštBªdwidth
(è{  
m_’dpošt_bªdwidth
; 
	}
}

54 
boŞ
 
	$g‘Ad­tiveRoutšg
(è{ 
m_ad­tive_routšg
; 
	}
}

56 
cŞÏ‹Sts
();

57 
»gSts
();

59 
boŞ
 
	$isVN‘Ord”ed
(
vÃt
ècÚ¡ {  
m_Üd”ed
[vÃt]; 
	}
}

62 
makeExtOutLšk
(
Sw™chID
 
¤c
, 
NodeID
 
de¡
, 
BasicLšk
* 
lšk
,

63 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
);

64 
makeExtInLšk
(
NodeID
 
¤c
, 
Sw™chID
 
de¡
, 
BasicLšk
* 
lšk
,

65 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
);

66 
makeIÁ”ÇlLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
, 
BasicLšk
* 
lšk
,

67 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
,

68 
PÜtDœeùiÚ
 
¤c_ouÜt
,

69 
PÜtDœeùiÚ
 
d¡_špÜt
);

71 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

73 
boŞ
 
	`funùiÚ®R—d
(
Pack‘
 *
pkt
);

74 
ušt32_t
 
	`funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

76 
´iv©e
:

77 
	`addLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
, 
lšk_Ï‹ncy
);

78 
	`makeLšk
(
Sw™chID
 
¤c
, Sw™chID 
de¡
,

79 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
, 
lšk_Ï‹ncy
);

80 
	`makeTİŞogy
();

83 
	`Sim¶eN‘wÜk
(cÚ¡ 
Sim¶eN‘wÜk
& 
obj
);

84 
Sim¶eN‘wÜk
& 
İ”©Ü
=(cÚ¡ Sim¶eN‘wÜk& 
obj
);

86 
¡d
::
veùÜ
<
Sw™ch
*> 
m_sw™ches
;

87 
¡d
::
veùÜ
<
Mes§geBufãr
*> 
m_št_lšk_bufãrs
;

88 
m_num_cÚÃùed_bufãrs
;

89 cÚ¡ 
m_bufãr_size
;

90 cÚ¡ 
m_’dpošt_bªdwidth
;

91 cÚ¡ 
boŞ
 
m_ad­tive_routšg
;

94 
Sts
::
FÜmuÏ
 
m_msg_couÁs
[
Mes§geSizeTy³_NUM
];

95 
Sts
::
FÜmuÏ
 
m_msg_by‹s
[
Mes§geSizeTy³_NUM
];

96 
	}
};

98 
šlše
 
	g¡d
::
o¡»am
&

99 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gSim¶eN‘wÜk
& 
	gobj
)

101 
	gobj
.
´št
(
out
);

102 
	gout
 << 
	g¡d
::
æush
;

103  
	gout
;

	@ruby/network/simple/Switch.cc

29 
	~<num”ic
>

31 
	~"ba£/ÿ¡.hh
"

32 
	~"ba£/¡l_h–³rs.hh
"

33 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

34 
	~"mem/ruby/ÃtwÜk/sim¶e/P”ãùSw™ch.hh
"

35 
	~"mem/ruby/ÃtwÜk/sim¶e/Sim¶eN‘wÜk.hh
"

36 
	~"mem/ruby/ÃtwÜk/sim¶e/Sw™ch.hh
"

37 
	~"mem/ruby/ÃtwÜk/sim¶e/ThrÙe.hh
"

39 
usšg
 
Çme¥aû
 
	g¡d
;

40 
usšg
 
	gm5
::
¡l_h–³rs
::
d–‘ePoš‹rs
;

41 
usšg
 
	gm5
::
¡l_h–³rs
::
İ”©Ü
<<;

43 
	gSw™ch
::
	$Sw™ch
(cÚ¡ 
P¬ams
 *
p
è: 
	$BasicRou‹r
(
p
)

45 
m_³rãù_sw™ch
 = 
Ãw
 
	`P”ãùSw™ch
(
m_id
, 
this
, 
p
->
vœt_Ãts
);

46 
m_pÜt_bufãrs
 = 
p
->
pÜt_bufãrs
;

47 
m_num_cÚÃùed_bufãrs
 = 0;

48 
	}
}

50 
	gSw™ch
::~
	$Sw™ch
()

52 
d–‘e
 
m_³rãù_sw™ch
;

55 
	`d–‘ePoš‹rs
(
m_thrÙes
);

58 
	`d–‘ePoš‹rs
(
m_pÜt_bufãrs
);

59 
	}
}

62 
	gSw™ch
::
	$š™
()

64 
BasicRou‹r
::
	`š™
();

65 
m_³rãù_sw™ch
->
	`š™
(
m_ÃtwÜk_±r
);

66 
	}
}

69 
	gSw™ch
::
addInPÜt
(cÚ¡ 
veùÜ
<
Mes§geBufãr
*>& 
š
)

71 
m_³rãù_sw™ch
->
addInPÜt
(
š
);

75 
	gSw™ch
::
addOutPÜt
(cÚ¡ 
veùÜ
<
Mes§geBufãr
*>& 
out
,

76 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
,

77 
Cyşes
 
lšk_Ï‹ncy
, 
bw_muÉl›r
)

80 
RubySy¡em
 *
	grs
 = 
m_ÃtwÜk_±r
->
·¿ms
()->
ruby_sy¡em
;

81 
ThrÙe
* 
	gthrÙe_±r
 = 
Ãw
 ThrÙe(
m_id
, 
rs
, 
m_thrÙes
.
size
(),

82 
lšk_Ï‹ncy
, 
bw_muÉl›r
,

83 
m_ÃtwÜk_±r
->
g‘EndpoštBªdwidth
(),

84 
this
);

86 
	gm_thrÙes
.
push_back
(
thrÙe_±r
);

89 
	gveùÜ
<
	gMes§geBufãr
*> 
	gš‹rmedŸ‹Bufãrs
;

91 
	gi
 = 0; i < 
	gout
.
size
(); ++i) {

92 
as£¹
(
m_num_cÚÃùed_bufãrs
 < 
m_pÜt_bufãrs
.
size
());

93 
Mes§geBufãr
* 
	gbufãr_±r
 = 
m_pÜt_bufãrs
[
m_num_cÚÃùed_bufãrs
];

94 
	gm_num_cÚÃùed_bufãrs
++;

95 
	gš‹rmedŸ‹Bufãrs
.
push_back
(
bufãr_±r
);

99 
	gm_³rãù_sw™ch
->
addOutPÜt
(
š‹rmedŸ‹Bufãrs
, 
routšg_bË_’Œy
);

102 
	gthrÙe_±r
->
addLšks
(
š‹rmedŸ‹Bufãrs
, 
out
);

105 cÚ¡ 
ThrÙe
*

106 
	gSw™ch
::
	$g‘ThrÙe
(
LškID
 
lšk_numb”
) const

108 
	`as£¹
(
m_thrÙes
[
lšk_numb”
] !ğ
NULL
);

109  
m_thrÙes
[
lšk_numb”
];

110 
	}
}

113 
	gSw™ch
::
	$»gSts
()

115 
BasicRou‹r
::
	`»gSts
();

117 
lšk
 = 0;†šk < 
m_thrÙes
.
	`size
();†ink++) {

118 
m_thrÙes
[
lšk
]->
	`»gSts
(
	`Çme
());

121 
m_avg_utiz©iÚ
.
	`Çme
(name() + ".percent_links_utilized");

122 
i
 = 0; i < 
m_thrÙes
.
	`size
(); i++) {

123 
m_avg_utiz©iÚ
 +ğ
m_thrÙes
[
i
]->
	`g‘Utiz©iÚ
();

125 
m_avg_utiz©iÚ
 /ğ
Sts
::
	`cÚ¡ªt
(
m_thrÙes
.
	`size
());

127 
ty³
 = 
Mes§geSizeTy³_FIRST
;

128 
ty³
 < 
Mes§geSizeTy³_NUM
; ++type) {

129 
m_msg_couÁs
[
ty³
]

130 .
	`Çme
(name() + ".msg_count." +

131 
	`Mes§geSizeTy³_to_¡ršg
(
	`Mes§geSizeTy³
(
ty³
)))

132 .
	`æags
(
Sts
::
noz”o
)

134 
m_msg_by‹s
[
ty³
]

135 .
	`Çme
(name() + ".msg_bytes." +

136 
	`Mes§geSizeTy³_to_¡ršg
(
	`Mes§geSizeTy³
(
ty³
)))

137 .
	`æags
(
Sts
::
noz”o
)

140 
i
 = 0; i < 
m_thrÙes
.
	`size
(); i++) {

141 
m_msg_couÁs
[
ty³
] +ğ
m_thrÙes
[
i
]->
	`g‘MsgCouÁ
(type);

143 
m_msg_by‹s
[
ty³
] = 
m_msg_couÁs
[ty³] * 
Sts
::
	`cÚ¡ªt
(

144 
N‘wÜk
::
	`Mes§geSizeTy³_to_št
(
	`Mes§geSizeTy³
(
ty³
)));

146 
	}
}

149 
	gSw™ch
::
	$»£tSts
()

151 
m_³rãù_sw™ch
->
	`ş—rSts
();

152 
i
 = 0; i < 
m_thrÙes
.
	`size
(); i++) {

153 
m_thrÙes
[
i
]->
	`ş—rSts
();

155 
	}
}

158 
	gSw™ch
::
	$cŞÏ‹Sts
()

160 
m_³rãù_sw™ch
->
	`cŞÏ‹Sts
();

161 
i
 = 0; i < 
m_thrÙes
.
	`size
(); i++) {

162 
m_thrÙes
[
i
]->
	`cŞÏ‹Sts
();

164 
	}
}

167 
	gSw™ch
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

170 
out
 << "[Switch]";

171 
	}
}

173 
boŞ


174 
	gSw™ch
::
	$funùiÚ®R—d
(
Pack‘
 *
pkt
)

176  
çl£
;

177 
	}
}

179 
ušt32_t


180 
	gSw™ch
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

183 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

184 
i
 = 0; i < 
m_pÜt_bufãrs
.
	`size
(); ++i) {

185 
num_funùiÚ®_wr™es
 +ğ
m_pÜt_bufãrs
[
i
]->
	`funùiÚ®Wr™e
(
pkt
);

187  
num_funùiÚ®_wr™es
;

188 
	}
}

190 
Sw™ch
 *

191 
	gSw™chP¬ams
::
	$ü—‹
()

193  
Ãw
 
	`Sw™ch
(
this
);

194 
	}
}

	@ruby/network/simple/Switch.hh

39 #iâdeà
__MEM_RUBY_NETWORK_SIMPLE_SWITCH_HH__


40 
	#__MEM_RUBY_NETWORK_SIMPLE_SWITCH_HH__


	)

42 
	~<io¡»am
>

43 
	~<veùÜ
>

45 
	~"mem/·ck‘.hh
"

46 
	~"mem/´ÙocŞ/Mes§geSizeTy³.hh
"

47 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

48 
	~"mem/ruby/ÃtwÜk/BasicRou‹r.hh
"

49 
	~"·¿ms/Sw™ch.hh
"

51 
şass
 
	gMes§geBufãr
;

52 
şass
 
	gP”ãùSw™ch
;

53 
şass
 
	gN‘De¡
;

54 
şass
 
	gSim¶eN‘wÜk
;

55 
şass
 
	gThrÙe
;

57 şas 
	cSw™ch
 : 
public
 
BasicRou‹r


59 
public
:

60 
Sw™chP¬ams
 
	tP¬ams
;

61 
Sw™ch
(cÚ¡ 
P¬ams
 *
p
);

62 ~
Sw™ch
();

63 
š™
();

65 
addInPÜt
(cÚ¡ 
¡d
::
veùÜ
<
Mes§geBufãr
*>& 
š
);

66 
addOutPÜt
(cÚ¡ 
¡d
::
veùÜ
<
Mes§geBufãr
*>& 
out
,

67 cÚ¡ 
N‘De¡
& 
routšg_bË_’Œy
,

68 
Cyşes
 
lšk_Ï‹ncy
, 
bw_muÉl›r
);

70 cÚ¡ 
ThrÙe
* 
	$g‘ThrÙe
(
LškID
 
lšk_numb”
) const;

72 
	`»£tSts
();

73 
	`cŞÏ‹Sts
();

74 
	`»gSts
();

75 cÚ¡ 
Sts
::
FÜmuÏ
 & 
	$g‘MsgCouÁ
(
ty³
) const

76 {  
m_msg_couÁs
[
ty³
]; }

78 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

79 
	$š™_Ãt_±r
(
Sim¶eN‘wÜk
* 
Ãt_±r
è{ 
m_ÃtwÜk_±r
 =‚‘_±r; 
	}
}

81 
boŞ
 
funùiÚ®R—d
(
Pack‘
 *);

82 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *);

84 
	g´iv©e
:

86 
Sw™ch
(cÚ¡ Sw™ch& 
obj
);

87 
	gSw™ch
& 
	gİ”©Ü
=(cÚ¡ 
Sw™ch
& 
obj
);

89 
P”ãùSw™ch
* 
	gm_³rãù_sw™ch
;

90 
Sim¶eN‘wÜk
* 
	gm_ÃtwÜk_±r
;

91 
	g¡d
::
veùÜ
<
ThrÙe
*> 
m_thrÙes
;

92 
	g¡d
::
veùÜ
<
Mes§geBufãr
*> 
m_pÜt_bufãrs
;

93 
	gm_num_cÚÃùed_bufãrs
;

96 
	gSts
::
FÜmuÏ
 
m_avg_utiz©iÚ
;

97 
	gSts
::
FÜmuÏ
 
m_msg_couÁs
[
Mes§geSizeTy³_NUM
];

98 
	gSts
::
FÜmuÏ
 
m_msg_by‹s
[
Mes§geSizeTy³_NUM
];

101 
šlše
 
	g¡d
::
o¡»am
&

102 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gSw™ch
& 
	gobj
)

104 
	gobj
.
´št
(
out
);

105 
	gout
 << 
	g¡d
::
æush
;

106  
	gout
;

	@ruby/network/simple/Throttle.cc

29 
	~<ÿs£¹
>

31 
	~"ba£/ÿ¡.hh
"

32 
	~"ba£/ırštf.hh
"

33 
	~"debug/RubyN‘wÜk.hh
"

34 
	~"mem/ruby/ÃtwÜk/sim¶e/Sw™ch.hh
"

35 
	~"mem/ruby/ÃtwÜk/sim¶e/ThrÙe.hh
"

36 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

37 
	~"mem/ruby/ÃtwÜk/N‘wÜk.hh
"

38 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

39 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

41 
usšg
 
Çme¥aû
 
	g¡d
;

43 cÚ¡ 
	gMESSAGE_SIZE_MULTIPLIER
 = 1000;

45 cÚ¡ 
	gBROADCAST_SCALING
 = 1;

46 cÚ¡ 
	gPRIORITY_SWITCH_LIMIT
 = 128;

48 
ÃtwÜk_mes§ge_to_size
(
Mes§ge
* 
Ãt_msg_±r
);

50 
	gThrÙe
::
	$ThrÙe
(
sID
, 
RubySy¡em
 *
rs
, 
NodeID
 
node
, 
Cyşes
 
lšk_Ï‹ncy
,

51 
lšk_bªdwidth_muÉl›r
, 
’dpošt_bªdwidth
,

52 
Sw™ch
 *
em
)

53 : 
	`CÚsum”
(
em
), 
	`m_sw™ch_id
(
sID
), 
	`m_sw™ch
Óm), 
	`m_node
(
node
),

54 
	$m_ruby_sy¡em
(
rs
)

56 
m_vÃts
 = 0;

58 
	`as£¹
(
lšk_bªdwidth_muÉl›r
 > 0);

59 
m_lšk_bªdwidth_muÉl›r
 = 
lšk_bªdwidth_muÉl›r
;

61 
m_lšk_Ï‹ncy
 = 
lšk_Ï‹ncy
;

62 
m_’dpošt_bªdwidth
 = 
’dpošt_bªdwidth
;

64 
m_wakeups_wo_sw™ch
 = 0;

65 
m_lšk_utiz©iÚ_´oxy
 = 0;

66 
	}
}

69 
	gThrÙe
::
addLšks
(cÚ¡ 
veùÜ
<
Mes§geBufãr
*>& 
š_vec
,

70 cÚ¡ 
veùÜ
<
Mes§geBufãr
*>& 
out_vec
)

72 
as£¹
(
š_vec
.
size
(è=ğ
out_vec
.size());

74 
	gvÃt
 = 0; vÃˆ< 
	gš_vec
.
size
(); ++vnet) {

75 
Mes§geBufãr
 *
	gš_±r
 = 
š_vec
[
vÃt
];

76 
Mes§geBufãr
 *
	gout_±r
 = 
out_vec
[
vÃt
];

78 
	gm_vÃts
++;

79 
	gm_un™s_»maššg
.
push_back
(0);

80 
	gm_š
.
push_back
(
š_±r
);

81 
	gm_out
.
push_back
(
out_±r
);

84 
	gš_±r
->
£tCÚsum”
(
this
);

85 
¡ršg
 
	gdesc
 = "[QueutØThrÙ" + 
to_¡ršg
(
m_sw™ch_id
) + " " +

86 
to_¡ršg
(
m_node
) + "]";

91 
	gThrÙe
::
	$İ”©eVÃt
(
vÃt
, &
bw_»maššg
, 
boŞ
 &
scheduË_wakeup
,

92 
Mes§geBufãr
 *
š
, Mes§geBufã¸*
out
)

94 ià(
out
 =ğ
nuÎ±r
 || 
š
 ==‚ullptr) {

98 
	`as£¹
(
m_un™s_»maššg
[
vÃt
] >= 0);

99 
Tick
 
cu¼’t_time
 = 
m_sw™ch
->
	`şockEdge
();

101 
bw_»maššg
 > 0 && (
š
->
	`isR—dy
(
cu¼’t_time
) ||

102 
m_un™s_»maššg
[
vÃt
] > 0) &&

103 
out
->
	`¬eNSlÙsAvaabË
(1, 
cu¼’t_time
)) {

106 ià(
m_un™s_»maššg
[
vÃt
] =ğ0 && 
š
->
	`isR—dy
(
cu¼’t_time
)) {

108 
MsgPŒ
 
msg_±r
 = 
š
->
	`³ekMsgPŒ
();

109 
Mes§ge
 *
Ãt_msg_±r
 = 
msg_±r
.
	`g‘
();

110 
m_un™s_»maššg
[
vÃt
] +=

111 
	`ÃtwÜk_mes§ge_to_size
(
Ãt_msg_±r
);

113 
	`DPRINTF
(
RubyN‘wÜk
, "throttle: %d my bw %d bw spent "

115 
m_node
, 
	`g‘LškBªdwidth
(), 
m_un™s_»maššg
[
vÃt
],

116 
m_ruby_sy¡em
->
	`curCyşe
());

119 
š
->
	`dequeue
(
cu¼’t_time
);

120 
out
->
	`’queue
(
msg_±r
, 
cu¼’t_time
,

121 
m_sw™ch
->
	`cyşesToTicks
(
m_lšk_Ï‹ncy
));

124 
m_msg_couÁs
[
Ãt_msg_±r
->
	`g‘Mes§geSize
()][
vÃt
]++;

125 
	`DPRINTF
(
RubyN‘wÜk
, "%s\n", *
out
);

129 
diff
 = 
m_un™s_»maššg
[
vÃt
] - 
bw_»maššg
;

130 
m_un™s_»maššg
[
vÃt
] = 
	`max
(0, 
diff
);

131 
bw_»maššg
 = 
	`max
(0, -
diff
);

134 ià(
bw_»maššg
 > 0 && (
š
->
	`isR—dy
(
cu¼’t_time
) ||

135 
m_un™s_»maššg
[
vÃt
] > 0) &&

136 !
out
->
	`¬eNSlÙsAvaabË
(1, 
cu¼’t_time
)) {

137 
	`DPRINTF
(
RubyN‘wÜk
, "vÃt: %d", 
vÃt
);

141 
scheduË_wakeup
 = 
Œue
;

143 
	}
}

146 
	gThrÙe
::
	$wakeup
()

149 
	`as£¹
(
	`g‘LškBªdwidth
() > 0);

150 
bw_»maššg
 = 
	`g‘LškBªdwidth
();

152 
m_wakeups_wo_sw™ch
++;

153 
boŞ
 
scheduË_wakeup
 = 
çl£
;

156 
boŞ
 
™”©iÚ_dœeùiÚ
 = 
çl£
;

160 ià(
m_wakeups_wo_sw™ch
 > 
PRIORITY_SWITCH_LIMIT
) {

161 
m_wakeups_wo_sw™ch
 = 0;

162 
™”©iÚ_dœeùiÚ
 = 
Œue
;

165 ià(
™”©iÚ_dœeùiÚ
) {

166 
vÃt
 = 0; vÃˆ< 
m_vÃts
; ++vnet) {

167 
	`İ”©eVÃt
(
vÃt
, 
bw_»maššg
, 
scheduË_wakeup
,

168 
m_š
[
vÃt
], 
m_out
[vnet]);

171 
vÃt
 = 
m_vÃts
-1; vnet >= 0; --vnet) {

172 
	`İ”©eVÃt
(
vÃt
, 
bw_»maššg
, 
scheduË_wakeup
,

173 
m_š
[
vÃt
], 
m_out
[vnet]);

182 
¿tio
 = 1.0 - ((
bw_»maššg
è/ (
	`g‘LškBªdwidth
()));

185 
m_lšk_utiz©iÚ_´oxy
 +ğ
¿tio
;

187 ià(
bw_»maššg
 > 0 && !
scheduË_wakeup
) {

191 
	`DPRINTF
(
RubyN‘wÜk
, "% nÙ scheduËd‡gaš\n", *
this
);

193 
	`DPRINTF
(
RubyN‘wÜk
, "% scheduËd‡gaš\n", *
this
);

197 
	`scheduËEv’t
(
	`Cyşes
(1));

199 
	}
}

202 
	gThrÙe
::
	$»gSts
(
¡ršg
 
·»Á
)

204 
m_lšk_utiz©iÚ


205 .
	`Çme
(
·»Á
 + 
	`c¥rštf
(".thrÙe%i", 
m_node
) + ".link_utilization");

207 
Mes§geSizeTy³
 
ty³
 = 
Mes§geSizeTy³_FIRST
;

208 
ty³
 < 
Mes§geSizeTy³_NUM
; ++type) {

209 
m_msg_couÁs
[()
ty³
]

210 .
	`š™
(
N‘wÜk
::
	`g‘Numb”OfVœtu®N‘wÜks
())

211 .
	`Çme
(
·»Á
 + 
	`c¥rštf
(".thrÙe%i", 
m_node
) + ".msg_count." +

212 
	`Mes§geSizeTy³_to_¡ršg
(
ty³
))

213 .
	`æags
(
Sts
::
noz”o
)

215 
m_msg_by‹s
[(è
ty³
]

216 .
	`Çme
(
·»Á
 + 
	`c¥rštf
(".thrÙe%i", 
m_node
) + ".msg_bytes." +

217 
	`Mes§geSizeTy³_to_¡ršg
(
ty³
))

218 .
	`æags
(
Sts
::
noz”o
)

221 
m_msg_by‹s
[(è
ty³
] = 
m_msg_couÁs
[ty³] * 
Sts
::
	`cÚ¡ªt
(

222 
N‘wÜk
::
	`Mes§geSizeTy³_to_št
(
ty³
));

224 
	}
}

227 
	gThrÙe
::
	$ş—rSts
()

229 
m_lšk_utiz©iÚ_´oxy
 = 0;

230 
	}
}

233 
	gThrÙe
::
	$cŞÏ‹Sts
()

235 
time_d–
 = (
m_ruby_sy¡em
->
	`curCyşe
() -

236 
m_ruby_sy¡em
->
	`g‘S¹Cyşe
());

238 
m_lšk_utiz©iÚ
 = 100.0 * 
m_lšk_utiz©iÚ_´oxy
 / 
time_d–
;

239 
	}
}

242 
	gThrÙe
::
	$´št
(
o¡»am
& 
out
) const

244 
	`cırštf
(
out
, "[%˜bw: %i]", 
m_node
, 
	`g‘LškBªdwidth
());

245 
	}
}

248 
	$ÃtwÜk_mes§ge_to_size
(
Mes§ge
 *
Ãt_msg_±r
)

250 
	`as£¹
(
Ãt_msg_±r
 !ğ
NULL
);

252 
size
 = 
N‘wÜk
::
	`Mes§geSizeTy³_to_št
(
Ãt_msg_±r
->
	`g‘Mes§geSize
());

253 
size
 *ğ
MESSAGE_SIZE_MULTIPLIER
;

256 ià(
BROADCAST_SCALING
 > 1 && 
Ãt_msg_±r
->
	`g‘De¡š©iÚ
().
	`isBrßdÿ¡
())

257 
size
 *ğ
BROADCAST_SCALING
;

259  
size
;

260 
	}
}

	@ruby/network/simple/Throttle.hh

38 #iâdeà
__MEM_RUBY_NETWORK_SIMPLE_THROTTLE_HH__


39 
	#__MEM_RUBY_NETWORK_SIMPLE_THROTTLE_HH__


	)

41 
	~<io¡»am
>

42 
	~<¡ršg
>

43 
	~<veùÜ
>

45 
	~"mem/ruby/commÚ/CÚsum”.hh
"

46 
	~"mem/ruby/ÃtwÜk/N‘wÜk.hh
"

47 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

49 
şass
 
	gMes§geBufãr
;

50 
şass
 
	gSw™ch
;

52 şas 
	cThrÙe
 : 
public
 
CÚsum”


54 
public
:

55 
ThrÙe
(
sID
, 
RubySy¡em
 *
rs
, 
NodeID
 
node
, 
Cyşes
 
lšk_Ï‹ncy
,

56 
lšk_bªdwidth_muÉl›r
, 
’dpošt_bªdwidth
,

57 
Sw™ch
 *
em
);

58 ~
	$ThrÙe
() {}

60 
¡d
::
¡ršg
 
	$Çme
()

61 {  
	`c¥rštf
("ThrÙe-%i", 
m_sw™ch_id
); 
	}
}

63 
addLšks
(cÚ¡ 
¡d
::
veùÜ
<
Mes§geBufãr
*>& 
š_vec
,

64 cÚ¡ 
¡d
::
veùÜ
<
Mes§geBufãr
*>& 
out_vec
);

65 
wakeup
();

68 cÚ¡ 
	gSts
::
SÿÏr
 & 
	$g‘Utiz©iÚ
() const

69 {  
m_lšk_utiz©iÚ
; 
	}
}

70 cÚ¡ 
	gSts
::
VeùÜ
 & 
	$g‘MsgCouÁ
(
ty³
) const

71 {  
m_msg_couÁs
[
ty³
]; 
	}
}

73 
	$g‘LškBªdwidth
() const

74 {  
m_’dpošt_bªdwidth
 * 
m_lšk_bªdwidth_muÉl›r
; 
	}
}

76 
Cyşes
 
	$g‘L©’cy
(ècÚ¡ {  
m_lšk_Ï‹ncy
; 
	}
}

78 
ş—rSts
();

79 
cŞÏ‹Sts
();

80 
»gSts
(
¡d
::
¡ršg
 
Çme
);

81 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

83 
´iv©e
:

84 
	`š™
(
NodeID
 
node
, 
Cyşes
 
lšk_Ï‹ncy
, 
lšk_bªdwidth_muÉl›r
,

85 
’dpošt_bªdwidth
);

86 
	`İ”©eVÃt
(
vÃt
, &
bw_»mašš
, 
boŞ
 &
scheduË_wakeup
,

87 
Mes§geBufãr
 *
š
, Mes§geBufã¸*
out
);

90 
	`ThrÙe
(cÚ¡ 
ThrÙe
& 
obj
);

91 
ThrÙe
& 
İ”©Ü
=(cÚ¡ ThrÙe& 
obj
);

93 
¡d
::
veùÜ
<
Mes§geBufãr
*> 
m_š
;

94 
¡d
::
veùÜ
<
Mes§geBufãr
*> 
m_out
;

95 
m_vÃts
;

96 
¡d
::
veùÜ
<> 
m_un™s_»maššg
;

98 cÚ¡ 
m_sw™ch_id
;

99 
Sw™ch
 *
m_sw™ch
;

100 
NodeID
 
m_node
;

102 
m_lšk_bªdwidth_muÉl›r
;

103 
Cyşes
 
m_lšk_Ï‹ncy
;

104 
m_wakeups_wo_sw™ch
;

105 
m_’dpošt_bªdwidth
;

106 
RubySy¡em
 *
m_ruby_sy¡em
;

109 
Sts
::
SÿÏr
 
m_lšk_utiz©iÚ
;

110 
Sts
::
VeùÜ
 
m_msg_couÁs
[
Mes§geSizeTy³_NUM
];

111 
Sts
::
FÜmuÏ
 
m_msg_by‹s
[
Mes§geSizeTy³_NUM
];

113 
m_lšk_utiz©iÚ_´oxy
;

114 
	}
};

116 
šlše
 
	g¡d
::
o¡»am
&

117 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gThrÙe
& 
	gobj
)

119 
	gobj
.
´št
(
out
);

120 
	gout
 << 
	g¡d
::
æush
;

121  
	gout
;

	@ruby/profiler/AccessTraceForAddress.cc

29 
	~"mem/ruby/commÚ/Hi¡og¿m.hh
"

30 
	~"mem/ruby/´of”/AcûssT¿ûFÜAdd»ss.hh
"

32 
	gAcûssT¿ûFÜAdd»ss
::~
	$AcûssT¿ûFÜAdd»ss
()

34 ià(
m_hi¡og¿m_±r
) {

35 
d–‘e
 
m_hi¡og¿m_±r
;

36 
m_hi¡og¿m_±r
 = 
NULL
;

38 
	}
}

41 
	gAcûssT¿ûFÜAdd»ss
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

43 
out
 << 
m_addr
;

45 ià(
m_hi¡og¿m_±r
 =ğ
NULL
) {

46 
out
 << " " << 
m_tÙ®
;

47 
out
 << " | " << 
m_lßds
;

48 
out
 << " " << 
m_¡Ües
;

49 
out
 << " " << 
m_©omics
;

50 
out
 << " | " << 
m_u£r
;

51 
out
 << " " << 
m_tÙ®
-
m_u£r
;

52 
out
 << " | " << 
m_sh¬šg
;

53 
out
 << " | " << 
m_touched_by
.
	`couÁ
();

55 
	`as£¹
(
m_tÙ®
 == 0);

56 
out
 << " " << (*
m_hi¡og¿m_±r
);

58 
	}
}

61 
	gAcûssT¿ûFÜAdd»ss
::
	$upd©e
(
RubyReque¡Ty³
 
ty³
,

62 
RubyAcûssMode
 
acûss_mode
, 
NodeID
 
ıu
,

63 
boŞ
 
sh¬šg_miss
)

65 
m_touched_by
.
	`add
(
ıu
);

66 
m_tÙ®
++;

67 ià(
ty³
 =ğ
RubyReque¡Ty³_ATOMIC
) {

68 
m_©omics
++;

69 } ià(
ty³
 =ğ
RubyReque¡Ty³_LD
){

70 
m_lßds
++;

71 } ià(
ty³
 =ğ
RubyReque¡Ty³_ST
){

72 
m_¡Ües
++;

77 ià(
acûss_mode
 =ğ
RubyAcûssMode_U£r
) {

78 
m_u£r
++;

81 ià(
sh¬šg_miss
) {

82 
m_sh¬šg
++;

84 
	}
}

87 
	gAcûssT¿ûFÜAdd»ss
::
	$g‘TÙ®
() const

89 ià(
m_hi¡og¿m_±r
 =ğ
NULL
) {

90  
m_tÙ®
;

92  
m_hi¡og¿m_±r
->
	`g‘TÙ®
();

94 
	}
}

97 
	gAcûssT¿ûFÜAdd»ss
::
	$addSam¶e
(
v®ue
)

99 
	`as£¹
(
m_tÙ®
 == 0);

100 ià(
m_hi¡og¿m_±r
 =ğ
NULL
) {

101 
m_hi¡og¿m_±r
 = 
Ãw
 
Hi¡og¿m
;

103 
m_hi¡og¿m_±r
->
	`add
(
v®ue
);

104 
	}
}

	@ruby/profiler/AccessTraceForAddress.hh

29 #iâdeà
__MEM_RUBY_PROFILER_ACCESSTRACEFORADDRESS_HH__


30 
	#__MEM_RUBY_PROFILER_ACCESSTRACEFORADDRESS_HH__


	)

32 
	~<io¡»am
>

34 
	~"mem/´ÙocŞ/RubyAcûssMode.hh
"

35 
	~"mem/´ÙocŞ/RubyReque¡Ty³.hh
"

36 
	~"mem/ruby/commÚ/Add»ss.hh
"

37 
	~"mem/ruby/commÚ/S‘.hh
"

39 
şass
 
	gHi¡og¿m
;

41 şas 
	cAcûssT¿ûFÜAdd»ss


43 
	mpublic
:

44 
	$AcûssT¿ûFÜAdd»ss
()

45 : 
	`m_lßds
(0), 
	`m_¡Ües
(0), 
	`m_©omics
(0), 
	`m_tÙ®
(0), 
	`m_u£r
(0),

46 
	`m_sh¬šg
(0), 
	$m_hi¡og¿m_±r
(
NULL
)

48 ~
	`AcûssT¿ûFÜAdd»ss
();

50 
	$£tAdd»ss
(
Addr
 
addr
è{ 
m_addr
 =‡ddr; 
	}
}

51 
upd©e
(
RubyReque¡Ty³
 
ty³
, 
RubyAcûssMode
 
acûss_mode
, 
NodeID
 
ıu
,

52 
boŞ
 
sh¬šg_miss
);

53 
	$g‘TÙ®
() const;

54 
	$g‘Sh¬šg
(ècÚ¡ {  
m_sh¬šg
; 
	}
}

55 
	$g‘TouchedBy
(ècÚ¡ {  
m_touched_by
.
	`couÁ
(); 
	}
}

56 
Addr
 
	$g‘Add»ss
(ècÚ¡ {  
m_addr
; 
	}
}

57 
addSam¶e
(
v®ue
);

59 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

61 
šlše
 
boŞ


62 
	$Ëss_equ®
(cÚ¡ 
AcûssT¿ûFÜAdd»ss
* 
n1
,

63 cÚ¡ 
AcûssT¿ûFÜAdd»ss
* 
n2
)

65  
n1
->
	`g‘TÙ®
(è<ğ
n2
->getTotal();

66 
	}
}

68 
	g´iv©e
:

69 
Addr
 
m_addr
;

70 
ušt64_t
 
	gm_lßds
;

71 
ušt64_t
 
	gm_¡Ües
;

72 
ušt64_t
 
	gm_©omics
;

73 
ušt64_t
 
	gm_tÙ®
;

74 
ušt64_t
 
	gm_u£r
;

75 
ušt64_t
 
	gm_sh¬šg
;

76 
S‘
 
	gm_touched_by
;

77 
Hi¡og¿m
* 
	gm_hi¡og¿m_±r
;

80 
šlše
 
	g¡d
::
o¡»am
&

81 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gAcûssT¿ûFÜAdd»ss
& 
	gobj
)

83 
	gobj
.
´št
(
out
);

84 
	gout
 << 
	g¡d
::
æush
;

85  
	gout
;

	@ruby/profiler/AddressProfiler.cc

29 
	~<veùÜ
>

31 
	~"ba£/¡l_h–³rs.hh
"

32 
	~"mem/´ÙocŞ/RubyReque¡.hh
"

33 
	~"mem/ruby/´of”/Add»ssProf”.hh
"

34 
	~"mem/ruby/´of”/Prof”.hh
"

36 
usšg
 
Çme¥aû
 
	g¡d
;

37 
	gAdd»ssProf”
::
	tAdd»ssM­
 AddressMap;

39 
usšg
 
	gm5
::
¡l_h–³rs
::
İ”©Ü
<<;

42 
	gAcûssT¿ûFÜAdd»ss
&

43 
	$lookupT¿ûFÜAdd»ss
(
Addr
 
addr
, 
Add»ssM­
& 
»cÜd_m­
)

49 cÚ¡ 
AcûssT¿ûFÜAdd»ss
 
dæt
;

51 
·œ
<
Add»ssM­
::
™”©Ü
, 
boŞ
> 
r
 =

52 
»cÜd_m­
.
	`š£¹
(
	`make_·œ
(
addr
, 
dæt
));

53 
Add»ssM­
::
™”©Ü
 
i
 = 
r
.
fœ¡
;

54 
AcûssT¿ûFÜAdd»ss
 &
acûss_Œaû
 = 
i
->
£cÚd
;

55 ià(
r
.
£cÚd
) {

58 
acûss_Œaû
.
	`£tAdd»ss
(
addr
);

61  
acûss_Œaû
;

62 
	}
}

65 
	$´štSÜ‹d
(
o¡»am
& 
out
, 
num_of_£qu’ûrs
, cÚ¡ 
Add»ssM­
 &
»cÜd_m­
,

66 
¡ršg
 
desütiÚ
, 
Prof”
 *
´of”
)

68 cÚ¡ 
»cÜds_´š‹d
 = 100;

70 
ušt64_t
 
mis£s
 = 0;

71 
¡d
::
veùÜ
<cÚ¡ 
AcûssT¿ûFÜAdd»ss
 *> 
sÜ‹d
;

73 
Add»ssM­
::
cÚ¡_™”©Ü
 
i
 = 
»cÜd_m­
.
	`begš
();

74 
Add»ssM­
::
cÚ¡_™”©Ü
 
’d
 = 
»cÜd_m­
.
	`’d
();

75 ; 
i
 !ğ
’d
; ++i) {

76 cÚ¡ 
AcûssT¿ûFÜAdd»ss
* 
»cÜd
 = &
i
->
£cÚd
;

77 
mis£s
 +ğ
»cÜd
->
	`g‘TÙ®
();

78 
sÜ‹d
.
	`push_back
(
»cÜd
);

80 
	`sÜt
(
sÜ‹d
.
	`begš
(), sÜ‹d.
	`’d
(), 
AcûssT¿ûFÜAdd»ss
::
Ëss_equ®
);

82 
out
 << "TÙ®_’Œ›s_" << 
desütiÚ
 << ": " << 
»cÜd_m­
.
	`size
()

83 << 
’dl
;

84 ià(
´of”
->
	`g‘AÎIn¡ruùiÚs
())

85 
out
 << "TÙ®_In¡ruùiÚs_" << 
desütiÚ
 << ": " << 
mis£s
 << 
’dl
;

87 
out
 << "TÙ®_d©a_mis£s_" << 
desütiÚ
 << ": " << 
mis£s
 << 
’dl
;

89 
out
 << "total |†oad store‡tomic | user supervisor | sharing |ouched-by"

90 << 
’dl
;

92 
Hi¡og¿m
 
	`»maššg_»cÜds
(1, 100);

93 
Hi¡og¿m
 
	`®l_»cÜds
(1, 100);

94 
Hi¡og¿m
 
	`»maššg_»cÜds_log
(-1);

95 
Hi¡og¿m
 
	`®l_»cÜds_log
(-1);

98 
¡d
::
veùÜ
<
št64_t
> 
m_touched_vec
;

99 
¡d
::
veùÜ
<
št64_t
> 
m_touched_weigh‹d_vec
;

100 
m_touched_vec
.
	`»size
(
num_of_£qu’ûrs
+1);

101 
m_touched_weigh‹d_vec
.
	`»size
(
num_of_£qu’ûrs
+1);

102 
j
 = 0; j < 
m_touched_vec
.
	`size
(); j++) {

103 
m_touched_vec
[
j
] = 0;

104 
m_touched_weigh‹d_vec
[
j
] = 0;

107 
couÁ”
 = 0;

108 
max
 = 
sÜ‹d
.
	`size
();

109 
couÁ”
 < 
max
 && couÁ” < 
»cÜds_´š‹d
) {

110 cÚ¡ 
AcûssT¿ûFÜAdd»ss
* 
»cÜd
 = 
sÜ‹d
[
couÁ”
];

111 
³rûÁ
 = 100.0 * (
»cÜd
->
	`g‘TÙ®
(è/ (
mis£s
));

112 
out
 << 
desütiÚ
 << " | " << 
³rûÁ
 << " % " << *
»cÜd
 << 
’dl
;

113 
®l_»cÜds
.
	`add
(
»cÜd
->
	`g‘TÙ®
());

114 
®l_»cÜds_log
.
	`add
(
»cÜd
->
	`g‘TÙ®
());

115 
couÁ”
++;

116 
m_touched_vec
[
»cÜd
->
	`g‘TouchedBy
()]++;

117 
m_touched_weigh‹d_vec
[
»cÜd
->
	`g‘TouchedBy
()] +ğ»cÜd->
	`g‘TÙ®
();

120 
couÁ”
 < 
max
) {

121 cÚ¡ 
AcûssT¿ûFÜAdd»ss
* 
»cÜd
 = 
sÜ‹d
[
couÁ”
];

122 
®l_»cÜds
.
	`add
(
»cÜd
->
	`g‘TÙ®
());

123 
»maššg_»cÜds
.
	`add
(
»cÜd
->
	`g‘TÙ®
());

124 
®l_»cÜds_log
.
	`add
(
»cÜd
->
	`g‘TÙ®
());

125 
»maššg_»cÜds_log
.
	`add
(
»cÜd
->
	`g‘TÙ®
());

126 
m_touched_vec
[
»cÜd
->
	`g‘TouchedBy
()]++;

127 
m_touched_weigh‹d_vec
[
»cÜd
->
	`g‘TouchedBy
()] +ğ»cÜd->
	`g‘TÙ®
();

129 
out
 << 
’dl
;

130 
out
 << "®l_»cÜds_" << 
desütiÚ
 << ": "

131 << 
®l_»cÜds
 << 
’dl


132 << "®l_»cÜds_log_" << 
desütiÚ
 << ": "

133 << 
®l_»cÜds_log
 << 
’dl


134 << "»maššg_»cÜds_" << 
desütiÚ
 << ": "

135 << 
»maššg_»cÜds
 << 
’dl


136 << "»maššg_»cÜds_log_" << 
desütiÚ
 << ": "

137 << 
»maššg_»cÜds_log
 << 
’dl


138 << "touched_by_" << 
desütiÚ
 << ": "

139 << 
m_touched_vec
 << 
’dl


140 << "touched_by_weigh‹d_" << 
desütiÚ
 << ": "

141 << 
m_touched_weigh‹d_vec
 << 
’dl


142 << 
’dl
;

143 
	}
}

145 
	gAdd»ssProf”
::
	$Add»ssProf”
(
num_of_£qu’ûrs
, 
Prof”
 *
´of”
)

146 : 
	$m_´of”
(
´of”
)

148 
m_num_of_£qu’ûrs
 = 
num_of_£qu’ûrs
;

149 
	`ş—rSts
();

150 
	}
}

152 
	gAdd»ssProf”
::~
	$Add»ssProf”
()

154 
	}
}

157 
Add»ssProf”
::
	$£tHÙLšes
(
boŞ
 
hÙ_lšes
)

159 
m_hÙ_lšes
 = 
hÙ_lšes
;

160 
	}
}

163 
	gAdd»ssProf”
::
	$£tAÎIn¡ruùiÚs
(
boŞ
 
®l_š¡ruùiÚs
)

165 
m_®l_š¡ruùiÚs
 = 
®l_š¡ruùiÚs
;

166 
	}
}

169 
	gAdd»ssProf”
::
	$´štSts
(
o¡»am
& 
out
) const

171 ià(
m_hÙ_lšes
) {

172 
out
 << 
’dl
;

173 
out
 << "Add»ssProf” Sts" << 
’dl
;

174 
out
 << "---------------------" << 
’dl
;

176 
out
 << 
’dl
;

177 
out
 << "sh¬šg_mis£s: " << 
m_sh¬šg_miss_couÁ”
 << 
’dl
;

178 
out
 << "g‘x_sh¬šg_hi¡og¿m: " << 
m_g‘x_sh¬šg_hi¡og¿m
 << 
’dl
;

179 
out
 << "g‘s_sh¬šg_hi¡og¿m: " << 
m_g‘s_sh¬šg_hi¡og¿m
 << 
’dl
;

181 
out
 << 
’dl
;

182 
out
 << "HÙ D©¨Blocks" << 
’dl
;

183 
out
 << "---------------" << 
’dl
;

184 
out
 << 
’dl
;

185 
	`´štSÜ‹d
(
out
, 
m_num_of_£qu’ûrs
, 
m_d©aAcûssT¿û
,

186 "block_add»ss", 
m_´of”
);

188 
out
 << 
’dl
;

189 
out
 << "HÙ MaüoD©¨Blocks" << 
’dl
;

190 
out
 << "--------------------" << 
’dl
;

191 
out
 << 
’dl
;

192 
	`´štSÜ‹d
(
out
, 
m_num_of_£qu’ûrs
, 
m_maüoBlockAcûssT¿û
,

193 "maüoblock_add»ss", 
m_´of”
);

195 
out
 << "HÙ In¡ruùiÚs" << 
’dl
;

196 
out
 << "----------------" << 
’dl
;

197 
out
 << 
’dl
;

198 
	`´štSÜ‹d
(
out
, 
m_num_of_£qu’ûrs
, 
m_´og¿mCouÁ”AcûssT¿û
,

199 "pc_add»ss", 
m_´of”
);

202 ià(
m_®l_š¡ruùiÚs
) {

203 
out
 << 
’dl
;

204 
out
 << "AÎ In¡ruùiÚ Profe:" << 
’dl
;

205 
out
 << "-------------------------" << 
’dl
;

206 
out
 << 
’dl
;

207 
	`´štSÜ‹d
(
out
, 
m_num_of_£qu’ûrs
, 
m_´og¿mCouÁ”AcûssT¿û
,

208 "pc_add»ss", 
m_´of”
);

209 
out
 << 
’dl
;

212 ià(
m_»ŒyProfeHi¡o
.
	`size
() > 0) {

213 
out
 << "R‘ry Profe" << 
’dl
;

214 
out
 << "-------------" << 
’dl
;

215 
out
 << 
’dl
;

216 
out
 << "»Œy_hi¡og¿m_absŞu‹: " << 
m_»ŒyProfeHi¡o
 << 
’dl
;

217 
out
 << "»Œy_hi¡og¿m_wr™e: " << 
m_»ŒyProfeHi¡oWr™e
 << 
’dl
;

218 
out
 << "»Œy_hi¡og¿m_»ad: " << 
m_»ŒyProfeHi¡oR—d
 << 
’dl
;

220 
out
 << "retry_histogram_percent: ";

221 
m_»ŒyProfeHi¡o
.
	`´štP”ûÁ
(
out
);

222 
out
 << 
’dl
;

224 
	`´štSÜ‹d
(
out
, 
m_num_of_£qu’ûrs
, 
m_»ŒyProfeM­
,

225 "block_add»ss", 
m_´of”
);

226 
out
 << 
’dl
;

228 
	}
}

231 
	gAdd»ssProf”
::
	$ş—rSts
()

234 
m_sh¬šg_miss_couÁ”
 = 0;

235 
m_d©aAcûssT¿û
.
	`ş—r
();

236 
m_maüoBlockAcûssT¿û
.
	`ş—r
();

237 
m_´og¿mCouÁ”AcûssT¿û
.
	`ş—r
();

238 
m_»ŒyProfeM­
.
	`ş—r
();

239 
m_»ŒyProfeHi¡o
.
	`ş—r
();

240 
m_»ŒyProfeHi¡oR—d
.
	`ş—r
();

241 
m_»ŒyProfeHi¡oWr™e
.
	`ş—r
();

242 
m_g‘x_sh¬šg_hi¡og¿m
.
	`ş—r
();

243 
m_g‘s_sh¬šg_hi¡og¿m
.
	`ş—r
();

244 
	}
}

247 
	gAdd»ssProf”
::
	$´ofeG‘X
(
Addr
 
d©ablock
, Add¸
PC
,

248 cÚ¡ 
S‘
& 
owÃr
, cÚ¡ S‘& 
sh¬”s
,

249 
NodeID
 
»que¡Ü
)

251 
S‘
 
šdœeùiÚ_£t
;

252 
šdœeùiÚ_£t
.
	`addS‘
(
sh¬”s
);

253 
šdœeùiÚ_£t
.
	`addS‘
(
owÃr
);

254 
šdœeùiÚ_£t
.
	`»move
(
»que¡Ü
);

255 
num_šdœeùiÚs
 = 
šdœeùiÚ_£t
.
	`couÁ
();

257 
m_g‘x_sh¬šg_hi¡og¿m
.
	`add
(
num_šdœeùiÚs
);

258 
boŞ
 
šdœeùiÚ_miss
 = (
num_šdœeùiÚs
 > 0);

260 
	`addT¿ûSam¶e
(
d©ablock
, 
PC
, 
RubyReque¡Ty³_ST
, 
	`RubyAcûssMode
(0),

261 
»que¡Ü
, 
šdœeùiÚ_miss
);

262 
	}
}

265 
	gAdd»ssProf”
::
	$´ofeG‘S
(
Addr
 
d©ablock
, Add¸
PC
,

266 cÚ¡ 
S‘
& 
owÃr
, cÚ¡ S‘& 
sh¬”s
,

267 
NodeID
 
»que¡Ü
)

269 
S‘
 
šdœeùiÚ_£t
;

270 
šdœeùiÚ_£t
.
	`addS‘
(
owÃr
);

271 
šdœeùiÚ_£t
.
	`»move
(
»que¡Ü
);

272 
num_šdœeùiÚs
 = 
šdœeùiÚ_£t
.
	`couÁ
();

274 
m_g‘s_sh¬šg_hi¡og¿m
.
	`add
(
num_šdœeùiÚs
);

275 
boŞ
 
šdœeùiÚ_miss
 = (
num_šdœeùiÚs
 > 0);

277 
	`addT¿ûSam¶e
(
d©ablock
, 
PC
, 
RubyReque¡Ty³_LD
, 
	`RubyAcûssMode
(0),

278 
»que¡Ü
, 
šdœeùiÚ_miss
);

279 
	}
}

282 
	gAdd»ssProf”
::
	$addT¿ûSam¶e
(
Addr
 
d©a_addr
, Add¸
pc_addr
,

283 
RubyReque¡Ty³
 
ty³
,

284 
RubyAcûssMode
 
acûss_mode
, 
NodeID
 
id
,

285 
boŞ
 
sh¬šg_miss
)

287 ià(
m_®l_š¡ruùiÚs
) {

288 ià(
sh¬šg_miss
) {

289 
m_sh¬šg_miss_couÁ”
++;

293 
d©a_addr
 = 
	`makeLšeAdd»ss
(data_addr);

294 
	`lookupT¿ûFÜAdd»ss
(
d©a_addr
, 
m_d©aAcûssT¿û
).

295 
	`upd©e
(
ty³
, 
acûss_mode
, 
id
, 
sh¬šg_miss
);

300 
Addr
 
maüo_addr
 = 
	`maskLowOrd”B™s
(
d©a_addr
, 10);

301 
	`lookupT¿ûFÜAdd»ss
(
maüo_addr
, 
m_maüoBlockAcûssT¿û
).

302 
	`upd©e
(
ty³
, 
acûss_mode
, 
id
, 
sh¬šg_miss
);

305 
	`lookupT¿ûFÜAdd»ss
(
pc_addr
, 
m_´og¿mCouÁ”AcûssT¿û
).

306 
	`upd©e
(
ty³
, 
acûss_mode
, 
id
, 
sh¬šg_miss
);

309 ià(
m_®l_š¡ruùiÚs
) {

313 
	`lookupT¿ûFÜAdd»ss
(
pc_addr
, 
m_´og¿mCouÁ”AcûssT¿û
).

314 
	`upd©e
(
ty³
, 
acûss_mode
, 
id
, 
sh¬šg_miss
);

316 
	}
}

319 
	gAdd»ssProf”
::
	$´ofeR‘ry
(
Addr
 
d©a_addr
, 
AcûssTy³
 
ty³
, 
couÁ
)

321 
m_»ŒyProfeHi¡o
.
	`add
(
couÁ
);

322 ià(
ty³
 =ğ
AcûssTy³_R—d
) {

323 
m_»ŒyProfeHi¡oR—d
.
	`add
(
couÁ
);

325 
m_»ŒyProfeHi¡oWr™e
.
	`add
(
couÁ
);

327 ià(
couÁ
 > 1) {

328 
	`lookupT¿ûFÜAdd»ss
(
d©a_addr
, 
m_»ŒyProfeM­
).
	`addSam¶e
(
couÁ
);

330 
	}
}

	@ruby/profiler/AddressProfiler.hh

29 #iâdeà
__MEM_RUBY_PROFILER_ADDRESSPROFILER_HH__


30 
	#__MEM_RUBY_PROFILER_ADDRESSPROFILER_HH__


	)

32 
	~<io¡»am
>

33 
	~<unÜd”ed_m­
>

35 
	~"mem/´ÙocŞ/AcûssTy³.hh
"

36 
	~"mem/´ÙocŞ/RubyReque¡.hh
"

37 
	~"mem/ruby/commÚ/Add»ss.hh
"

38 
	~"mem/ruby/commÚ/Hi¡og¿m.hh
"

39 
	~"mem/ruby/´of”/AcûssT¿ûFÜAdd»ss.hh
"

40 
	~"mem/ruby/´of”/Prof”.hh
"

42 
şass
 
	gS‘
;

44 şas 
	cAdd»ssProf”


46 
	mpublic
:

47 
¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	tAcûssT¿ûFÜAdd»ss
> 
	tAdd»ssM­
;

49 
	mpublic
:

50 
Add»ssProf”
(
num_of_£qu’ûrs
, 
Prof”
 *
´of”
);

51 ~
Add»ssProf”
();

53 
	$´štSts
(
¡d
::
o¡»am
& 
out
) const;

54 
	`ş—rSts
();

56 
	`addT¿ûSam¶e
(
Addr
 
d©a_addr
, Add¸
pc_addr
,

57 
RubyReque¡Ty³
 
ty³
, 
RubyAcûssMode
 
acûss_mode
,

58 
NodeID
 
id
, 
boŞ
 
sh¬šg_miss
);

59 
	`´ofeR‘ry
(
Addr
 
d©a_addr
, 
AcûssTy³
 
ty³
, 
couÁ
);

60 
	`´ofeG‘X
(
Addr
 
d©ablock
, Add¸
PC
,

61 cÚ¡ 
S‘
& 
owÃr
, cÚ¡ S‘& 
sh¬”s
, 
NodeID
 
»que¡Ü
);

62 
	`´ofeG‘S
(
Addr
 
d©ablock
, Add¸
PC
,

63 cÚ¡ 
S‘
& 
owÃr
, cÚ¡ S‘& 
sh¬”s
, 
NodeID
 
»que¡Ü
);

65 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

68 
	`£tHÙLšes
(
boŞ
 
hÙ_lšes
);

69 
	`£tAÎIn¡ruùiÚs
(
boŞ
 
®l_š¡ruùiÚs
);

70 
	$»gSts
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {}

71 
	$cŞÏ‹Sts
(è{
	}
}

73 
´iv©e
:

75 
Add»ssProf”
(cÚ¡ Add»ssProf”& 
obj
);

76 
	gAdd»ssProf”
& 
	gİ”©Ü
=(cÚ¡ 
Add»ssProf”
& 
obj
);

78 
št64_t
 
	gm_sh¬šg_miss_couÁ”
;

80 
Add»ssM­
 
	gm_d©aAcûssT¿û
;

81 
Add»ssM­
 
	gm_maüoBlockAcûssT¿û
;

82 
Add»ssM­
 
	gm_´og¿mCouÁ”AcûssT¿û
;

83 
Add»ssM­
 
	gm_»ŒyProfeM­
;

84 
Hi¡og¿m
 
	gm_»ŒyProfeHi¡o
;

85 
Hi¡og¿m
 
	gm_»ŒyProfeHi¡oWr™e
;

86 
Hi¡og¿m
 
	gm_»ŒyProfeHi¡oR—d
;

87 
Hi¡og¿m
 
	gm_g‘x_sh¬šg_hi¡og¿m
;

88 
Hi¡og¿m
 
	gm_g‘s_sh¬šg_hi¡og¿m
;

90 
Prof”
 *
	gm_´of”
;

93 
boŞ
 
	gm_hÙ_lšes
;

94 
boŞ
 
	gm_®l_š¡ruùiÚs
;

96 
	gm_num_of_£qu’ûrs
;

99 
	gAcûssT¿ûFÜAdd»ss
& 
lookupT¿ûFÜAdd»ss
(
Addr
 
addr
,

100 
Add»ssProf”
::
Add»ssM­
&

101 
»cÜd_m­
);

103 
´štSÜ‹d
(
¡d
::
o¡»am
& 
out
, 
num_of_£qu’ûrs
,

104 cÚ¡ 
Add»ssProf”
::
Add»ssM­
 &
»cÜd_m­
,

105 
¡d
::
¡ršg
 
desütiÚ
, 
Prof”
 *
´of”
);

107 
šlše
 
	g¡d
::
o¡»am
&

108 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gAdd»ssProf”
& 
	gobj
)

110 
	gobj
.
´št
(
out
);

111 
	gout
 << 
	g¡d
::
æush
;

112  
	gout
;

	@ruby/profiler/MemCntrlProfiler.cc

29 
	~"mem/ruby/´of”/MemCÁ¾Prof”.hh
"

31 
usšg
 
Çme¥aû
 
	g¡d
;

33 
	gMemCÁ¾Prof”
::
	$MemCÁ¾Prof”
(cÚ¡ 
¡ršg
& 
desütiÚ
,

34 
bªks_³r_¿nk
, 
¿nks_³r_dimm
, 
dimms_³r_chªÃl
)

36 
m_desütiÚ
 = 
desütiÚ
;

37 
m_bªks_³r_¿nk
 = 
bªks_³r_¿nk
;

38 
m_¿nks_³r_dimm
 = 
¿nks_³r_dimm
;

39 
m_dimms_³r_chªÃl
 = 
dimms_³r_chªÃl
;

40 
	}
}

42 
	gMemCÁ¾Prof”
::~
	$MemCÁ¾Prof”
()

44 
	}
}

47 
MemCÁ¾Prof”
::
	$´ofeMemReq
(
bªk
)

49 
m_memReq
++;

50 
m_memBªkCouÁ
[
bªk
]++;

51 
	}
}

54 
	gMemCÁ¾Prof”
::
	$´ofeMemBªkBusy
()

56 
m_memBªkBusy
++;

57 
	}
}

60 
	gMemCÁ¾Prof”
::
	$´ofeMemBusBusy
()

62 
m_memBusBusy
++;

63 
	}
}

66 
	gMemCÁ¾Prof”
::
	$´ofeMemR—dWr™eBusy
()

68 
m_memR—dWr™eBusy
++;

69 
	}
}

72 
	gMemCÁ¾Prof”
::
	$´ofeMemD©aBusBusy
()

74 
m_memD©aBusBusy
++;

75 
	}
}

78 
	gMemCÁ¾Prof”
::
	$´ofeMemTçwBusy
()

80 
m_memTçwBusy
++;

81 
	}
}

84 
	gMemCÁ¾Prof”
::
	$´ofeMemReäesh
()

86 
m_memReäesh
++;

87 
	}
}

90 
	gMemCÁ¾Prof”
::
	$´ofeMemR—d
()

92 
m_memR—d
++;

93 
	}
}

96 
	gMemCÁ¾Prof”
::
	$´ofeMemWr™e
()

98 
m_memWr™e
++;

99 
	}
}

102 
	gMemCÁ¾Prof”
::
	$´ofeMemWa™Cyşes
(
cyşes
)

104 
m_memWa™Cyşes
 +ğ
cyşes
;

105 
	}
}

108 
	gMemCÁ¾Prof”
::
	$´ofeMemIÅutQ
(
cyşes
)

110 
m_memIÅutQ
 +ğ
cyşes
;

111 
	}
}

114 
	gMemCÁ¾Prof”
::
	$´ofeMemBªkQ
(
cyşes
)

116 
m_memBªkQ
 +ğ
cyşes
;

117 
	}
}

120 
	gMemCÁ¾Prof”
::
	$´ofeMemArbWa™
(
cyşes
)

122 
m_memArbWa™
 +ğ
cyşes
;

123 
	}
}

126 
	gMemCÁ¾Prof”
::
	$´ofeMemRªdBusy
()

128 
m_memRªdBusy
++;

129 
	}
}

132 
	gMemCÁ¾Prof”
::
	$´ofeMemNÙOld
()

134 
m_memNÙOld
++;

135 
	}
}

138 
	gMemCÁ¾Prof”
::
	$»gSts
()

140 
m_memReq


141 .
	`Çme
(
m_desütiÚ
 + ".memReq")

142 .
	`desc
("Total‚umber of memory„equests")

143 .
	`æags
(
Sts
::
noz”o
)

146 
m_memR—d


147 .
	`Çme
(
m_desütiÚ
 + ".memRead")

148 .
	`desc
("Number of memory„eads")

149 .
	`æags
(
Sts
::
noz”o
)

152 
m_memWr™e


153 .
	`Çme
(
m_desütiÚ
 + ".memWrite")

154 .
	`desc
("Number of memory writes")

155 .
	`æags
(
Sts
::
noz”o
)

158 
m_memReäesh


159 .
	`Çme
(
m_desütiÚ
 + ".memRefresh")

160 .
	`desc
("Number of memory„efreshes")

161 .
	`æags
(
Sts
::
noz”o
)

164 
m_memIÅutQ


165 .
	`Çme
(
m_desütiÚ
 + ".memInputQ")

166 .
	`desc
("Delay inhe input queue")

167 .
	`æags
(
Sts
::
noz”o
)

170 
m_memBªkQ


171 .
	`Çme
(
m_desütiÚ
 + ".memBankQ")

172 .
	`desc
("Delay behindhe head ofhe bank queue")

173 .
	`æags
(
Sts
::
noz”o
)

176 
m_memWa™Cyşes


177 .
	`Çme
(
m_desütiÚ
 + ".memWaitCycles")

178 .
	`desc
("Delay stalled‡the head ofhe bank queue")

179 .
	`æags
(
Sts
::
noz”o
)

182 
m_tÙ®SÎs


183 .
	`Çme
(
m_desütiÚ
 + ".totalStalls")

184 .
	`desc
("Total‚umber of stall cycles")

185 .
	`æags
(
Sts
::
noz”o
)

188 
m_tÙ®SÎs
 = 
m_memIÅutQ
 + 
m_memBªkQ
 + 
m_memWa™Cyşes
;

190 
m_¡®lsP”Req


191 .
	`Çme
(
m_desütiÚ
 + ".stallsPerReq")

192 .
	`desc
("Expected‚umber of stall cycles…er„equest")

193 .
	`æags
(
Sts
::
noz”o
)

196 
m_¡®lsP”Req
 = 
m_tÙ®SÎs
 / 
m_memReq
;

207 
m_memBªkBusy


208 .
	`Çme
(
m_desütiÚ
 + ".memBankBusy")

209 .
	`desc
("memory stalls dueo busy bank")

210 .
	`æags
(
Sts
::
noz”o
)

213 
m_memRªdBusy


214 .
	`Çme
(
m_desütiÚ
 + ".memRandBusy")

215 .
	`desc
("memory stalls dueo busy„andom")

216 .
	`æags
(
Sts
::
noz”o
)

219 
m_memNÙOld


220 .
	`Çme
(
m_desütiÚ
 + ".memNotOld")

221 .
	`desc
("memory stalls dueo‡nti starvation")

222 .
	`æags
(
Sts
::
noz”o
)

225 
m_memArbWa™


226 .
	`Çme
(
m_desütiÚ
 + ".memArbWait")

227 .
	`desc
("memory stalls dueo‡rbitration")

228 .
	`æags
(
Sts
::
noz”o
)

231 
m_memBusBusy


232 .
	`Çme
(
m_desütiÚ
 + ".memBusBusy")

233 .
	`desc
("memory stalls dueo busy bus")

234 .
	`æags
(
Sts
::
noz”o
)

237 
m_memTçwBusy


238 .
	`Çme
(
m_desütiÚ
 + ".memTfawBusy")

239 .
	`desc
("memory stalls for Tfaw")

240 .
	`æags
(
Sts
::
noz”o
)

243 
m_memR—dWr™eBusy


244 .
	`Çme
(
m_desütiÚ
 + ".memReadWriteBusy")

245 .
	`desc
("memory stalls dueo„ead writeurnaround")

246 .
	`æags
(
Sts
::
noz”o
)

249 
m_memD©aBusBusy


250 .
	`Çme
(
m_desütiÚ
 + ".memDataBusBusy")

251 .
	`desc
("memory stalls dueo„ead„eadurnaround")

252 .
	`æags
(
Sts
::
noz”o
)

255 
tÙ®Bªks
 = 
m_bªks_³r_¿nk
 * 
m_¿nks_³r_dimm
 * 
m_dimms_³r_chªÃl
;

256 
m_memBªkCouÁ


257 .
	`š™
(
tÙ®Bªks
)

258 .
	`Çme
(
m_desütiÚ
 + ".memBankCount")

259 .
	`desc
("Number of‡ccesses…er bank")

260 .
	`æags
(
Sts
::
pdf
 | Sts::
tÙ®
|Sts::
Ú–še
)

262 
i
 = 0; i < 
tÙ®Bªks
; i++) {

263 
m_memBªkCouÁ
.
	`subÇme
(
i
, "");

265 
	}
}

	@ruby/profiler/MemCntrlProfiler.hh

29 #iâdeà
__MEM_RUBY_PROFILER_MEMCNTRLPROFILER_HH__


30 
	#__MEM_RUBY_PROFILER_MEMCNTRLPROFILER_HH__


	)

32 
	~<io¡»am
>

33 
	~<¡ršg
>

34 
	~<veùÜ
>

36 
	~"ba£/¡©i¡ics.hh
"

37 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

39 şas 
	cMemCÁ¾Prof”


41 
	mpublic
:

42 
MemCÁ¾Prof”
(cÚ¡ 
¡d
::
¡ršg
& 
desütiÚ
, 
bªks_³r_¿nk
,

43 
¿nks_³r_dimm
, 
dimms_³r_chªÃl
);

44 ~
MemCÁ¾Prof”
();

46 
»gSts
();

48 
´ofeMemReq
(
bªk
);

49 
´ofeMemBªkBusy
();

50 
´ofeMemBusBusy
();

51 
´ofeMemTçwBusy
();

52 
´ofeMemR—dWr™eBusy
();

53 
´ofeMemD©aBusBusy
();

54 
´ofeMemReäesh
();

55 
´ofeMemR—d
();

56 
´ofeMemWr™e
();

57 
´ofeMemWa™Cyşes
(
cyşes
);

58 
´ofeMemIÅutQ
(
cyşes
);

59 
´ofeMemBªkQ
(
cyşes
);

60 
´ofeMemArbWa™
(
cyşes
);

61 
´ofeMemRªdBusy
();

62 
´ofeMemNÙOld
();

64 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

66 
´iv©e
:

68 
	`MemCÁ¾Prof”
(cÚ¡ 
MemCÁ¾Prof”
& 
obj
);

69 
MemCÁ¾Prof”
& 
İ”©Ü
=(cÚ¡ MemCÁ¾Prof”& 
obj
);

71 
¡d
::
¡ršg
 
m_desütiÚ
;

72 
Sts
::
SÿÏr
 
m_memReq
;

73 
Sts
::
SÿÏr
 
m_memR—d
;

74 
Sts
::
SÿÏr
 
m_memWr™e
;

75 
Sts
::
SÿÏr
 
m_memReäesh
;

77 
Sts
::
SÿÏr
 
m_memWa™Cyşes
;

78 
Sts
::
SÿÏr
 
m_memIÅutQ
;

79 
Sts
::
SÿÏr
 
m_memBªkQ
;

80 
Sts
::
FÜmuÏ
 
m_tÙ®SÎs
;

81 
Sts
::
FÜmuÏ
 
m_¡®lsP”Req
;

83 
Sts
::
SÿÏr
 
m_memBªkBusy
;

84 
Sts
::
SÿÏr
 
m_memBusBusy
;

85 
Sts
::
SÿÏr
 
m_memTçwBusy
;

86 
Sts
::
SÿÏr
 
m_memR—dWr™eBusy
;

87 
Sts
::
SÿÏr
 
m_memD©aBusBusy
;

88 
Sts
::
SÿÏr
 
m_memArbWa™
;

89 
Sts
::
SÿÏr
 
m_memRªdBusy
;

90 
Sts
::
SÿÏr
 
m_memNÙOld
;

91 
Sts
::
VeùÜ
 
m_memBªkCouÁ
;

93 
m_bªks_³r_¿nk
;

94 
m_¿nks_³r_dimm
;

95 
m_dimms_³r_chªÃl
;

98 
šlše
 
¡d
::
o¡»am
&

99 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
MemCÁ¾Prof”
& 
obj
)

101 
obj
.
	`´št
(
out
);

102 
out
 << 
¡d
::
æush
;

103  
out
;

104 
	}
}

	@ruby/profiler/Profiler.cc

45 
	~"mem/ruby/´of”/Prof”.hh
"

47 
	~<sys/ty³s.h
>

48 
	~<uni¡d.h
>

50 
	~<®gÜ™hm
>

51 
	~<f¡»am
>

53 
	~"ba£/¡l_h–³rs.hh
"

54 
	~"ba£/¡r.hh
"

55 
	~"mem/´ÙocŞ/MachšeTy³.hh
"

56 
	~"mem/´ÙocŞ/RubyReque¡.hh
"

57 
	~"mem/ruby/ÃtwÜk/N‘wÜk.hh
"

58 
	~"mem/ruby/´of”/Add»ssProf”.hh
"

59 
	~"mem/ruby/sy¡em/GPUCßËsûr.hh
"

60 
	~"mem/ruby/sy¡em/Sequ’ûr.hh
"

62 
usšg
 
Çme¥aû
 
	g¡d
;

63 
usšg
 
	gm5
::
¡l_h–³rs
::
İ”©Ü
<<;

65 
	gProf”
::
	$Prof”
(cÚ¡ 
RubySy¡emP¬ams
 *
p
, 
RubySy¡em
 *
rs
)

66 : 
	`m_ruby_sy¡em
(
rs
), 
	`m_hÙ_lšes
(
p
->
hÙ_lšes
),

67 
	`m_®l_š¡ruùiÚs
(
p
->
®l_š¡ruùiÚs
),

68 
	`m_num_vÃts
(
p
->
numb”_of_vœtu®_ÃtwÜks
)

70 
m_add»ss_´of”_±r
 = 
Ãw
 
	`Add»ssProf”
(
p
->
num_of_£qu’ûrs
, 
this
);

71 
m_add»ss_´of”_±r
->
	`£tHÙLšes
(
m_hÙ_lšes
);

72 
m_add»ss_´of”_±r
->
	`£tAÎIn¡ruùiÚs
(
m_®l_š¡ruùiÚs
);

74 ià(
m_®l_š¡ruùiÚs
) {

75 
m_š¡_´of”_±r
 = 
Ãw
 
	`Add»ssProf”
(
p
->
num_of_£qu’ûrs
, 
this
);

76 
m_š¡_´of”_±r
->
	`£tHÙLšes
(
m_hÙ_lšes
);

77 
m_š¡_´of”_±r
->
	`£tAÎIn¡ruùiÚs
(
m_®l_š¡ruùiÚs
);

79 
	}
}

81 
	gProf”
::~
	$Prof”
()

83 
	}
}

86 
Prof”
::
	$»gSts
(cÚ¡ 
¡d
::
¡ršg
 &
pName
)

88 ià(!
m_®l_š¡ruùiÚs
) {

89 
m_add»ss_´of”_±r
->
	`»gSts
(
pName
);

92 ià(
m_®l_š¡ruùiÚs
) {

93 
m_š¡_´of”_±r
->
	`»gSts
(
pName
);

96 
d–ayHi¡og¿m


97 .
	`š™
(10)

98 .
	`Çme
(
pName
 + ".delayHist")

99 .
	`desc
("delay histogram for‡ll message")

100 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

102 
i
 = 0; i < 
m_num_vÃts
; i++) {

103 
d–ayVCHi¡og¿m
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

104 
d–ayVCHi¡og¿m
[
i
]

105 ->
	`š™
(10)

106 .
	`Çme
(
pName
 + 
	`c¥rštf
(".d–ayVCHi¡.vÃt_%i", 
i
))

107 .
	`desc
(
	`c¥rštf
("d–ay hi¡og¿m fÜ vÃt_%i", 
i
))

108 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

111 
m_out¡ªdReqHi¡Seqr


112 .
	`š™
(10)

113 .
	`Çme
(
pName
 + ".outstanding_req_hist_seqr")

114 .
	`desc
("")

115 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

117 
m_out¡ªdReqHi¡Cßl¤


118 .
	`š™
(10)

119 .
	`Çme
(
pName
 + ".outstanding_req_hist_coalsr")

120 .
	`desc
("")

121 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

123 
m_Ï‹ncyHi¡Seqr


124 .
	`š™
(10)

125 .
	`Çme
(
pName
 + ".latency_hist_seqr")

126 .
	`desc
("")

127 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

129 
m_Ï‹ncyHi¡Cßl¤


130 .
	`š™
(10)

131 .
	`Çme
(
pName
 + ".latency_hist_coalsr")

132 .
	`desc
("")

133 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

135 
m_h™L©’cyHi¡Seqr


136 .
	`š™
(10)

137 .
	`Çme
(
pName
 + ".hit_latency_hist_seqr")

138 .
	`desc
("")

139 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

141 
m_missL©’cyHi¡Seqr


142 .
	`š™
(10)

143 .
	`Çme
(
pName
 + ".miss_latency_hist_seqr")

144 .
	`desc
("")

145 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

147 
m_missL©’cyHi¡Cßl¤


148 .
	`š™
(10)

149 .
	`Çme
(
pName
 + ".miss_latency_hist_coalsr")

150 .
	`desc
("")

151 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

153 
i
 = 0; i < 
RubyReque¡Ty³_NUM
; i++) {

154 
m_ty³L©’cyHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

155 
m_ty³L©’cyHi¡Seqr
[
i
]

156 ->
	`š™
(10)

157 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.latency_hist_seqr",

158 
	`RubyReque¡Ty³
(
i
)))

159 .
	`desc
("")

160 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

162 
m_ty³L©’cyHi¡Cßl¤
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

163 
m_ty³L©’cyHi¡Cßl¤
[
i
]

164 ->
	`š™
(10)

165 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.latency_hist_coalsr",

166 
	`RubyReque¡Ty³
(
i
)))

167 .
	`desc
("")

168 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

170 
m_h™Ty³L©’cyHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

171 
m_h™Ty³L©’cyHi¡Seqr
[
i
]

172 ->
	`š™
(10)

173 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.hit_latency_hist_seqr",

174 
	`RubyReque¡Ty³
(
i
)))

175 .
	`desc
("")

176 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

178 
m_missTy³L©’cyHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

179 
m_missTy³L©’cyHi¡Seqr
[
i
]

180 ->
	`š™
(10)

181 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.miss_latency_hist_seqr",

182 
	`RubyReque¡Ty³
(
i
)))

183 .
	`desc
("")

184 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

186 
m_missTy³L©’cyHi¡Cßl¤
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

187 
m_missTy³L©’cyHi¡Cßl¤
[
i
]

188 ->
	`š™
(10)

189 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.miss_latency_hist_coalsr",

190 
	`RubyReque¡Ty³
(
i
)))

191 .
	`desc
("")

192 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

195 
i
 = 0; i < 
MachšeTy³_NUM
; i++) {

196 
m_h™MachL©’cyHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

197 
m_h™MachL©’cyHi¡Seqr
[
i
]

198 ->
	`š™
(10)

199 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.hit_mach_latency_hist_seqr",

200 
	`MachšeTy³
(
i
)))

201 .
	`desc
("")

202 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

204 
m_missMachL©’cyHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

205 
m_missMachL©’cyHi¡Seqr
[
i
]

206 ->
	`š™
(10)

207 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.miss_mach_latency_hist_seqr",

208 
	`MachšeTy³
(
i
)))

209 .
	`desc
("")

210 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

212 
m_missMachL©’cyHi¡Cßl¤
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

213 
m_missMachL©’cyHi¡Cßl¤
[
i
]

214 ->
	`š™
(10)

215 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.miss_mach_latency_hist_coalsr",

216 
	`MachšeTy³
(
i
)))

217 .
	`desc
("")

218 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

220 
m_IssueToIn™ŸlD–ayHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

221 
m_IssueToIn™ŸlD–ayHi¡Seqr
[
i
]

222 ->
	`š™
(10)

223 .
	`Çme
(
pName
 + 
	`c¥rštf
(

225 
	`MachšeTy³
(
i
)))

226 .
	`desc
("")

227 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

229 
m_IssueToIn™ŸlD–ayHi¡Cßl¤
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

230 
m_IssueToIn™ŸlD–ayHi¡Cßl¤
[
i
]

231 ->
	`š™
(10)

232 .
	`Çme
(
pName
 + 
	`c¥rštf
(

234 
	`MachšeTy³
(
i
)))

235 .
	`desc
("")

236 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

238 
m_In™ŸlToFÜw¬dD–ayHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

239 
m_In™ŸlToFÜw¬dD–ayHi¡Seqr
[
i
]

240 ->
	`š™
(10)

241 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.miss_latency_hist_seqr.initial_to_forward",

242 
	`MachšeTy³
(
i
)))

243 .
	`desc
("")

244 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

246 
m_In™ŸlToFÜw¬dD–ayHi¡Cßl¤
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

247 
m_In™ŸlToFÜw¬dD–ayHi¡Cßl¤
[
i
]

248 ->
	`š™
(10)

249 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.miss_latency_hist_coalsr.initial_to_forward",

250 
	`MachšeTy³
(
i
)))

251 .
	`desc
("")

252 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

254 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

255 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡Seqr
[
i
]

256 ->
	`š™
(10)

257 .
	`Çme
(
pName
 + 
	`c¥rštf
(

259 
	`MachšeTy³
(
i
)))

260 .
	`desc
("")

261 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

263 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡Cßl¤
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

264 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡Cßl¤
[
i
]

265 ->
	`š™
(10)

266 .
	`Çme
(
pName
 + 
	`c¥rštf
(

268 
	`MachšeTy³
(
i
)))

269 .
	`desc
("")

270 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

272 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡Seqr
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

273 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡Seqr
[
i
]

274 ->
	`š™
(10)

275 .
	`Çme
(
pName
 + 
	`c¥rštf
(

277 
	`MachšeTy³
(
i
)))

278 .
	`desc
("")

279 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

281 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡Cßl¤
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

282 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡Cßl¤
[
i
]

283 ->
	`š™
(10)

284 .
	`Çme
(
pName
 + 
	`c¥rštf
(

286 
	`MachšeTy³
(
i
)))

287 .
	`desc
("")

288 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

290 
m_Incom¶‘eTimesSeqr
[
i
]

291 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.šcom¶‘e_times_£qr", 
	`MachšeTy³
(
i
)))

292 .
	`desc
("")

293 .
	`æags
(
Sts
::
noz”o
);

296 
i
 = 0; i < 
RubyReque¡Ty³_NUM
; i++) {

297 
m_h™Ty³MachL©’cyHi¡Seqr
.
	`push_back
(
¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *>());

298 
m_missTy³MachL©’cyHi¡Seqr
.
	`push_back
(
¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *>());

299 
m_missTy³MachL©’cyHi¡Cßl¤
.
	`push_back
(
¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *>());

301 
j
 = 0; j < 
MachšeTy³_NUM
; j++) {

302 
m_h™Ty³MachL©’cyHi¡Seqr
[
i
].
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

303 
m_h™Ty³MachL©’cyHi¡Seqr
[
i
][
j
]

304 ->
	`š™
(10)

305 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.%s.hit_type_mach_latency_hist_seqr",

306 
	`RubyReque¡Ty³
(
i
), 
	`MachšeTy³
(
j
)))

307 .
	`desc
("")

308 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

310 
m_missTy³MachL©’cyHi¡Seqr
[
i
].
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

311 
m_missTy³MachL©’cyHi¡Seqr
[
i
][
j
]

312 ->
	`š™
(10)

313 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.%s.miss_type_mach_latency_hist_seqr",

314 
	`RubyReque¡Ty³
(
i
), 
	`MachšeTy³
(
j
)))

315 .
	`desc
("")

316 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

318 
m_missTy³MachL©’cyHi¡Cßl¤
[
i
].
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

319 
m_missTy³MachL©’cyHi¡Cßl¤
[
i
][
j
]

320 ->
	`š™
(10)

321 .
	`Çme
(
pName
 + 
	`c¥rštf
(".%s.%s.miss_type_mach_latency_hist_coalsr",

322 
	`RubyReque¡Ty³
(
i
), 
	`MachšeTy³
(
j
)))

323 .
	`desc
("")

324 .
	`æags
(
Sts
::
noz”o
 | Sts::
pdf
 | Sts::
Ú–še
);

327 
	}
}

330 
	gProf”
::
	$cŞÏ‹Sts
()

332 ià(!
m_®l_š¡ruùiÚs
) {

333 
m_add»ss_´of”_±r
->
	`cŞÏ‹Sts
();

336 ià(
m_®l_š¡ruùiÚs
) {

337 
m_š¡_´of”_±r
->
	`cŞÏ‹Sts
();

340 
ušt32_t
 
i
 = 0; i < 
MachšeTy³_NUM
; i++) {

341 
m­
<
ušt32_t
, 
Ab¡¿ùCÚŒŞËr
*>::
™”©Ü
 
™
 =

342 
m_ruby_sy¡em
->
m_ab¡¿ù_cÚŒŞs
[
i
].
	`begš
();

343 
™
 !ğ
m_ruby_sy¡em
->
m_ab¡¿ù_cÚŒŞs
[
i
].
	`’d
(); ++it) {

345 
Ab¡¿ùCÚŒŞËr
 *
ùr
 = (*
™
).
£cÚd
;

346 
d–ayHi¡og¿m
.
	`add
(
ùr
->
	`g‘D–ayHi¡
());

348 
ušt32_t
 
i
 = 0; i < 
m_num_vÃts
; i++) {

349 
d–ayVCHi¡og¿m
[
i
]->
	`add
(
ùr
->
	`g‘D–ayVCHi¡
(i));

354 
ušt32_t
 
i
 = 0; i < 
MachšeTy³_NUM
; i++) {

355 
m­
<
ušt32_t
, 
Ab¡¿ùCÚŒŞËr
*>::
™”©Ü
 
™
 =

356 
m_ruby_sy¡em
->
m_ab¡¿ù_cÚŒŞs
[
i
].
	`begš
();

357 
™
 !ğ
m_ruby_sy¡em
->
m_ab¡¿ù_cÚŒŞs
[
i
].
	`’d
(); ++it) {

359 
Ab¡¿ùCÚŒŞËr
 *
ùr
 = (*
™
).
£cÚd
;

360 
Sequ’ûr
 *
£q
 = 
ùr
->
	`g‘CPUSequ’ûr
();

361 ià(
£q
 !ğ
NULL
) {

362 
m_out¡ªdReqHi¡Seqr
.
	`add
(
£q
->
	`g‘Out¡ªdReqHi¡
());

364 
GPUCßËsûr
 *
cßl
 = 
ùr
->
	`g‘GPUCßËsûr
();

365 ià(
cßl
 !ğ
NULL
) {

366 
m_out¡ªdReqHi¡Cßl¤
.
	`add
(
cßl
->
	`g‘Out¡ªdReqHi¡
());

371 
ušt32_t
 
i
 = 0; i < 
MachšeTy³_NUM
; i++) {

372 
m­
<
ušt32_t
, 
Ab¡¿ùCÚŒŞËr
*>::
™”©Ü
 
™
 =

373 
m_ruby_sy¡em
->
m_ab¡¿ù_cÚŒŞs
[
i
].
	`begš
();

374 
™
 !ğ
m_ruby_sy¡em
->
m_ab¡¿ù_cÚŒŞs
[
i
].
	`’d
(); ++it) {

376 
Ab¡¿ùCÚŒŞËr
 *
ùr
 = (*
™
).
£cÚd
;

377 
Sequ’ûr
 *
£q
 = 
ùr
->
	`g‘CPUSequ’ûr
();

378 ià(
£q
 !ğ
NULL
) {

380 
m_Ï‹ncyHi¡Seqr
.
	`add
(
£q
->
	`g‘L©’cyHi¡
());

381 
m_h™L©’cyHi¡Seqr
.
	`add
(
£q
->
	`g‘H™L©’cyHi¡
());

382 
m_missL©’cyHi¡Seqr
.
	`add
(
£q
->
	`g‘MissL©’cyHi¡
());

385 
ušt32_t
 
j
 = 0; j < 
RubyReque¡Ty³_NUM
; ++j) {

386 
m_ty³L©’cyHi¡Seqr
[
j
]

387 ->
	`add
(
£q
->
	`g‘Ty³L©’cyHi¡
(
j
));

388 
m_h™Ty³L©’cyHi¡Seqr
[
j
]

389 ->
	`add
(
£q
->
	`g‘H™Ty³L©’cyHi¡
(
j
));

390 
m_missTy³L©’cyHi¡Seqr
[
j
]

391 ->
	`add
(
£q
->
	`g‘MissTy³L©’cyHi¡
(
j
));

395 
ušt32_t
 
j
 = 0; j < 
MachšeTy³_NUM
; ++j) {

396 
m_h™MachL©’cyHi¡Seqr
[
j
]

397 ->
	`add
(
£q
->
	`g‘H™MachL©’cyHi¡
(
j
));

398 
m_missMachL©’cyHi¡Seqr
[
j
]

399 ->
	`add
(
£q
->
	`g‘MissMachL©’cyHi¡
(
j
));

401 
m_IssueToIn™ŸlD–ayHi¡Seqr
[
j
]->
	`add
(

402 
£q
->
	`g‘IssueToIn™ŸlD–ayHi¡
(
	`MachšeTy³
(
j
)));

404 
m_In™ŸlToFÜw¬dD–ayHi¡Seqr
[
j
]->
	`add
(

405 
£q
->
	`g‘In™ŸlToFÜw¬dD–ayHi¡
(
	`MachšeTy³
(
j
)));

406 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡Seqr
[
j
]->
	`add
(
£q
->

407 
	`g‘FÜw¬dReque¡ToFœ¡Re¥Ú£Hi¡
(
	`MachšeTy³
(
j
)));

409 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡Seqr
[
j
]->
	`add
(
£q
->

410 
	`g‘Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
(

411 
	`MachšeTy³
(
j
)));

412 
m_Incom¶‘eTimesSeqr
[
j
] +=

413 
£q
->
	`g‘Incom¶‘eTimes
(
	`MachšeTy³
(
j
));

417 
ušt32_t
 
j
 = 0; j < 
RubyReque¡Ty³_NUM
; j++) {

418 
ušt32_t
 
k
 = 0; k < 
MachšeTy³_NUM
; k++) {

419 
m_h™Ty³MachL©’cyHi¡Seqr
[
j
][
k
]->
	`add
(

420 
£q
->
	`g‘H™Ty³MachL©’cyHi¡
(
j
,
k
));

421 
m_missTy³MachL©’cyHi¡Seqr
[
j
][
k
]->
	`add
(

422 
£q
->
	`g‘MissTy³MachL©’cyHi¡
(
j
,
k
));

427 
GPUCßËsûr
 *
cßl
 = 
ùr
->
	`g‘GPUCßËsûr
();

428 ià(
cßl
 !ğ
NULL
) {

430 
m_Ï‹ncyHi¡Cßl¤
.
	`add
(
cßl
->
	`g‘L©’cyHi¡
());

431 
m_missL©’cyHi¡Cßl¤
.
	`add
(
cßl
->
	`g‘MissL©’cyHi¡
());

434 
ušt32_t
 
j
 = 0; j < 
RubyReque¡Ty³_NUM
; ++j) {

435 
m_ty³L©’cyHi¡Cßl¤
[
j
]

436 ->
	`add
(
cßl
->
	`g‘Ty³L©’cyHi¡
(
j
));

437 
m_missTy³L©’cyHi¡Cßl¤
[
j
]

438 ->
	`add
(
cßl
->
	`g‘MissTy³L©’cyHi¡
(
j
));

442 
ušt32_t
 
j
 = 0; j < 
MachšeTy³_NUM
; ++j) {

443 
m_missMachL©’cyHi¡Cßl¤
[
j
]

444 ->
	`add
(
cßl
->
	`g‘MissMachL©’cyHi¡
(
j
));

446 
m_IssueToIn™ŸlD–ayHi¡Cßl¤
[
j
]->
	`add
(

447 
cßl
->
	`g‘IssueToIn™ŸlD–ayHi¡
(
	`MachšeTy³
(
j
)));

449 
m_In™ŸlToFÜw¬dD–ayHi¡Cßl¤
[
j
]->
	`add
(

450 
cßl
->
	`g‘In™ŸlToFÜw¬dD–ayHi¡
(
	`MachšeTy³
(
j
)));

451 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡Cßl¤
[
j
]->
	`add
(
cßl
->

452 
	`g‘FÜw¬dReque¡ToFœ¡Re¥Ú£Hi¡
(
	`MachšeTy³
(
j
)));

454 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡Cßl¤
[
j
]->
	`add
(
cßl
->

455 
	`g‘Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
(

456 
	`MachšeTy³
(
j
)));

460 
ušt32_t
 
j
 = 0; j < 
RubyReque¡Ty³_NUM
; j++) {

461 
ušt32_t
 
k
 = 0; k < 
MachšeTy³_NUM
; k++) {

462 
m_missTy³MachL©’cyHi¡Cßl¤
[
j
][
k
]->
	`add
(

463 
cßl
->
	`g‘MissTy³MachL©’cyHi¡
(
j
,
k
));

469 
	}
}

472 
	gProf”
::
	$addAdd»ssT¿ûSam¶e
(cÚ¡ 
RubyReque¡
& 
msg
, 
NodeID
 
id
)

474 ià(
msg
.
	`g‘Ty³
(è!ğ
RubyReque¡Ty³_IFETCH
) {

481 
m_add»ss_´of”_±r
->

482 
	`addT¿ûSam¶e
(
msg
.
	`g‘LšeAdd»ss
(), msg.
	`g‘Prog¿mCouÁ”
(),

483 
msg
.
	`g‘Ty³
(), msg.
	`g‘AcûssMode
(), 
id
, 
çl£
);

485 
	}
}

	@ruby/profiler/Profiler.hh

45 #iâdeà
__MEM_RUBY_PROFILER_PROFILER_HH__


46 
	#__MEM_RUBY_PROFILER_PROFILER_HH__


	)

48 
	~<m­
>

49 
	~<¡ršg
>

50 
	~<veùÜ
>

52 
	~"ba£/ÿÎback.hh
"

53 
	~"ba£/¡©i¡ics.hh
"

54 
	~"mem/´ÙocŞ/AcûssTy³.hh
"

55 
	~"mem/´ÙocŞ/P»ãtchB™.hh
"

56 
	~"mem/´ÙocŞ/RubyAcûssMode.hh
"

57 
	~"mem/´ÙocŞ/RubyReque¡Ty³.hh
"

58 
	~"mem/ruby/commÚ/MachšeID.hh
"

59 
	~"·¿ms/RubySy¡em.hh
"

61 
şass
 
	gRubyReque¡
;

62 
şass
 
	gAdd»ssProf”
;

64 şas 
	cProf”


66 
	mpublic
:

67 
Prof”
(cÚ¡ 
RubySy¡emP¬ams
 *
·¿ms
, 
RubySy¡em
 *
rs
);

68 ~
Prof”
();

70 
RubySy¡em
 *
	mm_ruby_sy¡em
;

72 
wakeup
();

73 
»gSts
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
);

74 
cŞÏ‹Sts
();

76 
Add»ssProf”
* 
	$g‘Add»ssProf”
(è{  
m_add»ss_´of”_±r
; }

77 
Add»ssProf”
* 
	$g‘In¡ruùiÚProf”
(è{  
m_š¡_´of”_±r
; 
	}
}

79 
addAdd»ssT¿ûSam¶e
(cÚ¡ 
RubyReque¡
& 
msg
, 
NodeID
 
id
);

82 
boŞ
 
	$g‘HÙLšes
(ècÚ¡ {  
m_hÙ_lšes
; 
	}
}

83 
boŞ
 
	$g‘AÎIn¡ruùiÚs
(ècÚ¡ {  
m_®l_š¡ruùiÚs
; 
	}
}

85 
	g´iv©e
:

87 
Prof”
(cÚ¡ Prof”& 
obj
);

88 
	gProf”
& 
	gİ”©Ü
=(cÚ¡ 
Prof”
& 
obj
);

90 
Add»ssProf”
* 
	gm_add»ss_´of”_±r
;

91 
Add»ssProf”
* 
	gm_š¡_´of”_±r
;

93 
	gSts
::
Hi¡og¿m
 
d–ayHi¡og¿m
;

94 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
d–ayVCHi¡og¿m
;

97 
	gSts
::
Hi¡og¿m
 
m_out¡ªdReqHi¡Seqr
;

98 
	gSts
::
Hi¡og¿m
 
m_out¡ªdReqHi¡Cßl¤
;

101 
	gSts
::
Hi¡og¿m
 
m_Ï‹ncyHi¡Seqr
;

102 
	gSts
::
Hi¡og¿m
 
m_Ï‹ncyHi¡Cßl¤
;

103 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_ty³L©’cyHi¡Seqr
;

104 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_ty³L©’cyHi¡Cßl¤
;

108 
	gSts
::
Hi¡og¿m
 
m_h™L©’cyHi¡Seqr
;

109 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_h™Ty³L©’cyHi¡Seqr
;

113 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_h™MachL©’cyHi¡Seqr
;

114 
	g¡d
::
veùÜ
< 
¡d
::veùÜ<
Sts
::
Hi¡og¿m
 *> > 
m_h™Ty³MachL©’cyHi¡Seqr
;

118 
	gSts
::
Hi¡og¿m
 
m_missL©’cyHi¡Seqr
;

119 
	gSts
::
Hi¡og¿m
 
m_missL©’cyHi¡Cßl¤
;

120 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_missTy³L©’cyHi¡Seqr
;

121 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_missTy³L©’cyHi¡Cßl¤
;

125 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_missMachL©’cyHi¡Seqr
;

126 
	g¡d
::
veùÜ
< 
¡d
::veùÜ<
Sts
::
Hi¡og¿m
 *> > 
m_missTy³MachL©’cyHi¡Seqr
;

127 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_missMachL©’cyHi¡Cßl¤
;

128 
	g¡d
::
veùÜ
< 
¡d
::veùÜ<
Sts
::
Hi¡og¿m
 *> > 
m_missTy³MachL©’cyHi¡Cßl¤
;

131 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_IssueToIn™ŸlD–ayHi¡Seqr
;

132 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_In™ŸlToFÜw¬dD–ayHi¡Seqr
;

133 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡Seqr
;

134 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡Seqr
;

135 
	gSts
::
SÿÏr
 
m_Incom¶‘eTimesSeqr
[
MachšeTy³_NUM
];

136 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_IssueToIn™ŸlD–ayHi¡Cßl¤
;

137 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_In™ŸlToFÜw¬dD–ayHi¡Cßl¤
;

138 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡Cßl¤
;

139 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡Cßl¤
;

142 cÚ¡ 
boŞ
 
	gm_hÙ_lšes
;

143 cÚ¡ 
boŞ
 
	gm_®l_š¡ruùiÚs
;

144 cÚ¡ 
ušt32_t
 
	gm_num_vÃts
;

	@ruby/profiler/StoreTrace.cc

29 
	~"mem/ruby/´of”/StÜeT¿û.hh
"

30 
	~"sim/cÜe.hh
"

32 
usšg
 
Çme¥aû
 
	g¡d
;

34 
boŞ
 
	gStÜeT¿û
::
s_š™
 = 
çl£
;

36 
št64_t
 
	gStÜeT¿û
::
s_tÙ®_§m¶es
 = 0;

38 
Hi¡og¿m
* 
	gStÜeT¿û
::
s_¡Üe_couÁ_±r
 = 
NULL
;

39 
Hi¡og¿m
* 
	gStÜeT¿û
::
s_¡Üe_fœ¡_to_¡Ş’_±r
 = 
NULL
;

40 
Hi¡og¿m
* 
	gStÜeT¿û
::
s_¡Üe_Ï¡_to_¡Ş’_±r
 = 
NULL
;

41 
Hi¡og¿m
* 
	gStÜeT¿û
::
s_¡Üe_fœ¡_to_Ï¡_±r
 = 
NULL
;

43 
	gStÜeT¿û
::
	$StÜeT¿û
(
Addr
 
addr
)

44 : 
	`m_¡Üe_couÁ
(-1), 
	`m_¡Üe_fœ¡_to_¡Ş’
(-1),

45 
	`m_¡Üe_Ï¡_to_¡Ş’
(-1), 
	`m_¡Üe_fœ¡_to_Ï¡
(-1)

47 
StÜeT¿û
::
	`š™Summ¬y
();

48 
m_addr
 = 
addr
;

49 
m_tÙ®_§m¶es
 = 0;

52 
m_Ï¡_wr™”
 = -1;

53 
m_¡Ües_this_š‹rv®
 = 0;

54 
	}
}

56 
	gStÜeT¿û
::~
	$StÜeT¿û
()

58 
	}
}

61 
StÜeT¿û
::
	$´št
(
o¡»am
& 
out
) const

63 
out
 << 
m_addr


64 << "Ù®_§m¶es: " << 
m_tÙ®_§m¶es
 << 
’dl


65 << "¡Üe_couÁ: " << 
m_¡Üe_couÁ
 << 
’dl


66 << "¡Üe_fœ¡_to_¡Ş’: " << 
m_¡Üe_fœ¡_to_¡Ş’
 << 
’dl


67 << "¡Üe_Ï¡_to_¡Ş’: " << 
m_¡Üe_Ï¡_to_¡Ş’
 << 
’dl


68 << "¡Üe_fœ¡_to_Ï¡: " << 
m_¡Üe_fœ¡_to_Ï¡
 << 
’dl
;

69 
	}
}

72 
	gStÜeT¿û
::
	$š™Summ¬y
()

74 ià(!
s_š™
) {

75 
s_tÙ®_§m¶es
 = 0;

76 
s_¡Üe_couÁ_±r
 = 
Ãw
 
	`Hi¡og¿m
(-1);

77 
s_¡Üe_fœ¡_to_¡Ş’_±r
 = 
Ãw
 
	`Hi¡og¿m
(-1);

78 
s_¡Üe_Ï¡_to_¡Ş’_±r
 = 
Ãw
 
	`Hi¡og¿m
(-1);

79 
s_¡Üe_fœ¡_to_Ï¡_±r
 = 
Ãw
 
	`Hi¡og¿m
(-1);

81 
s_š™
 = 
Œue
;

82 
	}
}

85 
	gStÜeT¿û
::
	$´štSumm¬y
(
o¡»am
& 
out
)

87 
out
 << "tÙ®_§m¶es: " << 
s_tÙ®_§m¶es
 << 
’dl
;

88 
out
 << "¡Üe_couÁ: " << (*
s_¡Üe_couÁ_±r
è<< 
’dl
;

89 
out
 << "¡Üe_fœ¡_to_¡Ş’: " << (*
s_¡Üe_fœ¡_to_¡Ş’_±r
è<< 
’dl
;

90 
out
 << "¡Üe_Ï¡_to_¡Ş’: " << (*
s_¡Üe_Ï¡_to_¡Ş’_±r
è<< 
’dl
;

91 
out
 << "¡Üe_fœ¡_to_Ï¡: " << (*
s_¡Üe_fœ¡_to_Ï¡_±r
è<< 
’dl
;

92 
	}
}

95 
	gStÜeT¿û
::
	$ş—rSumm¬y
()

97 
StÜeT¿û
::
	`š™Summ¬y
();

98 
s_tÙ®_§m¶es
 = 0;

99 
s_¡Üe_couÁ_±r
->
	`ş—r
();

100 
s_¡Üe_fœ¡_to_¡Ş’_±r
->
	`ş—r
();

101 
s_¡Üe_Ï¡_to_¡Ş’_±r
->
	`ş—r
();

102 
s_¡Üe_fœ¡_to_Ï¡_±r
->
	`ş—r
();

103 
	}
}

106 
	gStÜeT¿û
::
	$¡Üe
(
NodeID
 
node
)

108 
Tick
 
cu¼’t
 = 
	`curTick
();

110 
	`as£¹
((
m_Ï¡_wr™”
 =ğ-1è|| (m_Ï¡_wr™” =ğ
node
));

112 
m_Ï¡_wr™”
 = 
node
;

113 ià(
m_Ï¡_wr™”
 == -1) {

114 
	`as£¹
(
m_¡Ües_this_š‹rv®
 == 0);

117 ià(
m_¡Ües_this_š‹rv®
 == 0) {

119 
m_fœ¡_¡Üe
 = 
cu¼’t
;

122 
m_Ï¡_¡Üe
 = 
cu¼’t
;

123 
m_¡Ües_this_š‹rv®
++;

124 
	}
}

127 
	gStÜeT¿û
::
	$downg¿de
(
NodeID
 
node
)

129 ià(
node
 =ğ
m_Ï¡_wr™”
) {

130 
Tick
 
cu¼’t
 = 
	`curTick
();

131 
	`as£¹
(
m_¡Ües_this_š‹rv®
 != 0);

132 
	`as£¹
(
m_Ï¡_¡Üe
 != 0);

133 
	`as£¹
(
m_fœ¡_¡Üe
 != 0);

134 
	`as£¹
(
m_Ï¡_wr™”
 != -1);

137 
m_¡Üe_fœ¡_to_¡Ş’
.
	`add
(
cu¼’t
 - 
m_fœ¡_¡Üe
);

138 
m_¡Üe_couÁ
.
	`add
(
m_¡Ües_this_š‹rv®
);

139 
m_¡Üe_Ï¡_to_¡Ş’
.
	`add
(
cu¼’t
 - 
m_Ï¡_¡Üe
);

140 
m_¡Üe_fœ¡_to_Ï¡
.
	`add
(
m_Ï¡_¡Üe
 - 
m_fœ¡_¡Üe
);

141 
m_tÙ®_§m¶es
++;

144 
	`as£¹
(
s_¡Üe_fœ¡_to_¡Ş’_±r
 !ğ
NULL
);

145 
s_¡Üe_fœ¡_to_¡Ş’_±r
->
	`add
(
cu¼’t
 - 
m_fœ¡_¡Üe
);

146 
s_¡Üe_couÁ_±r
->
	`add
(
m_¡Ües_this_š‹rv®
);

147 
s_¡Üe_Ï¡_to_¡Ş’_±r
->
	`add
(
cu¼’t
 - 
m_Ï¡_¡Üe
);

148 
s_¡Üe_fœ¡_to_Ï¡_±r
->
	`add
(
m_Ï¡_¡Üe
 - 
m_fœ¡_¡Üe
);

149 
s_tÙ®_§m¶es
++;

152 
m_¡Ües_this_š‹rv®
 = 0;

153 
m_Ï¡_¡Üe
 = 0;

154 
m_fœ¡_¡Üe
 = 0;

155 
m_Ï¡_wr™”
 = -1;

157 
	}
}

	@ruby/profiler/StoreTrace.hh

29 #iâdeà
__MEM_RUBY_PROFILER_STORETRACE_HH__


30 
	#__MEM_RUBY_PROFILER_STORETRACE_HH__


	)

32 
	~<io¡»am
>

34 
	~"ba£/ty³s.hh
"

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

36 
	~"mem/ruby/commÚ/Hi¡og¿m.hh
"

38 şas 
	cStÜeT¿û


40 
	mpublic
:

41 
	$StÜeT¿û
() { }

42 
ex¶ic™
 
	`StÜeT¿û
(
Addr
 
addr
);

43 ~
	`StÜeT¿û
();

45 
	`¡Üe
(
NodeID
 
node
);

46 
	`downg¿de
(
NodeID
 
node
);

47 
	$g‘TÙ®
(ècÚ¡ {  
m_tÙ®_§m¶es
; 
	}
}

48 
š™Summ¬y
();

49 
´štSumm¬y
(
¡d
::
o¡»am
& 
out
);

50 
ş—rSumm¬y
();

52 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

54 
´iv©e
:

55 
boŞ
 
s_š™
;

56 
št64_t
 
s_tÙ®_§m¶es
;

58 
Hi¡og¿m
* 
s_¡Üe_couÁ_±r
;

59 
Hi¡og¿m
* 
s_¡Üe_fœ¡_to_¡Ş’_±r
;

60 
Hi¡og¿m
* 
s_¡Üe_Ï¡_to_¡Ş’_±r
;

61 
Hi¡og¿m
* 
s_¡Üe_fœ¡_to_Ï¡_±r
;

63 
Addr
 
m_addr
;

64 
NodeID
 
m_Ï¡_wr™”
;

65 
Tick
 
m_fœ¡_¡Üe
;

66 
Tick
 
m_Ï¡_¡Üe
;

67 
m_¡Ües_this_š‹rv®
;

69 
št64_t
 
m_tÙ®_§m¶es
;

70 
Hi¡og¿m
 
m_¡Üe_couÁ
;

71 
Hi¡og¿m
 
m_¡Üe_fœ¡_to_¡Ş’
;

72 
Hi¡og¿m
 
m_¡Üe_Ï¡_to_¡Ş’
;

73 
Hi¡og¿m
 
m_¡Üe_fœ¡_to_Ï¡
;

74 
	}
};

76 
šlše
 
boŞ


77 
	$node_Ëss_th’_eq
(cÚ¡ 
StÜeT¿û
* 
n1
, cÚ¡ StÜeT¿û* 
n2
)

79  
n1
->
	`g‘TÙ®
(è> 
n2
->getTotal();

80 
	}
}

82 
šlše
 
	g¡d
::
o¡»am
&

83 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gStÜeT¿û
& 
	gobj
)

85 
	gobj
.
´št
(
out
);

86 
	gout
 << 
	g¡d
::
æush
;

87  
	gout
;

	@ruby/slicc_interface/AbstractCacheEntry.cc

29 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCacheEÁry.hh
"

31 
	~"ba£/Œaû.hh
"

32 
	~"debug/RubyCache.hh
"

34 
	gAb¡¿ùCacheEÁry
::
	$Ab¡¿ùCacheEÁry
()

36 
m_P”missiÚ
 = 
AcûssP”missiÚ_NÙP»£Á
;

37 
m_Add»ss
 = 0;

38 
m_locked
 = -1;

39 
	}
}

41 
	gAb¡¿ùCacheEÁry
::~
	$Ab¡¿ùCacheEÁry
()

43 
	}
}

46 
Ab¡¿ùCacheEÁry
::
	$chªgeP”missiÚ
(
AcûssP”missiÚ
 
Ãw_³rm
)

48 
Ab¡¿ùEÁry
::
	`chªgeP”missiÚ
(
Ãw_³rm
);

49 ià((
Ãw_³rm
 =ğ
AcûssP”missiÚ_Inv®id
) ||

50 (
Ãw_³rm
 =ğ
AcûssP”missiÚ_NÙP»£Á
)) {

51 
m_locked
 = -1;

53 
	}
}

56 
	gAb¡¿ùCacheEÁry
::
	$£tLocked
(
cÚ‹xt
)

58 
	`DPRINTF
(
RubyCache
, "S‘tšg Lock fÜ‡ddr: %#xØ%d\n", 
m_Add»ss
, 
cÚ‹xt
);

59 
m_locked
 = 
cÚ‹xt
;

60 
	}
}

63 
	gAb¡¿ùCacheEÁry
::
	$ş—rLocked
()

65 
	`DPRINTF
(
RubyCache
, "CË¬ Lock fÜ‡ddr: %#x\n", 
m_Add»ss
);

66 
m_locked
 = -1;

67 
	}
}

69 
boŞ


70 
	gAb¡¿ùCacheEÁry
::
	$isLocked
(
cÚ‹xt
) const

72 
	`DPRINTF
(
RubyCache
, "Testing Lock for‡ddr: %#llx cur %d con %d\n",

73 
m_Add»ss
, 
m_locked
, 
cÚ‹xt
);

74  
m_locked
 =ğ
cÚ‹xt
;

75 
	}
}

	@ruby/slicc_interface/AbstractCacheEntry.hh

33 #iâdeà
__MEM_RUBY_SLICC_INTERFACE_ABSTRACTCACHEENTRY_HH__


34 
	#__MEM_RUBY_SLICC_INTERFACE_ABSTRACTCACHEENTRY_HH__


	)

36 
	~<io¡»am
>

38 
	~"ba£/misc.hh
"

39 
	~"mem/´ÙocŞ/AcûssP”missiÚ.hh
"

40 
	~"mem/ruby/commÚ/Add»ss.hh
"

41 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùEÁry.hh
"

43 
şass
 
	gD©aBlock
;

45 şas 
	cAb¡¿ùCacheEÁry
 : 
public
 
Ab¡¿ùEÁry


47 
public
:

48 
Ab¡¿ùCacheEÁry
();

49 
	mvœtu®
 ~
Ab¡¿ùCacheEÁry
() = 0;

52 
chªgeP”missiÚ
(
AcûssP”missiÚ
 
Ãw_³rm
);

56 
vœtu®
 
	mD©aBlock
& 
	$g‘D©aBlk
()

57 { 
	`·nic
("getDataBlk()‚ot implemented!"); }

59 
v®idBlocks
;

60 
vœtu®
 & 
	$g‘NumV®idBlocks
()

62  
v®idBlocks
;

63 
	}
}

67 
£tLocked
(
cÚ‹xt
);

68 
ş—rLocked
();

69 
boŞ
 
	$isLocked
(
cÚ‹xt
) const;

71 
	$£tS‘Index
(
ušt32_t
 
s
è{ 
m_£t_šdex
 = s; 
	}
}

72 
ušt32_t
 
	$g‘S‘Index
(ècÚ¡ {  
m_£t_šdex
; 
	}
}

74 
	$£tWayIndex
(
ušt32_t
 
s
è{ 
m_way_šdex
 = s; 
	}
}

75 
ušt32_t
 
	$g‘WayIndex
(ècÚ¡ {  
m_way_šdex
; 
	}
}

78 
Addr
 
	gm_Add»ss
;

81 
	gm_locked
;

83 
	g´iv©e
:

85 
ušt32_t
 
m_£t_šdex
;

86 
ušt32_t
 
	gm_way_šdex
;

89 
šlše
 
	g¡d
::
o¡»am
&

90 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gAb¡¿ùCacheEÁry
& 
	gobj
)

92 
	gobj
.
´št
(
out
);

93 
	gout
 << 
	g¡d
::
æush
;

94  
	gout
;

	@ruby/slicc_interface/AbstractController.cc

29 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCÚŒŞËr.hh
"

31 
	~"debug/RubyQueue.hh
"

32 
	~"mem/´ÙocŞ/MemÜyMsg.hh
"

33 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

34 
	~"mem/ruby/sy¡em/Sequ’ûr.hh
"

35 
	~"mem/ruby/sy¡em/GPUCßËsûr.hh
"

36 
	~"sim/sy¡em.hh
"

38 
	gAb¡¿ùCÚŒŞËr
::
	$Ab¡¿ùCÚŒŞËr
(cÚ¡ 
P¬ams
 *
p
)

39 : 
	`MemObjeù
(
p
), 
	`CÚsum”
(
this
), 
	`m_v”siÚ
Õ->
v”siÚ
),

40 
	`m_şu¡”ID
(
p
->
şu¡”_id
),

41 
	`m_ma¡”Id
(
p
->
sy¡em
->
	`g‘Ma¡”Id
(
	`Çme
())), 
	`m_is_blockšg
(
çl£
),

42 
	`m_numb”_of_TBEs
(
p
->
numb”_of_TBEs
),

43 
	`m_Œªs™iÚs_³r_cyşe
(
p
->
Œªs™iÚs_³r_cyşe
),

44 
	`m_bufãr_size
(
p
->
bufãr_size
), 
	`m_»cyşe_Ï‹ncy
Õ->
»cyşe_Ï‹ncy
),

45 
	`memÜyPÜt
(
	`c¥rštf
("%s.memÜy", 
	`Çme
()), 
this
, "")

47 ià(
m_v”siÚ
 == 0) {

50 
Sts
::
	`»gi¡”DumpC®lback
(
Ãw
 
	`StsC®lback
(
this
));

52 
	}
}

55 
	gAb¡¿ùCÚŒŞËr
::
	$š™
()

57 
	`·¿ms
()->
ruby_sy¡em
->
	`»gi¡”Ab¡¿ùCÚŒŞËr
(
this
);

58 
m_d–ayHi¡og¿m
.
	`š™
(10);

59 
ušt32_t
 
size
 = 
N‘wÜk
::
	`g‘Numb”OfVœtu®N‘wÜks
();

60 
ušt32_t
 
i
 = 0; i < 
size
; i++) {

61 
m_d–ayVCHi¡og¿m
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

62 
m_d–ayVCHi¡og¿m
[
i
]->
	`š™
(10);

64 
	}
}

67 
	gAb¡¿ùCÚŒŞËr
::
	$»£tSts
()

69 
m_d–ayHi¡og¿m
.
	`»£t
();

70 
ušt32_t
 
size
 = 
N‘wÜk
::
	`g‘Numb”OfVœtu®N‘wÜks
();

71 
ušt32_t
 
i
 = 0; i < 
size
; i++) {

72 
m_d–ayVCHi¡og¿m
[
i
]->
	`»£t
();

74 
	}
}

77 
	gAb¡¿ùCÚŒŞËr
::
	$»gSts
()

79 
MemObjeù
::
	`»gSts
();

81 
m_fuÎy_busy_cyşes


82 .
	`Çme
(name() + ".fully_busy_cycles")

83 .
	`desc
("cycles for which‚umber ofransistions == maxransitions")

84 .
	`æags
(
Sts
::
noz”o
);

85 
	}
}

88 
	gAb¡¿ùCÚŒŞËr
::
	$´ofeMsgD–ay
(
ušt32_t
 
vœtu®N‘wÜk
, 
Cyşes
 
d–ay
)

90 
	`as£¹
(
vœtu®N‘wÜk
 < 
m_d–ayVCHi¡og¿m
.
	`size
());

91 
m_d–ayHi¡og¿m
.
	`§m¶e
(
d–ay
);

92 
m_d–ayVCHi¡og¿m
[
vœtu®N‘wÜk
]->
	`§m¶e
(
d–ay
);

93 
	}
}

96 
	gAb¡¿ùCÚŒŞËr
::
	$¡®lBufãr
(
Mes§geBufãr
* 
buf
, 
Addr
 
addr
)

98 ià(
m_wa™šg_bufãrs
.
	`couÁ
(
addr
) == 0) {

99 
MsgVecTy³
* 
msgVec
 = 
Ãw
 MsgVecType;

100 
msgVec
->
	`»size
(
m_š_pÜts
, 
NULL
);

101 
m_wa™šg_bufãrs
[
addr
] = 
msgVec
;

103 
	`DPRINTF
(
RubyQueue
, "¡®lšg % pÜˆ%d‡dd¸%#x\n", 
buf
, 
m_cur_š_pÜt
,

104 
addr
);

105 
	`as£¹
(
m_š_pÜts
 > 
m_cur_š_pÜt
);

106 (*(
m_wa™šg_bufãrs
[
addr
]))[
m_cur_š_pÜt
] = 
buf
;

107 
	}
}

110 
	gAb¡¿ùCÚŒŞËr
::
	$wakeUpBufãrs
(
Addr
 
addr
)

112 ià(
m_wa™šg_bufãrs
.
	`couÁ
(
addr
) > 0) {

117 
š_pÜt_¿nk
 = 
m_cur_š_pÜt
 - 1;

118 
š_pÜt_¿nk
 >= 0;

119 
š_pÜt_¿nk
--) {

120 ià((*(
m_wa™šg_bufãrs
[
addr
]))[
š_pÜt_¿nk
] !ğ
NULL
) {

121 (*(
m_wa™šg_bufãrs
[
addr
]))[
š_pÜt_¿nk
]->

122 
	`»ª®yzeMes§ges
(
addr
, 
	`şockEdge
());

125 
d–‘e
 
m_wa™šg_bufãrs
[
addr
];

126 
m_wa™šg_bufãrs
.
	`”a£
(
addr
);

128 
	}
}

131 
	gAb¡¿ùCÚŒŞËr
::
	$wakeUpAÎBufãrs
(
Addr
 
addr
)

133 ià(
m_wa™šg_bufãrs
.
	`couÁ
(
addr
) > 0) {

138 
š_pÜt_¿nk
 = 
m_š_pÜts
 - 1;

139 
š_pÜt_¿nk
 >= 0;

140 
š_pÜt_¿nk
--) {

141 ià((*(
m_wa™šg_bufãrs
[
addr
]))[
š_pÜt_¿nk
] !ğ
NULL
) {

142 (*(
m_wa™šg_bufãrs
[
addr
]))[
š_pÜt_¿nk
]->

143 
	`»ª®yzeMes§ges
(
addr
, 
	`şockEdge
());

146 
d–‘e
 
m_wa™šg_bufãrs
[
addr
];

147 
m_wa™šg_bufãrs
.
	`”a£
(
addr
);

149 
	}
}

152 
	gAb¡¿ùCÚŒŞËr
::
	$wakeUpAÎBufãrs
()

158 
¡d
::
veùÜ
<
MsgVecTy³
*> 
wokeUpMsgVecs
;

159 
MsgBufTy³
 
wokeUpMsgBufs
;

161 ià(
m_wa™šg_bufãrs
.
	`size
() > 0) {

162 
Wa™šgBufTy³
::
™”©Ü
 
buf_™”
 = 
m_wa™šg_bufãrs
.
	`begš
();

163 
buf_™”
 !ğ
m_wa™šg_bufãrs
.
	`’d
();

164 ++
buf_™”
) {

165 
MsgVecTy³
::
™”©Ü
 
vec_™”
 = 
buf_™”
->
£cÚd
->
	`begš
();

166 
vec_™”
 !ğ
buf_™”
->
£cÚd
->
	`’d
();

167 ++
vec_™”
) {

171 ià(*
vec_™”
 !ğ
NULL
 &&

172 (
wokeUpMsgBufs
.
	`couÁ
(*
vec_™”
) == 0)) {

173 (*
vec_™”
)->
	`»ª®yzeAÎMes§ges
(
	`şockEdge
());

174 
wokeUpMsgBufs
.
	`š£¹
(*
vec_™”
);

177 
wokeUpMsgVecs
.
	`push_back
(
buf_™”
->
£cÚd
);

180 
¡d
::
veùÜ
<
MsgVecTy³
*>::
™”©Ü
 
wb_™”
 = 
wokeUpMsgVecs
.
	`begš
();

181 
wb_™”
 !ğ
wokeUpMsgVecs
.
	`’d
();

182 ++
wb_™”
) {

183 
	`d–‘e
 (*
wb_™”
);

186 
m_wa™šg_bufãrs
.
	`ş—r
();

188 
	}
}

191 
	gAb¡¿ùCÚŒŞËr
::
	$blockOnQueue
(
Addr
 
addr
, 
Mes§geBufãr
* 
pÜt
)

193 
m_is_blockšg
 = 
Œue
;

194 
m_block_m­
[
addr
] = 
pÜt
;

195 
	}
}

197 
boŞ


198 
	gAb¡¿ùCÚŒŞËr
::
	$isBlocked
(
Addr
 
addr
) const

200  
m_is_blockšg
 && (
m_block_m­
.
	`fšd
(
addr
è!ğm_block_m­.
	`’d
());

201 
	}
}

204 
	gAb¡¿ùCÚŒŞËr
::
	$unblock
(
Addr
 
addr
)

206 
m_block_m­
.
	`”a£
(
addr
);

207 ià(
m_block_m­
.
	`size
() == 0) {

208 
m_is_blockšg
 = 
çl£
;

210 
	}
}

212 
boŞ


213 
	gAb¡¿ùCÚŒŞËr
::
	$isBlocked
(
Addr
 
addr
)

215  (
m_block_m­
.
	`couÁ
(
addr
) > 0);

216 
	}
}

218 
	gBa£Ma¡”PÜt
 &

219 
	gAb¡¿ùCÚŒŞËr
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

220 
PÜtID
 
idx
)

222  
memÜyPÜt
;

223 
	}
}

226 
	gAb¡¿ùCÚŒŞËr
::
	$queueMemÜyR—d
(cÚ¡ 
MachšeID
 &
id
, 
Addr
 
addr
,

227 
Cyşes
 
Ï‹ncy
)

229 
Reque¡PŒ
 
»q
 = 
Ãw
 
	`Reque¡
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(), 0,

230 
m_ma¡”Id
);

232 
Pack‘PŒ
 
pkt
 = 
Pack‘
::
	`ü—‹R—d
(
»q
);

233 
ušt8_t
 *
ÃwD©a
 = 
Ãw
 ušt8_t[
RubySy¡em
::
	`g‘BlockSizeBy‹s
()];

234 
pkt
->
	`d©aDyÇmic
(
ÃwD©a
);

236 
S’d”S‹
 *
s
 = 
Ãw
 
	`S’d”S‹
(
id
);

237 
pkt
->
	`pushS’d”S‹
(
s
);

240 ià(
RubySy¡em
::
	`g‘W¬mupEÇbËd
()) {

241 
memÜyPÜt
.
	`£ndFunùiÚ®
(
pkt
);

242 
	`»cvTimšgRe¥
(
pkt
);

246 
memÜyPÜt
.
	`schedTimšgReq
(
pkt
, 
	`şockEdge
(
Ï‹ncy
));

247 
	}
}

250 
	gAb¡¿ùCÚŒŞËr
::
	$queueMemÜyWr™e
(cÚ¡ 
MachšeID
 &
id
, 
Addr
 
addr
,

251 
Cyşes
 
Ï‹ncy
, cÚ¡ 
D©aBlock
 &
block
)

253 
Reque¡PŒ
 
»q
 = 
Ãw
 
	`Reque¡
(
addr
, 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(), 0,

254 
m_ma¡”Id
);

256 
Pack‘PŒ
 
pkt
 = 
Pack‘
::
	`ü—‹Wr™e
(
»q
);

257 
ušt8_t
 *
ÃwD©a
 = 
Ãw
 ušt8_t[
RubySy¡em
::
	`g‘BlockSizeBy‹s
()];

258 
pkt
->
	`d©aDyÇmic
(
ÃwD©a
);

259 
	`memıy
(
ÃwD©a
, 
block
.
	`g‘D©a
(0, 
RubySy¡em
::
	`g‘BlockSizeBy‹s
()),

260 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

262 
S’d”S‹
 *
s
 = 
Ãw
 
	`S’d”S‹
(
id
);

263 
pkt
->
	`pushS’d”S‹
(
s
);

266 ià(
RubySy¡em
::
	`g‘W¬mupEÇbËd
()) {

267 
memÜyPÜt
.
	`£ndFunùiÚ®
(
pkt
);

268 
	`»cvTimšgRe¥
(
pkt
);

273 
memÜyPÜt
.
	`schedTimšgReq
(
pkt
, 
	`şockEdge
(
Ï‹ncy
));

274 
	}
}

277 
	gAb¡¿ùCÚŒŞËr
::
	$queueMemÜyWr™eP¬tŸl
(cÚ¡ 
MachšeID
 &
id
, 
Addr
 
addr
,

278 
Cyşes
 
Ï‹ncy
,

279 cÚ¡ 
D©aBlock
 &
block
, 
size
)

281 
Reque¡PŒ
 
»q
 = 
Ãw
 
	`Reque¡
(
addr
, 
size
, 0, 
m_ma¡”Id
);

283 
Pack‘PŒ
 
pkt
 = 
Pack‘
::
	`ü—‹Wr™e
(
»q
);

284 
ušt8_t
 *
ÃwD©a
 = 
Ãw
 ušt8_t[
size
];

285 
pkt
->
	`d©aDyÇmic
(
ÃwD©a
);

286 
	`memıy
(
ÃwD©a
, 
block
.
	`g‘D©a
(
	`g‘Off£t
(
addr
), 
size
), size);

288 
S’d”S‹
 *
s
 = 
Ãw
 
	`S’d”S‹
(
id
);

289 
pkt
->
	`pushS’d”S‹
(
s
);

292 
memÜyPÜt
.
	`schedTimšgReq
(
pkt
, 
	`şockEdge
(
Ï‹ncy
));

293 
	}
}

296 
	gAb¡¿ùCÚŒŞËr
::
	$funùiÚ®MemÜyR—d
(
Pack‘PŒ
 
pkt
)

298 
memÜyPÜt
.
	`£ndFunùiÚ®
(
pkt
);

299 
	}
}

302 
	gAb¡¿ùCÚŒŞËr
::
	$funùiÚ®MemÜyWr™e
(
Pack‘PŒ
 
pkt
)

304 
num_funùiÚ®_wr™es
 = 0;

307 ià(
memÜyPÜt
.
	`checkFunùiÚ®
(
pkt
)) {

308 
num_funùiÚ®_wr™es
++;

312 
memÜyPÜt
.
	`£ndFunùiÚ®
(
pkt
);

313  
num_funùiÚ®_wr™es
 + 1;

314 
	}
}

317 
	gAb¡¿ùCÚŒŞËr
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

319 
	`as£¹
(
	`g‘MemÜyQueue
());

320 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

322 
¡d
::
sh¬ed_±r
<
MemÜyMsg
> 
msg
 = std::
make_sh¬ed
<MemÜyMsg>(
	`şockEdge
());

323 (*
msg
).
m_addr
 = 
pkt
->
	`g‘Addr
();

324 (*
msg
).
m_S’d”
 = 
m_machšeID
;

326 
S’d”S‹
 *
s
 = 
dyÇmic_ÿ¡
<S’d”S‹ *>(
pkt
->
£nd”S‹
);

327 (*
msg
).
m_Origš®Reque¡ÜMachId
 = 
s
->
id
;

328 
d–‘e
 
s
;

330 ià(
pkt
->
	`isR—d
()) {

331 (*
msg
).
m_Ty³
 = 
MemÜyReque¡Ty³_MEMORY_READ
;

332 (*
msg
).
m_Mes§geSize
 = 
Mes§geSizeTy³_Re¥Ú£_D©a
;

335 (*
msg
).
m_D©aBlk
.
	`£tD©a
(
pkt
->
g‘PŒ
<
ušt8_t
>(), 0,

336 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

337 } ià(
pkt
->
	`isWr™e
()) {

338 (*
msg
).
m_Ty³
 = 
MemÜyReque¡Ty³_MEMORY_WB
;

339 (*
msg
).
m_Mes§geSize
 = 
Mes§geSizeTy³_Wr™eback_CÚŒŞ
;

341 
	`·nic
("Incorrect…acketype„eceived from memory controller!");

344 
	`g‘MemÜyQueue
()->
	`’queue
(
msg
, 
	`şockEdge
(), 
	`cyşesToTicks
(
	`Cyşes
(1)));

345 
d–‘e
 
pkt
->
»q
;

346 
d–‘e
 
pkt
;

347 
	}
}

349 
boŞ


350 
	gAb¡¿ùCÚŒŞËr
::
MemÜyPÜt
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

352 
cÚŒŞËr
->
	`»cvTimšgRe¥
(
pkt
);

353  
Œue
;

354 
	}
}

356 
	gAb¡¿ùCÚŒŞËr
::
MemÜyPÜt
::
	$MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

357 
Ab¡¿ùCÚŒŞËr
 *
_cÚŒŞËr
,

358 cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
)

359 : 
	`QueuedMa¡”PÜt
(
_Çme
, 
_cÚŒŞËr
, 
»qQueue
, 
¢oİRe¥Queue
),

360 
	`»qQueue
(*
_cÚŒŞËr
, *
this
, 
_Ïb–
),

361 
	`¢oİRe¥Queue
(*
_cÚŒŞËr
, *
this
, 
_Ïb–
),

362 
	$cÚŒŞËr
(
_cÚŒŞËr
)

364 
	}
}

	@ruby/slicc_interface/AbstractController.hh

29 #iâdeà
__MEM_RUBY_SLICC_INTERFACE_ABSTRACTCONTROLLER_HH__


30 
	#__MEM_RUBY_SLICC_INTERFACE_ABSTRACTCONTROLLER_HH__


	)

32 
	~<exû±iÚ
>

33 
	~<io¡»am
>

34 
	~<¡ršg
>

36 
	~"ba£/ÿÎback.hh
"

37 
	~"mem/´ÙocŞ/AcûssP”missiÚ.hh
"

38 
	~"mem/ruby/commÚ/Add»ss.hh
"

39 
	~"mem/ruby/commÚ/CÚsum”.hh
"

40 
	~"mem/ruby/commÚ/D©aBlock.hh
"

41 
	~"mem/ruby/commÚ/Hi¡og¿m.hh
"

42 
	~"mem/ruby/commÚ/MachšeID.hh
"

43 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

44 
	~"mem/ruby/ÃtwÜk/N‘wÜk.hh
"

45 
	~"mem/ruby/sy¡em/CacheRecÜd”.hh
"

46 
	~"mem/·ck‘.hh
"

47 
	~"mem/qpÜt.hh
"

48 
	~"·¿ms/RubyCÚŒŞËr.hh
"

49 
	~"mem/mem_objeù.hh
"

51 
şass
 
	gN‘wÜk
;

52 
şass
 
	gGPUCßËsûr
;

55 şas 
	cRejeùExû±iÚ
: 
public
 
¡d
::
exû±iÚ


57 
vœtu®
 cÚ¡ * 
	$wh©
(ècÚ¡ 
	$throw
()

59 
	}
};

61 
şass
 
	gAb¡¿ùCÚŒŞËr
 : 
public
 
MemObjeù
,…ubliø
	gCÚsum”


63 
	gpublic
:

64 
RubyCÚŒŞËrP¬ams
 
	tP¬ams
;

65 
Ab¡¿ùCÚŒŞËr
(cÚ¡ 
P¬ams
 *
p
);

66 
š™
();

67 cÚ¡ 
P¬ams
 *
·¿ms
(ècÚ¡ {  (cÚ¡ 
	gP¬ams
 *)
	g_·¿ms
; }

69 
NodeID
 
g‘V”siÚ
(ècÚ¡ {  
	gm_machšeID
.
g‘Num
(); }

70 
MachšeTy³
 
g‘Ty³
(ècÚ¡ {  
	gm_machšeID
.getType(); }

72 
š™N‘wÜkPŒ
(
N‘wÜk
* 
Ãt_±r
è{ 
	gm_Ãt_±r
 =‚et_ptr; }

75 
blockOnQueue
(
Addr
, 
Mes§geBufãr
*);

76 
boŞ
 
isBlocked
(
Addr
) const;

77 
unblock
(
Addr
);

78 
boŞ
 
isBlocked
(
Addr
);

80 
vœtu®
 
Mes§geBufãr
* 
g‘Mªd©ÜyQueue
() const = 0;

81 
vœtu®
 
Mes§geBufãr
* 
g‘MemÜyQueue
() const = 0;

82 
vœtu®
 
AcûssP”missiÚ
 
g‘AcûssP”missiÚ
(cÚ¡ 
Addr
 &
addr
) = 0;

84 
vœtu®
 
´št
(
¡d
::
o¡»am
 & 
out
) const = 0;

85 
vœtu®
 
wakeup
() = 0;

86 
vœtu®
 
»£tSts
() = 0;

87 
vœtu®
 
»gSts
();

89 
vœtu®
 
»cÜdCacheT¿û
(
úŒl
, 
CacheRecÜd”
* 
Œ
) = 0;

90 
vœtu®
 
Sequ’ûr
* 
g‘CPUSequ’ûr
() const = 0;

91 
vœtu®
 
GPUCßËsûr
* 
g‘GPUCßËsûr
() const = 0;

95 
vœtu®
 
funùiÚ®R—d
(cÚ¡ 
Addr
 &
addr
, 
Pack‘PŒ
) = 0;

96 
funùiÚ®MemÜyR—d
(
Pack‘PŒ
);

99 
vœtu®
 
funùiÚ®Wr™eBufãrs
(
Pack‘PŒ
&) = 0;

100 
vœtu®
 
funùiÚ®Wr™e
(cÚ¡ 
Addr
 &
addr
, 
Pack‘PŒ
) = 0;

101 
funùiÚ®MemÜyWr™e
(
Pack‘PŒ
);

104 
vœtu®
 
’queueP»ãtch
(cÚ¡ 
Addr
 &, cÚ¡ 
RubyReque¡Ty³
&)

105 { 
çl
("Prefetches‚ot implemented!");}

110 
vœtu®
 
cŞÏ‹Sts
()

111 {
çl
("collateStats() should be overridden!");}

114 
vœtu®
 
š™N‘Queues
() = 0;

117 
	gBa£Ma¡”PÜt
& 
g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

118 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

120 
queueMemÜyR—d
(cÚ¡ 
MachšeID
 &
id
, 
Addr
 
addr
, 
Cyşes
 
Ï‹ncy
);

121 
queueMemÜyWr™e
(cÚ¡ 
MachšeID
 &
id
, 
Addr
 
addr
, 
Cyşes
 
Ï‹ncy
,

122 cÚ¡ 
D©aBlock
 &
block
);

123 
queueMemÜyWr™eP¬tŸl
(cÚ¡ 
MachšeID
 &
id
, 
Addr
 
addr
, 
Cyşes
 
Ï‹ncy
,

124 cÚ¡ 
D©aBlock
 &
block
, 
size
);

125 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

127 
	gpublic
:

128 
MachšeID
 
g‘MachšeID
(ècÚ¡ {  
m_machšeID
; }

130 
	gSts
::
Hi¡og¿m
& 
g‘D–ayHi¡
(è{  
m_d–ayHi¡og¿m
; }

131 
	gSts
::
Hi¡og¿m
& 
g‘D–ayVCHi¡
(
ušt32_t
 
šdex
)

132 {  *(
m_d–ayVCHi¡og¿m
[
šdex
]); }

134 
	g´Ùeùed
:

136 
´ofeReque¡
(cÚ¡ 
¡d
::
¡ršg
 &
»que¡
);

138 
´ofeMsgD–ay
(
ušt32_t
 
vœtu®N‘wÜk
, 
Cyşes
 
d–ay
);

140 
¡®lBufãr
(
Mes§geBufãr
* 
buf
, 
Addr
 
addr
);

141 
wakeUpBufãrs
(
Addr
 
addr
);

142 
wakeUpAÎBufãrs
(
Addr
 
addr
);

143 
wakeUpAÎBufãrs
();

145 
	g´Ùeùed
:

146 cÚ¡ 
NodeID
 
m_v”siÚ
;

147 
MachšeID
 
	gm_machšeID
;

148 cÚ¡ 
NodeID
 
	gm_şu¡”ID
;

151 cÚ¡ 
Ma¡”ID
 
	gm_ma¡”Id
;

153 
N‘wÜk
 *
	gm_Ãt_±r
;

154 
boŞ
 
	gm_is_blockšg
;

155 
	g¡d
::
m­
<
Addr
, 
	gMes§geBufãr
*> 
	gm_block_m­
;

157 
	g¡d
::
	tveùÜ
<
	tMes§geBufãr
*> 
	tMsgVecTy³
;

158 
	g¡d
::
	t£t
<
	tMes§geBufãr
*> 
	tMsgBufTy³
;

159 
	g¡d
::
	tm­
<
	tAddr
, 
	tMsgVecTy³
* > 
	tWa™šgBufTy³
;

160 
Wa™šgBufTy³
 
	gm_wa™šg_bufãrs
;

162 
	gm_š_pÜts
;

163 
	gm_cur_š_pÜt
;

164 cÚ¡ 
	gm_numb”_of_TBEs
;

165 cÚ¡ 
	gm_Œªs™iÚs_³r_cyşe
;

166 cÚ¡ 
	gm_bufãr_size
;

167 
Cyşes
 
	gm_»cyşe_Ï‹ncy
;

171 
	gSts
::
SÿÏr
 
m_fuÎy_busy_cyşes
;

175 
	gSts
::
Hi¡og¿m
 
m_d–ayHi¡og¿m
;

176 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_d–ayVCHi¡og¿m
;

180 şas 
	cStsC®lback
 : 
public
 
C®lback


182 
´iv©e
:

183 
Ab¡¿ùCÚŒŞËr
 *
ùr
;

185 
	gpublic
:

186 
vœtu®
 ~
StsC®lback
() {}

187 
StsC®lback
(
Ab¡¿ùCÚŒŞËr
 *
_ùr
è: 
ùr
(_ctr) {}

188 
´oûss
(è{
ùr
->
cŞÏ‹Sts
();}

195 şas 
	cMemÜyPÜt
 : 
public
 
QueuedMa¡”PÜt


197 
´iv©e
:

199 
ReqPack‘Queue
 
»qQueue
;

200 
SnoİRe¥Pack‘Queue
 
	g¢oİRe¥Queue
;

203 
Ab¡¿ùCÚŒŞËr
 *
	gcÚŒŞËr
;

205 
	gpublic
:

206 
MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
Ab¡¿ùCÚŒŞËr
 *
_cÚŒŞËr
,

207 cÚ¡ 
¡d
::
¡ršg
 &
_Ïb–
);

212 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

216 
MemÜyPÜt
 
	gmemÜyPÜt
;

219 
	gS’d”S‹
 : 
public
 
Pack‘
::
S’d”S‹


222 
MachšeID
 
id
;

224 
S’d”S‹
(
MachšeID
 
_id
è: 
id
(_id)

	@ruby/slicc_interface/AbstractEntry.cc

29 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùEÁry.hh
"

31 
	gAb¡¿ùEÁry
::
	$Ab¡¿ùEÁry
()

33 
m_P”missiÚ
 = 
AcûssP”missiÚ_NÙP»£Á
;

34 
	}
}

36 
	gAb¡¿ùEÁry
::~
	$Ab¡¿ùEÁry
()

38 
	}
}

40 
AcûssP”missiÚ


41 
Ab¡¿ùEÁry
::
	$g‘P”missiÚ
() const

43  
m_P”missiÚ
;

44 
	}
}

47 
	gAb¡¿ùEÁry
::
	$chªgeP”missiÚ
(
AcûssP”missiÚ
 
Ãw_³rm
)

49 
m_P”missiÚ
 = 
Ãw_³rm
;

50 
	}
}

	@ruby/slicc_interface/AbstractEntry.hh

29 #iâdeà
__MEM_RUBY_SLICC_INTERFACE_ABSTRACTENTRY_HH__


30 
	#__MEM_RUBY_SLICC_INTERFACE_ABSTRACTENTRY_HH__


	)

32 
	~<io¡»am
>

34 
	~"mem/´ÙocŞ/AcûssP”missiÚ.hh
"

36 şas 
	cAb¡¿ùEÁry


38 
	mpublic
:

39 
Ab¡¿ùEÁry
();

40 
	mvœtu®
 ~
Ab¡¿ùEÁry
() = 0;

43 
AcûssP”missiÚ
 
	$g‘P”missiÚ
() const;

44 
	`chªgeP”missiÚ
(
AcûssP”missiÚ
 
Ãw_³rm
);

46 
vœtu®
 
	$´št
(
¡d
::
o¡»am
& 
out
) const = 0;

48 
AcûssP”missiÚ
 
m_P”missiÚ
;

52 
šlše
 
¡d
::
o¡»am
&

53 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
Ab¡¿ùEÁry
& 
obj
)

55 
obj
.
	`´št
(
out
);

56 
out
 << 
¡d
::
æush
;

57  
out
;

58 
	}
}

	@ruby/slicc_interface/Message.hh

29 #iâdeà
__MEM_RUBY_SLICC_INTERFACE_MESSAGE_HH__


30 
	#__MEM_RUBY_SLICC_INTERFACE_MESSAGE_HH__


	)

32 
	~<io¡»am
>

33 
	~<memÜy
>

34 
	~<¡ack
>

36 
	~"mem/·ck‘.hh
"

37 
	~"mem/´ÙocŞ/Mes§geSizeTy³.hh
"

38 
	~"mem/ruby/commÚ/N‘De¡.hh
"

40 
şass
 
	gMes§ge
;

41 
	g¡d
::
	tsh¬ed_±r
<
	tMes§ge
> 
	tMsgPŒ
;

43 şas 
	cMes§ge


45 
	mpublic
:

46 
	$Mes§ge
(
Tick
 
curTime
)

47 : 
	`m_time
(
curTime
),

48 
	`m_La¡EnqueueTime
(
curTime
),

49 
	`m_D–ayedTicks
(0), 
	$m_msg_couÁ”
(0)

52 
	$Mes§ge
(cÚ¡ 
Mes§ge
 &
Ùh”
)

53 : 
	`m_time
(
Ùh”
.
m_time
),

54 
	`m_La¡EnqueueTime
(
Ùh”
.
m_La¡EnqueueTime
),

55 
	`m_D–ayedTicks
(
Ùh”
.
m_D–ayedTicks
),

56 
	$m_msg_couÁ”
(
Ùh”
.
m_msg_couÁ”
)

57 { 
	}
}

59 
	gvœtu®
 ~
	$Mes§ge
(è{ 
	}
}

61 
vœtu®
 
MsgPŒ
 
	$şÚe
() const = 0;

62 
vœtu®
 
	$´št
(
¡d
::
o¡»am
& 
out
) const = 0;

64 
vœtu®
 cÚ¡ 
Mes§geSizeTy³
& 
	$g‘Mes§geSize
() const

65 { 
	`·nic
("Mes§geSizeTy³(èÿÎed oÀwrÚg mes§ge!"); 
	}
}

66 
vœtu®
 
	gMes§geSizeTy³
& 
	$g‘Mes§geSize
()

67 { 
	`·nic
("Mes§geSizeTy³(èÿÎed oÀwrÚg mes§ge!"); 
	}
}

76 
vœtu®
 
boŞ
 
funùiÚ®R—d
(
Pack‘
 *
pkt
) = 0;

77 
vœtu®
 
boŞ
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
) = 0;

80 
	$upd©eD–ayedTicks
(
Tick
 
curTime
)

82 
	`as£¹
(
m_La¡EnqueueTime
 <ğ
curTime
);

83 
Tick
 
d–
 = 
curTime
 - 
m_La¡EnqueueTime
;

84 
m_D–ayedTicks
 +ğ
d–
;

85 
	}
}

86 
Tick
 
	$g‘D–ayedTicks
(ècÚ¡ { 
m_D–ayedTicks
;
	}
}

88 
	$£tLa¡EnqueueTime
(cÚ¡ 
Tick
& 
time
è{ 
m_La¡EnqueueTime
 =ime; 
	}
}

89 
Tick
 
	$g‘La¡EnqueueTime
(ècÚ¡ { 
m_La¡EnqueueTime
;
	}
}

91 
Tick
 
	$g‘Time
(ècÚ¡ {  
m_time
; 
	}
}

92 
	$£tMsgCouÁ”
(
ušt64_t
 
c
è{ 
m_msg_couÁ”
 = c; 
	}
}

93 
ušt64_t
 
	$g‘MsgCouÁ”
(ècÚ¡ {  
m_msg_couÁ”
; 
	}
}

96 
vœtu®
 cÚ¡ 
	gN‘De¡
& 
	$g‘De¡š©iÚ
() const

97 { 
	`·nic
("g‘De¡š©iÚ(èÿÎed oÀwrÚg mes§ge!"); 
	}
}

98 
vœtu®
 
	gN‘De¡
& 
	$g‘De¡š©iÚ
()

99 { 
	`·nic
("g‘De¡š©iÚ(èÿÎed oÀwrÚg mes§ge!"); 
	}
}

101 
	$g‘IncomšgLšk
(ècÚ¡ {  
šcomšg_lšk
; 
	}
}

102 
	$£tIncomšgLšk
(
lšk
è{ 
šcomšg_lšk
 =†šk; 
	}
}

103 
	$g‘VÃt
(ècÚ¡ {  
vÃt
; 
	}
}

104 
	$£tVÃt
(
Ãt
è{ 
vÃt
 =‚‘; 
	}
}

106 
	g´iv©e
:

107 cÚ¡ 
Tick
 
m_time
;

108 
Tick
 
	gm_La¡EnqueueTime
;

109 
Tick
 
	gm_D–ayedTicks
;

110 
ušt64_t
 
	gm_msg_couÁ”
;

113 
	gšcomšg_lšk
;

114 
	gvÃt
;

117 
šlše
 
boŞ


118 
	gİ”©Ü
>(cÚ¡ 
	gMsgPŒ
 &
	glhs
, cÚ¡ MsgPŒ &
	grhs
)

120 cÚ¡ 
Mes§ge
 *
	gl
 = 
lhs
.
g‘
();

121 cÚ¡ 
Mes§ge
 *
	gr
 = 
rhs
.
g‘
();

123 ià(
	gl
->
g‘La¡EnqueueTime
(è=ğ
r
->getLastEnqueueTime()) {

124  
l
->
g‘MsgCouÁ”
(è> 
r
->getMsgCounter();

126  
	gl
->
g‘La¡EnqueueTime
(è> 
	gr
->getLastEnqueueTime();

129 
šlše
 
	g¡d
::
o¡»am
&

130 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gMes§ge
& 
	gobj
)

132 
	gobj
.
´št
(
out
);

133 
	gout
 << 
	g¡d
::
æush
;

134  
	gout
;

	@ruby/slicc_interface/RubyRequest.cc

29 
	~<io¡»am
>

31 
	~"mem/ruby/¦icc_š‹rçû/RubyReque¡.hh
"

33 
usšg
 
Çme¥aû
 
	g¡d
;

36 
	gRubyReque¡
::
	$´št
(
o¡»am
& 
out
) const

38 
out
 << "[RubyRequest: ";

39 
out
 << 
hex
 << "LšeAdd»s ğ0x" << 
m_LšeAdd»ss
 << 
dec
 << " ";

40 
out
 << 
hex
 << "PhysiÿlAdd»s ğ0x" << 
m_PhysiÿlAdd»ss
 << 
dec
 << " ";

41 
out
 << "Ty³ = " << 
m_Ty³
 << " ";

42 
out
 << 
hex
 << "Prog¿mCouÁ” = 0x" << 
m_Prog¿mCouÁ”
 << 
dec
 << " ";

43 
out
 << "AcûssModğ" << 
m_AcûssMode
 << " ";

44 
out
 << "Sizğ" << 
m_Size
 << " ";

45 
out
 << "P»ãtch = " << 
m_P»ãtch
 << " ";

47 
out
 << "]";

48 
	}
}

50 
boŞ


51 
	gRubyReque¡
::
	$funùiÚ®R—d
(
Pack‘
 *
pkt
)

57  
çl£
;

58 
	}
}

60 
boŞ


61 
	gRubyReque¡
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

70 
Addr
 
wBa£
 = 
pkt
->
	`g‘Addr
();

71 
Addr
 
wTa
 = 
wBa£
 + 
pkt
->
	`g‘Size
();

72 
Addr
 
mBa£
 = 
m_PhysiÿlAdd»ss
;

73 
Addr
 
mTa
 = 
mBa£
 + 
m_Size
;

75 cÚ¡ 
ušt8_t
 * 
pktD©a
 = 
pkt
->
g‘CÚ¡PŒ
<uint8_t>();

77 
Addr
 
cBa£
 = 
¡d
::
	`max
(
wBa£
, 
mBa£
);

78 
Addr
 
cTa
 = 
¡d
::
	`mš
(
wTa
, 
mTa
);

80 
Addr
 
i
 = 
cBa£
; i < 
cTa
; ++i) {

81 
d©a
[
i
 - 
mBa£
] = 
pktD©a
[˜- 
wBa£
];

84  
cBa£
 < 
cTa
;

85 
	}
}

	@ruby/slicc_interface/RubyRequest.hh

29 #iâdeà
__MEM_RUBY_SLICC_INTERFACE_RUBY_REQUEST_HH__


30 
	#__MEM_RUBY_SLICC_INTERFACE_RUBY_REQUEST_HH__


	)

32 
	~<o¡»am
>

33 
	~<veùÜ
>

35 
	~"mem/´ÙocŞ/HSAScİe.hh
"

36 
	~"mem/´ÙocŞ/HSASegm’t.hh
"

37 
	~"mem/´ÙocŞ/Mes§ge.hh
"

38 
	~"mem/´ÙocŞ/P»ãtchB™.hh
"

39 
	~"mem/´ÙocŞ/RubyAcûssMode.hh
"

40 
	~"mem/´ÙocŞ/RubyReque¡Ty³.hh
"

41 
	~"mem/ruby/commÚ/Add»ss.hh
"

42 
	~"mem/ruby/commÚ/D©aBlock.hh
"

43 
	~"mem/ruby/commÚ/Wr™eMask.hh
"

45 şas 
	cRubyReque¡
 : 
public
 
Mes§ge


47 
public
:

48 
Addr
 
m_PhysiÿlAdd»ss
;

49 
Addr
 
	mm_LšeAdd»ss
;

50 
RubyReque¡Ty³
 
	mm_Ty³
;

51 
Addr
 
	mm_Prog¿mCouÁ”
;

52 
RubyAcûssMode
 
	mm_AcûssMode
;

53 
	mm_Size
;

54 
P»ãtchB™
 
	mm_P»ãtch
;

55 
ušt8_t
* 
	md©a
;

56 
Pack‘PŒ
 
	mm_pkt
;

57 
CÚ‹xtID
 
	mm_cÚ‹xtId
;

58 
Wr™eMask
 
	mm_wr™eMask
;

59 
D©aBlock
 
	mm_WTD©a
;

60 
	mm_wfid
;

61 
HSAScİe
 
	mm_scİe
;

62 
HSASegm’t
 
	mm_£gm’t
;

65 
	$RubyReque¡
(
Tick
 
curTime
, 
ušt64_t
 
_·ddr
, 
ušt8_t
* 
_d©a
, 
_Ën
,

66 
ušt64_t
 
_pc
, 
RubyReque¡Ty³
 
_ty³
, 
RubyAcûssMode
 
_acûss_mode
,

67 
Pack‘PŒ
 
_pkt
, 
P»ãtchB™
 
_pb
 = 
P»ãtchB™_No
,

68 
CÚ‹xtID
 
_´oc_id
 = 100, CÚ‹xtID 
_cÜe_id
 = 99,

69 
HSAScİe
 
_scİe
 = 
HSAScİe_UNSPECIFIED
,

70 
HSASegm’t
 
_£gm’t
 = 
HSASegm’t_GLOBAL
)

71 : 
	`Mes§ge
(
curTime
),

72 
	`m_PhysiÿlAdd»ss
(
_·ddr
),

73 
	`m_Ty³
(
_ty³
),

74 
	`m_Prog¿mCouÁ”
(
_pc
),

75 
	`m_AcûssMode
(
_acûss_mode
),

76 
	`m_Size
(
_Ën
),

77 
	`m_P»ãtch
(
_pb
),

78 
	`d©a
(
_d©a
),

79 
	`m_pkt
(
_pkt
),

80 
	`m_cÚ‹xtId
(
_cÜe_id
),

81 
	`m_scİe
(
_scİe
),

82 
	$m_£gm’t
(
_£gm’t
)

84 
m_LšeAdd»ss
 = 
	`makeLšeAdd»ss
(
m_PhysiÿlAdd»ss
);

87 
	`RubyReque¡
(
Tick
 
curTime
, 
ušt64_t
 
_·ddr
, 
ušt8_t
* 
_d©a
, 
_Ën
,

88 
ušt64_t
 
_pc
, 
RubyReque¡Ty³
 
_ty³
,

89 
RubyAcûssMode
 
_acûss_mode
, 
Pack‘PŒ
 
_pkt
, 
P»ãtchB™
 
_pb
,

90 
_´oc_id
, 
_cÜe_id
,

91 
_wm_size
, 
¡d
::
veùÜ
<
boŞ
> & 
_wm_mask
,

92 
D©aBlock
 & 
_D©a
,

93 
HSAScİe
 
_scİe
 = 
HSAScİe_UNSPECIFIED
,

94 
HSASegm’t
 
_£gm’t
 = 
HSASegm’t_GLOBAL
)

95 : 
	`Mes§ge
(
curTime
),

96 
	`m_PhysiÿlAdd»ss
(
_·ddr
),

97 
	`m_Ty³
(
_ty³
),

98 
	`m_Prog¿mCouÁ”
(
_pc
),

99 
	`m_AcûssMode
(
_acûss_mode
),

100 
	`m_Size
(
_Ën
),

101 
	`m_P»ãtch
(
_pb
),

102 
	`d©a
(
_d©a
),

103 
	`m_pkt
(
_pkt
),

104 
	`m_cÚ‹xtId
(
_cÜe_id
),

105 
	`m_wr™eMask
(
_wm_size
,
_wm_mask
),

106 
	`m_WTD©a
(
_D©a
),

107 
	`m_wfid
(
_´oc_id
),

108 
	`m_scİe
(
_scİe
),

109 
	$m_£gm’t
(
_£gm’t
)

111 
m_LšeAdd»ss
 = 
	`makeLšeAdd»ss
(
m_PhysiÿlAdd»ss
);

112 
	}
}

114 
RubyReque¡
(
Tick
 
curTime
, 
ušt64_t
 
_·ddr
, 
ušt8_t
* 
_d©a
, 
_Ën
,

115 
ušt64_t
 
_pc
, 
RubyReque¡Ty³
 
_ty³
,

116 
RubyAcûssMode
 
_acûss_mode
, 
Pack‘PŒ
 
_pkt
, 
P»ãtchB™
 
_pb
,

117 
_´oc_id
, 
_cÜe_id
,

118 
_wm_size
, 
¡d
::
veùÜ
<
boŞ
> & 
_wm_mask
,

119 
D©aBlock
 & 
_D©a
,

120 
¡d
::
veùÜ
< std::
·œ
<,
AtomicOpFunùÜ
*> > 
_©omicOps
,

121 
HSAScİe
 
_scİe
 = 
HSAScİe_UNSPECIFIED
,

122 
HSASegm’t
 
_£gm’t
 = 
HSASegm’t_GLOBAL
)

123 : 
Mes§ge
(
curTime
),

124 
m_PhysiÿlAdd»ss
(
_·ddr
),

125 
m_Ty³
(
_ty³
),

126 
m_Prog¿mCouÁ”
(
_pc
),

127 
m_AcûssMode
(
_acûss_mode
),

128 
m_Size
(
_Ën
),

129 
m_P»ãtch
(
_pb
),

130 
d©a
(
_d©a
),

131 
m_pkt
(
_pkt
),

132 
m_cÚ‹xtId
(
_cÜe_id
),

133 
m_wr™eMask
(
_wm_size
,
_wm_mask
,
_©omicOps
),

134 
m_WTD©a
(
_D©a
),

135 
m_wfid
(
_´oc_id
),

136 
m_scİe
(
_scİe
),

137 
	$m_£gm’t
(
_£gm’t
)

139 
m_LšeAdd»ss
 = 
	`makeLšeAdd»ss
(
m_PhysiÿlAdd»ss
);

140 
	}
}

143 
	$RubyReque¡
(
Tick
 
curTime
è: 
	$Mes§ge
(
curTime
è{
	}
}

144 
MsgPŒ
 
	$şÚe
() const

145 {  
¡d
::
sh¬ed_±r
<
Mes§ge
>(
Ãw
 
	`RubyReque¡
(*
this
)); 
	}
}

147 
Addr
 
	$g‘LšeAdd»ss
(ècÚ¡ {  
m_LšeAdd»ss
; 
	}
}

148 
Addr
 
	$g‘PhysiÿlAdd»ss
(ècÚ¡ {  
m_PhysiÿlAdd»ss
; 
	}
}

149 cÚ¡ 
	gRubyReque¡Ty³
& 
	$g‘Ty³
(ècÚ¡ {  
m_Ty³
; 
	}
}

150 
Addr
 
	$g‘Prog¿mCouÁ”
(ècÚ¡ {  
m_Prog¿mCouÁ”
; 
	}
}

151 cÚ¡ 
	gRubyAcûssMode
& 
	$g‘AcûssMode
(ècÚ¡ {  
m_AcûssMode
; 
	}
}

152 cÚ¡ & 
	$g‘Size
(ècÚ¡ {  
m_Size
; 
	}
}

153 cÚ¡ 
	gP»ãtchB™
& 
	$g‘P»ãtch
(ècÚ¡ {  
m_P»ãtch
; 
	}
}

155 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

156 
boŞ
 
	`funùiÚ®R—d
(
Pack‘
 *
pkt
);

157 
boŞ
 
	`funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

158 
	}
};

160 
šlše
 
	g¡d
::
o¡»am
&

161 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gRubyReque¡
& 
	gobj
)

163 
	gobj
.
´št
(
out
);

164 
	gout
 << 
	g¡d
::
æush
;

165  
	gout
;

	@ruby/slicc_interface/RubySlicc_ComponentMapping.hh

29 #iâdeà
__MEM_RUBY_SLICC_INTERFACE_RUBYSLICC_COMPONENTMAPPINGS_HH__


30 
	#__MEM_RUBY_SLICC_INTERFACE_RUBYSLICC_COMPONENTMAPPINGS_HH__


	)

32 
	~"mem/´ÙocŞ/MachšeTy³.hh
"

33 
	~"mem/ruby/commÚ/Add»ss.hh
"

34 
	~"mem/ruby/commÚ/MachšeID.hh
"

35 
	~"mem/ruby/commÚ/N‘De¡.hh
"

36 
	~"mem/ruby/¡ruùu»s/DœeùÜyMemÜy.hh
"

40 
šlše
 
NodeID


41 
	$m­_Add»ss_to_DœeùÜyNode
(
Addr
 
addr
)

43  
DœeùÜyMemÜy
::
	`m­Add»ssToDœeùÜyV”siÚ
(
addr
);

44 
	}
}

46 
šlše
 
NodeID


47 
	$m­_Add»ss_to_TCCdœNode
(
Addr
 
addr
)

49  
DœeùÜyMemÜy
::
	`m­Add»ssToDœeùÜyV”siÚ
(
addr
);

50 
	}
}

54 
šlše
 
MachšeID


55 
	$m­_Add»ss_to_DœeùÜy
(
Addr
 
addr
)

57 
MachšeID
 
mach
 =

58 {
MachšeTy³_DœeùÜy
, 
	`m­_Add»ss_to_DœeùÜyNode
(
addr
)};

59  
mach
;

60 
	}
}

62 
šlše
 
MachšeID


63 
	$m­_Add»ss_to_RegiÚDœ
(
Addr
 
addr
)

65 
MachšeID
 
mach
 = {
MachšeTy³_RegiÚDœ
,

66 
	`m­_Add»ss_to_DœeùÜyNode
(
addr
)};

67  
mach
;

68 
	}
}

70 
šlše
 
MachšeID


71 
	$m­_Add»ss_to_TCCdœ
(
Addr
 
addr
)

73 
MachšeID
 
mach
 =

74 {
MachšeTy³_TCCdœ
, 
	`m­_Add»ss_to_TCCdœNode
(
addr
)};

75  
mach
;

76 
	}
}

78 
šlše
 
N‘De¡


79 
	$brßdÿ¡
(
MachšeTy³
 
ty³
)

81 
N‘De¡
 
de¡
;

82 
NodeID
 
i
 = 0; i < 
	`MachšeTy³_ba£_couÁ
(
ty³
); i++) {

83 
MachšeID
 
mach
 = {
ty³
, 
i
};

84 
de¡
.
	`add
(
mach
);

86  
de¡
;

87 
	}
}

89 
šlše
 
MachšeID


90 
	$m­Add»ssToRªge
(
Addr
 
addr
, 
MachšeTy³
 
ty³
, 
low_b™
,

91 
num_b™s
, 
şu¡”_id
 = 0)

93 
MachšeID
 
mach
 = {
ty³
, 0};

94 ià(
num_b™s
 == 0)

95 
mach
.
num
 = 
şu¡”_id
;

97 
mach
.
num
 = 
	`b™S–eù
(
addr
, 
low_b™
,†ow_b™ + 
num_b™s
 - 1)

98 + (1 << 
num_b™s
è* 
şu¡”_id
;

99  
mach
;

100 
	}
}

102 
šlše
 
NodeID


103 
	$machšeIDToNodeID
(
MachšeID
 
machID
)

105  
machID
.
num
;

106 
	}
}

108 
šlše
 
MachšeTy³


109 
	$machšeIDToMachšeTy³
(
MachšeID
 
machID
)

111  
machID
.
ty³
;

112 
	}
}

114 
šlše
 

115 
	$machšeCouÁ
(
MachšeTy³
 
machTy³
)

117  
	`MachšeTy³_ba£_couÁ
(
machTy³
);

118 
	}
}

120 
šlše
 
MachšeID


121 
	$ü—‹MachšeID
(
MachšeTy³
 
ty³
, 
NodeID
 
id
)

123 
MachšeID
 
mach
 = {
ty³
, 
id
};

124  
mach
;

125 
	}
}

127 
šlše
 
MachšeID


128 
	$MachšeTy³AndNodeIDToMachšeID
(
MachšeTy³
 
ty³
, 
NodeID
 
node
)

130 
MachšeID
 
mach
 = {
ty³
, 
node
};

131  
mach
;

132 
	}
}

	@ruby/slicc_interface/RubySlicc_Util.hh

34 #iâdeà
__MEM_RUBY_SLICC_INTERFACE_RUBYSLICCUTIL_HH__


35 
	#__MEM_RUBY_SLICC_INTERFACE_RUBYSLICCUTIL_HH__


	)

37 
	~<ÿs£¹
>

39 
	~"debug/RubySlicc.hh
"

40 
	~"mem/·ck‘.hh
"

41 
	~"mem/ruby/commÚ/Add»ss.hh
"

42 
	~"mem/ruby/commÚ/BoŞVec.hh
"

43 
	~"mem/ruby/commÚ/D©aBlock.hh
"

44 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

45 
	~"mem/ruby/commÚ/Wr™eMask.hh
"

47 
šlše
 
Cyşes
 
	$z”o_time
(è{  
	`Cyşes
(0); 
	}
}

49 
šlše
 
NodeID


50 
	$štToID
(
nod’um
)

52 
NodeID
 
id
 = 
nod’um
;

53  
id
;

54 
	}
}

56 
šlše
 

57 
	$IDToIÁ
(
NodeID
 
id
)

59 
nod’um
 = 
id
;

60  
nod’um
;

61 
	}
}

63 
šlše
 

64 
	$add»ssToIÁ
(
Addr
 
addr
)

66 
	`as£¹
(!(
addr
 & 0xffffffff00000000));

67  
addr
;

68 
	}
}

70 
šlše
 
Addr


71 
	$štToAdd»ss
(
addr
)

73 
	`as£¹
(!(
addr
 & 0xffffffff00000000));

74  
addr
;

75 
	}
}

77 
šlše
 

78 
	$mod
(
v®
, 
mod
)

80  
v®
 % 
mod
;

81 
	}
}

83 
šlše
 
	$max_tok’s
()

86 
	}
}

100 
šlše
 
boŞ


101 
	$‹¡AndR—d
(
Addr
 
addr
, 
D©aBlock
& 
blk
, 
Pack‘
 *
pkt
)

103 
Addr
 
pktLšeAddr
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

104 
Addr
 
lšeAddr
 = 
	`makeLšeAdd»ss
(
addr
);

106 ià(
pktLšeAddr
 =ğ
lšeAddr
) {

107 
ušt8_t
 *
d©a
 = 
pkt
->
g‘PŒ
<uint8_t>();

108 
size_š_by‹s
 = 
pkt
->
	`g‘Size
();

109 
¡¬tBy‹
 = 
pkt
->
	`g‘Addr
(è- 
lšeAddr
;

111 
i
 = 0; i < 
size_š_by‹s
; ++i) {

112 
d©a
[
i
] = 
blk
.
	`g‘By‹
(˜+ 
¡¬tBy‹
);

114  
Œue
;

116  
çl£
;

117 
	}
}

126 
šlše
 
boŞ


127 
	$‹¡AndR—dMask
(
Addr
 
addr
, 
D©aBlock
& 
blk
, 
Wr™eMask
& 
mask
, 
Pack‘
 *
pkt
)

129 
Addr
 
pktLšeAddr
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

130 
Addr
 
lšeAddr
 = 
	`makeLšeAdd»ss
(
addr
);

132 ià(
pktLšeAddr
 =ğ
lšeAddr
) {

133 
ušt8_t
 *
d©a
 = 
pkt
->
g‘PŒ
<uint8_t>();

134 
size_š_by‹s
 = 
pkt
->
	`g‘Size
();

135 
¡¬tBy‹
 = 
pkt
->
	`g‘Addr
(è- 
lšeAddr
;

136 
boŞ
 
was_»ad
 = 
çl£
;

138 
i
 = 0; i < 
size_š_by‹s
; ++i) {

139 ià(
mask
.
	`‹¡
(
i
 + 
¡¬tBy‹
)) {

140 
was_»ad
 = 
Œue
;

141 
d©a
[
i
] = 
blk
.
	`g‘By‹
(˜+ 
¡¬tBy‹
);

144  
was_»ad
;

146  
çl£
;

147 
	}
}

155 
šlše
 
boŞ


156 
	$‹¡AndWr™e
(
Addr
 
addr
, 
D©aBlock
& 
blk
, 
Pack‘
 *
pkt
)

158 
Addr
 
pktLšeAddr
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

159 
Addr
 
lšeAddr
 = 
	`makeLšeAdd»ss
(
addr
);

161 ià(
pktLšeAddr
 =ğ
lšeAddr
) {

162 cÚ¡ 
ušt8_t
 *
d©a
 = 
pkt
->
g‘CÚ¡PŒ
<uint8_t>();

163 
size_š_by‹s
 = 
pkt
->
	`g‘Size
();

164 
¡¬tBy‹
 = 
pkt
->
	`g‘Addr
(è- 
lšeAddr
;

166 
i
 = 0; i < 
size_š_by‹s
; ++i) {

167 
blk
.
	`£tBy‹
(
i
 + 
¡¬tBy‹
, 
d©a
[i]);

169  
Œue
;

171  
çl£
;

172 
	}
}

174 
šlše
 

175 
	$couÁBoŞVec
(
BoŞVec
 
bVec
)

177 
couÁ
 = 0;

178 cÚ¡‡utØ&
™
: 
bVec
) {

179 ià(
™
) {

180 
couÁ
++;

183  
couÁ
;

184 
	}
}

	@ruby/slicc_interface/RubySlicc_includes.hh

29 #iâdeà
__MEM_RUBY_SLICC_INTERFACE_RUBYSLICC_INCLUDES_HH__


30 
	#__MEM_RUBY_SLICC_INTERFACE_RUBYSLICC_INCLUDES_HH__


	)

32 
	~"mem/ruby/¦icc_š‹rçû/RubySlicc_CompÚ’tM­pšg.hh
"

33 
	~"mem/ruby/¦icc_š‹rçû/RubySlicc_Ut.hh
"

	@ruby/structures/AbstractReplacementPolicy.cc

31 
	~"mem/ruby/¡ruùu»s/Ab¡¿ùR•Ïûm’tPŞicy.hh
"

33 
	gAb¡¿ùR•Ïûm’tPŞicy
::
	$Ab¡¿ùR•Ïûm’tPŞicy
(cÚ¡ 
P¬ams
 * 
p
)

34 : 
	$SimObjeù
(
p
)

36 
m_num_£ts
 = 
p
->
size
/p->
block_size
/p->
assoc
;

37 
m_assoc
 = 
p
->
assoc
;

38 
m_Ï¡_»f_±r
 = 
Ãw
 
Tick
*[
m_num_£ts
];

39 
i
 = 0; i < 
m_num_£ts
; i++){

40 
m_Ï¡_»f_±r
[
i
] = 
Ãw
 
Tick
[
m_assoc
];

41 
j
 = 0; j < 
m_assoc
; j++){

42 
m_Ï¡_»f_±r
[
i
][
j
] = 0;

45 
	}
}

47 
Ab¡¿ùR•Ïûm’tPŞicy
 *

48 
	gR•Ïûm’tPŞicyP¬ams
::
	$ü—‹
()

50 
	`çl
("Cannot create‡n AbstractReplacementPolicy");

51  
NULL
;

52 
	}
}

56 
	gAb¡¿ùR•Ïûm’tPŞicy
::~
	$Ab¡¿ùR•Ïûm’tPŞicy
()

58 ià(
m_Ï¡_»f_±r
 !ğ
NULL
){

59 
i
 = 0; i < 
m_num_£ts
; i++){

60 ià(
m_Ï¡_»f_±r
[
i
] !ğ
NULL
){

61 
d–‘e
[] 
m_Ï¡_»f_±r
[
i
];

64 
d–‘e
[] 
m_Ï¡_»f_±r
;

66 
	}
}

68 
Tick


69 
	gAb¡¿ùR•Ïûm’tPŞicy
::
	$g‘La¡Acûss
(
št64_t
 
£t
, iÁ64_ˆ
way
)

71  
m_Ï¡_»f_±r
[
£t
][
way
];

72 
	}
}

	@ruby/structures/AbstractReplacementPolicy.hh

29 #iâdeà
__MEM_RUBY_STRUCTURES_ABSTRACTREPLACEMENTPOLICY_HH__


30 
	#__MEM_RUBY_STRUCTURES_ABSTRACTREPLACEMENTPOLICY_HH__


	)

32 
	~"ba£/ty³s.hh
"

33 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

34 
	~"·¿ms/R•Ïûm’tPŞicy.hh
"

35 
	~"sim/sim_objeù.hh
"

37 
şass
 
	gCacheMemÜy
;

39 şas 
	cAb¡¿ùR•Ïûm’tPŞicy
 : 
public
 
SimObjeù


41 
public
:

42 
R•Ïûm’tPŞicyP¬ams
 
	tP¬ams
;

43 
Ab¡¿ùR•Ïûm’tPŞicy
(cÚ¡ 
P¬ams
 * 
p
);

44 
	mvœtu®
 ~
Ab¡¿ùR•Ïûm’tPŞicy
();

47 
vœtu®
 
touch
(
št64_t
 
£t
, iÁ64_ˆ
way
, 
Tick
 
time
) = 0;

50 
vœtu®
 
št64_t
 
	$g‘Viùim
(
št64_t
 
£t
) const = 0;

53 
Tick
 
	`g‘La¡Acûss
(
št64_t
 
£t
, iÁ64_ˆ
way
);

55 
vœtu®
 
boŞ
 
	$u£Occu·ncy
(ècÚ¡ {  
çl£
; }

57 
	$£tCache
(
CacheMemÜy
 * 
pCache
è{
m_ÿche
 =…Cache;
	}
}

58 
CacheMemÜy
 * 
	gm_ÿche
;

60 
	g´Ùeùed
:

61 
m_num_£ts
;

62 
	gm_assoc
;

63 
Tick
 **
	gm_Ï¡_»f_±r
;

	@ruby/structures/BankedArray.cc

32 
	~"ba£/štm©h.hh
"

33 
	~"mem/ruby/¡ruùu»s/BªkedA¼ay.hh
"

34 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

36 
	gBªkedA¼ay
::
	$BªkedA¼ay
(
bªks
, 
Cyşes
 
acûssL©’cy
,

37 
¡¬tIndexB™
, 
RubySy¡em
 *
rs
)

38 : 
	$m_ruby_sy¡em
(
rs
)

40 
this
->
bªks
 = banks;

41 
this
->
acûssL©’cy
 =‡ccessLatency;

42 
this
->
¡¬tIndexB™
 = startIndexBit;

44 ià(
bªks
 != 0) {

45 
bªkB™s
 = 
	`æoÜLog2
(
bªks
);

48 
busyBªks
.
	`»size
(
bªks
);

49 
	}
}

51 
boŞ


52 
	gBªkedA¼ay
::
	$ŒyAcûss
(
št64_t
 
idx
)

54 ià(
acûssL©’cy
 == 0)

55  
Œue
;

57 
bªk
 = 
	`m­IndexToBªk
(
idx
);

58 
	`as£¹
(
bªk
 < 
bªks
);

60 ià(
busyBªks
[
bªk
].
’dAcûss
 >ğ
	`curTick
()) {

61  
çl£
;

64  
Œue
;

65 
	}
}

68 
	gBªkedA¼ay
::
	$»£rve
(
št64_t
 
idx
)

70 ià(
acûssL©’cy
 == 0)

73 
bªk
 = 
	`m­IndexToBªk
(
idx
);

74 
	`as£¹
(
bªk
 < 
bªks
);

76 ià(
busyBªks
[
bªk
].
’dAcûss
 >ğ
	`curTick
()) {

77 ià(
busyBªks
[
bªk
].
¡¬tAcûss
 =ğ
	`curTick
() &&

78 
busyBªks
[
bªk
].
idx
 == idx) {

83 
	`·nic
("BankedArray„eservationƒrror");

87 
busyBªks
[
bªk
].
idx
 = idx;

88 
busyBªks
[
bªk
].
¡¬tAcûss
 = 
	`curTick
();

89 
busyBªks
[
bªk
].
’dAcûss
 = 
	`curTick
() +

90 (
acûssL©’cy
-1è* 
m_ruby_sy¡em
->
	`şockP”iod
();

91 
	}
}

94 
	gBªkedA¼ay
::
	$m­IndexToBªk
(
št64_t
 
idx
)

96 ià(
bªks
 == 1) {

99  
idx
 % 
bªks
;

100 
	}
}

	@ruby/structures/BankedArray.hh

32 #iâdeà
__MEM_RUBY_STRUCTURES_BANKEDARRAY_HH__


33 
	#__MEM_RUBY_STRUCTURES_BANKEDARRAY_HH__


	)

35 
	~<veùÜ
>

37 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

38 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

39 
	~"sim/cÜe.hh
"

41 şas 
	cBªkedA¼ay


43 
	m´iv©e
:

44 
bªks
;

45 
Cyşes
 
	macûssL©’cy
;

46 
	mbªkB™s
;

47 
	m¡¬tIndexB™
;

48 
RubySy¡em
 *
	mm_ruby_sy¡em
;

50 şas 
	cAcûssRecÜd


52 
	mpublic
:

53 
AcûssRecÜd
(è: 
idx
(0), 
¡¬tAcûss
(0), 
’dAcûss
(0) {}

54 
št64_t
 
	midx
;

55 
Tick
 
	m¡¬tAcûss
;

56 
Tick
 
	m’dAcûss
;

61 
	g¡d
::
veùÜ
<
AcûssRecÜd
> 
busyBªks
;

63 
m­IndexToBªk
(
št64_t
 
idx
);

65 
	gpublic
:

66 
BªkedA¼ay
(
bªks
, 
Cyşes
 
acûssL©’cy
,

67 
¡¬tIndexB™
, 
RubySy¡em
 *
rs
);

71 
boŞ
 
ŒyAcûss
(
št64_t
 
idx
);

73 
»£rve
(
št64_t
 
idx
);

75 
Cyşes
 
	$g‘L©’cy
(ècÚ¡ {  
acûssL©’cy
; 
	}
}

	@ruby/structures/CacheMemory.cc

30 
	~"ba£/štm©h.hh
"

31 
	~"debug/RubyCache.hh
"

32 
	~"debug/RubyCacheT¿û.hh
"

33 
	~"debug/RubyResourûSÎs.hh
"

34 
	~"debug/RubySts.hh
"

35 
	~"mem/´ÙocŞ/AcûssP”missiÚ.hh
"

36 
	~"mem/ruby/¡ruùu»s/CacheMemÜy.hh
"

37 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

38 
	~"mem/ruby/sy¡em/Weigh‹dLRUPŞicy.hh
"

40 
usšg
 
Çme¥aû
 
	g¡d
;

42 
	go¡»am
&

43 
	gİ”©Ü
<<(
	go¡»am
& 
	gout
, cÚ¡ 
	gCacheMemÜy
& 
	gobj
)

45 
	gobj
.
´št
(
out
);

46 
	gout
 << 
	gæush
;

47  
	gout
;

50 
CacheMemÜy
 *

51 
	gRubyCacheP¬ams
::
	$ü—‹
()

53  
Ãw
 
	`CacheMemÜy
(
this
);

54 
	}
}

56 
	gCacheMemÜy
::
	$CacheMemÜy
(cÚ¡ 
P¬ams
 *
p
)

57 : 
	`SimObjeù
(
p
),

58 
	`d©aA¼ay
(
p
->
d©aA¼ayBªks
,…->
d©aAcûssL©’cy
,

59 
p
->
¡¬t_šdex_b™
,…->
ruby_sy¡em
),

60 
	`gA¼ay
(
p
->
gA¼ayBªks
,…->
gAcûssL©’cy
,

61 
p
->
¡¬t_šdex_b™
,…->
ruby_sy¡em
)

63 
m_ÿche_size
 = 
p
->
size
;

64 
m_ÿche_assoc
 = 
p
->
assoc
;

65 
m_»¶aûm’tPŞicy_±r
 = 
p
->
»¶aûm’t_pŞicy
;

66 
m_»¶aûm’tPŞicy_±r
->
	`£tCache
(
this
);

67 
m_¡¬t_šdex_b™
 = 
p
->
¡¬t_šdex_b™
;

68 
m_is_š¡ruùiÚ_Úly_ÿche
 = 
p
->
is_iÿche
;

69 
m_»sourû_¡®ls
 = 
p
->
»sourûSÎs
;

70 
m_block_size
 = 
p
->
block_size
;

71 
	}
}

74 
	gCacheMemÜy
::
	$š™
()

76 ià(
m_block_size
 == 0) {

77 
m_block_size
 = 
RubySy¡em
::
	`g‘BlockSizeBy‹s
();

79 
m_ÿche_num_£ts
 = (
m_ÿche_size
 / 
m_ÿche_assoc
è/ 
m_block_size
;

80 
	`as£¹
(
m_ÿche_num_£ts
 > 1);

81 
m_ÿche_num_£t_b™s
 = 
	`æoÜLog2
(
m_ÿche_num_£ts
);

82 
	`as£¹
(
m_ÿche_num_£t_b™s
 > 0);

84 
m_ÿche
.
	`»size
(
m_ÿche_num_£ts
,

85 
¡d
::
veùÜ
<
Ab¡¿ùCacheEÁry
*>(
m_ÿche_assoc
, 
nuÎ±r
));

86 
	}
}

88 
	gCacheMemÜy
::~
	$CacheMemÜy
()

90 ià(
m_»¶aûm’tPŞicy_±r
)

91 
d–‘e
 
m_»¶aûm’tPŞicy_±r
;

92 
i
 = 0; i < 
m_ÿche_num_£ts
; i++) {

93 
j
 = 0; j < 
m_ÿche_assoc
; j++) {

94 
d–‘e
 
m_ÿche
[
i
][
j
];

97 
	}
}

100 
št64_t


101 
	gCacheMemÜy
::
	$add»ssToCacheS‘
(
Addr
 
add»ss
) const

103 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

104  
	`b™S–eù
(
add»ss
, 
m_¡¬t_šdex_b™
,

105 
m_¡¬t_šdex_b™
 + 
m_ÿche_num_£t_b™s
 - 1);

106 
	}
}

111 
	gCacheMemÜy
::
	$fšdTagInS‘
(
št64_t
 
ÿcheS‘
, 
Addr
 
g
) const

113 
	`as£¹
(
g
 =ğ
	`makeLšeAdd»ss
(tag));

115 autØ
™
 = 
m_g_šdex
.
	`fšd
(
g
);

116 ià(
™
 !ğ
m_g_šdex
.
	`’d
())

117 ià(
m_ÿche
[
ÿcheS‘
][
™
->
£cÚd
]->
m_P”missiÚ
 !=

118 
AcûssP”missiÚ_NÙP»£Á
)

119  
™
->
£cÚd
;

121 
	}
}

126 
	gCacheMemÜy
::
	$fšdTagInS‘IgnÜeP”missiÚs
(
št64_t
 
ÿcheS‘
,

127 
Addr
 
g
) const

129 
	`as£¹
(
g
 =ğ
	`makeLšeAdd»ss
(tag));

131 autØ
™
 = 
m_g_šdex
.
	`fšd
(
g
);

132 ià(
™
 !ğ
m_g_šdex
.
	`’d
())

133  
™
->
£cÚd
;

135 
	}
}

140 
Addr


141 
	gCacheMemÜy
::
	$g‘Add»ssAtIdx
(
idx
) const

143 
Addr
 
	`tmp
(0);

145 
£t
 = 
idx
 / 
m_ÿche_assoc
;

146 
	`as£¹
(
£t
 < 
m_ÿche_num_£ts
);

148 
way
 = 
idx
 - 
£t
 * 
m_ÿche_assoc
;

149 
	`as£¹
 (
way
 < 
m_ÿche_assoc
);

151 
Ab¡¿ùCacheEÁry
* 
’Œy
 = 
m_ÿche
[
£t
][
way
];

152 ià(
’Œy
 =ğ
NULL
 ||

153 
’Œy
->
m_P”missiÚ
 =ğ
AcûssP”missiÚ_Inv®id
 ||

154 
’Œy
->
m_P”missiÚ
 =ğ
AcûssP”missiÚ_NÙP»£Á
) {

155  
tmp
;

157  
’Œy
->
m_Add»ss
;

158 
	}
}

160 
boŞ


161 
	gCacheMemÜy
::
	$ŒyCacheAcûss
(
Addr
 
add»ss
, 
RubyReque¡Ty³
 
ty³
,

162 
D©aBlock
*& 
d©a_±r
)

164 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

165 
	`DPRINTF
(
RubyCache
, "add»ss: %#x\n", 
add»ss
);

166 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

167 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

168 ià(
loc
 != -1) {

170 
Ab¡¿ùCacheEÁry
* 
’Œy
 = 
m_ÿche
[
ÿcheS‘
][
loc
];

171 
m_»¶aûm’tPŞicy_±r
->
	`touch
(
ÿcheS‘
, 
loc
, 
	`curTick
());

172 
d©a_±r
 = &(
’Œy
->
	`g‘D©aBlk
());

174 ià(
’Œy
->
m_P”missiÚ
 =ğ
AcûssP”missiÚ_R—d_Wr™e
) {

175  
Œue
;

177 ià((
’Œy
->
m_P”missiÚ
 =ğ
AcûssP”missiÚ_R—d_OÆy
) &&

178 (
ty³
 =ğ
RubyReque¡Ty³_LD
 ||y³ =ğ
RubyReque¡Ty³_IFETCH
)) {

179  
Œue
;

183 
d©a_±r
 = 
NULL
;

184  
çl£
;

185 
	}
}

187 
boŞ


188 
	gCacheMemÜy
::
	$‹¡CacheAcûss
(
Addr
 
add»ss
, 
RubyReque¡Ty³
 
ty³
,

189 
D©aBlock
*& 
d©a_±r
)

191 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

192 
	`DPRINTF
(
RubyCache
, "add»ss: %#x\n", 
add»ss
);

193 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

194 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

196 ià(
loc
 != -1) {

198 
Ab¡¿ùCacheEÁry
* 
’Œy
 = 
m_ÿche
[
ÿcheS‘
][
loc
];

199 
m_»¶aûm’tPŞicy_±r
->
	`touch
(
ÿcheS‘
, 
loc
, 
	`curTick
());

200 
d©a_±r
 = &(
’Œy
->
	`g‘D©aBlk
());

202  
m_ÿche
[
ÿcheS‘
][
loc
]->
m_P”missiÚ
 !=

203 
AcûssP”missiÚ_NÙP»£Á
;

206 
d©a_±r
 = 
NULL
;

207  
çl£
;

208 
	}
}

211 
boŞ


212 
	gCacheMemÜy
::
	$isTagP»£Á
(
Addr
 
add»ss
) const

214 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

215 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

216 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

218 ià(
loc
 == -1) {

220 
	`DPRINTF
(
RubyCache
, "NØg m©ch fÜ‡dd»ss: %#x\n", 
add»ss
);

221  
çl£
;

223 
	`DPRINTF
(
RubyCache
, "add»ss: %#x found\n", 
add»ss
);

224  
Œue
;

225 
	}
}

230 
boŞ


231 
	gCacheMemÜy
::
	$ÿcheAva
(
Addr
 
add»ss
) const

233 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

235 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

237 
i
 = 0; i < 
m_ÿche_assoc
; i++) {

238 
Ab¡¿ùCacheEÁry
* 
’Œy
 = 
m_ÿche
[
ÿcheS‘
][
i
];

239 ià(
’Œy
 !ğ
NULL
) {

240 ià(
’Œy
->
m_Add»ss
 =ğ
add»ss
 ||

241 
’Œy
->
m_P”missiÚ
 =ğ
AcûssP”missiÚ_NÙP»£Á
) {

243  
Œue
;

246  
Œue
;

249  
çl£
;

250 
	}
}

252 
Ab¡¿ùCacheEÁry
*

253 
	gCacheMemÜy
::
	$®loÿ‹
(
Addr
 
add»ss
, 
Ab¡¿ùCacheEÁry
 *
’Œy
, 
boŞ
 
touch
)

255 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

256 
	`as£¹
(!
	`isTagP»£Á
(
add»ss
));

257 
	`as£¹
(
	`ÿcheAva
(
add»ss
));

258 
	`DPRINTF
(
RubyCache
, "add»ss: %#x\n", 
add»ss
);

261 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

262 
¡d
::
veùÜ
<
Ab¡¿ùCacheEÁry
*> &
£t
 = 
m_ÿche
[
ÿcheS‘
];

263 
i
 = 0; i < 
m_ÿche_assoc
; i++) {

264 ià(!
£t
[
i
] || s‘[i]->
m_P”missiÚ
 =ğ
AcûssP”missiÚ_NÙP»£Á
) {

265 ià(
£t
[
i
] && (£t[i] !ğ
’Œy
)) {

266 
	`w¬n_Úû
("This…rotocol contains‡ cacheƒntry handling bug: "

270 
add»ss
);

272 
£t
[
i
] = 
’Œy
;

273 
£t
[
i
]->
m_Add»ss
 = 
add»ss
;

274 
£t
[
i
]->
m_P”missiÚ
 = 
AcûssP”missiÚ_Inv®id
;

275 
	`DPRINTF
(
RubyCache
, "Allocate clearing†ock for‡ddr: %x\n",

276 
add»ss
);

277 
£t
[
i
]->
m_locked
 = -1;

278 
m_g_šdex
[
add»ss
] = 
i
;

279 
’Œy
->
	`£tS‘Index
(
ÿcheS‘
);

280 
’Œy
->
	`£tWayIndex
(
i
);

282 ià(
touch
) {

283 
m_»¶aûm’tPŞicy_±r
->
	`touch
(
ÿcheS‘
, 
i
, 
	`curTick
());

286  
’Œy
;

289 
	`·nic
("Allocate didn't find‡n‡vailableƒntry");

290 
	}
}

293 
	gCacheMemÜy
::
	$d—Îoÿ‹
(
Addr
 
add»ss
)

295 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

296 
	`as£¹
(
	`isTagP»£Á
(
add»ss
));

297 
	`DPRINTF
(
RubyCache
, "add»ss: %#x\n", 
add»ss
);

298 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

299 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

300 ià(
loc
 != -1) {

301 
d–‘e
 
m_ÿche
[
ÿcheS‘
][
loc
];

302 
m_ÿche
[
ÿcheS‘
][
loc
] = 
NULL
;

303 
m_g_šdex
.
	`”a£
(
add»ss
);

305 
	}
}

308 
Addr


309 
	gCacheMemÜy
::
	$ÿcheProbe
(
Addr
 
add»ss
) const

311 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

312 
	`as£¹
(!
	`ÿcheAva
(
add»ss
));

314 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

315  
m_ÿche
[
ÿcheS‘
][
m_»¶aûm’tPŞicy_±r
->
	`g‘Viùim
(cacheSet)]->

316 
m_Add»ss
;

317 
	}
}

320 
Ab¡¿ùCacheEÁry
*

321 
	gCacheMemÜy
::
	$lookup
(
Addr
 
add»ss
)

323 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

324 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

325 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

326 ià(
loc
 =ğ-1è 
NULL
;

327  
m_ÿche
[
ÿcheS‘
][
loc
];

328 
	}
}

331 cÚ¡ 
Ab¡¿ùCacheEÁry
*

332 
	gCacheMemÜy
::
	$lookup
(
Addr
 
add»ss
) const

334 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

335 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

336 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

337 ià(
loc
 =ğ-1è 
NULL
;

338  
m_ÿche
[
ÿcheS‘
][
loc
];

339 
	}
}

343 
	gCacheMemÜy
::
	$£tMRU
(
Addr
 
add»ss
)

345 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

346 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

348 ià(
loc
 != -1)

349 
m_»¶aûm’tPŞicy_±r
->
	`touch
(
ÿcheS‘
, 
loc
, 
	`curTick
());

350 
	}
}

353 
	gCacheMemÜy
::
	$£tMRU
(cÚ¡ 
Ab¡¿ùCacheEÁry
 *
e
)

355 
ušt32_t
 
ÿcheS‘
 = 
e
->
	`g‘S‘Index
();

356 
ušt32_t
 
loc
 = 
e
->
	`g‘WayIndex
();

357 
m_»¶aûm’tPŞicy_±r
->
	`touch
(
ÿcheS‘
, 
loc
, 
	`curTick
());

358 
	}
}

361 
	gCacheMemÜy
::
	$£tMRU
(
Addr
 
add»ss
, 
occu·ncy
)

363 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

364 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

366 ià(
loc
 != -1) {

367 ià(
m_»¶aûm’tPŞicy_±r
->
	`u£Occu·ncy
()) {

368 (
¡©ic_ÿ¡
<
Weigh‹dLRUPŞicy
*>(
m_»¶aûm’tPŞicy_±r
))->

369 
	`touch
(
ÿcheS‘
, 
loc
, 
	`curTick
(), 
occu·ncy
);

371 
m_»¶aûm’tPŞicy_±r
->

372 
	`touch
(
ÿcheS‘
, 
loc
, 
	`curTick
());

375 
	}
}

378 
	gCacheMemÜy
::
	$g‘R•Ïûm’tWeight
(
št64_t
 
£t
, iÁ64_ˆ
loc
)

380 
	`as£¹
(
£t
 < 
m_ÿche_num_£ts
);

381 
	`as£¹
(
loc
 < 
m_ÿche_assoc
);

382 
»t
 = 0;

383 ià(
m_ÿche
[
£t
][
loc
] !ğ
NULL
) {

384 
»t
 = 
m_ÿche
[
£t
][
loc
]->
	`g‘NumV®idBlocks
();

385 
	`as£¹
(
»t
 >= 0);

388  
»t
;

389 
	}
}

392 
	gCacheMemÜy
::
	$»cÜdCacheCÚ‹Ás
(
úŒl
, 
CacheRecÜd”
* 
Œ
) const

394 
ušt64_t
 
w¬medUpBlocks
 = 0;

395 
ušt64_t
 
tÙ®Blocks
 
M5_VAR_USED
 = (ušt64_t)
m_ÿche_num_£ts
 *

396 (
ušt64_t
)
m_ÿche_assoc
;

398 
i
 = 0; i < 
m_ÿche_num_£ts
; i++) {

399 
j
 = 0; j < 
m_ÿche_assoc
; j++) {

400 ià(
m_ÿche
[
i
][
j
] !ğ
NULL
) {

401 
AcûssP”missiÚ
 
³rm
 = 
m_ÿche
[
i
][
j
]->
m_P”missiÚ
;

402 
RubyReque¡Ty³
 
»que¡_ty³
 = 
RubyReque¡Ty³_NULL
;

403 ià(
³rm
 =ğ
AcûssP”missiÚ_R—d_OÆy
) {

404 ià(
m_is_š¡ruùiÚ_Úly_ÿche
) {

405 
»que¡_ty³
 = 
RubyReque¡Ty³_IFETCH
;

407 
»que¡_ty³
 = 
RubyReque¡Ty³_LD
;

409 } ià(
³rm
 =ğ
AcûssP”missiÚ_R—d_Wr™e
) {

410 
»que¡_ty³
 = 
RubyReque¡Ty³_ST
;

413 ià(
»que¡_ty³
 !ğ
RubyReque¡Ty³_NULL
) {

414 
Œ
->
	`addRecÜd
(
úŒl
, 
m_ÿche
[
i
][
j
]->
m_Add»ss
,

415 0, 
»que¡_ty³
,

416 
m_»¶aûm’tPŞicy_±r
->
	`g‘La¡Acûss
(
i
, 
j
),

417 
m_ÿche
[
i
][
j
]->
	`g‘D©aBlk
());

418 
w¬medUpBlocks
++;

424 
	`DPRINTF
(
RubyCacheT¿û
, "%s: %lli blocks of %lliotal blocks"

425 "»cÜded %.2f%% \n", 
	`Çme
().
	`c_¡r
(), 
w¬medUpBlocks
,

426 
tÙ®Blocks
, ((
w¬medUpBlocks
) / (totalBlocks)) * 100.0);

427 
	}
}

430 
	gCacheMemÜy
::
	$´št
(
o¡»am
& 
out
) const

432 
out
 << "Cachdump: " << 
	`Çme
(è<< 
’dl
;

433 
i
 = 0; i < 
m_ÿche_num_£ts
; i++) {

434 
j
 = 0; j < 
m_ÿche_assoc
; j++) {

435 ià(
m_ÿche
[
i
][
j
] !ğ
NULL
) {

436 
out
 << " Index: " << 
i


437 << " way: " << 
j


438 << "ƒÁry: " << *
m_ÿche
[
i
][
j
] << 
’dl
;

440 
out
 << " Index: " << 
i


441 << " way: " << 
j


442 << "ƒÁry: NULL" << 
’dl
;

446 
	}
}

449 
	gCacheMemÜy
::
	$´štD©a
(
o¡»am
& 
out
) const

451 
out
 << "´štD©a(ènÙ suµÜ‹d" << 
’dl
;

452 
	}
}

455 
	gCacheMemÜy
::
	$£tLocked
(
Addr
 
add»ss
, 
cÚ‹xt
)

457 
	`DPRINTF
(
RubyCache
, "S‘tšg Lock fÜ‡ddr: %#xØ%d\n", 
add»ss
, 
cÚ‹xt
);

458 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

459 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

460 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

461 
	`as£¹
(
loc
 != -1);

462 
m_ÿche
[
ÿcheS‘
][
loc
]->
	`£tLocked
(
cÚ‹xt
);

463 
	}
}

466 
	gCacheMemÜy
::
	$ş—rLocked
(
Addr
 
add»ss
)

468 
	`DPRINTF
(
RubyCache
, "CË¬ Lock fÜ‡ddr: %#x\n", 
add»ss
);

469 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

470 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

471 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

472 
	`as£¹
(
loc
 != -1);

473 
m_ÿche
[
ÿcheS‘
][
loc
]->
	`ş—rLocked
();

474 
	}
}

476 
boŞ


477 
	gCacheMemÜy
::
	$isLocked
(
Addr
 
add»ss
, 
cÚ‹xt
)

479 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

480 
št64_t
 
ÿcheS‘
 = 
	`add»ssToCacheS‘
(
add»ss
);

481 
loc
 = 
	`fšdTagInS‘
(
ÿcheS‘
, 
add»ss
);

482 
	`as£¹
(
loc
 != -1);

483 
	`DPRINTF
(
RubyCache
, "Testing Lock for‡ddr: %#llx cur %d con %d\n",

484 
add»ss
, 
m_ÿche
[
ÿcheS‘
][
loc
]->
m_locked
, 
cÚ‹xt
);

485  
m_ÿche
[
ÿcheS‘
][
loc
]->
	`isLocked
(
cÚ‹xt
);

486 
	}
}

489 
	gCacheMemÜy
::
	$»gSts
()

491 
SimObjeù
::
	`»gSts
();

493 
m_demªd_h™s


494 .
	`Çme
(name() + ".demand_hits")

495 .
	`desc
("Number of cache demand hits")

498 
m_demªd_mis£s


499 .
	`Çme
(name() + ".demand_misses")

500 .
	`desc
("Number of cache demand misses")

503 
m_demªd_acûs£s


504 .
	`Çme
(name() + ".demand_accesses")

505 .
	`desc
("Number of cache demand‡ccesses")

508 
m_demªd_acûs£s
 = 
m_demªd_h™s
 + 
m_demªd_mis£s
;

510 
m_sw_´eãtches


511 .
	`Çme
(name() + ".total_sw_prefetches")

512 .
	`desc
("Number of software…refetches")

513 .
	`æags
(
Sts
::
noz”o
)

516 
m_hw_´eãtches


517 .
	`Çme
(name() + ".total_hw_prefetches")

518 .
	`desc
("Number of hardware…refetches")

519 .
	`æags
(
Sts
::
noz”o
)

522 
m_´eãtches


523 .
	`Çme
(name() + ".total_prefetches")

524 .
	`desc
("Number of…refetches")

525 .
	`æags
(
Sts
::
noz”o
)

528 
m_´eãtches
 = 
m_sw_´eãtches
 + 
m_hw_´eãtches
;

530 
m_acûssModeTy³


531 .
	`š™
(
RubyReque¡Ty³_NUM
)

532 .
	`Çme
(name() + ".access_mode")

533 .
	`æags
(
Sts
::
pdf
 | Sts::
tÙ®
)

535 
i
 = 0; i < 
RubyAcûssMode_NUM
; i++) {

536 
m_acûssModeTy³


537 .
	`subÇme
(
i
, 
	`RubyAcûssMode_to_¡ršg
(
	`RubyAcûssMode
(i)))

538 .
	`æags
(
Sts
::
noz”o
)

542 
numD©aA¼ayR—ds


543 .
	`Çme
(name() + ".num_data_array_reads")

544 .
	`desc
("number of data‡rray„eads")

545 .
	`æags
(
Sts
::
noz”o
)

548 
numD©aA¼ayWr™es


549 .
	`Çme
(name() + ".num_data_array_writes")

550 .
	`desc
("number of data‡rray writes")

551 .
	`æags
(
Sts
::
noz”o
)

554 
numTagA¼ayR—ds


555 .
	`Çme
(name() + ".num_tag_array_reads")

556 .
	`desc
("number ofag‡rray„eads")

557 .
	`æags
(
Sts
::
noz”o
)

560 
numTagA¼ayWr™es


561 .
	`Çme
(name() + ".num_tag_array_writes")

562 .
	`desc
("number ofag‡rray writes")

563 .
	`æags
(
Sts
::
noz”o
)

566 
numTagA¼aySÎs


567 .
	`Çme
(name() + ".num_tag_array_stalls")

568 .
	`desc
("number of stalls caused byag‡rray")

569 .
	`æags
(
Sts
::
noz”o
)

572 
numD©aA¼aySÎs


573 .
	`Çme
(name() + ".num_data_array_stalls")

574 .
	`desc
("number of stalls caused by data‡rray")

575 .
	`æags
(
Sts
::
noz”o
)

577 
	}
}

582 
	gCacheMemÜy
::
	$»cÜdReque¡Ty³
(
CacheReque¡Ty³
 
»que¡Ty³
, 
Addr
 
addr
)

584 
	`DPRINTF
(
RubySts
, "Recorded statistic: %s\n",

585 
	`CacheReque¡Ty³_to_¡ršg
(
»que¡Ty³
));

586 
»que¡Ty³
) {

587 
CacheReque¡Ty³_D©aA¼ayR—d
:

588 ià(
m_»sourû_¡®ls
)

589 
d©aA¼ay
.
	`»£rve
(
	`add»ssToCacheS‘
(
addr
));

590 
numD©aA¼ayR—ds
++;

592 
CacheReque¡Ty³_D©aA¼ayWr™e
:

593 ià(
m_»sourû_¡®ls
)

594 
d©aA¼ay
.
	`»£rve
(
	`add»ssToCacheS‘
(
addr
));

595 
numD©aA¼ayWr™es
++;

597 
CacheReque¡Ty³_TagA¼ayR—d
:

598 ià(
m_»sourû_¡®ls
)

599 
gA¼ay
.
	`»£rve
(
	`add»ssToCacheS‘
(
addr
));

600 
numTagA¼ayR—ds
++;

602 
CacheReque¡Ty³_TagA¼ayWr™e
:

603 ià(
m_»sourû_¡®ls
)

604 
gA¼ay
.
	`»£rve
(
	`add»ssToCacheS‘
(
addr
));

605 
numTagA¼ayWr™es
++;

608 
	`w¬n
("CacheMemory‡ccess_type‚ot found: %s",

609 
	`CacheReque¡Ty³_to_¡ršg
(
»que¡Ty³
));

611 
	}
}

613 
boŞ


614 
	gCacheMemÜy
::
	$checkResourûAvaabË
(
CacheResourûTy³
 
»s
, 
Addr
 
addr
)

616 ià(!
m_»sourû_¡®ls
) {

617  
Œue
;

620 ià(
»s
 =ğ
CacheResourûTy³_TagA¼ay
) {

621 ià(
gA¼ay
.
	`ŒyAcûss
(
	`add»ssToCacheS‘
(
addr
))è 
Œue
;

623 
	`DPRINTF
(
RubyResourûSÎs
,

625 
addr
, 
	`add»ssToCacheS‘
(addr));

626 
numTagA¼aySÎs
++;

627  
çl£
;

629 } ià(
»s
 =ğ
CacheResourûTy³_D©aA¼ay
) {

630 ià(
d©aA¼ay
.
	`ŒyAcûss
(
	`add»ssToCacheS‘
(
addr
))è 
Œue
;

632 
	`DPRINTF
(
RubyResourûSÎs
,

634 
addr
, 
	`add»ssToCacheS‘
(addr));

635 
numD©aA¼aySÎs
++;

636  
çl£
;

639 
	`as£¹
(
çl£
);

640  
Œue
;

642 
	}
}

644 
boŞ


645 
	gCacheMemÜy
::
	$isBlockInv®id
(
št64_t
 
ÿche_£t
, iÁ64_ˆ
loc
)

647  (
m_ÿche
[
ÿche_£t
][
loc
]->
m_P”missiÚ
 =ğ
AcûssP”missiÚ_Inv®id
);

648 
	}
}

650 
boŞ


651 
	gCacheMemÜy
::
	$isBlockNÙBusy
(
št64_t
 
ÿche_£t
, iÁ64_ˆ
loc
)

653  (
m_ÿche
[
ÿche_£t
][
loc
]->
m_P”missiÚ
 !ğ
AcûssP”missiÚ_Busy
);

654 
	}
}

	@ruby/structures/CacheMemory.hh

30 #iâdeà
__MEM_RUBY_STRUCTURES_CACHEMEMORY_HH__


31 
	#__MEM_RUBY_STRUCTURES_CACHEMEMORY_HH__


	)

33 
	~<¡ršg
>

34 
	~<unÜd”ed_m­
>

35 
	~<veùÜ
>

37 
	~"ba£/¡©i¡ics.hh
"

38 
	~"mem/´ÙocŞ/CacheReque¡Ty³.hh
"

39 
	~"mem/´ÙocŞ/CacheResourûTy³.hh
"

40 
	~"mem/´ÙocŞ/RubyReque¡.hh
"

41 
	~"mem/ruby/commÚ/D©aBlock.hh
"

42 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCacheEÁry.hh
"

43 
	~"mem/ruby/¦icc_š‹rçû/RubySlicc_CompÚ’tM­pšg.hh
"

44 
	~"mem/ruby/¡ruùu»s/Ab¡¿ùR•Ïûm’tPŞicy.hh
"

45 
	~"mem/ruby/¡ruùu»s/BªkedA¼ay.hh
"

46 
	~"mem/ruby/sy¡em/CacheRecÜd”.hh
"

47 
	~"·¿ms/RubyCache.hh
"

48 
	~"sim/sim_objeù.hh
"

50 şas 
	cCacheMemÜy
 : 
public
 
SimObjeù


52 
public
:

53 
RubyCacheP¬ams
 
	tP¬ams
;

54 
CacheMemÜy
(cÚ¡ 
P¬ams
 *
p
);

55 ~
CacheMemÜy
();

57 
š™
();

61 
boŞ
 
ŒyCacheAcûss
(
Addr
 
add»ss
, 
RubyReque¡Ty³
 
ty³
,

62 
D©aBlock
*& 
d©a_±r
);

65 
boŞ
 
‹¡CacheAcûss
(
Addr
 
add»ss
, 
RubyReque¡Ty³
 
ty³
,

66 
D©aBlock
*& 
d©a_±r
);

69 
boŞ
 
	$isTagP»£Á
(
Addr
 
add»ss
) const;

74 
boŞ
 
	$ÿcheAva
(
Addr
 
add»ss
) const;

77 
Ab¡¿ùCacheEÁry
* 
	`®loÿ‹
(
Addr
 
add»ss
,

78 
Ab¡¿ùCacheEÁry
* 
Ãw_’Œy
, 
boŞ
 
touch
);

79 
Ab¡¿ùCacheEÁry
* 
	$®loÿ‹
(
Addr
 
add»ss
, 
Ab¡¿ùCacheEÁry
* 
Ãw_’Œy
)

81  
	`®loÿ‹
(
add»ss
, 
Ãw_’Œy
, 
Œue
);

83 
	$®loÿ‹Void
(
Addr
 
add»ss
, 
Ab¡¿ùCacheEÁry
* 
Ãw_’Œy
)

85 
	`®loÿ‹
(
add»ss
, 
Ãw_’Œy
, 
Œue
);

86 
	}
}

89 
d—Îoÿ‹
(
Addr
 
add»ss
);

92 
Addr
 
	$ÿcheProbe
(
Addr
 
add»ss
) const;

95 
Ab¡¿ùCacheEÁry
* 
	`lookup
(
Addr
 
add»ss
);

96 cÚ¡ 
Ab¡¿ùCacheEÁry
* 
	$lookup
(
Addr
 
add»ss
) const;

98 
Cyşes
 
	$g‘TagL©’cy
(ècÚ¡ {  
gA¼ay
.
	`g‘L©’cy
(); 
	}
}

99 
Cyşes
 
	$g‘D©aL©’cy
(ècÚ¡ {  
d©aA¼ay
.
	`g‘L©’cy
(); 
	}
}

101 
boŞ
 
isBlockInv®id
(
št64_t
 
ÿche_£t
, iÁ64_ˆ
loc
);

102 
boŞ
 
isBlockNÙBusy
(
št64_t
 
ÿche_£t
, iÁ64_ˆ
loc
);

105 
	$»cÜdCacheCÚ‹Ás
(
úŒl
, 
CacheRecÜd”
* 
Œ
) const;

108 
	`£tMRU
(
Addr
 
add»ss
);

109 
	`£tMRU
(
Addr
 
addr
, 
occu·ncy
);

110 
	`g‘R•Ïûm’tWeight
(
št64_t
 
£t
, iÁ64_ˆ
loc
);

111 
	`£tMRU
(cÚ¡ 
Ab¡¿ùCacheEÁry
 *
e
);

118 
	`£tLocked
 (
Addr
 
addr
, 
cÚ‹xt
);

119 
	`ş—rLocked
 (
Addr
 
addr
);

120 
boŞ
 
	`isLocked
 (
Addr
 
addr
, 
cÚ‹xt
);

123 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

124 
	$´štD©a
(
¡d
::
o¡»am
& 
out
) const;

126 
	`»gSts
();

127 
boŞ
 
	`checkResourûAvaabË
(
CacheResourûTy³
 
»s
, 
Addr
 
addr
);

128 
	`»cÜdReque¡Ty³
(
CacheReque¡Ty³
 
»que¡Ty³
, 
Addr
 
addr
);

130 
public
:

131 
Sts
::
SÿÏr
 
m_demªd_h™s
;

132 
Sts
::
SÿÏr
 
m_demªd_mis£s
;

133 
Sts
::
FÜmuÏ
 
m_demªd_acûs£s
;

135 
Sts
::
SÿÏr
 
m_sw_´eãtches
;

136 
Sts
::
SÿÏr
 
m_hw_´eãtches
;

137 
Sts
::
FÜmuÏ
 
m_´eãtches
;

139 
Sts
::
VeùÜ
 
m_acûssModeTy³
;

141 
Sts
::
SÿÏr
 
numD©aA¼ayR—ds
;

142 
Sts
::
SÿÏr
 
numD©aA¼ayWr™es
;

143 
Sts
::
SÿÏr
 
numTagA¼ayR—ds
;

144 
Sts
::
SÿÏr
 
numTagA¼ayWr™es
;

146 
Sts
::
SÿÏr
 
numTagA¼aySÎs
;

147 
Sts
::
SÿÏr
 
numD©aA¼aySÎs
;

149 
	$g‘CacheSize
(ècÚ¡ {  
m_ÿche_size
; 
	}
}

150 
	$g‘CacheAssoc
(ècÚ¡ {  
m_ÿche_assoc
; 
	}
}

151 
	$g‘NumBlocks
(ècÚ¡ {  
m_ÿche_num_£ts
 * 
m_ÿche_assoc
; 
	}
}

152 
Addr
 
	$g‘Add»ssAtIdx
(
idx
) const;

154 
´iv©e
:

156 
št64_t
 
	$add»ssToCacheS‘
(
Addr
 
add»ss
) const;

160 
	$fšdTagInS‘
(
št64_t
 
lše
, 
Addr
 
g
) const;

161 
	$fšdTagInS‘IgnÜeP”missiÚs
(
št64_t
 
ÿcheS‘
, 
Addr
 
g
) const;

164 
	`CacheMemÜy
(cÚ¡ 
CacheMemÜy
& 
obj
);

165 
CacheMemÜy
& 
İ”©Ü
=(cÚ¡ CacheMemÜy& 
obj
);

167 
´iv©e
:

169 
boŞ
 
m_is_š¡ruùiÚ_Úly_ÿche
;

173 
¡d
::
unÜd”ed_m­
<
Addr
, > 
m_g_šdex
;

174 
¡d
::
veùÜ
<¡d::veùÜ<
Ab¡¿ùCacheEÁry
*> > 
m_ÿche
;

176 
Ab¡¿ùR•Ïûm’tPŞicy
 *
m_»¶aûm’tPŞicy_±r
;

178 
BªkedA¼ay
 
d©aA¼ay
;

179 
BªkedA¼ay
 
gA¼ay
;

181 
m_ÿche_size
;

182 
m_ÿche_num_£ts
;

183 
m_ÿche_num_£t_b™s
;

184 
m_ÿche_assoc
;

185 
m_¡¬t_šdex_b™
;

186 
boŞ
 
m_»sourû_¡®ls
;

187 
m_block_size
;

188 
	}
};

190 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gCacheMemÜy
& 
	gobj
);

	@ruby/structures/DirectoryMemory.cc

29 
	~"ba£/štm©h.hh
"

30 
	~"debug/RubyCache.hh
"

31 
	~"debug/RubySts.hh
"

32 
	~"mem/ruby/¦icc_š‹rçû/RubySlicc_Ut.hh
"

33 
	~"mem/ruby/¡ruùu»s/DœeùÜyMemÜy.hh
"

34 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

36 
usšg
 
Çme¥aû
 
	g¡d
;

38 
	gDœeùÜyMemÜy
::
m_num_dœeùÜ›s
 = 0;

39 
	gDœeùÜyMemÜy
::
m_num_dœeùÜ›s_b™s
 = 0;

40 
	gDœeùÜyMemÜy
::
m_numa_high_b™
 = 0;

42 
	gDœeùÜyMemÜy
::
	$DœeùÜyMemÜy
(cÚ¡ 
P¬ams
 *
p
)

43 : 
	$SimObjeù
(
p
)

45 
m_v”siÚ
 = 
p
->
v”siÚ
;

46 
m_size_by‹s
 = 
p
->
size
;

47 
m_size_b™s
 = 
	`æoÜLog2
(
m_size_by‹s
);

48 
m_num_’Œ›s
 = 0;

49 
m_numa_high_b™
 = 
p
->
numa_high_b™
;

50 
	}
}

53 
	gDœeùÜyMemÜy
::
	$š™
()

55 
m_num_’Œ›s
 = 
m_size_by‹s
 / 
RubySy¡em
::
	`g‘BlockSizeBy‹s
();

56 
m_’Œ›s
 = 
Ãw
 
Ab¡¿ùEÁry
*[
m_num_’Œ›s
];

57 
i
 = 0; i < 
m_num_’Œ›s
; i++)

58 
m_’Œ›s
[
i
] = 
NULL
;

60 
m_num_dœeùÜ›s
++;

61 
m_num_dœeùÜ›s_b™s
 = 
	`ûLog2
(
m_num_dœeùÜ›s
);

63 ià(
m_numa_high_b™
 == 0) {

64 
m_numa_high_b™
 = 
RubySy¡em
::
	`g‘MemÜySizeB™s
() - 1;

66 
	`as£¹
(
m_numa_high_b™
 != 0);

67 
	}
}

69 
	gDœeùÜyMemÜy
::~
	$DœeùÜyMemÜy
()

72 
ušt64_t
 
i
 = 0; i < 
m_num_’Œ›s
; i++) {

73 ià(
m_’Œ›s
[
i
] !ğ
NULL
) {

74 
d–‘e
 
m_’Œ›s
[
i
];

77 
d–‘e
 [] 
m_’Œ›s
;

78 
	}
}

80 
ušt64_t


81 
	gDœeùÜyMemÜy
::
	$m­Add»ssToDœeùÜyV”siÚ
(
Addr
 
add»ss
)

83 ià(
m_num_dœeùÜ›s_b™s
 == 0)

86 
ušt64_t
 
»t
 = 
	`b™S–eù
(
add»ss
,

87 
m_numa_high_b™
 - 
m_num_dœeùÜ›s_b™s
 + 1,

88 
m_numa_high_b™
);

89  
»t
;

90 
	}
}

92 
boŞ


93 
	gDœeùÜyMemÜy
::
	$isP»£Á
(
Addr
 
add»ss
)

95 
boŞ
 
»t
 = (
	`m­Add»ssToDœeùÜyV”siÚ
(
add»ss
è=ğ
m_v”siÚ
);

96  
»t
;

97 
	}
}

99 
ušt64_t


100 
	gDœeùÜyMemÜy
::
	$m­Add»ssToLoÿlIdx
(
Addr
 
add»ss
)

102 
ušt64_t
 
»t
;

103 ià(
m_num_dœeùÜ›s_b™s
 > 0) {

104 
»t
 = 
	`b™Remove
(
add»ss
, 
m_numa_high_b™
 - 
m_num_dœeùÜ›s_b™s
 + 1,

105 
m_numa_high_b™
);

107 
»t
 = 
add»ss
;

110  
»t
 >> (
RubySy¡em
::
	`g‘BlockSizeB™s
());

111 
	}
}

113 
Ab¡¿ùEÁry
*

114 
	gDœeùÜyMemÜy
::
	$lookup
(
Addr
 
add»ss
)

116 
	`as£¹
(
	`isP»£Á
(
add»ss
));

117 
	`DPRINTF
(
RubyCache
, "Lookšg u°add»ss: %#x\n", 
add»ss
);

119 
ušt64_t
 
idx
 = 
	`m­Add»ssToLoÿlIdx
(
add»ss
);

120 
	`as£¹
(
idx
 < 
m_num_’Œ›s
);

121  
m_’Œ›s
[
idx
];

122 
	}
}

124 
Ab¡¿ùEÁry
*

125 
	gDœeùÜyMemÜy
::
	$®loÿ‹
(
Addr
 
add»ss
, 
Ab¡¿ùEÁry
 *
’Œy
)

127 
	`as£¹
(
	`isP»£Á
(
add»ss
));

128 
ušt64_t
 
idx
;

129 
	`DPRINTF
(
RubyCache
, "Lookšg u°add»ss: %#x\n", 
add»ss
);

131 
idx
 = 
	`m­Add»ssToLoÿlIdx
(
add»ss
);

132 
	`as£¹
(
idx
 < 
m_num_’Œ›s
);

133 
’Œy
->
	`chªgeP”missiÚ
(
AcûssP”missiÚ_R—d_OÆy
);

134 
m_’Œ›s
[
idx
] = 
’Œy
;

136  
’Œy
;

137 
	}
}

140 
	gDœeùÜyMemÜy
::
	$´št
(
o¡»am
& 
out
) const

142 
	}
}

145 
DœeùÜyMemÜy
::
	$»cÜdReque¡Ty³
(
DœeùÜyReque¡Ty³
 
»que¡Ty³
) {

146 
	`DPRINTF
(
RubySts
, "Recorded statistic: %s\n",

147 
	`DœeùÜyReque¡Ty³_to_¡ršg
(
»que¡Ty³
));

148 
	}
}

150 
DœeùÜyMemÜy
 *

151 
	gRubyDœeùÜyMemÜyP¬ams
::
	$ü—‹
()

153  
Ãw
 
	`DœeùÜyMemÜy
(
this
);

154 
	}
}

	@ruby/structures/DirectoryMemory.hh

29 #iâdeà
__MEM_RUBY_STRUCTURES_DIRECTORYMEMORY_HH__


30 
	#__MEM_RUBY_STRUCTURES_DIRECTORYMEMORY_HH__


	)

32 
	~<io¡»am
>

33 
	~<¡ršg
>

35 
	~"mem/´ÙocŞ/DœeùÜyReque¡Ty³.hh
"

36 
	~"mem/ruby/commÚ/Add»ss.hh
"

37 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùEÁry.hh
"

38 
	~"·¿ms/RubyDœeùÜyMemÜy.hh
"

39 
	~"sim/sim_objeù.hh
"

41 şas 
	cDœeùÜyMemÜy
 : 
public
 
SimObjeù


43 
public
:

44 
RubyDœeùÜyMemÜyP¬ams
 
	tP¬ams
;

45 
DœeùÜyMemÜy
(cÚ¡ 
P¬ams
 *
p
);

46 ~
DœeùÜyMemÜy
();

48 
š™
();

50 
ušt64_t
 
m­Add»ssToLoÿlIdx
(
Addr
 
add»ss
);

51 
ušt64_t
 
m­Add»ssToDœeùÜyV”siÚ
(
Addr
 
add»ss
);

53 
ušt64_t
 
	$g‘Size
(è{  
m_size_by‹s
; }

55 
boŞ
 
	`isP»£Á
(
Addr
 
add»ss
);

56 
Ab¡¿ùEÁry
 *
	`lookup
(
Addr
 
add»ss
);

57 
Ab¡¿ùEÁry
 *
	`®loÿ‹
(
Addr
 
add»ss
, Ab¡¿ùEÁry* 
Ãw_’Œy
);

59 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

60 
	`»cÜdReque¡Ty³
(
DœeùÜyReque¡Ty³
 
»que¡Ty³
);

62 
´iv©e
:

64 
	`DœeùÜyMemÜy
(cÚ¡ 
DœeùÜyMemÜy
& 
obj
);

65 
DœeùÜyMemÜy
& 
İ”©Ü
=(cÚ¡ DœeùÜyMemÜy& 
obj
);

67 
´iv©e
:

68 cÚ¡ 
¡d
::
¡ršg
 
m_Çme
;

69 
Ab¡¿ùEÁry
 **
m_’Œ›s
;

72 
ušt64_t
 
m_size_by‹s
;

73 
ušt64_t
 
m_size_b™s
;

74 
ušt64_t
 
m_num_’Œ›s
;

75 
m_v”siÚ
;

77 
m_num_dœeùÜ›s
;

78 
m_num_dœeùÜ›s_b™s
;

79 
m_numa_high_b™
;

80 
	}
};

82 
šlše
 
	g¡d
::
o¡»am
&

83 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gDœeùÜyMemÜy
& 
	gobj
)

85 
	gobj
.
´št
(
out
);

86 
	gout
 << 
	g¡d
::
æush
;

87  
	gout
;

	@ruby/structures/LRUPolicy.cc

31 
	~"mem/ruby/¡ruùu»s/LRUPŞicy.hh
"

35 
	gLRUPŞicy
::
	$LRUPŞicy
(cÚ¡ 
P¬ams
 * 
p
)

36 : 
	$Ab¡¿ùR•Ïûm’tPŞicy
(
p
)

38 
	}
}

41 
LRUPŞicy
::~
	$LRUPŞicy
()

43 
	}
}

45 
LRUPŞicy
 *

46 
LRUR•Ïûm’tPŞicyP¬ams
::
	$ü—‹
()

48  
Ãw
 
	`LRUPŞicy
(
this
);

49 
	}
}

53 
	gLRUPŞicy
::
	$touch
(
št64_t
 
£t
, iÁ64_ˆ
šdex
, 
Tick
 
time
)

55 
	`as£¹
(
šdex
 >ğ0 && index < 
m_assoc
);

56 
	`as£¹
(
£t
 >ğ0 && s‘ < 
m_num_£ts
);

58 
m_Ï¡_»f_±r
[
£t
][
šdex
] = 
time
;

59 
	}
}

61 
št64_t


62 
	gLRUPŞicy
::
	$g‘Viùim
(
št64_t
 
£t
) const

64 
Tick
 
time
, 
sm®Ë¡_time
;

65 
št64_t
 
sm®Ë¡_šdex
 = 0;

66 
sm®Ë¡_time
 = 
m_Ï¡_»f_±r
[
£t
][0];

68 
i
 = 0; i < 
m_assoc
; i++) {

69 
time
 = 
m_Ï¡_»f_±r
[
£t
][
i
];

71 ià(
time
 < 
sm®Ë¡_time
) {

72 
sm®Ë¡_šdex
 = 
i
;

73 
sm®Ë¡_time
 = 
time
;

77  
sm®Ë¡_šdex
;

78 
	}
}

	@ruby/structures/LRUPolicy.hh

29 #iâdeà
__MEM_RUBY_STRUCTURES_LRUPOLICY_HH__


30 
	#__MEM_RUBY_STRUCTURES_LRUPOLICY_HH__


	)

32 
	~"mem/ruby/¡ruùu»s/Ab¡¿ùR•Ïûm’tPŞicy.hh
"

33 
	~"·¿ms/LRUR•Ïûm’tPŞicy.hh
"

37 şas 
	cLRUPŞicy
 : 
public
 
Ab¡¿ùR•Ïûm’tPŞicy


39 
public
:

40 
LRUR•Ïûm’tPŞicyP¬ams
 
	tP¬ams
;

41 
LRUPŞicy
(cÚ¡ 
P¬ams
 * 
p
);

42 ~
LRUPŞicy
();

44 
touch
(
št64_t
 
£t
, iÁ64_ˆ
way
, 
Tick
 
time
);

45 
št64_t
 
	$g‘Viùim
(
št64_t
 
£t
) const;

	@ruby/structures/MemoryNode.cc

29 
	~"mem/ruby/¡ruùu»s/MemÜyNode.hh
"

31 
usšg
 
Çme¥aû
 
	g¡d
;

34 
	gMemÜyNode
::
	$´št
(
o¡»am
& 
out
) const

36 
out
 << "[";

37 
out
 << 
m_time
 << ", ";

38 
out
 << 
m_msg_couÁ”
 << ", ";

39 
out
 << 
pkt
 << "; ";

40 
out
 << "]";

41 
	}
}

	@ruby/structures/MemoryNode.hh

38 #iâdeà
__MEM_RUBY_STRUCTURES_MEMORYNODE_HH__


39 
	#__MEM_RUBY_STRUCTURES_MEMORYNODE_HH__


	)

41 
	~<io¡»am
>

43 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

44 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

46 şas 
	cMemÜyNode


48 
	mpublic
:

50 
	$MemÜyNode
(cÚ¡ 
Cyşes
& 
time
, 
couÁ”
, cÚ¡ 
Pack‘PŒ
 
p
,

51 
Addr
 
addr
, cÚ¡ 
boŞ
 
is_mem_»ad
)

52 : 
	`m_time
(
time
), 
	$pkt
(
p
)

54 
m_msg_couÁ”
 = 
couÁ”
;

55 
m_addr
 = 
addr
;

56 
m_is_mem_»ad
 = 
is_mem_»ad
;

57 
m_is_dœty_wb
 = !
is_mem_»ad
;

61 
	$MemÜyNode
(cÚ¡ 
Cyşes
& 
time
, cÚ¡ 
Pack‘PŒ
 
p
,

62 
Addr
 
addr
, cÚ¡ 
boŞ
 
is_mem_»ad
,

63 cÚ¡ 
boŞ
 
is_dœty_wb
)

64 : 
	`m_time
(
time
), 
	$pkt
(
p
)

66 
m_msg_couÁ”
 = 0;

67 
m_addr
 = 
addr
;

68 
m_is_mem_»ad
 = 
is_mem_»ad
;

69 
m_is_dœty_wb
 = 
is_dœty_wb
;

70 
	}
}

72 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

74 
Cyşes
 
m_time
;

75 
m_msg_couÁ”
;

76 
Pack‘PŒ
 
pkt
;

77 
Addr
 
m_addr
;

78 
boŞ
 
m_is_mem_»ad
;

79 
boŞ
 
m_is_dœty_wb
;

80 
	}
};

82 
šlše
 
	g¡d
::
o¡»am
&

83 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gMemÜyNode
& 
	gobj
)

85 
	gobj
.
´št
(
out
);

86 
	gout
 << 
	g¡d
::
æush
;

87  
	gout
;

	@ruby/structures/PerfectCacheMemory.hh

29 #iâdeà
__MEM_RUBY_STRUCTURES_PERFECTCACHEMEMORY_HH__


30 
	#__MEM_RUBY_STRUCTURES_PERFECTCACHEMEMORY_HH__


	)

32 
	~<unÜd”ed_m­
>

34 
	~"mem/´ÙocŞ/AcûssP”missiÚ.hh
"

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

37 
	g‹m¶©e
<
şass
 
	gENTRY
>

38 
	sP”ãùCacheLšeS‹


40 
P”ãùCacheLšeS‹
(è{ 
	mm_³rmissiÚ
 = 
AcûssP”missiÚ_NUM
; }

41 
AcûssP”missiÚ
 
	mm_³rmissiÚ
;

42 
ENTRY
 
	mm_’Œy
;

45 
	g‹m¶©e
<
şass
 
	gENTRY
>

46 
šlše
 
	g¡d
::
o¡»am
&

47 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gP”ãùCacheLšeS‹
<
	gENTRY
>& 
	gobj
)

49  
	gout
;

52 
	g‹m¶©e
<
şass
 
	gENTRY
>

53 şas 
	cP”ãùCacheMemÜy


55 
	mpublic
:

56 
P”ãùCacheMemÜy
();

59 
boŞ
 
	$isTagP»£Á
(
Addr
 
add»ss
) const;

64 
boŞ
 
	$ÿcheAva
(
Addr
 
add»ss
) const;

67 
	`®loÿ‹
(
Addr
 
add»ss
);

69 
	`d—Îoÿ‹
(
Addr
 
add»ss
);

72 
Addr
 
	$ÿcheProbe
(
Addr
 
ÃwAdd»ss
) const;

75 
ENTRY
* 
	`lookup
(
Addr
 
add»ss
);

76 cÚ¡ 
ENTRY
* 
	$lookup
(
Addr
 
add»ss
) const;

79 
AcûssP”missiÚ
 
	$g‘P”missiÚ
(
Addr
 
add»ss
) const;

80 
	`chªgeP”missiÚ
(
Addr
 
add»ss
, 
AcûssP”missiÚ
 
Ãw_³rm
);

83 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

85 
´iv©e
:

87 
	`P”ãùCacheMemÜy
(cÚ¡ 
P”ãùCacheMemÜy
& 
obj
);

88 
P”ãùCacheMemÜy
& 
İ”©Ü
=(cÚ¡ P”ãùCacheMemÜy& 
obj
);

91 
¡d
::
unÜd”ed_m­
<
Addr
, 
P”ãùCacheLšeS‹
<
ENTRY
> > 
m_m­
;

94 
‹m¶©e
<
şass
 
ENTRY
>

95 
šlše
 
¡d
::
o¡»am
&

96 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
P”ãùCacheMemÜy
<
ENTRY
>& 
obj
)

98 
obj
.
	`´št
(
out
);

99 
out
 << 
¡d
::
æush
;

100  
out
;

101 
	}
}

103 
	g‹m¶©e
<
şass
 
	gENTRY
>

104 
šlše


105 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$P”ãùCacheMemÜy
()

107 
	}
}

110 
‹m¶©e
<
şass
 
ENTRY
>

111 
šlše
 
boŞ


112 
P”ãùCacheMemÜy
<
ENTRY
>::
	$isTagP»£Á
(
Addr
 
add»ss
) const

114  
m_m­
.
	`couÁ
(
	`makeLšeAdd»ss
(
add»ss
)) > 0;

115 
	}
}

117 
	g‹m¶©e
<
şass
 
	gENTRY
>

118 
šlše
 
boŞ


119 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$ÿcheAva
(
Addr
 
add»ss
) const

121  
Œue
;

122 
	}
}

126 
	g‹m¶©e
<
şass
 
	gENTRY
>

127 
šlše
 

128 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$®loÿ‹
(
Addr
 
add»ss
)

130 
P”ãùCacheLšeS‹
<
ENTRY
> 
lše_¡©e
;

131 
lše_¡©e
.
m_³rmissiÚ
 = 
AcûssP”missiÚ_Inv®id
;

132 
lše_¡©e
.
m_’Œy
 = 
	`ENTRY
();

133 
m_m­
[
	`makeLšeAdd»ss
(
add»ss
)] = 
lše_¡©e
;

134 
	}
}

137 
	g‹m¶©e
<
şass
 
	gENTRY
>

138 
šlše
 

139 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$d—Îoÿ‹
(
Addr
 
add»ss
)

141 
m_m­
.
	`”a£
(
	`makeLšeAdd»ss
(
add»ss
));

142 
	}
}

145 
	g‹m¶©e
<
şass
 
	gENTRY
>

146 
šlše
 
Addr


147 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$ÿcheProbe
(
Addr
 
ÃwAdd»ss
) const

149 
	`·nic
("cacheProbe called in…erfect cache");

150  
ÃwAdd»ss
;

151 
	}
}

154 
	g‹m¶©e
<
şass
 
	gENTRY
>

155 
šlše
 
ENTRY
*

156 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$lookup
(
Addr
 
add»ss
)

158  &
m_m­
[
	`makeLšeAdd»ss
(
add»ss
)].
m_’Œy
;

159 
	}
}

162 
	g‹m¶©e
<
şass
 
	gENTRY
>

163 
šlše
 cÚ¡ 
ENTRY
*

164 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$lookup
(
Addr
 
add»ss
) const

166  &
m_m­
[
	`makeLšeAdd»ss
(
add»ss
)].
m_’Œy
;

167 
	}
}

169 
	g‹m¶©e
<
şass
 
	gENTRY
>

170 
šlše
 
AcûssP”missiÚ


171 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$g‘P”missiÚ
(
Addr
 
add»ss
) const

173  
m_m­
[
	`makeLšeAdd»ss
(
add»ss
)].
m_³rmissiÚ
;

174 
	}
}

176 
	g‹m¶©e
<
şass
 
	gENTRY
>

177 
šlše
 

178 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$chªgeP”missiÚ
(
Addr
 
add»ss
,

179 
AcûssP”missiÚ
 
Ãw_³rm
)

181 
Addr
 
lše_add»ss
 = 
	`makeLšeAdd»ss
(
add»ss
);

182 
P”ãùCacheLšeS‹
<
ENTRY
>& 
lše_¡©e
 = 
m_m­
[
lše_add»ss
];

183 
lše_¡©e
.
m_³rmissiÚ
 = 
Ãw_³rm
;

184 
	}
}

186 
	g‹m¶©e
<
şass
 
	gENTRY
>

187 
šlše
 

188 
	gP”ãùCacheMemÜy
<
	gENTRY
>::
	$´št
(
¡d
::
o¡»am
& 
out
) const

190 
	}
}

	@ruby/structures/PersistentTable.cc

29 
	~"mem/ruby/¡ruùu»s/P”si¡’tTabË.hh
"

31 
usšg
 
Çme¥aû
 
	g¡d
;

35 
	g³rsi¡’t_¿ndomize
[] = {0, 4, 8, 12, 1, 5, 9, 13, 2, 6,

37 
	g³rsi¡’t_¿ndomize
[] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9,

41 
	gP”si¡’tTabË
::
	$P”si¡’tTabË
()

43 
	}
}

45 
P”si¡’tTabË
::~
	$P”si¡’tTabË
()

47 
	}
}

50 
P”si¡’tTabË
::
	$³rsi¡’tReque¡Lock
(
Addr
 
add»ss
,

51 
MachšeID
 
lock”
,

52 
AcûssTy³
 
ty³
)

55 ià(
lock”
 =ğ
m_ch_±r
->
	`g‘ID
())

56 
cout
 << "Ch " << 
m_ch_±r
->
	`g‘ID
(è<< ": " << 
Îock”


57 << "„eque¡šg†ock fÜ " << 
add»ss
 << 
’dl
;

59 
MachšeID
 
lock”
 = (MachšeIDè
³rsi¡’t_¿ndomize
[
Îock”
];

62 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

64 cÚ¡ 
P”si¡’tTabËEÁry
 
dæt
;

65 
·œ
<
Add»ssM­
::
™”©Ü
, 
boŞ
> 
r
 =

66 
m_m­
.
	`š£¹
(
Add»ssM­
::
	`v®ue_ty³
(
add»ss
, 
dæt
));

67 
boŞ
 
´e£Á
 = !
r
.
£cÚd
;

68 
Add»ssM­
::
™”©Ü
 
i
 = 
r
.
fœ¡
;

69 
P”si¡’tTabËEÁry
 &
’Œy
 = 
i
->
£cÚd
;

71 ià(
´e£Á
) {

73 
	`as£¹
(!(
’Œy
.
m_¡¬všg
.
	`isEËm’t
(
lock”
)));

76 
’Œy
.
m_¡¬všg
.
	`add
(
lock”
);

77 ià(
ty³
 =ğ
AcûssTy³_Wr™e
)

78 
’Œy
.
m_»que¡_to_wr™e
.
	`add
(
lock”
);

80 ià(
´e£Á
)

81 
	`as£¹
(
’Œy
.
m_m¬ked
.
	`isSub£t
ÓÁry.
m_¡¬všg
));

82 
	}
}

85 
	gP”si¡’tTabË
::
	$³rsi¡’tReque¡UÆock
(
Addr
 
add»ss
,

86 
MachšeID
 
uÆock”
)

89 ià(
uÆock”
 =ğ
m_ch_±r
->
	`g‘ID
())

90 
cout
 << "Ch " << 
m_ch_±r
->
	`g‘ID
(è<< ": " << 
uuÆock”


91 << "„eque¡šg uÆock fÜ " << 
add»ss
 << 
’dl
;

93 
MachšeID
 
uÆock”
 = (MachšeIDè
³rsi¡’t_¿ndomize
[
uuÆock”
];

96 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

97 
	`as£¹
(
m_m­
.
	`couÁ
(
add»ss
));

98 
P”si¡’tTabËEÁry
& 
’Œy
 = 
m_m­
[
add»ss
];

103 
	`as£¹
(
’Œy
.
m_¡¬všg
.
	`isEËm’t
(
uÆock”
));

104 
	`as£¹
(
’Œy
.
m_m¬ked
.
	`isSub£t
ÓÁry.
m_¡¬všg
));

105 
’Œy
.
m_¡¬všg
.
	`»move
(
uÆock”
);

106 
’Œy
.
m_m¬ked
.
	`»move
(
uÆock”
);

107 
’Œy
.
m_»que¡_to_wr™e
.
	`»move
(
uÆock”
);

108 
	`as£¹
(
’Œy
.
m_m¬ked
.
	`isSub£t
ÓÁry.
m_¡¬všg
));

111 ià(
’Œy
.
m_¡¬všg
.
	`isEm±y
()) {

112 
	`as£¹
(
’Œy
.
m_m¬ked
.
	`isEm±y
());

113 
m_m­
.
	`”a£
(
add»ss
);

115 
	}
}

117 
boŞ


118 
	gP”si¡’tTabË
::
	$okToIssueSrvšg
(
Addr
 
add»ss
,

119 
MachšeID
 
machId
) const

121 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

123 
Add»ssM­
::
cÚ¡_™”©Ü
 
i
 = 
m_m­
.
	`fšd
(
add»ss
);

124 ià(
i
 =ğ
m_m­
.
	`’d
()) {

126  
Œue
;

129 cÚ¡ 
P”si¡’tTabËEÁry
 &
’Œy
 = 
i
->
£cÚd
;

131 ià(
’Œy
.
m_¡¬všg
.
	`isEËm’t
(
machId
)) {

134  
çl£
;

137  
’Œy
.
m_m¬ked
.
	`isEm±y
();

138 
	}
}

140 
MachšeID


141 
	gP”si¡’tTabË
::
	$fšdSm®Ë¡
(
Addr
 
add»ss
) const

143 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

144 
Add»ssM­
::
cÚ¡_™”©Ü
 
i
 = 
m_m­
.
	`fšd
(
add»ss
);

145 
	`as£¹
(
i
 !ğ
m_m­
.
	`’d
());

146 cÚ¡ 
P”si¡’tTabËEÁry
& 
’Œy
 = 
i
->
£cÚd
;

147  
’Œy
.
m_¡¬všg
.
	`sm®Ë¡EËm’t
();

148 
	}
}

150 
AcûssTy³


151 
	gP”si¡’tTabË
::
	$ty³OfSm®Ë¡
(
Addr
 
add»ss
) const

153 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

154 
Add»ssM­
::
cÚ¡_™”©Ü
 
i
 = 
m_m­
.
	`fšd
(
add»ss
);

155 
	`as£¹
(
i
 !ğ
m_m­
.
	`’d
());

156 cÚ¡ 
P”si¡’tTabËEÁry
& 
’Œy
 = 
i
->
£cÚd
;

157 ià(
’Œy
.
m_»que¡_to_wr™e
.

158 
	`isEËm’t
(
’Œy
.
m_¡¬všg
.
	`sm®Ë¡EËm’t
())) {

159  
AcûssTy³_Wr™e
;

161  
AcûssTy³_R—d
;

163 
	}
}

166 
	gP”si¡’tTabË
::
	$m¬kEÁr›s
(
Addr
 
add»ss
)

168 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

169 
Add»ssM­
::
™”©Ü
 
i
 = 
m_m­
.
	`fšd
(
add»ss
);

170 ià(
i
 =ğ
m_m­
.
	`’d
())

173 
P”si¡’tTabËEÁry
& 
’Œy
 = 
i
->
£cÚd
;

176 
	`as£¹
(
’Œy
.
m_m¬ked
.
	`isEm±y
());

179 
’Œy
.
m_m¬ked
 =ƒÁry.
m_¡¬všg
;

180 
	}
}

182 
boŞ


183 
	gP”si¡’tTabË
::
	$isLocked
(
Addr
 
add»ss
) const

185 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

188  
m_m­
.
	`couÁ
(
add»ss
) > 0;

189 
	}
}

192 
	gP”si¡’tTabË
::
	$couÁSrvšgFÜAdd»ss
(
Addr
 
add»ss
) const

194 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

195 
Add»ssM­
::
cÚ¡_™”©Ü
 
i
 = 
m_m­
.
	`fšd
(
add»ss
);

196 ià(
i
 =ğ
m_m­
.
	`’d
())

199 cÚ¡ 
P”si¡’tTabËEÁry
& 
’Œy
 = 
i
->
£cÚd
;

200  
’Œy
.
m_¡¬všg
.
	`couÁ
();

201 
	}
}

204 
	gP”si¡’tTabË
::
	$couÁR—dSrvšgFÜAdd»ss
(
Addr
 
add»ss
) const

206 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

207 
Add»ssM­
::
cÚ¡_™”©Ü
 
i
 = 
m_m­
.
	`fšd
(
add»ss
);

208 ià(
i
 =ğ
m_m­
.
	`’d
())

211 cÚ¡ 
P”si¡’tTabËEÁry
& 
’Œy
 = 
i
->
£cÚd
;

212  
’Œy
.
m_¡¬všg
.
	`couÁ
(è-ƒÁry.
m_»que¡_to_wr™e
.count();

213 
	}
}

216 
	gP”si¡’tTabË
::
	$´št
(
o¡»am
& 
out
) const

218 
	}
}

	@ruby/structures/PersistentTable.hh

29 #iâdeà
__MEM_RUBY_STRUCTURES_PERSISTENTTABLE_HH__


30 
	#__MEM_RUBY_STRUCTURES_PERSISTENTTABLE_HH__


	)

32 
	~<io¡»am
>

33 
	~<unÜd”ed_m­
>

35 
	~"mem/´ÙocŞ/AcûssTy³.hh
"

36 
	~"mem/ruby/commÚ/Add»ss.hh
"

37 
	~"mem/ruby/commÚ/MachšeID.hh
"

38 
	~"mem/ruby/commÚ/N‘De¡.hh
"

40 şas 
	cP”si¡’tTabËEÁry


42 
	mpublic
:

43 
	$P”si¡’tTabËEÁry
() {}

44 
	$´št
(
¡d
::
o¡»am
& 
out
ècÚ¡ {
	}
}

46 
N‘De¡
 
m_¡¬všg
;

47 
N‘De¡
 
	gm_m¬ked
;

48 
N‘De¡
 
	gm_»que¡_to_wr™e
;

51 şas 
	cP”si¡’tTabË


53 
	mpublic
:

55 
P”si¡’tTabË
();

58 ~
P”si¡’tTabË
();

61 
³rsi¡’tReque¡Lock
(
Addr
 
add»ss
, 
MachšeID
 
lock”
,

62 
AcûssTy³
 
ty³
);

63 
³rsi¡’tReque¡UÆock
(
Addr
 
add»ss
, 
MachšeID
 
uÆock”
);

64 
boŞ
 
	$okToIssueSrvšg
(
Addr
 
add»ss
, 
MachšeID
 
machID
) const;

65 
MachšeID
 
	$fšdSm®Ë¡
(
Addr
 
add»ss
) const;

66 
AcûssTy³
 
	$ty³OfSm®Ë¡
(
Addr
 
add»ss
) const;

67 
	`m¬kEÁr›s
(
Addr
 
add»ss
);

68 
boŞ
 
	$isLocked
(
Addr
 
addr
) const;

69 
	$couÁSrvšgFÜAdd»ss
(
Addr
 
addr
) const;

70 
	$couÁR—dSrvšgFÜAdd»ss
(
Addr
 
addr
) const;

72 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

74 
´iv©e
:

76 
	`P”si¡’tTabË
(cÚ¡ 
P”si¡’tTabË
& 
obj
);

77 
P”si¡’tTabË
& 
İ”©Ü
=(cÚ¡ P”si¡’tTabË& 
obj
);

80 
¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	tP”si¡’tTabËEÁry
> 
	tAdd»ssM­
;

81 
Add»ssM­
 
m_m­
;

84 
šlše
 
¡d
::
o¡»am
&

85 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
P”si¡’tTabË
& 
obj
)

87 
obj
.
	`´št
(
out
);

88 
out
 << 
¡d
::
æush
;

89  
out
;

90 
	}
}

92 
šlše
 
	g¡d
::
o¡»am
&

93 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gP”si¡’tTabËEÁry
& 
	gobj
)

95 
	gobj
.
´št
(
out
);

96 
	gout
 << 
	g¡d
::
æush
;

97  
	gout
;

	@ruby/structures/Prefetcher.cc

29 
	~"debug/RubyP»ãtch”.hh
"

30 
	~"mem/ruby/¦icc_š‹rçû/RubySlicc_CompÚ’tM­pšg.hh
"

31 
	~"mem/ruby/¡ruùu»s/P»ãtch”.hh
"

32 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

34 
P»ãtch”
*

35 
	gP»ãtch”P¬ams
::
	$ü—‹
()

37  
Ãw
 
	`P»ãtch”
(
this
);

38 
	}
}

40 
	gP»ãtch”
::
	$P»ãtch”
(cÚ¡ 
P¬ams
 *
p
)

41 : 
	`SimObjeù
(
p
), 
	`m_num_¡»ams
Õ->
num_¡»ams
),

42 
	`m_¬¿y
(
p
->
num_¡»ams
), 
	`m_Œaš_mis£s
Õ->
Œaš_mis£s
),

43 
	`m_num_¡¬tup_pfs
(
p
->
num_¡¬tup_pfs
), 
	`m_num_un™_f‹rs
Õ->
un™_f‹r
),

44 
	`m_num_nÚun™_f‹rs
(
p
->
nÚun™_f‹r
),

45 
	`m_un™_f‹r
(
p
->
un™_f‹r
, 0),

46 
	`m_Ãg©ive_f‹r
(
p
->
un™_f‹r
, 0),

47 
	`m_nÚun™_f‹r
(
p
->
nÚun™_f‹r
, 0),

48 
	`m_´eãtch_üoss_·ges
(
p
->
üoss_·ge
),

49 
	`m_·ge_shiá
(
p
->
sys
->
	$g‘PageShiá
())

51 
	`as£¹
(
m_num_¡»ams
 > 0);

52 
	`as£¹
(
m_num_¡¬tup_pfs
 <ğ
MAX_PF_INFLIGHT
);

55 
m_un™_f‹r_šdex
 = 0;

56 
m_un™_f‹r_h™
 = 
Ãw
 
ušt32_t
[
m_num_un™_f‹rs
];

57 
ušt32_t
 
i
 =0; i < 
m_num_un™_f‹rs
; i++) {

58 
m_un™_f‹r_h™
[
i
] = 0;

62 
m_Ãg©ive_f‹r_šdex
 = 0;

63 
m_Ãg©ive_f‹r_h™
 = 
Ãw
 
ušt32_t
[
m_num_un™_f‹rs
];

64 
i
 =0; i < 
m_num_un™_f‹rs
; i++) {

65 
m_Ãg©ive_f‹r_h™
[
i
] = 0;

69 
m_nÚun™_šdex
 = 0;

70 
m_nÚun™_¡ride
 = 
Ãw
 [
m_num_nÚun™_f‹rs
];

71 
m_nÚun™_h™
 = 
Ãw
 
ušt32_t
[
m_num_nÚun™_f‹rs
];

72 
i
 =0; i < 
m_num_nÚun™_f‹rs
; i++) {

73 
m_nÚun™_¡ride
[
i
] = 0;

74 
m_nÚun™_h™
[
i
] = 0;

76 
	}
}

78 
	gP»ãtch”
::~
	$P»ãtch”
()

80 
d–‘e
 
m_un™_f‹r_h™
;

81 
d–‘e
 
m_Ãg©ive_f‹r_h™
;

82 
d–‘e
 
m_nÚun™_¡ride
;

83 
d–‘e
 
m_nÚun™_h™
;

84 
	}
}

87 
	gP»ãtch”
::
	$»gSts
()

89 
SimObjeù
::
	`»gSts
();

91 
numMissOb£rved


92 .
	`Çme
(name() + ".miss_observed")

93 .
	`desc
("number of misses observed")

96 
numAÎoÿ‹dSŒ—ms


97 .
	`Çme
(name() + ".allocated_streams")

98 .
	`desc
("number of streams‡llocated for…refetching")

101 
numP»ãtchReque¡ed


102 .
	`Çme
(name() + ".prefetches_requested")

103 .
	`desc
("number of…refetch„equests made")

106 
numP»ãtchAcû±ed


107 .
	`Çme
(name() + ".prefetches_accepted")

108 .
	`desc
("number of…refetch„equests‡ccepted")

111 
numDrİ³dP»ãtches


112 .
	`Çme
(name() + ".dropped_prefetches")

113 .
	`desc
("number of…refetch„equests dropped")

116 
numH™s


117 .
	`Çme
(name() + ".hits")

118 .
	`desc
("number of…refetched blocks‡ccessed")

121 
numP¬tŸlH™s


122 .
	`Çme
(name() + ".partial_hits")

123 .
	`desc
("number of misses observed for‡ block being…refetched")

126 
numPagesCros£d


127 .
	`Çme
(name() + ".pages_crossed")

128 .
	`desc
("number of…refetches‡cross…ages")

131 
numMis£dP»ãtchedBlocks


132 .
	`Çme
(name() + ".misses_on_prefetched_blocks")

133 .
	`desc
("number of misses for blockshat were…refetched, yet missed")

135 
	}
}

138 
	gP»ãtch”
::
	$ob£rveMiss
(
Addr
 
add»ss
, cÚ¡ 
RubyReque¡Ty³
& 
ty³
)

140 
	`DPRINTF
(
RubyP»ãtch”
, "Ob£rved mis fÜ %#x\n", 
add»ss
);

141 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
add»ss
);

142 
numMissOb£rved
++;

145 
ušt32_t
 
šdex
 = 0;

146 
P»ãtchEÁry
 *
pfEÁry
 = 
	`g‘P»ãtchEÁry
(
lše_addr
, 
šdex
);

147 ià(
pfEÁry
 !ğ
NULL
) {

148 ià(
pfEÁry
->
»que¡Issued
[
šdex
]) {

149 ià(
pfEÁry
->
»que¡Com¶‘ed
[
šdex
]) {

152 
numMis£dP»ãtchedBlocks
++;

157 
numP¬tŸlH™s
++;

158 
	`ob£rvePfH™
(
lše_addr
);

169 
boŞ
 
®loc
 = 
çl£
;

170 
boŞ
 
h™
 = 
	`acûssUn™F‹r
(
m_un™_f‹r
, 
m_un™_f‹r_h™
,

171 
m_un™_f‹r_šdex
, 
lše_addr
, 1, 
®loc
);

172 ià(
®loc
) {

174 
	`š™ŸlizeSŒ—m
(
lše_addr
, 1, 
	`g‘LRUšdex
(), 
ty³
);

176 ià(
h™
) {

177 
	`DPRINTF
(
RubyP»ãtch”
, " *** hit in unit stride buffer\n");

181 
h™
 = 
	`acûssUn™F‹r
(
m_Ãg©ive_f‹r
, 
m_Ãg©ive_f‹r_h™
,

182 
m_Ãg©ive_f‹r_šdex
, 
lše_addr
, -1, 
®loc
);

183 ià(
®loc
) {

185 
	`š™ŸlizeSŒ—m
(
lše_addr
, -1, 
	`g‘LRUšdex
(), 
ty³
);

187 ià(
h™
) {

188 
	`DPRINTF
(
RubyP»ãtch”
, " *** hit in unit‚egative unit buffer\n");

193 
¡ride
 = 0;

194 
h™
 = 
	`acûssNÚun™F‹r
(
add»ss
, &
¡ride
, 
®loc
);

195 ià(
®loc
) {

196 
	`as£¹
(
¡ride
 != 0);

197 
	`š™ŸlizeSŒ—m
(
lše_addr
, 
¡ride
, 
	`g‘LRUšdex
(), 
ty³
);

199 ià(
h™
) {

200 
	`DPRINTF
(
RubyP»ãtch”
, " *** hit in‚on-unit stride buffer\n");

203 
	}
}

206 
	gP»ãtch”
::
	$ob£rvePfMiss
(
Addr
 
add»ss
)

208 
numP¬tŸlH™s
++;

209 
	`DPRINTF
(
RubyP»ãtch”
, "Ob£rved…¬tŸÈh™ fÜ %#x\n", 
add»ss
);

210 
	`issueNextP»ãtch
(
add»ss
, 
NULL
);

211 
	}
}

214 
	gP»ãtch”
::
	$ob£rvePfH™
(
Addr
 
add»ss
)

216 
numH™s
++;

217 
	`DPRINTF
(
RubyP»ãtch”
, "Ob£rved h™ fÜ %#x\n", 
add»ss
);

218 
	`issueNextP»ãtch
(
add»ss
, 
NULL
);

219 
	}
}

222 
	gP»ãtch”
::
	$issueNextP»ãtch
(
Addr
 
add»ss
, 
P»ãtchEÁry
 *
¡»am
)

225 ià(
¡»am
 =ğ
NULL
) {

226 
ušt32_t
 
šdex
 = 0;

227 
¡»am
 = 
	`g‘P»ãtchEÁry
(
add»ss
, 
šdex
);

231 ià(
¡»am
 =ğ
NULL
) {

232 
	`DPRINTF
(
RubyP»ãtch”
, "Unallocated stream,„eturning\n");

237 
Addr
 
·ge_addr
 = 
	`·geAdd»ss
(
¡»am
->
m_add»ss
);

238 
Addr
 
lše_addr
 = 
	`makeNextSŒideAdd»ss
(
¡»am
->
m_add»ss
,

239 
¡»am
->
m_¡ride
);

242 ià(
·ge_addr
 !ğ
	`·geAdd»ss
(
lše_addr
)) {

243 
numPagesCros£d
++;

244 ià(!
m_´eãtch_üoss_·ges
) {

247 
¡»am
->
m_is_v®id
 = 
çl£
;

253 
¡»am
->
m_add»ss
 = 
lše_addr
;

254 
¡»am
->
m_u£_time
 = 
m_cÚŒŞËr
->
	`curCyşe
();

255 
	`DPRINTF
(
RubyP»ãtch”
, "Reque¡šg…»ãtch fÜ %#x\n", 
lše_addr
);

256 
m_cÚŒŞËr
->
	`’queueP»ãtch
(
lše_addr
, 
¡»am
->
m_ty³
);

257 
	}
}

259 
ušt32_t


260 
	gP»ãtch”
::
	$g‘LRUšdex
()

262 
ušt32_t
 
Ìu_šdex
 = 0;

263 
Cyşes
 
Ìu_acûss
 = 
m_¬¿y
[
Ìu_šdex
].
m_u£_time
;

265 
ušt32_t
 
i
 = 0; i < 
m_num_¡»ams
; i++) {

266 ià(!
m_¬¿y
[
i
].
m_is_v®id
) {

267  
i
;

269 ià(
m_¬¿y
[
i
].
m_u£_time
 < 
Ìu_acûss
) {

270 
Ìu_acûss
 = 
m_¬¿y
[
i
].
m_u£_time
;

271 
Ìu_šdex
 = 
i
;

275  
Ìu_šdex
;

276 
	}
}

279 
	gP»ãtch”
::
	$ş—rNÚun™EÁry
(
ušt32_t
 
šdex
)

281 
m_nÚun™_f‹r
[
šdex
] = 0;

282 
m_nÚun™_¡ride
[
šdex
] = 0;

283 
m_nÚun™_h™
[
šdex
] = 0;

284 
	}
}

287 
	gP»ãtch”
::
	$š™ŸlizeSŒ—m
(
Addr
 
add»ss
, 
¡ride
,

288 
ušt32_t
 
šdex
, cÚ¡ 
RubyReque¡Ty³
& 
ty³
)

290 
numAÎoÿ‹dSŒ—ms
++;

293 
P»ãtchEÁry
 *
my¡»am
 = &(
m_¬¿y
[
šdex
]);

294 
my¡»am
->
m_add»ss
 = 
	`makeLšeAdd»ss
(
add»ss
);

295 
my¡»am
->
m_¡ride
 = 
¡ride
;

296 
my¡»am
->
m_u£_time
 = 
m_cÚŒŞËr
->
	`curCyşe
();

297 
my¡»am
->
m_is_v®id
 = 
Œue
;

298 
my¡»am
->
m_ty³
 = 
ty³
;

301 
Addr
 
·ge_addr
 = 
	`·geAdd»ss
(
my¡»am
->
m_add»ss
);

302 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
my¡»am
->
m_add»ss
);

305 
k
 = 0; k < 
m_num_¡¬tup_pfs
; k++) {

306 
lše_addr
 = 
	`makeNextSŒideAdd»ss
Öše_addr, 
¡ride
);

308 ià(
·ge_addr
 !ğ
	`·geAdd»ss
(
lše_addr
)) {

309 
numPagesCros£d
++;

310 ià(!
m_´eãtch_üoss_·ges
) {

312 
my¡»am
->
m_is_v®id
 = 
çl£
;

318 
numP»ãtchReque¡ed
++;

319 
	`DPRINTF
(
RubyP»ãtch”
, "Reque¡šg…»ãtch fÜ %#x\n", 
lše_addr
);

320 
m_cÚŒŞËr
->
	`’queueP»ãtch
(
lše_addr
, 
m_¬¿y
[
šdex
].
m_ty³
);

324 
my¡»am
->
m_add»ss
 = 
lše_addr
;

325 
	}
}

327 
P»ãtchEÁry
 *

328 
	gP»ãtch”
::
	$g‘P»ãtchEÁry
(
Addr
 
add»ss
, 
ušt32_t
 &
šdex
)

331 
i
 = 0; i < 
m_num_¡»ams
; i++) {

333 ià(
m_¬¿y
[
i
].
m_is_v®id
) {

334 
j
 = 0; j < 
m_num_¡¬tup_pfs
; j++) {

335 ià(
	`makeNextSŒideAdd»ss
(
m_¬¿y
[
i
].
m_add»ss
,

336 -(
m_¬¿y
[
i
].
m_¡ride
*
j
)è=ğ
add»ss
) {

337  &(
m_¬¿y
[
i
]);

342  
NULL
;

343 
	}
}

345 
boŞ


346 
	gP»ãtch”
::
acûssUn™F‹r
(
¡d
::
veùÜ
<
Addr
>& 
f‹r_bË
,

347 
ušt32_t
 *
f‹r_h™
, ušt32_ˆ&
šdex
, 
Addr
 
add»ss
,

348 
¡ride
, 
boŞ
 &
®loc
)

351 
	g®loc
 = 
çl£
;

353 
Addr
 
	glše_addr
 = 
makeLšeAdd»ss
(
add»ss
);

354 
	gi
 = 0; i < 
	gm_num_un™_f‹rs
; i++) {

355 ià(
	gf‹r_bË
[
i
] =ğ
lše_addr
) {

356 
f‹r_bË
[
i
] = 
makeNextSŒideAdd»ss
(f‹r_bË[i], 
¡ride
);

357 
	gf‹r_h™
[
i
]++;

358 ià(
	gf‹r_h™
[
i
] >ğ
m_Œaš_mis£s
) {

359 
®loc
 = 
Œue
;

361  
	gŒue
;

366 
	gloÿl_šdex
 = 
šdex
;

367 
	gf‹r_bË
[
loÿl_šdex
] = 
makeNextSŒideAdd»ss
(
lše_addr
, 
¡ride
);

368 
	gf‹r_h™
[
loÿl_šdex
] = 0;

369 
	gloÿl_šdex
 = 
loÿl_šdex
 + 1;

370 ià(
	gloÿl_šdex
 >ğ
m_num_un™_f‹rs
) {

371 
loÿl_šdex
 = 0;

374 
	gšdex
 = 
loÿl_šdex
;

375  
	gçl£
;

378 
boŞ


379 
	gP»ãtch”
::
	$acûssNÚun™F‹r
(
Addr
 
add»ss
, *
¡ride
,

380 
boŞ
 &
®loc
)

383 
®loc
 = 
çl£
;

386 
Addr
 
·ge_addr
 = 
	`·geAdd»ss
(
add»ss
);

387 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
add»ss
);

389 
ušt32_t
 
i
 = 0; i < 
m_num_nÚun™_f‹rs
; i++) {

390 ià(
	`·geAdd»ss
(
m_nÚun™_f‹r
[
i
]è=ğ
·ge_addr
) {

393 
d–
 = 
lše_addr
 - 
m_nÚun™_f‹r
[
i
];

395 ià(
d–
 != 0) {

398 ià(
d–
 =ğ
m_nÚun™_¡ride
[
i
]) {

401 
m_nÚun™_h™
[
i
]++;

402 ià(
m_nÚun™_h™
[
i
] > 
m_Œaš_mis£s
) {

406 *
¡ride
 = 
m_nÚun™_¡ride
[
i
] /

407 
RubySy¡em
::
	`g‘BlockSizeBy‹s
();

410 
	`ş—rNÚun™EÁry
(
i
);

411 
®loc
 = 
Œue
;

416 
m_nÚun™_h™
[
i
] = 0;

420 
m_nÚun™_¡ride
[
i
] = 
d–
;

421 
m_nÚun™_f‹r
[
i
] = 
lše_addr
;

422  
Œue
;

424  
çl£
;

430 
m_nÚun™_f‹r
[
m_nÚun™_šdex
] = 
lše_addr
;

431 
m_nÚun™_¡ride
[
m_nÚun™_šdex
] = 0;

432 
m_nÚun™_h™
[
m_nÚun™_šdex
] = 0;

434 
m_nÚun™_šdex
 = m_nonunit_index + 1;

435 ià(
m_nÚun™_šdex
 >ğ
m_num_nÚun™_f‹rs
) {

436 
m_nÚun™_šdex
 = 0;

438  
çl£
;

439 
	}
}

442 
	gP»ãtch”
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

444 
out
 << 
	`Çme
() << " Prefetcher State\n";

446 
out
 << "unitable:\n";

447 
i
 = 0; i < 
m_num_un™_f‹rs
; i++) {

448 
out
 << 
m_un™_f‹r
[
i
] << 
¡d
::
’dl
;

451 
out
 << "negativeable:\n";

452 
i
 = 0; i < 
m_num_un™_f‹rs
; i++) {

453 
out
 << 
m_Ãg©ive_f‹r
[
i
] << 
¡d
::
’dl
;

457 
out
 << "non-unitable:\n";

458 
i
 = 0; i < 
m_num_nÚun™_f‹rs
; i++) {

459 
out
 << 
m_nÚun™_f‹r
[
i
] << " "

460 << 
m_nÚun™_¡ride
[
i
] << " "

461 << 
m_nÚun™_h™
[
i
] << 
¡d
::
’dl
;

465 
out
 << "streams:\n";

466 
i
 = 0; i < 
m_num_¡»ams
; i++) {

467 
out
 << 
m_¬¿y
[
i
].
m_add»ss
 << " "

468 << 
m_¬¿y
[
i
].
m_¡ride
 << " "

469 << 
m_¬¿y
[
i
].
m_is_v®id
 << " "

470 << 
m_¬¿y
[
i
].
m_u£_time
 << 
¡d
::
’dl
;

472 
	}
}

474 
Addr


475 
	gP»ãtch”
::
	$·geAdd»ss
(
Addr
 
addr
) const

477  
	`maskLowOrd”B™s
(
addr
, 
m_·ge_shiá
);

478 
	}
}

	@ruby/structures/Prefetcher.hh

29 #iâdeà
__MEM_RUBY_STRUCTURES_PREFETCHER_HH__


30 
	#__MEM_RUBY_STRUCTURES_PREFETCHER_HH__


	)

34 
	~<b™£t
>

36 
	~"ba£/¡©i¡ics.hh
"

37 
	~"mem/ruby/commÚ/Add»ss.hh
"

38 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

39 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCÚŒŞËr.hh
"

40 
	~"mem/ruby/¦icc_š‹rçû/RubyReque¡.hh
"

41 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

42 
	~"·¿ms/P»ãtch”.hh
"

43 
	~"sim/sim_objeù.hh
"

44 
	~"sim/sy¡em.hh
"

46 
	#MAX_PF_INFLIGHT
 8

	)

48 şas 
	cP»ãtchEÁry


50 
	mpublic
:

52 
	$P»ãtchEÁry
()

55 
m_¡ride
 = (1 << 
RubySy¡em
::
	`g‘BlockSizeB™s
());

56 
m_u£_time
 = 
	`Cyşes
(0);

57 
m_is_v®id
 = 
çl£
;

61 
Addr
 
m_add»ss
;

64 
m_¡ride
;

67 
Cyşes
 
m_u£_time
;

70 
boŞ
 
m_is_v®id
;

73 
RubyReque¡Ty³
 
m_ty³
;

77 
¡d
::
b™£t
<
MAX_PF_INFLIGHT
> 
»que¡Issued
;

78 
¡d
::
b™£t
<
MAX_PF_INFLIGHT
> 
»que¡Com¶‘ed
;

79 
	}
};

81 şas 
	cP»ãtch”
 : 
public
 
SimObjeù


83 
public
:

84 
P»ãtch”P¬ams
 
	tP¬ams
;

85 
P»ãtch”
(cÚ¡ 
P¬ams
 *
p
);

86 ~
P»ãtch”
();

88 
issueNextP»ãtch
(
Addr
 
add»ss
, 
P»ãtchEÁry
 *
¡»am
);

95 
ob£rvePfH™
(
Addr
 
add»ss
);

96 
ob£rvePfMiss
(
Addr
 
add»ss
);

103 
ob£rveMiss
(
Addr
 
add»ss
, cÚ¡ 
RubyReque¡Ty³
& 
ty³
);

108 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

109 
	$£tCÚŒŞËr
(
Ab¡¿ùCÚŒŞËr
 *
_ù¾
)

110 { 
m_cÚŒŞËr
 = 
_ù¾
; }

112 
	`»gSts
();

114 
´iv©e
:

120 
ušt32_t
 
	`g‘LRUšdex
();

123 
	`ş—rNÚun™EÁry
(
ušt32_t
 
šdex
);

126 
	`š™ŸlizeSŒ—m
(
Addr
 
add»ss
, 
¡ride
,

127 
ušt32_t
 
šdex
, cÚ¡ 
RubyReque¡Ty³
& 
ty³
);

131 
P»ãtchEÁry
* 
	`g‘P»ãtchEÁry
(
Addr
 
add»ss
,

132 
ušt32_t
 &
šdex
);

135 
boŞ
 
	`acûssUn™F‹r
(
¡d
::
veùÜ
<
Addr
>& 
f‹r_bË
,

136 
ušt32_t
 *
h™_bË
, ušt32_ˆ&
šdex
, 
Addr
 
add»ss
,

137 
¡ride
, 
boŞ
 &
®loc
);

140 
boŞ
 
	`acûssNÚun™F‹r
(
Addr
 
add»ss
, *
¡ride
,

141 
boŞ
 &
®loc
);

144 
Addr
 
	$·geAdd»ss
(
Addr
 
addr
) const;

147 
ušt32_t
 
m_num_¡»ams
;

149 
¡d
::
veùÜ
<
P»ãtchEÁry
> 
m_¬¿y
;

152 
ušt32_t
 
m_Œaš_mis£s
;

154 
ušt32_t
 
m_num_¡¬tup_pfs
;

156 
ušt32_t
 
m_num_un™_f‹rs
;

158 
ušt32_t
 
m_num_nÚun™_f‹rs
;

162 
¡d
::
veùÜ
<
Addr
> 
m_un™_f‹r
;

164 
ušt32_t
 
m_un™_f‹r_šdex
;

167 
ušt32_t
 *
m_un™_f‹r_h™
;

171 
¡d
::
veùÜ
<
Addr
> 
m_Ãg©ive_f‹r
;

173 
ušt32_t
 
m_Ãg©ive_f‹r_šdex
;

176 
ušt32_t
 *
m_Ãg©ive_f‹r_h™
;

180 
¡d
::
veùÜ
<
Addr
> 
m_nÚun™_f‹r
;

182 *
m_nÚun™_¡ride
;

185 
ušt32_t
 *
m_nÚun™_h™
;

187 
ušt32_t
 
m_nÚun™_šdex
;

190 
boŞ
 
m_´eãtch_üoss_·ges
;

192 
Ab¡¿ùCÚŒŞËr
 *
m_cÚŒŞËr
;

194 cÚ¡ 
Addr
 
m_·ge_shiá
;

197 
Sts
::
SÿÏr
 
numMissOb£rved
;

199 
Sts
::
SÿÏr
 
numAÎoÿ‹dSŒ—ms
;

201 
Sts
::
SÿÏr
 
numP»ãtchReque¡ed
;

203 
Sts
::
SÿÏr
 
numP»ãtchAcû±ed
;

205 
Sts
::
SÿÏr
 
numDrİ³dP»ãtches
;

207 
Sts
::
SÿÏr
 
numH™s
;

209 
Sts
::
SÿÏr
 
numP¬tŸlH™s
;

211 
Sts
::
SÿÏr
 
numPagesCros£d
;

213 
Sts
::
SÿÏr
 
numMis£dP»ãtchedBlocks
;

214 
	}
};

	@ruby/structures/PseudoLRUPolicy.cc

31 
	~"mem/ruby/¡ruùu»s/P£udoLRUPŞicy.hh
"

35 
	gP£udoLRUPŞicy
::
	$P£udoLRUPŞicy
(cÚ¡ 
P¬ams
 * 
p
)

36 : 
	$Ab¡¿ùR•Ïûm’tPŞicy
(
p
)

39 
	`as£¹
(
m_num_£ts
 > 0 &&

40 
m_assoc
 > 1 &&

41 
m_assoc
 <ğ(
št64_t
è(
ušt64_t
)*4);

43 
m_Œ“s
 = 
NULL
;

44 
m_num_Ëv–s
 = 0;

46 
m_efãùive_assoc
 = 1;

47 
m_efãùive_assoc
 < 
m_assoc
) {

49 
m_efãùive_assoc
 <<= 1;

51 
tmp_assoc
 = 
m_efãùive_assoc
;

52 
Œue
) {

53 
tmp_assoc
 /= 2;

54 ià(!
tmp_assoc
) ;

55 
m_num_Ëv–s
++;

57 
	`as£¹
(
m_num_Ëv–s
 < ()*4);

58 
m_Œ“s
 = 
Ãw
 
ušt64_t
[
m_num_£ts
];

59 
i
 = 0; i < 
m_num_£ts
; i++) {

60 
m_Œ“s
[
i
] = 0;

62 
	}
}

64 
P£udoLRUPŞicy
 *

65 
	gP£udoLRUR•Ïûm’tPŞicyP¬ams
::
	$ü—‹
()

67  
Ãw
 
	`P£udoLRUPŞicy
(
this
);

68 
	}
}

71 
	gP£udoLRUPŞicy
::~
	$P£udoLRUPŞicy
()

73 ià(
m_Œ“s
 !ğ
NULL
)

74 
d–‘e
[] 
m_Œ“s
;

75 
	}
}

78 
	gP£udoLRUPŞicy
::
	$touch
(
št64_t
 
£t
, iÁ64_ˆ
šdex
, 
Tick
 
time
)

80 
	`as£¹
(
šdex
 >ğ0 && index < 
m_assoc
);

81 
	`as£¹
(
£t
 >ğ0 && s‘ < 
m_num_£ts
);

83 
Œ“_šdex
 = 0;

84 
node_v®
;

85 
i
 = 
m_num_Ëv–s
 - 1; i >= 0; i--) {

86 
node_v®
 = (
šdex
 >> 
i
)&1;

87 ià(
node_v®
)

88 
m_Œ“s
[
£t
] |ğ
node_v®
 << 
Œ“_šdex
;

90 
m_Œ“s
[
£t
] &ğ~(1 << 
Œ“_šdex
);

91 
Œ“_šdex
 = 
node_v®
 ? (tree_index*2)+2 : (tree_index*2)+1;

93 
m_Ï¡_»f_±r
[
£t
][
šdex
] = 
time
;

94 
	}
}

96 
št64_t


97 
	gP£udoLRUPŞicy
::
	$g‘Viùim
(
št64_t
 
£t
) const

99 
št64_t
 
šdex
 = 0;

101 
Œ“_šdex
 = 0;

102 
node_v®
;

103 
i
 = 0; i < 
m_num_Ëv–s
; i++){

104 
node_v®
 = (
m_Œ“s
[
£t
] >> 
Œ“_šdex
) & 1;

105 
šdex
 +ğ
node_v®
 ? 0 : (
m_efãùive_assoc
 >> (
i
 + 1));

106 
Œ“_šdex
 = 
node_v®
 ? (tree_index * 2) + 1 : (tree_index * 2) + 2;

108 
	`as£¹
(
šdex
 >ğ0 && index < 
m_efãùive_assoc
);

112  (
šdex
 > (
m_assoc
 - 1)) ? m_assoc - 1 : index;

113 
	}
}

	@ruby/structures/PseudoLRUPolicy.hh

30 #iâdeà
__MEM_RUBY_STRUCTURES_PSEUDOLRUPOLICY_HH__


31 
	#__MEM_RUBY_STRUCTURES_PSEUDOLRUPOLICY_HH__


	)

33 
	~"mem/ruby/¡ruùu»s/Ab¡¿ùR•Ïûm’tPŞicy.hh
"

34 
	~"·¿ms/P£udoLRUR•Ïûm’tPŞicy.hh
"

49 şas 
	cP£udoLRUPŞicy
 : 
public
 
Ab¡¿ùR•Ïûm’tPŞicy


51 
public
:

52 
P£udoLRUR•Ïûm’tPŞicyP¬ams
 
	tP¬ams
;

53 
P£udoLRUPŞicy
(cÚ¡ 
P¬ams
 * 
p
);

54 ~
P£udoLRUPŞicy
();

56 
touch
(
št64_t
 
£t
, iÁ64_ˆ
way
, 
Tick
 
time
);

57 
št64_t
 
	$g‘Viùim
(
št64_t
 
£t
) const;

59 
´iv©e
:

60 
m_efãùive_assoc
;

61 
m_num_Ëv–s
;

62 
ušt64_t
* 
m_Œ“s
;

	@ruby/structures/RubyMemoryControl.cc

108 
	~"ba£/ÿ¡.hh
"

109 
	~"ba£/ırštf.hh
"

110 
	~"ba£/¿ndom.hh
"

111 
	~"debug/RubyMemÜy.hh
"

112 
	~"mem/ruby/commÚ/Add»ss.hh
"

113 
	~"mem/ruby/´of”/Prof”.hh
"

114 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

115 
	~"mem/ruby/¦icc_š‹rçû/RubySlicc_CompÚ’tM­pšg.hh
"

116 
	~"mem/ruby/¡ruùu»s/RubyMemÜyCÚŒŞ.hh
"

117 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

119 
usšg
 
Çme¥aû
 
	g¡d
;

130 
	#IDLECOUNT_MAX_VALUE
 1000

	)

134 
	go¡»am
&

135 
	gİ”©Ü
<<(
	go¡»am
& 
	gout
, cÚ¡ 
	gRubyMemÜyCÚŒŞ
& 
	gobj
)

137 
	gobj
.
´št
(
out
);

138 
	gout
 << 
	gæush
;

139  
	gout
;

146 
	gRubyMemÜyCÚŒŞ
::
	$RubyMemÜyCÚŒŞ
(cÚ¡ 
P¬ams
 *
p
)

147 : 
	`Ab¡¿ùMemÜy
(
p
), 
	`CÚsum”
(
this
), 
	`pÜt
(
	`Çme
() + ".port", *this),

148 
	$m_ev’t
(
this
)

150 
m_bªks_³r_¿nk
 = 
p
->
bªks_³r_¿nk
;

151 
m_¿nks_³r_dimm
 = 
p
->
¿nks_³r_dimm
;

152 
m_dimms_³r_chªÃl
 = 
p
->
dimms_³r_chªÃl
;

153 
m_bªk_b™_0
 = 
p
->
bªk_b™_0
;

154 
m_¿nk_b™_0
 = 
p
->
¿nk_b™_0
;

155 
m_dimm_b™_0
 = 
p
->
dimm_b™_0
;

156 
m_bªk_queue_size
 = 
p
->
bªk_queue_size
;

157 
m_bªk_busy_time
 = 
p
->
bªk_busy_time
;

158 
m_¿nk_¿nk_d–ay
 = 
p
->
¿nk_¿nk_d–ay
;

159 
m_»ad_wr™e_d–ay
 = 
p
->
»ad_wr™e_d–ay
;

160 
m_basic_bus_busy_time
 = 
p
->
basic_bus_busy_time
;

161 
m_mem_ùl_Ï‹ncy
 = 
p
->
mem_ùl_Ï‹ncy
;

162 
m_»äesh_³riod
 = 
p
->
»äesh_³riod
;

163 
m_tFaw
 = 
p
->
tFaw
;

164 
m_mem_¿ndom_¬b™¿‹
 = 
p
->
mem_¿ndom_¬b™¿‹
;

165 
m_mem_fixed_d–ay
 = 
p
->
mem_fixed_d–ay
;

167 
m_´of”_±r
 = 
Ãw
 
	`MemCÁ¾Prof”
(
	`Çme
(),

168 
m_bªks_³r_¿nk
,

169 
m_¿nks_³r_dimm
,

170 
m_dimms_³r_chªÃl
);

172 
	`w¬n
("RubyMemoryControl is deprecated, use‡ DRAMCtrl subclass instead\n");

173 
	}
}

176 
	gRubyMemÜyCÚŒŞ
::
	$š™
()

178 
m_msg_couÁ”
 = 0;

179 
	`as£¹
(
m_tFaw
 <= 62);

181 
m_tÙ®_bªks
 = 
m_bªks_³r_¿nk
 * 
m_¿nks_³r_dimm
 * 
m_dimms_³r_chªÃl
;

182 
m_tÙ®_¿nks
 = 
m_¿nks_³r_dimm
 * 
m_dimms_³r_chªÃl
;

183 
m_»äesh_³riod_sy¡em
 = 
m_»äesh_³riod
 / 
m_tÙ®_bªks
;

185 
m_bªkQueues
 = 
Ãw
 
li¡
<
MemÜyNode
 *> [
m_tÙ®_bªks
];

186 
	`as£¹
(
m_bªkQueues
);

188 
m_bªkBusyCouÁ”
 = 
Ãw
 [
m_tÙ®_bªks
];

189 
	`as£¹
(
m_bªkBusyCouÁ”
);

191 
m_ŞdReque¡
 = 
Ãw
 [
m_tÙ®_bªks
];

192 
	`as£¹
(
m_ŞdReque¡
);

194 
i
 = 0; i < 
m_tÙ®_bªks
; i++) {

195 
m_bªkBusyCouÁ”
[
i
] = 0;

196 
m_ŞdReque¡
[
i
] = 0;

199 
m_busBusyCouÁ”_Basic
 = 0;

200 
m_busBusyCouÁ”_Wr™e
 = 0;

201 
m_busBusyCouÁ”_R—dNewRªk
 = 0;

202 
m_busBusy_WhichRªk
 = 0;

204 
m_roundRobš
 = 0;

205 
m_»äesh_couÁ
 = 1;

206 
m_Ãed_»äesh
 = 0;

207 
m_»äesh_bªk
 = 0;

208 
m_idËCouÁ
 = 0;

209 
m_ageCouÁ”
 = 0;

216 
m_tçw_shiá
 = 
Ãw
 
ušt64_t
[
m_tÙ®_¿nks
];

217 
m_tçw_couÁ
 = 
Ãw
 [
m_tÙ®_¿nks
];

218 
i
 = 0; i < 
m_tÙ®_¿nks
; i++) {

219 
m_tçw_shiá
[
i
] = 0;

220 
m_tçw_couÁ
[
i
] = 0;

222 
	}
}

224 
	gBa£SÏvePÜt
&

225 
	gRubyMemÜyCÚŒŞ
::
	$g‘SÏvePÜt
(cÚ¡ 
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

227 ià(
if_Çme
 != "port") {

228  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

230  
pÜt
;

232 
	}
}

235 
	gRubyMemÜyCÚŒŞ
::
	$»£t
()

237 
m_msg_couÁ”
 = 0;

239 
	`as£¹
(
m_tFaw
 <= 62);

241 
m_tÙ®_bªks
 = 
m_bªks_³r_¿nk
 * 
m_¿nks_³r_dimm
 * 
m_dimms_³r_chªÃl
;

242 
m_tÙ®_¿nks
 = 
m_¿nks_³r_dimm
 * 
m_dimms_³r_chªÃl
;

243 
m_»äesh_³riod_sy¡em
 = 
m_»äesh_³riod
 / 
m_tÙ®_bªks
;

245 
	`as£¹
(
m_bªkQueues
);

247 
	`as£¹
(
m_bªkBusyCouÁ”
);

249 
	`as£¹
(
m_ŞdReque¡
);

251 
i
 = 0; i < 
m_tÙ®_bªks
; i++) {

252 
m_bªkBusyCouÁ”
[
i
] = 0;

253 
m_ŞdReque¡
[
i
] = 0;

256 
m_busBusyCouÁ”_Basic
 = 0;

257 
m_busBusyCouÁ”_Wr™e
 = 0;

258 
m_busBusyCouÁ”_R—dNewRªk
 = 0;

259 
m_busBusy_WhichRªk
 = 0;

261 
m_roundRobš
 = 0;

262 
m_»äesh_couÁ
 = 1;

263 
m_Ãed_»äesh
 = 0;

264 
m_»äesh_bªk
 = 0;

265 
m_idËCouÁ
 = 0;

266 
m_ageCouÁ”
 = 0;

273 
i
 = 0; i < 
m_tÙ®_¿nks
; i++) {

274 
m_tçw_shiá
[
i
] = 0;

275 
m_tçw_couÁ
[
i
] = 0;

277 
	}
}

279 
	gRubyMemÜyCÚŒŞ
::~
	$RubyMemÜyCÚŒŞ
()

281 
d–‘e
 [] 
m_bªkQueues
;

282 
d–‘e
 [] 
m_bªkBusyCouÁ”
;

283 
d–‘e
 [] 
m_ŞdReque¡
;

284 
d–‘e
 
m_´of”_±r
;

285 
	}
}

288 
boŞ


289 
	gRubyMemÜyCÚŒŞ
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

291 
Cyşes
 
¬riv®_time
 = 
	`curCyşe
();

292 
Addr
 
addr
 = 
pkt
->
	`g‘Addr
();

293 
boŞ
 
is_mem_»ad
 = 
pkt
->
	`isR—d
();

295 
	`acûss
(
pkt
);

296 
MemÜyNode
 *
thisReq
 = 
Ãw
 
	`MemÜyNode
(
¬riv®_time
, 
pkt
, 
addr
,

297 
is_mem_»ad
, !is_mem_read);

298 
	`’queueMemRef
(
thisReq
);

299  
Œue
;

300 
	}
}

305 
	gRubyMemÜyCÚŒŞ
::
	$’queueMemRef
(
MemÜyNode
 *
memRef
)

307 
m_msg_couÁ”
++;

308 
memRef
->
m_msg_couÁ”
 = m_msg_counter;

309 
Addr
 
addr
 = 
memRef
->
m_addr
;

310 
bªk
 = 
	`g‘Bªk
(
addr
);

312 
m_´of”_±r
->
	`´ofeMemReq
(
bªk
);

313 
m_šput_queue
.
	`push_back
(
memRef
);

315 ià(!
m_ev’t
.
	`scheduËd
()) {

316 
	`scheduË
(
m_ev’t
, 
	`şockEdge
());

318 
	}
}

321 
	gRubyMemÜyCÚŒŞ
::
	$´št
(
o¡»am
& 
out
) const

323 
	}
}

327 
RubyMemÜyCÚŒŞ
::
	$’queueToDœeùÜy
(
MemÜyNode
 *
»q
, 
Cyşes
 
Ï‹ncy
)

329 
Tick
 
¬riv®_time
 = 
	`şockEdge
(
Ï‹ncy
);

330 
Pack‘PŒ
 
pkt
 = 
»q
->pkt;

333 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

337 
pÜt
.
	`schedTimšgRe¥
(
pkt
, 
¬riv®_time
);

339 
	`DPRINTF
(
RubyMemÜy
, "Enqueueing msg %#08x %c backo directory‡t %15d\n",

340 
»q
->
m_addr
,„eq->
m_is_mem_»ad
 ? 'R':'W', 
¬riv®_time
);

341 
	}
}

346 
	gRubyMemÜyCÚŒŞ
::
	$g‘Bªk
(cÚ¡ 
Addr
 
addr
) const

348 
dimm
 = (
addr
 >> 
m_dimm_b™_0
è& (
m_dimms_³r_chªÃl
 - 1);

349 
¿nk
 = (
addr
 >> 
m_¿nk_b™_0
è& (
m_¿nks_³r_dimm
 - 1);

350 
bªk
 = (
addr
 >> 
m_bªk_b™_0
è& (
m_bªks_³r_¿nk
 - 1);

351  (
dimm
 * 
m_¿nks_³r_dimm
 * 
m_bªks_³r_¿nk
)

352 + (
¿nk
 * 
m_bªks_³r_¿nk
)

353 + 
bªk
;

354 
	}
}

357 
	gRubyMemÜyCÚŒŞ
::
	$g‘Rªk
(cÚ¡ 
Addr
 
addr
) const

359 
bªk
 = 
	`g‘Bªk
(
addr
);

360 
¿nk
 = (
bªk
 / 
m_bªks_³r_¿nk
);

361 
	`as£¹
 (
¿nk
 < (
m_¿nks_³r_dimm
 * 
m_dimms_³r_chªÃl
));

362  
¿nk
;

363 
	}
}

368 
	gRubyMemÜyCÚŒŞ
::
	$g‘Rªk
(
bªk
) const

370 
¿nk
 = (
bªk
 / 
m_bªks_³r_¿nk
);

371 
	`as£¹
 (
¿nk
 < (
m_¿nks_³r_dimm
 * 
m_dimms_³r_chªÃl
));

372  
¿nk
;

373 
	}
}

377 
	gRubyMemÜyCÚŒŞ
::
	$g‘ChªÃl
(cÚ¡ 
Addr
 
addr
) const

379 
	`as£¹
(
çl£
);

381 
	}
}

385 
	gRubyMemÜyCÚŒŞ
::
	$g‘Row
(cÚ¡ 
Addr
 
addr
) const

387 
	`as£¹
(
çl£
);

389 
	}
}

393 
boŞ


394 
	gRubyMemÜyCÚŒŞ
::
	$queueR—dy
(
bªk
)

396 ià((
m_bªkBusyCouÁ”
[
bªk
] > 0è&& !
m_mem_fixed_d–ay
) {

397 
m_´of”_±r
->
	`´ofeMemBªkBusy
();

399 
	`DPRINTF
(
RubyMemÜy
, "bªk %x busy %d\n", 
bªk
, 
m_bªkBusyCouÁ”
[bank]);

400  
çl£
;

403 ià(
m_mem_¿ndom_¬b™¿‹
 >= 2) {

404 ià(
¿ndom_mt
.
	`¿ndom
(0, 100è< 
m_mem_¿ndom_¬b™¿‹
) {

405 
m_´of”_±r
->
	`´ofeMemRªdBusy
();

406  
çl£
;

410 ià(
m_mem_fixed_d–ay
)

411  
Œue
;

413 ià((
m_ageCouÁ”
 > (2 * 
m_bªk_busy_time
)è&& !
m_ŞdReque¡
[
bªk
]) {

414 
m_´of”_±r
->
	`´ofeMemNÙOld
();

415  
çl£
;

418 ià(
m_busBusyCouÁ”_Basic
 =ğ
m_basic_bus_busy_time
) {

424 
m_´of”_±r
->
	`´ofeMemArbWa™
(1);

425  
çl£
;

428 ià(
m_busBusyCouÁ”_Basic
 > 0) {

429 
m_´of”_±r
->
	`´ofeMemBusBusy
();

430  
çl£
;

433 
¿nk
 = 
	`g‘Rªk
(
bªk
);

434 ià(
m_tçw_couÁ
[
¿nk
] >ğ
ACTIVATE_PER_TFAW
) {

435 
m_´of”_±r
->
	`´ofeMemTçwBusy
();

436  
çl£
;

439 
boŞ
 
wr™e
 = !
m_bªkQueues
[
bªk
].
	`äÚt
()->
m_is_mem_»ad
;

440 ià(
wr™e
 && (
m_busBusyCouÁ”_Wr™e
 > 0)) {

441 
m_´of”_±r
->
	`´ofeMemR—dWr™eBusy
();

442  
çl£
;

445 ià(!
wr™e
 && (
¿nk
 !ğ
m_busBusy_WhichRªk
)

446 && (
m_busBusyCouÁ”_R—dNewRªk
 > 0)) {

447 
m_´of”_±r
->
	`´ofeMemD©aBusBusy
();

448  
çl£
;

451  
Œue
;

452 
	}
}

456 
boŞ


457 
	gRubyMemÜyCÚŒŞ
::
	$issueReäesh
(
bªk
)

459 ià(!
m_Ãed_»äesh
 || (
m_»äesh_bªk
 !ğ
bªk
))

460  
çl£
;

461 ià(
m_bªkBusyCouÁ”
[
bªk
] > 0)

462  
çl£
;

465 ià(
m_busBusyCouÁ”_Basic
 > 0)

466  
çl£
;

467 
¿nk
 = 
	`g‘Rªk
(
bªk
);

468 ià(
m_tçw_couÁ
[
¿nk
] >ğ
ACTIVATE_PER_TFAW
)

469  
çl£
;

472 
	`DPRINTF
(
RubyMemÜy
, "Reäesh bªk %3x\n", 
bªk
);

474 
m_´of”_±r
->
	`´ofeMemReäesh
();

475 
m_Ãed_»äesh
--;

476 
m_»äesh_bªk
++;

477 ià(
m_»äesh_bªk
 >ğ
m_tÙ®_bªks
)

478 
m_»äesh_bªk
 = 0;

479 
m_bªkBusyCouÁ”
[
bªk
] = 
m_bªk_busy_time
;

480 
m_busBusyCouÁ”_Basic
 = 
m_basic_bus_busy_time
;

481 
m_busBusyCouÁ”_Wr™e
 = 
m_basic_bus_busy_time
;

482 
m_busBusyCouÁ”_R—dNewRªk
 = 
m_basic_bus_busy_time
;

483 
	`m¬kTçw
(
¿nk
);

484  
Œue
;

485 
	}
}

489 
	gRubyMemÜyCÚŒŞ
::
	$m¬kTçw
(
¿nk
)

491 ià(
m_tFaw
) {

492 
m_tçw_shiá
[
¿nk
] |ğ(1 << (
m_tFaw
-1));

493 
m_tçw_couÁ
[
¿nk
]++;

495 
	}
}

501 
	gRubyMemÜyCÚŒŞ
::
	$issueReque¡
(
bªk
)

503 
¿nk
 = 
	`g‘Rªk
(
bªk
);

504 
MemÜyNode
 *
»q
 = 
m_bªkQueues
[
bªk
].
	`äÚt
();

505 
m_bªkQueues
[
bªk
].
	`pİ_äÚt
();

507 
	`DPRINTF
(
RubyMemÜy
, "Mem issue„equest%7d: %#08x %c "

508 "bªk=%3x sched %c\n", 
»q
->
m_msg_couÁ”
,„eq->
m_addr
,

509 
»q
->
m_is_mem_»ad
? 'R':'W',

510 
bªk
, 
m_ev’t
.
	`scheduËd
() ? 'Y':'N');

512 
	`’queueToDœeùÜy
(
»q
, 
	`Cyşes
(
m_mem_ùl_Ï‹ncy
 + 
m_mem_fixed_d–ay
));

514 
m_ŞdReque¡
[
bªk
] = 0;

515 
	`m¬kTçw
(
¿nk
);

516 
m_bªkBusyCouÁ”
[
bªk
] = 
m_bªk_busy_time
;

517 
m_busBusy_WhichRªk
 = 
¿nk
;

518 ià(
»q
->
m_is_mem_»ad
) {

519 
m_´of”_±r
->
	`´ofeMemR—d
();

520 
m_busBusyCouÁ”_Basic
 = 
m_basic_bus_busy_time
;

521 
m_busBusyCouÁ”_Wr™e
 = 
m_basic_bus_busy_time
 + 
m_»ad_wr™e_d–ay
;

522 
m_busBusyCouÁ”_R—dNewRªk
 =

523 
m_basic_bus_busy_time
 + 
m_¿nk_¿nk_d–ay
;

525 
m_´of”_±r
->
	`´ofeMemWr™e
();

526 
m_busBusyCouÁ”_Basic
 = 
m_basic_bus_busy_time
;

527 
m_busBusyCouÁ”_Wr™e
 = 
m_basic_bus_busy_time
;

528 
m_busBusyCouÁ”_R—dNewRªk
 = 
m_basic_bus_busy_time
;

531 
d–‘e
 
»q
;

532 
	}
}

537 
	gRubyMemÜyCÚŒŞ
::
	$execu‹Cyşe
()

540 
bªk
=0; bªk < 
m_tÙ®_bªks
; bank++) {

541 ià(
m_bªkBusyCouÁ”
[
bªk
] > 0) m_bankBusyCounter[bank]--;

543 ià(
m_busBusyCouÁ”_Wr™e
 > 0)

544 
m_busBusyCouÁ”_Wr™e
--;

545 ià(
m_busBusyCouÁ”_R—dNewRªk
 > 0)

546 
m_busBusyCouÁ”_R—dNewRªk
--;

547 ià(
m_busBusyCouÁ”_Basic
 > 0)

548 
m_busBusyCouÁ”_Basic
--;

551 
¿nk
=0;„ªk < 
m_tÙ®_¿nks
;„ank++) {

552 ià(
m_tçw_shiá
[
¿nk
] & 1è
m_tçw_couÁ
[rank]--;

553 
m_tçw_shiá
[
¿nk
] >>= 1;

558 ià(!
m_mem_fixed_d–ay
è
m_»äesh_couÁ
--;

559 ià(
m_»äesh_couÁ
 == 0) {

560 
m_»äesh_couÁ
 = 
m_»äesh_³riod_sy¡em
;

563 
	`as£¹
(
m_Ãed_»äesh
 < 10);

564 
m_Ãed_»äesh
++;

568 
m_ageCouÁ”
++;

569 
ªyOld
 = 0;

570 
bªk
=0; bªk < 
m_tÙ®_bªks
; bank++) {

571 
ªyOld
 |ğ
m_ŞdReque¡
[
bªk
];

573 ià(!
ªyOld
) {

574 
bªk
=0; bªk < 
m_tÙ®_bªks
; bank++) {

575 ià(!
m_bªkQueues
[
bªk
].
	`em±y
()è
m_ŞdReque¡
[bank] = 1;

577 
m_ageCouÁ”
 = 0;

581 ià(
m_mem_¿ndom_¬b™¿‹
) {

582 
m_roundRobš
 = 
¿ndom_mt
.
	`¿ndom
(0, 
m_tÙ®_bªks
 - 1);

591 
queueH—ds
 = 0;

592 
bªksIssued
 = 0;

593 
i
 = 0; i < 
m_tÙ®_bªks
; i++) {

594 
m_roundRobš
++;

595 ià(
m_roundRobš
 >ğ
m_tÙ®_bªks
) m_roundRobin = 0;

596 
	`issueReäesh
(
m_roundRobš
);

597 
qs
 = 
m_bªkQueues
[
m_roundRobš
].
	`size
();

598 ià(
qs
 > 1) {

599 
m_´of”_±r
->
	`´ofeMemBªkQ
(
qs
-1);

601 ià(
qs
 > 0) {

603 
m_idËCouÁ
 = 
IDLECOUNT_MAX_VALUE
;

604 
queueH—ds
++;

605 ià(
	`queueR—dy
(
m_roundRobš
)) {

606 
	`issueReque¡
(
m_roundRobš
);

607 
bªksIssued
++;

608 ià(
m_mem_fixed_d–ay
) {

609 
m_´of”_±r
->
	`´ofeMemWa™Cyşes
(
m_mem_fixed_d–ay
);

617 
m_´of”_±r
->
	`´ofeMemWa™Cyşes
(
queueH—ds
 - 
bªksIssued
);

625 ià(!
m_šput_queue
.
	`em±y
()) {

627 
m_idËCouÁ
 = 
IDLECOUNT_MAX_VALUE
;

628 
MemÜyNode
 *
»q
 = 
m_šput_queue
.
	`äÚt
();

629 
bªk
 = 
	`g‘Bªk
(
»q
->
m_addr
);

630 ià(
m_bªkQueues
[
bªk
].
	`size
(è< 
m_bªk_queue_size
) {

631 
m_šput_queue
.
	`pİ_äÚt
();

632 
m_bªkQueues
[
bªk
].
	`push_back
(
»q
);

634 
m_´of”_±r
->
	`´ofeMemIÅutQ
(
m_šput_queue
.
	`size
());

636 
	}
}

638 
D¿šS‹


639 
	gRubyMemÜyCÚŒŞ
::
	$d¿š
()

641 
	`DPRINTF
(
RubyMemÜy
, "MemoryController drain\n");

642 ià(
m_ev’t
.
	`scheduËd
()) {

643 
	`descheduË
(
m_ev’t
);

645  
D¿šS‹
::
D¿šed
;

646 
	}
}

650 
	gRubyMemÜyCÚŒŞ
::
	$wakeup
()

652 
	`DPRINTF
(
RubyMemÜy
, "MemoryController wakeup\n");

654 
	`execu‹Cyşe
();

656 
m_idËCouÁ
--;

657 ià(
m_idËCouÁ
 > 0) {

658 
	`as£¹
(!
m_ev’t
.
	`scheduËd
());

659 
	`scheduË
(
m_ev’t
, 
	`şockEdge
(
	`Cyşes
(1)));

661 
	}
}

672 
boŞ


673 
	gRubyMemÜyCÚŒŞ
::
	$funùiÚ®R—d
(
Pack‘
 *
pkt
)

675 
¡d
::
li¡
<
MemÜyNode
 *>::
™”©Ü
 
™
 = 
m_šput_queue
.
	`begš
();

676 
™
 !ğ
m_šput_queue
.
	`’d
(); ++it) {

677 
Pack‘PŒ
 
msg
 = (*
™
)->
pkt
;

678 ià(
pkt
->
	`checkFunùiÚ®
(
msg
)) {

679  
Œue
;

683 
¡d
::
li¡
<
MemÜyNode
 *>::
™”©Ü
 
™
 = 
m_»¥Ú£_queue
.
	`begš
();

684 
™
 !ğ
m_»¥Ú£_queue
.
	`’d
(); ++it) {

685 
Pack‘PŒ
 
msg
 = (*
™
)->
pkt
;

686 ià(
pkt
->
	`checkFunùiÚ®
(
msg
)) {

687  
Œue
;

691 
ušt32_t
 
bªk
 = 0; bªk < 
m_tÙ®_bªks
; ++bank) {

692 
¡d
::
li¡
<
MemÜyNode
 *>::
™”©Ü
 
™
 = 
m_bªkQueues
[
bªk
].
	`begš
();

693 
™
 !ğ
m_bªkQueues
[
bªk
].
	`’d
(); ++it) {

694 
Pack‘PŒ
 
msg
 = (*
™
)->
pkt
;

695 ià(
pkt
->
	`checkFunùiÚ®
(
msg
)) {

696  
Œue
;

701 
	`funùiÚ®Acûss
(
pkt
);

702  
Œue
;

703 
	}
}

713 
ušt32_t


714 
	gRubyMemÜyCÚŒŞ
::
	$funùiÚ®Wr™e
(
Pack‘
 *
pkt
)

716 
ušt32_t
 
num_funùiÚ®_wr™es
 = 0;

718 
¡d
::
li¡
<
MemÜyNode
 *>::
™”©Ü
 
™
 = 
m_šput_queue
.
	`begš
();

719 
™
 !ğ
m_šput_queue
.
	`’d
(); ++it) {

720 
Pack‘PŒ
 
msg
 = (*
™
)->
pkt
;

721 ià(
pkt
->
	`checkFunùiÚ®
(
msg
)) {

722 
num_funùiÚ®_wr™es
++;

726 
¡d
::
li¡
<
MemÜyNode
 *>::
™”©Ü
 
™
 = 
m_»¥Ú£_queue
.
	`begš
();

727 
™
 !ğ
m_»¥Ú£_queue
.
	`’d
(); ++it) {

728 
Pack‘PŒ
 
msg
 = (*
™
)->
pkt
;

729 ià(
pkt
->
	`checkFunùiÚ®
(
msg
)) {

730 
num_funùiÚ®_wr™es
++;

734 
ušt32_t
 
bªk
 = 0; bªk < 
m_tÙ®_bªks
; ++bank) {

735 
¡d
::
li¡
<
MemÜyNode
 *>::
™”©Ü
 
™
 = 
m_bªkQueues
[
bªk
].
	`begš
();

736 
™
 !ğ
m_bªkQueues
[
bªk
].
	`’d
(); ++it) {

737 
Pack‘PŒ
 
msg
 = (*
™
)->
pkt
;

738 ià(
pkt
->
	`checkFunùiÚ®
(
msg
)) {

739 
num_funùiÚ®_wr™es
++;

744 
	`funùiÚ®Acûss
(
pkt
);

745 
num_funùiÚ®_wr™es
++;

746  
num_funùiÚ®_wr™es
;

747 
	}
}

750 
	gRubyMemÜyCÚŒŞ
::
	$»gSts
()

752 
m_´of”_±r
->
	`»gSts
();

753 
Ab¡¿ùMemÜy
::
	`»gSts
();

754 
	}
}

756 
RubyMemÜyCÚŒŞ
 *

757 
	gRubyMemÜyCÚŒŞP¬ams
::
	$ü—‹
()

759  
Ãw
 
	`RubyMemÜyCÚŒŞ
(
this
);

760 
	}
}

762 
	gRubyMemÜyCÚŒŞ
::
MemÜyPÜt
::
	$MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
,

763 
RubyMemÜyCÚŒŞ
& 
_memÜy
)

764 : 
	`QueuedSÏvePÜt
(
Çme
, &
_memÜy
, 
queue
), 
	`queue
(_memÜy, *
this
),

765 
	$memÜy
(
_memÜy
)

766 { 
	}
}

768 
AddrRªgeLi¡


769 
	gRubyMemÜyCÚŒŞ
::
MemÜyPÜt
::
	$g‘AddrRªges
() const

771 
AddrRªgeLi¡
 
¿nges
;

772 
¿nges
.
	`push_back
(
memÜy
.
	`g‘AddrRªge
());

773  
¿nges
;

774 
	}
}

777 
	gRubyMemÜyCÚŒŞ
::
MemÜyPÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

779 
pkt
->
	`pushLab–
(
memÜy
.
	`Çme
());

781 ià(!
queue
.
	`checkFunùiÚ®
(
pkt
)) {

785 
memÜy
.
	`funùiÚ®Wr™e
(
pkt
);

788 
pkt
->
	`pİLab–
();

789 
	}
}

791 
Tick


792 
	gRubyMemÜyCÚŒŞ
::
MemÜyPÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

794 
	`·nic
("This controller does‚ot support„ecv‡tomic!\n");

795 
	}
}

797 
boŞ


798 
	gRubyMemÜyCÚŒŞ
::
MemÜyPÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

801  
memÜy
.
	`»cvTimšgReq
(
pkt
);

802 
	}
}

	@ruby/structures/RubyMemoryControl.hh

30 #iâdeà
__MEM_RUBY_STRUCTURES_MEMORY_CONTROL_HH__


31 
	#__MEM_RUBY_STRUCTURES_MEMORY_CONTROL_HH__


	)

33 
	~<io¡»am
>

34 
	~<li¡
>

35 
	~<¡ršg
>

37 
	~"mem/ab¡¿ù_mem.hh
"

38 
	~"mem/´ÙocŞ/MemÜyMsg.hh
"

39 
	~"mem/ruby/commÚ/Add»ss.hh
"

40 
	~"mem/ruby/´of”/MemCÁ¾Prof”.hh
"

41 
	~"mem/ruby/¡ruùu»s/MemÜyNode.hh
"

42 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

43 
	~"·¿ms/RubyMemÜyCÚŒŞ.hh
"

47 
	#ACTIVATE_PER_TFAW
 4

	)

51 
şass
 
	gRubyMemÜyCÚŒŞ
 : 
public
 
Ab¡¿ùMemÜy
,…ubliø
	gCÚsum”


53 
	gpublic
:

54 
RubyMemÜyCÚŒŞP¬ams
 
	tP¬ams
;

55 
RubyMemÜyCÚŒŞ
(cÚ¡ 
P¬ams
 *
p
);

56 
š™
(è
	gov”ride
;

57 
»£t
();

59 ~
RubyMemÜyCÚŒŞ
();

61 
vœtu®
 
	gBa£SÏvePÜt
& 
g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

62 
PÜtID
 
idx
 = 
Inv®idPÜtID
è
ov”ride
;

63 
D¿šS‹
 
d¿š
(è
	gov”ride
;

64 
wakeup
(è
	gov”ride
;

66 
£tDesütiÚ
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
è{ 
m_desütiÚ
 =‚ame; };

67 
	g¡d
::
¡ršg
 
g‘DesütiÚ
(è{  
m_desütiÚ
; };

70 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

71 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

72 
’queueMemRef
(
MemÜyNode
 *
memRef
);

73 
boŞ
 
¬eNSlÙsAvaabË
(
n
è{  
	gŒue
; };

75 
´št
(
¡d
::
o¡»am
& 
out
ècÚ¡ 
ov”ride
;

76 
»gSts
(è
	gov”ride
;

78 
g‘Bªk
(cÚ¡ 
Addr
 
addr
) const;

79 
g‘Rªk
(cÚ¡ 
Addr
 
addr
) const;

82 
g‘ChªÃl
(cÚ¡ 
Addr
 
addr
) const;

83 
g‘Row
(cÚ¡ 
Addr
 
addr
) const;

86 
g‘BªksP”Rªk
(è{  
	gm_bªks_³r_¿nk
; };

87 
g‘RªksP”Dimm
(è{  
	gm_¿nks_³r_dimm
; };

88 
g‘DimmsP”ChªÃl
(è{  
	gm_dimms_³r_chªÃl
; }

90 
boŞ
 
funùiÚ®R—d
(
Pack‘
 *
pkt
);

91 
ušt32_t
 
funùiÚ®Wr™e
(
Pack‘
 *
pkt
);

93 
	g´iv©e
:

94 
’queueToDœeùÜy
(
MemÜyNode
 *
»q
, 
Cyşes
 
Ï‹ncy
);

95 
g‘Rªk
(
bªk
) const;

96 
boŞ
 
queueR—dy
(
bªk
);

97 
issueReque¡
(
bªk
);

98 
boŞ
 
issueReäesh
(
bªk
);

99 
m¬kTçw
(
¿nk
);

100 
execu‹Cyşe
();

103 
RubyMemÜyCÚŒŞ
 (cÚ¡ RubyMemÜyCÚŒŞ& 
obj
);

104 
	gRubyMemÜyCÚŒŞ
& 
	gİ”©Ü
=(cÚ¡ 
RubyMemÜyCÚŒŞ
& 
obj
);

106 
	g´iv©e
:

109 şas 
	cMemÜyPÜt
 : 
public
 
QueuedSÏvePÜt


111 
Re¥Pack‘Queue
 
queue
;

112 
	gRubyMemÜyCÚŒŞ
& 
	gmemÜy
;

114 
	gpublic
:

115 
MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
RubyMemÜyCÚŒŞ
& 
_memÜy
);

117 
	g´Ùeùed
:

118 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

120 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

122 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
);

124 
vœtu®
 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

131 
MemÜyPÜt
 
	gpÜt
;

134 
	g¡d
::
¡ršg
 
m_desütiÚ
;

135 
	gm_msg_couÁ”
;

137 
	gm_bªks_³r_¿nk
;

138 
	gm_¿nks_³r_dimm
;

139 
	gm_dimms_³r_chªÃl
;

140 
	gm_bªk_b™_0
;

141 
	gm_¿nk_b™_0
;

142 
	gm_dimm_b™_0
;

143 
	gm_bªk_queue_size
;

144 
	gm_bªk_busy_time
;

145 
	gm_¿nk_¿nk_d–ay
;

146 
	gm_»ad_wr™e_d–ay
;

147 
	gm_basic_bus_busy_time
;

148 
Cyşes
 
	gm_mem_ùl_Ï‹ncy
;

149 
	gm_»äesh_³riod
;

150 
	gm_mem_¿ndom_¬b™¿‹
;

151 
	gm_tFaw
;

152 
Cyşes
 
	gm_mem_fixed_d–ay
;

154 
	gm_tÙ®_bªks
;

155 
	gm_tÙ®_¿nks
;

156 
	gm_»äesh_³riod_sy¡em
;

159 
	g¡d
::
li¡
<
MemÜyNode
 *> 
m_»¥Ú£_queue
;

160 
	g¡d
::
li¡
<
MemÜyNode
 *> 
m_šput_queue
;

161 
	g¡d
::
li¡
<
MemÜyNode
 *>* 
m_bªkQueues
;

165 *
	gm_bªkBusyCouÁ”
;

166 *
	gm_ŞdReque¡
;

168 
ušt64_t
 *
	gm_tçw_shiá
;

169 *
	gm_tçw_couÁ
;

173 
	gm_busBusyCouÁ”_Wr™e
;

174 
	gm_busBusyCouÁ”_R—dNewRªk
;

175 
	gm_busBusyCouÁ”_Basic
;

177 
	gm_busBusy_WhichRªk
;

178 
	gm_roundRobš
;

179 
	gm_»äesh_couÁ
;

180 
	gm_Ãed_»äesh
;

181 
	gm_»äesh_bªk
;

182 
	gm_ageCouÁ”
;

183 
	gm_idËCouÁ
;

185 
MemCÁ¾Prof”
 *
	gm_´of”_±r
;

187 şas 
	cMemCÁ¾Ev’t
 : 
public
 
Ev’t


189 
public
:

190 
MemCÁ¾Ev’t
(
RubyMemÜyCÚŒŞ
 *
_mem_úŒl
)

192 
mem_úŒl
 = 
_mem_úŒl
;

194 
	g´iv©e
:

195 
´oûss
(è{ 
mem_úŒl
->
wakeup
(); }

197 
RubyMemÜyCÚŒŞ
* 
	gmem_úŒl
;

200 
MemCÁ¾Ev’t
 
	gm_ev’t
;

203 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gRubyMemÜyCÚŒŞ
& 
	gobj
);

	@ruby/structures/TBETable.hh

29 #iâdeà
__MEM_RUBY_STRUCTURES_TBETABLE_HH__


30 
	#__MEM_RUBY_STRUCTURES_TBETABLE_HH__


	)

32 
	~<io¡»am
>

33 
	~<unÜd”ed_m­
>

35 
	~"mem/ruby/commÚ/Add»ss.hh
"

37 
	g‹m¶©e
<
şass
 
	gENTRY
>

38 şas 
	cTBETabË


40 
	mpublic
:

41 
	$TBETabË
(
numb”_of_TBEs
)

42 : 
	$m_numb”_of_TBEs
(
numb”_of_TBEs
)

46 
boŞ
 
	$isP»£Á
(
Addr
 
add»ss
) const;

47 
	`®loÿ‹
(
Addr
 
add»ss
);

48 
	`d—Îoÿ‹
(
Addr
 
add»ss
);

49 
boŞ


50 
	$¬eNSlÙsAvaabË
(
n
, 
Tick
 
cu¼’t_time
) const

52  (
m_numb”_of_TBEs
 - 
m_m­
.
	`size
()è>ğ
n
;

53 
	}
}

55 
ENTRY
 *
lookup
(
Addr
 
add»ss
);

58 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

60 
´iv©e
:

62 
	`TBETabË
(cÚ¡ 
TBETabË
& 
obj
);

63 
TBETabË
& 
İ”©Ü
=(cÚ¡ TBETabË& 
obj
);

66 
¡d
::
unÜd”ed_m­
<
Addr
, 
ENTRY
> 
m_m­
;

68 
´iv©e
:

69 
m_numb”_of_TBEs
;

70 
	}
};

72 
	g‹m¶©e
<
şass
 
	gENTRY
>

73 
šlše
 
	g¡d
::
o¡»am
&

74 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gTBETabË
<
	gENTRY
>& 
	gobj
)

76 
	gobj
.
´št
(
out
);

77 
	gout
 << 
	g¡d
::
æush
;

78  
	gout
;

81 
	g‹m¶©e
<
şass
 
	gENTRY
>

82 
šlše
 
boŞ


83 
	gTBETabË
<
	gENTRY
>::
	$isP»£Á
(
Addr
 
add»ss
) const

85 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

86 
	`as£¹
(
m_m­
.
	`size
(è<ğ
m_numb”_of_TBEs
);

87  !!
m_m­
.
	`couÁ
(
add»ss
);

88 
	}
}

90 
	g‹m¶©e
<
şass
 
	gENTRY
>

91 
šlše
 

92 
	gTBETabË
<
	gENTRY
>::
	$®loÿ‹
(
Addr
 
add»ss
)

94 
	`as£¹
(!
	`isP»£Á
(
add»ss
));

95 
	`as£¹
(
m_m­
.
	`size
(è< 
m_numb”_of_TBEs
);

96 
m_m­
[
add»ss
] = 
	`ENTRY
();

97 
	}
}

99 
	g‹m¶©e
<
şass
 
	gENTRY
>

100 
šlše
 

101 
	gTBETabË
<
	gENTRY
>::
	$d—Îoÿ‹
(
Addr
 
add»ss
)

103 
	`as£¹
(
	`isP»£Á
(
add»ss
));

104 
	`as£¹
(
m_m­
.
	`size
() > 0);

105 
m_m­
.
	`”a£
(
add»ss
);

106 
	}
}

109 
	g‹m¶©e
<
şass
 
	gENTRY
>

110 
šlše
 
ENTRY
*

111 
	gTBETabË
<
	gENTRY
>::
	$lookup
(
Addr
 
add»ss
)

113 ià(
m_m­
.
	`fšd
(
add»ss
è!ğm_m­.
	`’d
()è &(m_m­.fšd×dd»ss)->
£cÚd
);

114  
NULL
;

115 
	}
}

118 
	g‹m¶©e
<
şass
 
	gENTRY
>

119 
šlše
 

120 
	gTBETabË
<
	gENTRY
>::
	$´št
(
¡d
::
o¡»am
& 
out
) const

122 
	}
}

	@ruby/structures/TimerTable.cc

29 
	~"mem/ruby/¡ruùu»s/Tim”TabË.hh
"

31 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

33 
	gTim”TabË
::
	$Tim”TabË
()

34 : 
	$m_Ãxt_time
(0)

36 
m_cÚsum”_±r
 = 
NULL
;

37 
m_Ãxt_v®id
 = 
çl£
;

38 
m_Ãxt_add»ss
 = 0;

39 
	}
}

41 
boŞ


42 
	gTim”TabË
::
	$isR—dy
(
Tick
 
curTime
) const

44 ià(
m_m­
.
	`em±y
())

45  
çl£
;

47 ià(!
m_Ãxt_v®id
) {

48 
	`upd©eNext
();

50 
	`as£¹
(
m_Ãxt_v®id
);

51  (
curTime
 >ğ
m_Ãxt_time
);

52 
	}
}

54 
Addr


55 
	gTim”TabË
::
	$ÃxtAdd»ss
() const

57 ià(!
m_Ãxt_v®id
) {

58 
	`upd©eNext
();

60 
	`as£¹
(
m_Ãxt_v®id
);

61  
m_Ãxt_add»ss
;

62 
	}
}

65 
	gTim”TabË
::
	$£t
(
Addr
 
add»ss
, 
Tick
 
»ady_time
)

67 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

68 
	`as£¹
(!
m_m­
.
	`couÁ
(
add»ss
));

70 
m_m­
[
add»ss
] = 
»ady_time
;

71 
	`as£¹
(
m_cÚsum”_±r
 !ğ
NULL
);

72 
m_cÚsum”_±r
->
	`scheduËEv’tAbsŞu‹
(
»ady_time
);

73 
m_Ãxt_v®id
 = 
çl£
;

76 ià(
»ady_time
 <ğ
m_Ãxt_time
) {

77 
m_Ãxt_v®id
 = 
çl£
;

79 
	}
}

82 
	gTim”TabË
::
	$un£t
(
Addr
 
add»ss
)

84 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

85 
	`as£¹
(
m_m­
.
	`couÁ
(
add»ss
));

86 
m_m­
.
	`”a£
(
add»ss
);

89 ià(
add»ss
 =ğ
m_Ãxt_add»ss
) {

90 
m_Ãxt_v®id
 = 
çl£
;

92 
	}
}

95 
	gTim”TabË
::
	$´št
(
¡d
::
o¡»am
& 
out
) const

97 
	}
}

100 
Tim”TabË
::
	$upd©eNext
() const

102 ià(
m_m­
.
	`em±y
()) {

103 
	`as£¹
(!
m_Ãxt_v®id
);

107 
Add»ssM­
::
cÚ¡_™”©Ü
 
i
 = 
m_m­
.
	`begš
();

108 
Add»ssM­
::
cÚ¡_™”©Ü
 
’d
 = 
m_m­
.
	`’d
();

110 
m_Ãxt_add»ss
 = 
i
->
fœ¡
;

111 
m_Ãxt_time
 = 
i
->
£cÚd
;

112 ++
i
;

114 ; 
i
 !ğ
’d
; ++i) {

115 ià(
i
->
£cÚd
 < 
m_Ãxt_time
) {

116 
m_Ãxt_add»ss
 = 
i
->
fœ¡
;

117 
m_Ãxt_time
 = 
i
->
£cÚd
;

121 
m_Ãxt_v®id
 = 
Œue
;

122 
	}
}

	@ruby/structures/TimerTable.hh

29 #iâdeà
__MEM_RUBY_STRUCTURES_TIMERTABLE_HH__


30 
	#__MEM_RUBY_STRUCTURES_TIMERTABLE_HH__


	)

32 
	~<ÿs£¹
>

33 
	~<io¡»am
>

34 
	~<m­
>

35 
	~<¡ršg
>

37 
	~"mem/ruby/commÚ/Add»ss.hh
"

38 
	~"mem/ruby/commÚ/CÚsum”.hh
"

40 şas 
	cTim”TabË


42 
	mpublic
:

43 
Tim”TabË
();

46 
	$£tCÚsum”
(
CÚsum”
* 
cÚsum”_±r
)

48 
	`as£¹
(
m_cÚsum”_±r
 =ğ
NULL
);

49 
m_cÚsum”_±r
 = 
cÚsum”_±r
;

53 
	$£tDesütiÚ
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
)

55 
m_Çme
 = 
Çme
;

56 
	}
}

58 
boŞ
 
	$isR—dy
(
Tick
 
curTime
) const;

59 
Addr
 
	$ÃxtAdd»ss
() const;

60 
boŞ
 
	$isS‘
(
Addr
 
add»ss
ècÚ¡ {  !!
m_m­
.
	`couÁ
×dd»ss); 
	}
}

61 
£t
(
Addr
 
add»ss
, 
Tick
 
»ady_time
);

62 
un£t
(
Addr
 
add»ss
);

63 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

65 
´iv©e
:

66 
	$upd©eNext
() const;

69 
	`Tim”TabË
(cÚ¡ 
Tim”TabË
& 
obj
);

70 
Tim”TabË
& 
İ”©Ü
=(cÚ¡ Tim”TabË& 
obj
);

76 
¡d
::
	tm­
<
	tAddr
, 
	tTick
> 
	tAdd»ssM­
;

77 
Add»ssM­
 
m_m­
;

78 
mubË
 
boŞ
 
m_Ãxt_v®id
;

79 
mubË
 
Tick
 
m_Ãxt_time
;

80 
mubË
 
Addr
 
m_Ãxt_add»ss
;

83 
CÚsum”
* 
m_cÚsum”_±r
;

85 
¡d
::
¡ršg
 
m_Çme
;

86 
	}
};

88 
šlše
 
	g¡d
::
o¡»am
&

89 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gTim”TabË
& 
	gobj
)

91 
	gobj
.
´št
(
out
);

92 
	gout
 << 
	g¡d
::
æush
;

93  
	gout
;

	@ruby/structures/WireBuffer.cc

32 
	~<®gÜ™hm
>

33 
	~<funùiÚ®
>

35 
	~"ba£/ırštf.hh
"

36 
	~"ba£/¡l_h–³rs.hh
"

37 
	~"mem/ruby/¡ruùu»s/WœeBufãr.hh
"

38 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

40 
usšg
 
Çme¥aû
 
	g¡d
;

44 
	go¡»am
&

45 
	gİ”©Ü
<<(
	go¡»am
& 
	gout
, cÚ¡ 
	gWœeBufãr
& 
	gobj
)

47 
	gobj
.
´št
(
out
);

48 
	gout
 << 
	gæush
;

49  
	gout
;

56 
	gWœeBufãr
::
	$WœeBufãr
(cÚ¡ 
P¬ams
 *
p
)

57 : 
	$SimObjeù
(
p
)

59 
m_msg_couÁ”
 = 0;

60 
	}
}

63 
	gWœeBufãr
::
	$š™
()

65 
	}
}

67 
WœeBufãr
::~
	$WœeBufãr
()

69 
	}
}

72 
WœeBufãr
::
	$’queue
(
MsgPŒ
 
mes§ge
, 
Tick
 
cu¼’t_time
, Tick 
d–
)

74 
m_msg_couÁ”
++;

75 
Tick
 
¬riv®_time
 = 
cu¼’t_time
 + 
d–
;

76 
	`as£¹
(
¬riv®_time
 > 
cu¼’t_time
);

78 
Mes§ge
* 
msg_±r
 = 
mes§ge
.
	`g‘
();

79 
msg_±r
->
	`£tLa¡EnqueueTime
(
¬riv®_time
);

80 
m_mes§ge_queue
.
	`push_back
(
mes§ge
);

81 ià(
m_cÚsum”_±r
 !ğ
NULL
) {

82 
m_cÚsum”_±r
->

83 
	`scheduËEv’tAbsŞu‹
(
¬riv®_time
);

85 
	`·nic
("NØCÚsum” fÜ WœeBufãr! %s\n", *
this
);

87 
	}
}

90 
	gWœeBufãr
::
	$dequeue
(
Tick
 
cu¼’t_time
)

92 
	`as£¹
(
	`isR—dy
(
cu¼’t_time
));

93 
	`pİ_h—p
(
m_mes§ge_queue
.
	`begš
(), m_mes§ge_queue.
	`’d
(),

94 
g»©”
<
MsgPŒ
>());

95 
m_mes§ge_queue
.
	`pİ_back
();

96 
	}
}

98 cÚ¡ 
Mes§ge
*

99 
	gWœeBufãr
::
	$³ek
()

101 
Mes§ge
* 
msg_±r
 = 
m_mes§ge_queue
.
	`äÚt
().
	`g‘
();

102 
	`as£¹
(
msg_±r
 !ğ
NULL
);

103  
msg_±r
;

104 
	}
}

107 
	gWœeBufãr
::
	$»cyşe
(
Tick
 
cu¼’t_time
, Tick 
»cyşe_Ï‹ncy
)

113 
	`as£¹
(
	`isR—dy
(
cu¼’t_time
));

114 
MsgPŒ
 
node
 = 
m_mes§ge_queue
.
	`äÚt
();

115 
	`pİ_h—p
(
m_mes§ge_queue
.
	`begš
(), m_mes§ge_queue.
	`’d
(), 
g»©”
<
MsgPŒ
>());

117 
Tick
 
futu»_time
 = 
cu¼’t_time
 + 
»cyşe_Ï‹ncy
;

118 
node
->
	`£tLa¡EnqueueTime
(
futu»_time
);

120 
m_mes§ge_queue
.
	`back
(èğ
node
;

121 
	`push_h—p
(
m_mes§ge_queue
.
	`begš
(), m_mes§ge_queue.
	`’d
(),

122 
g»©”
<
MsgPŒ
>());

123 
m_cÚsum”_±r
->

124 
	`scheduËEv’tAbsŞu‹
(
futu»_time
);

125 
	}
}

127 
boŞ


128 
	gWœeBufãr
::
	$isR—dy
(
Tick
 
cu¼’t_time
)

130  ((!
m_mes§ge_queue
.
	`em±y
()) &&

131 (
m_mes§ge_queue
.
	`äÚt
()->
	`g‘La¡EnqueueTime
(è<ğ
cu¼’t_time
));

132 
	}
}

135 
	gWœeBufãr
::
	$´št
(
o¡»am
& 
out
) const

137 
	}
}

140 
WœeBufãr
::
	$wakeup
()

142 
	}
}

144 
WœeBufãr
 *

145 
RubyWœeBufãrP¬ams
::
	$ü—‹
()

147  
Ãw
 
	`WœeBufãr
(
this
);

148 
	}
}

	@ruby/structures/WireBuffer.hh

32 #iâdeà
__MEM_RUBY_STRUCTURES_WIREBUFFER_HH__


33 
	#__MEM_RUBY_STRUCTURES_WIREBUFFER_HH__


	)

35 
	~<io¡»am
>

36 
	~<¡ršg
>

37 
	~<veùÜ
>

39 
	~"mem/ruby/commÚ/CÚsum”.hh
"

40 
	~"mem/ruby/¦icc_š‹rçû/Mes§ge.hh
"

41 
	~"·¿ms/RubyWœeBufãr.hh
"

42 
	~"sim/sim_objeù.hh
"

54 
şass
 
	gMes§ge
;

56 şas 
	cWœeBufãr
 : 
public
 
SimObjeù


58 
public
:

59 
RubyWœeBufãrP¬ams
 
	tP¬ams
;

60 
WœeBufãr
(cÚ¡ 
P¬ams
 *
p
);

61 
š™
();

63 ~
WœeBufãr
();

65 
wakeup
();

67 
	$£tCÚsum”
(
CÚsum”
* 
cÚsum”_±r
)

69 
m_cÚsum”_±r
 = 
cÚsum”_±r
;

71 
CÚsum”
* 
	$g‘CÚsum”
(è{  
m_cÚsum”_±r
; 
	}
};

72 
	$£tDesütiÚ
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
è{ 
m_desütiÚ
 =‚ame; 
	}
};

73 
	g¡d
::
¡ršg
 
	$g‘DesütiÚ
(è{  
m_desütiÚ
; 
	}
};

75 
’queue
(
MsgPŒ
 
mes§ge
, 
Tick
 
cu¼’t_time
, Tick 
d–
);

76 
dequeue
(
Tick
 
cu¼’t_time
);

77 cÚ¡ 
Mes§ge
* 
³ek
();

78 
»cyşe
(
Tick
 
cu¼’t_time
, Tick 
»cyşe_Ï‹ncy
);

79 
boŞ
 
isR—dy
(
Tick
 
cu¼’t_time
);

81 
boŞ
 
	$¬eNSlÙsAvaabË
(
n
, 
Tick
 
cu¼’t_time
è{  
Œue
; 
	}
};

83 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

84 
ušt64_t
 
m_msg_couÁ”
;

86 
´iv©e
:

88 
	`WœeBufãr
 (cÚ¡ 
WœeBufãr
& 
obj
);

89 
WœeBufãr
& 
İ”©Ü
=(cÚ¡ WœeBufãr& 
obj
);

92 
CÚsum”
* 
m_cÚsum”_±r
;

93 
¡d
::
¡ršg
 
m_desütiÚ
;

96 
¡d
::
veùÜ
<
MsgPŒ
> 
m_mes§ge_queue
;

97 
	}
};

99 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gWœeBufãr
& 
	gobj
);

	@ruby/system/CacheRecorder.cc

30 
	~"debug/RubyCacheT¿û.hh
"

31 
	~"mem/ruby/sy¡em/CacheRecÜd”.hh
"

32 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

33 
	~"mem/ruby/sy¡em/Sequ’ûr.hh
"

35 
usšg
 
Çme¥aû
 
	g¡d
;

38 
	gT¿ûRecÜd
::
	$´št
(
o¡»am
& 
out
) const

40 
out
 << "[T¿ûRecÜd: Node, " << 
m_úŒl_id
 << ", "

41 << 
m_d©a_add»ss
 << ", " << 
m_pc_add»ss
 << ", "

42 << 
m_ty³
 << ", Time: " << 
m_time
 << "]";

43 
	}
}

45 
	gCacheRecÜd”
::
	$CacheRecÜd”
()

46 : 
	`m_uncom´es£d_Œaû
(
NULL
),

47 
	`m_uncom´es£d_Œaû_size
(0),

48 
	`m_block_size_by‹s
(
RubySy¡em
::
	$g‘BlockSizeBy‹s
())

50 
	}
}

52 
CacheRecÜd”
::CacheRecÜd”(
ušt8_t
* 
uncom´es£d_Œaû
,

53 
ušt64_t
 
uncom´es£d_Œaû_size
,

54 
¡d
::
veùÜ
<
Sequ’ûr
*>& 
£q_m­
,

55 
ušt64_t
 
block_size_by‹s
)

56 : 
m_uncom´es£d_Œaû
(
uncom´es£d_Œaû
),

57 
m_uncom´es£d_Œaû_size
(
uncom´es£d_Œaû_size
),

58 
m_£q_m­
(
£q_m­
), 
m_by‹s_»ad
(0), 
m_»cÜds_»ad
(0),

59 
m_»cÜds_æushed
(0), 
	$m_block_size_by‹s
(
block_size_by‹s
)

61 ià(
m_uncom´es£d_Œaû
 !ğ
NULL
) {

62 ià(
m_block_size_by‹s
 < 
RubySy¡em
::
	`g‘BlockSizeBy‹s
()) {

66 
	`·nic
("Recorded cache block size (%d) < current block size (%d) !!",

67 
m_block_size_by‹s
, 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

70 
	}
}

72 
	gCacheRecÜd”
::~
	$CacheRecÜd”
()

74 ià(
m_uncom´es£d_Œaû
 !ğ
NULL
) {

75 
d–‘e
 [] 
m_uncom´es£d_Œaû
;

76 
m_uncom´es£d_Œaû
 = 
NULL
;

78 
m_£q_m­
.
	`ş—r
();

79 
	}
}

82 
	gCacheRecÜd”
::
	$’queueNextFlushReque¡
()

84 ià(
m_»cÜds_æushed
 < 
m_»cÜds
.
	`size
()) {

85 
T¿ûRecÜd
* 
»c
 = 
m_»cÜds
[
m_»cÜds_æushed
];

86 
m_»cÜds_æushed
++;

87 
Reque¡
* 
»q
 = 
Ãw
 
	`Reque¡
(
»c
->
m_d©a_add»ss
,

88 
m_block_size_by‹s
, 0,

89 
Reque¡
::
funcMa¡”Id
);

90 
MemCmd
::
Commªd
 
»que¡Ty³
 = MemCmd::
FlushReq
;

91 
Pack‘
 *
pkt
 = 
Ãw
 
	`Pack‘
(
»q
, 
»que¡Ty³
);

93 
Sequ’ûr
* 
m_£qu’ûr_±r
 = 
m_£q_m­
[
»c
->
m_úŒl_id
];

94 
	`as£¹
(
m_£qu’ûr_±r
 !ğ
NULL
);

95 
m_£qu’ûr_±r
->
	`makeReque¡
(
pkt
);

97 
	`DPRINTF
(
RubyCacheT¿û
, "Flushšg %s\n", *
»c
);

99 
	`DPRINTF
(
RubyCacheT¿û
, "Flushed‡Î %d„ecÜds\n", 
m_»cÜds_æushed
);

101 
	}
}

104 
	gCacheRecÜd”
::
	$’queueNextF‘chReque¡
()

106 ià(
m_by‹s_»ad
 < 
m_uncom´es£d_Œaû_size
) {

107 
T¿ûRecÜd
* 
ŒaûRecÜd
 = (T¿ûRecÜd*è(
m_uncom´es£d_Œaû
 +

108 
m_by‹s_»ad
);

110 
	`DPRINTF
(
RubyCacheT¿û
, "Issušg %s\n", *
ŒaûRecÜd
);

112 
»c_by‹s_»ad
 = 0;„ec_by‹s_»ad < 
m_block_size_by‹s
;

113 
»c_by‹s_»ad
 +ğ
RubySy¡em
::
	`g‘BlockSizeBy‹s
()) {

114 
Reque¡
* 
»q
 = 
nuÎ±r
;

115 
MemCmd
::
Commªd
 
»que¡Ty³
;

117 ià(
ŒaûRecÜd
->
m_ty³
 =ğ
RubyReque¡Ty³_LD
) {

118 
»que¡Ty³
 = 
MemCmd
::
R—dReq
;

119 
»q
 = 
Ãw
 
	`Reque¡
(
ŒaûRecÜd
->
m_d©a_add»ss
 + 
»c_by‹s_»ad
,

120 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(), 0, 
Reque¡
::
funcMa¡”Id
);

121 } ià(
ŒaûRecÜd
->
m_ty³
 =ğ
RubyReque¡Ty³_IFETCH
) {

122 
»que¡Ty³
 = 
MemCmd
::
R—dReq
;

123 
»q
 = 
Ãw
 
	`Reque¡
(
ŒaûRecÜd
->
m_d©a_add»ss
 + 
»c_by‹s_»ad
,

124 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(),

125 
Reque¡
::
INST_FETCH
, Reque¡::
funcMa¡”Id
);

127 
»que¡Ty³
 = 
MemCmd
::
Wr™eReq
;

128 
»q
 = 
Ãw
 
	`Reque¡
(
ŒaûRecÜd
->
m_d©a_add»ss
 + 
»c_by‹s_»ad
,

129 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(), 0, 
Reque¡
::
funcMa¡”Id
);

132 
Pack‘
 *
pkt
 = 
Ãw
 
	`Pack‘
(
»q
, 
»que¡Ty³
);

133 
pkt
->
	`d©aStic
(
ŒaûRecÜd
->
m_d©a
 + 
»c_by‹s_»ad
);

135 
Sequ’ûr
* 
m_£qu’ûr_±r
 = 
m_£q_m­
[
ŒaûRecÜd
->
m_úŒl_id
];

136 
	`as£¹
(
m_£qu’ûr_±r
 !ğ
NULL
);

137 
m_£qu’ûr_±r
->
	`makeReque¡
(
pkt
);

140 
m_by‹s_»ad
 +ğ((
T¿ûRecÜd
è+ 
m_block_size_by‹s
);

141 
m_»cÜds_»ad
++;

143 
	`DPRINTF
(
RubyCacheT¿û
, "F‘ched‡Î %d„ecÜds\n", 
m_»cÜds_»ad
);

145 
	}
}

148 
	gCacheRecÜd”
::
	$addRecÜd
(
úŒl
, 
Addr
 
d©a_addr
, Add¸
pc_addr
,

149 
RubyReque¡Ty³
 
ty³
, 
Tick
 
time
, 
D©aBlock
& 
d©a
)

151 
T¿ûRecÜd
* 
»c
 = (T¿ûRecÜd*)
	`m®loc
((TraceRecord) +

152 
m_block_size_by‹s
);

153 
»c
->
m_úŒl_id
 = 
úŒl
;

154 
»c
->
m_time
 = 
time
;

155 
»c
->
m_d©a_add»ss
 = 
d©a_addr
;

156 
»c
->
m_pc_add»ss
 = 
pc_addr
;

157 
»c
->
m_ty³
 = 
ty³
;

158 
	`memıy
(
»c
->
m_d©a
, 
d©a
.
	`g‘D©a
(0, 
m_block_size_by‹s
),

159 
m_block_size_by‹s
);

161 
m_»cÜds
.
	`push_back
(
»c
);

162 
	}
}

164 
ušt64_t


165 
	gCacheRecÜd”
::
	$agg»g©eRecÜds
(
ušt8_t
 **
buf
, 
ušt64_t
 
tÙ®_size
)

167 
¡d
::
	`sÜt
(
m_»cÜds
.
	`begš
(), m_»cÜds.
	`’d
(), 
com·»T¿ûRecÜds
);

169 
size
 = 
m_»cÜds
.
	`size
();

170 
ušt64_t
 
cu¼’t_size
 = 0;

171 
»cÜd_size
 = (
T¿ûRecÜd
è+ 
m_block_size_by‹s
;

173 
i
 = 0; i < 
size
; ++i) {

175 ià(
cu¼’t_size
 + 
»cÜd_size
 > 
tÙ®_size
) {

176 
ušt8_t
* 
Ãw_buf
 = 
	`Ãw
 (
nÙhrow
èušt8_t[
tÙ®_size
 * 2];

177 ià(
Ãw_buf
 =ğ
NULL
) {

178 
	`çl
("Unableo‡llocate buffer of size %s\n",

179 
tÙ®_size
 * 2);

181 
tÙ®_size
 =otal_size * 2;

182 
ušt8_t
* 
Şd_buf
 = *
buf
;

183 
	`memıy
(
Ãw_buf
, 
Şd_buf
, 
cu¼’t_size
);

184 *
buf
 = 
Ãw_buf
;

185 
d–‘e
 [] 
Şd_buf
;

189 
	`memıy
(&((*
buf
)[
cu¼’t_size
]), 
m_»cÜds
[
i
], 
»cÜd_size
);

190 
cu¼’t_size
 +ğ
»cÜd_size
;

192 
	`ä“
(
m_»cÜds
[
i
]);

193 
m_»cÜds
[
i
] = 
NULL
;

196 
m_»cÜds
.
	`ş—r
();

197  
cu¼’t_size
;

198 
	}
}

	@ruby/system/CacheRecorder.hh

35 #iâdeà
__MEM_RUBY_RECORDER_CACHERECORDER_HH__


36 
	#__MEM_RUBY_RECORDER_CACHERECORDER_HH__


	)

38 
	~<veùÜ
>

40 
	~"ba£/ty³s.hh
"

41 
	~"mem/´ÙocŞ/RubyReque¡Ty³.hh
"

42 
	~"mem/ruby/commÚ/Add»ss.hh
"

43 
	~"mem/ruby/commÚ/D©aBlock.hh
"

44 
	~"mem/ruby/commÚ/Ty³Defšes.hh
"

46 
şass
 
	gSequ’ûr
;

54 şas 
	cT¿ûRecÜd
 {

55 
	mpublic
:

56 
m_úŒl_id
;

57 
Tick
 
	mm_time
;

58 
Addr
 
	mm_d©a_add»ss
;

59 
Addr
 
	mm_pc_add»ss
;

60 
RubyReque¡Ty³
 
	mm_ty³
;

61 
ušt8_t
 
	mm_d©a
[0];

63 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

66 şas 
	cCacheRecÜd”


68 
public
:

69 
	`CacheRecÜd”
();

70 ~
	`CacheRecÜd”
();

72 
	`CacheRecÜd”
(
ušt8_t
* 
uncom´es£d_Œaû
,

73 
ušt64_t
 
uncom´es£d_Œaû_size
,

74 
¡d
::
veùÜ
<
Sequ’ûr
*>& 
Sequ’ûrM­
,

75 
ušt64_t
 
block_size_by‹s
);

76 
	`addRecÜd
(
úŒl
, 
Addr
 
d©a_addr
, Add¸
pc_addr
,

77 
RubyReque¡Ty³
 
ty³
, 
Tick
 
time
, 
D©aBlock
& 
d©a
);

79 
ušt64_t
 
	`agg»g©eRecÜds
(
ušt8_t
 **
d©a
, ušt64_ˆ
size
);

89 
	`’queueNextFlushReque¡
();

98 
	`’queueNextF‘chReque¡
();

100 
´iv©e
:

102 
	`CacheRecÜd”
(cÚ¡ 
CacheRecÜd”
& 
obj
);

103 
CacheRecÜd”
& 
İ”©Ü
=(cÚ¡ CacheRecÜd”& 
obj
);

105 
¡d
::
veùÜ
<
T¿ûRecÜd
*> 
m_»cÜds
;

106 
ušt8_t
* 
m_uncom´es£d_Œaû
;

107 
ušt64_t
 
m_uncom´es£d_Œaû_size
;

108 
¡d
::
veùÜ
<
Sequ’ûr
*> 
m_£q_m­
;

109 
ušt64_t
 
m_by‹s_»ad
;

110 
ušt64_t
 
m_»cÜds_»ad
;

111 
ušt64_t
 
m_»cÜds_æushed
;

112 
ušt64_t
 
m_block_size_by‹s
;

115 
šlše
 
boŞ


116 
	$com·»T¿ûRecÜds
(cÚ¡ 
T¿ûRecÜd
* 
n1
, cÚ¡ T¿ûRecÜd* 
n2
)

118  
n1
->
m_time
 > 
n2
->m_time;

119 
	}
}

121 
šlše
 
	g¡d
::
o¡»am
&

122 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gT¿ûRecÜd
& 
	gobj
)

124 
	gobj
.
´št
(
out
);

125 
	gout
 << 
	g¡d
::
æush
;

126  
	gout
;

	@ruby/system/DMASequencer.cc

29 
	~<memÜy
>

31 
	~"debug/RubyDma.hh
"

32 
	~"debug/RubySts.hh
"

33 
	~"mem/´ÙocŞ/Sequ’ûrMsg.hh
"

34 
	~"mem/´ÙocŞ/Sequ’ûrReque¡Ty³.hh
"

35 
	~"mem/ruby/sy¡em/DMASequ’ûr.hh
"

36 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

38 
	gDMAReque¡
::
	$DMAReque¡
(
ušt64_t
 
¡¬t_·ddr
, 
Ën
, 
boŞ
 
wr™e
,

39 
by‹s_com¶‘ed
, 
by‹s_issued
, 
ušt8_t
 *
d©a
,

40 
Pack‘PŒ
 
pkt
)

41 : 
	`¡¬t_·ddr
(
¡¬t_·ddr
), 
	`Ën
(
Ën
), 
	`wr™e
(
wr™e
),

42 
	`by‹s_com¶‘ed
(
by‹s_com¶‘ed
), 
	`by‹s_issued
(
by‹s_issued
), 
	`d©a
(
d©a
),

43 
	$pkt
(
pkt
)

45 
	}
}

47 
	gDMASequ’ûr
::
	$DMASequ’ûr
(cÚ¡ 
P¬ams
 *
p
)

48 : 
	`RubyPÜt
(
p
), 
	`m_out¡ªdšg_couÁ
(0),

49 
	`m_max_out¡ªdšg_»que¡s
(
p
->
max_out¡ªdšg_»que¡s
)

51 
	}
}

54 
	gDMASequ’ûr
::
	$š™
()

56 
RubyPÜt
::
	`š™
();

57 
m_d©a_block_mask
 = 
	`mask
(
RubySy¡em
::
	`g‘BlockSizeB™s
());

59 cÚ¡‡utØ&
s_pÜt
 : 
¦ave_pÜts
)

60 
s_pÜt
->
	`£ndRªgeChªge
();

61 
	}
}

63 
Reque¡Stus


64 
	gDMASequ’ûr
::
	$makeReque¡
(
Pack‘PŒ
 
pkt
)

66 ià(
m_out¡ªdšg_couÁ
 =ğ
m_max_out¡ªdšg_»que¡s
) {

67  
Reque¡Stus_BufãrFuÎ
;

70 
Addr
 
·ddr
 = 
pkt
->
	`g‘Addr
();

71 
ušt8_t
* 
d©a
 = 
pkt
->
g‘PŒ
<uint8_t>();

72 
Ën
 = 
pkt
->
	`g‘Size
();

73 
boŞ
 
wr™e
 = 
pkt
->
	`isWr™e
();

75 
	`as£¹
(
m_out¡ªdšg_couÁ
 < 
m_max_out¡ªdšg_»que¡s
);

76 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
·ddr
);

77 autØ
em¶aû_·œ
 =

78 
m_Reque¡TabË
.
	`em¶aû
(
¡d
::
p›ûwi£_cÚ¡ruù
,

79 
¡d
::
	`fÜw¬d_as_tu¶e
(
lše_addr
),

80 
¡d
::
	`fÜw¬d_as_tu¶e
(
·ddr
, 
Ën
, 
wr™e
, 0,

81 0, 
d©a
, 
pkt
));

82 
DMAReque¡
& 
aùive_»que¡
 = 
em¶aû_·œ
.
fœ¡
->
£cÚd
;

87 ià(!
em¶aû_·œ
.
£cÚd
) {

88 
	`DPRINTF
(
RubyDma
, "DMA‡lŸ£d:‡dd¸%p,†’ %d\n", 
lše_addr
, 
Ën
);

89  
Reque¡Stus_AlŸ£d
;

92 
	`DPRINTF
(
RubyDma
, "DMA„eq c»©ed:‡dd¸%p,†’ %d\n", 
lše_addr
, 
Ën
);

94 
¡d
::
sh¬ed_±r
<
Sequ’ûrMsg
> 
msg
 =

95 
¡d
::
make_sh¬ed
<
Sequ’ûrMsg
>(
	`şockEdge
());

96 
msg
->
	`g‘PhysiÿlAdd»ss
(èğ
·ddr
;

97 
msg
->
	`g‘LšeAdd»ss
(èğ
lše_addr
;

98 
msg
->
	`g‘Ty³
(èğ
wr™e
 ? 
Sequ’ûrReque¡Ty³_ST
 : 
Sequ’ûrReque¡Ty³_LD
;

99 
off£t
 = 
·ddr
 & 
m_d©a_block_mask
;

101 
msg
->
	`g‘L’
(èğ(
off£t
 + 
Ën
è<ğ
RubySy¡em
::
	`g‘BlockSizeBy‹s
() ?

102 
Ën
 : 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(è- 
off£t
;

104 ià(
wr™e
 && (
d©a
 !ğ
NULL
)) {

105 ià(
aùive_»que¡
.
d©a
 !ğ
NULL
) {

106 
msg
->
	`g‘D©aBlk
().
	`£tD©a
(
d©a
, 
off£t
, msg->
	`g‘L’
());

110 
m_out¡ªdšg_couÁ
++;

112 
	`as£¹
(
m_mªd©Üy_q_±r
 !ğ
NULL
);

113 
m_mªd©Üy_q_±r
->
	`’queue
(
msg
, 
	`şockEdge
(), 
	`cyşesToTicks
(
	`Cyşes
(1)));

114 
aùive_»que¡
.
by‹s_issued
 +ğ
msg
->
	`g‘L’
();

116  
Reque¡Stus_Issued
;

117 
	}
}

120 
	gDMASequ’ûr
::
	$issueNext
(cÚ¡ 
Addr
& 
add»ss
)

122 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_Reque¡TabË
.
	`fšd
(
add»ss
);

123 
	`as£¹
(
i
 !ğ
m_Reque¡TabË
.
	`’d
());

125 
DMAReque¡
 &
aùive_»que¡
 = 
i
->
£cÚd
;

127 
	`as£¹
(
m_out¡ªdšg_couÁ
 <ğ
m_max_out¡ªdšg_»que¡s
);

128 
aùive_»que¡
.
by‹s_com¶‘ed
 =‡ùive_»que¡.
by‹s_issued
;

129 ià(
aùive_»que¡
.
Ën
 =ğaùive_»que¡.
by‹s_com¶‘ed
) {

130 
	`DPRINTF
(
RubyDma
, "DMA„equest completed:‡ddr %p, size %d\n",

131 
add»ss
, 
aùive_»que¡
.
Ën
);

132 
m_out¡ªdšg_couÁ
--;

133 
Pack‘PŒ
 
pkt
 = 
aùive_»que¡
.pkt;

134 
m_Reque¡TabË
.
	`”a£
(
i
);

135 
	`ruby_h™_ÿÎback
(
pkt
);

139 
¡d
::
sh¬ed_±r
<
Sequ’ûrMsg
> 
msg
 =

140 
¡d
::
make_sh¬ed
<
Sequ’ûrMsg
>(
	`şockEdge
());

141 
msg
->
	`g‘PhysiÿlAdd»ss
(èğ
aùive_»que¡
.
¡¬t_·ddr
 +

142 
aùive_»que¡
.
by‹s_com¶‘ed
;

144 
	`as£¹
((
msg
->
	`g‘PhysiÿlAdd»ss
(è& 
m_d©a_block_mask
) == 0);

145 
msg
->
	`g‘LšeAdd»ss
(èğ
	`makeLšeAdd»ss
(msg->
	`g‘PhysiÿlAdd»ss
());

147 
msg
->
	`g‘Ty³
(èğ(
aùive_»que¡
.
wr™e
 ? 
Sequ’ûrReque¡Ty³_ST
 :

148 
Sequ’ûrReque¡Ty³_LD
);

150 
msg
->
	`g‘L’
() =

151 (
aùive_»que¡
.
Ën
 -

152 
aùive_»que¡
.
by‹s_com¶‘ed
 < 
RubySy¡em
::
	`g‘BlockSizeBy‹s
() ?

153 
aùive_»que¡
.
Ën
 -‡ùive_»que¡.
by‹s_com¶‘ed
 :

154 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

156 ià(
aùive_»que¡
.
wr™e
) {

157 
msg
->
	`g‘D©aBlk
().

158 
	`£tD©a
(&
aùive_»que¡
.
d©a
[aùive_»que¡.
by‹s_com¶‘ed
],

159 0, 
msg
->
	`g‘L’
());

162 
	`as£¹
(
m_mªd©Üy_q_±r
 !ğ
NULL
);

163 
m_mªd©Üy_q_±r
->
	`’queue
(
msg
, 
	`şockEdge
(), 
	`cyşesToTicks
(
	`Cyşes
(1)));

164 
aùive_»que¡
.
by‹s_issued
 +ğ
msg
->
	`g‘L’
();

165 
	`DPRINTF
(
RubyDma
,

167 
aùive_»que¡
.
by‹s_issued
,‡ùive_»que¡.
by‹s_com¶‘ed
,

168 
aùive_»que¡
.
Ën
);

169 
	}
}

172 
	gDMASequ’ûr
::
	$d©aC®lback
(cÚ¡ 
D©aBlock
 & 
dblk
, cÚ¡ 
Addr
& 
add»ss
)

175 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_Reque¡TabË
.
	`fšd
(
add»ss
);

176 
	`as£¹
(
i
 !ğ
m_Reque¡TabË
.
	`’d
());

178 
DMAReque¡
 &
aùive_»que¡
 = 
i
->
£cÚd
;

179 
Ën
 = 
aùive_»que¡
.
by‹s_issued
 -‡ùive_»que¡.
by‹s_com¶‘ed
;

180 
off£t
 = 0;

181 ià(
aùive_»que¡
.
by‹s_com¶‘ed
 == 0)

182 
off£t
 = 
aùive_»que¡
.
¡¬t_·ddr
 & 
m_d©a_block_mask
;

183 
	`as£¹
(!
aùive_»que¡
.
wr™e
);

184 ià(
aùive_»que¡
.
d©a
 !ğ
NULL
) {

185 
	`memıy
(&
aùive_»que¡
.
d©a
[aùive_»que¡.
by‹s_com¶‘ed
],

186 
dblk
.
	`g‘D©a
(
off£t
, 
Ën
),†en);

188 
	`issueNext
(
add»ss
);

189 
	}
}

192 
	gDMASequ’ûr
::
	$ackC®lback
(cÚ¡ 
Addr
& 
add»ss
)

194 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_Reque¡TabË
.
	`fšd
(
add»ss
);

195 
	`as£¹
(
i
 !ğ
m_Reque¡TabË
.
	`’d
());

197 
	`issueNext
(
add»ss
);

198 
	}
}

201 
	gDMASequ’ûr
::
	$»cÜdReque¡Ty³
(
DMASequ’ûrReque¡Ty³
 
»que¡Ty³
)

203 
	`DPRINTF
(
RubySts
, "Recorded statistic: %s\n",

204 
	`DMASequ’ûrReque¡Ty³_to_¡ršg
(
»que¡Ty³
));

205 
	}
}

207 
DMASequ’ûr
 *

208 
	gDMASequ’ûrP¬ams
::
	$ü—‹
()

210  
Ãw
 
	`DMASequ’ûr
(
this
);

211 
	}
}

	@ruby/system/DMASequencer.hh

29 #iâdeà
__MEM_RUBY_SYSTEM_DMASEQUENCER_HH__


30 
	#__MEM_RUBY_SYSTEM_DMASEQUENCER_HH__


	)

32 
	~<memÜy
>

33 
	~<o¡»am
>

34 
	~<unÜd”ed_m­
>

36 
	~"mem/´ÙocŞ/DMASequ’ûrReque¡Ty³.hh
"

37 
	~"mem/ruby/commÚ/Add»ss.hh
"

38 
	~"mem/ruby/commÚ/D©aBlock.hh
"

39 
	~"mem/ruby/sy¡em/RubyPÜt.hh
"

40 
	~"·¿ms/DMASequ’ûr.hh
"

42 
	sDMAReque¡


44 
DMAReque¡
(
ušt64_t
 
¡¬t_·ddr
, 
Ën
, 
boŞ
 
wr™e
, 
by‹s_com¶‘ed
,

45 
by‹s_issued
, 
ušt8_t
 *
d©a
, 
Pack‘PŒ
 
pkt
);

47 
ušt64_t
 
	m¡¬t_·ddr
;

48 
	mËn
;

49 
boŞ
 
	mwr™e
;

50 
	mby‹s_com¶‘ed
;

51 
	mby‹s_issued
;

52 
ušt8_t
 *
	md©a
;

53 
Pack‘PŒ
 
	mpkt
;

56 şas 
	cDMASequ’ûr
 : 
public
 
RubyPÜt


58 
public
:

59 
DMASequ’ûrP¬ams
 
	tP¬ams
;

60 
DMASequ’ûr
(cÚ¡ 
P¬ams
 *);

61 
	$š™
(è
ov”ride
;

64 
Reque¡Stus
 
	$makeReque¡
(
Pack‘PŒ
 
pkt
è
ov”ride
;

65 
boŞ
 
	$busy
(è{  
m_out¡ªdšg_couÁ
 > 0; }

66 
	$out¡ªdšgCouÁ
(ècÚ¡ 
ov”ride
 {  
m_out¡ªdšg_couÁ
; 
	}
}

67 
boŞ
 
	$isD—dlockEv’tScheduËd
(ècÚ¡ 
ov”ride
 {  
çl£
; 
	}
}

68 
	$descheduËD—dlockEv’t
(è
ov”ride
 {
	}
}

71 
d©aC®lback
(cÚ¡ 
D©aBlock
 &
dblk
, cÚ¡ 
Addr
 &
addr
);

72 
ackC®lback
(cÚ¡ 
Addr
 &
addr
);

74 
»cÜdReque¡Ty³
(
DMASequ’ûrReque¡Ty³
 
»que¡Ty³
);

76 
	g´iv©e
:

77 
issueNext
(cÚ¡ 
Addr
 &
addr
);

79 
ušt64_t
 
	gm_d©a_block_mask
;

81 
	g¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	tDMAReque¡
> 
	tReque¡TabË
;

82 
Reque¡TabË
 
	gm_Reque¡TabË
;

84 
	gm_out¡ªdšg_couÁ
;

85 
	gm_max_out¡ªdšg_»que¡s
;

	@ruby/system/GPUCoalescer.cc

36 
	~"ba£/misc.hh
"

37 
	~"ba£/¡r.hh
"

38 
	~"cÚfig/the_i§.hh
"

40 #ià
THE_ISA
 =ğ
X86_ISA


41 
	~"¬ch/x86/š¡s/miüŞd¡İ.hh
"

44 
	~"mem/ruby/sy¡em/GPUCßËsûr.hh
"

46 
	~"ıu/‹¡”s/ruby‹¡/RubyTe¡”.hh
"

47 
	~"debug/GPUCßËsûr.hh
"

48 
	~"debug/MemÜyAcûss.hh
"

49 
	~"debug/PrÙocŞT¿û.hh
"

50 
	~"debug/RubyPÜt.hh
"

51 
	~"debug/RubySts.hh
"

52 
	~"gpu-compu‹/shad”.hh
"

53 
	~"mem/·ck‘.hh
"

54 
	~"mem/ruby/commÚ/D©aBlock.hh
"

55 
	~"mem/ruby/commÚ/SubBlock.hh
"

56 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

57 
	~"mem/ruby/´of”/Prof”.hh
"

58 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCÚŒŞËr.hh
"

59 
	~"mem/ruby/¦icc_š‹rçû/RubyReque¡.hh
"

60 
	~"mem/ruby/¡ruùu»s/CacheMemÜy.hh
"

61 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

62 
	~"·¿ms/RubyGPUCßËsûr.hh
"

64 
usšg
 
Çme¥aû
 
	g¡d
;

66 
GPUCßËsûr
 *

67 
	gRubyGPUCßËsûrP¬ams
::
	$ü—‹
()

69  
Ãw
 
	`GPUCßËsûr
(
this
);

70 
	}
}

72 
HSAScİe


73 
	$»qScİeToHSAScİe
(
Reque¡
* 
»q
)

75 
HSAScİe
 
acûssScİe
 = 
HSAScİe_UNSPECIFIED
;

76 ià(
»q
->
	`isScİed
()) {

77 ià(
»q
->
	`isWaveäÚtScİe
()) {

78 
acûssScİe
 = 
HSAScİe_WAVEFRONT
;

79 } ià(
»q
->
	`isWÜkgroupScİe
()) {

80 
acûssScİe
 = 
HSAScİe_WORKGROUP
;

81 } ià(
»q
->
	`isDeviûScİe
()) {

82 
acûssScİe
 = 
HSAScİe_DEVICE
;

83 } ià(
»q
->
	`isSy¡emScİe
()) {

84 
acûssScİe
 = 
HSAScİe_SYSTEM
;

86 
	`çl
("Bad scopeype");

89  
acûssScİe
;

90 
	}
}

92 
HSASegm’t


93 
	$»qSegm’tToHSASegm’t
(
Reque¡
* 
»q
)

95 
HSASegm’t
 
acûssSegm’t
 = 
HSASegm’t_GLOBAL
;

97 ià(
»q
->
	`isGlob®Segm’t
()) {

98 
acûssSegm’t
 = 
HSASegm’t_GLOBAL
;

99 } ià(
»q
->
	`isGroupSegm’t
()) {

100 
acûssSegm’t
 = 
HSASegm’t_GROUP
;

101 } ià(
»q
->
	`isPriv©eSegm’t
()) {

102 
acûssSegm’t
 = 
HSASegm’t_PRIVATE
;

103 } ià(
»q
->
	`isK”ÇrgSegm’t
()) {

104 
acûssSegm’t
 = 
HSASegm’t_KERNARG
;

105 } ià(
»q
->
	`isR—dÚlySegm’t
()) {

106 
acûssSegm’t
 = 
HSASegm’t_READONLY
;

107 } ià(
»q
->
	`isSplSegm’t
()) {

108 
acûssSegm’t
 = 
HSASegm’t_SPILL
;

109 } ià(
»q
->
	`isArgSegm’t
()) {

110 
acûssSegm’t
 = 
HSASegm’t_ARG
;

112 
	`çl
("Bad segmentype");

115  
acûssSegm’t
;

116 
	}
}

118 
	gGPUCßËsûr
::
	$GPUCßËsûr
(cÚ¡ 
P¬ams
 *
p
)

119 : 
	`RubyPÜt
(
p
), 
	`issueEv’t
(
this
), 
	$d—dlockCheckEv’t
(
this
)

121 
m_¡Üe_wa™šg_Ú_lßd_cyşes
 = 0;

122 
m_¡Üe_wa™šg_Ú_¡Üe_cyşes
 = 0;

123 
m_lßd_wa™šg_Ú_¡Üe_cyşes
 = 0;

124 
m_lßd_wa™šg_Ú_lßd_cyşes
 = 0;

126 
m_out¡ªdšg_couÁ
 = 0;

128 
m_max_out¡ªdšg_»que¡s
 = 0;

129 
m_d—dlock_th»shŞd
 = 0;

130 
m_š¡Cache_±r
 = 
nuÎ±r
;

131 
m_d©aCache_±r
 = 
nuÎ±r
;

133 
m_š¡Cache_±r
 = 
p
->
iÿche
;

134 
m_d©aCache_±r
 = 
p
->
dÿche
;

135 
m_max_out¡ªdšg_»que¡s
 = 
p
->
max_out¡ªdšg_»que¡s
;

136 
m_d—dlock_th»shŞd
 = 
p
->
d—dlock_th»shŞd
;

138 
	`as£¹
(
m_max_out¡ªdšg_»que¡s
 > 0);

139 
	`as£¹
(
m_d—dlock_th»shŞd
 > 0);

140 
	`as£¹
(
m_š¡Cache_±r
);

141 
	`as£¹
(
m_d©aCache_±r
);

143 
m_d©a_ÿche_h™_Ï‹ncy
 = 
p
->
dÿche_h™_Ï‹ncy
;

145 
m_ruÂšgG¬ÃtSnd®Úe
 = 
p
->
g¬Ãt_¡ªd®Úe
;

146 
assumšgRfOCoh”’û
 = 
p
->
assume_rfo
;

147 
	}
}

149 
	gGPUCßËsûr
::~
	$GPUCßËsûr
()

151 
	}
}

154 
GPUCßËsûr
::
	$wakeup
()

157 
Cyşes
 
cu¼’t_time
 = 
	`curCyşe
();

160 
tÙ®_out¡ªdšg
 = 0;

162 
Reque¡TabË
::
™”©Ü
 
»ad
 = 
m_»adReque¡TabË
.
	`begš
();

163 
Reque¡TabË
::
™”©Ü
 
»ad_’d
 = 
m_»adReque¡TabË
.
	`’d
();

164 ; 
»ad
 !ğ
»ad_’d
; ++read) {

165 
GPUCßËsûrReque¡
* 
»que¡
 = 
»ad
->
£cÚd
;

166 ià(
cu¼’t_time
 - 
»que¡
->
issue_time
 < 
m_d—dlock_th»shŞd
)

169 
	`·nic
("Possible Deadlock detected. Aborting!\n"

171 "cu¼’ˆtime: %u issue_time: %d difã»nû: %d\n", 
m_v”siÚ
,

172 
»que¡
->
pkt
->
	`g‘Addr
(), 
m_»adReque¡TabË
.
	`size
(),

173 
cu¼’t_time
 * 
	`şockP”iod
(), 
»que¡
->
issue_time
 * clockPeriod(),

174 (
cu¼’t_time
 - 
»que¡
->
issue_time
)*
	`şockP”iod
());

177 
Reque¡TabË
::
™”©Ü
 
wr™e
 = 
m_wr™eReque¡TabË
.
	`begš
();

178 
Reque¡TabË
::
™”©Ü
 
wr™e_’d
 = 
m_wr™eReque¡TabË
.
	`’d
();

179 ; 
wr™e
 !ğ
wr™e_’d
; ++write) {

180 
GPUCßËsûrReque¡
* 
»que¡
 = 
wr™e
->
£cÚd
;

181 ià(
cu¼’t_time
 - 
»que¡
->
issue_time
 < 
m_d—dlock_th»shŞd
)

184 
	`·nic
("Possible Deadlock detected. Aborting!\n"

186 "cu¼’ˆtime: %u issue_time: %d difã»nû: %d\n", 
m_v”siÚ
,

187 
»que¡
->
pkt
->
	`g‘Addr
(), 
m_wr™eReque¡TabË
.
	`size
(),

188 
cu¼’t_time
 * 
	`şockP”iod
(), 
»que¡
->
issue_time
 * clockPeriod(),

189 (
cu¼’t_time
 - 
»que¡
->
issue_time
è* 
	`şockP”iod
());

192 
tÙ®_out¡ªdšg
 +ğ
m_wr™eReque¡TabË
.
	`size
();

193 
tÙ®_out¡ªdšg
 +ğ
m_»adReque¡TabË
.
	`size
();

195 
	`as£¹
(
m_out¡ªdšg_couÁ
 =ğ
tÙ®_out¡ªdšg
);

197 ià(
m_out¡ªdšg_couÁ
 > 0) {

199 
	`scheduË
(
d—dlockCheckEv’t
,

200 
m_d—dlock_th»shŞd
 * 
	`şockP”iod
() +

201 
	`curTick
());

203 
	}
}

206 
	gGPUCßËsûr
::
	$»£tSts
()

208 
m_Ï‹ncyHi¡
.
	`»£t
();

209 
m_missL©’cyHi¡
.
	`»£t
();

210 
i
 = 0; i < 
RubyReque¡Ty³_NUM
; i++) {

211 
m_ty³L©’cyHi¡
[
i
]->
	`»£t
();

212 
m_missTy³L©’cyHi¡
[
i
]->
	`»£t
();

213 
j
 = 0; j < 
MachšeTy³_NUM
; j++) {

214 
m_missTy³MachL©’cyHi¡
[
i
][
j
]->
	`»£t
();

218 
i
 = 0; i < 
MachšeTy³_NUM
; i++) {

219 
m_missMachL©’cyHi¡
[
i
]->
	`»£t
();

221 
m_IssueToIn™ŸlD–ayHi¡
[
i
]->
	`»£t
();

222 
m_In™ŸlToFÜw¬dD–ayHi¡
[
i
]->
	`»£t
();

223 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
[
i
]->
	`»£t
();

224 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
[
i
]->
	`»£t
();

226 
	}
}

229 
	gGPUCßËsûr
::
	$´štProg»ss
(
o¡»am
& 
out
) const

231 
	}
}

233 
Reque¡Stus


234 
GPUCßËsûr
::
	$g‘Reque¡Stus
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
»que¡_ty³
)

236 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

238 ià(!
m_mªd©Üy_q_±r
->
	`¬eNSlÙsAvaabË
(1, 
	`şockEdge
())) {

239  
Reque¡Stus_BufãrFuÎ
;

242 ià(
m_cÚŒŞËr
->
	`isBlocked
(
lše_addr
) &&

243 
»que¡_ty³
 !ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
) {

244  
Reque¡Stus_AlŸ£d
;

247 ià((
»que¡_ty³
 =ğ
RubyReque¡Ty³_ST
) ||

248 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_ATOMIC
) ||

249 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_ATOMIC_RETURN
) ||

250 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_ATOMIC_NO_RETURN
) ||

251 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_RMW_R—d
) ||

252 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_RMW_Wr™e
) ||

253 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
) ||

254 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_StÜe_CÚd™iÚ®
) ||

255 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) ||

256 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
) ||

257 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_FLUSH
)) {

261 ià(
m_»adReque¡TabË
.
	`couÁ
(
lše_addr
) > 0) {

262 
m_¡Üe_wa™šg_Ú_lßd_cyşes
++;

263  
Reque¡Stus_AlŸ£d
;

266 ià(
m_wr™eReque¡TabË
.
	`couÁ
(
lše_addr
) > 0) {

268 
m_¡Üe_wa™šg_Ú_¡Üe_cyşes
++;

269  
Reque¡Stus_AlŸ£d
;

274 ià(
m_wr™eReque¡TabË
.
	`couÁ
(
lše_addr
) > 0) {

275 
m_lßd_wa™šg_Ú_¡Üe_cyşes
++;

276  
Reque¡Stus_AlŸ£d
;

279 ià(
m_»adReque¡TabË
.
	`couÁ
(
lše_addr
) > 0) {

281 
m_lßd_wa™šg_Ú_lßd_cyşes
++;

282  
Reque¡Stus_AlŸ£d
;

286  
Reque¡Stus_R—dy
;

288 
	}
}

294 
	gGPUCßËsûr
::
	$š£¹K”Ãl
(
waveäÚt_id
, 
Pack‘PŒ
 
pkt
)

299 
	`DPRINTF
(
GPUCßËsûr
, "š£¹šg wf: %dØk”ÃlEndli¡\n", 
waveäÚt_id
);

300 
	`as£¹
(
k”ÃlEndLi¡
.
	`couÁ
(
waveäÚt_id
) == 0);

302 
k”ÃlEndLi¡
[
waveäÚt_id
] = 
pkt
;

303 
	`DPRINTF
(
GPUCßËsûr
, "kernelEndList->size() = %d\n",

304 
k”ÃlEndLi¡
.
	`size
());

305 
	}
}

310 
boŞ


311 
	gGPUCßËsûr
::
	$š£¹Reque¡
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
»que¡_ty³
)

313 
	`as£¹
(
	`g‘Reque¡Stus
(
pkt
, 
»que¡_ty³
è=ğ
Reque¡Stus_R—dy
 ||

314 
pkt
->
»q
->
	`isLockedRMW
() ||

315 !
m_mªd©Üy_q_±r
->
	`¬eNSlÙsAvaabË
(1, 
	`şockEdge
()));

317 
tÙ®_out¡ªdšg
 
M5_VAR_USED
 =

318 
m_wr™eReque¡TabË
.
	`size
(è+ 
m_»adReque¡TabË
.size();

320 
	`as£¹
(
m_out¡ªdšg_couÁ
 =ğ
tÙ®_out¡ªdšg
);

323 ià(!
d—dlockCheckEv’t
.
	`scheduËd
()) {

324 
	`scheduË
(
d—dlockCheckEv’t
, 
m_d—dlock_th»shŞd
 + 
	`curTick
());

327 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

328 ià((
»que¡_ty³
 =ğ
RubyReque¡Ty³_ST
) ||

329 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_ATOMIC
) ||

330 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_ATOMIC_RETURN
) ||

331 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_ATOMIC_NO_RETURN
) ||

332 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_RMW_R—d
) ||

333 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_RMW_Wr™e
) ||

334 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
) ||

335 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_StÜe_CÚd™iÚ®
) ||

336 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) ||

337 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
) ||

338 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_FLUSH
)) {

340 
·œ
<
Reque¡TabË
::
™”©Ü
, 
boŞ
> 
r
 =

341 
m_wr™eReque¡TabË
.
	`š£¹
(
Reque¡TabË
::
	`v®ue_ty³
(
lše_addr
,

342 (
GPUCßËsûrReque¡
*è
NULL
));

343 ià(
r
.
£cÚd
) {

344 
Reque¡TabË
::
™”©Ü
 
i
 = 
r
.
fœ¡
;

345 
i
->
£cÚd
 = 
Ãw
 
	`GPUCßËsûrReque¡
(
pkt
, 
»que¡_ty³
,

346 
	`curCyşe
());

347 
	`DPRINTF
(
GPUCßËsûr
,

349 
pkt
->
»q
->
	`g‘Paddr
(), 
i
->
£cÚd
->
m_ty³
);

350 
m_out¡ªdšg_couÁ
++;

352  
Œue
;

355 
·œ
<
Reque¡TabË
::
™”©Ü
, 
boŞ
> 
r
 =

356 
m_»adReque¡TabË
.
	`š£¹
(
Reque¡TabË
::
	`v®ue_ty³
(
lše_addr
,

357 (
GPUCßËsûrReque¡
*è
NULL
));

359 ià(
r
.
£cÚd
) {

360 
Reque¡TabË
::
™”©Ü
 
i
 = 
r
.
fœ¡
;

361 
i
->
£cÚd
 = 
Ãw
 
	`GPUCßËsûrReque¡
(
pkt
, 
»que¡_ty³
,

362 
	`curCyşe
());

363 
	`DPRINTF
(
GPUCßËsûr
,

365 
pkt
->
»q
->
	`g‘Paddr
(), 
i
->
£cÚd
->
m_ty³
);

366 
m_out¡ªdšg_couÁ
++;

368  
Œue
;

372 
m_out¡ªdReqHi¡
.
	`§m¶e
(
m_out¡ªdšg_couÁ
);

374 
tÙ®_out¡ªdšg
 = 
m_wr™eReque¡TabË
.
	`size
(è+ 
m_»adReque¡TabË
.size();

375 
	`as£¹
(
m_out¡ªdšg_couÁ
 =ğ
tÙ®_out¡ªdšg
);

377  
çl£
;

378 
	}
}

381 
	gGPUCßËsûr
::
	$m¬kRemoved
()

383 
m_out¡ªdšg_couÁ
--;

384 
	`as£¹
(
m_out¡ªdšg_couÁ
 ==

385 
m_wr™eReque¡TabË
.
	`size
(è+ 
m_»adReque¡TabË
.size());

386 
	}
}

389 
	gGPUCßËsûr
::
	$»moveReque¡
(
GPUCßËsûrReque¡
* 
¤eque¡
)

391 
	`as£¹
(
m_out¡ªdšg_couÁ
 ==

392 
m_wr™eReque¡TabË
.
	`size
(è+ 
m_»adReque¡TabË
.size());

394 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
¤eque¡
->
pkt
->
	`g‘Addr
());

395 ià((
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ST
) ||

396 (
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_RMW_R—d
) ||

397 (
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_RMW_Wr™e
) ||

398 (
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
) ||

399 (
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_StÜe_CÚd™iÚ®
) ||

400 (
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) ||

401 (
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
)) {

402 
m_wr™eReque¡TabË
.
	`”a£
(
lše_addr
);

404 
m_»adReque¡TabË
.
	`”a£
(
lše_addr
);

407 
	`m¬kRemoved
();

408 
	}
}

410 
boŞ


411 
	gGPUCßËsûr
::
	$hªdËLlsc
(
Addr
 
add»ss
, 
GPUCßËsûrReque¡
* 
»que¡
)

418 
boŞ
 
sucûss
 = 
Œue
;

419 ià(
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_StÜe_CÚd™iÚ®
) {

420 ià(!
m_d©aCache_±r
->
	`isLocked
(
add»ss
, 
m_v”siÚ
)) {

425 
»que¡
->
pkt
->
»q
->
	`£tExŒaD©a
(0);

426 
sucûss
 = 
çl£
;

432 
»que¡
->
pkt
->
»q
->
	`£tExŒaD©a
(1);

437 
m_d©aCache_±r
->
	`ş—rLocked
(
add»ss
);

438 } ià(
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
) {

443 
m_d©aCache_±r
->
	`£tLocked
(
add»ss
, 
m_v”siÚ
);

444 } ià((
m_d©aCache_±r
->
	`isTagP»£Á
(
add»ss
)) &&

445 (
m_d©aCache_±r
->
	`isLocked
(
add»ss
, 
m_v”siÚ
))) {

449 
m_d©aCache_±r
->
	`ş—rLocked
(
add»ss
);

451  
sucûss
;

452 
	}
}

455 
	gGPUCßËsûr
::
	$wr™eC®lback
(
Addr
 
add»ss
, 
D©aBlock
& 
d©a
)

457 
	`wr™eC®lback
(
add»ss
, 
MachšeTy³_NULL
, 
d©a
);

458 
	}
}

461 
	gGPUCßËsûr
::
	$wr™eC®lback
(
Addr
 
add»ss
,

462 
MachšeTy³
 
mach
,

463 
D©aBlock
& 
d©a
)

465 
	`wr™eC®lback
(
add»ss
, 
mach
, 
d©a
, 
	`Cyşes
(0), Cycles(0), Cycles(0));

466 
	}
}

469 
	gGPUCßËsûr
::
	$wr™eC®lback
(
Addr
 
add»ss
,

470 
MachšeTy³
 
mach
,

471 
D©aBlock
& 
d©a
,

472 
Cyşes
 
š™ŸlReque¡Time
,

473 
Cyşes
 
fÜw¬dReque¡Time
,

474 
Cyşes
 
fœ¡Re¥Ú£Time
)

476 
	`wr™eC®lback
(
add»ss
, 
mach
, 
d©a
,

477 
š™ŸlReque¡Time
, 
fÜw¬dReque¡Time
, 
fœ¡Re¥Ú£Time
,

478 
çl£
);

479 
	}
}

482 
	gGPUCßËsûr
::
	$wr™eC®lback
(
Addr
 
add»ss
,

483 
MachšeTy³
 
mach
,

484 
D©aBlock
& 
d©a
,

485 
Cyşes
 
š™ŸlReque¡Time
,

486 
Cyşes
 
fÜw¬dReque¡Time
,

487 
Cyşes
 
fœ¡Re¥Ú£Time
,

488 
boŞ
 
isRegiÚ
)

490 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

492 
	`DPRINTF
(
GPUCßËsûr
, "wr™ÿÎback fÜ‡dd»s %#x\n", 
add»ss
);

493 
	`as£¹
(
m_wr™eReque¡TabË
.
	`couÁ
(
	`makeLšeAdd»ss
(
add»ss
)));

495 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_wr™eReque¡TabË
.
	`fšd
(
add»ss
);

496 
	`as£¹
(
i
 !ğ
m_wr™eReque¡TabË
.
	`’d
());

497 
GPUCßËsûrReque¡
* 
»que¡
 = 
i
->
£cÚd
;

499 
m_wr™eReque¡TabË
.
	`”a£
(
i
);

500 
	`m¬kRemoved
();

502 
	`as£¹
((
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ST
) ||

503 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ATOMIC
) ||

504 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ATOMIC_RETURN
) ||

505 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ATOMIC_NO_RETURN
) ||

506 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_RMW_R—d
) ||

507 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_RMW_Wr™e
) ||

508 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
) ||

509 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_StÜe_CÚd™iÚ®
) ||

510 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) ||

511 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
) ||

512 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_FLUSH
));

521 
boŞ
 
sucûss
 = 
Œue
;

522 ià(!
m_ruÂšgG¬ÃtSnd®Úe
)

523 
sucûss
 = 
	`hªdËLlsc
(
add»ss
, 
»que¡
);

525 ià(
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) {

526 
m_cÚŒŞËr
->
	`blockOnQueue
(
add»ss
, 
m_mªd©Üy_q_±r
);

527 } ià(
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
) {

528 
m_cÚŒŞËr
->
	`unblock
(
add»ss
);

531 
	`h™C®lback
(
»que¡
, 
mach
, 
d©a
, 
sucûss
,

532 
»que¡
->
issue_time
, 
fÜw¬dReque¡Time
, 
fœ¡Re¥Ú£Time
,

533 
isRegiÚ
);

534 
	}
}

537 
	gGPUCßËsûr
::
	$»adC®lback
(
Addr
 
add»ss
, 
D©aBlock
& 
d©a
)

539 
	`»adC®lback
(
add»ss
, 
MachšeTy³_NULL
, 
d©a
);

540 
	}
}

543 
	gGPUCßËsûr
::
	$»adC®lback
(
Addr
 
add»ss
,

544 
MachšeTy³
 
mach
,

545 
D©aBlock
& 
d©a
)

547 
	`»adC®lback
(
add»ss
, 
mach
, 
d©a
, 
	`Cyşes
(0), Cycles(0), Cycles(0));

548 
	}
}

551 
	gGPUCßËsûr
::
	$»adC®lback
(
Addr
 
add»ss
,

552 
MachšeTy³
 
mach
,

553 
D©aBlock
& 
d©a
,

554 
Cyşes
 
š™ŸlReque¡Time
,

555 
Cyşes
 
fÜw¬dReque¡Time
,

556 
Cyşes
 
fœ¡Re¥Ú£Time
)

559 
	`»adC®lback
(
add»ss
, 
mach
, 
d©a
,

560 
š™ŸlReque¡Time
, 
fÜw¬dReque¡Time
, 
fœ¡Re¥Ú£Time
,

561 
çl£
);

562 
	}
}

565 
	gGPUCßËsûr
::
	$»adC®lback
(
Addr
 
add»ss
,

566 
MachšeTy³
 
mach
,

567 
D©aBlock
& 
d©a
,

568 
Cyşes
 
š™ŸlReque¡Time
,

569 
Cyşes
 
fÜw¬dReque¡Time
,

570 
Cyşes
 
fœ¡Re¥Ú£Time
,

571 
boŞ
 
isRegiÚ
)

573 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

574 
	`as£¹
(
m_»adReque¡TabË
.
	`couÁ
(
	`makeLšeAdd»ss
(
add»ss
)));

576 
	`DPRINTF
(
GPUCßËsûr
, "»ad c®lback fÜ‡dd»s %#x\n", 
add»ss
);

577 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_»adReque¡TabË
.
	`fšd
(
add»ss
);

578 
	`as£¹
(
i
 !ğ
m_»adReque¡TabË
.
	`’d
());

579 
GPUCßËsûrReque¡
* 
»que¡
 = 
i
->
£cÚd
;

581 
m_»adReque¡TabË
.
	`”a£
(
i
);

582 
	`m¬kRemoved
();

584 
	`as£¹
((
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_LD
) ||

585 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_IFETCH
));

587 
	`h™C®lback
(
»que¡
, 
mach
, 
d©a
, 
Œue
,

588 
»que¡
->
issue_time
, 
fÜw¬dReque¡Time
, 
fœ¡Re¥Ú£Time
,

589 
isRegiÚ
);

590 
	}
}

593 
	gGPUCßËsûr
::
	$h™C®lback
(
GPUCßËsûrReque¡
* 
¤eque¡
,

594 
MachšeTy³
 
mach
,

595 
D©aBlock
& 
d©a
,

596 
boŞ
 
sucûss
,

597 
Cyşes
 
š™ŸlReque¡Time
,

598 
Cyşes
 
fÜw¬dReque¡Time
,

599 
Cyşes
 
fœ¡Re¥Ú£Time
,

600 
boŞ
 
isRegiÚ
)

602 
Pack‘PŒ
 
pkt
 = 
¤eque¡
->pkt;

603 
Addr
 
»que¡_add»ss
 = 
pkt
->
	`g‘Addr
();

604 
Addr
 
»que¡_lše_add»ss
 = 
	`makeLšeAdd»ss
(
»que¡_add»ss
);

606 
RubyReque¡Ty³
 
ty³
 = 
¤eque¡
->
m_ty³
;

609 ià(
ty³
 =ğ
RubyReque¡Ty³_IFETCH
) {

610 ià(
m_š¡Cache_±r
->
	`isTagP»£Á
(
»que¡_lše_add»ss
))

611 
m_š¡Cache_±r
->
	`£tMRU
(
»que¡_lše_add»ss
);

613 ià(
m_d©aCache_±r
->
	`isTagP»£Á
(
»que¡_lše_add»ss
))

614 
m_d©aCache_±r
->
	`£tMRU
(
»que¡_lše_add»ss
);

617 
	`»cÜdMissL©’cy
(
¤eque¡
, 
mach
,

618 
š™ŸlReque¡Time
,

619 
fÜw¬dReque¡Time
,

620 
fœ¡Re¥Ú£Time
,

621 
sucûss
, 
isRegiÚ
);

625 
Ën
 = 
»qCßËsûr
[
»que¡_lše_add»ss
].
	`size
();

626 
¡d
::
veùÜ
<
Pack‘PŒ
> 
myli¡
;

627 
i
 = 0; i < 
Ën
; ++i) {

628 
Pack‘PŒ
 
pkt
 = 
»qCßËsûr
[
»que¡_lše_add»ss
][
i
].pkt;

629 
	`as£¹
(
ty³
 =ğ
»qCßËsûr
[
»que¡_lše_add»ss
][
i
].
´im¬yTy³
);

630 
»que¡_add»ss
 = 
pkt
->
	`g‘Addr
();

631 
»que¡_lše_add»ss
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

632 ià(
pkt
->
g‘PŒ
<
ušt8_t
>()) {

633 ià((
ty³
 =ğ
RubyReque¡Ty³_LD
) ||

634 (
ty³
 =ğ
RubyReque¡Ty³_ATOMIC
) ||

635 (
ty³
 =ğ
RubyReque¡Ty³_ATOMIC_RETURN
) ||

636 (
ty³
 =ğ
RubyReque¡Ty³_IFETCH
) ||

637 (
ty³
 =ğ
RubyReque¡Ty³_RMW_R—d
) ||

638 (
ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) ||

639 (
ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
)) {

640 
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(),

641 
d©a
.
	`g‘D©a
(
	`g‘Off£t
(
»que¡_add»ss
),

642 
pkt
->
	`g‘Size
()),

643 
pkt
->
	`g‘Size
());

645 
d©a
.
	`£tD©a
(
pkt
->
g‘PŒ
<
ušt8_t
>(),

646 
	`g‘Off£t
(
»que¡_add»ss
), 
pkt
->
	`g‘Size
());

649 
	`DPRINTF
(
MemÜyAcûss
,

652 
	`RubyReque¡Ty³_to_¡ršg
(
ty³
));

660 ià(
m_usšgRubyTe¡”
) {

661 
RubyPÜt
::
S’d”S‹
 *
»que¡S’d”S‹
 =

662 
§ã_ÿ¡
<
RubyPÜt
::
S’d”S‹
*>(
pkt
->
£nd”S‹
);

663 
RubyTe¡”
::
S’d”S‹
* 
‹¡”S’d”S‹
 =

664 
§ã_ÿ¡
<
RubyTe¡”
::
S’d”S‹
*>(
»que¡S’d”S‹
->
´edeûssÜ
);

665 
‹¡”S’d”S‹
->
subBlock
.
	`m”geFrom
(
d©a
);

668 
myli¡
.
	`push_back
(
pkt
);

670 
d–‘e
 
¤eque¡
;

671 
»qCßËsûr
.
	`”a£
(
»que¡_lše_add»ss
);

672 
	`as£¹
(!
»qCßËsûr
.
	`couÁ
(
»que¡_lše_add»ss
));

676 
	`com¶‘eH™C®lback
(
myli¡
, 
Ën
);

677 
	}
}

679 
boŞ


680 
	gGPUCßËsûr
::
	$em±y
() const

682  
m_wr™eReque¡TabË
.
	`em±y
(è&& 
m_»adReque¡TabË
.empty();

683 
	}
}

694 
Reque¡Stus


695 
	gGPUCßËsûr
::
	$makeReque¡
(
Pack‘PŒ
 
pkt
)

701 ià(
pkt
->
»q
->
	`isK”Ãl
()) {

702 ià(
pkt
->
»q
->
	`isAcquœe
()){

705  
Reque¡Stus_Issued
;

706 }ià(
pkt
->
»q
->
	`isR–—£
()) {

712 
wf_id
 = 0;

713 ià(
pkt
->
»q
->
	`hasCÚ‹xtId
()) {

714 
wf_id
 = 
pkt
->
»q
->
	`cÚ‹xtId
();

716 
	`š£¹K”Ãl
(
wf_id
, 
pkt
);

717 
ÃwK”ÃlEnds
.
	`push_back
(
wf_id
);

718 ià(!
issueEv’t
.
	`scheduËd
()) {

719 
	`scheduË
(
issueEv’t
, 
	`curTick
());

721  
Reque¡Stus_Issued
;

728 ià(
m_out¡ªdšg_couÁ
 >ğ
m_max_out¡ªdšg_»que¡s
) {

729  
Reque¡Stus_BufãrFuÎ
;

732 
RubyReque¡Ty³
 
´im¬y_ty³
 = 
RubyReque¡Ty³_NULL
;

733 
RubyReque¡Ty³
 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_NULL
;

735 ià(
pkt
->
	`isLLSC
()) {

744 ià(
pkt
->
	`isWr™e
()) {

745 
´im¬y_ty³
 = 
RubyReque¡Ty³_StÜe_CÚd™iÚ®
;

747 
	`as£¹
(
pkt
->
	`isR—d
());

748 
´im¬y_ty³
 = 
RubyReque¡Ty³_Lßd_Lšked
;

750 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ATOMIC
;

751 } ià(
pkt
->
»q
->
	`isLockedRMW
()) {

758 ià(
pkt
->
	`isWr™e
()) {

759 
´im¬y_ty³
 = 
RubyReque¡Ty³_Locked_RMW_Wr™e
;

761 
	`as£¹
(
pkt
->
	`isR—d
());

762 
´im¬y_ty³
 = 
RubyReque¡Ty³_Locked_RMW_R—d
;

764 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ST
;

765 } ià(
pkt
->
	`isAtomicOp
()) {

769 
´im¬y_ty³
 = 
RubyReque¡Ty³_ATOMIC
;

770 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ATOMIC
;

772 ià(
pkt
->
	`isR—d
()) {

773 ià(
pkt
->
»q
->
	`isIn¡F‘ch
()) {

774 
´im¬y_ty³
 = 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_IFETCH
;

776 #ià
THE_ISA
 =ğ
X86_ISA


777 
ušt32_t
 
æags
 = 
pkt
->
»q
->
	`g‘FÏgs
();

778 
boŞ
 
¡ÜeCheck
 = 
æags
 &

779 (
TheISA
::
StÜeCheck
 << TheISA::
FÏgShiá
);

781 
boŞ
 
¡ÜeCheck
 = 
çl£
;

783 ià(
¡ÜeCheck
) {

784 
´im¬y_ty³
 = 
RubyReque¡Ty³_RMW_R—d
;

785 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ST
;

787 
´im¬y_ty³
 = 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_LD
;

790 } ià(
pkt
->
	`isWr™e
()) {

794 
´im¬y_ty³
 = 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ST
;

795 } ià(
pkt
->
	`isFlush
()) {

796 
´im¬y_ty³
 = 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_FLUSH
;

797 } ià(
pkt
->
»q
->
	`isR–—£
(è||…kt->»q->
	`isAcquœe
()) {

798 ià(
assumšgRfOCoh”’û
) {

806 
wf_id
 = 0;

807 ià(
pkt
->
»q
->
	`hasCÚ‹xtId
()) {

808 
wf_id
 = 
pkt
->
»q
->
	`cÚ‹xtId
();

810 
	`š£¹K”Ãl
(
wf_id
, 
pkt
);

811 
ÃwK”ÃlEnds
.
	`push_back
(
wf_id
);

812 ià(!
issueEv’t
.
	`scheduËd
()) {

813 
	`scheduË
(
issueEv’t
, 
	`curTick
());

815  
Reque¡Stus_Issued
;

819  
Reque¡Stus_Issued
;

822 
	`·nic
("Unsupported„uby…acketype\n");

831 
Reque¡Stus
 
¡©us
 = 
	`g‘Reque¡Stus
(
pkt
, 
´im¬y_ty³
);

832 ià(
¡©us
 !ğ
Reque¡Stus_R—dy
)

833  
¡©us
;

835 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

839 ià(!
»qCßËsûr
.
	`couÁ
(
lše_addr
)) {

844 
ÃwReque¡s
.
	`push_back
(
lše_addr
);

849 } ià(
´im¬y_ty³
 !=

850 
»qCßËsûr
[
lše_addr
][0].
´im¬yTy³
) {

852  
Reque¡Stus_AlŸ£d
;

853 } ià(
pkt
->
»q
->
	`isLockedRMW
() ||

854 
»qCßËsûr
[
lše_addr
][0].
pkt
->
»q
->
	`isLockedRMW
()) {

856  
Reque¡Stus_AlŸ£d
;

857 } ià(
pkt
->
»q
->
	`hasCÚ‹xtId
(è&&…kt->»q->
	`isR–—£
() &&

858 
pkt
->
»q
->
	`cÚ‹xtId
() !=

859 
»qCßËsûr
[
lše_addr
][0].
pkt
->
»q
->
	`cÚ‹xtId
()) {

861  
Reque¡Stus_AlŸ£d
;

865 
»qCßËsûr
[
lše_addr
].
	`em¶aû_back
(
pkt
, 
´im¬y_ty³
, 
£cÚd¬y_ty³
);

866 ià(!
issueEv’t
.
	`scheduËd
())

867 
	`scheduË
(
issueEv’t
, 
	`curTick
());

869  
Reque¡Stus_Issued
;

870 
	}
}

873 
	gGPUCßËsûr
::
	$issueReque¡
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
£cÚd¬y_ty³
)

876 
´oc_id
 = -1;

877 ià(
pkt
 !ğ
NULL
 &&…kt->
»q
->
	`hasCÚ‹xtId
()) {

878 
´oc_id
 = 
pkt
->
»q
->
	`cÚ‹xtId
();

882 
Addr
 
pc
 = 0;

883 ià(
pkt
->
»q
->
	`hasPC
()) {

884 
pc
 = 
pkt
->
»q
->
	`g‘PC
();

894 
HSASegm’t
 
acûssSegm’t
 = 
	`»qSegm’tToHSASegm’t
(
pkt
->
»q
);

895 
HSAScİe
 
acûssScİe
 = 
	`»qScİeToHSAScİe
(
pkt
->
»q
);

897 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

902 
D©aBlock
 
d©aBlock
;

903 
d©aBlock
.
	`ş—r
();

904 
ušt32_t
 
blockSize
 = 
RubySy¡em
::
	`g‘BlockSizeBy‹s
();

905 
¡d
::
veùÜ
<
boŞ
> 
	`acûssMask
(
blockSize
,
çl£
);

906 
¡d
::
veùÜ
< std::
·œ
<,
AtomicOpFunùÜ
*> > 
©omicOps
;

907 
ušt32_t
 
bËSize
 = 
»qCßËsûr
[
lše_addr
].
	`size
();

908 
i
 = 0; i < 
bËSize
; i++) {

909 
Pack‘PŒ
 
tmpPkt
 = 
»qCßËsûr
[
lše_addr
][
i
].
pkt
;

910 
ušt32_t
 
tmpOff£t
 = (
tmpPkt
->
	`g‘Addr
()è- 
lše_addr
;

911 
ušt32_t
 
tmpSize
 = 
tmpPkt
->
	`g‘Size
();

912 ià(
tmpPkt
->
	`isAtomicOp
()) {

913 
¡d
::
·œ
<,
AtomicOpFunùÜ
 *> 
	`tmpAtomicOp
(
tmpOff£t
,

914 
tmpPkt
->
	`g‘AtomicOp
());

915 
©omicOps
.
	`push_back
(
tmpAtomicOp
);

916 } ià(
tmpPkt
->
	`isWr™e
()) {

917 
d©aBlock
.
	`£tD©a
(
tmpPkt
->
g‘PŒ
<
ušt8_t
>(),

918 
tmpOff£t
, 
tmpSize
);

920 
j
 = 0; j < 
tmpSize
; j++) {

921 
acûssMask
[
tmpOff£t
 + 
j
] = 
Œue
;

924 
¡d
::
sh¬ed_±r
<
RubyReque¡
> 
msg
;

925 ià(
pkt
->
	`isAtomicOp
()) {

926 
msg
 = 
¡d
::
make_sh¬ed
<
RubyReque¡
>(
	`şockEdge
(), 
pkt
->
	`g‘Addr
(),

927 
pkt
->
g‘PŒ
<
ušt8_t
>(),

928 
pkt
->
	`g‘Size
(), 
pc
, 
£cÚd¬y_ty³
,

929 
RubyAcûssMode_Su³rvisÜ
, 
pkt
,

930 
P»ãtchB™_No
, 
´oc_id
, 100,

931 
blockSize
, 
acûssMask
,

932 
d©aBlock
, 
©omicOps
,

933 
acûssScİe
, 
acûssSegm’t
);

935 
msg
 = 
¡d
::
make_sh¬ed
<
RubyReque¡
>(
	`şockEdge
(), 
pkt
->
	`g‘Addr
(),

936 
pkt
->
g‘PŒ
<
ušt8_t
>(),

937 
pkt
->
	`g‘Size
(), 
pc
, 
£cÚd¬y_ty³
,

938 
RubyAcûssMode_Su³rvisÜ
, 
pkt
,

939 
P»ãtchB™_No
, 
´oc_id
, 100,

940 
blockSize
, 
acûssMask
,

941 
d©aBlock
,

942 
acûssScİe
, 
acûssSegm’t
);

944 
	`DPRINTFR
(
PrÙocŞT¿û
, "%15s %3s %10s%20s %6s>%-6s %s %s\n",

945 
	`curTick
(), 
m_v”siÚ
, "Coal", "Begin", "", "",

946 
	`´štAdd»ss
(
msg
->
	`g‘PhysiÿlAdd»ss
()),

947 
	`RubyReque¡Ty³_to_¡ršg
(
£cÚd¬y_ty³
));

949 
	`çl_if
(
£cÚd¬y_ty³
 =ğ
RubyReque¡Ty³_IFETCH
,

953 
	`çl_if
(
m_d©a_ÿche_h™_Ï‹ncy
 == 0,

956 
	`as£¹
(
m_mªd©Üy_q_±r
);

957 
m_mªd©Üy_q_±r
->
	`’queue
(
msg
, 
	`şockEdge
(), 
m_d©a_ÿche_h™_Ï‹ncy
);

958 
	}
}

960 
	g‹m¶©e
 <
şass
 
	gKEY
, cÏs 
	gVALUE
>

961 
	g¡d
::
o¡»am
 &

962 
İ”©Ü
<<(
o¡»am
 &
out
, cÚ¡ 
	g¡d
::
unÜd”ed_m­
<
KEY
, 
	gVALUE
> &
	gm­
)

964 
	gout
 << "[";

965 autØ
	gi
 = 
m­
.
begš
(); i !ğm­.
’d
(); ++i)

966 
	gout
 << " " << 
	gi
->
	gfœ¡
 << "=" << i->
	g£cÚd
;

967 
	gout
 << " ]";

969  
	gout
;

973 
	gGPUCßËsûr
::
	$´št
(
o¡»am
& 
out
) const

975 
out
 << "[GPUCßËsûr: " << 
m_v”siÚ


976 << ", out¡ªdšg„eque¡s: " << 
m_out¡ªdšg_couÁ


977 << ",„—d„eque¡abË: " << 
m_»adReque¡TabË


978 << ", wr™»que¡abË: " << 
m_wr™eReque¡TabË


980 
	}
}

986 
	gGPUCßËsûr
::
	$checkCoh”’û
(
Addr
 
addr
)

988 #ifdeà
CHECK_COHERENCE


989 
m_ruby_sy¡em
->
	`checkGlob®Coh”’ûInv¬ŸÁ
(
addr
);

991 
	}
}

994 
	gGPUCßËsûr
::
	$»cÜdReque¡Ty³
(
Sequ’ûrReque¡Ty³
 
»que¡Ty³
) {

995 
	`DPRINTF
(
RubySts
, "Recorded statistic: %s\n",

996 
	`Sequ’ûrReque¡Ty³_to_¡ršg
(
»que¡Ty³
));

997 
	}
}

999 
	gGPUCßËsûr
::
IssueEv’t
::
	$IssueEv’t
(
GPUCßËsûr
* 
_£q
)

1000 : 
	`Ev’t
(
Prog»ss_Ev’t_Pri
), 
	$£q
(
_£q
)

1002 
	}
}

1006 
	gGPUCßËsûr
::
	$com¶‘eIssue
()

1011 
Ën
 = 
ÃwReque¡s
.
	`size
();

1012 
	`DPRINTF
(
GPUCßËsûr
, "Com¶‘šg issufÜ %d‚ew„eque¡s.\n", 
Ën
);

1013 
i
 = 0; i < 
Ën
; ++i) {

1018 
Reque¡Desc
 
šfo
 = 
»qCßËsûr
[
ÃwReque¡s
[
i
]][0];

1019 
Pack‘PŒ
 
pkt
 = 
šfo
.pkt;

1020 
	`DPRINTF
(
GPUCßËsûr
, "Completing for‚ewReq %d:…addr %#x\n",

1021 
i
, 
pkt
->
»q
->
	`g‘Paddr
());

1024 
boŞ
 
found
 = 
	`š£¹Reque¡
(
pkt
, 
šfo
.
´im¬yTy³
);

1026 ià(
found
) {

1027 
	`·nic
("GPUCoalescer::makeRequest should‚ever be called ifhe "

1032 
	`issueReque¡
(
pkt
, 
šfo
.
£cÚd¬yTy³
);

1034 
ÃwReque¡s
.
	`ş—r
();

1037 
Ën
 = 
ÃwK”ÃlEnds
.
	`size
();

1038 
i
 = 0; i < 
Ën
; i++) {

1039 
	`k”ÃlC®lback
(
ÃwK”ÃlEnds
[
i
]);

1041 
ÃwK”ÃlEnds
.
	`ş—r
();

1042 
	}
}

1045 
	gGPUCßËsûr
::
IssueEv’t
::
	$´oûss
()

1047 
£q
->
	`com¶‘eIssue
();

1048 
	}
}

1051 
	gGPUCßËsûr
::
IssueEv’t
::
	$desütiÚ
() const

1054 
	}
}

1057 
	gGPUCßËsûr
::
	$eviùiÚC®lback
(
Addr
 
add»ss
)

1059 
	`ruby_eviùiÚ_ÿÎback
(
add»ss
);

1060 
	}
}

1063 
	gGPUCßËsûr
::
	$k”ÃlC®lback
(
waveäÚt_id
)

1065 
	`as£¹
(
k”ÃlEndLi¡
.
	`couÁ
(
waveäÚt_id
));

1067 
	`ruby_h™_ÿÎback
(
k”ÃlEndLi¡
[
waveäÚt_id
]);

1069 
k”ÃlEndLi¡
.
	`”a£
(
waveäÚt_id
);

1070 
	}
}

1073 
	gGPUCßËsûr
::
	$©omicC®lback
(
Addr
 
add»ss
,

1074 
MachšeTy³
 
mach
,

1075 cÚ¡ 
D©aBlock
& 
d©a
)

1077 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

1079 
	`DPRINTF
(
GPUCßËsûr
, "©omiøÿÎback fÜ‡dd»s %#x\n", 
add»ss
);

1080 
	`as£¹
(
m_wr™eReque¡TabË
.
	`couÁ
(
	`makeLšeAdd»ss
(
add»ss
)));

1082 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_wr™eReque¡TabË
.
	`fšd
(
add»ss
);

1083 
	`as£¹
(
i
 !ğ
m_wr™eReque¡TabË
.
	`’d
());

1084 
GPUCßËsûrReque¡
* 
¤eque¡
 = 
i
->
£cÚd
;

1086 
m_wr™eReque¡TabË
.
	`”a£
(
i
);

1087 
	`m¬kRemoved
();

1089 
	`as£¹
((
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ATOMIC
) ||

1090 (
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ATOMIC_RETURN
) ||

1091 (
¤eque¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ATOMIC_NO_RETURN
));

1096 
	`»cÜdMissL©’cy
(
¤eque¡
, 
mach
,

1097 
¤eque¡
->
issue_time
, 
	`Cyşes
(0), Cyşes(0), 
Œue
, 
çl£
);

1099 
Pack‘PŒ
 
pkt
 = 
¤eque¡
->pkt;

1100 
Addr
 
»que¡_add»ss
 = 
pkt
->
	`g‘Addr
();

1101 
Addr
 
»que¡_lše_add»ss
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

1103 
Ën
 = 
»qCßËsûr
[
»que¡_lše_add»ss
].
	`size
();

1104 
¡d
::
veùÜ
<
Pack‘PŒ
> 
myli¡
;

1105 
i
 = 0; i < 
Ën
; ++i) {

1106 
Pack‘PŒ
 
pkt
 = 
»qCßËsûr
[
»que¡_lše_add»ss
][
i
].pkt;

1107 
	`as£¹
(
¤eque¡
->
m_ty³
 ==

1108 
»qCßËsûr
[
»que¡_lše_add»ss
][
i
].
´im¬yTy³
);

1109 
»que¡_add»ss
 = (
pkt
->
	`g‘Addr
());

1110 
»que¡_lše_add»ss
 = 
	`makeLšeAdd»ss
(
»que¡_add»ss
);

1111 ià(
pkt
->
g‘PŒ
<
ušt8_t
>() &&

1112 
¤eque¡
->
m_ty³
 !ğ
RubyReque¡Ty³_ATOMIC_NO_RETURN
) {

1114 
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(),

1115 
d©a
.
	`g‘D©a
(
	`g‘Off£t
(
»que¡_add»ss
),

1116 
pkt
->
	`g‘Size
()),

1117 
pkt
->
	`g‘Size
());

1119 
	`DPRINTF
(
MemÜyAcûss
,

1122 
	`RubyReque¡Ty³_to_¡ršg
(
¤eque¡
->
m_ty³
));

1130 ià(
m_usšgRubyTe¡”
) {

1131 
RubyPÜt
::
S’d”S‹
 *
»que¡S’d”S‹
 =

1132 
§ã_ÿ¡
<
RubyPÜt
::
S’d”S‹
*>(
pkt
->
£nd”S‹
);

1133 
RubyTe¡”
::
S’d”S‹
* 
‹¡”S’d”S‹
 =

1134 
§ã_ÿ¡
<
RubyTe¡”
::
S’d”S‹
*>(
»que¡S’d”S‹
->
´edeûssÜ
);

1135 
‹¡”S’d”S‹
->
subBlock
.
	`m”geFrom
(
d©a
);

1138 
myli¡
.
	`push_back
(
pkt
);

1140 
d–‘e
 
¤eque¡
;

1141 
»qCßËsûr
.
	`”a£
(
»que¡_lše_add»ss
);

1142 
	`as£¹
(!
»qCßËsûr
.
	`couÁ
(
»que¡_lše_add»ss
));

1144 
	`com¶‘eH™C®lback
(
myli¡
, 
Ën
);

1145 
	}
}

1148 
	gGPUCßËsûr
::
	$»cÜdCPR—dC®lBack
(
MachšeID
 
myMachID
, MachšeID 
£nd”MachID
)

1150 ià(
myMachID
 =ğ
£nd”MachID
) {

1151 
CP_TCPLdH™s
++;

1152 } ià(
	`machšeIDToMachšeTy³
(
£nd”MachID
è=ğ
MachšeTy³_TCP
) {

1153 
CP_TCPLdT¿nsãrs
++;

1154 } ià(
	`machšeIDToMachšeTy³
(
£nd”MachID
è=ğ
MachšeTy³_TCC
) {

1155 
CP_TCCLdH™s
++;

1157 
CP_LdMiss
++;

1159 
	}
}

1162 
	gGPUCßËsûr
::
	$»cÜdCPWr™eC®lBack
(
MachšeID
 
myMachID
, MachšeID 
£nd”MachID
)

1164 ià(
myMachID
 =ğ
£nd”MachID
) {

1165 
CP_TCPStH™s
++;

1166 } ià(
	`machšeIDToMachšeTy³
(
£nd”MachID
è=ğ
MachšeTy³_TCP
) {

1167 
CP_TCPStT¿nsãrs
++;

1168 } ià(
	`machšeIDToMachšeTy³
(
£nd”MachID
è=ğ
MachšeTy³_TCC
) {

1169 
CP_TCCStH™s
++;

1171 
CP_StMiss
++;

1173 
	}
}

1176 
	gGPUCßËsûr
::
com¶‘eH™C®lback
(
¡d
::
veùÜ
<
Pack‘PŒ
> & 
myli¡
, 
Ën
)

1178 
	gi
 = 0; i < 
	gËn
; ++i) {

1179 
	gRubyPÜt
::
S’d”S‹
 *
ss
 =

1180 
§ã_ÿ¡
<
RubyPÜt
::
S’d”S‹
 *>(
myli¡
[
i
]->
£nd”S‹
);

1181 
MemSÏvePÜt
 *
	gpÜt
 = 
ss
->
pÜt
;

1182 
as£¹
(
pÜt
 !ğ
NULL
);

1184 
	gmyli¡
[
i
]->
	g£nd”S‹
 = 
ss
->
´edeûssÜ
;

1185 
d–‘e
 
	gss
;

1186 
	gpÜt
->
h™C®lback
(
myli¡
[
i
]);

1187 
ŒyS’dR‘r›s
();

1190 
‹¡D¿šCom¶‘e
();

1193 
Pack‘PŒ


1194 
	gGPUCßËsûr
::
	$m­AddrToPkt
(
Addr
 
add»ss
)

1196 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_»adReque¡TabË
.
	`fšd
(
add»ss
);

1197 
	`as£¹
(
i
 !ğ
m_»adReque¡TabË
.
	`’d
());

1198 
GPUCßËsûrReque¡
* 
»que¡
 = 
i
->
£cÚd
;

1199  
»que¡
->
pkt
;

1200 
	}
}

1203 
	gGPUCßËsûr
::
	$»cÜdMissL©’cy
(
GPUCßËsûrReque¡
* 
¤eque¡
,

1204 
MachšeTy³
 
mach
,

1205 
Cyşes
 
š™ŸlReque¡Time
,

1206 
Cyşes
 
fÜw¬dReque¡Time
,

1207 
Cyşes
 
fœ¡Re¥Ú£Time
,

1208 
boŞ
 
sucûss
, boŞ 
isRegiÚ
)

1210 
RubyReque¡Ty³
 
ty³
 = 
¤eque¡
->
m_ty³
;

1211 
Cyşes
 
issued_time
 = 
¤eque¡
->
issue_time
;

1212 
Cyşes
 
com¶‘iÚ_time
 = 
	`curCyşe
();

1213 
	`as£¹
(
com¶‘iÚ_time
 >ğ
issued_time
);

1214 
Cyşes
 
tÙ®_Ït
 = 
com¶‘iÚ_time
 - 
issued_time
;

1217 ià(
mach
 =ğ
MachšeTy³_TCP
) {

1218 ià(
ty³
 =ğ
RubyReque¡Ty³_LD
) {

1219 
GPU_TCPLdH™s
++;

1221 
GPU_TCPStH™s
++;

1223 } ià(
mach
 =ğ
MachšeTy³_L1Cache_wCC
) {

1224 ià(
ty³
 =ğ
RubyReque¡Ty³_LD
) {

1225 
GPU_TCPLdT¿nsãrs
++;

1227 
GPU_TCPStT¿nsãrs
++;

1229 } ià(
mach
 =ğ
MachšeTy³_TCC
) {

1230 ià(
ty³
 =ğ
RubyReque¡Ty³_LD
) {

1231 
GPU_TCCLdH™s
++;

1233 
GPU_TCCStH™s
++;

1236 ià(
ty³
 =ğ
RubyReque¡Ty³_LD
) {

1237 
GPU_LdMiss
++;

1239 
GPU_StMiss
++;

1244 
m_Ï‹ncyHi¡
.
	`§m¶e
(
tÙ®_Ït
);

1245 
m_ty³L©’cyHi¡
[
ty³
]->
	`§m¶e
(
tÙ®_Ït
);

1248 ià(
tÙ®_Ït
 !ğ
	`Cyşes
(0)) {

1249 
m_missL©’cyHi¡
.
	`§m¶e
(
tÙ®_Ït
);

1250 
m_missTy³L©’cyHi¡
[
ty³
]->
	`§m¶e
(
tÙ®_Ït
);

1252 ià(
mach
 !ğ
MachšeTy³_NUM
) {

1253 
m_missMachL©’cyHi¡
[
mach
]->
	`§m¶e
(
tÙ®_Ït
);

1254 
m_missTy³MachL©’cyHi¡
[
ty³
][
mach
]->
	`§m¶e
(
tÙ®_Ït
);

1256 ià((
issued_time
 <ğ
š™ŸlReque¡Time
) &&

1257 (
š™ŸlReque¡Time
 <ğ
fÜw¬dReque¡Time
) &&

1258 (
fÜw¬dReque¡Time
 <ğ
fœ¡Re¥Ú£Time
) &&

1259 (
fœ¡Re¥Ú£Time
 <ğ
com¶‘iÚ_time
)) {

1261 
m_IssueToIn™ŸlD–ayHi¡
[
mach
]->
	`§m¶e
(

1262 
š™ŸlReque¡Time
 - 
issued_time
);

1263 
m_In™ŸlToFÜw¬dD–ayHi¡
[
mach
]->
	`§m¶e
(

1264 
fÜw¬dReque¡Time
 - 
š™ŸlReque¡Time
);

1265 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
[
mach
]->
	`§m¶e
(

1266 
fœ¡Re¥Ú£Time
 - 
fÜw¬dReque¡Time
);

1267 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
[
mach
]->
	`§m¶e
(

1268 
com¶‘iÚ_time
 - 
fœ¡Re¥Ú£Time
);

1274 
	`DPRINTFR
(
PrÙocŞT¿û
, "%15s %3s %10s%20s %6s>%-6s %s %d cycles\n",

1275 
	`curTick
(), 
m_v”siÚ
, "Coal",

1276 
sucûss
 ? "Done" : "SC_Failed", "", "",

1277 
	`´štAdd»ss
(
¤eque¡
->
pkt
->
	`g‘Addr
()), 
tÙ®_Ït
);

1278 
	}
}

1281 
	gGPUCßËsûr
::
	$»gSts
()

1283 
RubyPÜt
::
	`»gSts
();

1288 
m_out¡ªdReqHi¡
.
	`š™
(10);

1289 
m_Ï‹ncyHi¡
.
	`š™
(10);

1290 
m_missL©’cyHi¡
.
	`š™
(10);

1292 
i
 = 0; i < 
RubyReque¡Ty³_NUM
; i++) {

1293 
m_ty³L©’cyHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

1294 
m_ty³L©’cyHi¡
[
i
]->
	`š™
(10);

1296 
m_missTy³L©’cyHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

1297 
m_missTy³L©’cyHi¡
[
i
]->
	`š™
(10);

1300 
i
 = 0; i < 
MachšeTy³_NUM
; i++) {

1301 
m_missMachL©’cyHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

1302 
m_missMachL©’cyHi¡
[
i
]->
	`š™
(10);

1304 
m_IssueToIn™ŸlD–ayHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

1305 
m_IssueToIn™ŸlD–ayHi¡
[
i
]->
	`š™
(10);

1307 
m_In™ŸlToFÜw¬dD–ayHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

1308 
m_In™ŸlToFÜw¬dD–ayHi¡
[
i
]->
	`š™
(10);

1310 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

1311 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
[
i
]->
	`š™
(10);

1313 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

1314 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
[
i
]->
	`š™
(10);

1317 
i
 = 0; i < 
RubyReque¡Ty³_NUM
; i++) {

1318 
m_missTy³MachL©’cyHi¡
.
	`push_back
(
¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *>());

1320 
j
 = 0; j < 
MachšeTy³_NUM
; j++) {

1321 
m_missTy³MachL©’cyHi¡
[
i
].
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

1322 
m_missTy³MachL©’cyHi¡
[
i
][
j
]->
	`š™
(10);

1327 
GPU_TCPLdH™s


1328 .
	`Çme
(name() + ".gpu_tcp_ld_hits")

1329 .
	`desc
("loadshat hit inhe TCP")

1331 
GPU_TCPLdT¿nsãrs


1332 .
	`Çme
(name() + ".gpu_tcp_ld_transfers")

1333 .
	`desc
("TCPo TCP†oadransfers")

1335 
GPU_TCCLdH™s


1336 .
	`Çme
(name() + ".gpu_tcc_ld_hits")

1337 .
	`desc
("loadshat hit inhe TCC")

1339 
GPU_LdMiss


1340 .
	`Çme
(name() + ".gpu_ld_misses")

1341 .
	`desc
("loadshat miss inhe GPU")

1344 
GPU_TCPStH™s


1345 .
	`Çme
(name() + ".gpu_tcp_st_hits")

1346 .
	`desc
("storeshat hit inhe TCP")

1348 
GPU_TCPStT¿nsãrs


1349 .
	`Çme
(name() + ".gpu_tcp_st_transfers")

1350 .
	`desc
("TCPo TCP storeransfers")

1352 
GPU_TCCStH™s


1353 .
	`Çme
(name() + ".gpu_tcc_st_hits")

1354 .
	`desc
("storeshat hit inhe TCC")

1356 
GPU_StMiss


1357 .
	`Çme
(name() + ".gpu_st_misses")

1358 .
	`desc
("storeshat miss inhe GPU")

1362 
CP_TCPLdH™s


1363 .
	`Çme
(name() + ".cp_tcp_ld_hits")

1364 .
	`desc
("loadshat hit inhe TCP")

1366 
CP_TCPLdT¿nsãrs


1367 .
	`Çme
(name() + ".cp_tcp_ld_transfers")

1368 .
	`desc
("TCPo TCP†oadransfers")

1370 
CP_TCCLdH™s


1371 .
	`Çme
(name() + ".cp_tcc_ld_hits")

1372 .
	`desc
("loadshat hit inhe TCC")

1374 
CP_LdMiss


1375 .
	`Çme
(name() + ".cp_ld_misses")

1376 .
	`desc
("loadshat miss inhe GPU")

1379 
CP_TCPStH™s


1380 .
	`Çme
(name() + ".cp_tcp_st_hits")

1381 .
	`desc
("storeshat hit inhe TCP")

1383 
CP_TCPStT¿nsãrs


1384 .
	`Çme
(name() + ".cp_tcp_st_transfers")

1385 .
	`desc
("TCPo TCP storeransfers")

1387 
CP_TCCStH™s


1388 .
	`Çme
(name() + ".cp_tcc_st_hits")

1389 .
	`desc
("storeshat hit inhe TCC")

1391 
CP_StMiss


1392 .
	`Çme
(name() + ".cp_st_misses")

1393 .
	`desc
("storeshat miss inhe GPU")

1395 
	}
}

	@ruby/system/GPUCoalescer.hh

36 #iâdeà
__MEM_RUBY_SYSTEM_GPU_COALESCER_HH__


37 
	#__MEM_RUBY_SYSTEM_GPU_COALESCER_HH__


	)

39 
	~<io¡»am
>

40 
	~<unÜd”ed_m­
>

42 
	~"ba£/¡©i¡ics.hh
"

43 
	~"mem/´ÙocŞ/HSAScİe.hh
"

44 
	~"mem/´ÙocŞ/HSASegm’t.hh
"

45 
	~"mem/´ÙocŞ/P»ãtchB™.hh
"

46 
	~"mem/´ÙocŞ/RubyAcûssMode.hh
"

47 
	~"mem/´ÙocŞ/RubyReque¡Ty³.hh
"

48 
	~"mem/´ÙocŞ/Sequ’ûrReque¡Ty³.hh
"

49 
	~"mem/»que¡.hh
"

50 
	~"mem/ruby/commÚ/Add»ss.hh
"

51 
	~"mem/ruby/commÚ/CÚsum”.hh
"

52 
	~"mem/ruby/sy¡em/RubyPÜt.hh
"

54 
şass
 
	gD©aBlock
;

55 
şass
 
	gCacheMsg
;

56 
şass
 
	gMachšeID
;

57 
şass
 
	gCacheMemÜy
;

59 
şass
 
	gRubyGPUCßËsûrP¬ams
;

61 
HSAScİe
 
»qScİeToHSAScİe
(
Reque¡
* 
»q
);

62 
HSASegm’t
 
»qSegm’tToHSASegm’t
(
Reque¡
* 
»q
);

64 
	sGPUCßËsûrReque¡


66 
Pack‘PŒ
 
	mpkt
;

67 
RubyReque¡Ty³
 
	mm_ty³
;

68 
Cyşes
 
	missue_time
;

70 
GPUCßËsûrReque¡
(
Pack‘PŒ
 
_pkt
, 
RubyReque¡Ty³
 
_m_ty³
,

71 
Cyşes
 
_issue_time
)

72 : 
pkt
(
_pkt
), 
m_ty³
(
_m_ty³
), 
issue_time
(
_issue_time
)

76 şas 
	cReque¡Desc


78 
	mpublic
:

79 
	$Reque¡Desc
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
p_ty³
, RubyReque¡Ty³ 
s_ty³
)

80 : 
	`pkt
(
pkt
), 
	`´im¬yTy³
(
p_ty³
), 
	$£cÚd¬yTy³
(
s_ty³
)

84 
	$Reque¡Desc
(è: 
	`pkt
(
nuÎ±r
), 
	`´im¬yTy³
(
RubyReque¡Ty³_NULL
),

85 
	$£cÚd¬yTy³
(
RubyReque¡Ty³_NULL
)

87 
	}
}

89 
Pack‘PŒ
 
	gpkt
;

90 
RubyReque¡Ty³
 
	g´im¬yTy³
;

91 
RubyReque¡Ty³
 
	g£cÚd¬yTy³
;

94 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gGPUCßËsûrReque¡
& 
	gobj
);

96 şas 
	cGPUCßËsûr
 : 
public
 
RubyPÜt


98 
public
:

99 
RubyGPUCßËsûrP¬ams
 
	tP¬ams
;

100 
GPUCßËsûr
(cÚ¡ 
P¬ams
 *);

101 ~
GPUCßËsûr
();

104 
wakeup
();

106 
	$´štProg»ss
(
¡d
::
o¡»am
& 
out
) const;

107 
	`»£tSts
();

108 
	`cŞÏ‹Sts
();

109 
	`»gSts
();

111 
	`wr™eC®lback
(
Addr
 
add»ss
, 
D©aBlock
& 
d©a
);

113 
	`wr™eC®lback
(
Addr
 
add»ss
,

114 
MachšeTy³
 
mach
,

115 
D©aBlock
& 
d©a
);

117 
	`wr™eC®lback
(
Addr
 
add»ss
,

118 
MachšeTy³
 
mach
,

119 
D©aBlock
& 
d©a
,

120 
Cyşes
 
š™ŸlReque¡Time
,

121 
Cyşes
 
fÜw¬dReque¡Time
,

122 
Cyşes
 
fœ¡Re¥Ú£Time
,

123 
boŞ
 
isRegiÚ
);

125 
	`wr™eC®lback
(
Addr
 
add»ss
,

126 
MachšeTy³
 
mach
,

127 
D©aBlock
& 
d©a
,

128 
Cyşes
 
š™ŸlReque¡Time
,

129 
Cyşes
 
fÜw¬dReque¡Time
,

130 
Cyşes
 
fœ¡Re¥Ú£Time
);

132 
	`»adC®lback
(
Addr
 
add»ss
, 
D©aBlock
& 
d©a
);

134 
	`»adC®lback
(
Addr
 
add»ss
,

135 
MachšeTy³
 
mach
,

136 
D©aBlock
& 
d©a
);

138 
	`»adC®lback
(
Addr
 
add»ss
,

139 
MachšeTy³
 
mach
,

140 
D©aBlock
& 
d©a
,

141 
Cyşes
 
š™ŸlReque¡Time
,

142 
Cyşes
 
fÜw¬dReque¡Time
,

143 
Cyşes
 
fœ¡Re¥Ú£Time
);

145 
	`»adC®lback
(
Addr
 
add»ss
,

146 
MachšeTy³
 
mach
,

147 
D©aBlock
& 
d©a
,

148 
Cyşes
 
š™ŸlReque¡Time
,

149 
Cyşes
 
fÜw¬dReque¡Time
,

150 
Cyşes
 
fœ¡Re¥Ú£Time
,

151 
boŞ
 
isRegiÚ
);

154 
	`©omicC®lback
(
Addr
 
add»ss
,

155 
MachšeTy³
 
mach
,

156 cÚ¡ 
D©aBlock
& 
d©a
);

158 
	`»cÜdCPR—dC®lBack
(
MachšeID
 
myMachID
, MachšeID 
£nd”MachID
);

159 
	`»cÜdCPWr™eC®lBack
(
MachšeID
 
myMachID
, MachšeID 
£nd”MachID
);

162 
vœtu®
 
Reque¡Stus
 
	`makeReque¡
(
Pack‘PŒ
 
pkt
);

164 
	$out¡ªdšgCouÁ
(ècÚ¡ {  
m_out¡ªdšg_couÁ
; }

166 
boŞ


167 
	$isD—dlockEv’tScheduËd
() const

169  
d—dlockCheckEv’t
.
	`scheduËd
();

170 
	}
}

173 
	$descheduËD—dlockEv’t
()

175 
	`descheduË
(
d—dlockCheckEv’t
);

176 
	}
}

178 
boŞ
 
	$em±y
() const;

180 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

181 
	`checkCoh”’û
(
Addr
 
add»ss
);

183 
	`m¬kRemoved
();

184 
	`»moveReque¡
(
GPUCßËsûrReque¡
* 
»que¡
);

185 
	`eviùiÚC®lback
(
Addr
 
add»ss
);

186 
	`com¶‘eIssue
();

188 
	`š£¹K”Ãl
(
waveäÚt_id
, 
Pack‘PŒ
 
pkt
);

190 
	`»cÜdReque¡Ty³
(
Sequ’ûrReque¡Ty³
 
»que¡Ty³
);

191 
Sts
::
Hi¡og¿m
& 
	$g‘Out¡ªdReqHi¡
(è{  
m_out¡ªdReqHi¡
; 
	}
}

193 
	gSts
::
Hi¡og¿m
& 
	$g‘L©’cyHi¡
(è{  
m_Ï‹ncyHi¡
; 
	}
}

194 
	gSts
::
Hi¡og¿m
& 
	$g‘Ty³L©’cyHi¡
(
ušt32_t
 
t
)

195 {  *
m_ty³L©’cyHi¡
[
t
]; 
	}
}

197 
	gSts
::
Hi¡og¿m
& 
	$g‘MissL©’cyHi¡
()

198 {  
m_missL©’cyHi¡
; 
	}
}

199 
	gSts
::
Hi¡og¿m
& 
	$g‘MissTy³L©’cyHi¡
(
ušt32_t
 
t
)

200 {  *
m_missTy³L©’cyHi¡
[
t
]; 
	}
}

202 
	gSts
::
Hi¡og¿m
& 
	$g‘MissMachL©’cyHi¡
(
ušt32_t
 
t
) const

203 {  *
m_missMachL©’cyHi¡
[
t
]; 
	}
}

205 
	gSts
::
Hi¡og¿m
&

206 
	$g‘MissTy³MachL©’cyHi¡
(
ušt32_t
 
r
, ušt32_ˆ
t
) const

207 {  *
m_missTy³MachL©’cyHi¡
[
r
][
t
]; 
	}
}

209 
	gSts
::
Hi¡og¿m
& 
	$g‘IssueToIn™ŸlD–ayHi¡
(
ušt32_t
 
t
) const

210 {  *
m_IssueToIn™ŸlD–ayHi¡
[
t
]; 
	}
}

212 
	gSts
::
Hi¡og¿m
&

213 
	$g‘In™ŸlToFÜw¬dD–ayHi¡
(cÚ¡ 
MachšeTy³
 
t
) const

214 {  *
m_In™ŸlToFÜw¬dD–ayHi¡
[
t
]; 
	}
}

216 
	gSts
::
Hi¡og¿m
&

217 
	$g‘FÜw¬dReque¡ToFœ¡Re¥Ú£Hi¡
(cÚ¡ 
MachšeTy³
 
t
) const

218 {  *
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
[
t
]; 
	}
}

220 
	gSts
::
Hi¡og¿m
&

221 
	$g‘Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
(cÚ¡ 
MachšeTy³
 
t
) const

222 {  *
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
[
t
]; 
	}
}

225 
	g´Ùeùed
:

226 
boŞ
 
ŒyCacheAcûss
(
Addr
 
addr
, 
RubyReque¡Ty³
 
ty³
,

227 
Addr
 
pc
, 
RubyAcûssMode
 
acûss_mode
,

228 
size
, 
D©aBlock
*& 
d©a_±r
);

230 
vœtu®
 
issueReque¡
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
ty³
);

232 
k”ÃlC®lback
(
waväÚt_id
);

234 
h™C®lback
(
GPUCßËsûrReque¡
* 
»que¡
,

235 
MachšeTy³
 
mach
,

236 
D©aBlock
& 
d©a
,

237 
boŞ
 
sucûss
,

238 
Cyşes
 
š™ŸlReque¡Time
,

239 
Cyşes
 
fÜw¬dReque¡Time
,

240 
Cyşes
 
fœ¡Re¥Ú£Time
,

241 
boŞ
 
isRegiÚ
);

242 
»cÜdMissL©’cy
(
GPUCßËsûrReque¡
* 
»que¡
,

243 
MachšeTy³
 
mach
,

244 
Cyşes
 
š™ŸlReque¡Time
,

245 
Cyşes
 
fÜw¬dReque¡Time
,

246 
Cyşes
 
fœ¡Re¥Ú£Time
,

247 
boŞ
 
sucûss
, boŞ 
isRegiÚ
);

248 
com¶‘eH™C®lback
(
¡d
::
veùÜ
<
Pack‘PŒ
> & 
myli¡
, 
Ën
);

249 
Pack‘PŒ
 
m­AddrToPkt
(
Addr
 
add»ss
);

252 
Reque¡Stus
 
g‘Reque¡Stus
(
Pack‘PŒ
 
pkt
,

253 
RubyReque¡Ty³
 
»que¡_ty³
);

254 
boŞ
 
š£¹Reque¡
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
»que¡_ty³
);

256 
boŞ
 
hªdËLlsc
(
Addr
 
add»ss
, 
GPUCßËsûrReque¡
* 
»que¡
);

259 
GPUCßËsûr
(cÚ¡ GPUCßËsûr& 
obj
);

260 
	gGPUCßËsûr
& 
	gİ”©Ü
=(cÚ¡ 
GPUCßËsûr
& 
obj
);

262 şas 
	cIssueEv’t
 : 
public
 
Ev’t


264 
´iv©e
:

265 
GPUCßËsûr
 *
£q
;

266 
	gpublic
:

267 
IssueEv’t
(
GPUCßËsûr
 *
_£q
);

268 
´oûss
();

269 cÚ¡ *
desütiÚ
() const;

272 
IssueEv’t
 
	gissueEv’t
;

276 
	g´Ùeùed
:

277 
m_max_out¡ªdšg_»que¡s
;

278 
	gm_d—dlock_th»shŞd
;

280 
CacheMemÜy
* 
	gm_d©aCache_±r
;

281 
CacheMemÜy
* 
	gm_š¡Cache_±r
;

286 
Cyşes
 
	gm_d©a_ÿche_h™_Ï‹ncy
;

292 
	g¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	t¡d
::
	tveùÜ
<
	tReque¡Desc
>> 
	tCßËscšgTabË
;

293 
CßËscšgTabË
 
	g»qCßËsûr
;

294 
	g¡d
::
veùÜ
<
Addr
> 
ÃwReque¡s
;

296 
	g¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	tGPUCßËsûrReque¡
*> 
	tReque¡TabË
;

297 
Reque¡TabË
 
	gm_wr™eReque¡TabË
;

298 
Reque¡TabË
 
	gm_»adReque¡TabË
;

300 
	gm_out¡ªdšg_couÁ
;

301 
boŞ
 
	gm_d—dlock_check_scheduËd
;

302 
	g¡d
::
unÜd”ed_m­
<, 
	gPack‘PŒ
> 
	gk”ÃlEndLi¡
;

303 
	g¡d
::
veùÜ
<> 
ÃwK”ÃlEnds
;

305 
	gm_¡Üe_wa™šg_Ú_lßd_cyşes
;

306 
	gm_¡Üe_wa™šg_Ú_¡Üe_cyşes
;

307 
	gm_lßd_wa™šg_Ú_¡Üe_cyşes
;

308 
	gm_lßd_wa™šg_Ú_lßd_cyşes
;

310 
boŞ
 
	gm_ruÂšgG¬ÃtSnd®Úe
;

312 şas 
	cGPUCßËsûrWakeupEv’t
 : 
public
 
Ev’t


314 
´iv©e
:

315 
GPUCßËsûr
 *
m_GPUCßËsûr_±r
;

317 
	gpublic
:

318 
GPUCßËsûrWakeupEv’t
(
GPUCßËsûr
 *
_£q
) :

319 
m_GPUCßËsûr_±r
(
_£q
) {}

320 
´oûss
(è{ 
m_GPUCßËsûr_±r
->
wakeup
(); }

321 cÚ¡ *
desütiÚ
() const

327 
GPUCßËsûrWakeupEv’t
 
	gd—dlockCheckEv’t
;

328 
boŞ
 
	gassumšgRfOCoh”’û
;

331 
	gSts
::
SÿÏr
 
GPU_TCPLdH™s
;

332 
	gSts
::
SÿÏr
 
GPU_TCPLdT¿nsãrs
;

333 
	gSts
::
SÿÏr
 
GPU_TCCLdH™s
;

334 
	gSts
::
SÿÏr
 
GPU_LdMiss
;

336 
	gSts
::
SÿÏr
 
GPU_TCPStH™s
;

337 
	gSts
::
SÿÏr
 
GPU_TCPStT¿nsãrs
;

338 
	gSts
::
SÿÏr
 
GPU_TCCStH™s
;

339 
	gSts
::
SÿÏr
 
GPU_StMiss
;

341 
	gSts
::
SÿÏr
 
CP_TCPLdH™s
;

342 
	gSts
::
SÿÏr
 
CP_TCPLdT¿nsãrs
;

343 
	gSts
::
SÿÏr
 
CP_TCCLdH™s
;

344 
	gSts
::
SÿÏr
 
CP_LdMiss
;

346 
	gSts
::
SÿÏr
 
CP_TCPStH™s
;

347 
	gSts
::
SÿÏr
 
CP_TCPStT¿nsãrs
;

348 
	gSts
::
SÿÏr
 
CP_TCCStH™s
;

349 
	gSts
::
SÿÏr
 
CP_StMiss
;

352 
	gSts
::
Hi¡og¿m
 
m_out¡ªdReqHi¡
;

355 
	gSts
::
Hi¡og¿m
 
m_Ï‹ncyHi¡
;

356 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_ty³L©’cyHi¡
;

360 
	gSts
::
Hi¡og¿m
 
m_missL©’cyHi¡
;

361 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_missTy³L©’cyHi¡
;

365 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_missMachL©’cyHi¡
;

366 
	g¡d
::
veùÜ
< 
¡d
::veùÜ<
Sts
::
Hi¡og¿m
 *> > 
m_missTy³MachL©’cyHi¡
;

369 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_IssueToIn™ŸlD–ayHi¡
;

370 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_In™ŸlToFÜw¬dD–ayHi¡
;

371 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
;

372 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
;

375 
šlše
 
	g¡d
::
o¡»am
&

376 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gGPUCßËsûr
& 
	gobj
)

378 
	gobj
.
´št
(
out
);

379 
	gout
 << 
	g¡d
::
æush
;

380  
	gout
;

	@ruby/system/RubyPort.cc

42 
	~"ıu/‹¡”s/ruby‹¡/RubyTe¡”.hh
"

43 
	~"debug/CÚfig.hh
"

44 
	~"debug/D¿š.hh
"

45 
	~"debug/Ruby.hh
"

46 
	~"mem/´ÙocŞ/AcûssP”missiÚ.hh
"

47 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCÚŒŞËr.hh
"

48 
	~"mem/ruby/sy¡em/RubyPÜt.hh
"

49 
	~"mem/sim¶e_mem.hh
"

50 
	~"sim/fuÎ_sy¡em.hh
"

51 
	~"sim/sy¡em.hh
"

53 
	gRubyPÜt
::
	$RubyPÜt
(cÚ¡ 
P¬ams
 *
p
)

54 : 
	`MemObjeù
(
p
), 
	`m_ruby_sy¡em
Õ->
ruby_sy¡em
), 
	`m_v”siÚ
Õ->
v”siÚ
),

55 
	`m_cÚŒŞËr
(
NULL
), 
	`m_mªd©Üy_q_±r
(NULL),

56 
	`m_usšgRubyTe¡”
(
p
->
usšg_ruby_‹¡”
), 
	`sy¡em
Õ->
sy¡em
),

57 
	`pioMa¡”PÜt
(
	`c¥rštf
("%s.pio-ma¡”-pÜt", 
	`Çme
()), 
this
),

58 
	`pioSÏvePÜt
(
	`c¥rštf
("%s.pio-¦ave-pÜt", 
	`Çme
()), 
this
),

59 
	`memMa¡”PÜt
(
	`c¥rštf
("%s.mem-ma¡”-pÜt", 
	`Çme
()), 
this
),

60 
	`memSÏvePÜt
(
	`c¥rštf
("%s-mem-¦ave-pÜt", 
	`Çme
()), 
this
,

61 
p
->
ruby_sy¡em
->
	`g‘AcûssBackšgStÜe
(), -1,

62 
p
->
no_»Œy_Ú_¡®l
),

63 
	`gÙAddrRªges
(
p
->
pÜt_ma¡”_cÚÃùiÚ_couÁ
),

64 
	`m_isCPUSequ’ûr
(
p
->
is_ıu_£qu’ûr
)

66 
	`as£¹
(
m_v”siÚ
 != -1);

69 
size_t
 
i
 = 0; i < 
p
->
pÜt_¦ave_cÚÃùiÚ_couÁ
; ++i) {

70 
¦ave_pÜts
.
	`push_back
(
Ãw
 
	`MemSÏvePÜt
(
	`c¥rštf
("%s.¦ave%d", 
	`Çme
(),

71 
i
), 
this
, 
p
->
ruby_sy¡em
->
	`g‘AcûssBackšgStÜe
(),

72 
i
, 
p
->
no_»Œy_Ú_¡®l
));

76 
size_t
 
i
 = 0; i < 
p
->
pÜt_ma¡”_cÚÃùiÚ_couÁ
; ++i) {

77 
ma¡”_pÜts
.
	`push_back
(
Ãw
 
	`PioMa¡”PÜt
(
	`c¥rštf
("%s.master%d",

78 
	`Çme
(), 
i
), 
this
));

80 
	}
}

83 
	gRubyPÜt
::
	$š™
()

85 
	`as£¹
(
m_cÚŒŞËr
 !ğ
NULL
);

86 
m_mªd©Üy_q_±r
 = 
m_cÚŒŞËr
->
	`g‘Mªd©ÜyQueue
();

87 
	}
}

89 
	gBa£Ma¡”PÜt
 &

90 
	gRubyPÜt
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

92 ià(
if_Çme
 == "mem_master_port") {

93  
memMa¡”PÜt
;

96 ià(
if_Çme
 == "pio_master_port") {

97  
pioMa¡”PÜt
;

102 ià(
if_Çme
 != "master") {

104  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

106 ià(
idx
 >ğ
¡©ic_ÿ¡
<
PÜtID
>(
ma¡”_pÜts
.
	`size
())) {

107 
	`·nic
("RubyPÜt::g‘Ma¡”PÜt: unknowÀšdex %d\n", 
idx
);

110  *
ma¡”_pÜts
[
idx
];

112 
	}
}

114 
	gBa£SÏvePÜt
 &

115 
	gRubyPÜt
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

117 ià(
if_Çme
 == "mem_slave_port") {

118  
memSÏvePÜt
;

121 ià(
if_Çme
 == "pio_slave_port")

122  
pioSÏvePÜt
;

126 ià(
if_Çme
 != "slave") {

128  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

130 ià(
idx
 >ğ
¡©ic_ÿ¡
<
PÜtID
>(
¦ave_pÜts
.
	`size
())) {

131 
	`·nic
("RubyPÜt::g‘SÏvePÜt: unknowÀšdex %d\n", 
idx
);

134  *
¦ave_pÜts
[
idx
];

136 
	}
}

138 
	gRubyPÜt
::
PioMa¡”PÜt
::
	$PioMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

139 
RubyPÜt
 *
_pÜt
)

140 : 
	`QueuedMa¡”PÜt
(
_Çme
, 
_pÜt
, 
»qQueue
, 
¢oİRe¥Queue
),

141 
	`»qQueue
(*
_pÜt
, *
this
), 
	$¢oİRe¥Queue
(*
_pÜt
, *
this
)

143 
	`DPRINTF
(
RubyPÜt
, "C»©ed ma¡”…iİÜˆÚ sequ’û¸%s\n", 
_Çme
);

144 
	}
}

146 
	gRubyPÜt
::
PioSÏvePÜt
::
	$PioSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

147 
RubyPÜt
 *
_pÜt
)

148 : 
	`QueuedSÏvePÜt
(
_Çme
, 
_pÜt
, 
queue
), 
	$queue
(*
_pÜt
, *
this
)

150 
	`DPRINTF
(
RubyPÜt
, "C»©ed sÏvpiİÜˆÚ sequ’û¸%s\n", 
_Çme
);

151 
	}
}

153 
	gRubyPÜt
::
MemMa¡”PÜt
::
	$MemMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
,

154 
RubyPÜt
 *
_pÜt
)

155 : 
	`QueuedMa¡”PÜt
(
_Çme
, 
_pÜt
, 
»qQueue
, 
¢oİRe¥Queue
),

156 
	`»qQueue
(*
_pÜt
, *
this
), 
	$¢oİRe¥Queue
(*
_pÜt
, *
this
)

158 
	`DPRINTF
(
RubyPÜt
, "C»©ed ma¡” mempÜˆÚ„uby sequ’û¸%s\n", 
_Çme
);

159 
	}
}

161 
	gRubyPÜt
::
MemSÏvePÜt
::
	$MemSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
RubyPÜt
 *
_pÜt
,

162 
boŞ
 
_acûss_backšg_¡Üe
, 
PÜtID
 
id
,

163 
boŞ
 
_no_»Œy_Ú_¡®l
)

164 : 
	`QueuedSÏvePÜt
(
_Çme
, 
_pÜt
, 
queue
, 
id
), 
	`queue
(*_pÜt, *
this
),

165 
	`acûss_backšg_¡Üe
(
_acûss_backšg_¡Üe
),

166 
	$no_»Œy_Ú_¡®l
(
_no_»Œy_Ú_¡®l
)

168 
	`DPRINTF
(
RubyPÜt
, "C»©ed sÏvmempÜˆÚ„uby sequ’û¸%s\n", 
_Çme
);

169 
	}
}

171 
boŞ


172 
	gRubyPÜt
::
PioMa¡”PÜt
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

174 
RubyPÜt
 *
½
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

175 
	`DPRINTF
(
RubyPÜt
, "Re¥Ú£ fÜ‡dd»ss: 0x%#x\n", 
pkt
->
	`g‘Addr
());

178 
½
->
pioSÏvePÜt
.
	`schedTimšgRe¥
(

179 
pkt
, 
	`curTick
(è+ 
½
->
m_ruby_sy¡em
->
	`şockP”iod
());

180  
Œue
;

181 
	}
}

183 
boŞ
 
	gRubyPÜt
::
MemMa¡”PÜt
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

186 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

189 
RubyPÜt
::
S’d”S‹
 *
£nd”S‹
 =

190 
§ã_ÿ¡
<
RubyPÜt
::
S’d”S‹
 *>(
pkt
->
	`pİS’d”S‹
());

191 
MemSÏvePÜt
 *
pÜt
 = 
£nd”S‹
->port;

192 
	`as£¹
(
pÜt
 !ğ
NULL
);

193 
d–‘e
 
£nd”S‹
;

197 
	`DPRINTF
(
RubyPÜt
, "Pio„esponse for‡ddress %#x, goingo %s\n",

198 
pkt
->
	`g‘Addr
(), 
pÜt
->
	`Çme
());

201 
RubyPÜt
 *
½
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

202 
pÜt
->
	`schedTimšgRe¥
(
pkt
, 
	`curTick
(è+ 
½
->
m_ruby_sy¡em
->
	`şockP”iod
());

204  
Œue
;

205 
	}
}

207 
boŞ


208 
	gRubyPÜt
::
PioSÏvePÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

210 
RubyPÜt
 *
ruby_pÜt
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

212 
size_t
 
i
 = 0; i < 
ruby_pÜt
->
ma¡”_pÜts
.
	`size
(); ++i) {

213 
AddrRªgeLi¡
 
l
 = 
ruby_pÜt
->
ma¡”_pÜts
[
i
]->
	`g‘AddrRªges
();

214 autØ
™
 = 
l
.
	`begš
(); iˆ!ğl.
	`’d
(); ++it) {

215 ià(
™
->
	`cÚšs
(
pkt
->
	`g‘Addr
())) {

218 
boŞ
 
M5_VAR_USED
 
sucûss
 =

219 
ruby_pÜt
->
ma¡”_pÜts
[
i
]->
	`£ndTimšgReq
(
pkt
);

220 
	`as£¹
(
sucûss
);

221  
Œue
;

225 
	`·nic
("Should‚ever„each here!\n");

226 
	}
}

228 
boŞ


229 
	gRubyPÜt
::
MemSÏvePÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

231 
	`DPRINTF
(
RubyPÜt
, "Timing„equest for‡ddress %#x on…ort %d\n",

232 
pkt
->
	`g‘Addr
(), 
id
);

233 
RubyPÜt
 *
ruby_pÜt
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

235 ià(
pkt
->
	`ÿcheRe¥Údšg
())

236 
	`·nic
("RubyPort should‚ever see„equest withhe "

241 ià(
pkt
->
cmd
 !ğ
MemCmd
::
MemF’ûReq
) {

242 ià(!
	`isPhysMemAdd»ss
(
pkt
->
	`g‘Addr
())) {

243 
	`as£¹
(
ruby_pÜt
->
memMa¡”PÜt
.
	`isCÚÃùed
());

244 
	`DPRINTF
(
RubyPÜt
, "Request‡ddress %#x‡ssumedo be‡ "

245 "piØadd»ss\n", 
pkt
->
	`g‘Addr
());

249 
pkt
->
	`pushS’d”S‹
(
Ãw
 
	`S’d”S‹
(
this
));

252 
RubySy¡em
 *
rs
 = 
ruby_pÜt
->
m_ruby_sy¡em
;

253 
ruby_pÜt
->
memMa¡”PÜt
.
	`schedTimšgReq
(
pkt
,

254 
	`curTick
(è+ 
rs
->
	`şockP”iod
());

255  
Œue
;

258 
	`as£¹
(
	`g‘Off£t
(
pkt
->
	`g‘Addr
()è+…kt->
	`g‘Size
() <=

259 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

263 
Reque¡Stus
 
»que¡Stus
 = 
ruby_pÜt
->
	`makeReque¡
(
pkt
);

268 ià(
»que¡Stus
 =ğ
Reque¡Stus_Issued
) {

271 
pkt
->
	`pushS’d”S‹
(
Ãw
 
	`S’d”S‹
(
this
));

273 
	`DPRINTF
(
RubyPÜt
, "Reque¡ % 0x%x issued\n", 
pkt
->
	`cmdSŒšg
(),

274 
pkt
->
	`g‘Addr
());

275  
Œue
;

278 ià(
pkt
->
cmd
 !ğ
MemCmd
::
MemF’ûReq
) {

279 
	`DPRINTF
(
RubyPÜt
,

281 
pkt
->
	`g‘Addr
(), 
	`Reque¡Stus_to_¡ršg
(
»que¡Stus
));

284 
	`addToR‘ryLi¡
();

286  
çl£
;

287 
	}
}

290 
	gRubyPÜt
::
MemSÏvePÜt
::
	$addToR‘ryLi¡
()

292 
RubyPÜt
 *
ruby_pÜt
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

299 ià(!
no_»Œy_Ú_¡®l
 && !
ruby_pÜt
->
	`ÚR‘ryLi¡
(
this
)) {

300 
ruby_pÜt
->
	`addToR‘ryLi¡
(
this
);

302 
	}
}

305 
	gRubyPÜt
::
MemSÏvePÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

307 
	`DPRINTF
(
RubyPÜt
, "FunùiÚ®‡cûs fÜ‡dd»ss: %#x\n", 
pkt
->
	`g‘Addr
());

309 
RubyPÜt
 *
½
 
M5_VAR_USED
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

310 
RubySy¡em
 *
rs
 = 
½
->
m_ruby_sy¡em
;

314 ià(!
	`isPhysMemAdd»ss
(
pkt
->
	`g‘Addr
())) {

315 
	`DPRINTF
(
RubyPÜt
, "PiØReque¡ fÜ‡dd»ss: 0x%#x\n", 
pkt
->
	`g‘Addr
());

316 
	`as£¹
(
½
->
pioMa¡”PÜt
.
	`isCÚÃùed
());

317 
½
->
pioMa¡”PÜt
.
	`£ndFunùiÚ®
(
pkt
);

321 
	`as£¹
(
pkt
->
	`g‘Addr
(è+…kt->
	`g‘Size
() <=

322 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
()è+ 
RubySy¡em
::
	`g‘BlockSizeBy‹s
());

324 ià(
acûss_backšg_¡Üe
) {

329 
rs
->
	`g‘PhysMem
()->
	`funùiÚ®Acûss
(
pkt
);

331 
boŞ
 
acûssSucûeded
 = 
çl£
;

332 
boŞ
 
ÃedsRe¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

335 ià(
pkt
->
	`isR—d
()) {

336 
acûssSucûeded
 = 
rs
->
	`funùiÚ®R—d
(
pkt
);

337 } ià(
pkt
->
	`isWr™e
()) {

338 
acûssSucûeded
 = 
rs
->
	`funùiÚ®Wr™e
(
pkt
);

340 
	`·nic
("UnsuµÜ‹d funùiÚ® commªd %s\n", 
pkt
->
	`cmdSŒšg
());

345 ià(!
acûssSucûeded
 && !
pkt
->
	`suµ»ssFuncE¼Ü
()) {

346 
	`çl
("Ruby functional %s failed for‡ddress %#x\n",

347 
pkt
->
	`isWr™e
(è? "wr™e" : "»ad",…kt->
	`g‘Addr
());

351 ià(
ÃedsRe¥Ú£
) {

352 
pkt
->
	`£tFunùiÚ®Re¥Ú£Stus
(
acûssSucûeded
);

355 
	`DPRINTF
(
RubyPÜt
, "Functional‡ccess %s!\n",

356 
acûssSucûeded
 ? "successful":"failed");

358 
	}
}

361 
	gRubyPÜt
::
	$ruby_h™_ÿÎback
(
Pack‘PŒ
 
pkt
)

363 
	`DPRINTF
(
RubyPÜt
, "H™ c®lback fÜ % 0x%x\n", 
pkt
->
	`cmdSŒšg
(),

364 
pkt
->
	`g‘Addr
());

368 
	`as£¹
(
sy¡em
->
	`isMemAddr
(
pkt
->
	`g‘Addr
()));

369 
	`as£¹
(
pkt
->
	`isReque¡
());

372 
RubyPÜt
::
S’d”S‹
 *
£nd”S‹
 =

373 
§ã_ÿ¡
<
RubyPÜt
::
S’d”S‹
 *>(
pkt
->
	`pİS’d”S‹
());

374 
MemSÏvePÜt
 *
pÜt
 = 
£nd”S‹
->port;

375 
	`as£¹
(
pÜt
 !ğ
NULL
);

376 
d–‘e
 
£nd”S‹
;

378 
pÜt
->
	`h™C®lback
(
pkt
);

380 
	`ŒyS’dR‘r›s
();

381 
	}
}

384 
	gRubyPÜt
::
	$ŒyS’dR‘r›s
()

390 ià(!
»ŒyLi¡
.
	`em±y
()) {

396 
¡d
::
veùÜ
<
MemSÏvePÜt
 *> 
	`curR‘ryLi¡
(
»ŒyLi¡
);

398 
»ŒyLi¡
.
	`ş—r
();

400 autØ
i
 = 
curR‘ryLi¡
.
	`begš
(); i !ğcurR‘ryLi¡.
	`’d
(); ++i) {

401 
	`DPRINTF
(
RubyPÜt
,

403 (*
i
)->
	`Çme
());

404 (*
i
)->
	`£ndR‘ryReq
();

407 
	}
}

410 
	gRubyPÜt
::
	$‹¡D¿šCom¶‘e
()

413 ià(
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
) {

414 
d¿šCouÁ
 = 
	`out¡ªdšgCouÁ
();

415 
	`DPRINTF
(
D¿š
, "D¿š couÁ: %u\n", 
d¿šCouÁ
);

416 ià(
d¿šCouÁ
 == 0) {

417 
	`DPRINTF
(
D¿š
, "RubyPort done draining, signaling drain done\n");

418 
	`sigÇlD¿šDÚe
();

421 
	}
}

423 
D¿šS‹


424 
	gRubyPÜt
::
	$d¿š
()

426 ià(
	`isD—dlockEv’tScheduËd
()) {

427 
	`descheduËD—dlockEv’t
();

434 
	`DPRINTF
(
CÚfig
, "out¡ªdšg couÁ %d\n", 
	`out¡ªdšgCouÁ
());

435 ià(
	`out¡ªdšgCouÁ
() > 0) {

436 
	`DPRINTF
(
D¿š
, "RubyPort‚ot drained\n");

437  
D¿šS‹
::
D¿ššg
;

439  
D¿šS‹
::
D¿šed
;

441 
	}
}

444 
	gRubyPÜt
::
MemSÏvePÜt
::
	$h™C®lback
(
Pack‘PŒ
 
pkt
)

446 
boŞ
 
ÃedsRe¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

450 
boŞ
 
acûssPhysMem
 = 
acûss_backšg_¡Üe
;

452 ià(
pkt
->
	`isLLSC
()) {

453 ià(
pkt
->
	`isWr™e
()) {

454 ià(
pkt
->
»q
->
	`g‘ExŒaD©a
() != 0) {

458 
pkt
->
	`cÚv”tScToWr™e
();

464 
acûssPhysMem
 = 
çl£
;

471 
pkt
->
	`cÚv”tLlToR—d
();

476 ià(
pkt
->
	`isFlush
(è||…kt->
cmd
 =ğ
MemCmd
::
MemF’ûReq
) {

477 
acûssPhysMem
 = 
çl£
;

480 ià(
pkt
->
»q
->
	`isK”Ãl
()) {

481 
acûssPhysMem
 = 
çl£
;

482 
ÃedsRe¥Ú£
 = 
Œue
;

485 
	`DPRINTF
(
RubyPÜt
, "H™ c®lback‚“d »¥Ú£ %d\n", 
ÃedsRe¥Ú£
);

487 
RubyPÜt
 *
ruby_pÜt
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

488 
RubySy¡em
 *
rs
 = 
ruby_pÜt
->
m_ruby_sy¡em
;

489 ià(
acûssPhysMem
) {

490 
rs
->
	`g‘PhysMem
()->
	`acûss
(
pkt
);

491 } ià(
ÃedsRe¥Ú£
) {

492 
pkt
->
	`makeRe¥Ú£
();

496 ià(
ÃedsRe¥Ú£
) {

497 
	`DPRINTF
(
RubyPÜt
, "Sending…acket back over…ort\n");

501 
	`schedTimšgRe¥
(
pkt
, 
	`curTick
());

503 
d–‘e
 
pkt
;

506 
	`DPRINTF
(
RubyPÜt
, "Hit callback done!\n");

507 
	}
}

509 
AddrRªgeLi¡


510 
	gRubyPÜt
::
PioSÏvePÜt
::
	$g‘AddrRªges
() const

513 
AddrRªgeLi¡
 
¿nges
;

514 
RubyPÜt
 *
ruby_pÜt
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

516 
size_t
 
i
 = 0; i < 
ruby_pÜt
->
ma¡”_pÜts
.
	`size
(); ++i) {

517 
¿nges
.
	`¥liû
Ôªges.
	`begš
(),

518 
ruby_pÜt
->
ma¡”_pÜts
[
i
]->
	`g‘AddrRªges
());

520 cÚ¡‡utØ
M5_VAR_USED
 &
r
 : 
¿nges
)

521 
	`DPRINTF
(
RubyPÜt
, "%s\n", 
r
.
	`to_¡ršg
());

522  
¿nges
;

523 
	}
}

525 
boŞ


526 
	gRubyPÜt
::
MemSÏvePÜt
::
	$isPhysMemAdd»ss
(
Addr
 
addr
) const

528 
RubyPÜt
 *
ruby_pÜt
 = 
¡©ic_ÿ¡
<RubyPÜˆ*>(&
owÃr
);

529  
ruby_pÜt
->
sy¡em
->
	`isMemAddr
(
addr
);

530 
	}
}

533 
	gRubyPÜt
::
	$ruby_eviùiÚ_ÿÎback
(
Addr
 
add»ss
)

535 
	`DPRINTF
(
RubyPÜt
, "Sending invalidations.\n");

539 
Reque¡
 
	`»que¡
(
add»ss
, 
RubySy¡em
::
	`g‘BlockSizeBy‹s
(), 0,

540 
Reque¡
::
funcMa¡”Id
);

543 
Pack‘
 
	`pkt
(&
»que¡
, 
MemCmd
::
Inv®id©eReq
);

544 
CpuPÜtI‹r
 
p
 = 
¦ave_pÜts
.
	`begš
();… !ğ¦ave_pÜts.
	`’d
(); ++p) {

546 ià((*
p
)->
	`isSnoİšg
()) {

548 (*
p
)->
	`£ndTimšgSnoİReq
(&
pkt
);

551 
	}
}

554 
	gRubyPÜt
::
PioMa¡”PÜt
::
	$»cvRªgeChªge
()

556 
RubyPÜt
 &
r
 = 
¡©ic_ÿ¡
<RubyPÜˆ&>(
owÃr
);

557 
r
.
gÙAddrRªges
--;

558 ià(
r
.
gÙAddrRªges
 =ğ0 && 
FuÎSy¡em
) {

559 
r
.
pioSÏvePÜt
.
	`£ndRªgeChªge
();

561 
	}
}

	@ruby/system/RubyPort.hh

42 #iâdeà
__MEM_RUBY_SYSTEM_RUBYPORT_HH__


43 
	#__MEM_RUBY_SYSTEM_RUBYPORT_HH__


	)

45 
	~<ÿs£¹
>

46 
	~<¡ršg
>

48 
	~"mem/´ÙocŞ/Reque¡Stus.hh
"

49 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

50 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

51 
	~"mem/mem_objeù.hh
"

52 
	~"mem/Üt.hh
"

53 
	~"·¿ms/RubyPÜt.hh
"

55 
şass
 
	gAb¡¿ùCÚŒŞËr
;

57 şas 
	cRubyPÜt
 : 
public
 
MemObjeù


59 
public
:

60 şas 
	cMemMa¡”PÜt
 : 
public
 
QueuedMa¡”PÜt


62 
´iv©e
:

63 
ReqPack‘Queue
 
»qQueue
;

64 
SnoİRe¥Pack‘Queue
 
	m¢oİRe¥Queue
;

66 
	mpublic
:

67 
MemMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
RubyPÜt
 *
_pÜt
);

69 
	m´Ùeùed
:

70 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

71 
»cvRªgeChªge
() {}

74 şas 
	cMemSÏvePÜt
 : 
public
 
QueuedSÏvePÜt


76 
´iv©e
:

77 
Re¥Pack‘Queue
 
queue
;

78 
boŞ
 
	gacûss_backšg_¡Üe
;

79 
boŞ
 
	gno_»Œy_Ú_¡®l
;

81 
	gpublic
:

82 
MemSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
RubyPÜt
 *
_pÜt
,

83 
boŞ
 
_acûss_backšg_¡Üe
,

84 
PÜtID
 
id
, 
boŞ
 
_no_»Œy_Ú_¡®l
);

85 
h™C®lback
(
Pack‘PŒ
 
pkt
);

86 
eviùiÚC®lback
(
Addr
 
add»ss
);

88 
	g´Ùeùed
:

89 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

91 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
)

92 { 
·nic
("RubyPort::MemSlavePort::recvAtomic()‚ot implemented!\n"); }

94 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

96 
AddrRªgeLi¡
 
g‘AddrRªges
() const

97 { 
AddrRªgeLi¡
 
	g¿nges
; „anges; }

99 
addToR‘ryLi¡
();

101 
	g´iv©e
:

102 
boŞ
 
isPhysMemAdd»ss
(
Addr
 
addr
) const;

105 şas 
	cPioMa¡”PÜt
 : 
public
 
QueuedMa¡”PÜt


107 
´iv©e
:

108 
ReqPack‘Queue
 
»qQueue
;

109 
SnoİRe¥Pack‘Queue
 
	g¢oİRe¥Queue
;

111 
	gpublic
:

112 
PioMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
RubyPÜt
 *
_pÜt
);

114 
	g´Ùeùed
:

115 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

116 
»cvRªgeChªge
();

119 şas 
	cPioSÏvePÜt
 : 
public
 
QueuedSÏvePÜt


121 
´iv©e
:

122 
Re¥Pack‘Queue
 
queue
;

124 
	gpublic
:

125 
PioSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
_Çme
, 
RubyPÜt
 *
_pÜt
);

127 
	g´Ùeùed
:

128 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

130 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
)

131 { 
·nic
("recvAtomic‚ot supported with„uby!"); }

133 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

134 { 
·nic
("recvFunctional should‚ever be called on…io slave…ort!"); }

136 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

139 
	gS’d”S‹
 : 
public
 
Pack‘
::
S’d”S‹


141 
MemSÏvePÜt
 *
pÜt
;

142 
S’d”S‹
(
MemSÏvePÜt
 * 
_pÜt
è: 
pÜt
(_port)

146 
RubyPÜtP¬ams
 
	tP¬ams
;

147 
RubyPÜt
(cÚ¡ 
P¬ams
 *
p
);

148 
	gvœtu®
 ~
	$RubyPÜt
(è{
	}
}

150 
	$š™
(è
ov”ride
;

152 
Ba£Ma¡”PÜt
 &
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

153 
PÜtID
 
idx
 = 
Inv®idPÜtID
è
ov”ride
;

154 
Ba£SÏvePÜt
 &
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
,

155 
PÜtID
 
idx
 = 
Inv®idPÜtID
è
ov”ride
;

157 
vœtu®
 
Reque¡Stus
 
	`makeReque¡
(
Pack‘PŒ
 
pkt
) = 0;

158 
vœtu®
 
	$out¡ªdšgCouÁ
() const = 0;

159 
vœtu®
 
boŞ
 
	$isD—dlockEv’tScheduËd
() const = 0;

160 
vœtu®
 
	`descheduËD—dlockEv’t
() = 0;

166 
	$£tCÚŒŞËr
(
Ab¡¿ùCÚŒŞËr
* 
_úŒl
è{ 
m_cÚŒŞËr
 = _úŒl; 
	}
}

167 
ušt32_t
 
	$g‘Id
(è{  
m_v”siÚ
; 
	}
}

168 
D¿šS‹
 
	$d¿š
(è
ov”ride
;

170 
boŞ
 
	$isCPUSequ’ûr
(è{  
m_isCPUSequ’ûr
; 
	}
}

172 
	g´Ùeùed
:

173 
ŒyS’dR‘r›s
();

174 
ruby_h™_ÿÎback
(
Pack‘PŒ
 
pkt
);

175 
‹¡D¿šCom¶‘e
();

176 
ruby_eviùiÚ_ÿÎback
(
Addr
 
add»ss
);

186 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
PÜtID
 
ma¡”_pÜt_id
);

188 
RubySy¡em
 *
	gm_ruby_sy¡em
;

189 
ušt32_t
 
	gm_v”siÚ
;

190 
Ab¡¿ùCÚŒŞËr
* 
	gm_cÚŒŞËr
;

191 
Mes§geBufãr
* 
	gm_mªd©Üy_q_±r
;

192 
boŞ
 
	gm_usšgRubyTe¡”
;

193 
Sy¡em
* 
	gsy¡em
;

195 
	g¡d
::
veùÜ
<
MemSÏvePÜt
 *> 
¦ave_pÜts
;

197 
	g´iv©e
:

198 
boŞ
 
	$ÚR‘ryLi¡
(
MemSÏvePÜt
 * 
pÜt
)

200  (
¡d
::
	`fšd
(
»ŒyLi¡
.
	`begš
(),„‘ryLi¡.
	`’d
(), 
pÜt
) !=

201 
»ŒyLi¡
.
	`’d
());

202 
	}
}

203 
	$addToR‘ryLi¡
(
MemSÏvePÜt
 * 
pÜt
)

205 ià(
	`ÚR‘ryLi¡
(
pÜt
)) ;

206 
»ŒyLi¡
.
	`push_back
(
pÜt
);

207 
	}
}

209 
PioMa¡”PÜt
 
	gpioMa¡”PÜt
;

210 
PioSÏvePÜt
 
	gpioSÏvePÜt
;

211 
MemMa¡”PÜt
 
	gmemMa¡”PÜt
;

212 
MemSÏvePÜt
 
	gmemSÏvePÜt
;

213 
	ggÙAddrRªges
;

216 
	g¡d
::
	tveùÜ
<
	tMemSÏvePÜt
 *>::
	t™”©Ü
 
	tCpuPÜtI‹r
;

217 
	g¡d
::
veùÜ
<
PioMa¡”PÜt
 *> 
ma¡”_pÜts
;

223 
	g¡d
::
veùÜ
<
MemSÏvePÜt
 *> 
»ŒyLi¡
;

225 
boŞ
 
	gm_isCPUSequ’ûr
;

	@ruby/system/RubyPortProxy.cc

40 
	~"mem/ruby/sy¡em/RubyPÜtProxy.hh
"

42 
	gRubyPÜtProxy
::
	$RubyPÜtProxy
(cÚ¡ 
RubyPÜtProxyP¬ams
* 
p
) :

43 
	$RubyPÜt
(
p
) {

44 
	}
}

46 
RubyPÜtProxy
::~
	$RubyPÜtProxy
()

48 
	}
}

51 
RubyPÜtProxy
::
	$š™
()

54 
	}
}

56 
Reque¡Stus


57 
RubyPÜtProxy
::
	$makeReque¡
(
Pack‘PŒ
 
pkt
)

62 
	`·nic
("RubyPortProxy::makeRequest should‚ot be called");

63  
Reque¡Stus_NULL
;

64 
	}
}

66 
RubyPÜtProxy
*

67 
	gRubyPÜtProxyP¬ams
::
	$ü—‹
()

69  
Ãw
 
	`RubyPÜtProxy
(
this
);

70 
	}
}

	@ruby/system/RubyPortProxy.hh

48 #iâdeà
__MEM_RUBY_SYSTEM_RUBYPORTPROXY_HH__


49 
	#__MEM_RUBY_SYSTEM_RUBYPORTPROXY_HH__


	)

51 
	~"mem/ruby/sy¡em/RubyPÜt.hh
"

52 
	~"·¿ms/RubyPÜtProxy.hh
"

54 şas 
	cRubyPÜtProxy
 : 
public
 
RubyPÜt


57 
public
:

64 
RubyPÜtProxy
(cÚ¡ 
RubyPÜtProxyP¬ams
* 
p
);

69 
	mvœtu®
 ~
RubyPÜtProxy
();

75 
š™
();

85 
Reque¡Stus
 
makeReque¡
(
Pack‘PŒ
 
pkt
);

94 
	$out¡ªdšgCouÁ
() const {  0; }

103 
boŞ
 
	$isD—dlockEv’tScheduËd
(ècÚ¡ {  
çl£
; 
	}
}

110 
	$descheduËD—dlockEv’t
(è{ 
	}
}

	@ruby/system/RubySystem.cc

29 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

31 
	~<fú.h
>

32 
	~<zlib.h
>

34 
	~<c¡dio
>

35 
	~<li¡
>

37 
	~"ba£/štm©h.hh
"

38 
	~"ba£/¡©i¡ics.hh
"

39 
	~"debug/RubyCacheT¿û.hh
"

40 
	~"debug/RubySy¡em.hh
"

41 
	~"mem/ruby/commÚ/Add»ss.hh
"

42 
	~"mem/ruby/ÃtwÜk/N‘wÜk.hh
"

43 
	~"mem/sim¶e_mem.hh
"

44 
	~"sim/ev’tq.hh
"

45 
	~"sim/simuÏ‹.hh
"

47 
usšg
 
Çme¥aû
 
	g¡d
;

49 
boŞ
 
	gRubySy¡em
::
m_¿ndomiz©iÚ
;

50 
ušt32_t
 
	gRubySy¡em
::
m_block_size_by‹s
;

51 
ušt32_t
 
	gRubySy¡em
::
m_block_size_b™s
;

52 
ušt32_t
 
	gRubySy¡em
::
m_memÜy_size_b™s
;

53 
boŞ
 
	gRubySy¡em
::
m_w¬mup_’abËd
 = 
çl£
;

56 
	gRubySy¡em
::
m_sy¡ems_to_w¬mup
 = 0;

57 
boŞ
 
	gRubySy¡em
::
m_coŞdown_’abËd
 = 
çl£
;

59 
	gRubySy¡em
::
	$RubySy¡em
(cÚ¡ 
P¬ams
 *
p
)

60 : 
	`ClockedObjeù
(
p
), 
	`m_acûss_backšg_¡Üe
Õ->
acûss_backšg_¡Üe
),

61 
	$m_ÿche_»cÜd”
(
NULL
)

63 
m_¿ndomiz©iÚ
 = 
p
->
¿ndomiz©iÚ
;

65 
m_block_size_by‹s
 = 
p
->
block_size_by‹s
;

66 
	`as£¹
(
	`isPow”Of2
(
m_block_size_by‹s
));

67 
m_block_size_b™s
 = 
	`æoÜLog2
(
m_block_size_by‹s
);

68 
m_memÜy_size_b™s
 = 
p
->
memÜy_size_b™s
;

71 
m_ab¡¿ù_cÚŒŞs
.
	`»size
(
MachšeTy³_NUM
);

74 
Sts
::
	`»gi¡”DumpC®lback
(
Ãw
 
	`RubyStsC®lback
(
this
));

76 
m_´of”
 = 
Ãw
 
	`Prof”
(
p
, 
this
);

77 
m_phys_mem
 = 
p
->
phys_mem
;

78 
	}
}

81 
	gRubySy¡em
::
	$»gi¡”N‘wÜk
(
N‘wÜk
* 
ÃtwÜk_±r
)

83 
m_ÃtwÜk
 = 
ÃtwÜk_±r
;

84 
	}
}

87 
	gRubySy¡em
::
	$»gi¡”Ab¡¿ùCÚŒŞËr
(
Ab¡¿ùCÚŒŞËr
* 
úŒl
)

89 
m_abs_úŒl_vec
.
	`push_back
(
úŒl
);

91 
MachšeID
 
id
 = 
úŒl
->
	`g‘MachšeID
();

92 
m_ab¡¿ù_cÚŒŞs
[
id
.
	`g‘Ty³
()][id.
	`g‘Num
()] = 
úŒl
;

93 
	}
}

95 
	gRubySy¡em
::~
	$RubySy¡em
()

97 
d–‘e
 
m_ÃtwÜk
;

98 
d–‘e
 
m_´of”
;

99 
	}
}

102 
	gRubySy¡em
::
	$makeCacheRecÜd”
(
ušt8_t
 *
uncom´es£d_Œaû
,

103 
ušt64_t
 
ÿche_Œaû_size
,

104 
ušt64_t
 
block_size_by‹s
)

106 
veùÜ
<
Sequ’ûr
*> 
£qu’ûr_m­
;

107 
Sequ’ûr
* 
£qu’ûr_±r
 = 
NULL
;

109 
úŒl
 = 0; cÁ¾ < 
m_abs_úŒl_vec
.
	`size
(); cntrl++) {

110 
£qu’ûr_m­
.
	`push_back
(
m_abs_úŒl_vec
[
úŒl
]->
	`g‘CPUSequ’ûr
());

111 ià(
£qu’ûr_±r
 =ğ
NULL
) {

112 
£qu’ûr_±r
 = 
£qu’ûr_m­
[
úŒl
];

116 
	`as£¹
(
£qu’ûr_±r
 !ğ
NULL
);

118 
úŒl
 = 0; cÁ¾ < 
m_abs_úŒl_vec
.
	`size
(); cntrl++) {

119 ià(
£qu’ûr_m­
[
úŒl
] =ğ
NULL
) {

120 
£qu’ûr_m­
[
úŒl
] = 
£qu’ûr_±r
;

125 ià(
m_ÿche_»cÜd”
 !ğ
NULL
) {

126 
d–‘e
 
m_ÿche_»cÜd”
;

130 
m_ÿche_»cÜd”
 = 
Ãw
 
	`CacheRecÜd”
(
uncom´es£d_Œaû
, 
ÿche_Œaû_size
,

131 
£qu’ûr_m­
, 
block_size_by‹s
);

132 
	}
}

135 
	gRubySy¡em
::
	$memWr™eback
()

137 
m_coŞdown_’abËd
 = 
Œue
;

140 
	`DPRINTF
(
RubyCacheT¿û
, "Recording Cache Trace\n");

141 
	`makeCacheRecÜd”
(
NULL
, 0, 
	`g‘BlockSizeBy‹s
());

142 
úŒl
 = 0; cÁ¾ < 
m_abs_úŒl_vec
.
	`size
(); cntrl++) {

143 
m_abs_úŒl_vec
[
úŒl
]->
	`»cÜdCacheT¿û
(úŒl, 
m_ÿche_»cÜd”
);

145 
	`DPRINTF
(
RubyCacheT¿û
, "Cache Trace Complete\n");

148 
Tick
 
cu¹ick_Üigš®
 = 
	`curTick
();

149 
	`DPRINTF
(
RubyCacheT¿û
, "RecÜdšg cu¼’ˆtick %ld\n", 
cu¹ick_Üigš®
);

153 
li¡
<
·œ
<
Ev’t
*, 
Tick
> > 
Üigš®_ev’ts
;

154 !
ev’tq
->
	`em±y
()) {

155 
Ev’t
 *
cu¼_h—d
 = 
ev’tq
->
	`g‘H—d
();

156 ià(
cu¼_h—d
->
	`isAutoD–‘e
()) {

157 
	`DPRINTF
(
RubyCacheT¿û
, "Event %s‡uto-deletes when descheduled,"

158 "‚Ù„ecÜdšg\n", 
cu¼_h—d
->
	`Çme
());

160 
Üigš®_ev’ts
.
	`push_back
(
	`make_·œ
(
cu¼_h—d
, cu¼_h—d->
	`wh’
()));

162 
ev’tq
->
	`descheduË
(
cu¼_h—d
);

166 
	`DPRINTF
(
RubyCacheT¿û
, "Starting cache flush\n");

167 
	`’queueRubyEv’t
(
	`curTick
());

168 
	`simuÏ‹
();

169 
	`DPRINTF
(
RubyCacheT¿û
, "Cache flush complete\n");

172 !
ev’tq
->
	`em±y
()) {

173 
ev’tq
->
	`descheduË
Óv’tq->
	`g‘H—d
());

177 
	`£tCurTick
(
cu¹ick_Üigš®
);

182 !
Üigš®_ev’ts
.
	`em±y
()) {

183 
·œ
<
Ev’t
*, 
Tick
> 
ev’t
 = 
Üigš®_ev’ts
.
	`back
();

184 
ev’tq
->
	`scheduË
(
ev’t
.
fœ¡
,ƒv’t.
£cÚd
);

185 
Üigš®_ev’ts
.
	`pİ_back
();

189 
m_coŞdown_’abËd
 = 
çl£
;

199 
	`w¬n_Úû
("Ruby memory writeback isƒxperimental. Continuing simulation "

204 
	}
}

207 
	gRubySy¡em
::
	$wr™eCom´es£dT¿û
(
ušt8_t
 *
¿w_d©a
, 
¡ršg
 
f’ame
,

208 
ušt64_t
 
uncom´es£d_Œaû_size
)

211 
¡ršg
 
thefe
 = 
CheckpoštIn
::
	`dœ
(è+ "/" + 
f’ame
.
	`c_¡r
();

213 
fd
 = 
	`ü—t
(
thefe
.
	`c_¡r
(), 0664);

214 ià(
fd
 < 0) {

215 
	`³¼Ü
("creat");

216 
	`çl
("Cª'ˆİ’ memÜy¿û f'%s'\n", 
f’ame
);

219 
gzFe
 
com´es£dMemÜy
 = 
	`gzdİ’
(
fd
, "wb");

220 ià(
com´es£dMemÜy
 =ğ
NULL
)

221 
	`çl
("Insufficient memoryo‡llocate compression state for %s\n",

222 
f’ame
);

224 ià(
	`gzwr™e
(
com´es£dMemÜy
, 
¿w_d©a
, 
uncom´es£d_Œaû_size
) !=

225 
uncom´es£d_Œaû_size
) {

226 
	`çl
("Wr™çed oÀmemÜy¿û f'%s'\n", 
f’ame
);

229 ià(
	`gzşo£
(
com´es£dMemÜy
)) {

230 
	`çl
("Clo£ faed oÀmemÜy¿û f'%s'\n", 
f’ame
);

232 
d–‘e
[] 
¿w_d©a
;

233 
	}
}

236 
	gRubySy¡em
::
	$£rŸlize
(
CheckpoštOut
 &
ı
) const

241 
ušt64_t
 
block_size_by‹s
 = 
	`g‘BlockSizeBy‹s
();

242 
	`SERIALIZE_SCALAR
(
block_size_by‹s
);

247 ià(
m_ÿche_»cÜd”
 =ğ
NULL
) {

248 
	`çl
("Call memWriteback() before serialize()o create„ubyrace");

252 
ušt8_t
 *
¿w_d©a
 = 
Ãw
 uint8_t[4096];

253 
ušt64_t
 
ÿche_Œaû_size
 = 
m_ÿche_»cÜd”
->
	`agg»g©eRecÜds
(&
¿w_d©a
,

255 
¡ršg
 
ÿche_Œaû_fe
 = 
	`Çme
() + ".cache.gz";

256 
	`wr™eCom´es£dT¿û
(
¿w_d©a
, 
ÿche_Œaû_fe
, 
ÿche_Œaû_size
);

258 
	`SERIALIZE_SCALAR
(
ÿche_Œaû_fe
);

259 
	`SERIALIZE_SCALAR
(
ÿche_Œaû_size
);

260 
	}
}

263 
	gRubySy¡em
::
	$d¿šResume
()

267 ià(
m_ÿche_»cÜd”
) {

268 
d–‘e
 
m_ÿche_»cÜd”
;

269 
m_ÿche_»cÜd”
 = 
NULL
;

271 
	}
}

274 
	gRubySy¡em
::
	$»adCom´es£dT¿û
(
¡ršg
 
f’ame
, 
ušt8_t
 *&
¿w_d©a
,

275 
ušt64_t
 &
uncom´es£d_Œaû_size
)

278 
gzFe
 
com´es£dT¿û
;

281 
fd
 = 
	`İ’
(
f’ame
.
	`c_¡r
(), 
O_RDONLY
);

282 ià(
fd
 < 0) {

283 
	`³¼Ü
("open");

284 
	`çl
("UÇbËØİ’¿û f%s", 
f’ame
);

287 
com´es£dT¿û
 = 
	`gzdİ’
(
fd
, "rb");

288 ià(
com´es£dT¿û
 =ğ
NULL
) {

289 
	`çl
("Insufficient memoryo‡llocate compression state for %s\n",

290 
f’ame
);

293 
¿w_d©a
 = 
Ãw
 
ušt8_t
[
uncom´es£d_Œaû_size
];

294 ià(
	`gz»ad
(
com´es£dT¿û
, 
¿w_d©a
, 
uncom´es£d_Œaû_size
) <

295 
uncom´es£d_Œaû_size
) {

296 
	`çl
("UÇbËØ»ad com¶‘Œaû from f%s\n", 
f’ame
);

299 ià(
	`gzşo£
(
com´es£dT¿û
)) {

300 
	`çl
("FaedØşo£ cachŒaû f'%s'\n", 
f’ame
);

302 
	}
}

305 
	gRubySy¡em
::
	$un£rŸlize
(
CheckpoštIn
 &
ı
)

307 
ušt8_t
 *
uncom´es£d_Œaû
 = 
NULL
;

312 
ušt64_t
 
block_size_by‹s
 = 
	`g‘BlockSizeBy‹s
();

313 
	`UNSERIALIZE_OPT_SCALAR
(
block_size_by‹s
);

315 
¡ršg
 
ÿche_Œaû_fe
;

316 
ušt64_t
 
ÿche_Œaû_size
 = 0;

318 
	`UNSERIALIZE_SCALAR
(
ÿche_Œaû_fe
);

319 
	`UNSERIALIZE_SCALAR
(
ÿche_Œaû_size
);

320 
ÿche_Œaû_fe
 = 
ı
.
ıtDœ
 + "/" + cache_trace_file;

322 
	`»adCom´es£dT¿û
(
ÿche_Œaû_fe
, 
uncom´es£d_Œaû
,

323 
ÿche_Œaû_size
);

324 
m_w¬mup_’abËd
 = 
Œue
;

325 
m_sy¡ems_to_w¬mup
++;

328 
	`makeCacheRecÜd”
(
uncom´es£d_Œaû
, 
ÿche_Œaû_size
, 
block_size_by‹s
);

329 
	}
}

332 
	gRubySy¡em
::
	$¡¬tup
()

351 ià(
m_w¬mup_’abËd
) {

352 
	`DPRINTF
(
RubyCacheT¿û
, "Starting„uby cache warmup\n");

354 
Tick
 
cu¹ick_Üigš®
 = 
	`curTick
();

356 
Ev’t
* 
ev’tq_h—d
 = 
ev’tq
->
	`»¶aûH—d
(
NULL
);

358 
	`£tCurTick
(0);

359 
	`»£tClock
();

362 
	`’queueRubyEv’t
(
	`curTick
());

363 
	`simuÏ‹
();

365 
d–‘e
 
m_ÿche_»cÜd”
;

366 
m_ÿche_»cÜd”
 = 
NULL
;

367 
m_sy¡ems_to_w¬mup
--;

368 ià(
m_sy¡ems_to_w¬mup
 == 0) {

369 
m_w¬mup_’abËd
 = 
çl£
;

373 
ev’tq
->
	`»¶aûH—d
(
ev’tq_h—d
);

375 
	`£tCurTick
(
cu¹ick_Üigš®
);

376 
	`»£tClock
();

379 
	`»£tSts
();

380 
	}
}

383 
	gRubySy¡em
::
RubyEv’t
::
	$´oûss
()

385 ià(
RubySy¡em
::
	`g‘W¬mupEÇbËd
()) {

386 
m_ruby_sy¡em
->
m_ÿche_»cÜd”
->
	`’queueNextF‘chReque¡
();

387 } ià(
RubySy¡em
::
	`g‘CoŞdownEÇbËd
()) {

388 
m_ruby_sy¡em
->
m_ÿche_»cÜd”
->
	`’queueNextFlushReque¡
();

390 
	}
}

393 
	gRubySy¡em
::
	$»£tSts
()

395 
m_¡¬t_cyşe
 = 
	`curCyşe
();

396 
	}
}

398 
boŞ


399 
	gRubySy¡em
::
	$funùiÚ®R—d
(
Pack‘PŒ
 
pkt
)

401 
Addr
 
	`add»ss
(
pkt
->
	`g‘Addr
());

402 
Addr
 
lše_add»ss
 = 
	`makeLšeAdd»ss
(
add»ss
);

404 
AcûssP”missiÚ
 
acûss_³rm
 = 
AcûssP”missiÚ_NÙP»£Á
;

405 
num_cÚŒŞËrs
 = 
m_abs_úŒl_vec
.
	`size
();

407 
	`DPRINTF
(
RubySy¡em
, "FunùiÚ® R—d„eque¡ fÜ %#x\n", 
add»ss
);

409 
num_ro
 = 0;

410 
num_rw
 = 0;

411 
num_busy
 = 0;

412 
num_backšg_¡Üe
 = 0;

413 
num_šv®id
 = 0;

417 
i
 = 0; i < 
num_cÚŒŞËrs
; ++i) {

418 
acûss_³rm
 = 
m_abs_úŒl_vec
[
i
]-> 
	`g‘AcûssP”missiÚ
(
lše_add»ss
);

419 ià(
acûss_³rm
 =ğ
AcûssP”missiÚ_R—d_OÆy
)

420 
num_ro
++;

421 ià(
acûss_³rm
 =ğ
AcûssP”missiÚ_R—d_Wr™e
)

422 
num_rw
++;

423 ià(
acûss_³rm
 =ğ
AcûssP”missiÚ_Busy
)

424 
num_busy
++;

425 ià(
acûss_³rm
 =ğ
AcûssP”missiÚ_Backšg_StÜe
)

430 
num_backšg_¡Üe
++;

431 ià(
acûss_³rm
 =ğ
AcûssP”missiÚ_Inv®id
 ||

432 
acûss_³rm
 =ğ
AcûssP”missiÚ_NÙP»£Á
)

433 
num_šv®id
++;

435 
	`as£¹
(
num_rw
 <= 1);

445 ià(
num_šv®id
 =ğ(
num_cÚŒŞËrs
 - 1è&& 
num_backšg_¡Üe
 == 1) {

446 
	`DPRINTF
(
RubySy¡em
, "only copy in Backing_Store memory,„ead from it\n");

447 
i
 = 0; i < 
num_cÚŒŞËrs
; ++i) {

448 
acûss_³rm
 = 
m_abs_úŒl_vec
[
i
]->
	`g‘AcûssP”missiÚ
(
lše_add»ss
);

449 ià(
acûss_³rm
 =ğ
AcûssP”missiÚ_Backšg_StÜe
) {

450 
m_abs_úŒl_vec
[
i
]->
	`funùiÚ®R—d
(
lše_add»ss
, 
pkt
);

451  
Œue
;

454 } ià(
num_ro
 > 0 || 
num_rw
 == 1) {

459 
	`DPRINTF
(
RubySy¡em
, "num_busy = %d,‚um_ro = %d,‚um_rw = %d\n",

460 
num_busy
, 
num_ro
, 
num_rw
);

464 
i
 = 0;˜< 
num_cÚŒŞËrs
;++i) {

465 
acûss_³rm
 = 
m_abs_úŒl_vec
[
i
]->
	`g‘AcûssP”missiÚ
(
lše_add»ss
);

466 ià(
acûss_³rm
 =ğ
AcûssP”missiÚ_R—d_OÆy
 ||

467 
acûss_³rm
 =ğ
AcûssP”missiÚ_R—d_Wr™e
) {

468 
m_abs_úŒl_vec
[
i
]->
	`funùiÚ®R—d
(
lše_add»ss
, 
pkt
);

469  
Œue
;

474  
çl£
;

475 
	}
}

481 
boŞ


482 
	gRubySy¡em
::
	$funùiÚ®Wr™e
(
Pack‘PŒ
 
pkt
)

484 
Addr
 
	`addr
(
pkt
->
	`g‘Addr
());

485 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
addr
);

486 
AcûssP”missiÚ
 
acûss_³rm
 = 
AcûssP”missiÚ_NÙP»£Á
;

487 
num_cÚŒŞËrs
 = 
m_abs_úŒl_vec
.
	`size
();

489 
	`DPRINTF
(
RubySy¡em
, "FunùiÚ® Wr™»que¡ fÜ %#x\n", 
addr
);

491 
ušt32_t
 
M5_VAR_USED
 
num_funùiÚ®_wr™es
 = 0;

493 
i
 = 0; i < 
num_cÚŒŞËrs
;++i) {

494 
num_funùiÚ®_wr™es
 +=

495 
m_abs_úŒl_vec
[
i
]->
	`funùiÚ®Wr™eBufãrs
(
pkt
);

497 
acûss_³rm
 = 
m_abs_úŒl_vec
[
i
]->
	`g‘AcûssP”missiÚ
(
lše_addr
);

498 ià(
acûss_³rm
 !ğ
AcûssP”missiÚ_Inv®id
 &&

499 
acûss_³rm
 !ğ
AcûssP”missiÚ_NÙP»£Á
) {

500 
num_funùiÚ®_wr™es
 +=

501 
m_abs_úŒl_vec
[
i
]->
	`funùiÚ®Wr™e
(
lše_addr
, 
pkt
);

505 
num_funùiÚ®_wr™es
 +ğ
m_ÃtwÜk
->
	`funùiÚ®Wr™e
(
pkt
);

506 
	`DPRINTF
(
RubySy¡em
, "Mes§ge wr™‹Àğ%u\n", 
num_funùiÚ®_wr™es
);

508  
Œue
;

509 
	}
}

511 #ifdeà
CHECK_COHERENCE


521 
	gRubySy¡em
::
	$checkGlob®Coh”’ûInv¬ŸÁ
(cÚ¡ 
Add»ss
& 
addr
)

524 
NodeID
 
exşusive
 = -1;

525 
boŞ
 
sh¬edD‘eùed
 = 
çl£
;

526 
NodeID
 
Ï¡Sh¬ed
 = -1;

528 
i
 = 0; i < 
m_ch_veùÜ
.
	`size
(); i++) {

529 ià(
m_ch_veùÜ
[
i
]->
	`isBlockExşusive
(
addr
)) {

530 ià(
exşusive
 != -1) {

532 
	`WARN_EXPR
(
exşusive
);

533 
	`WARN_EXPR
(
m_ch_veùÜ
[
i
]->
	`g‘ID
());

534 
	`WARN_EXPR
(
addr
);

535 
	`WARN_EXPR
(
	`g‘Time
());

536 
	`ERROR_MSG
("Coherence Violation Detected -- 2ƒxclusive chips");

537 } ià(
sh¬edD‘eùed
) {

538 
	`WARN_EXPR
(
Ï¡Sh¬ed
);

539 
	`WARN_EXPR
(
m_ch_veùÜ
[
i
]->
	`g‘ID
());

540 
	`WARN_EXPR
(
addr
);

541 
	`WARN_EXPR
(
	`g‘Time
());

542 
	`ERROR_MSG
("Coherence Violation Detected --ƒxclusive chip with >=1 shared");

544 
exşusive
 = 
m_ch_veùÜ
[
i
]->
	`g‘ID
();

546 } ià(
m_ch_veùÜ
[
i
]->
	`isBlockSh¬ed
(
addr
)) {

547 
sh¬edD‘eùed
 = 
Œue
;

548 
Ï¡Sh¬ed
 = 
m_ch_veùÜ
[
i
]->
	`g‘ID
();

550 ià(
exşusive
 != -1) {

551 
	`WARN_EXPR
(
Ï¡Sh¬ed
);

552 
	`WARN_EXPR
(
exşusive
);

553 
	`WARN_EXPR
(
addr
);

554 
	`WARN_EXPR
(
	`g‘Time
());

555 
	`ERROR_MSG
("Coherence Violation Detected --ƒxclusive chip with >=1 shared");

560 
	}
}

563 
RubySy¡em
 *

564 
	gRubySy¡emP¬ams
::
	$ü—‹
()

566  
Ãw
 
	`RubySy¡em
(
this
);

567 
	}
}

	@ruby/system/RubySystem.hh

35 #iâdeà
__MEM_RUBY_SYSTEM_SYSTEM_HH__


36 
	#__MEM_RUBY_SYSTEM_SYSTEM_HH__


	)

38 
	~"ba£/ÿÎback.hh
"

39 
	~"ba£/ouut.hh
"

40 
	~"mem/·ck‘.hh
"

41 
	~"mem/ruby/´of”/Prof”.hh
"

42 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCÚŒŞËr.hh
"

43 
	~"mem/ruby/sy¡em/CacheRecÜd”.hh
"

44 
	~"·¿ms/RubySy¡em.hh
"

45 
	~"sim/şocked_objeù.hh
"

47 
şass
 
	gN‘wÜk
;

48 
şass
 
	gAb¡¿ùCÚŒŞËr
;

50 şas 
	cRubySy¡em
 : 
public
 
ClockedObjeù


52 
public
:

53 şas 
	cRubyEv’t
 : 
public
 
Ev’t


55 
public
:

56 
RubyEv’t
(
RubySy¡em
* 
_ruby_sy¡em
)

58 
m_ruby_sy¡em
 = 
_ruby_sy¡em
;

60 
	m´iv©e
:

61 
´oûss
();

63 
RubySy¡em
* 
	mm_ruby_sy¡em
;

66 
ä›nd
 
şass
 
	gRubyEv’t
;

68 
RubySy¡emP¬ams
 
	tP¬ams
;

69 
RubySy¡em
(cÚ¡ 
P¬ams
 *
p
);

70 ~
RubySy¡em
();

73 
	$g‘Rªdomiz©iÚ
(è{  
m_¿ndomiz©iÚ
; 
	}
}

74 
ušt32_t
 
	$g‘BlockSizeBy‹s
(è{  
m_block_size_by‹s
; 
	}
}

75 
ušt32_t
 
	$g‘BlockSizeB™s
(è{  
m_block_size_b™s
; 
	}
}

76 
ušt32_t
 
	$g‘MemÜySizeB™s
(è{  
m_memÜy_size_b™s
; 
	}
}

77 
boŞ
 
	$g‘W¬mupEÇbËd
(è{  
m_w¬mup_’abËd
; 
	}
}

78 
boŞ
 
	$g‘CoŞdownEÇbËd
(è{  
m_coŞdown_’abËd
; 
	}
}

80 
Sim¶eMemÜy
 *
	$g‘PhysMem
(è{  
m_phys_mem
; 
	}
}

81 
Cyşes
 
	$g‘S¹Cyşe
(è{  
m_¡¬t_cyşe
; 
	}
}

82 
boŞ
 
	$g‘AcûssBackšgStÜe
(è{  
m_acûss_backšg_¡Üe
; 
	}
}

85 
Prof”
*

86 
	$g‘Prof”
()

88 
	`as£¹
(
m_´of”
 !ğ
NULL
);

89  
m_´of”
;

90 
	}
}

92 
	$»gSts
(è
ov”ride
 {

93 
ClockedObjeù
::
	`»gSts
();

94 
m_´of”
->
	`»gSts
(
	`Çme
());

95 
	}
}

96 
	$cŞÏ‹Sts
(è{ 
m_´of”
->
	`cŞÏ‹Sts
(); 
	}
}

97 
	$»£tSts
(è
ov”ride
;

99 
	$memWr™eback
(è
ov”ride
;

100 
	$£rŸlize
(
CheckpoštOut
 &
ı
ècÚ¡ 
ov”ride
;

101 
	$un£rŸlize
(
CheckpoštIn
 &
ı
è
ov”ride
;

102 
	$d¿šResume
(è
ov”ride
;

103 
	`´oûss
();

104 
	$¡¬tup
(è
ov”ride
;

105 
boŞ
 
	`funùiÚ®R—d
(
Pack‘
 *
±r
);

106 
boŞ
 
	`funùiÚ®Wr™e
(
Pack‘
 *
±r
);

108 
	`»gi¡”N‘wÜk
(
N‘wÜk
*);

109 
	`»gi¡”Ab¡¿ùCÚŒŞËr
(
Ab¡¿ùCÚŒŞËr
*);

111 
boŞ
 
	$ev’tQueueEm±y
(è{  
ev’tq
->
	`em±y
(); 
	}
}

112 
	$’queueRubyEv’t
(
Tick
 
tick
)

114 
RubyEv’t
* 
e
 = 
Ãw
 
	`RubyEv’t
(
this
);

115 
	`scheduË
(
e
, 
tick
);

116 
	}
}

118 
	g´iv©e
:

120 
RubySy¡em
(cÚ¡ RubySy¡em& 
obj
);

121 
	gRubySy¡em
& 
	gİ”©Ü
=(cÚ¡ 
RubySy¡em
& 
obj
);

123 
makeCacheRecÜd”
(
ušt8_t
 *
uncom´es£d_Œaû
,

124 
ušt64_t
 
ÿche_Œaû_size
,

125 
ušt64_t
 
block_size_by‹s
);

127 
»adCom´es£dT¿û
(
¡d
::
¡ršg
 
f’ame
,

128 
ušt8_t
 *&
¿w_d©a
,

129 
ušt64_t
 &
uncom´es£d_Œaû_size
);

130 
wr™eCom´es£dT¿û
(
ušt8_t
 *
¿w_d©a
, 
¡d
::
¡ršg
 
fe
,

131 
ušt64_t
 
uncom´es£d_Œaû_size
);

133 
	g´iv©e
:

135 
boŞ
 
m_¿ndomiz©iÚ
;

136 
ušt32_t
 
	gm_block_size_by‹s
;

137 
ušt32_t
 
	gm_block_size_b™s
;

138 
ušt32_t
 
	gm_memÜy_size_b™s
;

140 
boŞ
 
	gm_w¬mup_’abËd
;

141 
	gm_sy¡ems_to_w¬mup
;

142 
boŞ
 
	gm_coŞdown_’abËd
;

143 
Sim¶eMemÜy
 *
	gm_phys_mem
;

144 cÚ¡ 
boŞ
 
	gm_acûss_backšg_¡Üe
;

146 
N‘wÜk
* 
	gm_ÃtwÜk
;

147 
	g¡d
::
veùÜ
<
Ab¡¿ùCÚŒŞËr
 *> 
m_abs_úŒl_vec
;

148 
Cyşes
 
	gm_¡¬t_cyşe
;

150 
	gpublic
:

151 
Prof”
* 
m_´of”
;

152 
CacheRecÜd”
* 
	gm_ÿche_»cÜd”
;

153 
	g¡d
::
veùÜ
<
¡d
::
m­
<
ušt32_t
, 
	gAb¡¿ùCÚŒŞËr
 *> > 
	gm_ab¡¿ù_cÚŒŞs
;

156 şas 
	cRubyStsC®lback
 : 
public
 
C®lback


158 
´iv©e
:

159 
RubySy¡em
 *
m_ruby_sy¡em
;

161 
	mpublic
:

162 
vœtu®
 ~
	$RubyStsC®lback
() {}

163 
	$RubyStsC®lback
(
RubySy¡em
 *
sy¡em
è: 
	$m_ruby_sy¡em
(
sy¡em
è{
	}
}

164 
	$´oûss
(è{ 
m_ruby_sy¡em
->
	`cŞÏ‹Sts
(); 
	}
}

	@ruby/system/Sequencer.cc

29 
	~"¬ch/x86/ld¡æags.hh
"

30 
	~"ba£/misc.hh
"

31 
	~"ba£/¡r.hh
"

32 
	~"ıu/‹¡”s/ruby‹¡/RubyTe¡”.hh
"

33 
	~"debug/MemÜyAcûss.hh
"

34 
	~"debug/PrÙocŞT¿û.hh
"

35 
	~"debug/RubySequ’ûr.hh
"

36 
	~"debug/RubySts.hh
"

37 
	~"mem/´ÙocŞ/P»ãtchB™.hh
"

38 
	~"mem/´ÙocŞ/RubyAcûssMode.hh
"

39 
	~"mem/ruby/´of”/Prof”.hh
"

40 
	~"mem/ruby/¦icc_š‹rçû/RubyReque¡.hh
"

41 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

42 
	~"mem/ruby/sy¡em/Sequ’ûr.hh
"

43 
	~"mem/·ck‘.hh
"

44 
	~"sim/sy¡em.hh
"

46 
usšg
 
Çme¥aû
 
	g¡d
;

48 
Sequ’ûr
 *

49 
	gRubySequ’ûrP¬ams
::
	$ü—‹
()

51  
Ãw
 
	`Sequ’ûr
(
this
);

52 
	}
}

54 
	gSequ’ûr
::
	$Sequ’ûr
(cÚ¡ 
P¬ams
 *
p
)

55 : 
	`RubyPÜt
(
p
), 
	`m_Incom¶‘eTimes
(
MachšeTy³_NUM
), 
	$d—dlockCheckEv’t
(
this
)

57 
m_out¡ªdšg_couÁ
 = 0;

59 
m_š¡Cache_±r
 = 
p
->
iÿche
;

60 
m_d©aCache_±r
 = 
p
->
dÿche
;

61 
m_d©a_ÿche_h™_Ï‹ncy
 = 
p
->
dÿche_h™_Ï‹ncy
;

62 
m_š¡_ÿche_h™_Ï‹ncy
 = 
p
->
iÿche_h™_Ï‹ncy
;

63 
m_max_out¡ªdšg_»que¡s
 = 
p
->
max_out¡ªdšg_»que¡s
;

64 
m_d—dlock_th»shŞd
 = 
p
->
d—dlock_th»shŞd
;

66 
m_cÜeId
 = 
p
->
cÜeid
;

67 
	`as£¹
(
m_max_out¡ªdšg_»que¡s
 > 0);

68 
	`as£¹
(
m_d—dlock_th»shŞd
 > 0);

69 
	`as£¹
(
m_š¡Cache_±r
 !ğ
NULL
);

70 
	`as£¹
(
m_d©aCache_±r
 !ğ
NULL
);

71 
	`as£¹
(
m_d©a_ÿche_h™_Ï‹ncy
 > 0);

72 
	`as£¹
(
m_š¡_ÿche_h™_Ï‹ncy
 > 0);

74 
m_ruÂšgG¬ÃtSnd®Úe
 = 
p
->
g¬Ãt_¡ªd®Úe
;

75 
	}
}

77 
	gSequ’ûr
::~
	$Sequ’ûr
()

79 
	}
}

82 
Sequ’ûr
::
	$wakeup
()

84 
	`as£¹
(
	`d¿šS‹
(è!ğ
D¿šS‹
::
D¿ššg
);

87 
Cyşes
 
cu¼’t_time
 = 
	`curCyşe
();

90 
tÙ®_out¡ªdšg
 = 0;

92 
Reque¡TabË
::
™”©Ü
 
»ad
 = 
m_»adReque¡TabË
.
	`begš
();

93 
Reque¡TabË
::
™”©Ü
 
»ad_’d
 = 
m_»adReque¡TabË
.
	`’d
();

94 ; 
»ad
 !ğ
»ad_’d
; ++read) {

95 
Sequ’ûrReque¡
* 
»que¡
 = 
»ad
->
£cÚd
;

96 ià(
cu¼’t_time
 - 
»que¡
->
issue_time
 < 
m_d—dlock_th»shŞd
)

99 
	`·nic
("Possible Deadlock detected. Aborting!\n"

101 "cu¼’ˆtime: %u issue_time: %d difã»nû: %d\n", 
m_v”siÚ
,

102 
»que¡
->
pkt
->
	`g‘Addr
(), 
m_»adReque¡TabË
.
	`size
(),

103 
cu¼’t_time
 * 
	`şockP”iod
(), 
»que¡
->
issue_time
 * clockPeriod(),

104 (
cu¼’t_time
 * 
	`şockP”iod
()è- (
»que¡
->
issue_time
 * clockPeriod()));

107 
Reque¡TabË
::
™”©Ü
 
wr™e
 = 
m_wr™eReque¡TabË
.
	`begš
();

108 
Reque¡TabË
::
™”©Ü
 
wr™e_’d
 = 
m_wr™eReque¡TabË
.
	`’d
();

109 ; 
wr™e
 !ğ
wr™e_’d
; ++write) {

110 
Sequ’ûrReque¡
* 
»que¡
 = 
wr™e
->
£cÚd
;

111 ià(
cu¼’t_time
 - 
»que¡
->
issue_time
 < 
m_d—dlock_th»shŞd
)

114 
	`·nic
("Possible Deadlock detected. Aborting!\n"

116 "cu¼’ˆtime: %u issue_time: %d difã»nû: %d\n", 
m_v”siÚ
,

117 
»que¡
->
pkt
->
	`g‘Addr
(), 
m_wr™eReque¡TabË
.
	`size
(),

118 
cu¼’t_time
 * 
	`şockP”iod
(), 
»que¡
->
issue_time
 * clockPeriod(),

119 (
cu¼’t_time
 * 
	`şockP”iod
()è- (
»que¡
->
issue_time
 * clockPeriod()));

122 
tÙ®_out¡ªdšg
 +ğ
m_wr™eReque¡TabË
.
	`size
();

123 
tÙ®_out¡ªdšg
 +ğ
m_»adReque¡TabË
.
	`size
();

125 
	`as£¹
(
m_out¡ªdšg_couÁ
 =ğ
tÙ®_out¡ªdšg
);

127 ià(
m_out¡ªdšg_couÁ
 > 0) {

129 
	`scheduË
(
d—dlockCheckEv’t
, 
	`şockEdge
(
m_d—dlock_th»shŞd
));

131 
	}
}

133 
	gSequ’ûr
::
	$»£tSts
()

135 
m_Ï‹ncyHi¡
.
	`»£t
();

136 
m_h™L©’cyHi¡
.
	`»£t
();

137 
m_missL©’cyHi¡
.
	`»£t
();

138 
i
 = 0; i < 
RubyReque¡Ty³_NUM
; i++) {

139 
m_ty³L©’cyHi¡
[
i
]->
	`»£t
();

140 
m_h™Ty³L©’cyHi¡
[
i
]->
	`»£t
();

141 
m_missTy³L©’cyHi¡
[
i
]->
	`»£t
();

142 
j
 = 0; j < 
MachšeTy³_NUM
; j++) {

143 
m_h™Ty³MachL©’cyHi¡
[
i
][
j
]->
	`»£t
();

144 
m_missTy³MachL©’cyHi¡
[
i
][
j
]->
	`»£t
();

148 
i
 = 0; i < 
MachšeTy³_NUM
; i++) {

149 
m_missMachL©’cyHi¡
[
i
]->
	`»£t
();

150 
m_h™MachL©’cyHi¡
[
i
]->
	`»£t
();

152 
m_IssueToIn™ŸlD–ayHi¡
[
i
]->
	`»£t
();

153 
m_In™ŸlToFÜw¬dD–ayHi¡
[
i
]->
	`»£t
();

154 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
[
i
]->
	`»£t
();

155 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
[
i
]->
	`»£t
();

157 
m_Incom¶‘eTimes
[
i
] = 0;

159 
	}
}

163 
Reque¡Stus


164 
	gSequ’ûr
::
	$š£¹Reque¡
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
»que¡_ty³
)

166 
	`as£¹
(
m_out¡ªdšg_couÁ
 ==

167 (
m_wr™eReque¡TabË
.
	`size
(è+ 
m_»adReque¡TabË
.size()));

170 ià(!
d—dlockCheckEv’t
.
	`scheduËd
() &&

171 
	`d¿šS‹
(è!ğ
D¿šS‹
::
D¿ššg
) {

172 
	`scheduË
(
d—dlockCheckEv’t
, 
	`şockEdge
(
m_d—dlock_th»shŞd
));

175 
Addr
 
lše_addr
 = 
	`makeLšeAdd»ss
(
pkt
->
	`g‘Addr
());

178 ià(
m_cÚŒŞËr
->
	`isBlocked
(
lše_addr
) &&

179 (
»que¡_ty³
 !ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
)) {

183  
Reque¡Stus_AlŸ£d
;

188 
Reque¡TabË
::
v®ue_ty³
 
	`deçuÉ_’Œy
(
lše_addr
,

189 (
Sequ’ûrReque¡
*è
NULL
);

191 ià((
»que¡_ty³
 =ğ
RubyReque¡Ty³_ST
) ||

192 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_RMW_R—d
) ||

193 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_RMW_Wr™e
) ||

194 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
) ||

195 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_StÜe_CÚd™iÚ®
) ||

196 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) ||

197 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
) ||

198 (
»que¡_ty³
 =ğ
RubyReque¡Ty³_FLUSH
)) {

202 ià(
m_»adReque¡TabË
.
	`couÁ
(
lše_addr
) > 0) {

203 
m_¡Üe_wa™šg_Ú_lßd
++;

204  
Reque¡Stus_AlŸ£d
;

207 
·œ
<
Reque¡TabË
::
™”©Ü
, 
boŞ
> 
r
 =

208 
m_wr™eReque¡TabË
.
	`š£¹
(
deçuÉ_’Œy
);

209 ià(
r
.
£cÚd
) {

210 
Reque¡TabË
::
™”©Ü
 
i
 = 
r
.
fœ¡
;

211 
i
->
£cÚd
 = 
Ãw
 
	`Sequ’ûrReque¡
(
pkt
, 
»que¡_ty³
, 
	`curCyşe
());

212 
m_out¡ªdšg_couÁ
++;

215 
m_¡Üe_wa™šg_Ú_¡Üe
++;

216  
Reque¡Stus_AlŸ£d
;

221 ià(
m_wr™eReque¡TabË
.
	`couÁ
(
lše_addr
) > 0) {

222 
m_lßd_wa™šg_Ú_¡Üe
++;

223  
Reque¡Stus_AlŸ£d
;

226 
·œ
<
Reque¡TabË
::
™”©Ü
, 
boŞ
> 
r
 =

227 
m_»adReque¡TabË
.
	`š£¹
(
deçuÉ_’Œy
);

229 ià(
r
.
£cÚd
) {

230 
Reque¡TabË
::
™”©Ü
 
i
 = 
r
.
fœ¡
;

231 
i
->
£cÚd
 = 
Ãw
 
	`Sequ’ûrReque¡
(
pkt
, 
»que¡_ty³
, 
	`curCyşe
());

232 
m_out¡ªdšg_couÁ
++;

235 
m_lßd_wa™šg_Ú_lßd
++;

236  
Reque¡Stus_AlŸ£d
;

240 
m_out¡ªdReqHi¡
.
	`§m¶e
(
m_out¡ªdšg_couÁ
);

241 
	`as£¹
(
m_out¡ªdšg_couÁ
 ==

242 (
m_wr™eReque¡TabË
.
	`size
(è+ 
m_»adReque¡TabË
.size()));

244  
Reque¡Stus_R—dy
;

245 
	}
}

248 
	gSequ’ûr
::
	$m¬kRemoved
()

250 
m_out¡ªdšg_couÁ
--;

251 
	`as£¹
(
m_out¡ªdšg_couÁ
 ==

252 
m_wr™eReque¡TabË
.
	`size
(è+ 
m_»adReque¡TabË
.size());

253 
	}
}

256 
	gSequ’ûr
::
	$šv®id©eSC
(
Addr
 
add»ss
)

258 
Ab¡¿ùCacheEÁry
 *
e
 = 
m_d©aCache_±r
->
	`lookup
(
add»ss
);

261 ià(
e
 &&ƒ->
	`isLocked
(
m_v”siÚ
)) {

262 
e
->
	`ş—rLocked
();

264 
	}
}

266 
boŞ


267 
	gSequ’ûr
::
	$hªdËLlsc
(
Addr
 
add»ss
, 
Sequ’ûrReque¡
* 
»que¡
)

269 
Ab¡¿ùCacheEÁry
 *
e
 = 
m_d©aCache_±r
->
	`lookup
(
add»ss
);

270 ià(!
e
)

271  
Œue
;

276 
boŞ
 
sucûss
 = 
Œue
;

277 ià(
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_StÜe_CÚd™iÚ®
) {

278 ià(!
e
->
	`isLocked
(
m_v”siÚ
)) {

283 
»que¡
->
pkt
->
»q
->
	`£tExŒaD©a
(0);

284 
sucûss
 = 
çl£
;

290 
»que¡
->
pkt
->
»q
->
	`£tExŒaD©a
(1);

295 
e
->
	`ş—rLocked
();

296 } ià(
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
) {

301 
e
->
	`£tLocked
(
m_v”siÚ
);

302 } ià(
e
->
	`isLocked
(
m_v”siÚ
)) {

306 
e
->
	`ş—rLocked
();

308  
sucûss
;

309 
	}
}

312 
	gSequ’ûr
::
	$»cÜdMissL©’cy
(cÚ¡ 
Cyşes
 
cyşes
, cÚ¡ 
RubyReque¡Ty³
 
ty³
,

313 cÚ¡ 
MachšeTy³
 
»¥ÚdšgMach
,

314 
boŞ
 
isEx‹º®H™
, 
Cyşes
 
issuedTime
,

315 
Cyşes
 
š™ŸlReque¡Time
,

316 
Cyşes
 
fÜw¬dReque¡Time
,

317 
Cyşes
 
fœ¡Re¥Ú£Time
, Cyşe 
com¶‘iÚTime
)

319 
m_Ï‹ncyHi¡
.
	`§m¶e
(
cyşes
);

320 
m_ty³L©’cyHi¡
[
ty³
]->
	`§m¶e
(
cyşes
);

322 ià(
isEx‹º®H™
) {

323 
m_missL©’cyHi¡
.
	`§m¶e
(
cyşes
);

324 
m_missTy³L©’cyHi¡
[
ty³
]->
	`§m¶e
(
cyşes
);

326 ià(
»¥ÚdšgMach
 !ğ
MachšeTy³_NUM
) {

327 
m_missMachL©’cyHi¡
[
»¥ÚdšgMach
]->
	`§m¶e
(
cyşes
);

328 
m_missTy³MachL©’cyHi¡
[
ty³
][
»¥ÚdšgMach
]->
	`§m¶e
(
cyşes
);

330 ià((
issuedTime
 <ğ
š™ŸlReque¡Time
) &&

331 (
š™ŸlReque¡Time
 <ğ
fÜw¬dReque¡Time
) &&

332 (
fÜw¬dReque¡Time
 <ğ
fœ¡Re¥Ú£Time
) &&

333 (
fœ¡Re¥Ú£Time
 <ğ
com¶‘iÚTime
)) {

335 
m_IssueToIn™ŸlD–ayHi¡
[
»¥ÚdšgMach
]->
	`§m¶e
(

336 
š™ŸlReque¡Time
 - 
issuedTime
);

337 
m_In™ŸlToFÜw¬dD–ayHi¡
[
»¥ÚdšgMach
]->
	`§m¶e
(

338 
fÜw¬dReque¡Time
 - 
š™ŸlReque¡Time
);

339 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
[
»¥ÚdšgMach
]->
	`§m¶e
(

340 
fœ¡Re¥Ú£Time
 - 
fÜw¬dReque¡Time
);

341 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
[
»¥ÚdšgMach
]->
	`§m¶e
(

342 
com¶‘iÚTime
 - 
fœ¡Re¥Ú£Time
);

344 
m_Incom¶‘eTimes
[
»¥ÚdšgMach
]++;

348 
m_h™L©’cyHi¡
.
	`§m¶e
(
cyşes
);

349 
m_h™Ty³L©’cyHi¡
[
ty³
]->
	`§m¶e
(
cyşes
);

351 ià(
»¥ÚdšgMach
 !ğ
MachšeTy³_NUM
) {

352 
m_h™MachL©’cyHi¡
[
»¥ÚdšgMach
]->
	`§m¶e
(
cyşes
);

353 
m_h™Ty³MachL©’cyHi¡
[
ty³
][
»¥ÚdšgMach
]->
	`§m¶e
(
cyşes
);

356 
	}
}

359 
	gSequ’ûr
::
	$wr™eC®lback
(
Addr
 
add»ss
, 
D©aBlock
& 
d©a
,

360 cÚ¡ 
boŞ
 
ex‹º®H™
, cÚ¡ 
MachšeTy³
 
mach
,

361 cÚ¡ 
Cyşes
 
š™ŸlReque¡Time
,

362 cÚ¡ 
Cyşes
 
fÜw¬dReque¡Time
,

363 cÚ¡ 
Cyşes
 
fœ¡Re¥Ú£Time
)

365 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

366 
	`as£¹
(
m_wr™eReque¡TabË
.
	`couÁ
(
	`makeLšeAdd»ss
(
add»ss
)));

368 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_wr™eReque¡TabË
.
	`fšd
(
add»ss
);

369 
	`as£¹
(
i
 !ğ
m_wr™eReque¡TabË
.
	`’d
());

370 
Sequ’ûrReque¡
* 
»que¡
 = 
i
->
£cÚd
;

372 
m_wr™eReque¡TabË
.
	`”a£
(
i
);

373 
	`m¬kRemoved
();

375 
	`as£¹
((
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ST
) ||

376 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_ATOMIC
) ||

377 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_RMW_R—d
) ||

378 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_RMW_Wr™e
) ||

379 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
) ||

380 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_StÜe_CÚd™iÚ®
) ||

381 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) ||

382 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
) ||

383 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_FLUSH
));

391 
boŞ
 
sucûss
 = 
Œue
;

392 ià(!
m_ruÂšgG¬ÃtSnd®Úe
)

393 
sucûss
 = 
	`hªdËLlsc
(
add»ss
, 
»que¡
);

398 ià(
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) {

404 
m_cÚŒŞËr
->
	`blockOnQueue
(
add»ss
, 
m_mªd©Üy_q_±r
);

405 } ià(
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_Wr™e
) {

406 
m_cÚŒŞËr
->
	`unblock
(
add»ss
);

409 
	`h™C®lback
(
»que¡
, 
d©a
, 
sucûss
, 
mach
, 
ex‹º®H™
,

410 
š™ŸlReque¡Time
, 
fÜw¬dReque¡Time
, 
fœ¡Re¥Ú£Time
);

411 
	}
}

414 
	gSequ’ûr
::
	$»adC®lback
(
Addr
 
add»ss
, 
D©aBlock
& 
d©a
,

415 
boŞ
 
ex‹º®H™
, cÚ¡ 
MachšeTy³
 
mach
,

416 
Cyşes
 
š™ŸlReque¡Time
,

417 
Cyşes
 
fÜw¬dReque¡Time
,

418 
Cyşes
 
fœ¡Re¥Ú£Time
)

420 
	`as£¹
(
add»ss
 =ğ
	`makeLšeAdd»ss
(address));

421 
	`as£¹
(
m_»adReque¡TabË
.
	`couÁ
(
	`makeLšeAdd»ss
(
add»ss
)));

423 
Reque¡TabË
::
™”©Ü
 
i
 = 
m_»adReque¡TabË
.
	`fšd
(
add»ss
);

424 
	`as£¹
(
i
 !ğ
m_»adReque¡TabË
.
	`’d
());

425 
Sequ’ûrReque¡
* 
»que¡
 = 
i
->
£cÚd
;

427 
m_»adReque¡TabË
.
	`”a£
(
i
);

428 
	`m¬kRemoved
();

430 
	`as£¹
((
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_LD
) ||

431 (
»que¡
->
m_ty³
 =ğ
RubyReque¡Ty³_IFETCH
));

433 
	`h™C®lback
(
»que¡
, 
d©a
, 
Œue
, 
mach
, 
ex‹º®H™
,

434 
š™ŸlReque¡Time
, 
fÜw¬dReque¡Time
, 
fœ¡Re¥Ú£Time
);

435 
	}
}

438 
	gSequ’ûr
::
	$h™C®lback
(
Sequ’ûrReque¡
* 
¤eque¡
, 
D©aBlock
& 
d©a
,

439 
boŞ
 
ÎscSucûss
,

440 cÚ¡ 
MachšeTy³
 
mach
, cÚ¡ 
boŞ
 
ex‹º®H™
,

441 cÚ¡ 
Cyşes
 
š™ŸlReque¡Time
,

442 cÚ¡ 
Cyşes
 
fÜw¬dReque¡Time
,

443 cÚ¡ 
Cyşes
 
fœ¡Re¥Ú£Time
)

445 
	`w¬n_Úû
("Replacement…olicy updates„ecently becamehe„esponsibility "

449 
Pack‘PŒ
 
pkt
 = 
¤eque¡
->pkt;

450 
Addr
 
	`»que¡_add»ss
(
pkt
->
	`g‘Addr
());

451 
RubyReque¡Ty³
 
ty³
 = 
¤eque¡
->
m_ty³
;

452 
Cyşes
 
issued_time
 = 
¤eque¡
->
issue_time
;

454 
	`as£¹
(
	`curCyşe
(è>ğ
issued_time
);

455 
Cyşes
 
tÙ®_Ï‹ncy
 = 
	`curCyşe
(è- 
issued_time
;

458 
	`»cÜdMissL©’cy
(
tÙ®_Ï‹ncy
, 
ty³
, 
mach
, 
ex‹º®H™
, 
issued_time
,

459 
š™ŸlReque¡Time
, 
fÜw¬dReque¡Time
,

460 
fœ¡Re¥Ú£Time
, 
	`curCyşe
());

462 
	`DPRINTFR
(
PrÙocŞT¿û
, "%15s %3s %10s%20s %6s>%-6s %#x %d cycles\n",

463 
	`curTick
(), 
m_v”siÚ
, "Seq",

464 
ÎscSucûss
 ? "Done" : "SC_Failed", "", "",

465 
	`´štAdd»ss
(
»que¡_add»ss
), 
tÙ®_Ï‹ncy
);

468 ià(
RubySy¡em
::
	`g‘W¬mupEÇbËd
()) {

469 
d©a
.
	`£tD©a
(
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(),

470 
	`g‘Off£t
(
»que¡_add»ss
), 
pkt
->
	`g‘Size
());

471 } ià(!
pkt
->
	`isFlush
()) {

472 ià((
ty³
 =ğ
RubyReque¡Ty³_LD
) ||

473 (
ty³
 =ğ
RubyReque¡Ty³_IFETCH
) ||

474 (
ty³
 =ğ
RubyReque¡Ty³_RMW_R—d
) ||

475 (
ty³
 =ğ
RubyReque¡Ty³_Locked_RMW_R—d
) ||

476 (
ty³
 =ğ
RubyReque¡Ty³_Lßd_Lšked
)) {

477 
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(),

478 
d©a
.
	`g‘D©a
(
	`g‘Off£t
(
»que¡_add»ss
), 
pkt
->
	`g‘Size
()),

479 
pkt
->
	`g‘Size
());

480 
	`DPRINTF
(
RubySequ’ûr
, "»ad d©¨%s\n", 
d©a
);

481 } ià(
pkt
->
»q
->
	`isSw­
()) {

482 
¡d
::
veùÜ
<
ušt8_t
> 
	`ov”wr™e_v®
(
pkt
->
	`g‘Size
());

483 
	`memıy
(&
ov”wr™e_v®
[0], 
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(),

484 
pkt
->
	`g‘Size
());

485 
	`memıy
(
pkt
->
g‘PŒ
<
ušt8_t
>(),

486 
d©a
.
	`g‘D©a
(
	`g‘Off£t
(
»que¡_add»ss
), 
pkt
->
	`g‘Size
()),

487 
pkt
->
	`g‘Size
());

488 
d©a
.
	`£tD©a
(&
ov”wr™e_v®
[0],

489 
	`g‘Off£t
(
»que¡_add»ss
), 
pkt
->
	`g‘Size
());

490 
	`DPRINTF
(
RubySequ’ûr
, "sw­ d©¨%s\n", 
d©a
);

492 
d©a
.
	`£tD©a
(
pkt
->
g‘CÚ¡PŒ
<
ušt8_t
>(),

493 
	`g‘Off£t
(
»que¡_add»ss
), 
pkt
->
	`g‘Size
());

494 
	`DPRINTF
(
RubySequ’ûr
, "£ˆd©¨%s\n", 
d©a
);

501 ià(
m_usšgRubyTe¡”
) {

502 
	`DPRINTF
(
RubySequ’ûr
, "hitCallback %s 0x%x using RubyTester\n",

503 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

504 
RubyTe¡”
::
S’d”S‹
* 
‹¡”S’d”S‹
 =

505 
pkt
->
fšdNextS’d”S‹
<
RubyTe¡”
::
S’d”S‹
>();

506 
	`as£¹
(
‹¡”S’d”S‹
);

507 
‹¡”S’d”S‹
->
subBlock
.
	`m”geFrom
(
d©a
);

510 
d–‘e
 
¤eque¡
;

512 
RubySy¡em
 *
rs
 = 
m_ruby_sy¡em
;

513 ià(
RubySy¡em
::
	`g‘W¬mupEÇbËd
()) {

514 
	`as£¹
(
pkt
->
»q
);

515 
d–‘e
 
pkt
->
»q
;

516 
d–‘e
 
pkt
;

517 
rs
->
m_ÿche_»cÜd”
->
	`’queueNextF‘chReque¡
();

518 } ià(
RubySy¡em
::
	`g‘CoŞdownEÇbËd
()) {

519 
d–‘e
 
pkt
;

520 
rs
->
m_ÿche_»cÜd”
->
	`’queueNextFlushReque¡
();

522 
	`ruby_h™_ÿÎback
(
pkt
);

523 
	`‹¡D¿šCom¶‘e
();

525 
	}
}

527 
boŞ


528 
	gSequ’ûr
::
	$em±y
() const

530  
m_wr™eReque¡TabË
.
	`em±y
(è&& 
m_»adReque¡TabË
.empty();

531 
	}
}

533 
Reque¡Stus


534 
	gSequ’ûr
::
	$makeReque¡
(
Pack‘PŒ
 
pkt
)

536 ià(
m_out¡ªdšg_couÁ
 >ğ
m_max_out¡ªdšg_»que¡s
) {

537  
Reque¡Stus_BufãrFuÎ
;

540 
RubyReque¡Ty³
 
´im¬y_ty³
 = 
RubyReque¡Ty³_NULL
;

541 
RubyReque¡Ty³
 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_NULL
;

543 ià(
pkt
->
	`isLLSC
()) {

552 ià(
pkt
->
	`isWr™e
()) {

553 
	`DPRINTF
(
RubySequ’ûr
, "Issuing SC\n");

554 
´im¬y_ty³
 = 
RubyReque¡Ty³_StÜe_CÚd™iÚ®
;

556 
	`DPRINTF
(
RubySequ’ûr
, "Issuing LL\n");

557 
	`as£¹
(
pkt
->
	`isR—d
());

558 
´im¬y_ty³
 = 
RubyReque¡Ty³_Lßd_Lšked
;

560 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ATOMIC
;

561 } ià(
pkt
->
»q
->
	`isLockedRMW
()) {

568 ià(
pkt
->
	`isWr™e
()) {

569 
	`DPRINTF
(
RubySequ’ûr
, "Issuing Locked RMW Write\n");

570 
´im¬y_ty³
 = 
RubyReque¡Ty³_Locked_RMW_Wr™e
;

572 
	`DPRINTF
(
RubySequ’ûr
, "Issuing Locked RMW Read\n");

573 
	`as£¹
(
pkt
->
	`isR—d
());

574 
´im¬y_ty³
 = 
RubyReque¡Ty³_Locked_RMW_R—d
;

576 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ST
;

583 ià(
pkt
->
	`isWr™e
()) {

587 
´im¬y_ty³
 = 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ST
;

588 } ià(
pkt
->
	`isR—d
()) {

589 ià(
pkt
->
»q
->
	`isIn¡F‘ch
()) {

590 
´im¬y_ty³
 = 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_IFETCH
;

592 
boŞ
 
¡ÜeCheck
 = 
çl£
;

594 ià(
sy¡em
->
	`g‘Arch
(è=ğ
Arch
::
X86ISA
) {

595 
ušt32_t
 
æags
 = 
pkt
->
»q
->
	`g‘FÏgs
();

596 
¡ÜeCheck
 = 
æags
 &

597 (
X86ISA
::
StÜeCheck
 << X86ISA::
FÏgShiá
);

599 ià(
¡ÜeCheck
) {

600 
´im¬y_ty³
 = 
RubyReque¡Ty³_RMW_R—d
;

601 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_ST
;

603 
´im¬y_ty³
 = 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_LD
;

606 } ià(
pkt
->
	`isFlush
()) {

607 
´im¬y_ty³
 = 
£cÚd¬y_ty³
 = 
RubyReque¡Ty³_FLUSH
;

609 
	`·nic
("Unsupported„uby…acketype\n");

613 
Reque¡Stus
 
¡©us
 = 
	`š£¹Reque¡
(
pkt
, 
´im¬y_ty³
);

614 ià(
¡©us
 !ğ
Reque¡Stus_R—dy
)

615  
¡©us
;

617 
	`issueReque¡
(
pkt
, 
£cÚd¬y_ty³
);

620  
Reque¡Stus_Issued
;

621 
	}
}

624 
	gSequ’ûr
::
	$issueReque¡
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
£cÚd¬y_ty³
)

626 
	`as£¹
(
pkt
 !ğ
NULL
);

627 
CÚ‹xtID
 
´oc_id
 = 
pkt
->
»q
->
	`hasCÚ‹xtId
() ?

628 
pkt
->
»q
->
	`cÚ‹xtId
(è: 
Inv®idCÚ‹xtID
;

630 
CÚ‹xtID
 
cÜe_id
 = 
	`cÜeId
();

633 
Addr
 
pc
 = 0;

634 ià(
pkt
->
»q
->
	`hasPC
()) {

635 
pc
 = 
pkt
->
»q
->
	`g‘PC
();

640 
¡d
::
sh¬ed_±r
<
RubyReque¡
> 
msg
 =

641 
¡d
::
make_sh¬ed
<
RubyReque¡
>(
	`şockEdge
(), 
pkt
->
	`g‘Addr
(),

642 
pkt
->
	`isFlush
() ?

643 
nuÎ±r
 : 
pkt
->
g‘PŒ
<
ušt8_t
>(),

644 
pkt
->
	`g‘Size
(), 
pc
, 
£cÚd¬y_ty³
,

645 
RubyAcûssMode_Su³rvisÜ
, 
pkt
,

646 
P»ãtchB™_No
, 
´oc_id
, 
cÜe_id
);

648 
	`DPRINTFR
(
PrÙocŞT¿û
, "%15s %3s %10s%20s %6s>%-6s %#x %s\n",

649 
	`curTick
(), 
m_v”siÚ
, "Seq", "Begin", "", "",

650 
	`´štAdd»ss
(
msg
->
	`g‘PhysiÿlAdd»ss
()),

651 
	`RubyReque¡Ty³_to_¡ršg
(
£cÚd¬y_ty³
));

659 
Cyşes
 
	`Ï‹ncy
(0);

660 ià(
£cÚd¬y_ty³
 =ğ
RubyReque¡Ty³_IFETCH
)

661 
Ï‹ncy
 = 
m_š¡_ÿche_h™_Ï‹ncy
;

663 
Ï‹ncy
 = 
m_d©a_ÿche_h™_Ï‹ncy
;

666 
	`as£¹
(
Ï‹ncy
 > 0);

668 
	`as£¹
(
m_mªd©Üy_q_±r
 !ğ
NULL
);

669 
m_mªd©Üy_q_±r
->
	`’queue
(
msg
, 
	`şockEdge
(), 
	`cyşesToTicks
(
Ï‹ncy
));

670 
	}
}

672 
	g‹m¶©e
 <
şass
 
	gKEY
, cÏs 
	gVALUE
>

673 
	g¡d
::
o¡»am
 &

674 
İ”©Ü
<<(
o¡»am
 &
out
, cÚ¡ 
	g¡d
::
unÜd”ed_m­
<
KEY
, 
	gVALUE
> &
	gm­
)

676 autØ
	gi
 = 
m­
.
begš
();

677 autØ
	g’d
 = 
m­
.
’d
();

679 
	gout
 << "[";

680 ; 
	gi
 !ğ
’d
; ++i)

681 
	gout
 << " " << 
	gi
->
	gfœ¡
 << "=" << i->
	g£cÚd
;

682 
	gout
 << " ]";

684  
	gout
;

688 
	gSequ’ûr
::
	$´št
(
o¡»am
& 
out
) const

690 
out
 << "[Sequ’ûr: " << 
m_v”siÚ


691 << ", out¡ªdšg„eque¡s: " << 
m_out¡ªdšg_couÁ


692 << ",„—d„eque¡abË: " << 
m_»adReque¡TabË


693 << ", wr™»que¡abË: " << 
m_wr™eReque¡TabË


695 
	}
}

701 
	gSequ’ûr
::
	$checkCoh”’û
(
Addr
 
addr
)

703 #ifdeà
CHECK_COHERENCE


704 
m_ruby_sy¡em
->
	`checkGlob®Coh”’ûInv¬ŸÁ
(
addr
);

706 
	}
}

709 
	gSequ’ûr
::
	$»cÜdReque¡Ty³
(
Sequ’ûrReque¡Ty³
 
»que¡Ty³
) {

710 
	`DPRINTF
(
RubySts
, "Recorded statistic: %s\n",

711 
	`Sequ’ûrReque¡Ty³_to_¡ršg
(
»que¡Ty³
));

712 
	}
}

716 
	gSequ’ûr
::
	$eviùiÚC®lback
(
Addr
 
add»ss
)

718 
	`ruby_eviùiÚ_ÿÎback
(
add»ss
);

719 
	}
}

722 
	gSequ’ûr
::
	$»gSts
()

724 
RubyPÜt
::
	`»gSts
();

726 
m_¡Üe_wa™šg_Ú_lßd


727 .
	`Çme
(name() + ".store_waiting_on_load")

728 .
	`desc
("Number ofimes‡ store‡liased with‡…ending†oad")

729 .
	`æags
(
Sts
::
noz”o
);

730 
m_¡Üe_wa™šg_Ú_¡Üe


731 .
	`Çme
(name() + ".store_waiting_on_store")

732 .
	`desc
("Number ofimes‡ store‡liased with‡…ending store")

733 .
	`æags
(
Sts
::
noz”o
);

734 
m_lßd_wa™šg_Ú_lßd


735 .
	`Çme
(name() + ".load_waiting_on_load")

736 .
	`desc
("Number ofimes‡†oad‡liased with‡…ending†oad")

737 .
	`æags
(
Sts
::
noz”o
);

738 
m_lßd_wa™šg_Ú_¡Üe


739 .
	`Çme
(name() + ".load_waiting_on_store")

740 .
	`desc
("Number ofimes‡†oad‡liased with‡…ending store")

741 .
	`æags
(
Sts
::
noz”o
);

746 
m_out¡ªdReqHi¡
.
	`š™
(10);

747 
m_Ï‹ncyHi¡
.
	`š™
(10);

748 
m_h™L©’cyHi¡
.
	`š™
(10);

749 
m_missL©’cyHi¡
.
	`š™
(10);

751 
i
 = 0; i < 
RubyReque¡Ty³_NUM
; i++) {

752 
m_ty³L©’cyHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

753 
m_ty³L©’cyHi¡
[
i
]->
	`š™
(10);

755 
m_h™Ty³L©’cyHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

756 
m_h™Ty³L©’cyHi¡
[
i
]->
	`š™
(10);

758 
m_missTy³L©’cyHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

759 
m_missTy³L©’cyHi¡
[
i
]->
	`š™
(10);

762 
i
 = 0; i < 
MachšeTy³_NUM
; i++) {

763 
m_h™MachL©’cyHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

764 
m_h™MachL©’cyHi¡
[
i
]->
	`š™
(10);

766 
m_missMachL©’cyHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

767 
m_missMachL©’cyHi¡
[
i
]->
	`š™
(10);

769 
m_IssueToIn™ŸlD–ayHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

770 
m_IssueToIn™ŸlD–ayHi¡
[
i
]->
	`š™
(10);

772 
m_In™ŸlToFÜw¬dD–ayHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

773 
m_In™ŸlToFÜw¬dD–ayHi¡
[
i
]->
	`š™
(10);

775 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

776 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
[
i
]->
	`š™
(10);

778 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
.
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

779 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
[
i
]->
	`š™
(10);

782 
i
 = 0; i < 
RubyReque¡Ty³_NUM
; i++) {

783 
m_h™Ty³MachL©’cyHi¡
.
	`push_back
(
¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *>());

784 
m_missTy³MachL©’cyHi¡
.
	`push_back
(
¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *>());

786 
j
 = 0; j < 
MachšeTy³_NUM
; j++) {

787 
m_h™Ty³MachL©’cyHi¡
[
i
].
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

788 
m_h™Ty³MachL©’cyHi¡
[
i
][
j
]->
	`š™
(10);

790 
m_missTy³MachL©’cyHi¡
[
i
].
	`push_back
(
Ãw
 
Sts
::
	`Hi¡og¿m
());

791 
m_missTy³MachL©’cyHi¡
[
i
][
j
]->
	`š™
(10);

794 
	}
}

	@ruby/system/Sequencer.hh

29 #iâdeà
__MEM_RUBY_SYSTEM_SEQUENCER_HH__


30 
	#__MEM_RUBY_SYSTEM_SEQUENCER_HH__


	)

32 
	~<io¡»am
>

33 
	~<unÜd”ed_m­
>

35 
	~"mem/´ÙocŞ/MachšeTy³.hh
"

36 
	~"mem/´ÙocŞ/RubyReque¡Ty³.hh
"

37 
	~"mem/´ÙocŞ/Sequ’ûrReque¡Ty³.hh
"

38 
	~"mem/ruby/commÚ/Add»ss.hh
"

39 
	~"mem/ruby/¡ruùu»s/CacheMemÜy.hh
"

40 
	~"mem/ruby/sy¡em/RubyPÜt.hh
"

41 
	~"·¿ms/RubySequ’ûr.hh
"

43 
	sSequ’ûrReque¡


45 
Pack‘PŒ
 
	mpkt
;

46 
RubyReque¡Ty³
 
	mm_ty³
;

47 
Cyşes
 
	missue_time
;

49 
Sequ’ûrReque¡
(
Pack‘PŒ
 
_pkt
, 
RubyReque¡Ty³
 
_m_ty³
,

50 
Cyşes
 
_issue_time
)

51 : 
pkt
(
_pkt
), 
m_ty³
(
_m_ty³
), 
issue_time
(
_issue_time
)

55 
	g¡d
::
o¡»am
& 
İ”©Ü
<<(
¡d
::o¡»am& 
out
, cÚ¡ 
	gSequ’ûrReque¡
& 
	gobj
);

57 şas 
	cSequ’ûr
 : 
public
 
RubyPÜt


59 
public
:

60 
RubySequ’ûrP¬ams
 
	tP¬ams
;

61 
Sequ’ûr
(cÚ¡ 
P¬ams
 *);

62 ~
Sequ’ûr
();

65 
wakeup
();

66 
»£tSts
();

67 
cŞÏ‹Sts
();

68 
»gSts
();

70 
wr™eC®lback
(
Addr
 
add»ss
,

71 
D©aBlock
& 
d©a
,

72 cÚ¡ 
boŞ
 
ex‹º®H™
 = 
çl£
,

73 cÚ¡ 
MachšeTy³
 
mach
 = 
MachšeTy³_NUM
,

74 cÚ¡ 
Cyşes
 
š™ŸlReque¡Time
 = Cycles(0),

75 cÚ¡ 
Cyşes
 
fÜw¬dReque¡Time
 = Cycles(0),

76 cÚ¡ 
Cyşes
 
fœ¡Re¥Ú£Time
 = Cycles(0));

78 
»adC®lback
(
Addr
 
add»ss
,

79 
D©aBlock
& 
d©a
,

80 cÚ¡ 
boŞ
 
ex‹º®H™
 = 
çl£
,

81 cÚ¡ 
MachšeTy³
 
mach
 = 
MachšeTy³_NUM
,

82 cÚ¡ 
Cyşes
 
š™ŸlReque¡Time
 = Cycles(0),

83 cÚ¡ 
Cyşes
 
fÜw¬dReque¡Time
 = Cycles(0),

84 cÚ¡ 
Cyşes
 
fœ¡Re¥Ú£Time
 = Cycles(0));

86 
Reque¡Stus
 
makeReque¡
(
Pack‘PŒ
 
pkt
);

87 
boŞ
 
	$em±y
() const;

88 
	$out¡ªdšgCouÁ
(ècÚ¡ {  
m_out¡ªdšg_couÁ
; }

90 
boŞ
 
	$isD—dlockEv’tScheduËd
() const

91 {  
d—dlockCheckEv’t
.
	`scheduËd
(); 
	}
}

93 
	$descheduËD—dlockEv’t
()

94 { 
	`descheduË
(
d—dlockCheckEv’t
); 
	}
}

96 
	$´št
(
¡d
::
o¡»am
& 
out
) const;

97 
	`checkCoh”’û
(
Addr
 
add»ss
);

99 
	`m¬kRemoved
();

100 
	`eviùiÚC®lback
(
Addr
 
add»ss
);

101 
	`šv®id©eSC
(
Addr
 
add»ss
);

102 
	$cÜeId
(ècÚ¡ {  
m_cÜeId
; 
	}
}

104 
»cÜdReque¡Ty³
(
Sequ’ûrReque¡Ty³
 
»que¡Ty³
);

105 
	gSts
::
Hi¡og¿m
& 
	$g‘Out¡ªdReqHi¡
(è{  
m_out¡ªdReqHi¡
; 
	}
}

107 
	gSts
::
Hi¡og¿m
& 
	$g‘L©’cyHi¡
(è{  
m_Ï‹ncyHi¡
; 
	}
}

108 
	gSts
::
Hi¡og¿m
& 
	$g‘Ty³L©’cyHi¡
(
ušt32_t
 
t
)

109 {  *
m_ty³L©’cyHi¡
[
t
]; 
	}
}

111 
	gSts
::
Hi¡og¿m
& 
	$g‘H™L©’cyHi¡
(è{  
m_h™L©’cyHi¡
; 
	}
}

112 
	gSts
::
Hi¡og¿m
& 
	$g‘H™Ty³L©’cyHi¡
(
ušt32_t
 
t
)

113 {  *
m_h™Ty³L©’cyHi¡
[
t
]; 
	}
}

115 
	gSts
::
Hi¡og¿m
& 
	$g‘H™MachL©’cyHi¡
(
ušt32_t
 
t
)

116 {  *
m_h™MachL©’cyHi¡
[
t
]; 
	}
}

118 
	gSts
::
Hi¡og¿m
& 
	$g‘H™Ty³MachL©’cyHi¡
(
ušt32_t
 
r
, ušt32_ˆ
t
)

119 {  *
m_h™Ty³MachL©’cyHi¡
[
r
][
t
]; 
	}
}

121 
	gSts
::
Hi¡og¿m
& 
	$g‘MissL©’cyHi¡
()

122 {  
m_missL©’cyHi¡
; 
	}
}

123 
	gSts
::
Hi¡og¿m
& 
	$g‘MissTy³L©’cyHi¡
(
ušt32_t
 
t
)

124 {  *
m_missTy³L©’cyHi¡
[
t
]; 
	}
}

126 
	gSts
::
Hi¡og¿m
& 
	$g‘MissMachL©’cyHi¡
(
ušt32_t
 
t
) const

127 {  *
m_missMachL©’cyHi¡
[
t
]; 
	}
}

129 
	gSts
::
Hi¡og¿m
&

130 
	$g‘MissTy³MachL©’cyHi¡
(
ušt32_t
 
r
, ušt32_ˆ
t
) const

131 {  *
m_missTy³MachL©’cyHi¡
[
r
][
t
]; 
	}
}

133 
	gSts
::
Hi¡og¿m
& 
	$g‘IssueToIn™ŸlD–ayHi¡
(
ušt32_t
 
t
) const

134 {  *
m_IssueToIn™ŸlD–ayHi¡
[
t
]; 
	}
}

136 
	gSts
::
Hi¡og¿m
&

137 
	$g‘In™ŸlToFÜw¬dD–ayHi¡
(cÚ¡ 
MachšeTy³
 
t
) const

138 {  *
m_In™ŸlToFÜw¬dD–ayHi¡
[
t
]; 
	}
}

140 
	gSts
::
Hi¡og¿m
&

141 
	$g‘FÜw¬dReque¡ToFœ¡Re¥Ú£Hi¡
(cÚ¡ 
MachšeTy³
 
t
) const

142 {  *
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
[
t
]; 
	}
}

144 
	gSts
::
Hi¡og¿m
&

145 
	$g‘Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
(cÚ¡ 
MachšeTy³
 
t
) const

146 {  *
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
[
t
]; 
	}
}

148 
	gSts
::
CouÁ”
 
	$g‘Incom¶‘eTimes
(cÚ¡ 
MachšeTy³
 
t
) const

149 {  
m_Incom¶‘eTimes
[
t
]; 
	}
}

151 
	g´iv©e
:

152 
issueReque¡
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
ty³
);

154 
h™C®lback
(
Sequ’ûrReque¡
* 
»que¡
, 
D©aBlock
& 
d©a
,

155 
boŞ
 
ÎscSucûss
,

156 cÚ¡ 
MachšeTy³
 
mach
, cÚ¡ 
boŞ
 
ex‹º®H™
,

157 cÚ¡ 
Cyşes
 
š™ŸlReque¡Time
,

158 cÚ¡ 
Cyşes
 
fÜw¬dReque¡Time
,

159 cÚ¡ 
Cyşes
 
fœ¡Re¥Ú£Time
);

161 
»cÜdMissL©’cy
(cÚ¡ 
Cyşes
 
t
, cÚ¡ 
RubyReque¡Ty³
 
ty³
,

162 cÚ¡ 
MachšeTy³
 
»¥ÚdšgMach
,

163 
boŞ
 
isEx‹º®H™
, 
Cyşes
 
issuedTime
,

164 
Cyşes
 
š™ŸlReque¡Time
,

165 
Cyşes
 
fÜw¬dReque¡Time
, Cyşe 
fœ¡Re¥Ú£Time
,

166 
Cyşes
 
com¶‘iÚTime
);

168 
Reque¡Stus
 
š£¹Reque¡
(
Pack‘PŒ
 
pkt
, 
RubyReque¡Ty³
 
»que¡_ty³
);

169 
boŞ
 
hªdËLlsc
(
Addr
 
add»ss
, 
Sequ’ûrReque¡
* 
»que¡
);

172 
Sequ’ûr
(cÚ¡ Sequ’ûr& 
obj
);

173 
	gSequ’ûr
& 
	gİ”©Ü
=(cÚ¡ 
Sequ’ûr
& 
obj
);

175 
	g´iv©e
:

176 
m_max_out¡ªdšg_»que¡s
;

177 
Cyşes
 
	gm_d—dlock_th»shŞd
;

179 
CacheMemÜy
* 
	gm_d©aCache_±r
;

180 
CacheMemÜy
* 
	gm_š¡Cache_±r
;

186 
Cyşes
 
	gm_d©a_ÿche_h™_Ï‹ncy
;

187 
Cyşes
 
	gm_š¡_ÿche_h™_Ï‹ncy
;

189 
	g¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	tSequ’ûrReque¡
*> 
	tReque¡TabË
;

190 
Reque¡TabË
 
	gm_wr™eReque¡TabË
;

191 
Reque¡TabË
 
	gm_»adReque¡TabË
;

193 
	gm_out¡ªdšg_couÁ
;

194 
boŞ
 
	gm_d—dlock_check_scheduËd
;

197 
	gSts
::
SÿÏr
 
m_¡Üe_wa™šg_Ú_lßd
;

198 
	gSts
::
SÿÏr
 
m_¡Üe_wa™šg_Ú_¡Üe
;

199 
	gSts
::
SÿÏr
 
m_lßd_wa™šg_Ú_¡Üe
;

200 
	gSts
::
SÿÏr
 
m_lßd_wa™šg_Ú_lßd
;

202 
	gm_cÜeId
;

204 
boŞ
 
	gm_ruÂšgG¬ÃtSnd®Úe
;

207 
	gSts
::
Hi¡og¿m
 
m_out¡ªdReqHi¡
;

210 
	gSts
::
Hi¡og¿m
 
m_Ï‹ncyHi¡
;

211 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_ty³L©’cyHi¡
;

215 
	gSts
::
Hi¡og¿m
 
m_h™L©’cyHi¡
;

216 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_h™Ty³L©’cyHi¡
;

220 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_h™MachL©’cyHi¡
;

221 
	g¡d
::
veùÜ
< 
¡d
::veùÜ<
Sts
::
Hi¡og¿m
 *> > 
m_h™Ty³MachL©’cyHi¡
;

225 
	gSts
::
Hi¡og¿m
 
m_missL©’cyHi¡
;

226 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_missTy³L©’cyHi¡
;

230 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_missMachL©’cyHi¡
;

231 
	g¡d
::
veùÜ
< 
¡d
::veùÜ<
Sts
::
Hi¡og¿m
 *> > 
m_missTy³MachL©’cyHi¡
;

234 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_IssueToIn™ŸlD–ayHi¡
;

235 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_In™ŸlToFÜw¬dD–ayHi¡
;

236 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_FÜw¬dToFœ¡Re¥Ú£D–ayHi¡
;

237 
	g¡d
::
veùÜ
<
Sts
::
Hi¡og¿m
 *> 
m_Fœ¡Re¥Ú£ToCom¶‘iÚD–ayHi¡
;

238 
	g¡d
::
veùÜ
<
Sts
::
CouÁ”
> 
m_Incom¶‘eTimes
;

241 şas 
	cSequ’ûrWakeupEv’t
 : 
public
 
Ev’t


243 
´iv©e
:

244 
Sequ’ûr
 *
m_£qu’ûr_±r
;

246 
	gpublic
:

247 
Sequ’ûrWakeupEv’t
(
Sequ’ûr
 *
_£q
è: 
m_£qu’ûr_±r
(_seq) {}

248 
´oûss
(è{ 
m_£qu’ûr_±r
->
wakeup
(); }

249 cÚ¡ *
desütiÚ
() const {  "Sequencer deadlock check"; }

252 
Sequ’ûrWakeupEv’t
 
	gd—dlockCheckEv’t
;

255 
šlše
 
	g¡d
::
o¡»am
&

256 
İ”©Ü
<<(
¡d
::
o¡»am
& 
out
, cÚ¡ 
	gSequ’ûr
& 
	gobj
)

258 
	gobj
.
´št
(
out
);

259 
	gout
 << 
	g¡d
::
æush
;

260  
	gout
;

	@ruby/system/VIPERCoalescer.cc

36 
	~"ba£/misc.hh
"

37 
	~"ba£/¡r.hh
"

38 
	~"cÚfig/the_i§.hh
"

40 #ià
THE_ISA
 =ğ
X86_ISA


41 
	~"¬ch/x86/š¡s/miüŞd¡İ.hh
"

44 
	~"mem/ruby/sy¡em/VIPERCßËsûr.hh
"

46 
	~"ıu/‹¡”s/ruby‹¡/RubyTe¡”.hh
"

47 
	~"debug/GPUCßËsûr.hh
"

48 
	~"debug/MemÜyAcûss.hh
"

49 
	~"mem/·ck‘.hh
"

50 
	~"mem/ruby/commÚ/SubBlock.hh
"

51 
	~"mem/ruby/ÃtwÜk/Mes§geBufãr.hh
"

52 
	~"mem/ruby/´of”/Prof”.hh
"

53 
	~"mem/ruby/¦icc_š‹rçû/Ab¡¿ùCÚŒŞËr.hh
"

54 
	~"mem/ruby/¦icc_š‹rçû/RubyReque¡.hh
"

55 
	~"mem/ruby/¡ruùu»s/CacheMemÜy.hh
"

56 
	~"mem/ruby/sy¡em/GPUCßËsûr.hh
"

57 
	~"mem/ruby/sy¡em/RubySy¡em.hh
"

58 
	~"·¿ms/VIPERCßËsûr.hh
"

60 
usšg
 
Çme¥aû
 
	g¡d
;

62 
VIPERCßËsûr
 *

63 
	gVIPERCßËsûrP¬ams
::
	$ü—‹
()

65  
Ãw
 
	`VIPERCßËsûr
(
this
);

66 
	}
}

68 
	gVIPERCßËsûr
::
	$VIPERCßËsûr
(cÚ¡ 
P¬ams
 *
p
)

69 : 
	$GPUCßËsûr
(
p
)

71 
m_max_wb_³r_cyşe
=
p
->
max_wb_³r_cyşe
;

72 
m_max_šv_³r_cyşe
=
p
->
max_šv_³r_cyşe
;

73 
m_out¡ªdšg_šv
 = 0;

74 
m_out¡ªdšg_wb
 = 0;

75 
	}
}

77 
	gVIPERCßËsûr
::~
	$VIPERCßËsûr
()

79 
	}
}

90 
Reque¡Stus


91 
VIPERCßËsûr
::
	$makeReque¡
(
Pack‘PŒ
 
pkt
)

93 ià(
m_out¡ªdšg_wb
 | 
m_out¡ªdšg_šv
) {

94 
	`DPRINTF
(
GPUCßËsûr
,

96 
m_out¡ªdšg_wb
, 
m_out¡ªdšg_šv
);

99 ià((
m_out¡ªdšg_wb
) > 0) {

100 ià(
pkt
->
»q
->
	`isK”Ãl
()) {

104 ià(
pkt
->
»q
->
	`isAcquœe
(è&& (
m_out¡ªdšg_šv
 == 0)) {

105 
	`švL1
();

108 ià(
pkt
->
»q
->
	`isR–—£
()) {

109 
	`š£¹K”Ãl
(
pkt
->
»q
->
	`cÚ‹xtId
(),…kt);

112  
Reque¡Stus_Issued
;

115 } ià(
pkt
->
»q
->
	`isK”Ãl
(è&&…kt->»q->
	`isR–—£
()) {

118 
	`š£¹K”Ãl
(
pkt
->
»q
->
	`cÚ‹xtId
(),…kt);

119 
	`wbL1
();

120 ià(
m_out¡ªdšg_wb
 == 0) {

121 autØ
™
 = 
k”ÃlEndLi¡
.
	`begš
(); iˆ!ğk”ÃlEndLi¡.
	`’d
(); it++) {

122 
ÃwK”ÃlEnds
.
	`push_back
(
™
->
fœ¡
);

124 
	`com¶‘eIssue
();

126  
Reque¡Stus_Issued
;

128 
Reque¡Stus
 
»que¡Stus
 = 
GPUCßËsûr
::
	`makeReque¡
(
pkt
);

129 ià(
»que¡Stus
!=
Reque¡Stus_Issued
) {

132 
	`DPRINTF
(
GPUCßËsûr
, "Request‚ot issued by GPUCoaleser\n");

133  
»que¡Stus
;

134 } ià(
pkt
->
»q
->
	`isK”Ãl
(è&&…kt->»q->
	`isAcquœe
()) {

137 
	`švL1
();

138 } ià(
pkt
->
»q
->
	`isAcquœe
(è&&…kt->»q->
	`isR–—£
()) {

141 
	`švwbL1
();

142 ià(
m_out¡ªdšg_wb
 > 0 && 
issueEv’t
.
	`scheduËd
()) {

143 
	`DPRINTF
(
GPUCßËsûr
, "issueEvent Descheduled\n");

144 
	`descheduË
(
issueEv’t
);

146 } ià(
pkt
->
»q
->
	`isR–—£
()) {

149 
	`wbL1
();

150 ià(
m_out¡ªdšg_wb
 > 0 && 
issueEv’t
.
	`scheduËd
()) {

151 
	`DPRINTF
(
GPUCßËsûr
, "issueEvent Descheduled\n");

152 
	`descheduË
(
issueEv’t
);

154 } ià(
pkt
->
»q
->
	`isAcquœe
()) {

157 
	`švL1
();

160 ià(
m_out¡ªdšg_wb
 == 0) {

161 ià(!
issueEv’t
.
	`scheduËd
()) {

162 
	`DPRINTF
(
GPUCßËsûr
, "issueEvent Rescheduled\n");

163 
	`scheduË
(
issueEv’t
, 
	`curTick
());

166  
Reque¡Stus_Issued
;

167 
	}
}

170 
	gVIPERCßËsûr
::
	$wbC®lback
(
Addr
 
addr
)

172 
m_out¡ªdšg_wb
--;

175 
	`as£¹
(((è
m_out¡ªdšg_wb
) >= 0);

176 ià(
m_out¡ªdšg_wb
 == 0) {

177 autØ
™
 = 
k”ÃlEndLi¡
.
	`begš
(); iˆ!ğk”ÃlEndLi¡.
	`’d
(); it++) {

178 
ÃwK”ÃlEnds
.
	`push_back
(
™
->
fœ¡
);

180 
	`com¶‘eIssue
();

182 
	`ŒyS’dR‘r›s
();

183 
	}
}

186 
	gVIPERCßËsûr
::
	$švC®lback
(
Addr
 
addr
)

188 
m_out¡ªdšg_šv
--;

193 ià(
m_out¡ªdšg_wb
 == 0) {

194 autØ
™
 = 
k”ÃlEndLi¡
.
	`begš
(); iˆ!ğk”ÃlEndLi¡.
	`’d
(); it++) {

195 
ÃwK”ÃlEnds
.
	`push_back
(
™
->
fœ¡
);

197 
	`com¶‘eIssue
();

199 
	`ŒyS’dR‘r›s
();

200 
	}
}

206 
	gVIPERCßËsûr
::
	$švL1
()

208 
size
 = 
m_d©aCache_±r
->
	`g‘NumBlocks
();

209 
	`DPRINTF
(
GPUCßËsûr
,

211 
m_out¡ªdšg_šv
);

213 
i
 = 0; i < 
size
; i++) {

214 
Addr
 
addr
 = 
m_d©aCache_±r
->
	`g‘Add»ssAtIdx
(
i
);

216 
¡d
::
sh¬ed_±r
<
RubyReque¡
> 
msg
 = std::
make_sh¬ed
<RubyRequest>(

217 
	`şockEdge
(), 
addr
, (
ušt8_t
*) 0, 0, 0,

218 
RubyReque¡Ty³_REPLACEMENT
, 
RubyAcûssMode_Su³rvisÜ
,

219 
nuÎ±r
);

220 
	`as£¹
(
m_mªd©Üy_q_±r
 !ğ
NULL
);

221 
m_mªd©Üy_q_±r
->
	`’queue
(
msg
, 
	`şockEdge
(), 
m_d©a_ÿche_h™_Ï‹ncy
);

222 
m_out¡ªdšg_šv
++;

224 
	`DPRINTF
(
GPUCßËsûr
,

226 
m_out¡ªdšg_šv
);

227 
	}
}

233 
	gVIPERCßËsûr
::
	$wbL1
()

235 
size
 = 
m_d©aCache_±r
->
	`g‘NumBlocks
();

236 
	`DPRINTF
(
GPUCßËsûr
,

238 
m_out¡ªdšg_wb
);

240 
i
 = 0; i < 
size
; i++) {

241 
Addr
 
addr
 = 
m_d©aCache_±r
->
	`g‘Add»ssAtIdx
(
i
);

243 
¡d
::
sh¬ed_±r
<
RubyReque¡
> 
msg
 = std::
make_sh¬ed
<RubyRequest>(

244 
	`şockEdge
(), 
addr
, (
ušt8_t
*) 0, 0, 0,

245 
RubyReque¡Ty³_FLUSH
, 
RubyAcûssMode_Su³rvisÜ
,

246 
nuÎ±r
);

247 
	`as£¹
(
m_mªd©Üy_q_±r
 !ğ
NULL
);

248 
m_mªd©Üy_q_±r
->
	`’queue
(
msg
, 
	`şockEdge
(), 
m_d©a_ÿche_h™_Ï‹ncy
);

249 
m_out¡ªdšg_wb
++;

251 
	`DPRINTF
(
GPUCßËsûr
,

253 
m_out¡ªdšg_wb
);

254 
	}
}

260 
	gVIPERCßËsûr
::
	$švwbL1
()

262 
size
 = 
m_d©aCache_±r
->
	`g‘NumBlocks
();

264 
i
 = 0; i < 
size
; i++) {

265 
Addr
 
addr
 = 
m_d©aCache_±r
->
	`g‘Add»ssAtIdx
(
i
);

267 
¡d
::
sh¬ed_±r
<
RubyReque¡
> 
msg
 = std::
make_sh¬ed
<RubyRequest>(

268 
	`şockEdge
(), 
addr
, (
ušt8_t
*) 0, 0, 0,

269 
RubyReque¡Ty³_REPLACEMENT
, 
RubyAcûssMode_Su³rvisÜ
,

270 
nuÎ±r
);

271 
	`as£¹
(
m_mªd©Üy_q_±r
 !ğ
NULL
);

272 
m_mªd©Üy_q_±r
->
	`’queue
(
msg
, 
	`şockEdge
(), 
m_d©a_ÿche_h™_Ï‹ncy
);

273 
m_out¡ªdšg_šv
++;

276 
i
 = 0; i< 
size
; i++) {

277 
Addr
 
addr
 = 
m_d©aCache_±r
->
	`g‘Add»ssAtIdx
(
i
);

279 
¡d
::
sh¬ed_±r
<
RubyReque¡
> 
msg
 = std::
make_sh¬ed
<RubyRequest>(

280 
	`şockEdge
(), 
addr
, (
ušt8_t
*) 0, 0, 0,

281 
RubyReque¡Ty³_FLUSH
, 
RubyAcûssMode_Su³rvisÜ
,

282 
nuÎ±r
);

283 
	`as£¹
(
m_mªd©Üy_q_±r
 !ğ
NULL
);

284 
m_mªd©Üy_q_±r
->
	`’queue
(
msg
, 
	`şockEdge
(), 
m_d©a_ÿche_h™_Ï‹ncy
);

285 
m_out¡ªdšg_wb
++;

287 
	}
}

	@ruby/system/VIPERCoalescer.hh

36 #iâdeà
__MEM_RUBY_SYSTEM_VI_COALESCER_HH__


37 
	#__MEM_RUBY_SYSTEM_VI_COALESCER_HH__


	)

39 
	~<io¡»am
>

41 
	~"mem/´ÙocŞ/P»ãtchB™.hh
"

42 
	~"mem/´ÙocŞ/RubyAcûssMode.hh
"

43 
	~"mem/´ÙocŞ/RubyReque¡Ty³.hh
"

44 
	~"mem/ruby/commÚ/Add»ss.hh
"

45 
	~"mem/ruby/commÚ/CÚsum”.hh
"

46 
	~"mem/ruby/sy¡em/GPUCßËsûr.hh
"

47 
	~"mem/ruby/sy¡em/RubyPÜt.hh
"

49 
şass
 
	gD©aBlock
;

50 
şass
 
	gCacheMsg
;

51 
şass
 
	gMachšeID
;

52 
şass
 
	gCacheMemÜy
;

54 
şass
 
	gVIPERCßËsûrP¬ams
;

56 şas 
	cVIPERCßËsûr
 : 
public
 
GPUCßËsûr


58 
public
:

59 
VIPERCßËsûrP¬ams
 
	tP¬ams
;

60 
VIPERCßËsûr
(cÚ¡ 
P¬ams
 *);

61 ~
VIPERCßËsûr
();

62 
wbC®lback
(
Addr
 
add»ss
);

63 
švC®lback
(
Addr
 
add»ss
);

64 
Reque¡Stus
 
makeReque¡
(
Pack‘PŒ
 
pkt
);

65 
	m´iv©e
:

66 
švL1
();

67 
wbL1
();

68 
švwbL1
();

69 
ušt64_t
 
	mm_out¡ªdšg_šv
;

70 
ušt64_t
 
	mm_out¡ªdšg_wb
;

71 
ušt64_t
 
	mm_max_šv_³r_cyşe
;

72 
ušt64_t
 
	mm_max_wb_³r_cyşe
;

	@ruby/system/WeightedLRUPolicy.cc

36 
	~"mem/ruby/sy¡em/Weigh‹dLRUPŞicy.hh
"

38 
	gWeigh‹dLRUPŞicy
::
	$Weigh‹dLRUPŞicy
(cÚ¡ 
P¬ams
* 
p
)

39 : 
	`Ab¡¿ùR•Ïûm’tPŞicy
(
p
), 
	`m_ÿche
Õ->
ÿche
)

41 
m_Ï¡_occ_±r
 = 
Ãw
 *[
m_num_£ts
];

42 
i
 = 0; i < 
m_num_£ts
; i++){

43 
m_Ï¡_occ_±r
[
i
] = 
Ãw
 [
m_assoc
];

44 
j
 = 0; j < 
m_assoc
; j++){

45 
m_Ï¡_occ_±r
[
i
][
j
] = 0;

48 
	}
}

50 
Weigh‹dLRUPŞicy
 *

51 
	gWeigh‹dLRUR•Ïûm’tPŞicyP¬ams
::
	$ü—‹
()

53  
Ãw
 
	`Weigh‹dLRUPŞicy
(
this
);

54 
	}
}

56 
	gWeigh‹dLRUPŞicy
::~
	$Weigh‹dLRUPŞicy
()

58 ià(
m_Ï¡_occ_±r
 !ğ
NULL
){

59 
i
 = 0; i < 
m_num_£ts
; i++){

60 ià(
m_Ï¡_occ_±r
[
i
] !ğ
NULL
){

61 
d–‘e
[] 
m_Ï¡_occ_±r
[
i
];

64 
d–‘e
[] 
m_Ï¡_occ_±r
;

66 
	}
}

69 
	gWeigh‹dLRUPŞicy
::
	$touch
(
št64_t
 
£t
, iÁ64_ˆ
šdex
, 
Tick
 
time
)

71 
	`as£¹
(
šdex
 >ğ0 && index < 
m_assoc
);

72 
	`as£¹
(
£t
 >ğ0 && s‘ < 
m_num_£ts
);

74 
m_Ï¡_»f_±r
[
£t
][
šdex
] = 
time
;

75 
	}
}

78 
	gWeigh‹dLRUPŞicy
::
	$touch
(
št64_t
 
£t
, iÁ64_ˆ
šdex
, 
Tick
 
time
, 
occu·ncy
)

80 
	`as£¹
(
šdex
 >ğ0 && index < 
m_assoc
);

81 
	`as£¹
(
£t
 >ğ0 && s‘ < 
m_num_£ts
);

83 
m_Ï¡_»f_±r
[
£t
][
šdex
] = 
time
;

84 
m_Ï¡_occ_±r
[
£t
][
šdex
] = 
occu·ncy
;

85 
	}
}

87 
št64_t


88 
	gWeigh‹dLRUPŞicy
::
	$g‘Viùim
(
št64_t
 
£t
) const

90 
Tick
 
time
, 
sm®Ë¡_time
;

91 
št64_t
 
sm®Ë¡_šdex
;

93 
sm®Ë¡_šdex
 = 0;

94 
sm®Ë¡_time
 = 
m_Ï¡_»f_±r
[
£t
][0];

95 
sm®Ë¡_weight
 = 
m_Ï¡_»f_±r
[
£t
][0];

97 
i
 = 1; i < 
m_assoc
; i++) {

99 
weight
 = 
m_Ï¡_occ_±r
[
£t
][
i
];

100 ià(
weight
 < 
sm®Ë¡_weight
) {

101 
sm®Ë¡_weight
 = 
weight
;

102 
sm®Ë¡_šdex
 = 
i
;

103 
sm®Ë¡_time
 = 
m_Ï¡_»f_±r
[
£t
][
i
];

104 } ià(
weight
 =ğ
sm®Ë¡_weight
) {

105 
time
 = 
m_Ï¡_»f_±r
[
£t
][
i
];

106 ià(
time
 < 
sm®Ë¡_time
) {

107 
sm®Ë¡_šdex
 = 
i
;

108 
sm®Ë¡_time
 = 
time
;

112  
sm®Ë¡_šdex
;

113 
	}
}

	@ruby/system/WeightedLRUPolicy.hh

36 #iâdeà
__MEM_RUBY_SYSTEM_WEIGHTEDLRUPOLICY_HH__


37 
	#__MEM_RUBY_SYSTEM_WEIGHTEDLRUPOLICY_HH__


	)

39 
	~"mem/ruby/¡ruùu»s/Ab¡¿ùR•Ïûm’tPŞicy.hh
"

40 
	~"mem/ruby/¡ruùu»s/CacheMemÜy.hh
"

41 
	~"·¿ms/Weigh‹dLRUR•Ïûm’tPŞicy.hh
"

45 şas 
	cWeigh‹dLRUPŞicy
 : 
public
 
Ab¡¿ùR•Ïûm’tPŞicy


47 
public
:

48 
Weigh‹dLRUR•Ïûm’tPŞicyP¬ams
 
	tP¬ams
;

49 
Weigh‹dLRUPŞicy
(cÚ¡ 
P¬ams
* 
p
);

50 ~
Weigh‹dLRUPŞicy
();

52 
	$touch
(
št64_t
 
£t
, iÁ64_ˆ
way
, 
Tick
 
time
è
ov”ride
;

53 
	`touch
(
št64_t
 
£t
, iÁ64_ˆ
way
, 
Tick
 
time
, 
occu·ncy
);

54 
št64_t
 
	$g‘Viùim
(
št64_t
 
£t
ècÚ¡ 
ov”ride
;

56 
boŞ
 
	$u£Occu·ncy
(ècÚ¡ 
ov”ride
 {  
Œue
; }

58 
CacheMemÜy
 * 
m_ÿche
;

59 **
m_Ï¡_occ_±r
;

60 
	}
};

	@se_translating_port_proxy.cc

45 
	~<¡ršg
>

47 
	~"¬ch/i§_Œa™s.hh
"

48 
	~"ba£/chunk_g’”©Ü.hh
"

49 
	~"cÚfig/the_i§.hh
"

50 
	~"mem/·ge_bË.hh
"

51 
	~"mem/£_Œª¦©šg_pÜt_´oxy.hh
"

52 
	~"sim/´oûss.hh
"

53 
	~"sim/sy¡em.hh
"

55 
usšg
 
Çme¥aû
 
	gTheISA
;

57 
	gSET¿n¦©šgPÜtProxy
::
	$SET¿n¦©šgPÜtProxy
(
Ma¡”PÜt
& 
pÜt
, 
Proûss
 *
p
,

58 
AÎocTy³
 
®loc
)

59 : 
	`PÜtProxy
(
pÜt
, 
p
->
sy¡em
->
	`ÿcheLšeSize
()), 
	`pTabË
Õ->
pTabË
),

60 
	`´oûss
(
p
), 
	$®loÿtšg
(
®loc
)

61 { 
	}
}

63 
	gSET¿n¦©šgPÜtProxy
::~
	$SET¿n¦©šgPÜtProxy
()

64 { 
	}
}

66 
boŞ


67 
SET¿n¦©šgPÜtProxy
::
	$ŒyR—dBlob
(
Addr
 
addr
, 
ušt8_t
 *
p
, 
size
) const

69 
´evSize
 = 0;

71 
ChunkG’”©Ü
 
	`g’
(
addr
, 
size
, 
PageBy‹s
); !
g’
.
	`dÚe
(); g’.
	`Ãxt
()) {

72 
Addr
 
·ddr
;

74 ià(!
pTabË
->
	`Œª¦©e
(
g’
.
	`addr
(),
·ddr
))

75  
çl£
;

77 
PÜtProxy
::
	`»adBlob
(
·ddr
, 
p
 + 
´evSize
, 
g’
.
	`size
());

78 
´evSize
 +ğ
g’
.
	`size
();

81  
Œue
;

82 
	}
}

85 
	gSET¿n¦©šgPÜtProxy
::
	$»adBlob
(
Addr
 
addr
, 
ušt8_t
 *
p
, 
size
) const

87 ià(!
	`ŒyR—dBlob
(
addr
, 
p
, 
size
))

88 
	`çl
("»adBlob(0x%x, ...èçed", 
addr
);

89 
	}
}

92 
boŞ


93 
	gSET¿n¦©šgPÜtProxy
::
	$ŒyWr™eBlob
(
Addr
 
addr
, cÚ¡ 
ušt8_t
 *
p
,

94 
size
) const

96 
´evSize
 = 0;

98 
ChunkG’”©Ü
 
	`g’
(
addr
, 
size
, 
PageBy‹s
); !
g’
.
	`dÚe
(); g’.
	`Ãxt
()) {

99 
Addr
 
·ddr
;

101 ià(!
pTabË
->
	`Œª¦©e
(
g’
.
	`addr
(), 
·ddr
)) {

102 ià(
®loÿtšg
 =ğ
Always
) {

103 
´oûss
->
	`®loÿ‹Mem
(
	`roundDown
(
g’
.
	`addr
(), 
PageBy‹s
),

104 
PageBy‹s
);

105 } ià(
®loÿtšg
 =ğ
NextPage
) {

107 ià(!
´oûss
->
	`fixupSckFauÉ
(
g’
.
	`addr
()))

108 
	`·nic
("Pageable fault when‡ccessing virtual‡ddress %#x "

109 "duršg funùiÚ® wr™e\n", 
g’
.
	`addr
());

111  
çl£
;

113 
pTabË
->
	`Œª¦©e
(
g’
.
	`addr
(), 
·ddr
);

116 
PÜtProxy
::
	`wr™eBlob
(
·ddr
, 
p
 + 
´evSize
, 
g’
.
	`size
());

117 
´evSize
 +ğ
g’
.
	`size
();

120  
Œue
;

121 
	}
}

125 
	gSET¿n¦©šgPÜtProxy
::
	$wr™eBlob
(
Addr
 
addr
, cÚ¡ 
ušt8_t
 *
p
, 
size
) const

127 ià(!
	`ŒyWr™eBlob
(
addr
, 
p
, 
size
))

128 
	`çl
("wr™eBlob(0x%x, ...èçed", 
addr
);

129 
	}
}

131 
boŞ


132 
	gSET¿n¦©šgPÜtProxy
::
	$ŒyMem£tBlob
(
Addr
 
addr
, 
ušt8_t
 
v®
, 
size
) const

134 
ChunkG’”©Ü
 
	`g’
(
addr
, 
size
, 
PageBy‹s
); !
g’
.
	`dÚe
(); g’.
	`Ãxt
()) {

135 
Addr
 
·ddr
;

137 ià(!
pTabË
->
	`Œª¦©e
(
g’
.
	`addr
(), 
·ddr
)) {

138 ià(
®loÿtšg
 =ğ
Always
) {

139 
´oûss
->
	`®loÿ‹Mem
(
	`roundDown
(
g’
.
	`addr
(), 
PageBy‹s
),

140 
PageBy‹s
);

141 
pTabË
->
	`Œª¦©e
(
g’
.
	`addr
(), 
·ddr
);

143  
çl£
;

147 
PÜtProxy
::
	`mem£tBlob
(
·ddr
, 
v®
, 
g’
.
	`size
());

150  
Œue
;

151 
	}
}

154 
	gSET¿n¦©šgPÜtProxy
::
	$mem£tBlob
(
Addr
 
addr
, 
ušt8_t
 
v®
, 
size
) const

156 ià(!
	`ŒyMem£tBlob
(
addr
, 
v®
, 
size
))

157 
	`çl
("mem£tBlob(0x%x, ...èçed", 
addr
);

158 
	}
}

161 
boŞ


162 
	gSET¿n¦©šgPÜtProxy
::
	$ŒyWr™eSŒšg
(
Addr
 
addr
, cÚ¡ *
¡r
) const

164 
ušt8_t
 
c
;

166 
Addr
 
vaddr
 = 
addr
;

169 
c
 = *
¡r
++;

170 
Addr
 
·ddr
;

172 ià(!
pTabË
->
	`Œª¦©e
(
vaddr
++, 
·ddr
))

173  
çl£
;

175 
PÜtProxy
::
	`wr™eBlob
(
·ddr
, &
c
, 1);

176 } 
c
);

178  
Œue
;

179 
	}
}

182 
	gSET¿n¦©šgPÜtProxy
::
	$wr™eSŒšg
(
Addr
 
addr
, cÚ¡ *
¡r
) const

184 ià(!
	`ŒyWr™eSŒšg
(
addr
, 
¡r
))

185 
	`çl
("wr™eSŒšg(0x%x, ...èçed", 
addr
);

186 
	}
}

188 
boŞ


189 
	gSET¿n¦©šgPÜtProxy
::
	$ŒyR—dSŒšg
(
¡d
::
¡ršg
 &
¡r
, 
Addr
 
addr
) const

191 
ušt8_t
 
c
;

193 
Addr
 
vaddr
 = 
addr
;

195 
Œue
) {

196 
Addr
 
·ddr
;

198 ià(!
pTabË
->
	`Œª¦©e
(
vaddr
++, 
·ddr
))

199  
çl£
;

201 
PÜtProxy
::
	`»adBlob
(
·ddr
, &
c
, 1);

202 ià(
c
 == '\0')

205 
¡r
 +ğ
c
;

208  
Œue
;

209 
	}
}

212 
	gSET¿n¦©šgPÜtProxy
::
	$»adSŒšg
(
¡d
::
¡ršg
 &
¡r
, 
Addr
 
addr
) const

214 ià(!
	`ŒyR—dSŒšg
(
¡r
, 
addr
))

215 
	`çl
("»adSŒšg(0x%x, ...èçed", 
addr
);

216 
	}
}

	@se_translating_port_proxy.hh

45 #iâdeà
__MEM_SE_TRANSLATING_PORT_PROXY_HH__


46 
	#__MEM_SE_TRANSLATING_PORT_PROXY_HH__


	)

48 
	~"mem/·ge_bË.hh
"

49 
	~"mem/pÜt_´oxy.hh
"

51 
şass
 
	gProûss
;

67 şas 
	cSET¿n¦©šgPÜtProxy
 : 
public
 
PÜtProxy


70 
public
:

71 
	eAÎocTy³
 {

72 
Always
,

73 
	mNev”
,

74 
	mNextPage


77 
	g´iv©e
:

78 
PageTabËBa£
 *
pTabË
;

79 
Proûss
 *
	g´oûss
;

80 
AÎocTy³
 
	g®loÿtšg
;

82 
	gpublic
:

83 
SET¿n¦©šgPÜtProxy
(
Ma¡”PÜt
& 
pÜt
, 
Proûss
* 
p
, 
AÎocTy³
 
®loc
);

84 
	gvœtu®
 ~
SET¿n¦©šgPÜtProxy
();

86 
boŞ
 
	$ŒyR—dBlob
(
Addr
 
addr
, 
ušt8_t
 *
p
, 
size
) const;

87 
boŞ
 
	$ŒyWr™eBlob
(
Addr
 
addr
, cÚ¡ 
ušt8_t
 *
p
, 
size
) const;

88 
boŞ
 
	$ŒyMem£tBlob
(
Addr
 
addr
, 
ušt8_t
 
v®
, 
size
) const;

89 
boŞ
 
	$ŒyWr™eSŒšg
(
Addr
 
addr
, cÚ¡ *
¡r
) const;

90 
boŞ
 
	$ŒyR—dSŒšg
(
¡d
::
¡ršg
 &
¡r
, 
Addr
 
addr
) const;

92 
vœtu®
 
	$»adBlob
(
Addr
 
addr
, 
ušt8_t
 *
p
, 
size
) const;

93 
vœtu®
 
	$wr™eBlob
(
Addr
 
addr
, cÚ¡ 
ušt8_t
 *
p
, 
size
) const;

94 
vœtu®
 
	$mem£tBlob
(
Addr
 
addr
, 
ušt8_t
 
v®
, 
size
) const;

96 
	$wr™eSŒšg
(
Addr
 
addr
, cÚ¡ *
¡r
) const;

97 
	$»adSŒšg
(
¡d
::
¡ršg
 &
¡r
, 
Addr
 
addr
) const;

98 
	}
};

	@serial_link.cc

53 
	~"mem/£rŸl_lšk.hh
"

55 
	~"ba£/Œaû.hh
"

56 
	~"debug/S”ŸlLšk.hh
"

57 
	~"·¿ms/S”ŸlLšk.hh
"

60 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::S”ŸlLškSÏvePÜt(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
,

61 
S”ŸlLšk
& 
_£rŸl_lšk
,

62 
S”ŸlLškMa¡”PÜt
& 
_ma¡”PÜt
,

63 
Cyşes
 
_d–ay
, 
_»¥_lim™
,

64 cÚ¡ 
¡d
::
veùÜ
<
AddrRªge
>&

65 
_¿nges
)

66 : 
SÏvePÜt
(
_Çme
, &
_£rŸl_lšk
), 
£rŸl_lšk
(_serial_link),

67 
ma¡”PÜt
(
_ma¡”PÜt
), 
d–ay
(
_d–ay
),

68 
¿nges
(
_¿nges
.
begš
(), _¿nges.
’d
()),

69 
out¡ªdšgRe¥Ú£s
(0), 
»ŒyReq
(
çl£
),

70 
»¥QueueLim™
(
_»¥_lim™
), 
	$£ndEv’t
(*
this
)

72 
	}
}

74 
	gS”ŸlLšk
::
S”ŸlLškMa¡”PÜt
::
	$S”ŸlLškMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
&

75 
_Çme
, 
S”ŸlLšk
& 
_£rŸl_lšk
,

76 
S”ŸlLškSÏvePÜt
& 
_¦avePÜt
,

77 
Cyşes
 
_d–ay
, 
_»q_lim™
)

78 : 
	`Ma¡”PÜt
(
_Çme
, &
_£rŸl_lšk
), 
	`£rŸl_lšk
(_serial_link),

79 
	`¦avePÜt
(
_¦avePÜt
), 
	`d–ay
(
_d–ay
), 
	`»qQueueLim™
(
_»q_lim™
),

80 
	$£ndEv’t
(*
this
)

82 
	}
}

84 
	gS”ŸlLšk
::
	$S”ŸlLšk
(
S”ŸlLškP¬ams
 *
p
)

85 : 
	`MemObjeù
(
p
),

86 
	`¦avePÜt
(
p
->
Çme
 + ".¦ave", *
this
, 
ma¡”PÜt
,

87 
	`ticksToCyşes
(
p
->
d–ay
),…->
»¥_size
,…->
¿nges
),

88 
	`ma¡”PÜt
(
p
->
Çme
 + ".ma¡”", *
this
, 
¦avePÜt
,

89 
	`ticksToCyşes
(
p
->
d–ay
),…->
»q_size
),

90 
	`num_ÏÃs
(
p
->
num_ÏÃs
),

91 
	`lšk_¥“d
(
p
->
lšk_¥“d
)

94 
	}
}

96 
	gBa£Ma¡”PÜt
&

97 
	gS”ŸlLšk
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

99 ià(
if_Çme
 == "master")

100  
ma¡”PÜt
;

103  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

104 
	}
}

106 
	gBa£SÏvePÜt
&

107 
	gS”ŸlLšk
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

109 ià(
if_Çme
 == "slave")

110  
¦avePÜt
;

113  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

114 
	}
}

117 
	gS”ŸlLšk
::
	$š™
()

120 ià(!
¦avePÜt
.
	`isCÚÃùed
(è|| !
ma¡”PÜt
.isConnected())

121 
	`çl
("Both…orts of‡ serial_link must be connected.\n");

124 
¦avePÜt
.
	`£ndRªgeChªge
();

125 
	}
}

127 
boŞ


128 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$»¥QueueFuÎ
() const

130  
out¡ªdšgRe¥Ú£s
 =ğ
»¥QueueLim™
;

131 
	}
}

133 
boŞ


134 
	gS”ŸlLšk
::
S”ŸlLškMa¡”PÜt
::
	$»qQueueFuÎ
() const

136  
Œªsm™Li¡
.
	`size
(è=ğ
»qQueueLim™
;

137 
	}
}

139 
boŞ


140 
	gS”ŸlLšk
::
S”ŸlLškMa¡”PÜt
::
	$»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
)

144 
	`DPRINTF
(
S”ŸlLšk
, "recvTimingResp: %s‡ddr 0x%x\n",

145 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

147 
	`DPRINTF
(
S”ŸlLšk
, "Reque¡ queusize: %d\n", 
Œªsm™Li¡
.
	`size
());

150 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

157 
Cyşes
 
cyşes
 = 
d–ay
;

158 
cyşes
 +ğ
	`Cyşes
(
	`divCe
(
pkt
->
	`g‘Size
(è* 8, 
£rŸl_lšk
.
num_ÏÃs


159 * 
£rŸl_lšk
.
lšk_¥“d
));

160 
Tick
 
t
 = 
£rŸl_lšk
.
	`şockEdge
(
cyşes
);

167 
¦avePÜt
.
	`schedTimšgRe¥
(
pkt
, 
t
);

169  
Œue
;

170 
	}
}

172 
boŞ


173 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

175 
	`DPRINTF
(
S”ŸlLšk
, "recvTimingReq: %s‡ddr 0x%x\n",

176 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

179 
	`as£¹
(!
»ŒyReq
);

181 
	`DPRINTF
(
S”ŸlLšk
, "Response queue size: %d outresp: %d\n",

182 
Œªsm™Li¡
.
	`size
(), 
out¡ªdšgRe¥Ú£s
);

185 ià(
ma¡”PÜt
.
	`»qQueueFuÎ
()) {

186 
	`DPRINTF
(
S”ŸlLšk
, "Request queue full\n");

187 
»ŒyReq
 = 
Œue
;

188 } iàĞ!
»ŒyReq
 ) {

190 
boŞ
 
ex³ùs_»¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
() &&

191 !
pkt
->
	`ÿcheRe¥Údšg
();

192 ià(
ex³ùs_»¥Ú£
) {

193 ià(
	`»¥QueueFuÎ
()) {

194 
	`DPRINTF
(
S”ŸlLšk
, "Response queue full\n");

195 
»ŒyReq
 = 
Œue
;

198 
	`DPRINTF
(
S”ŸlLšk
, "Reserving space for„esponse\n");

199 
	`as£¹
(
out¡ªdšgRe¥Ú£s
 !ğ
»¥QueueLim™
);

200 ++
out¡ªdšgRe¥Ú£s
;

207 ià(!
»ŒyReq
) {

209 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

218 
Cyşes
 
cyşes
 = 
d–ay
;

219 
cyşes
 +ğ
	`Cyşes
(
	`divCe
(
pkt
->
	`g‘Size
() * 8,

220 
£rŸl_lšk
.
num_ÏÃs
 * s”Ÿl_lšk.
lšk_¥“d
));

221 
Tick
 
t
 = 
£rŸl_lšk
.
	`şockEdge
(
cyşes
);

228 
ma¡”PÜt
.
	`schedTimšgReq
(
pkt
, 
t
);

236  !
»ŒyReq
;

237 
	}
}

240 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$»ŒySÎedReq
()

242 ià(
»ŒyReq
) {

243 
	`DPRINTF
(
S”ŸlLšk
, "Request waiting for„etry,‚ow„etrying\n");

244 
»ŒyReq
 = 
çl£
;

245 
	`£ndR‘ryReq
();

247 
	}
}

250 
	gS”ŸlLšk
::
S”ŸlLškMa¡”PÜt
::
	$schedTimšgReq
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
)

256 ià(
Œªsm™Li¡
.
	`em±y
()) {

257 
£rŸl_lšk
.
	`scheduË
(
£ndEv’t
, 
wh’
);

260 
	`as£¹
(
Œªsm™Li¡
.
	`size
(è!ğ
»qQueueLim™
);

262 
Œªsm™Li¡
.
	`em¶aû_back
(
	`Deã¼edPack‘
(
pkt
, 
wh’
));

263 
	}
}

267 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$schedTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
)

273 ià(
Œªsm™Li¡
.
	`em±y
()) {

274 
£rŸl_lšk
.
	`scheduË
(
£ndEv’t
, 
wh’
);

277 
Œªsm™Li¡
.
	`em¶aû_back
(
	`Deã¼edPack‘
(
pkt
, 
wh’
));

278 
	}
}

281 
	gS”ŸlLšk
::
S”ŸlLškMa¡”PÜt
::
	$ŒyS’dTimšg
()

283 
	`as£¹
(!
Œªsm™Li¡
.
	`em±y
());

285 
Deã¼edPack‘
 
»q
 = 
Œªsm™Li¡
.
	`äÚt
();

287 
	`as£¹
(
»q
.
tick
 <ğ
	`curTick
());

289 
Pack‘PŒ
 
pkt
 = 
»q
.pkt;

291 
	`DPRINTF
(
S”ŸlLšk
, "trySend„equest‡ddr 0x%x, queue size %d\n",

292 
pkt
->
	`g‘Addr
(), 
Œªsm™Li¡
.
	`size
());

294 ià(
	`£ndTimšgReq
(
pkt
)) {

296 
Œªsm™Li¡
.
	`pİ_äÚt
();

298 
	`DPRINTF
(
S”ŸlLšk
, "trySend„equest successful\n");

301 ià(!
Œªsm™Li¡
.
	`em±y
()) {

302 
Deã¼edPack‘
 
Ãxt_»q
 = 
Œªsm™Li¡
.
	`äÚt
();

303 
	`DPRINTF
(
S”ŸlLšk
, "Scheduling‚ext send\n");

306 
Cyşes
 
cyşes
 = 
	`Cyşes
(
	`divCe
(
pkt
->
	`g‘Size
() * 8,

307 
£rŸl_lšk
.
num_ÏÃs
 * s”Ÿl_lšk.
lšk_¥“d
));

308 
Tick
 
t
 = 
£rŸl_lšk
.
	`şockEdge
(
cyşes
);

309 
£rŸl_lšk
.
	`scheduË
(
£ndEv’t
, 
¡d
::
	`max
(
Ãxt_»q
.
tick
, 
t
));

316 
¦avePÜt
.
	`»ŒySÎedReq
();

321 
	}
}

324 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$ŒyS’dTimšg
()

326 
	`as£¹
(!
Œªsm™Li¡
.
	`em±y
());

328 
Deã¼edPack‘
 
»¥
 = 
Œªsm™Li¡
.
	`äÚt
();

330 
	`as£¹
(
»¥
.
tick
 <ğ
	`curTick
());

332 
Pack‘PŒ
 
pkt
 = 
»¥
.pkt;

334 
	`DPRINTF
(
S”ŸlLšk
, "trySend„esponse‡ddr 0x%x, outstanding %d\n",

335 
pkt
->
	`g‘Addr
(), 
out¡ªdšgRe¥Ú£s
);

337 ià(
	`£ndTimšgRe¥
(
pkt
)) {

339 
Œªsm™Li¡
.
	`pİ_äÚt
();

340 
	`DPRINTF
(
S”ŸlLšk
, "trySend„esponse successful\n");

342 
	`as£¹
(
out¡ªdšgRe¥Ú£s
 != 0);

343 --
out¡ªdšgRe¥Ú£s
;

346 ià(!
Œªsm™Li¡
.
	`em±y
()) {

347 
Deã¼edPack‘
 
Ãxt_»¥
 = 
Œªsm™Li¡
.
	`äÚt
();

348 
	`DPRINTF
(
S”ŸlLšk
, "Scheduling‚ext send\n");

351 
Cyşes
 
cyşes
 = 
	`Cyşes
(
	`divCe
(
pkt
->
	`g‘Size
() * 8,

352 
£rŸl_lšk
.
num_ÏÃs
 * s”Ÿl_lšk.
lšk_¥“d
));

353 
Tick
 
t
 = 
£rŸl_lšk
.
	`şockEdge
(
cyşes
);

354 
£rŸl_lšk
.
	`scheduË
(
£ndEv’t
, 
¡d
::
	`max
(
Ãxt_»¥
.
tick
, 
t
));

360 ià(!
ma¡”PÜt
.
	`»qQueueFuÎ
(è&& 
»ŒyReq
) {

361 
	`DPRINTF
(
S”ŸlLšk
, "Request waiting for„etry,‚ow„etrying\n");

362 
»ŒyReq
 = 
çl£
;

363 
	`£ndR‘ryReq
();

369 
	}
}

372 
	gS”ŸlLšk
::
S”ŸlLškMa¡”PÜt
::
	$»cvReqR‘ry
()

374 
	`ŒyS’dTimšg
();

375 
	}
}

378 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$»cvRe¥R‘ry
()

380 
	`ŒyS’dTimšg
();

381 
	}
}

383 
Tick


384 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

386  
d–ay
 * 
£rŸl_lšk
.
	`şockP”iod
(è+ 
ma¡”PÜt
.
	`£ndAtomic
(
pkt
);

387 
	}
}

390 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

392 
pkt
->
	`pushLab–
(
	`Çme
());

395 autØ
i
 = 
Œªsm™Li¡
.
	`begš
(); i !ğŒªsm™Li¡.
	`’d
(); ++i) {

396 ià(
pkt
->
	`checkFunùiÚ®
((*
i
).pkt)) {

397 
pkt
->
	`makeRe¥Ú£
();

403 ià(
ma¡”PÜt
.
	`checkFunùiÚ®
(
pkt
)) {

407 
pkt
->
	`pİLab–
();

410 
ma¡”PÜt
.
	`£ndFunùiÚ®
(
pkt
);

411 
	}
}

413 
boŞ


414 
	gS”ŸlLšk
::
S”ŸlLškMa¡”PÜt
::
	$checkFunùiÚ®
(
Pack‘PŒ
 
pkt
)

416 
boŞ
 
found
 = 
çl£
;

417 autØ
i
 = 
Œªsm™Li¡
.
	`begš
();

419 
i
 !ğ
Œªsm™Li¡
.
	`’d
(è&& !
found
) {

420 ià(
pkt
->
	`checkFunùiÚ®
((*
i
).pkt)) {

421 
pkt
->
	`makeRe¥Ú£
();

422 
found
 = 
Œue
;

424 ++
i
;

427  
found
;

428 
	}
}

430 
AddrRªgeLi¡


431 
	gS”ŸlLšk
::
S”ŸlLškSÏvePÜt
::
	$g‘AddrRªges
() const

433  
¿nges
;

434 
	}
}

436 
S”ŸlLšk
 *

437 
	gS”ŸlLškP¬ams
::
	$ü—‹
()

439  
Ãw
 
	`S”ŸlLšk
(
this
);

440 
	}
}

	@serial_link.hh

53 #iâdeà
__MEM_SERIAL_LINK_HH__


54 
	#__MEM_SERIAL_LINK_HH__


	)

56 
	~<deque
>

58 
	~"ba£/ty³s.hh
"

59 
	~"mem/mem_objeù.hh
"

60 
	~"·¿ms/S”ŸlLšk.hh
"

69 şas 
	cS”ŸlLšk
 : 
public
 
MemObjeù


71 
´Ùeùed
:

77 şas 
	cDeã¼edPack‘


80 
public
:

82 cÚ¡ 
Tick
 
tick
;

83 cÚ¡ 
Pack‘PŒ
 
	mpkt
;

85 
Deã¼edPack‘
(
Pack‘PŒ
 
_pkt
, 
Tick
 
_tick
è: 
tick
(_tick), 
pkt
(_pkt)

90 
şass
 
	gS”ŸlLškMa¡”PÜt
;

98 şas 
	cS”ŸlLškSÏvePÜt
 : 
public
 
SÏvePÜt


101 
´iv©e
:

104 
S”ŸlLšk
& 
£rŸl_lšk
;

109 
	gS”ŸlLškMa¡”PÜt
& 
	gma¡”PÜt
;

112 cÚ¡ 
Cyşes
 
	gd–ay
;

115 cÚ¡ 
AddrRªgeLi¡
 
	g¿nges
;

123 
	g¡d
::
deque
<
Deã¼edPack‘
> 
Œªsm™Li¡
;

126 
	gout¡ªdšgRe¥Ú£s
;

129 
boŞ
 
	g»ŒyReq
;

132 
	g»¥QueueLim™
;

139 
boŞ
 
»¥QueueFuÎ
() const;

146 
ŒyS’dTimšg
();

149 
	gEv’tW¿µ”
<
	gS”ŸlLškSÏvePÜt
,

150 &
	gS”ŸlLškSÏvePÜt
::
ŒyS’dTimšg
> 
£ndEv’t
;

152 
	gpublic
:

165 
S”ŸlLškSÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
S”ŸlLšk
&

166 
_£rŸl_lšk
, 
S”ŸlLškMa¡”PÜt
& 
_ma¡”PÜt
,

167 
Cyşes
 
_d–ay
, 
_»¥_lim™
, const

168 
¡d
::
veùÜ
<
AddrRªge
>& 
_¿nges
);

177 
schedTimšgRe¥
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
);

184 
»ŒySÎedReq
();

186 
	g´Ùeùed
:

190 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

194 
»cvRe¥R‘ry
();

198 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

202 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

206 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

215 şas 
	cS”ŸlLškMa¡”PÜt
 : 
public
 
Ma¡”PÜt


218 
´iv©e
:

221 
S”ŸlLšk
& 
£rŸl_lšk
;

226 
	gS”ŸlLškSÏvePÜt
& 
	g¦avePÜt
;

229 cÚ¡ 
Cyşes
 
	gd–ay
;

237 
	g¡d
::
deque
<
Deã¼edPack‘
> 
Œªsm™Li¡
;

240 cÚ¡ 
	g»qQueueLim™
;

247 
ŒyS’dTimšg
();

250 
	gEv’tW¿µ”
<
	gS”ŸlLškMa¡”PÜt
,

251 &
	gS”ŸlLškMa¡”PÜt
::
ŒyS’dTimšg
> 
£ndEv’t
;

253 
	gpublic
:

265 
S”ŸlLškMa¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
S”ŸlLšk
&

266 
_£rŸl_lšk
, 
S”ŸlLškSÏvePÜt
& 
_¦avePÜt
, 
Cyşes


267 
_d–ay
, 
_»q_lim™
);

274 
boŞ
 
»qQueueFuÎ
() const;

283 
schedTimšgReq
(
Pack‘PŒ
 
pkt
, 
Tick
 
wh’
);

293 
boŞ
 
checkFunùiÚ®
(
Pack‘PŒ
 
pkt
);

295 
	g´Ùeùed
:

299 
boŞ
 
»cvTimšgRe¥
(
Pack‘PŒ
 
pkt
);

303 
»cvReqR‘ry
();

307 
S”ŸlLškSÏvePÜt
 
	g¦avePÜt
;

310 
S”ŸlLškMa¡”PÜt
 
	gma¡”PÜt
;

313 
	gnum_ÏÃs
;

316 
ušt64_t
 
	glšk_¥“d
;

318 
	gpublic
:

320 
vœtu®
 
Ba£Ma¡”PÜt
& 
g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

321 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

322 
vœtu®
 
	gBa£SÏvePÜt
& 
g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

323 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

325 
vœtu®
 
š™
();

327 
S”ŸlLškP¬ams
 
	tP¬ams
;

329 
S”ŸlLšk
(
S”ŸlLškP¬ams
 *
p
);

	@simple_mem.cc

45 
	~"ba£/¿ndom.hh
"

46 
	~"mem/sim¶e_mem.hh
"

47 
	~"debug/D¿š.hh
"

49 
usšg
 
Çme¥aû
 
	g¡d
;

51 
	gSim¶eMemÜy
::
	$Sim¶eMemÜy
(cÚ¡ 
Sim¶eMemÜyP¬ams
* 
p
) :

52 
	`Ab¡¿ùMemÜy
(
p
),

53 
	`pÜt
(
	`Çme
(è+ ".pÜt", *
this
), 
	`Ï‹ncy
(
p
->
Ï‹ncy
),

54 
	`Ï‹ncy_v¬
(
p
->
Ï‹ncy_v¬
), 
	`bªdwidth
Õ->
bªdwidth
), 
	`isBusy
(
çl£
),

55 
	`»ŒyReq
(
çl£
), 
	`»ŒyRe¥
(false),

56 
	`»Ëa£Ev’t
(
this
), 
	$dequeueEv’t
(
this
)

58 
	}
}

61 
	gSim¶eMemÜy
::
	$š™
()

63 
Ab¡¿ùMemÜy
::
	`š™
();

67 ià(
pÜt
.
	`isCÚÃùed
()) {

68 
pÜt
.
	`£ndRªgeChªge
();

70 
	}
}

72 
Tick


73 
	gSim¶eMemÜy
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

75 
	`·nic_if
(
pkt
->
	`ÿcheRe¥Údšg
(), "Should‚ot see…ackets where cache "

78 
	`acûss
(
pkt
);

79  
	`g‘L©’cy
();

80 
	}
}

83 
	gSim¶eMemÜy
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

85 
pkt
->
	`pushLab–
(
	`Çme
());

87 
	`funùiÚ®Acûss
(
pkt
);

89 
boŞ
 
dÚe
 = 
çl£
;

90 autØ
p
 = 
·ck‘Queue
.
	`begš
();

92 !
dÚe
 && 
p
 !ğ
·ck‘Queue
.
	`’d
()) {

93 
dÚe
 = 
pkt
->
	`checkFunùiÚ®
(
p
->pkt);

94 ++
p
;

97 
pkt
->
	`pİLab–
();

98 
	}
}

100 
boŞ


101 
	gSim¶eMemÜy
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

103 
	`·nic_if
(
pkt
->
	`ÿcheRe¥Údšg
(), "Should‚ot see…ackets where cache "

106 
	`·nic_if
(!(
pkt
->
	`isR—d
(è||…kt->
	`isWr™e
()),

108 "§w % tØ%#Îx\n", 
pkt
->
	`cmdSŒšg
(),…kt->
	`g‘Addr
());

113 ià(
»ŒyReq
)

114  
çl£
;

118 ià(
isBusy
) {

119 
»ŒyReq
 = 
Œue
;

120  
çl£
;

126 
Tick
 
»ûive_d–ay
 = 
pkt
->
h—d”D–ay
 +…kt->
·ylßdD–ay
;

127 
pkt
->
h—d”D–ay
 =…kt->
·ylßdD–ay
 = 0;

136 
Tick
 
du¿tiÚ
 = 
pkt
->
	`g‘Size
(è* 
bªdwidth
;

141 ià(
du¿tiÚ
 != 0) {

142 
	`scheduË
(
»Ëa£Ev’t
, 
	`curTick
(è+ 
du¿tiÚ
);

143 
isBusy
 = 
Œue
;

148 
boŞ
 
ÃedsRe¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

149 
	`»cvAtomic
(
pkt
);

151 ià(
ÃedsRe¥Ú£
) {

154 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

156 
Tick
 
wh’_to_£nd
 = 
	`curTick
(è+ 
»ûive_d–ay
 + 
	`g‘L©’cy
();

163 autØ
i
 = 
·ck‘Queue
.
	`’d
();

164 --
i
;

165 
i
 !ğ
·ck‘Queue
.
	`begš
(è&& 
wh’_to_£nd
 < i->
tick
 &&

166 
i
->
pkt
->
	`g‘Addr
() !=…kt->getAddr())

167 --
i
;

171 
·ck‘Queue
.
	`em¶aû
(++
i
, 
pkt
, 
wh’_to_£nd
);

173 ià(!
»ŒyRe¥
 && !
dequeueEv’t
.
	`scheduËd
())

174 
	`scheduË
(
dequeueEv’t
, 
·ck‘Queue
.
	`back
().
tick
);

176 
³ndšgD–‘e
.
	`»£t
(
pkt
);

179  
Œue
;

180 
	}
}

183 
	gSim¶eMemÜy
::
	$»Ëa£
()

185 
	`as£¹
(
isBusy
);

186 
isBusy
 = 
çl£
;

187 ià(
»ŒyReq
) {

188 
»ŒyReq
 = 
çl£
;

189 
pÜt
.
	`£ndR‘ryReq
();

191 
	}
}

194 
	gSim¶eMemÜy
::
	$dequeue
()

196 
	`as£¹
(!
·ck‘Queue
.
	`em±y
());

197 
Deã¼edPack‘
 
deã¼ed_pkt
 = 
·ck‘Queue
.
	`äÚt
();

199 
»ŒyRe¥
 = !
pÜt
.
	`£ndTimšgRe¥
(
deã¼ed_pkt
.
pkt
);

201 ià(!
»ŒyRe¥
) {

202 
·ck‘Queue
.
	`pİ_äÚt
();

206 ià(!
·ck‘Queue
.
	`em±y
()) {

209 
	`»scheduË
(
dequeueEv’t
,

210 
¡d
::
	`max
(
·ck‘Queue
.
	`äÚt
().
tick
, 
	`curTick
()), 
Œue
);

211 } ià(
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
) {

212 
	`DPRINTF
(
D¿š
, "Draining of SimpleMemory complete\n");

213 
	`sigÇlD¿šDÚe
();

216 
	}
}

218 
Tick


219 
	gSim¶eMemÜy
::
	$g‘L©’cy
() const

221  
Ï‹ncy
 +

222 (
Ï‹ncy_v¬
 ? 
¿ndom_mt
.
¿ndom
<
Tick
>(0,†atency_var) : 0);

223 
	}
}

226 
	gSim¶eMemÜy
::
	$»cvRe¥R‘ry
()

228 
	`as£¹
(
»ŒyRe¥
);

230 
	`dequeue
();

231 
	}
}

233 
	gBa£SÏvePÜt
 &

234 
	gSim¶eMemÜy
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

236 ià(
if_Çme
 != "port") {

237  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

239  
pÜt
;

241 
	}
}

243 
D¿šS‹


244 
	gSim¶eMemÜy
::
	$d¿š
()

246 ià(!
·ck‘Queue
.
	`em±y
()) {

247 
	`DPRINTF
(
D¿š
, "SimpleMemory Queue has„equests, waitingo drain\n");

248  
D¿šS‹
::
D¿ššg
;

250  
D¿šS‹
::
D¿šed
;

252 
	}
}

254 
	gSim¶eMemÜy
::
MemÜyPÜt
::
	$MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
,

255 
Sim¶eMemÜy
& 
_memÜy
)

256 : 
	`SÏvePÜt
(
_Çme
, &
_memÜy
), 
	$memÜy
(
_memÜy
)

257 { 
	}
}

259 
AddrRªgeLi¡


260 
	gSim¶eMemÜy
::
MemÜyPÜt
::
	$g‘AddrRªges
() const

262 
AddrRªgeLi¡
 
¿nges
;

263 
¿nges
.
	`push_back
(
memÜy
.
	`g‘AddrRªge
());

264  
¿nges
;

265 
	}
}

267 
Tick


268 
	gSim¶eMemÜy
::
MemÜyPÜt
::
	$»cvAtomic
(
Pack‘PŒ
 
pkt
)

270  
memÜy
.
	`»cvAtomic
(
pkt
);

271 
	}
}

274 
	gSim¶eMemÜy
::
MemÜyPÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

276 
memÜy
.
	`»cvFunùiÚ®
(
pkt
);

277 
	}
}

279 
boŞ


280 
	gSim¶eMemÜy
::
MemÜyPÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

282  
memÜy
.
	`»cvTimšgReq
(
pkt
);

283 
	}
}

286 
	gSim¶eMemÜy
::
MemÜyPÜt
::
	$»cvRe¥R‘ry
()

288 
memÜy
.
	`»cvRe¥R‘ry
();

289 
	}
}

291 
Sim¶eMemÜy
*

292 
	gSim¶eMemÜyP¬ams
::
	$ü—‹
()

294  
Ãw
 
	`Sim¶eMemÜy
(
this
);

295 
	}
}

	@simple_mem.hh

49 #iâdeà
__SIMPLE_MEMORY_HH__


50 
	#__SIMPLE_MEMORY_HH__


	)

52 
	~<li¡
>

54 
	~"mem/ab¡¿ù_mem.hh
"

55 
	~"mem/pÜt.hh
"

56 
	~"·¿ms/Sim¶eMemÜy.hh
"

64 şas 
	cSim¶eMemÜy
 : 
public
 
Ab¡¿ùMemÜy


67 
´iv©e
:

73 şas 
	cDeã¼edPack‘


76 
public
:

78 cÚ¡ 
Tick
 
tick
;

79 cÚ¡ 
Pack‘PŒ
 
	mpkt
;

81 
Deã¼edPack‘
(
Pack‘PŒ
 
_pkt
, 
Tick
 
_tick
è: 
tick
(_tick), 
pkt
(_pkt)

85 şas 
	cMemÜyPÜt
 : 
public
 
SÏvePÜt


88 
´iv©e
:

90 
Sim¶eMemÜy
& 
memÜy
;

92 
	gpublic
:

94 
MemÜyPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
, 
Sim¶eMemÜy
& 
_memÜy
);

96 
	g´Ùeùed
:

98 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
);

100 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

102 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

104 
»cvRe¥R‘ry
();

106 
AddrRªgeLi¡
 
g‘AddrRªges
() const;

110 
MemÜyPÜt
 
	gpÜt
;

116 cÚ¡ 
Tick
 
	gÏ‹ncy
;

121 cÚ¡ 
Tick
 
	gÏ‹ncy_v¬
;

128 
	g¡d
::
li¡
<
Deã¼edPack‘
> 
·ck‘Queue
;

135 cÚ¡ 
	gbªdwidth
;

141 
boŞ
 
	gisBusy
;

147 
boŞ
 
	g»ŒyReq
;

153 
boŞ
 
	g»ŒyRe¥
;

159 
»Ëa£
();

161 
	gEv’tW¿µ”
<
	gSim¶eMemÜy
, &Sim¶eMemÜy::
»Ëa£
> 
»Ëa£Ev’t
;

167 
dequeue
();

169 
	gEv’tW¿µ”
<
	gSim¶eMemÜy
, &Sim¶eMemÜy::
dequeue
> 
dequeueEv’t
;

176 
Tick
 
	$g‘L©’cy
() const;

182 
¡d
::
unique_±r
<
Pack‘
> 
³ndšgD–‘e
;

184 
public
:

186 
	`Sim¶eMemÜy
(cÚ¡ 
Sim¶eMemÜyP¬ams
 *
p
);

188 
D¿šS‹
 
	$d¿š
(è
ov”ride
;

190 
Ba£SÏvePÜt
& 
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

191 
PÜtID
 
idx
 = 
Inv®idPÜtID
è
ov”ride
;

192 
	$š™
(è
ov”ride
;

194 
´Ùeùed
:

196 
Tick
 
	`»cvAtomic
(
Pack‘PŒ
 
pkt
);

198 
	`»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

200 
boŞ
 
	`»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

202 
	`»cvRe¥R‘ry
();

204 
	}
};

	@snoop_filter.cc

45 
	~"ba£/misc.hh
"

46 
	~"ba£/Œaû.hh
"

47 
	~"debug/SnoİF‹r.hh
"

48 
	~"mem/¢oİ_f‹r.hh
"

49 
	~"sim/sy¡em.hh
"

52 
	gSnoİF‹r
::
	$”a£IfNuÎEÁry
(
SnoİF‹rCache
::
™”©Ü
& 
sf_™
)

54 
SnoİI‹m
& 
sf_™em
 = 
sf_™
->
£cÚd
;

55 ià(!(
sf_™em
.
»que¡ed
 | sf_™em.
hŞd”
)) {

56 
ÿchedLoÿtiÚs
.
	`”a£
(
sf_™
);

57 
	`DPRINTF
(
SnoİF‹r
, "%s: Removed SFƒntry.\n",

58 
__func__
);

60 
	}
}

62 
	g¡d
::
·œ
<
SnoİF‹r
::
SnoİLi¡
, 
	gCyşes
>

63 
	gSnoİF‹r
::
	$lookupReque¡
(cÚ¡ 
Pack‘
* 
ıkt
, cÚ¡ 
SÏvePÜt
& 
¦ave_pÜt
)

65 
	`DPRINTF
(
SnoİF‹r
, "%s:…acket src %s‡ddr 0x%x cmd %s\n",

66 
__func__
, 
¦ave_pÜt
.
	`Çme
(), 
ıkt
->
	`g‘Addr
(), cpkt->
	`cmdSŒšg
());

69 
boŞ
 
®loÿ‹
 = !
ıkt
->
»q
->
	`isUnÿch—bË
(è&& 
¦ave_pÜt
.
	`isSnoİšg
() &&

70 
ıkt
->
	`äomCache
();

71 
Addr
 
lše_addr
 = 
ıkt
->
	`g‘BlockAddr
(
lšesize
);

72 ià(
ıkt
->
	`isSecu»
()) {

73 
lše_addr
 |ğ
LšeSecu»
;

75 
SnoİMask
 
»q_pÜt
 = 
	`pÜtToMask
(
¦ave_pÜt
);

76 
»qLookupResuÉ
 = 
ÿchedLoÿtiÚs
.
	`fšd
(
lše_addr
);

77 
boŞ
 
is_h™
 = (
»qLookupResuÉ
 !ğ
ÿchedLoÿtiÚs
.
	`’d
());

82 ià(!
is_h™
 && !
®loÿ‹
)

83  
	`¢oİDown
(
lookupL©’cy
);

86 ià(!
is_h™
)

87 
»qLookupResuÉ
 = 
ÿchedLoÿtiÚs
.
	`em¶aû
(
lše_addr
, 
	`SnoİI‹m
()).
fœ¡
;

88 
SnoİI‹m
& 
sf_™em
 = 
»qLookupResuÉ
->
£cÚd
;

89 
SnoİMask
 
š‹»¡ed
 = 
sf_™em
.
hŞd”
 | sf_™em.
»que¡ed
;

94 
»ŒyI‹m
 = 
sf_™em
;

96 
tÙReque¡s
++;

97 ià(
is_h™
) {

99 ià(
	`isPow2
(
š‹»¡ed
))

100 
h™SšgËReque¡s
++;

102 
h™MuÉiReque¡s
++;

105 
	`DPRINTF
(
SnoİF‹r
, "%s: SF value %x.%x\n",

106 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

109 ià(!
®loÿ‹
)

110  
	`¢oİS–eùed
(
	`maskToPÜtLi¡
(
š‹»¡ed
 & ~
»q_pÜt
),

111 
lookupL©’cy
);

113 ià(
ıkt
->
	`ÃedsRe¥Ú£
()) {

114 ià(!
ıkt
->
	`ÿcheRe¥Údšg
()) {

116 
	`·nic_if
(
sf_™em
.
»que¡ed
 & 
»q_pÜt
, "double„equest :( " \

117 "SF v®u%x.%x\n", 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

120 
sf_™em
.
»que¡ed
 |ğ
»q_pÜt
;

121 
	`DPRINTF
(
SnoİF‹r
, "%s:‚ew SF value %x.%x\n",

122 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

128 
	`·nic_if
(!(
sf_™em
.
hŞd”
 & 
»q_pÜt
), "Needo holdhe value!");

129 
	`DPRINTF
(
SnoİF‹r
,

131 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

134 
	`as£¹
(
ıkt
->
	`isEviùiÚ
());

136 
	`·nic_if
(!(
sf_™em
.
hŞd”
 & 
»q_pÜt
), "requester %x is‚ot‡ " \

137 "hŞd” :ĞSF v®u%x.%x\n", 
»q_pÜt
,

138 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

141 ià(!
ıkt
->
	`isBlockCached
()) {

142 
sf_™em
.
hŞd”
 &ğ~
»q_pÜt
;

143 
	`DPRINTF
(
SnoİF‹r
, "%s:‚ew SF value %x.%x\n",

144 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

148  
	`¢oİS–eùed
(
	`maskToPÜtLi¡
(
š‹»¡ed
 & ~
»q_pÜt
), 
lookupL©’cy
);

149 
	}
}

152 
	gSnoİF‹r
::
	$fšishReque¡
(
boŞ
 
wl_»Œy
, 
Addr
 
addr
, boŞ 
is_£cu»
)

154 ià(
»qLookupResuÉ
 !ğ
ÿchedLoÿtiÚs
.
	`’d
()) {

157 
Addr
 
lše_addr
 = (
addr
 & ~(
	`Addr
(
lšesize
 - 1)));

158 ià(
is_£cu»
) {

159 
lše_addr
 |ğ
LšeSecu»
;

161 
	`as£¹
(
»qLookupResuÉ
->
fœ¡
 =ğ
lše_addr
);

162 ià(
wl_»Œy
) {

166 
»qLookupResuÉ
->
£cÚd
 = 
»ŒyI‹m
;

168 
	`DPRINTF
(
SnoİF‹r
, "%s:„estored SF value %x.%x\n",

169 
__func__
, 
»ŒyI‹m
.
»que¡ed
,„‘ryI‹m.
hŞd”
);

172 
	`”a£IfNuÎEÁry
(
»qLookupResuÉ
);

174 
	}
}

176 
	g¡d
::
·œ
<
SnoİF‹r
::
SnoİLi¡
, 
	gCyşes
>

177 
	gSnoİF‹r
::
	$lookupSnoİ
(cÚ¡ 
Pack‘
* 
ıkt
)

179 
	`DPRINTF
(
SnoİF‹r
, "%s:…acket‡ddr 0x%x cmd %s\n",

180 
__func__
, 
ıkt
->
	`g‘Addr
(), cpkt->
	`cmdSŒšg
());

182 
	`as£¹
(
ıkt
->
	`isReque¡
());

184 
Addr
 
lše_addr
 = 
ıkt
->
	`g‘BlockAddr
(
lšesize
);

185 ià(
ıkt
->
	`isSecu»
()) {

186 
lše_addr
 |ğ
LšeSecu»
;

188 autØ
sf_™
 = 
ÿchedLoÿtiÚs
.
	`fšd
(
lše_addr
);

189 
boŞ
 
is_h™
 = (
sf_™
 !ğ
ÿchedLoÿtiÚs
.
	`’d
());

191 
	`·nic_if
(!
is_h™
 && (
ÿchedLoÿtiÚs
.
	`size
(è>ğ
maxEÁryCouÁ
),

193 
maxEÁryCouÁ
);

198 ià(!
is_h™
)

199  
	`¢oİDown
(
lookupL©’cy
);

201 
SnoİI‹m
& 
sf_™em
 = 
sf_™
->
£cÚd
;

203 
	`DPRINTF
(
SnoİF‹r
, "%s: old SF value %x.%x\n",

204 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

206 
SnoİMask
 
š‹»¡ed
 = (
sf_™em
.
hŞd”
 | sf_™em.
»que¡ed
);

208 
tÙSnoİs
++;

210 ià(
	`isPow2
(
š‹»¡ed
))

211 
h™SšgËSnoİs
++;

213 
h™MuÉiSnoİs
++;

220 
	`as£¹
(
ıkt
->
	`isWr™eback
(è|| cpkt->
»q
->
	`isUnÿch—bË
() ||

221 (
ıkt
->
	`isInv®id©e
(è=ğıkt->
	`ÃedsWr™abË
()));

222 ià(
ıkt
->
	`isInv®id©e
(è&& !
sf_™em
.
»que¡ed
) {

226 
sf_™em
.
hŞd”
 = 0;

229 
	`”a£IfNuÎEÁry
(
sf_™
);

230 
	`DPRINTF
(
SnoİF‹r
, "%s:‚ew SF value %x.%x interest: %x \n",

231 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
, 
š‹»¡ed
);

233  
	`¢oİS–eùed
(
	`maskToPÜtLi¡
(
š‹»¡ed
), 
lookupL©’cy
);

234 
	}
}

237 
	gSnoİF‹r
::
	$upd©eSnoİRe¥Ú£
(cÚ¡ 
Pack‘
* 
ıkt
,

238 cÚ¡ 
SÏvePÜt
& 
r¥_pÜt
,

239 cÚ¡ 
SÏvePÜt
& 
»q_pÜt
)

241 
	`DPRINTF
(
SnoİF‹r
, "%s:…acket„sp %s„eq %s‡ddr 0x%x cmd %s\n",

242 
__func__
, 
r¥_pÜt
.
	`Çme
(), 
»q_pÜt
.Çme(), 
ıkt
->
	`g‘Addr
(),

243 
ıkt
->
	`cmdSŒšg
());

245 
	`as£¹
(
ıkt
->
	`isRe¥Ú£
());

246 
	`as£¹
(
ıkt
->
	`ÿcheRe¥Údšg
());

251 ià(
ıkt
->
»q
->
	`isUnÿch—bË
(è|| !
»q_pÜt
.
	`isSnoİšg
()) {

255 
Addr
 
lše_addr
 = 
ıkt
->
	`g‘BlockAddr
(
lšesize
);

256 ià(
ıkt
->
	`isSecu»
()) {

257 
lše_addr
 |ğ
LšeSecu»
;

259 
SnoİMask
 
r¥_mask
 = 
	`pÜtToMask
(
r¥_pÜt
);

260 
SnoİMask
 
»q_mask
 = 
	`pÜtToMask
(
»q_pÜt
);

261 
SnoİI‹m
& 
sf_™em
 = 
ÿchedLoÿtiÚs
[
lše_addr
];

263 
	`DPRINTF
(
SnoİF‹r
, "%s: old SF value %x.%x\n",

264 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

267 
	`·nic_if
(!(
sf_™em
.
hŞd”
 & 
r¥_mask
), "SF value %x.%x does‚ot have "\

268 "thlše\n", 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

271 
	`·nic_if
(!(
sf_™em
.
»que¡ed
 & 
»q_mask
), "SF value %x.%x missing "\

272 "thÜigš®„eque¡\n", 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

277 ià(!
ıkt
->
	`hasSh¬”s
()) {

278 
	`DPRINTF
(
SnoİF‹r
,

280 "»¥Ú£ SF v®: %x.%x\n", 
__func__
, 
r¥_mask
,

281 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

282 
sf_™em
.
hŞd”
 = 0;

284 
	`as£¹
(!
ıkt
->
	`isWr™eback
());

286 
sf_™em
.
hŞd”
 |ğ
»q_mask
;

287 
sf_™em
.
»que¡ed
 &ğ~
»q_mask
;

288 
	`as£¹
(
sf_™em
.
»que¡ed
 | sf_™em.
hŞd”
);

289 
	`DPRINTF
(
SnoİF‹r
, "%s:‚ew SF value %x.%x\n",

290 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

291 
	}
}

294 
	gSnoİF‹r
::
	$upd©eSnoİFÜw¬d
(cÚ¡ 
Pack‘
* 
ıkt
,

295 cÚ¡ 
SÏvePÜt
& 
r¥_pÜt
, cÚ¡ 
Ma¡”PÜt
& 
»q_pÜt
)

297 
	`DPRINTF
(
SnoİF‹r
, "%s:…acket„sp %s„eq %s‡ddr 0x%x cmd %s\n",

298 
__func__
, 
r¥_pÜt
.
	`Çme
(), 
»q_pÜt
.Çme(), 
ıkt
->
	`g‘Addr
(),

299 
ıkt
->
	`cmdSŒšg
());

301 
	`as£¹
(
ıkt
->
	`isRe¥Ú£
());

302 
	`as£¹
(
ıkt
->
	`ÿcheRe¥Údšg
());

304 
Addr
 
lše_addr
 = 
ıkt
->
	`g‘BlockAddr
(
lšesize
);

305 ià(
ıkt
->
	`isSecu»
()) {

306 
lše_addr
 |ğ
LšeSecu»
;

308 autØ
sf_™
 = 
ÿchedLoÿtiÚs
.
	`fšd
(
lše_addr
);

309 
boŞ
 
is_h™
 = 
sf_™
 !ğ
ÿchedLoÿtiÚs
.
	`’d
();

312 ià(!
is_h™
)

315 
SnoİI‹m
& 
sf_™em
 = 
sf_™
->
£cÚd
;

317 
	`DPRINTF
(
SnoİF‹r
, "%s: old SF value %x.%x\n",

318 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

323 ià(!
ıkt
->
	`hasSh¬”s
()) {

324 
sf_™em
.
hŞd”
 = 0;

326 
	`DPRINTF
(
SnoİF‹r
, "%s:‚ew SF value %x.%x\n",

327 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

328 
	`”a£IfNuÎEÁry
(
sf_™
);

330 
	}
}

333 
	gSnoİF‹r
::
	$upd©eRe¥Ú£
(cÚ¡ 
Pack‘
* 
ıkt
, cÚ¡ 
SÏvePÜt
& 
¦ave_pÜt
)

335 
	`DPRINTF
(
SnoİF‹r
, "%s:…acket src %s‡ddr 0x%x cmd %s\n",

336 
__func__
, 
¦ave_pÜt
.
	`Çme
(), 
ıkt
->
	`g‘Addr
(), cpkt->
	`cmdSŒšg
());

338 
	`as£¹
(
ıkt
->
	`isRe¥Ú£
());

342 ià(
ıkt
->
»q
->
	`isUnÿch—bË
(è|| !
¦ave_pÜt
.
	`isSnoİšg
())

346 
Addr
 
lše_addr
 = 
ıkt
->
	`g‘BlockAddr
(
lšesize
);

347 ià(
ıkt
->
	`isSecu»
()) {

348 
lše_addr
 |ğ
LšeSecu»
;

350 autØ
sf_™
 = 
ÿchedLoÿtiÚs
.
	`fšd
(
lše_addr
);

351 ià(
sf_™
 =ğ
ÿchedLoÿtiÚs
.
	`’d
())

354 
SnoİMask
 
¦ave_mask
 = 
	`pÜtToMask
(
¦ave_pÜt
);

355 
SnoİI‹m
& 
sf_™em
 = 
sf_™
->
£cÚd
;

357 
	`DPRINTF
(
SnoİF‹r
, "%s: old SF value %x.%x\n",

358 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

361 
	`·nic_if
(!(
sf_™em
.
»que¡ed
 & 
¦ave_mask
), "SF value %x.%x missing "\

362 "»que¡ b™\n", 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

367 ià(!
ıkt
->
	`hasSh¬”s
())

368 
sf_™em
.
hŞd”
 = 0;

369 
sf_™em
.
hŞd”
 |ğ
¦ave_mask
;

370 
sf_™em
.
»que¡ed
 &ğ~
¦ave_mask
;

371 
	`as£¹
(
sf_™em
.
hŞd”
 | sf_™em.
»que¡ed
);

372 
	`DPRINTF
(
SnoİF‹r
, "%s:‚ew SF value %x.%x\n",

373 
__func__
, 
sf_™em
.
»que¡ed
, sf_™em.
hŞd”
);

374 
	}
}

377 
	gSnoİF‹r
::
	$»gSts
()

379 
SimObjeù
::
	`»gSts
();

381 
tÙReque¡s


382 .
	`Çme
(name() + ".tot_requests")

383 .
	`desc
("Total‚umber of„equests madeohe snoop filter.");

385 
h™SšgËReque¡s


386 .
	`Çme
(name() + ".hit_single_requests")

387 .
	`desc
("Number of„equests hitting inhe snoop filter with‡ single "\

390 
h™MuÉiReque¡s


391 .
	`Çme
(name() + ".hit_multi_requests")

392 .
	`desc
("Number of„equests hitting inhe snoop filter with multiple "\

395 
tÙSnoİs


396 .
	`Çme
(name() + ".tot_snoops")

397 .
	`desc
("Total‚umber of snoops madeohe snoop filter.");

399 
h™SšgËSnoİs


400 .
	`Çme
(name() + ".hit_single_snoops")

401 .
	`desc
("Number of snoops hitting inhe snoop filter with‡ single "\

404 
h™MuÉiSnoİs


405 .
	`Çme
(name() + ".hit_multi_snoops")

406 .
	`desc
("Number of snoops hitting inhe snoop filter with multiple "\

408 
	}
}

410 
SnoİF‹r
 *

411 
	gSnoİF‹rP¬ams
::
	$ü—‹
()

413  
Ãw
 
	`SnoİF‹r
(
this
);

414 
	}
}

	@snoop_filter.hh

45 #iâdeà
__MEM_SNOOP_FILTER_HH__


46 
	#__MEM_SNOOP_FILTER_HH__


	)

48 
	~<unÜd”ed_m­
>

49 
	~<ut™y
>

51 
	~"mem/·ck‘.hh
"

52 
	~"mem/pÜt.hh
"

53 
	~"mem/qpÜt.hh
"

54 
	~"·¿ms/SnoİF‹r.hh
"

55 
	~"sim/sim_objeù.hh
"

56 
	~"sim/sy¡em.hh
"

87 şas 
	cSnoİF‹r
 : 
public
 
SimObjeù
 {

88 
public
:

89 
¡d
::
	tveùÜ
<
	tQueuedSÏvePÜt
*> 
	tSnoİLi¡
;

91 
	$SnoİF‹r
 (cÚ¡ 
SnoİF‹rP¬ams
 *
p
) :

92 
	`SimObjeù
(
p
), 
	`»qLookupResuÉ
(
ÿchedLoÿtiÚs
.
	`’d
()), 
»ŒyI‹m
{0, 0},

93 
	`lšesize
(
p
->
sy¡em
->
	`ÿcheLšeSize
()), 
	`lookupL©’cy
Õ->
lookup_Ï‹ncy
),

94 
	`maxEÁryCouÁ
(
p
->
max_ÿ·c™y
 /…->
sy¡em
->
	$ÿcheLšeSize
())

96 
	}
}

104 
	$£tSÏvePÜts
(cÚ¡ 
SnoİLi¡
& 
¦ave_pÜts
) {

105 
loÿlSÏvePÜtIds
.
	`»size
(
¦ave_pÜts
.
	`size
(), 
Inv®idPÜtID
);

107 
PÜtID
 
id
 = 0;

108 cÚ¡‡uto& 
p
 : 
¦ave_pÜts
) {

110 ià(
p
->
	`isSnoİšg
()) {

111 
¦avePÜts
.
	`push_back
(
p
);

112 
loÿlSÏvePÜtIds
[
p
->
	`g‘Id
()] = 
id
++;

117 
	`çl_if
(
id
 > 8 * (
SnoİMask
),

119 8 * (
SnoİMask
), 
id
);

120 
	}
}

134 
	g¡d
::
·œ
<
SnoİLi¡
, 
	gCyşes
> 
lookupReque¡
(cÚ¡ 
Pack‘
* 
ıkt
,

135 cÚ¡ 
SÏvePÜt
& 
¦ave_pÜt
);

146 
fšishReque¡
(
boŞ
 
wl_»Œy
, 
Addr
 
addr
, boŞ 
is_£cu»
);

157 
	g¡d
::
·œ
<
SnoİLi¡
, 
	gCyşes
> 
lookupSnoİ
(cÚ¡ 
Pack‘
* 
ıkt
);

169 
upd©eSnoİRe¥Ú£
(cÚ¡ 
Pack‘
 *
ıkt
, cÚ¡ 
SÏvePÜt
& 
r¥_pÜt
,

170 cÚ¡ 
SÏvePÜt
& 
»q_pÜt
);

181 
upd©eSnoİFÜw¬d
(cÚ¡ 
Pack‘
 *
ıkt
, cÚ¡ 
SÏvePÜt
& 
r¥_pÜt
,

182 cÚ¡ 
Ma¡”PÜt
& 
»q_pÜt
);

193 
upd©eRe¥Ú£
(cÚ¡ 
Pack‘
 *
ıkt
, cÚ¡ 
SÏvePÜt
& 
¦ave_pÜt
);

195 
vœtu®
 
»gSts
();

197 
	g´Ùeùed
:

207 
ušt64_t
 
	tSnoİMask
;

214 
	sSnoİI‹m
 {

215 
SnoİMask
 
	g»que¡ed
;

216 
SnoİMask
 
	ghŞd”
;

221 
	g¡d
::
	tunÜd”ed_m­
<
	tAddr
, 
	tSnoİI‹m
> 
	tSnoİF‹rCache
;

226 
	g¡d
::
·œ
<
SnoİLi¡
, 
	gCyşes
> 
	$¢oİAÎ
(
Cyşes
 
Ï‹ncy
) const

228  
¡d
::
	`make_·œ
(
¦avePÜts
, 
Ï‹ncy
);

229 
	}
}

230 
	g¡d
::
·œ
<
SnoİLi¡
, 
	gCyşes
> 
	$¢oİS–eùed
(cÚ¡ 
SnoİLi¡
& 
¦ave_pÜts
,

231 
Cyşes
 
Ï‹ncy
) const

233  
¡d
::
	`make_·œ
(
¦ave_pÜts
, 
Ï‹ncy
);

234 
	}
}

235 
	g¡d
::
·œ
<
SnoİLi¡
, 
	gCyşes
> 
	$¢oİDown
(
Cyşes
 
Ï‹ncy
) const

237 
SnoİLi¡
 
em±y
;

238  
¡d
::
	`make_·œ
(
em±y
 , 
Ï‹ncy
);

239 
	}
}

246 
SnoİMask
 
	$pÜtToMask
(cÚ¡ 
SÏvePÜt
& 
pÜt
) const;

252 
SnoİLi¡
 
	$maskToPÜtLi¡
(
SnoİMask
 
pÜts
) const;

254 
´iv©e
:

259 
	`”a£IfNuÎEÁry
(
SnoİF‹rCache
::
™”©Ü
& 
sf_™
);

262 
SnoİF‹rCache
 
ÿchedLoÿtiÚs
;

267 
SnoİF‹rCache
::
™”©Ü
 
»qLookupResuÉ
;

273 
SnoİI‹m
 
»ŒyI‹m
;

275 
SnoİLi¡
 
¦avePÜts
;

277 
¡d
::
veùÜ
<
PÜtID
> 
loÿlSÏvePÜtIds
;

279 cÚ¡ 
lšesize
;

281 cÚ¡ 
Cyşes
 
lookupL©’cy
;

283 cÚ¡ 
maxEÁryCouÁ
;

288 
	eLšeStus
 {

290 
LšeSecu»
 = 0x01,

291 
	}
};

294 
	gSts
::
SÿÏr
 
tÙReque¡s
;

295 
	gSts
::
SÿÏr
 
h™SšgËReque¡s
;

296 
	gSts
::
SÿÏr
 
h™MuÉiReque¡s
;

298 
	gSts
::
SÿÏr
 
tÙSnoİs
;

299 
	gSts
::
SÿÏr
 
h™SšgËSnoİs
;

300 
	gSts
::
SÿÏr
 
h™MuÉiSnoİs
;

303 
šlše
 
	gSnoİF‹r
::
SnoİMask


304 
SnoİF‹r
::
	$pÜtToMask
(cÚ¡ 
SÏvePÜt
& 
pÜt
) const

306 
	`as£¹
(
pÜt
.
	`g‘Id
(è!ğ
Inv®idPÜtID
);

308  !
pÜt
.
	`isSnoİšg
() ? 0 :

309 ((
SnoİMask
)1è<< 
loÿlSÏvePÜtIds
[
pÜt
.
	`g‘Id
()];

310 
	}
}

312 
šlše
 
	gSnoİF‹r
::
SnoİLi¡


313 
SnoİF‹r
::
	$maskToPÜtLi¡
(
SnoİMask
 
pÜt_mask
) const

315 
SnoİLi¡
 
»s
;

316 cÚ¡‡uto& 
p
 : 
¦avePÜts
)

317 ià(
pÜt_mask
 & 
	`pÜtToMask
(*
p
))

318 
»s
.
	`push_back
(
p
);

319  
»s
;

320 
	}
}

	@stack_dist_calc.cc

40 
	~"mem/¡ack_di¡_ÿlc.hh
"

42 
	~"ba£/chunk_g’”©Ü.hh
"

43 
	~"ba£/štm©h.hh
"

44 
	~"ba£/Œaû.hh
"

45 
	~"debug/SckDi¡.hh
"

47 
	gSckDi¡C®c
::
	$SckDi¡C®c
(
boŞ
 
v”ify_¡ack
)

48 : 
	`šdex
(0),

49 
	$v”ifySck
(
v”ify_¡ack
)

53 
IndexNodeM­
 
Œ“_Ëv–
;

56 
ÃxtIndex
.
	`push_back
(0);

59 
Œ“
.
	`push_back
(
Œ“_Ëv–
);

62 
Node
* 
roÙ_node
 = 
Ãw
 
	`Node
();

65 
ÃxtIndex
.
	`push_back
(1);

68 
Œ“
.
	`push_back
(
Œ“_Ëv–
);

71 
Œ“
[1][
roÙ_node
->
nodeIndex
] =„oot_node;

72 
	}
}

74 
	gSckDi¡C®c
::~
	$SckDi¡C®c
()

77 auto& 
Ïy”
 : 
Œ“
) {

78 auto& 
šdex_node
 : 
Ïy”
) {

80 
d–‘e
 
šdex_node
.
£cÚd
;

83 
Ïy”
.
	`ş—r
();

87 
Œ“
.
	`ş—r
();

88 
aiM­
.
	`ş—r
();

89 
ÃxtIndex
.
	`ş—r
();

92 
¡ack
.
	`ş—r
();

93 
	}
}

98 
ušt64_t


99 
	gSckDi¡C®c
::
	$upd©eSum
(
Node
* 
node
, 
boŞ
 
äom_Ëá
,

100 
ušt64_t
 
sum_äom_b–ow
, ušt64_ˆ
Ëv–
,

101 
ušt64_t
 
¡ack_di¡
, 
boŞ
 
disÿrd_node
)

103 ++
Ëv–
;

107 
ušt64_t
 
node_sum_l
 = 
node
->
sumLeá
;

108 
ušt64_t
 
node_sum_r
 = 
node
->
sumRight
;

109 
boŞ
 
node_Ëá
 = 
node
->
isLeáNode
;

110 
boŞ
 
node_disÿrd_Ëá
 = 
node
->
disÿrdLeá
;

111 
boŞ
 
node_disÿrd_right
 = 
node
->
disÿrdRight
;

112 
ušt64_t
 
node_n_šdex
 = 
node
->
nodeIndex
;

113 
Node
* 
node_·»Á_±r
 = 
node
->
·»Á
;

116 ià(
v”ifySck
) {

123 
	`·nic_if
(
node_sum_l
 > (1 << (
Ëv–
 - 1)),

125 "Sum = %uÎ \n", 
Ëv–
, 
node_n_šdex
, 
node_sum_l
);

127 
	`·nic_if
(
node_sum_r
 > (1 << (
Ëv–
 - 1)),

129 "Sum = %uÎ \n", 
Ëv–
, 
node_n_šdex
, 
node_sum_r
);

135 ià(
äom_Ëá
) {

137 
node_sum_l
 = 
sum_äom_b–ow
;

138 
¡ack_di¡
 +ğ
node_sum_r
;

141 
node_sum_r
 = 
sum_äom_b–ow
;

145 ià(
disÿrd_node
 && !
sum_äom_b–ow
) {

146 ià(
äom_Ëá
)

147 
node_disÿrd_Ëá
 = 
Œue
;

149 
node_disÿrd_right
 = 
Œue
;

153 
node
->
nodeIndex
 = 
node_n_šdex
;

154 
node
->
sumLeá
 = 
node_sum_l
;

155 
node
->
sumRight
 = 
node_sum_r
;

156 
node
->
isLeáNode
 = 
node_Ëá
;

157 
node
->
disÿrdLeá
 = 
node_disÿrd_Ëá
;

158 
node
->
disÿrdRight
 = 
node_disÿrd_right
;

161 ià(
node_disÿrd_Ëá
 && 
node_disÿrd_right
 &&

162 
disÿrd_node
 && 
node_·»Á_±r
 && !
sum_äom_b–ow
) {

163 
d–‘e
 
node
;

164 
Œ“
[
Ëv–
].
	`”a£
(
node_n_šdex
);

165 
disÿrd_node
 = 
Œue
;

169 
disÿrd_node
 = 
çl£
;

174 ià(
node_·»Á_±r
) {

175 
¡ack_di¡
 = 
	`upd©eSum
(
node_·»Á_±r
, 
node_Ëá
,

176 
node_sum_l
 + 
node_sum_r
,

177 
Ëv–
, 
¡ack_di¡
, 
disÿrd_node
);

180  
¡ack_di¡
;

181 
	}
}

187 
ušt64_t


188 
	gSckDi¡C®c
::
	$upd©eSumsL—vesToRoÙ
(
Node
* 
node
, 
boŞ
 
is_Ãw_Ëaf
)

190 
ušt64_t
 
Ëv–
 = 0;

191 
ušt64_t
 
¡ack_di¡
 = 0;

193 ià(
is_Ãw_Ëaf
) {

194 
node
->
sumLeá
 = 1;

195 
	`upd©eSum
(
node
->
·»Á
,

196 
node
->
isLeáNode
,‚ode->
sumLeá
,

197 
Ëv–
, 0, 
çl£
);

199 
¡ack_di¡
 = 
Infš™y
;

201 
node
->
sumLeá
 = 0;

202 
¡ack_di¡
 = 
	`upd©eSum
(
node
->
·»Á
,

203 
node
->
isLeáNode
, 0,

204 
Ëv–
, 
¡ack_di¡
, 
Œue
);

207  
¡ack_di¡
;

208 
	}
}

212 
ušt64_t


213 
	gSckDi¡C®c
::
	$g‘Sum
(
Node
* 
node
, 
boŞ
 
äom_Ëá
, 
ušt64_t
 
sum_äom_b–ow
,

214 
ušt64_t
 
¡ack_di¡
, ušt64_ˆ
Ëv–
) const

216 ++
Ëv–
;

219 ià(
äom_Ëá
) {

220 
¡ack_di¡
 +ğ
node
->
sumRight
;

225 ià(
node
->
·»Á
) {

226 
¡ack_di¡
 = 
	`g‘Sum
(
node
->
·»Á
,‚ode->
isLeáNode
,

227 
node
->
sumLeá
 +‚ode->
sumRight
,

228 
¡ack_di¡
, 
Ëv–
);

231  
¡ack_di¡
;

232 
	}
}

235 
ušt64_t


236 
	gSckDi¡C®c
::
	$g‘SumsL—vesToRoÙ
(
Node
* 
node
) const

238  
	`g‘Sum
(
node
->
·»Á
,‚ode->
isLeáNode
, 0, 0, 0);

239 
	}
}

250 
	gSckDi¡C®c
::
	$upd©eT»e
()

252 
ušt64_t
 
i
;

254 ià(
	`isPow”Of2
(
šdex
)) {

269 
Node
* 
ÃwRoÙNode
 = 
Ãw
 
	`Node
();

272 
ÃwRoÙNode
->
sumLeá
 = 
Œ“
[
	`g‘T»eD•th
()][0]->
sumRight
 +

273 
Œ“
[
	`g‘T»eD•th
()][0]->
sumLeá
;

276 
ÃwRoÙNode
->
disÿrdLeá
 = 
Œ“
[
	`g‘T»eD•th
()][0]->discardLeft &&

277 
Œ“
[
	`g‘T»eD•th
()][0]->
disÿrdRight
;

280 
IndexNodeM­
 
Œ“Lev–
;

282 
Œ“
.
	`push_back
(
Œ“Lev–
);

283 
ÃxtIndex
.
	`push_back
(1);

284 
Œ“
[
	`g‘T»eD•th
()][
ÃwRoÙNode
->
nodeIndex
] =‚ewRootNode;

288 
Œ“
[
	`g‘T»eD•th
(è- 1][0]->
·»Á
 =ree[getTreeDepth()][0];

292 
i
 = 
	`g‘T»eD•th
() - 1; i >= 1; --i) {

293 
Node
* 
ÃwINode
 = 
Ãw
 
	`Node
();

296 ià(
ÃxtIndex
[
i
] % 2 == 0) {

297 
ÃwINode
->
isLeáNode
 = 
Œue
;

299 
ÃwINode
->
isLeáNode
 = 
çl£
;

302 
ÃwINode
->
·»Á
 = 
Œ“
[
i
 + 1][
ÃxtIndex
[i + 1] - 1];

303 
ÃwINode
->
nodeIndex
 = ++
ÃxtIndex
[
i
] - 1;

304 
Œ“
[
i
][
ÃwINode
->
nodeIndex
] =‚ewINode;

322 
i
 = 
	`g‘T»eD•th
() - 1; i >= 1; --i) {

327 ià((
šdex
 % (1 << 
i
)) == 0) {

330 
Node
* 
ÃwINode
 = 
Ãw
 
	`Node
();

334 ià(
ÃxtIndex
[
i
] % 2 == 0) {

335 
ÃwINode
->
isLeáNode
 = 
Œue
;

337 
ÃwINode
->
isLeáNode
 = 
çl£
;

341 
ÃwINode
->
·»Á
 = 
Œ“
[
i
 + 1][
ÃxtIndex
[i + 1] - 1];

342 
ÃwINode
->
nodeIndex
 = ++
ÃxtIndex
[
i
] - 1;

343 
Œ“
[
i
][
ÃwINode
->
nodeIndex
] =‚ewINode;

347 
	}
}

358 
	g¡d
::
·œ
< 
ušt64_t
, 
	gboŞ
>

359 
	gSckDi¡C®c
::
	$ÿlcSckDi¡AndUpd©e
(cÚ¡ 
Addr
 
r_add»ss
, 
boŞ
 
addNewNode
)

361 
Node
* 
ÃwL—fNode
;

363 autØ
ai
 = 
aiM­
.
	`low”_bound
(
r_add»ss
);

366 
boŞ
 
isLeá
 = 
Œue
;

368 
boŞ
 
_m¬k
 = 
çl£
;

370 
ušt64_t
 
¡ack_di¡
;

377 ià(
ai
 !ğ
aiM­
.
	`’d
(è&& !×iM­.
	`key_comp
()(
r_add»ss
,‡i->
fœ¡
))) {

381 
ušt64_t
 
r_šdex
 = 
ai
->
£cÚd
;

383 ià(
addNewNode
) {

385 
ai
->
£cÚd
 = 
šdex
;

387 
aiM­
.
	`”a£
(
r_add»ss
);

393 
¡ack_di¡
 = 
	`upd©eSumsL—vesToRoÙ
(
Œ“
[0][
r_šdex
], 
çl£
);

394 
ÃwL—fNode
 = 
Œ“
[0][
r_šdex
];

396 
_m¬k
 = 
ÃwL—fNode
->
isM¬ked
;

397 
d–‘e
 
ÃwL—fNode
;

398 
Œ“
[0].
	`”a£
(
r_šdex
);

400 ià(
addNewNode
) {

402 
aiM­
[
r_add»ss
] = 
šdex
;

406 
¡ack_di¡
 = 
Infš™y
;

409 ià(
addNewNode
) {

411 ià(
šdex
 % 2 == 0) {

412 
	`upd©eT»e
();

416 
isLeá
 = 
çl£
;

421 
ÃwL—fNode
 = 
Ãw
 
	`Node
();

422 ++
ÃxtIndex
[0];

423 
ÃwL—fNode
->
nodeIndex
=
šdex
;

424 
ÃwL—fNode
->
isLeáNode
=
isLeá
;

426 
ÃwL—fNode
->
·»Á
 = 
Œ“
[1][
ÃxtIndex
[1] - 1];

427 
Œ“
[0][
šdex
] = 
ÃwL—fNode
;

430 
	`upd©eSumsL—vesToRoÙ
(
Œ“
[0][
šdex
], 
Œue
);

433 ià(
v”ifySck
) {

438 
	`§n™yCheckT»e
(
Œ“
[0][
šdex
]);

441 
ušt64_t
 
v”ify_¡ack_di¡
 = 
	`v”ifySckDi¡
(
r_add»ss
, 
Œue
);

442 
	`·nic_if
(
v”ify_¡ack_di¡
 !ğ
¡ack_di¡
,

445 
r_add»ss
, 
v”ify_¡ack_di¡
, 
¡ack_di¡
);

446 
	`´štSck
();

451 ++
šdex
;

454  (
¡d
::
	`make_·œ
(
¡ack_di¡
, 
_m¬k
));

455 
	}
}

460 
	g¡d
::
·œ
< 
ušt64_t
, 
	gboŞ
>

461 
	gSckDi¡C®c
::
	$ÿlcSckDi¡
(cÚ¡ 
Addr
 
r_add»ss
, 
boŞ
 
m¬k
)

464 
boŞ
 
_m¬k
 = 
çl£
;

466 autØ
ai
 = 
aiM­
.
	`low”_bound
(
r_add»ss
);

469 
ušt64_t
 
¡ack_di¡
 = 0;

475 ià(
ai
 !ğ
aiM­
.
	`’d
(è&& !×iM­.
	`key_comp
()(
r_add»ss
,‡i->
fœ¡
))) {

479 
ušt64_t
 
r_šdex
 = 
ai
->
£cÚd
;

482 
_m¬k
 = 
Œ“
[0][
r_šdex
]->
isM¬ked
;

484 
Œ“
[0][
r_šdex
]->
isM¬ked
 = 
m¬k
;

489 
¡ack_di¡
 = 
	`g‘SumsL—vesToRoÙ
(
Œ“
[0][
r_šdex
]);

493 
¡ack_di¡
 = 
Infš™y
;

497 ià(
v”ifySck
) {

499 
ušt64_t
 
v”ify_¡ack_di¡
 = 
	`v”ifySckDi¡
(
r_add»ss
);

500 
	`·nic_if
(
v”ify_¡ack_di¡
 !ğ
¡ack_di¡
,

503 
r_add»ss
, 
v”ify_¡ack_di¡
, 
¡ack_di¡
);

505 
	`´štSck
();

508  
¡d
::
	`make_·œ
(
¡ack_di¡
, 
_m¬k
);

509 
	}
}

514 
	gSckDi¡C®c
::
	$§n™yCheckT»e
(cÚ¡ 
Node
* 
node
, 
ušt64_t
 
Ëv–
) const

516 cÚ¡ 
Node
* 
Ãxt_up
 = 
node
->
·»Á
;

518 
ušt64_t
 
i
 = 
Ëv–
 + 1; i < 
	`g‘T»eD•th
() -†evel; ++i) {

519 
Ãxt_up
 =‚ext_up->
·»Á
;

520 
	`·nic_if
(!
Ãxt_up
, "Sanity check failed for‚ode %ull \n",

521 
node
->
nodeIndex
);

525 
	`·nic_if
(
Ãxt_up
->
·»Á
, "Sanity check failed for‚ode %ull \n",

526 
node
->
nodeIndex
);

527 
	}
}

533 
ušt64_t


534 
	gSckDi¡C®c
::
	$v”ifySckDi¡
(cÚ¡ 
Addr
 
r_add»ss
, 
boŞ
 
upd©e_¡ack
)

536 
boŞ
 
found
 = 
çl£
;

537 
ušt64_t
 
¡ack_di¡
 = 0;

538 autØ
a
 = 
¡ack
.
	`rbegš
();

540 ; 
a
 !ğ
¡ack
.
	`»nd
(); ++a) {

541 ià(*
a
 =ğ
r_add»ss
) {

542 
found
 = 
Œue
;

545 ++
¡ack_di¡
;

549 ià(
found
) {

550 ++
a
;

551 ià(
upd©e_¡ack
)

552 
¡ack
.
	`”a£
(
a
.
	`ba£
());

554 
¡ack_di¡
 = 
Infš™y
;

557 ià(
upd©e_¡ack
)

558 
¡ack
.
	`push_back
(
r_add»ss
);

560  
¡ack_di¡
;

561 
	}
}

565 
	gSckDi¡C®c
::
	$´štSck
(
n
) const

567 
Node
* 
node
;

568 
couÁ
 = 0;

570 
	`DPRINTF
(
SckDi¡
, "Prštšg†a¡ %dƒÁr› š»e\n", 
n
);

573 autØ
™
 = 
Œ“
[0].
	`rbegš
(); (
couÁ
 < 
n
è&& (™ !ğŒ“[0].
	`»nd
());

574 ++
™
, ++
couÁ
) {

575 
node
 = 
™
->
£cÚd
;

576 
ušt64_t
 
r_šdex
 = 
node
->
nodeIndex
;

579 autØ
ai
 = 
aiM­
.
	`rbegš
();‡˜!ğaiM­.
	`»nd
(); ++ai) {

580 ià(
ai
->
£cÚd
 =ğ
r_šdex
) {

581 
	`DPRINTF
(
SckDi¡
,"Tree†eaves, Rightmost-[%d] = %#lx\n",

582 
couÁ
, 
ai
->
fœ¡
);

588 
	`DPRINTF
(
SckDi¡
,"T»d•th = %#ld\n", 
	`g‘T»eD•th
());

590 ià(
v”ifySck
) {

591 
	`DPRINTF
(
SckDi¡
,"Prštšg La¡ %dƒÁr› š V”ifSck \n", 
n
);

592 
couÁ
 = 0;

593 autØ
a
 = 
¡ack
.
	`rbegš
(); (
couÁ
 < 
n
è&& (¨!ğ¡ack.
	`»nd
());

594 ++
a
, ++
couÁ
) {

595 
	`DPRINTF
(
SckDi¡
, "V”iàSck, Tİ-[%d] = %#lx\n", 
couÁ
, *
a
);

598 
	}
}

	@stack_dist_calc.hh

41 #iâdeà
__MEM_STACK_DIST_CALC_HH__


42 
	#__MEM_STACK_DIST_CALC_HH__


	)

44 
	~<lim™s
>

45 
	~<m­
>

46 
	~<veùÜ
>

48 
	~"ba£/ty³s.hh
"

174 şas 
	cSckDi¡C®c


177 
	m´iv©e
:

179 
Node
;

181 
	m¡d
::
	tm­
<
	tušt64_t
, 
	tNode
*> 
	tIndexNodeM­
;

182 
	m¡d
::
	tm­
<
	tAddr
, 
	tušt64_t
> 
	tAdd»ssIndexM­
;

183 
	m¡d
::
	tveùÜ
<
	tIndexNodeM­
> 
	tT»eTy³
;

199 
ušt64_t
 
	$g‘Sum
(
Node
* 
node
, 
boŞ
 
äom_Ëá
, 
ušt64_t
 
sum_äom_b–ow
,

200 
ušt64_t
 
¡ack_di¡
, ušt64_ˆ
Ëv–
) const;

210 
ušt64_t
 
	$g‘SumsL—vesToRoÙ
(
Node
* 
node
) const;

227 
ušt64_t
 
	`upd©eSum
(
Node
* 
node
,

228 
boŞ
 
äom_Ëá
, 
ušt64_t
 
sum_äom_b–ow
, ušt64_ˆ
Ëv–
,

229 
ušt64_t
 
¡ack_di¡
, 
boŞ
 
disÿrd_node
);

240 
ušt64_t
 
	`upd©eSumsL—vesToRoÙ
(
Node
* 
node
, 
boŞ
 
is_Ãw_Ëaf
);

252 
	`upd©eT»e
();

264 
	$§n™yCheckT»e
(cÚ¡ 
Node
* 
node
, 
ušt64_t
 
Ëv–
 = 0) const;

273 
ušt64_t
 
	$g‘Index
(ècÚ¡ {  
šdex
; }

282 
ušt64_t
 
	$g‘T»eD•th
(ècÚ¡ {  
Œ“
.
	`size
(è- 1; 
	}
}

290 
	$´štSck
(
n
 = 5) const;

304 
ušt64_t
 
	`v”ifySckDi¡
(cÚ¡ 
Addr
 
r_add»ss
,

305 
boŞ
 
upd©e_¡ack
 = 
çl£
);

307 
public
:

308 
	`SckDi¡C®c
(
boŞ
 
v”ify_¡ack
 = 
çl£
);

310 ~
	`SckDi¡C®c
();

315 
cÚ¡ex´
 
ušt64_t
 
Infš™y
 = 
¡d
::
num”ic_lim™s
<ušt64_t>::
	`max
();

328 
¡d
::
·œ
<
ušt64_t
, 
boŞ
> 
	`ÿlcSckDi¡
(cÚ¡ 
Addr
 
r_add»ss
,

329 
boŞ
 
m¬k
 = 
çl£
);

343 
¡d
::
·œ
<
ušt64_t
, 
boŞ
> 
	`ÿlcSckDi¡AndUpd©e
(cÚ¡ 
Addr
 
r_add»ss
,

344 
boŞ
 
addNewNode
 = 
Œue
);

346 
´iv©e
:

351 
	sNode
{

353 
ušt64_t
 
sumLeá
;

356 
ušt64_t
 
sumRight
;

359 
boŞ
 
disÿrdLeá
;

362 
boŞ
 
disÿrdRight
;

365 
ušt64_t
 
nodeIndex
;

368 
Node
* 
·»Á
;

371 
boŞ
 
isLeáNode
;

377 
boŞ
 
isM¬ked
;

383 
	`Node
(è: 
	`sumLeá
(0), 
	`sumRight
(0), 
	`disÿrdLeá
(
çl£
),

384 
	`disÿrdRight
(
çl£
), 
	`nodeIndex
(0),

385 
	`·»Á
(
nuÎ±r
), 
	`isLeáNode
(
Œue
), 
	`isM¬ked
(
çl£
)

387 
	}
};

397 
ušt64_t
 
	gšdex
;

400 
T»eTy³
 
	gŒ“
;

403 
Add»ssIndexM­
 
	gaiM­
;

407 
	g¡d
::
veùÜ
<
ušt64_t
> 
ÃxtIndex
;

410 
	g¡d
::
veùÜ
<
ušt64_t
> 
¡ack
;

413 cÚ¡ 
boŞ
 
	gv”ifySck
;

	@tport.cc

44 
	~"mem/mem_objeù.hh
"

45 
	~"mem/Üt.hh
"

47 
	gSim¶eTimšgPÜt
::
	$Sim¶eTimšgPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
_Çme
,

48 
MemObjeù
* 
_owÃr
) :

49 
	`QueuedSÏvePÜt
(
_Çme
, 
_owÃr
, 
queueIm¶
), 
	$queueIm¶
(*
_owÃr
, *
this
)

51 
	}
}

54 
	gSim¶eTimšgPÜt
::
	$»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
)

56 ià(!
»¥Queue
.
	`checkFunùiÚ®
(
pkt
)) {

58 
	`»cvAtomic
(
pkt
);

60 
	}
}

62 
boŞ


63 
	gSim¶eTimšgPÜt
::
	$»cvTimšgReq
(
Pack‘PŒ
 
pkt
)

68 ià(
pkt
->
	`ÿcheRe¥Údšg
())

69 
	`·nic
("SimpleTimingPort should‚ever see…ackets withhe "

72 
boŞ
 
ÃedsRe¥Ú£
 = 
pkt
->
	`ÃedsRe¥Ú£
();

73 
Tick
 
Ï‹ncy
 = 
	`»cvAtomic
(
pkt
);

75 ià(
ÃedsRe¥Ú£
) {

78 
	`as£¹
(
pkt
->
	`isRe¥Ú£
());

79 
	`schedTimšgRe¥
(
pkt
, 
	`curTick
(è+ 
Ï‹ncy
);

82 
³ndšgD–‘e
.
	`»£t
(
pkt
);

85  
Œue
;

86 
	}
}

	@tport.hh

44 #iâdeà
__MEM_TPORT_HH__


45 
	#__MEM_TPORT_HH__


	)

53 
	~"mem/qpÜt.hh
"

60 şas 
	cSim¶eTimšgPÜt
 : 
public
 
QueuedSÏvePÜt


63 
´iv©e
:

71 
Re¥Pack‘Queue
 
queueIm¶
;

73 
	m´Ùeùed
:

76 
»cvFunùiÚ®
(
Pack‘PŒ
 
pkt
);

79 
boŞ
 
»cvTimšgReq
(
Pack‘PŒ
 
pkt
);

81 
vœtu®
 
Tick
 
»cvAtomic
(
Pack‘PŒ
 
pkt
) = 0;

87 
	m¡d
::
unique_±r
<
Pack‘
> 
³ndšgD–‘e
;

89 
	mpublic
:

102 
Sim¶eTimšgPÜt
(cÚ¡ 
¡d
::
¡ršg
& 
Çme
, 
MemObjeù
* 
owÃr
);

104 
	mvœtu®
 ~
	$Sim¶eTimšgPÜt
() { }

106 
	}
};

	@xbar.cc

50 
	~"ba£/misc.hh
"

51 
	~"ba£/Œaû.hh
"

52 
	~"debug/AddrRªges.hh
"

53 
	~"debug/D¿š.hh
"

54 
	~"debug/XB¬.hh
"

55 
	~"mem/xb¬.hh
"

57 
	gBa£XB¬
::
	$Ba£XB¬
(cÚ¡ 
Ba£XB¬P¬ams
 *
p
)

58 : 
	`MemObjeù
(
p
),

59 
	`äÚ‹ndL©’cy
(
p
->
äÚ‹nd_Ï‹ncy
),

60 
	`fÜw¬dL©’cy
(
p
->
fÜw¬d_Ï‹ncy
),

61 
	`»¥Ú£L©’cy
(
p
->
»¥Ú£_Ï‹ncy
),

62 
	`width
(
p
->
width
),

63 
	`gÙAddrRªges
(
p
->
pÜt_deçuÉ_cÚÃùiÚ_couÁ
 +

64 
p
->
pÜt_ma¡”_cÚÃùiÚ_couÁ
, 
çl£
),

65 
	`gÙAÎAddrRªges
(
çl£
), 
	`deçuÉPÜtID
(
Inv®idPÜtID
),

66 
	`u£DeçuÉRªge
(
p
->
u£_deçuÉ_¿nge
)

67 {
	}
}

69 
	gBa£XB¬
::~
	$Ba£XB¬
()

71 autØ
m
: 
ma¡”PÜts
)

72 
d–‘e
 
m
;

74 autØ
s
: 
¦avePÜts
)

75 
d–‘e
 
s
;

76 
	}
}

79 
	gBa£XB¬
::
	$š™
()

81 
	}
}

83 
Ba£Ma¡”PÜt
 &

84 
Ba£XB¬
::
	$g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

86 ià(
if_Çme
 =ğ"ma¡”" && 
idx
 < 
ma¡”PÜts
.
	`size
()) {

88  *
ma¡”PÜts
[
idx
];

89 } ià(
if_Çme
 == "default") {

90  *
ma¡”PÜts
[
deçuÉPÜtID
];

92  
MemObjeù
::
	`g‘Ma¡”PÜt
(
if_Çme
, 
idx
);

94 
	}
}

96 
	gBa£SÏvePÜt
 &

97 
	gBa£XB¬
::
	$g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
 &
if_Çme
, 
PÜtID
 
idx
)

99 ià(
if_Çme
 =ğ"¦ave" && 
idx
 < 
¦avePÜts
.
	`size
()) {

101  *
¦avePÜts
[
idx
];

103  
MemObjeù
::
	`g‘SÏvePÜt
(
if_Çme
, 
idx
);

105 
	}
}

108 
	gBa£XB¬
::
	$ÿlcPack‘Timšg
(
Pack‘PŒ
 
pkt
, 
Tick
 
h—d”_d–ay
)

113 
Tick
 
off£t
 = 
	`şockEdge
(è- 
	`curTick
();

118 
pkt
->
h—d”D–ay
 +ğ
off£t
 + 
h—d”_d–ay
;

126 
	`·nic_if
(
pkt
->
h—d”D–ay
 > 
SimClock
::
IÁ
::
us
,

129 ià(
pkt
->
	`hasD©a
()) {

134 
pkt
->
·ylßdD–ay
 = 
¡d
::
max
<
Tick
>(pkt->payloadDelay,

135 
	`divCe
(
pkt
->
	`g‘Size
(), 
width
) *

136 
	`şockP”iod
());

143 
	}
}

145 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

146 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$Lay”
(
D¡Ty³
& 
_pÜt
, 
Ba£XB¬
& 
_xb¬
,

147 cÚ¡ 
¡d
::
¡ršg
& 
_Çme
) :

148 
	`pÜt
(
_pÜt
), 
	`xb¬
(
_xb¬
), 
	`_Çme
(
_Çme
), 
	`¡©e
(
IDLE
),

149 
	`wa™šgFÜP“r
(
NULL
), 
	$»Ëa£Ev’t
(
this
)

151 
	}
}

153 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

154 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$occupyLay”
(
Tick
 
uÁ
)

160 
	`as£¹
(
¡©e
 =ğ
BUSY
);

163 
	`as£¹
(
uÁ
 != 0);

164 
xb¬
.
	`scheduË
(
»Ëa£Ev’t
, 
uÁ
);

167 
occu·ncy
 +ğ
uÁ
 - 
	`curTick
();

169 
	`DPRINTF
(
Ba£XB¬
, "The crossbar†ayer is‚ow busy fromick %do %d\n",

170 
	`curTick
(), 
uÁ
);

171 
	}
}

173 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

174 
boŞ


175 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$ŒyTimšg
(
SrcTy³
* 
¤c_pÜt
)

186 ià(
¡©e
 =ğ
BUSY
 || 
wa™šgFÜP“r
 !ğ
NULL
) {

188 
	`as£¹
(
¡d
::
	`fšd
(
wa™šgFÜLay”
.
	`begš
(), wa™šgFÜLay”.
	`’d
(),

189 
¤c_pÜt
è=ğ
wa™šgFÜLay”
.
	`’d
());

195 
wa™šgFÜLay”
.
	`push_back
(
¤c_pÜt
);

196  
çl£
;

199 
¡©e
 = 
BUSY
;

201  
Œue
;

202 
	}
}

204 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

206 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$sucûededTimšg
(
Tick
 
busy_time
)

210 
	`as£¹
(
¡©e
 =ğ
BUSY
);

213 
	`occupyLay”
(
busy_time
);

214 
	}
}

216 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

218 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$çedTimšg
(
SrcTy³
* 
¤c_pÜt
,

219 
Tick
 
busy_time
)

223 
	`as£¹
(
wa™šgFÜP“r
 =ğ
NULL
);

228 
wa™šgFÜP“r
 = 
¤c_pÜt
;

232 
	`as£¹
(
¡©e
 =ğ
BUSY
);

235 
	`occupyLay”
(
busy_time
);

236 
	}
}

238 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

240 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$»Ëa£Lay”
()

243 
	`as£¹
(
¡©e
 =ğ
BUSY
);

244 
	`as£¹
(!
»Ëa£Ev’t
.
	`scheduËd
());

247 
¡©e
 = 
IDLE
;

250 ià(!
wa™šgFÜLay”
.
	`em±y
()) {

253 ià(
wa™šgFÜP“r
 =ğ
NULL
)

254 
	`»ŒyWa™šg
();

255 } ià(
wa™šgFÜP“r
 =ğ
NULL
 && 
	`d¿šS‹
(è=ğ
D¿šS‹
::
D¿ššg
) {

256 
	`DPRINTF
(
D¿š
, "Crossbar done draining, signaling drain manager\n");

258 
	`sigÇlD¿šDÚe
();

260 
	}
}

262 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

264 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$»ŒyWa™šg
()

267 
	`as£¹
(!
wa™šgFÜLay”
.
	`em±y
());

270 
	`as£¹
(
¡©e
 =ğ
IDLE
);

273 
¡©e
 = 
RETRY
;

277 
SrcTy³
* 
»ŒyšgPÜt
 = 
wa™šgFÜLay”
.
	`äÚt
();

278 
wa™šgFÜLay”
.
	`pİ_äÚt
();

282 
	`£ndR‘ry
(
»ŒyšgPÜt
);

287 ià(
¡©e
 =ğ
RETRY
) {

290 
¡©e
 = 
BUSY
;

293 
	`occupyLay”
(
xb¬
.
	`şockEdge
());

295 
	}
}

297 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

299 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$»cvR‘ry
()

303 
	`as£¹
(
wa™šgFÜP“r
 !ğ
NULL
);

308 
wa™šgFÜLay”
.
	`push_äÚt
(
wa™šgFÜP“r
);

311 
wa™šgFÜP“r
 = 
NULL
;

315 ià(
¡©e
 =ğ
IDLE
) {

316 
	`»ŒyWa™šg
();

318 
	`as£¹
(
¡©e
 =ğ
BUSY
);

320 
	}
}

322 
PÜtID


323 
	gBa£XB¬
::
	$fšdPÜt
(
Addr
 
addr
)

327 
	`as£¹
(
gÙAÎAddrRªges
);

330 
PÜtID
 
de¡_id
 = 
	`checkPÜtCache
(
addr
);

331 ià(
de¡_id
 !ğ
Inv®idPÜtID
)

332  
de¡_id
;

335 autØ
i
 = 
pÜtM­
.
	`fšd
(
addr
);

336 ià(
i
 !ğ
pÜtM­
.
	`’d
()) {

337 
de¡_id
 = 
i
->
£cÚd
;

338 
	`upd©ePÜtCache
(
de¡_id
, 
i
->
fœ¡
);

339  
de¡_id
;

343 ià(
u£DeçuÉRªge
) {

344 ià(
deçuÉRªge
.
	`cÚšs
(
addr
)) {

345 
	`DPRINTF
(
AddrRªges
, " found‡ddr %#llx on default\n",

346 
addr
);

347  
deçuÉPÜtID
;

349 } ià(
deçuÉPÜtID
 !ğ
Inv®idPÜtID
) {

350 
	`DPRINTF
(
AddrRªges
, "Unableo find destination for‡ddr %#llx, "

351 "wÈu£ deçuÉ…Üt\n", 
addr
);

352  
deçuÉPÜtID
;

357 
	`çl
("UÇbËØfšd de¡š©iÚ fÜ‡dd¸%#Îx oÀ%s\n", 
addr
,

358 
	`Çme
());

359 
	}
}

363 
	gBa£XB¬
::
	$»cvRªgeChªge
(
PÜtID
 
ma¡”_pÜt_id
)

365 
	`DPRINTF
(
AddrRªges
, "Received„ange change from slave…ort %s\n",

366 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`g‘SÏvePÜt
().
	`Çme
());

370 
gÙAddrRªges
[
ma¡”_pÜt_id
] = 
Œue
;

373 ià(!
gÙAÎAddrRªges
) {

376 
gÙAÎAddrRªges
 = 
Œue
;

377 
¡d
::
veùÜ
<
boŞ
>::
cÚ¡_™”©Ü
 
r
 = 
gÙAddrRªges
.
	`begš
();

378 
gÙAÎAddrRªges
 && 
r
 !ğ
gÙAddrRªges
.
	`’d
()) {

379 
gÙAÎAddrRªges
 &ğ*
r
++;

381 ià(
gÙAÎAddrRªges
)

382 
	`DPRINTF
(
AddrRªges
, "Got‡ddress„anges from‡ll slaves\n");

389 ià(
ma¡”_pÜt_id
 =ğ
deçuÉPÜtID
) {

393 ià(
u£DeçuÉRªge
) {

394 
AddrRªgeLi¡
 
¿nges
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`g‘AddrRªges
();

396 ià(
¿nges
.
	`size
() != 1)

397 
	`çl
("Crossbar %s may only have‡ single default„ange",

398 
	`Çme
());

400 
deçuÉRªge
 = 
¿nges
.
	`äÚt
();

405 ià(
gÙAddrRªges
[
ma¡”_pÜt_id
]) {

406 autØ
p
 = 
pÜtM­
.
	`begš
();… !ğpÜtM­.
	`’d
(); ) {

407 ià(
p
->
£cÚd
 =ğ
ma¡”_pÜt_id
)

410 
pÜtM­
.
	`”a£
(
p
++);

412 
p
++;

416 
AddrRªgeLi¡
 
¿nges
 = 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`g‘AddrRªges
();

418 cÚ¡‡uto& 
r
: 
¿nges
) {

419 
	`DPRINTF
(
AddrRªges
, "Adding„ange %s for id %d\n",

420 
r
.
	`to_¡ršg
(), 
ma¡”_pÜt_id
);

421 ià(
pÜtM­
.
	`š£¹
(
r
, 
ma¡”_pÜt_id
è=ğpÜtM­.
	`’d
()) {

422 
PÜtID
 
cÚæiù_id
 = 
pÜtM­
.
	`fšd
(
r
)->
£cÚd
;

423 
	`çl
("%s haswo…orts„esponding within„ange %s:\n\t%s\n\t%s\n",

424 
	`Çme
(),

425 
r
.
	`to_¡ršg
(),

426 
ma¡”PÜts
[
ma¡”_pÜt_id
]->
	`g‘SÏvePÜt
().
	`Çme
(),

427 
ma¡”PÜts
[
cÚæiù_id
]->
	`g‘SÏvePÜt
().
	`Çme
());

435 ià(
gÙAÎAddrRªges
) {

436 
	`DPRINTF
(
AddrRªges
, "Aggregating‡ddress„anges\n");

437 
xb¬Rªges
.
	`ş—r
();

440 ià(
u£DeçuÉRªge
) {

441 ià(!
gÙAddrRªges
[
deçuÉPÜtID
])

442 
	`çl
("Crossbar %s uses default„ange, but‚one…rovided",

443 
	`Çme
());

445 
xb¬Rªges
.
	`push_back
(
deçuÉRªge
);

446 
	`DPRINTF
(
AddrRªges
, "-- Adding default %s\n",

447 
deçuÉRªge
.
	`to_¡ršg
());

452 
¡d
::
veùÜ
<
AddrRªge
> 
šv_¿nges
;

453 cÚ¡‡uto& 
r
: 
pÜtM­
) {

455 ià(
r
.
fœ¡
.
	`š‹¾—ved
()) {

459 ià(!
šv_¿nges
.
	`em±y
() &&

460 !
šv_¿nges
.
	`back
().
	`m”gesW™h
(
r
.
fœ¡
)) {

461 
	`DPRINTF
(
AddrRªges
, "-- Merging„ange from %d„anges\n",

462 
šv_¿nges
.
	`size
());

463 
AddrRªge
 
	`m”ged_¿nge
(
šv_¿nges
);

465 ià(!(
u£DeçuÉRªge
 &&

466 
m”ged_¿nge
.
	`isSub£t
(
deçuÉRªge
))) {

467 
xb¬Rªges
.
	`push_back
(
m”ged_¿nge
);

468 
	`DPRINTF
(
AddrRªges
, "-- Adding merged„ange %s\n",

469 
m”ged_¿nge
.
	`to_¡ršg
());

471 
šv_¿nges
.
	`ş—r
();

473 
šv_¿nges
.
	`push_back
(
r
.
fœ¡
);

476 ià(!(
u£DeçuÉRªge
 &&

477 
r
.
fœ¡
.
	`isSub£t
(
deçuÉRªge
))) {

478 
xb¬Rªges
.
	`push_back
(
r
.
fœ¡
);

479 
	`DPRINTF
(
AddrRªges
, "-- Adding„ange %s\n",

480 
r
.
fœ¡
.
	`to_¡ršg
());

487 ià(!
šv_¿nges
.
	`em±y
()) {

488 
	`DPRINTF
(
AddrRªges
, "-- Merging„ange from %d„anges\n",

489 
šv_¿nges
.
	`size
());

490 
AddrRªge
 
	`m”ged_¿nge
(
šv_¿nges
);

491 ià(!(
u£DeçuÉRªge
 && 
m”ged_¿nge
.
	`isSub£t
(
deçuÉRªge
))) {

492 
xb¬Rªges
.
	`push_back
(
m”ged_¿nge
);

493 
	`DPRINTF
(
AddrRªges
, "-- Adding merged„ange %s\n",

494 
m”ged_¿nge
.
	`to_¡ršg
());

502 ià(
u£DeçuÉRªge
) {

503 cÚ¡‡uto& 
r
: 
xb¬Rªges
) {

506 ià(
r
.
	`š‹r£ùs
(
deçuÉRªge
) &&

507 !
r
.
	`isSub£t
(
deçuÉRªge
))

508 
	`çl
("Range %s intersectshe " \

510 "sub£t\n", 
r
.
	`to_¡ršg
(), 
	`Çme
());

516 cÚ¡‡uto& 
s
: 
¦avePÜts
)

517 
s
->
	`£ndRªgeChªge
();

520 
	`ş—rPÜtCache
();

521 
	}
}

523 
AddrRªgeLi¡


524 
	gBa£XB¬
::
	$g‘AddrRªges
() const

529 
	`as£¹
(
gÙAÎAddrRªges
);

536 
	`DPRINTF
(
AddrRªges
, "Received‡ddress„ange„equest\n");

538  
xb¬Rªges
;

539 
	}
}

542 
	gBa£XB¬
::
	$»gSts
()

544 
ClockedObjeù
::
	`»gSts
();

546 
usšg
 
Çme¥aû
 
Sts
;

548 
ŒªsDi¡


549 .
	`š™
(
MemCmd
::
NUM_MEM_CMDS
)

550 .
	`Çme
(name() + ".trans_dist")

551 .
	`desc
("Transaction distribution")

552 .
	`æags
(
noz”o
);

555 
i
 = 0; i < 
MemCmd
::
NUM_MEM_CMDS
; i++) {

556 
MemCmd
 
	`cmd
(
i
);

557 cÚ¡ 
¡d
::
¡ršg
 &
c¡r
 = 
cmd
.
	`toSŒšg
();

558 
ŒªsDi¡
.
	`subÇme
(
i
, 
c¡r
);

561 
pktCouÁ


562 .
	`š™
(
¦avePÜts
.
	`size
(), 
ma¡”PÜts
.size())

563 .
	`Çme
(name() + ".pkt_count")

564 .
	`desc
("Packet count…er connected master‡nd slave (bytes)")

565 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
);

567 
pktSize


568 .
	`š™
(
¦avePÜts
.
	`size
(), 
ma¡”PÜts
.size())

569 .
	`Çme
(name() + ".pkt_size")

570 .
	`desc
("Cumulative…acket size…er connected master‡nd slave (bytes)")

571 .
	`æags
(
tÙ®
 | 
noz”o
 | 
nÚª
);

579 
i
 = 0; i < 
¦avePÜts
.
	`size
(); i++) {

580 
pktCouÁ
.
	`subÇme
(
i
, 
¦avePÜts
[i]->
	`g‘Ma¡”PÜt
().
	`Çme
());

581 
pktSize
.
	`subÇme
(
i
, 
¦avePÜts
[i]->
	`g‘Ma¡”PÜt
().
	`Çme
());

582 
j
 = 0; j < 
ma¡”PÜts
.
	`size
(); j++) {

583 
pktCouÁ
.
	`ysubÇme
(
j
, 
ma¡”PÜts
[j]->
	`g‘SÏvePÜt
().
	`Çme
());

584 
pktSize
.
	`ysubÇme
(
j
, 
ma¡”PÜts
[j]->
	`g‘SÏvePÜt
().
	`Çme
());

587 
	}
}

589 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

590 
D¿šS‹


591 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$d¿š
()

596 ià(
¡©e
 !ğ
IDLE
) {

597 
	`DPRINTF
(
D¿š
, "Crossbar‚ot drained\n");

598  
D¿šS‹
::
D¿ššg
;

600  
D¿šS‹
::
D¿šed
;

602 
	}
}

604 
	g‹m¶©e
 <
ty³Çme
 
	gSrcTy³
,y³Çm
	gD¡Ty³
>

606 
	gBa£XB¬
::
Lay”
<
SrcTy³
,
	gD¡Ty³
>::
	$»gSts
()

608 
usšg
 
Çme¥aû
 
Sts
;

610 
occu·ncy


611 .
	`Çme
(name() + ".occupancy")

612 .
	`desc
("Layer occupancy (ticks)")

613 .
	`æags
(
noz”o
);

615 
utiz©iÚ


616 .
	`Çme
(name() + ".utilization")

617 .
	`desc
("Layer utilization (%)")

618 .
	`´ecisiÚ
(1)

619 .
	`æags
(
noz”o
);

621 
utiz©iÚ
 = 100 * 
occu·ncy
 / 
simTicks
;

622 
	}
}

629 
‹m¶©e
 
şass
 
	gBa£XB¬
::
Lay”
<
SÏvePÜt
,
	gMa¡”PÜt
>;

630 
‹m¶©e
 
şass
 
	gBa£XB¬
::
Lay”
<
Ma¡”PÜt
,
	gSÏvePÜt
>;

	@xbar.hh

51 #iâdeà
__MEM_XBAR_HH__


52 
	#__MEM_XBAR_HH__


	)

54 
	~<deque
>

55 
	~<unÜd”ed_m­
>

57 
	~"ba£/addr_¿nge_m­.hh
"

58 
	~"ba£/ty³s.hh
"

59 
	~"mem/mem_objeù.hh
"

60 
	~"mem/qpÜt.hh
"

61 
	~"·¿ms/Ba£XB¬.hh
"

62 
	~"sim/¡©s.hh
"

73 şas 
	cBa£XB¬
 : 
public
 
MemObjeù


76 
´Ùeùed
:

92 
‹m¶©e
 <
ty³Çme
 
SrcTy³
,y³Çm
	mD¡Ty³
>

93 şas 
	cLay”
 : 
public
 
D¿šabË


96 
public
:

106 
Lay”
(
D¡Ty³
& 
_pÜt
, 
Ba£XB¬
& 
_xb¬
, cÚ¡ 
¡d
::
¡ršg
& 
_Çme
);

117 
D¿šS‹
 
d¿š
(è
	mov”ride
;

122 cÚ¡ 
	m¡d
::
¡ršg
 
Çme
(ècÚ¡ {  
xb¬
.Çme(è+ 
_Çme
; }

135 
boŞ
 
ŒyTimšg
(
SrcTy³
* 
¤c_pÜt
);

144 
sucûededTimšg
(
Tick
 
busy_time
);

155 
çedTimšg
(
SrcTy³
* 
¤c_pÜt
, 
Tick
 
busy_time
);

158 
occupyLay”
(
Tick
 
uÁ
);

164 
»ŒyWa™šg
();

171 
»cvR‘ry
();

176 
»gSts
();

178 
	m´Ùeùed
:

186 
vœtu®
 
£ndR‘ry
(
SrcTy³
* 
»Œy_pÜt
) = 0;

188 
	m´iv©e
:

191 
D¡Ty³
& 
pÜt
;

194 
	mBa£XB¬
& 
	mxb¬
;

197 
	m¡d
::
¡ršg
 
_Çme
;

215 
	eS‹
 { 
	mIDLE
, 
	mBUSY
, 
	mRETRY
 };

218 
S‹
 
	m¡©e
;

224 
	m¡d
::
deque
<
SrcTy³
*> 
wa™šgFÜLay”
;

230 
SrcTy³
* 
	mwa™šgFÜP“r
;

237 
»Ëa£Lay”
();

240 
	mEv’tW¿µ”
<
	mLay”
, &Lay”::
»Ëa£Lay”
> 
»Ëa£Ev’t
;

247 
	mSts
::
SÿÏr
 
occu·ncy
;

248 
	mSts
::
FÜmuÏ
 
utiz©iÚ
;

252 
şass
 
	gReqLay”
 : 
public
 
Lay”
<
SÏvePÜt
,
	gMa¡”PÜt
>

254 
	gpublic
:

262 
ReqLay”
(
Ma¡”PÜt
& 
_pÜt
, 
Ba£XB¬
& 
_xb¬
, cÚ¡ 
¡d
::
¡ršg
& 
_Çme
) :

263 
Lay”
(
_pÜt
, 
_xb¬
, 
_Çme
) {}

265 
	g´Ùeùed
:

267 
£ndR‘ry
(
SÏvePÜt
* 
»Œy_pÜt
)

268 { 
»Œy_pÜt
->
£ndR‘ryReq
(); }

271 
şass
 
	gRe¥Lay”
 : 
public
 
Lay”
<
Ma¡”PÜt
,
	gSÏvePÜt
>

273 
	gpublic
:

281 
Re¥Lay”
(
SÏvePÜt
& 
_pÜt
, 
Ba£XB¬
& 
_xb¬
, cÚ¡ 
¡d
::
¡ršg
& 
_Çme
) :

282 
Lay”
(
_pÜt
, 
_xb¬
, 
_Çme
) {}

284 
	g´Ùeùed
:

286 
£ndR‘ry
(
Ma¡”PÜt
* 
»Œy_pÜt
)

287 { 
»Œy_pÜt
->
£ndR‘ryRe¥
(); }

290 
şass
 
	gSnoİRe¥Lay”
 : 
public
 
Lay”
<
SÏvePÜt
,
	gMa¡”PÜt
>

292 
	gpublic
:

300 
SnoİRe¥Lay”
(
Ma¡”PÜt
& 
_pÜt
, 
Ba£XB¬
& 
_xb¬
,

301 cÚ¡ 
¡d
::
¡ršg
& 
_Çme
) :

302 
Lay”
(
_pÜt
, 
_xb¬
, 
_Çme
) {}

304 
	g´Ùeùed
:

306 
£ndR‘ry
(
SÏvePÜt
* 
»Œy_pÜt
)

307 { 
»Œy_pÜt
->
£ndR‘rySnoİRe¥
(); }

314 cÚ¡ 
Cyşes
 
	gäÚ‹ndL©’cy
;

316 cÚ¡ 
Cyşes
 
	gfÜw¬dL©’cy
;

318 cÚ¡ 
Cyşes
 
	g»¥Ú£L©’cy
;

320 cÚ¡ 
ušt32_t
 
	gwidth
;

322 
	gAddrRªgeM­
<
	gPÜtID
> 
	gpÜtM­
;

330 
	g¡d
::
unÜd”ed_m­
<
Reque¡PŒ
, 
	gPÜtID
> 
	grou‹To
;

333 
AddrRªgeLi¡
 
	gxb¬Rªges
;

335 
AddrRªge
 
	gdeçuÉRªge
;

343 
vœtu®
 
»cvRªgeChªge
(
PÜtID
 
ma¡”_pÜt_id
);

351 
PÜtID
 
fšdPÜt
(
Addr
 
addr
);

354 
	sPÜtCache
 {

355 
boŞ
 
	gv®id
;

356 
PÜtID
 
	gid
;

357 
AddrRªge
 
	g¿nge
;

360 
PÜtCache
 
	gpÜtCache
[3];

364 
šlše
 
PÜtID
 
	$checkPÜtCache
(
Addr
 
addr
) const {

365 ià(
pÜtCache
[0].
v®id
 &&…ÜtCache[0].
¿nge
.
	`cÚšs
(
addr
)) {

366  
pÜtCache
[0].
id
;

368 ià(
pÜtCache
[1].
v®id
 &&…ÜtCache[1].
¿nge
.
	`cÚšs
(
addr
)) {

369  
pÜtCache
[1].
id
;

371 ià(
pÜtCache
[2].
v®id
 &&…ÜtCache[2].
¿nge
.
	`cÚšs
(
addr
)) {

372  
pÜtCache
[2].
id
;

375  
Inv®idPÜtID
;

376 
	}
}

379 
šlše
 
	$upd©ePÜtCache
(
id
, cÚ¡ 
AddrRªge
& 
¿nge
) {

380 
pÜtCache
[2].
v®id
 =…ortCache[1].valid;

381 
pÜtCache
[2].
id
 =…ortCache[1].id;

382 
pÜtCache
[2].
¿nge
 =…ortCache[1].range;

384 
pÜtCache
[1].
v®id
 =…ortCache[0].valid;

385 
pÜtCache
[1].
id
 =…ortCache[0].id;

386 
pÜtCache
[1].
¿nge
 =…ortCache[0].range;

388 
pÜtCache
[0].
v®id
 = 
Œue
;

389 
pÜtCache
[0].
id
 = id;

390 
pÜtCache
[0].
¿nge
 =„ange;

391 
	}
}

394 
šlše
 
	$ş—rPÜtCache
() {

395 
pÜtCache
[2].
v®id
 = 
çl£
;

396 
pÜtCache
[1].
v®id
 = 
çl£
;

397 
pÜtCache
[0].
v®id
 = 
çl£
;

398 
	}
}

405 
AddrRªgeLi¡
 
	$g‘AddrRªges
() const;

416 
	`ÿlcPack‘Timšg
(
Pack‘PŒ
 
pkt
, 
Tick
 
h—d”_d–ay
);

424 
¡d
::
veùÜ
<
boŞ
> 
gÙAddrRªges
;

425 
boŞ
 
gÙAÎAddrRªges
;

428 
¡d
::
veùÜ
<
QueuedSÏvePÜt
*> 
¦avePÜts
;

429 
¡d
::
veùÜ
<
Ma¡”PÜt
*> 
ma¡”PÜts
;

432 
PÜtID
 
deçuÉPÜtID
;

438 cÚ¡ 
boŞ
 
u£DeçuÉRªge
;

440 
	`Ba£XB¬
(cÚ¡ 
Ba£XB¬P¬ams
 *
p
);

442 
vœtu®
 ~
	`Ba£XB¬
();

453 
Sts
::
VeùÜ
 
ŒªsDi¡
;

454 
Sts
::
VeùÜ2d
 
pktCouÁ
;

455 
Sts
::
VeùÜ2d
 
pktSize
;

457 
public
:

459 
vœtu®
 
	`š™
();

462 
Ba£Ma¡”PÜt
& 
	`g‘Ma¡”PÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

463 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

464 
Ba£SÏvePÜt
& 
	`g‘SÏvePÜt
(cÚ¡ 
¡d
::
¡ršg
& 
if_Çme
,

465 
PÜtID
 
idx
 = 
Inv®idPÜtID
);

467 
vœtu®
 
	`»gSts
();

469 
	}
};

	@/usr/include/fcntl.h

22 #iâdef 
_FCNTL_H


23 
	#_FCNTL_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/ty³s.h
>

35 
	~<b™s/fú.h
>

40 #iâdeà
__mode_t_defšed


41 
__mode_t
 
	tmode_t
;

42 
	#__mode_t_defšed


	)

45 #iâdeà
__off_t_defšed


46 #iâdeà
__USE_FILE_OFFSET64


47 
__off_t
 
	toff_t
;

49 
__off64_t
 
	toff_t
;

51 
	#__off_t_defšed


	)

54 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


55 
__off64_t
 
	toff64_t
;

56 
	#__off64_t_defšed


	)

59 #iâdeà
__pid_t_defšed


60 
__pid_t
 
	tpid_t
;

61 
	#__pid_t_defšed


	)

65 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


66 
	#__Ãed_time¥ec


	)

67 
	~<time.h
>

68 
	~<b™s/¡©.h
>

70 
	#S_IFMT
 
__S_IFMT


	)

71 
	#S_IFDIR
 
__S_IFDIR


	)

72 
	#S_IFCHR
 
__S_IFCHR


	)

73 
	#S_IFBLK
 
__S_IFBLK


	)

74 
	#S_IFREG
 
__S_IFREG


	)

75 #ifdeà
__S_IFIFO


76 
	#S_IFIFO
 
__S_IFIFO


	)

78 #ifdeà
__S_IFLNK


79 
	#S_IFLNK
 
__S_IFLNK


	)

81 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


82 
	#S_IFSOCK
 
__S_IFSOCK


	)

87 
	#S_ISUID
 
__S_ISUID


	)

88 
	#S_ISGID
 
__S_ISGID


	)

90 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


92 
	#S_ISVTX
 
__S_ISVTX


	)

95 
	#S_IRUSR
 
__S_IREAD


	)

96 
	#S_IWUSR
 
__S_IWRITE


	)

97 
	#S_IXUSR
 
__S_IEXEC


	)

99 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

101 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

102 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

103 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

105 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

107 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

108 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

109 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

111 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

114 #ifdef 
__USE_MISC


115 #iâdeà
R_OK


118 
	#R_OK
 4

	)

119 
	#W_OK
 2

	)

120 
	#X_OK
 1

	)

121 
	#F_OK
 0

	)

126 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


127 
	#SEEK_SET
 0

	)

128 
	#SEEK_CUR
 1

	)

129 
	#SEEK_END
 2

	)

137 
fú
 (
__fd
, 
__cmd
, ...);

145 #iâdeà
__USE_FILE_OFFSET64


146 
	$İ’
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

148 #ifdeà
__REDIRECT


149 
	`__REDIRECT
 (
İ’
, (cÚ¡ *
__fe
, 
__oæag
, ...), 
İ’64
)

150 
	`__nÚnuÎ
 ((1));

152 
	#İ’
 
İ’64


	)

155 #ifdeà
__USE_LARGEFILE64


156 
	$İ’64
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

159 #ifdeà
__USE_ATFILE


169 #iâdeà
__USE_FILE_OFFSET64


170 
	$İ’©
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

171 
	`__nÚnuÎ
 ((2));

173 #ifdeà
__REDIRECT


174 
	`__REDIRECT
 (
İ’©
, (
__fd
, cÚ¡ *
__fe
, 
__oæag
,

175 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

177 
	#İ’©
 
İ’©64


	)

180 #ifdeà
__USE_LARGEFILE64


181 
	$İ’©64
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

182 
	`__nÚnuÎ
 ((2));

191 #iâdeà
__USE_FILE_OFFSET64


192 
	$ü—t
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

194 #ifdeà
__REDIRECT


195 
	`__REDIRECT
 (
ü—t
, (cÚ¡ *
__fe
, 
mode_t
 
__mode
),

196 
ü—t64
è
	`__nÚnuÎ
 ((1));

198 
	#ü—t
 
ü—t64


	)

201 #ifdeà
__USE_LARGEFILE64


202 
	$ü—t64
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

205 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

206 && !
defšed
 
__USE_POSIX
))

215 
	#F_ULOCK
 0

	)

216 
	#F_LOCK
 1

	)

217 
	#F_TLOCK
 2

	)

218 
	#F_TEST
 3

	)

220 #iâdeà
__USE_FILE_OFFSET64


221 
	`lockf
 (
__fd
, 
__cmd
, 
off_t
 
__Ën
);

223 #ifdeà
__REDIRECT


224 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

226 
	#lockf
 
lockf64


	)

229 #ifdeà
__USE_LARGEFILE64


230 
	`lockf64
 (
__fd
, 
__cmd
, 
off64_t
 
__Ën
);

234 #ifdeà
__USE_XOPEN2K


237 #iâdeà
__USE_FILE_OFFSET64


238 
	$posix_çdvi£
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
,

239 
__advi£
è
__THROW
;

241 #ifdeà
__REDIRECT_NTH


242 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

243 
__off64_t
 
__Ën
, 
__advi£
),

244 
posix_çdvi£64
);

246 
	#posix_çdvi£
 
posix_çdvi£64


	)

249 #ifdeà
__USE_LARGEFILE64


250 
	$posix_çdvi£64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
,

251 
__advi£
è
__THROW
;

259 #iâdeà
__USE_FILE_OFFSET64


260 
	`posix_çÎoÿ‹
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
);

262 #ifdeà
__REDIRECT


263 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

264 
__off64_t
 
__Ën
),

265 
posix_çÎoÿ‹64
);

267 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

270 #ifdeà
__USE_LARGEFILE64


271 
	`posix_çÎoÿ‹64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
);

277 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ
 \

278 && 
defšed
 
__va_¬g_·ck_Ën


279 
	~<b™s/fú2.h
>

282 
__END_DECLS


	@/usr/include/inttypes.h

22 #iâdeà
_INTTYPES_H


23 
	#_INTTYPES_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<¡dšt.h
>

30 #iâdeà
____gwch¬_t_defšed


31 #ifdeà
__ılu¥lus


32 
	#__gwch¬_t
 
wch¬_t


	)

33 #–ià
defšed
 
__WCHAR_TYPE__


34 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

36 
	#__Ãed_wch¬_t


	)

37 
	~<¡ddef.h
>

38 
wch¬_t
 
	t__gwch¬_t
;

40 
	#____gwch¬_t_defšed
 1

	)

43 #ià
__WORDSIZE
 == 64

44 
	#__PRI64_PREFIX
 "l"

	)

45 
	#__PRIPTR_PREFIX
 "l"

	)

47 
	#__PRI64_PREFIX
 "Î"

	)

48 
	#__PRIPTR_PREFIX


	)

54 
	#PRId8
 "d"

	)

55 
	#PRId16
 "d"

	)

56 
	#PRId32
 "d"

	)

57 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

59 
	#PRIdLEAST8
 "d"

	)

60 
	#PRIdLEAST16
 "d"

	)

61 
	#PRIdLEAST32
 "d"

	)

62 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

64 
	#PRIdFAST8
 "d"

	)

65 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

66 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

67 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIi8
 "i"

	)

71 
	#PRIi16
 "i"

	)

72 
	#PRIi32
 "i"

	)

73 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

75 
	#PRIiLEAST8
 "i"

	)

76 
	#PRIiLEAST16
 "i"

	)

77 
	#PRIiLEAST32
 "i"

	)

78 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

80 
	#PRIiFAST8
 "i"

	)

81 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

82 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

83 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIo8
 "o"

	)

87 
	#PRIo16
 "o"

	)

88 
	#PRIo32
 "o"

	)

89 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

91 
	#PRIoLEAST8
 "o"

	)

92 
	#PRIoLEAST16
 "o"

	)

93 
	#PRIoLEAST32
 "o"

	)

94 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

96 
	#PRIoFAST8
 "o"

	)

97 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

98 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

99 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIu8
 "u"

	)

103 
	#PRIu16
 "u"

	)

104 
	#PRIu32
 "u"

	)

105 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

107 
	#PRIuLEAST8
 "u"

	)

108 
	#PRIuLEAST16
 "u"

	)

109 
	#PRIuLEAST32
 "u"

	)

110 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

112 
	#PRIuFAST8
 "u"

	)

113 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

114 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

115 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIx8
 "x"

	)

119 
	#PRIx16
 "x"

	)

120 
	#PRIx32
 "x"

	)

121 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

123 
	#PRIxLEAST8
 "x"

	)

124 
	#PRIxLEAST16
 "x"

	)

125 
	#PRIxLEAST32
 "x"

	)

126 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

128 
	#PRIxFAST8
 "x"

	)

129 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

130 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

131 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIX8
 "X"

	)

135 
	#PRIX16
 "X"

	)

136 
	#PRIX32
 "X"

	)

137 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

139 
	#PRIXLEAST8
 "X"

	)

140 
	#PRIXLEAST16
 "X"

	)

141 
	#PRIXLEAST32
 "X"

	)

142 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

144 
	#PRIXFAST8
 "X"

	)

145 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

146 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

147 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

151 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

152 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

153 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

154 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

155 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

156 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

160 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

161 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

162 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

163 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

164 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

165 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

171 
	#SCNd8
 "hhd"

	)

172 
	#SCNd16
 "hd"

	)

173 
	#SCNd32
 "d"

	)

174 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

176 
	#SCNdLEAST8
 "hhd"

	)

177 
	#SCNdLEAST16
 "hd"

	)

178 
	#SCNdLEAST32
 "d"

	)

179 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

181 
	#SCNdFAST8
 "hhd"

	)

182 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

183 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

184 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNi8
 "hhi"

	)

188 
	#SCNi16
 "hi"

	)

189 
	#SCNi32
 "i"

	)

190 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

192 
	#SCNiLEAST8
 "hhi"

	)

193 
	#SCNiLEAST16
 "hi"

	)

194 
	#SCNiLEAST32
 "i"

	)

195 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

197 
	#SCNiFAST8
 "hhi"

	)

198 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

199 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

200 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNu8
 "hhu"

	)

204 
	#SCNu16
 "hu"

	)

205 
	#SCNu32
 "u"

	)

206 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

208 
	#SCNuLEAST8
 "hhu"

	)

209 
	#SCNuLEAST16
 "hu"

	)

210 
	#SCNuLEAST32
 "u"

	)

211 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

213 
	#SCNuFAST8
 "hhu"

	)

214 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

215 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

216 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNo8
 "hho"

	)

220 
	#SCNo16
 "ho"

	)

221 
	#SCNo32
 "o"

	)

222 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

224 
	#SCNoLEAST8
 "hho"

	)

225 
	#SCNoLEAST16
 "ho"

	)

226 
	#SCNoLEAST32
 "o"

	)

227 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

229 
	#SCNoFAST8
 "hho"

	)

230 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

231 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

232 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNx8
 "hhx"

	)

236 
	#SCNx16
 "hx"

	)

237 
	#SCNx32
 "x"

	)

238 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

240 
	#SCNxLEAST8
 "hhx"

	)

241 
	#SCNxLEAST16
 "hx"

	)

242 
	#SCNxLEAST32
 "x"

	)

243 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

245 
	#SCNxFAST8
 "hhx"

	)

246 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

247 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

248 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

252 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

253 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

254 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

255 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

256 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

259 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

260 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

261 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

262 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

263 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

266 
	g__BEGIN_DECLS


268 #ià
__WORDSIZE
 == 64

273 
	mquÙ
;

274 
	m»m
;

275 } 
	timaxdiv_t
;

282 
__ex‹nsiÚ__
 
	mquÙ
;

283 
__ex‹nsiÚ__
 
	m»m
;

284 } 
	timaxdiv_t
;

290 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

293 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

294 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

297 
štmax_t
 
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

298 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

301 
uštmax_t
 
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

302 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

305 
štmax_t
 
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

306 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

307 
__THROW
;

310 
uštmax_t
 
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

311 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

312 
__THROW
;

314 #ifdeà
__USE_EXTERN_INLINES


316 #ià
__WORDSIZE
 == 64

318 
	$__¡¹Ş_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

319 **
__»¡riù
 
__’d±r
,

320 
__ba£
, 
__group
)

321 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

323 
__ex‹º_šlše
 
štmax_t


324 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

325 
ba£
))

327  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

328 
	}
}

330 
	$__¡¹oul_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

331 ** 
__»¡riù
 
__’d±r
,

332 
__ba£
, 
__group
)

333 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

335 
__ex‹º_šlše
 
uštmax_t


336 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

337 
ba£
))

339  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

340 
	}
}

342 
	$__wc¡Ş_š‹º®
 (cÚ¡ 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

343 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

344 
__ba£
, 
__group
)

345 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

347 
__ex‹º_šlše
 
štmax_t


348 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

349 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

351  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

352 
	}
}

354 
	$__wc¡oul_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

355 
__»¡riù
 
__ÅŒ
,

356 
__gwch¬_t
 **

357 
__»¡riù
 
__’d±r
,

358 
__ba£
, 
__group
)

359 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

361 
__ex‹º_šlše
 
uštmax_t


362 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

363 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

365  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

366 
	}
}

370 
__ex‹nsiÚ__


371 
	$__¡¹Şl_š‹º®
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

372 **
__»¡riù
 
__’d±r
,

373 
__ba£
, 
__group
)

374 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

376 
__ex‹º_šlše
 
štmax_t


377 
	`__NTH
 (
	$¡¹oimax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

378 
ba£
))

380  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

381 
	}
}

383 
__ex‹nsiÚ__


384 
	$__¡¹ouÎ_š‹º®
 (const *

385 
__»¡riù
 
__ÅŒ
,

387 
__»¡riù
 
__’d±r
,

388 
__ba£
,

389 
__group
)

390 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

392 
__ex‹º_šlše
 
uštmax_t


393 
	`__NTH
 (
	$¡¹oumax
 (cÚ¡ *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

394 
ba£
))

396  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

397 
	}
}

399 
__ex‹nsiÚ__


400 
	$__wc¡Şl_š‹º®
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

401 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

402 
__ba£
, 
__group
)

403 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

405 
__ex‹º_šlše
 
štmax_t


406 
	`__NTH
 (
	$wc¡oimax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

407 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

409  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

410 
	}
}

413 
__ex‹nsiÚ__


414 
	$__wc¡ouÎ_š‹º®
 (cÚ¡ 
__gwch¬_t
 *

415 
__»¡riù
 
__ÅŒ
,

416 
__gwch¬_t
 **

417 
__»¡riù
 
__’d±r
,

418 
__ba£
,

419 
__group
)

420 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

422 
__ex‹º_šlše
 
uštmax_t


423 
	`__NTH
 (
	$wc¡oumax
 (cÚ¡ 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

424 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

426  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

427 
	}
}

432 
	g__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

71 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

75 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

79 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

83 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

86 #ifdeà
__USE_XOPEN2K8


87 
	#_XOPEN_VERSION
 700

	)

88 #–ià
defšed
 
__USE_XOPEN2K


89 
	#_XOPEN_VERSION
 600

	)

90 #–ià
defšed
 
__USE_UNIX98


91 
	#_XOPEN_VERSION
 500

	)

93 
	#_XOPEN_VERSION
 4

	)

97 
	#_XOPEN_XCU_VERSION
 4

	)

100 
	#_XOPEN_XPG2
 1

	)

101 
	#_XOPEN_XPG3
 1

	)

102 
	#_XOPEN_XPG4
 1

	)

105 
	#_XOPEN_UNIX
 1

	)

108 
	#_XOPEN_CRYPT
 1

	)

112 
	#_XOPEN_ENH_I18N
 1

	)

115 
	#_XOPEN_LEGACY
 1

	)

202 
	~<b™s/posix_İt.h
>

205 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


206 
	~<b™s/’vœÚm’ts.h
>

210 
	#STDIN_FILENO
 0

	)

211 
	#STDOUT_FILENO
 1

	)

212 
	#STDERR_FILENO
 2

	)

217 
	~<b™s/ty³s.h
>

219 #iâdef 
__ssize_t_defšed


220 
__ssize_t
 
	tssize_t
;

221 
	#__ssize_t_defšed


	)

224 
	#__Ãed_size_t


	)

225 
	#__Ãed_NULL


	)

226 
	~<¡ddef.h
>

228 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


231 #iâdeà
__gid_t_defšed


232 
__gid_t
 
	tgid_t
;

233 
	#__gid_t_defšed


	)

236 #iâdeà
__uid_t_defšed


237 
__uid_t
 
	tuid_t
;

238 
	#__uid_t_defšed


	)

241 #iâdeà
__off_t_defšed


242 #iâdeà
__USE_FILE_OFFSET64


243 
__off_t
 
	toff_t
;

245 
__off64_t
 
	toff_t
;

247 
	#__off_t_defšed


	)

249 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


250 
__off64_t
 
	toff64_t
;

251 
	#__off64_t_defšed


	)

254 #iâdeà
__u£cÚds_t_defšed


255 
__u£cÚds_t
 
	tu£cÚds_t
;

256 
	#__u£cÚds_t_defšed


	)

259 #iâdeà
__pid_t_defšed


260 
__pid_t
 
	tpid_t
;

261 
	#__pid_t_defšed


	)

265 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


266 #iâdeà
__šŒ_t_defšed


267 
__šŒ_t
 
	tšŒ_t
;

268 
	#__šŒ_t_defšed


	)

272 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN


273 #iâdeà
__sockËn_t_defšed


274 
__sockËn_t
 
	tsockËn_t
;

275 
	#__sockËn_t_defšed


	)

281 
	#R_OK
 4

	)

282 
	#W_OK
 2

	)

283 
	#X_OK
 1

	)

284 
	#F_OK
 0

	)

287 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

289 #ifdeà
__USE_GNU


292 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

293 
__THROW
 
	`__nÚnuÎ
 ((1));

296 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

297 
__THROW
 
	`__nÚnuÎ
 ((1));

300 #ifdeà
__USE_ATFILE


304 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

305 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

310 #iâdef 
_STDIO_H


311 
	#SEEK_SET
 0

	)

312 
	#SEEK_CUR
 1

	)

313 
	#SEEK_END
 2

	)

314 #ifdeà
__USE_GNU


315 
	#SEEK_DATA
 3

	)

316 
	#SEEK_HOLE
 4

	)

320 #ià
defšed
 
__USE_BSD
 && !defšed 
L_SET


322 
	#L_SET
 
SEEK_SET


	)

323 
	#L_INCR
 
SEEK_CUR


	)

324 
	#L_XTND
 
SEEK_END


	)

333 #iâdeà
__USE_FILE_OFFSET64


334 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

336 #ifdeà
__REDIRECT_NTH


337 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

338 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

339 
l£ek64
);

341 
	#l£ek
 
l£ek64


	)

344 #ifdeà
__USE_LARGEFILE64


345 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

346 
__THROW
;

353 
	`şo£
 (
__fd
);

360 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

366 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

368 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


369 #iâdeà
__USE_FILE_OFFSET64


376 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

377 
__off_t
 
__off£t
è
__wur
;

384 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

385 
__off_t
 
__off£t
è
__wur
;

387 #ifdeà
__REDIRECT


388 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

389 
__off64_t
 
__off£t
),

390 
´—d64
è
__wur
;

391 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

392 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

393 
pwr™e64
è
__wur
;

395 
	#´—d
 
´—d64


	)

396 
	#pwr™e
 
pwr™e64


	)

400 #ifdeà
__USE_LARGEFILE64


404 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

405 
__off64_t
 
__off£t
è
__wur
;

408 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

409 
__off64_t
 
__off£t
è
__wur
;

417 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

419 #ifdeà
__USE_GNU


422 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

432 
	$®¬m
 (
__£cÚds
è
__THROW
;

444 
	`¦“p
 (
__£cÚds
);

446 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

447 || 
defšed
 
__USE_BSD


452 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

453 
__THROW
;

460 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

469 
	`·u£
 ();

473 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

474 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

476 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


478 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

483 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

484 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

488 #ifdeà
__USE_ATFILE


491 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

492 
__gid_t
 
__group
, 
__æag
)

493 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

497 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

499 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


501 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

511 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

513 #ifdef 
__USE_GNU


517 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

520 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

521 || 
defšed
 
__USE_BSD


525 *
	$g‘wd
 (*
__buf
)

526 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

531 
	$dup
 (
__fd
è
__THROW
 
__wur
;

534 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

536 #ifdeà
__USE_GNU


539 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

543 **
__’vœÚ
;

544 #ifdeà
__USE_GNU


545 **
’vœÚ
;

551 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

552 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

554 #ifdeà
__USE_XOPEN2K8


557 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

558 
__THROW
 
	`__nÚnuÎ
 ((2));

563 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

564 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

568 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

569 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

573 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

578 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

579 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

584 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

585 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

587 #ifdeà
__USE_GNU


590 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

591 *cÚ¡ 
__’vp
[])

592 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

596 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


598 
	$niû
 (
__šc
è
__THROW
 
__wur
;

603 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

609 
	~<b™s/cÚâame.h
>

612 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

613 
__THROW
 
	`__nÚnuÎ
 ((1));

616 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

619 
	$syscÚf
 (
__Çme
è
__THROW
;

621 #ifdef 
__USE_POSIX2


623 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

628 
__pid_t
 
	$g‘pid
 (è
__THROW
;

631 
__pid_t
 
	$g‘µid
 (è
__THROW
;

634 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

637 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

638 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


639 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

646 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

648 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


660 
	$£g½
 (è
__THROW
;

667 
__pid_t
 
	$£tsid
 (è
__THROW
;

669 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


671 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

675 
__uid_t
 
	$g‘uid
 (è
__THROW
;

678 
__uid_t
 
	$g‘euid
 (è
__THROW
;

681 
__gid_t
 
	$g‘gid
 (è
__THROW
;

684 
__gid_t
 
	$g‘egid
 (è
__THROW
;

689 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

691 #ifdef 
__USE_GNU


693 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

700 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

702 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


705 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

708 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


710 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

717 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

719 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


722 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

725 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


727 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

730 #ifdeà
__USE_GNU


733 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

734 
__THROW
;

738 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

739 
__THROW
;

743 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

744 
__THROW
 
__wur
;

748 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

749 
__THROW
 
__wur
;

756 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

758 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

759 || 
defšed
 
__USE_BSD


764 
__pid_t
 
	$vfÜk
 (è
__THROW
;

770 *
	$‰yÇme
 (
__fd
è
__THROW
;

774 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

775 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

779 
	$i§‰y
 (
__fd
è
__THROW
;

781 #ià
defšed
 
__USE_BSD
 \

782 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

785 
	$‰y¦Ù
 (è
__THROW
;

790 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

791 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

793 #ifdeà
__USE_ATFILE


796 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

797 cÚ¡ *
__to
, 
__æags
)

798 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

801 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


803 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

804 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

809 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

810 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

811 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

814 #ifdeà
__USE_ATFILE


816 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

817 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

820 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

821 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

822 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

826 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

828 #ifdeà
__USE_ATFILE


830 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

831 
__THROW
 
	`__nÚnuÎ
 ((2));

835 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

839 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

842 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

849 *
	`g‘logš
 ();

850 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


857 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

860 #ifdef 
__USE_BSD


862 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

866 #ifdef 
__USE_POSIX2


870 
	#__Ãed_g‘İt


	)

871 
	~<g‘İt.h
>

875 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


879 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

883 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_UNIX98
)

886 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

887 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

891 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

897 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

898 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

899 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

900 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

906 
	$vhªgup
 (è
__THROW
;

909 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

917 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

918 
size_t
 
__off£t
, 
__sÿË
)

919 
__THROW
 
	`__nÚnuÎ
 ((1));

925 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

929 *
	$g‘u£rsh–l
 (è
__THROW
;

930 
	$’du£rsh–l
 (è
__THROW
;

931 
	$£tu£rsh–l
 (è
__THROW
;

937 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

941 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

944 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

948 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

956 
	`fsync
 (
__fd
);

959 #ifdeà
__USE_GNU


962 
	$syncfs
 (
__fd
è
__THROW
;

966 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


969 
	`g‘ho¡id
 ();

972 
	$sync
 (è
__THROW
;

975 #ià
defšed
 
__USE_BSD
 || !defšed 
__USE_XOPEN2K


978 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

983 
	$g‘dbËsize
 (è
__THROW
;

989 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


992 #iâdeà
__USE_FILE_OFFSET64


993 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

994 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

996 #ifdeà
__REDIRECT_NTH


997 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

998 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

999 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1001 
	#Œunÿ‹
 
Œunÿ‹64


	)

1004 #ifdeà
__USE_LARGEFILE64


1005 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1006 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1011 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_POSIX199309
 \

1012 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1015 #iâdeà
__USE_FILE_OFFSET64


1016 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1018 #ifdeà
__REDIRECT_NTH


1019 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1020 
árunÿ‹64
è
__wur
;

1022 
	#árunÿ‹
 
árunÿ‹64


	)

1025 #ifdeà
__USE_LARGEFILE64


1026 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1032 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1033 || 
defšed
 
__USE_MISC


1037 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1043 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1047 #ifdeà
__USE_MISC


1058 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1063 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1075 
	#F_ULOCK
 0

	)

1076 
	#F_LOCK
 1

	)

1077 
	#F_TLOCK
 2

	)

1078 
	#F_TEST
 3

	)

1080 #iâdeà
__USE_FILE_OFFSET64


1081 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1083 #ifdeà
__REDIRECT


1084 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1085 
lockf64
è
__wur
;

1087 
	#lockf
 
lockf64


	)

1090 #ifdeà
__USE_LARGEFILE64


1091 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1096 #ifdeà
__USE_GNU


1101 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1102 (
__ex‹nsiÚ__
 \

1103 ({ 
__»suÉ
; \

1104 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1105 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1106 
__»suÉ
; 
	}
}))

	)

1109 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1112 
fd©async
 (
__fdes
);

1118 #ifdef 
__USE_XOPEN


1120 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1121 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1125 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1126 
__THROW
 
	`__nÚnuÎ
 ((1));

1133 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1134 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1140 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1142 *
	$ù”mid
 (*
__s
è
__THROW
;

1147 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1148 
	~<b™s/uni¡d.h
>

1151 
__END_DECLS


	@/usr/include/zlib.h

31 #iâdeà
ZLIB_H


32 
	#ZLIB_H


	)

34 
	~"zcÚf.h
"

36 #ifdeà
__ılu¥lus


40 
	#ZLIB_VERSION
 "1.2.8"

	)

41 
	#ZLIB_VERNUM
 0x1280

	)

42 
	#ZLIB_VER_MAJOR
 1

	)

43 
	#ZLIB_VER_MINOR
 2

	)

44 
	#ZLIB_VER_REVISION
 8

	)

45 
	#ZLIB_VER_SUBREVISION
 0

	)

80 
voidpf
 (*
	t®loc_func
è
	tOF
((
	tvoidpf
 
	tİaque
, 
	tuIÁ
 
	t™ems
, uIÁ 
	tsize
));

81 (*
ä“_func
è
	tOF
((
	tvoidpf
 
	tİaque
, voidpà
	tadd»ss
));

83 
š‹º®_¡©e
;

85 
	sz_¡»am_s
 {

86 
z_cÚ¡
 
By‹f
 *
Ãxt_š
;

87 
uIÁ
 
ava_š
;

88 
uLÚg
 
tÙ®_š
;

90 
By‹f
 *
Ãxt_out
;

91 
uIÁ
 
ava_out
;

92 
uLÚg
 
tÙ®_out
;

94 
z_cÚ¡
 *
msg
;

95 
š‹º®_¡©e
 
FAR
 *
¡©e
;

97 
®loc_func
 
z®loc
;

98 
ä“_func
 
zä“
;

99 
voidpf
 
İaque
;

101 
d©a_ty³
;

102 
uLÚg
 
adËr
;

103 
uLÚg
 
»£rved
;

104 } 
	tz_¡»am
;

106 
z_¡»am
 
	tFAR
 *
	tz_¡»amp
;

112 
	sgz_h—d”_s
 {

113 
‹xt
;

114 
uLÚg
 
time
;

115 
xæags
;

116 
os
;

117 
By‹f
 *
exŒa
;

118 
uIÁ
 
exŒa_Ën
;

119 
uIÁ
 
exŒa_max
;

120 
By‹f
 *
Çme
;

121 
uIÁ
 
Çme_max
;

122 
By‹f
 *
comm’t
;

123 
uIÁ
 
comm_max
;

124 
hüc
;

125 
dÚe
;

127 } 
	tgz_h—d”
;

129 
gz_h—d”
 
	tFAR
 *
	tgz_h—d”p
;

164 
	#Z_NO_FLUSH
 0

	)

165 
	#Z_PARTIAL_FLUSH
 1

	)

166 
	#Z_SYNC_FLUSH
 2

	)

167 
	#Z_FULL_FLUSH
 3

	)

168 
	#Z_FINISH
 4

	)

169 
	#Z_BLOCK
 5

	)

170 
	#Z_TREES
 6

	)

173 
	#Z_OK
 0

	)

174 
	#Z_STREAM_END
 1

	)

175 
	#Z_NEED_DICT
 2

	)

176 
	#Z_ERRNO
 (-1)

	)

177 
	#Z_STREAM_ERROR
 (-2)

	)

178 
	#Z_DATA_ERROR
 (-3)

	)

179 
	#Z_MEM_ERROR
 (-4)

	)

180 
	#Z_BUF_ERROR
 (-5)

	)

181 
	#Z_VERSION_ERROR
 (-6)

	)

186 
	#Z_NO_COMPRESSION
 0

	)

187 
	#Z_BEST_SPEED
 1

	)

188 
	#Z_BEST_COMPRESSION
 9

	)

189 
	#Z_DEFAULT_COMPRESSION
 (-1)

	)

192 
	#Z_FILTERED
 1

	)

193 
	#Z_HUFFMAN_ONLY
 2

	)

194 
	#Z_RLE
 3

	)

195 
	#Z_FIXED
 4

	)

196 
	#Z_DEFAULT_STRATEGY
 0

	)

199 
	#Z_BINARY
 0

	)

200 
	#Z_TEXT
 1

	)

201 
	#Z_ASCII
 
Z_TEXT


	)

202 
	#Z_UNKNOWN
 2

	)

205 
	#Z_DEFLATED
 8

	)

208 
	#Z_NULL
 0

	)

210 
	#zlib_v”siÚ
 
	`zlibV”siÚ
()

	)

216 
ZEXTERN
 cÚ¡ * 
ZEXPORT
 
zlibV”siÚ
 
OF
(());

246 
ZEXTERN
 
ZEXPORT
 
deæ©e
 
OF
((
z_¡»amp
 
¡rm
, 
æush
));

353 
ZEXTERN
 
ZEXPORT
 
deæ©eEnd
 
OF
((
z_¡»amp
 
¡rm
));

392 
ZEXTERN
 
ZEXPORT
 
šæ©e
 
OF
((
z_¡»amp
 
¡rm
, 
æush
));

508 
ZEXTERN
 
ZEXPORT
 
šæ©eEnd
 
OF
((
z_¡»amp
 
¡rm
));

587 
ZEXTERN
 
ZEXPORT
 
deæ©eS‘DiùiÚ¬y
 
OF
((
z_¡»amp
 
¡rm
,

588 cÚ¡ 
By‹f
 *
diùiÚ¬y
,

589 
uIÁ
 
diùL’gth
));

631 
ZEXTERN
 
ZEXPORT
 
deæ©eCİy
 
OF
((
z_¡»amp
 
de¡
,

632 
z_¡»amp
 
sourû
));

649 
ZEXTERN
 
ZEXPORT
 
deæ©eRe£t
 
OF
((
z_¡»amp
 
¡rm
));

660 
ZEXTERN
 
ZEXPORT
 
deæ©eP¬ams
 
OF
((
z_¡»amp
 
¡rm
,

661 
Ëv–
,

662 
¡¿‹gy
));

681 
ZEXTERN
 
ZEXPORT
 
deæ©eTuÃ
 
OF
((
z_¡»amp
 
¡rm
,

682 
good_Ëngth
,

683 
max_Ïzy
,

684 
niû_Ëngth
,

685 
max_chaš
));

698 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
deæ©eBound
 
OF
((
z_¡»amp
 
¡rm
,

699 
uLÚg
 
sourûL’
));

713 
ZEXTERN
 
ZEXPORT
 
deæ©eP’dšg
 
OF
((
z_¡»amp
 
¡rm
,

714 *
³ndšg
,

715 *
b™s
));

728 
ZEXTERN
 
ZEXPORT
 
deæ©ePrime
 
OF
((
z_¡»amp
 
¡rm
,

729 
b™s
,

730 
v®ue
));

745 
ZEXTERN
 
ZEXPORT
 
deæ©eS‘H—d”
 
OF
((
z_¡»amp
 
¡rm
,

746 
gz_h—d”p
 
h—d
));

819 
ZEXTERN
 
ZEXPORT
 
šæ©eS‘DiùiÚ¬y
 
OF
((
z_¡»amp
 
¡rm
,

820 cÚ¡ 
By‹f
 *
diùiÚ¬y
,

821 
uIÁ
 
diùL’gth
));

842 
ZEXTERN
 
ZEXPORT
 
šæ©eG‘DiùiÚ¬y
 
OF
((
z_¡»amp
 
¡rm
,

843 
By‹f
 *
diùiÚ¬y
,

844 
uIÁ
 *
diùL’gth
));

857 
ZEXTERN
 
ZEXPORT
 
šæ©eSync
 
OF
((
z_¡»amp
 
¡rm
));

876 
ZEXTERN
 
ZEXPORT
 
šæ©eCİy
 
OF
((
z_¡»amp
 
de¡
,

877 
z_¡»amp
 
sourû
));

892 
ZEXTERN
 
ZEXPORT
 
šæ©eRe£t
 
OF
((
z_¡»amp
 
¡rm
));

902 
ZEXTERN
 
ZEXPORT
 
šæ©eRe£t2
 
OF
((
z_¡»amp
 
¡rm
,

903 
wšdowB™s
));

914 
ZEXTERN
 
ZEXPORT
 
šæ©ePrime
 
OF
((
z_¡»amp
 
¡rm
,

915 
b™s
,

916 
v®ue
));

935 
ZEXTERN
 
ZEXPORT
 
šæ©eM¬k
 
OF
((
z_¡»amp
 
¡rm
));

963 
ZEXTERN
 
ZEXPORT
 
šæ©eG‘H—d”
 
OF
((
z_¡»amp
 
¡rm
,

964 
gz_h—d”p
 
h—d
));

1025 (*
š_func
è
	tOF
((
	tFAR
 *,

1026 
	tz_cÚ¡
 
	tFAR
 * FAR *));

1027 (*
out_func
è
	tOF
((
	tFAR
 *, FAR *, ));

1029 
ZEXTERN
 
ZEXPORT
 
šæ©eBack
 
OF
((
z_¡»amp
 
¡rm
,

1030 
š_func
 
š
, 
FAR
 *
š_desc
,

1031 
out_func
 
out
, 
FAR
 *
out_desc
));

1099 
ZEXTERN
 
ZEXPORT
 
šæ©eBackEnd
 
OF
((
z_¡»amp
 
¡rm
));

1107 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
zlibCompeFÏgs
 
OF
(());

1148 #iâdeà
Z_SOLO


1160 
ZEXTERN
 
ZEXPORT
 
com´ess
 
OF
((
By‹f
 *
de¡
, 
uLÚgf
 *
de¡L’
,

1161 cÚ¡ 
By‹f
 *
sourû
, 
uLÚg
 
sourûL’
));

1174 
ZEXTERN
 
ZEXPORT
 
com´ess2
 
OF
((
By‹f
 *
de¡
, 
uLÚgf
 *
de¡L’
,

1175 cÚ¡ 
By‹f
 *
sourû
, 
uLÚg
 
sourûL’
,

1176 
Ëv–
));

1190 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
com´essBound
 
OF
((uLÚg 
sourûL’
));

1197 
ZEXTERN
 
ZEXPORT
 
uncom´ess
 
OF
((
By‹f
 *
de¡
, 
uLÚgf
 *
de¡L’
,

1198 cÚ¡ 
By‹f
 *
sourû
, 
uLÚg
 
sourûL’
));

1224 
gzFe_s
 *
	tgzFe
;

1264 
ZEXTERN
 
gzFe
 
ZEXPORT
 
gzdİ’
 
OF
((
fd
, cÚ¡ *
mode
));

1287 
ZEXTERN
 
ZEXPORT
 
gzbufãr
 
OF
((
gzFe
 
fe
, 
size
));

1304 
ZEXTERN
 
ZEXPORT
 
gz£¬ams
 
OF
((
gzFe
 
fe
, 
Ëv–
, 
¡¿‹gy
));

1313 
ZEXTERN
 
ZEXPORT
 
gz»ad
 
OF
((
gzFe
 
fe
, 
voidp
 
buf
, 
Ën
));

1341 
ZEXTERN
 
ZEXPORT
 
gzwr™e
 
OF
((
gzFe
 
fe
,

1342 
voidpc
 
buf
, 
Ën
));

1349 
ZEXTERN
 
ZEXPORTVA
 
gz´štf
 
Z_ARG
((
gzFe
 
fe
, cÚ¡ *
fÜm©
, ...));

1364 
ZEXTERN
 
ZEXPORT
 
gzputs
 
OF
((
gzFe
 
fe
, cÚ¡ *
s
));

1372 
ZEXTERN
 * 
ZEXPORT
 
gzg‘s
 
OF
((
gzFe
 
fe
, *
buf
, 
Ën
));

1385 
ZEXTERN
 
ZEXPORT
 
gzputc
 
OF
((
gzFe
 
fe
, 
c
));

1391 
ZEXTERN
 
ZEXPORT
 
gzg‘c
 
OF
((
gzFe
 
fe
));

1400 
ZEXTERN
 
ZEXPORT
 
gzung‘c
 
OF
((
c
, 
gzFe
 
fe
));

1412 
ZEXTERN
 
ZEXPORT
 
gzæush
 
OF
((
gzFe
 
fe
, 
æush
));

1447 
ZEXTERN
 
ZEXPORT
 
gz»wšd
 
OF
((
gzFe
 
fe
));

1475 
ZEXTERN
 
ZEXPORT
 
gzeof
 
OF
((
gzFe
 
fe
));

1490 
ZEXTERN
 
ZEXPORT
 
gzdœeù
 
OF
((
gzFe
 
fe
));

1511 
ZEXTERN
 
ZEXPORT
 
gzşo£
 
OF
((
gzFe
 
fe
));

1524 
ZEXTERN
 
ZEXPORT
 
gzşo£_r
 
OF
((
gzFe
 
fe
));

1525 
ZEXTERN
 
ZEXPORT
 
gzşo£_w
 
OF
((
gzFe
 
fe
));

1536 
ZEXTERN
 cÚ¡ * 
ZEXPORT
 
gz”rÜ
 
OF
((
gzFe
 
fe
, *
”ºum
));

1552 
ZEXTERN
 
ZEXPORT
 
gzş—»¼
 
OF
((
gzFe
 
fe
));

1569 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
adËr32
 
OF
((uLÚg 
adËr
, cÚ¡ 
By‹f
 *
buf
, 
uIÁ
 
Ën
));

1600 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
üc32
 
OF
((uLÚg 
üc
, cÚ¡ 
By‹f
 *
buf
, 
uIÁ
 
Ën
));

1633 
ZEXTERN
 
ZEXPORT
 
deæ©eIn™_
 
OF
((
z_¡»amp
 
¡rm
, 
Ëv–
,

1634 cÚ¡ *
v”siÚ
, 
¡»am_size
));

1635 
ZEXTERN
 
ZEXPORT
 
šæ©eIn™_
 
OF
((
z_¡»amp
 
¡rm
,

1636 cÚ¡ *
v”siÚ
, 
¡»am_size
));

1637 
ZEXTERN
 
ZEXPORT
 
deæ©eIn™2_
 
OF
((
z_¡»amp
 
¡rm
, 
Ëv–
, 
m‘hod
,

1638 
wšdowB™s
, 
memLev–
,

1639 
¡¿‹gy
, cÚ¡ *
v”siÚ
,

1640 
¡»am_size
));

1641 
ZEXTERN
 
ZEXPORT
 
šæ©eIn™2_
 
OF
((
z_¡»amp
 
¡rm
, 
wšdowB™s
,

1642 cÚ¡ *
v”siÚ
, 
¡»am_size
));

1643 
ZEXTERN
 
ZEXPORT
 
šæ©eBackIn™_
 
OF
((
z_¡»amp
 
¡rm
, 
wšdowB™s
,

1644 
FAR
 *
wšdow
,

1645 cÚ¡ *
v”siÚ
,

1646 
¡»am_size
));

1647 
	#deæ©eIn™
(
¡rm
, 
Ëv–
) \

1648 
	`deæ©eIn™_
((
¡rm
), (
Ëv–
), 
ZLIB_VERSION
, ()(
z_¡»am
))

	)

1649 
	#šæ©eIn™
(
¡rm
) \

1650 
	`šæ©eIn™_
((
¡rm
), 
ZLIB_VERSION
, ()(
z_¡»am
))

	)

1651 
	#deæ©eIn™2
(
¡rm
, 
Ëv–
, 
m‘hod
, 
wšdowB™s
, 
memLev–
, 
¡¿‹gy
) \

1652 
	`deæ©eIn™2_
((
¡rm
),(
Ëv–
),(
m‘hod
),(
wšdowB™s
),(
memLev–
),\

1653 (
¡¿‹gy
), 
ZLIB_VERSION
, ()(
z_¡»am
))

	)

1654 
	#šæ©eIn™2
(
¡rm
, 
wšdowB™s
) \

1655 
	`šæ©eIn™2_
((
¡rm
), (
wšdowB™s
), 
ZLIB_VERSION
, \

1656 ()(
z_¡»am
))

	)

1657 
	#šæ©eBackIn™
(
¡rm
, 
wšdowB™s
, 
wšdow
) \

1658 
	`šæ©eBackIn™_
((
¡rm
), (
wšdowB™s
), (
wšdow
), \

1659 
ZLIB_VERSION
, ()(
z_¡»am
))

	)

1661 #iâdeà
Z_SOLO


1670 
	sgzFe_s
 {

1671 
have
;

1672 *
Ãxt
;

1673 
z_off64_t
 
pos
;

1675 
ZEXTERN
 
ZEXPORT
 
gzg‘c_
 
OF
((
gzFe
 
fe
));

1676 #ifdeà
Z_PREFIX_SET


1677 #undeà
z_gzg‘c


1678 
	#z_gzg‘c
(
g
) \

1679 ((
g
)->
have
 ? ((g)->have--, (g)->
pos
++, *((g)->
Ãxt
)++è: 
	`gzg‘c
(g))

	)

1681 
	#gzg‘c
(
g
) \

1682 ((
g
)->
have
 ? ((g)->have--, (g)->
pos
++, *((g)->
Ãxt
)++è: 
	`gzg‘c
(g))

	)

1691 #ifdeà
Z_LARGE64


1692 
ZEXTERN
 
gzFe
 
ZEXPORT
 
gzİ’64
 
OF
((const *, const *));

1693 
ZEXTERN
 
z_off64_t
 
ZEXPORT
 
gz£ek64
 
OF
((
gzFe
, z_off64_t, ));

1694 
ZEXTERN
 
z_off64_t
 
ZEXPORT
 
gz‹Î64
 
OF
((
gzFe
));

1695 
ZEXTERN
 
z_off64_t
 
ZEXPORT
 
gzoff£t64
 
OF
((
gzFe
));

1696 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
adËr32_combše64
 
OF
((uLÚg, uLÚg, 
z_off64_t
));

1697 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
üc32_combše64
 
OF
((uLÚg, uLÚg, 
z_off64_t
));

1700 #ià!
defšed
(
ZLIB_INTERNAL
è&& defšed(
Z_WANT64
)

1701 #ifdeà
Z_PREFIX_SET


1702 
	#z_gzİ’
 
z_gzİ’64


	)

1703 
	#z_gz£ek
 
z_gz£ek64


	)

1704 
	#z_gz‹Î
 
z_gz‹Î64


	)

1705 
	#z_gzoff£t
 
z_gzoff£t64


	)

1706 
	#z_adËr32_combše
 
z_adËr32_combše64


	)

1707 
	#z_üc32_combše
 
z_üc32_combše64


	)

1709 
	#gzİ’
 
gzİ’64


	)

1710 
	#gz£ek
 
gz£ek64


	)

1711 
	#gz‹Î
 
gz‹Î64


	)

1712 
	#gzoff£t
 
gzoff£t64


	)

1713 
	#adËr32_combše
 
adËr32_combše64


	)

1714 
	#üc32_combše
 
üc32_combše64


	)

1716 #iâdeà
Z_LARGE64


1717 
ZEXTERN
 
gzFe
 
ZEXPORT
 
gzİ’64
 
OF
((const *, const *));

1718 
ZEXTERN
 
z_off_t
 
ZEXPORT
 
gz£ek64
 
OF
((
gzFe
, z_off_t, ));

1719 
ZEXTERN
 
z_off_t
 
ZEXPORT
 
gz‹Î64
 
OF
((
gzFe
));

1720 
ZEXTERN
 
z_off_t
 
ZEXPORT
 
gzoff£t64
 
OF
((
gzFe
));

1721 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
adËr32_combše64
 
OF
((uLÚg, uLÚg, 
z_off_t
));

1722 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
üc32_combše64
 
OF
((uLÚg, uLÚg, 
z_off_t
));

1725 
ZEXTERN
 
gzFe
 
ZEXPORT
 
gzİ’
 
OF
((const *, const *));

1726 
ZEXTERN
 
z_off_t
 
ZEXPORT
 
gz£ek
 
OF
((
gzFe
, z_off_t, ));

1727 
ZEXTERN
 
z_off_t
 
ZEXPORT
 
gz‹Î
 
OF
((
gzFe
));

1728 
ZEXTERN
 
z_off_t
 
ZEXPORT
 
gzoff£t
 
OF
((
gzFe
));

1729 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
adËr32_combše
 
OF
((uLÚg, uLÚg, 
z_off_t
));

1730 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
üc32_combše
 
OF
((uLÚg, uLÚg, 
z_off_t
));

1735 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
adËr32_combše
 
OF
((uLÚg, uLÚg, 
z_off_t
));

1736 
ZEXTERN
 
uLÚg
 
ZEXPORT
 
üc32_combše
 
OF
((uLÚg, uLÚg, 
z_off_t
));

1741 #ià!
defšed
(
ZUTIL_H
è&& !defšed(
NO_DUMMY_DECL
)

1742 
	sš‹º®_¡©e
 {
dummy
;};

1746 
ZEXTERN
 cÚ¡ * 
ZEXPORT
 
zE¼Ü
 
OF
(());

1747 
ZEXTERN
 
ZEXPORT
 
šæ©eSyncPošt
 
OF
((
z_¡»amp
));

1748 
ZEXTERN
 cÚ¡ 
z_üc_t
 
FAR
 * 
ZEXPORT
 
g‘_üc_bË
 
OF
(());

1749 
ZEXTERN
 
ZEXPORT
 
šæ©eUnd”mše
 
OF
((
z_¡»amp
, ));

1750 
ZEXTERN
 
ZEXPORT
 
šæ©eRe£tK“p
 
OF
((
z_¡»amp
));

1751 
ZEXTERN
 
ZEXPORT
 
deæ©eRe£tK“p
 
OF
((
z_¡»amp
));

1752 #ià
defšed
(
_WIN32
è&& !defšed(
Z_SOLO
)

1753 
ZEXTERN
 
gzFe
 
ZEXPORT
 
gzİ’_w
 
OF
((cÚ¡ 
wch¬_t
 *
·th
,

1754 cÚ¡ *
mode
));

1756 #ià
defšed
(
STDC
è|| defšed(
Z_HAVE_STDARG_H
)

1757 #iâdeà
Z_SOLO


1758 
ZEXTERN
 
ZEXPORTVA
 
gzv´štf
 
Z_ARG
((
gzFe
 
fe
,

1759 cÚ¡ *
fÜm©
,

1760 
va_li¡
 
va
));

1764 #ifdeà
__ılu¥lus


	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

101 #undeà
__USE_ISOC11


102 #undeà
__USE_ISOC99


103 #undeà
__USE_ISOC95


104 #undeà
__USE_ISOCXX11


105 #undeà
__USE_POSIX


106 #undeà
__USE_POSIX2


107 #undeà
__USE_POSIX199309


108 #undeà
__USE_POSIX199506


109 #undeà
__USE_XOPEN


110 #undeà
__USE_XOPEN_EXTENDED


111 #undeà
__USE_UNIX98


112 #undeà
__USE_XOPEN2K


113 #undeà
__USE_XOPEN2KXSI


114 #undeà
__USE_XOPEN2K8


115 #undeà
__USE_XOPEN2K8XSI


116 #undeà
__USE_LARGEFILE


117 #undeà
__USE_LARGEFILE64


118 #undeà
__USE_FILE_OFFSET64


119 #undeà
__USE_BSD


120 #undeà
__USE_SVID


121 #undeà
__USE_MISC


122 #undeà
__USE_ATFILE


123 #undeà
__USE_GNU


124 #undeà
__USE_REENTRANT


125 #undeà
__USE_FORTIFY_LEVEL


126 #undeà
__KERNEL_STRICT_NAMES


130 #iâdeà
_LOOSE_KERNEL_NAMES


131 
	#__KERNEL_STRICT_NAMES


	)

141 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


142 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

143 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

145 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

150 #ifdeà
_GNU_SOURCE


151 #undeà
_ISOC95_SOURCE


152 
	#_ISOC95_SOURCE
 1

	)

153 #undeà
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #undeà
_ISOC11_SOURCE


156 
	#_ISOC11_SOURCE
 1

	)

157 #undeà
_POSIX_SOURCE


158 
	#_POSIX_SOURCE
 1

	)

159 #undeà
_POSIX_C_SOURCE


160 
	#_POSIX_C_SOURCE
 200809L

	)

161 #undeà
_XOPEN_SOURCE


162 
	#_XOPEN_SOURCE
 700

	)

163 #undeà
_XOPEN_SOURCE_EXTENDED


164 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

165 #undeà
_LARGEFILE64_SOURCE


166 
	#_LARGEFILE64_SOURCE
 1

	)

167 #undeà
_DEFAULT_SOURCE


168 
	#_DEFAULT_SOURCE
 1

	)

169 #undeà
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #undeà
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #undeà
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #ià(
defšed
 
_DEFAULT_SOURCE
 \

180 || (!
defšed
 
	g__STRICT_ANSI__
 \

181 && !
defšed
 
	g_ISOC99_SOURCE
 \

182 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

183 && !
defšed
 
	g_XOPEN_SOURCE
 \

184 && !
defšed
 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
))

185 #undeà
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

187 #undeà
_BSD_SOURCE


188 
	#_BSD_SOURCE
 1

	)

189 #undeà
_SVID_SOURCE


190 
	#_SVID_SOURCE
 1

	)

194 #ià(
defšed
 
_ISOC11_SOURCE
 \

195 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

196 
	#__USE_ISOC11
 1

	)

200 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

201 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

202 
	#__USE_ISOC99
 1

	)

206 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

207 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

208 
	#__USE_ISOC95
 1

	)

215 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

216 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

217 
	#__USE_ISOCXX11
 1

	)

223 #ifdeà
_DEFAULT_SOURCE


224 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


225 
	#__USE_POSIX_IMPLICITLY
 1

	)

227 #undeà
_POSIX_SOURCE


228 
	#_POSIX_SOURCE
 1

	)

229 #undeà
_POSIX_C_SOURCE


230 
	#_POSIX_C_SOURCE
 200809L

	)

232 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

233 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

234 
	#_POSIX_SOURCE
 1

	)

235 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

236 
	#_POSIX_C_SOURCE
 2

	)

237 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

238 
	#_POSIX_C_SOURCE
 199506L

	)

239 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

240 
	#_POSIX_C_SOURCE
 200112L

	)

242 
	#_POSIX_C_SOURCE
 200809L

	)

244 
	#__USE_POSIX_IMPLICITLY
 1

	)

247 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


248 
	#__USE_POSIX
 1

	)

251 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


252 
	#__USE_POSIX2
 1

	)

255 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

256 
	#__USE_POSIX199309
 1

	)

259 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

260 
	#__USE_POSIX199506
 1

	)

263 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

264 
	#__USE_XOPEN2K
 1

	)

265 #undeà
__USE_ISOC95


266 
	#__USE_ISOC95
 1

	)

267 #undeà
__USE_ISOC99


268 
	#__USE_ISOC99
 1

	)

271 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

272 
	#__USE_XOPEN2K8
 1

	)

273 #undeà
_ATFILE_SOURCE


274 
	#_ATFILE_SOURCE
 1

	)

277 #ifdef 
_XOPEN_SOURCE


278 
	#__USE_XOPEN
 1

	)

279 #ià(
_XOPEN_SOURCE
 - 0) >= 500

280 
	#__USE_XOPEN_EXTENDED
 1

	)

281 
	#__USE_UNIX98
 1

	)

282 #undeà
_LARGEFILE_SOURCE


283 
	#_LARGEFILE_SOURCE
 1

	)

284 #ià(
_XOPEN_SOURCE
 - 0) >= 600

285 #ià(
_XOPEN_SOURCE
 - 0) >= 700

286 
	#__USE_XOPEN2K8
 1

	)

287 
	#__USE_XOPEN2K8XSI
 1

	)

289 
	#__USE_XOPEN2K
 1

	)

290 
	#__USE_XOPEN2KXSI
 1

	)

291 #undeà
__USE_ISOC95


292 
	#__USE_ISOC95
 1

	)

293 #undeà
__USE_ISOC99


294 
	#__USE_ISOC99
 1

	)

297 #ifdeà
_XOPEN_SOURCE_EXTENDED


298 
	#__USE_XOPEN_EXTENDED
 1

	)

303 #ifdeà
_LARGEFILE_SOURCE


304 
	#__USE_LARGEFILE
 1

	)

307 #ifdeà
_LARGEFILE64_SOURCE


308 
	#__USE_LARGEFILE64
 1

	)

311 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

312 
	#__USE_FILE_OFFSET64
 1

	)

315 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


316 
	#__USE_MISC
 1

	)

319 #ifdef 
_BSD_SOURCE


320 
	#__USE_BSD
 1

	)

323 #ifdef 
_SVID_SOURCE


324 
	#__USE_SVID
 1

	)

327 #ifdef 
_ATFILE_SOURCE


328 
	#__USE_ATFILE
 1

	)

331 #ifdef 
_GNU_SOURCE


332 
	#__USE_GNU
 1

	)

335 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


336 
	#__USE_REENTRANT
 1

	)

339 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

340 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

341 #ià
_FORTIFY_SOURCE
 > 1

342 
	#__USE_FORTIFY_LEVEL
 2

	)

344 
	#__USE_FORTIFY_LEVEL
 1

	)

347 
	#__USE_FORTIFY_LEVEL
 0

	)

352 
	~<¡dc-´edef.h
>

360 #undeà
__GNU_LIBRARY__


361 
	#__GNU_LIBRARY__
 6

	)

365 
	#__GLIBC__
 2

	)

366 
	#__GLIBC_MINOR__
 19

	)

368 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

369 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

372 #iâdeà
__ASSEMBLER__


373 #iâdeà
_SYS_CDEFS_H


374 
	~<sys/cdefs.h
>

379 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


380 
	#__USE_LARGEFILE
 1

	)

381 
	#__USE_LARGEFILE64
 1

	)

387 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

388 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

389 && 
defšed
 
	g__ex‹º_šlše


390 
	#__USE_EXTERN_INLINES
 1

	)

398 
	~<gnu/¡ubs.h
>

	@/usr/include/getopt.h

19 #iâdeà
_GETOPT_H


21 #iâdeà
__Ãed_g‘İt


22 
	#_GETOPT_H
 1

	)

32 #ià!
defšed
 
__GNU_LIBRARY__


33 
	~<ùy³.h
>

36 #iâdeà
__THROW


37 #iâdeà
__GNUC_PREREQ


38 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

40 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

41 
	#__THROW
 
	`throw
 ()

	)

43 
	#__THROW


	)

47 #ifdef 
__ılu¥lus


57 *
İrg
;

71 
İtšd
;

76 
İ‹¼
;

80 
İtİt
;

82 #iâdeà
__Ãed_g‘İt


104 
	sİtiÚ


106 cÚ¡ *
	gÇme
;

109 
	ghas_¬g
;

110 *
	gæag
;

111 
	gv®
;

116 
	#no_¬gum’t
 0

	)

117 
	#»quœed_¬gum’t
 1

	)

118 
	#İtiÚ®_¬gum’t
 2

	)

146 #ifdeà
__GNU_LIBRARY__


150 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

151 
__THROW
;

153 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

154 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


158 #ifdeà
__REDIRECT


159 
__REDIRECT_NTH
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

160 cÚ¡ *
__shÜtİts
),

161 
__posix_g‘İt
);

163 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

164 cÚ¡ *
__shÜtİts
è
__THROW
;

165 
	#g‘İt
 
__posix_g‘İt


	)

169 
g‘İt
 ();

172 #iâdeà
__Ãed_g‘İt


173 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

174 cÚ¡ *
__shÜtİts
,

175 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

176 
__THROW
;

177 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

178 cÚ¡ *
__shÜtİts
,

179 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

180 
__THROW
;

184 #ifdef 
__ılu¥lus


189 #undeà
__Ãed_g‘İt


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/wch¬.h
>

27 
	~<b™s/wÜdsize.h
>

34 #iâdeà
__št8_t_defšed


35 
	#__št8_t_defšed


	)

36 sigÃd 
	tšt8_t
;

37 
	tšt16_t
;

38 
	tšt32_t
;

39 #ià
__WORDSIZE
 == 64

40 
	tšt64_t
;

42 
__ex‹nsiÚ__


43 
	tšt64_t
;

48 
	tušt8_t
;

49 
	tušt16_t
;

50 #iâdeà
__ušt32_t_defšed


51 
	tušt32_t
;

52 
	#__ušt32_t_defšed


	)

54 #ià
__WORDSIZE
 == 64

55 
	tušt64_t
;

57 
__ex‹nsiÚ__


58 
	tušt64_t
;

65 sigÃd 
	tšt_Ëa¡8_t
;

66 
	tšt_Ëa¡16_t
;

67 
	tšt_Ëa¡32_t
;

68 #ià
__WORDSIZE
 == 64

69 
	tšt_Ëa¡64_t
;

71 
__ex‹nsiÚ__


72 
	tšt_Ëa¡64_t
;

76 
	tušt_Ëa¡8_t
;

77 
	tušt_Ëa¡16_t
;

78 
	tušt_Ëa¡32_t
;

79 #ià
__WORDSIZE
 == 64

80 
	tušt_Ëa¡64_t
;

82 
__ex‹nsiÚ__


83 
	tušt_Ëa¡64_t
;

90 sigÃd 
	tšt_ç¡8_t
;

91 #ià
__WORDSIZE
 == 64

92 
	tšt_ç¡16_t
;

93 
	tšt_ç¡32_t
;

94 
	tšt_ç¡64_t
;

96 
	tšt_ç¡16_t
;

97 
	tšt_ç¡32_t
;

98 
__ex‹nsiÚ__


99 
	tšt_ç¡64_t
;

103 
	tušt_ç¡8_t
;

104 #ià
__WORDSIZE
 == 64

105 
	tušt_ç¡16_t
;

106 
	tušt_ç¡32_t
;

107 
	tušt_ç¡64_t
;

109 
	tušt_ç¡16_t
;

110 
	tušt_ç¡32_t
;

111 
__ex‹nsiÚ__


112 
	tušt_ç¡64_t
;

117 #ià
__WORDSIZE
 == 64

118 #iâdeà
__šŒ_t_defšed


119 
	tšŒ_t
;

120 
	#__šŒ_t_defšed


	)

122 
	tušŒ_t
;

124 #iâdeà
__šŒ_t_defšed


125 
	tšŒ_t
;

126 
	#__šŒ_t_defšed


	)

128 
	tušŒ_t
;

133 #ià
__WORDSIZE
 == 64

134 
	tštmax_t
;

135 
	tuštmax_t
;

137 
__ex‹nsiÚ__


138 
	tštmax_t
;

139 
__ex‹nsiÚ__


140 
	tuštmax_t
;

144 #ià
__WORDSIZE
 == 64

145 
	#__INT64_C
(
c
èø## 
L


	)

146 
	#__UINT64_C
(
c
èø## 
UL


	)

148 
	#__INT64_C
(
c
èø## 
LL


	)

149 
	#__UINT64_C
(
c
èø## 
ULL


	)

155 
	#INT8_MIN
 (-128)

	)

156 
	#INT16_MIN
 (-32767-1)

	)

157 
	#INT32_MIN
 (-2147483647-1)

	)

158 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

160 
	#INT8_MAX
 (127)

	)

161 
	#INT16_MAX
 (32767)

	)

162 
	#INT32_MAX
 (2147483647)

	)

163 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

166 
	#UINT8_MAX
 (255)

	)

167 
	#UINT16_MAX
 (65535)

	)

168 
	#UINT32_MAX
 (4294967295U)

	)

169 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

173 
	#INT_LEAST8_MIN
 (-128)

	)

174 
	#INT_LEAST16_MIN
 (-32767-1)

	)

175 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

176 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

178 
	#INT_LEAST8_MAX
 (127)

	)

179 
	#INT_LEAST16_MAX
 (32767)

	)

180 
	#INT_LEAST32_MAX
 (2147483647)

	)

181 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

184 
	#UINT_LEAST8_MAX
 (255)

	)

185 
	#UINT_LEAST16_MAX
 (65535)

	)

186 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

187 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

191 
	#INT_FAST8_MIN
 (-128)

	)

192 #ià
__WORDSIZE
 == 64

193 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

194 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

196 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

197 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

199 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

201 
	#INT_FAST8_MAX
 (127)

	)

202 #ià
__WORDSIZE
 == 64

203 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

204 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

206 
	#INT_FAST16_MAX
 (2147483647)

	)

207 
	#INT_FAST32_MAX
 (2147483647)

	)

209 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINT_FAST8_MAX
 (255)

	)

213 #ià
__WORDSIZE
 == 64

214 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

215 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

217 
	#UINT_FAST16_MAX
 (4294967295U)

	)

218 
	#UINT_FAST32_MAX
 (4294967295U)

	)

220 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

224 #ià
__WORDSIZE
 == 64

225 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

226 
	#INTPTR_MAX
 (9223372036854775807L)

	)

227 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

229 
	#INTPTR_MIN
 (-2147483647-1)

	)

230 
	#INTPTR_MAX
 (2147483647)

	)

231 
	#UINTPTR_MAX
 (4294967295U)

	)

236 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

238 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

241 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

247 #ià
__WORDSIZE
 == 64

248 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

249 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

251 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

252 
	#PTRDIFF_MAX
 (2147483647)

	)

256 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

257 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

260 #ià
__WORDSIZE
 == 64

261 
	#SIZE_MAX
 (18446744073709551615UL)

	)

263 
	#SIZE_MAX
 (4294967295U)

	)

267 #iâdeà
WCHAR_MIN


269 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

270 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

274 
	#WINT_MIN
 (0u)

	)

275 
	#WINT_MAX
 (4294967295u)

	)

278 
	#INT8_C
(
c
è
	)
c

279 
	#INT16_C
(
c
è
	)
c

280 
	#INT32_C
(
c
è
	)
c

281 #ià
__WORDSIZE
 == 64

282 
	#INT64_C
(
c
èø## 
L


	)

284 
	#INT64_C
(
c
èø## 
LL


	)

288 
	#UINT8_C
(
c
è
	)
c

289 
	#UINT16_C
(
c
è
	)
c

290 
	#UINT32_C
(
c
èø## 
U


	)

291 #ià
__WORDSIZE
 == 64

292 
	#UINT64_C
(
c
èø## 
UL


	)

294 
	#UINT64_C
(
c
èø## 
ULL


	)

298 #ià
__WORDSIZE
 == 64

299 
	#INTMAX_C
(
c
èø## 
L


	)

300 
	#UINTMAX_C
(
c
èø## 
UL


	)

302 
	#INTMAX_C
(
c
èø## 
LL


	)

303 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/time.h

22 #iâdef 
_TIME_H


24 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

25 ! 
defšed
 
	g__Ãed_time¥ec
)

26 
	#_TIME_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


33 #ifdef 
_TIME_H


35 
	#__Ãed_size_t


	)

36 
	#__Ãed_NULL


	)

37 
	~<¡ddef.h
>

41 
	~<b™s/time.h
>

44 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


45 #iâdeà
CLK_TCK


46 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

52 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

53 
	#__şock_t_defšed
 1

	)

55 
	~<b™s/ty³s.h
>

57 
__BEGIN_NAMESPACE_STD


59 
__şock_t
 
	tşock_t
;

60 
	g__END_NAMESPACE_STD


61 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


62 
	$__USING_NAMESPACE_STD
(
şock_t
)

66 #undeà
__Ãed_şock_t


68 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

69 
	#__time_t_defšed
 1

	)

71 
	~<b™s/ty³s.h
>

73 
__BEGIN_NAMESPACE_STD


75 
__time_t
 
	ttime_t
;

76 
__END_NAMESPACE_STD


77 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC
 || defšed 
__USE_SVID


78 
	$__USING_NAMESPACE_STD
(
time_t
)

82 #undeà
__Ãed_time_t


84 #ià!
defšed
 
__şockid_t_defšed
 && \

85 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

86 
	#__şockid_t_defšed
 1

	)

88 
	~<b™s/ty³s.h
>

91 
__şockid_t
 
	tşockid_t
;

94 #undeà
__şockid_time_t


96 #ià!
defšed
 
__tim”_t_defšed
 && \

97 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

98 
	#__tim”_t_defšed
 1

	)

100 
	~<b™s/ty³s.h
>

103 
__tim”_t
 
	ttim”_t
;

106 #undeà
__Ãed_tim”_t


109 #ià(!
defšed
 
__time¥ec_defšed
 \

110 && ((
defšed
 
_TIME_H
 \

111 && (
defšed
 
__USE_POSIX199309
 || defšed 
__USE_MISC
 \

112 || 
defšed
 
__USE_ISOC11
)) \

113 || 
defšed
 
__Ãed_time¥ec
))

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
__sysÿÎ_¦Úg_t
 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_BSD


146 
tm_gmtoff
;

147 cÚ¡ *
tm_zÚe
;

149 
__tm_gmtoff
;

150 cÚ¡ *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 #ifdeà
__USE_ISOC11


182 
	#TIME_UTC
 1

	)

186 
__BEGIN_NAMESPACE_STD


189 
şock_t
 
	$şock
 (è
__THROW
;

192 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

195 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

196 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

199 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

205 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

206 cÚ¡ *
__»¡riù
 
__fÜm©
,

207 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

208 
__END_NAMESPACE_STD


210 #ifdeà
__USE_XOPEN


213 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

214 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

215 
__THROW
;

218 #ifdeà
__USE_XOPEN2K8


221 
	~<xloÿË.h
>

223 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

224 cÚ¡ *
__»¡riù
 
__fÜm©
,

225 cÚ¡ 
tm
 *
__»¡riù
 
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

229 #ifdeà
__USE_GNU


230 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

231 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

232 
__loÿË_t
 
__loc
è
__THROW
;

236 
__BEGIN_NAMESPACE_STD


239 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

243 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

244 
__END_NAMESPACE_STD


246 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


249 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

250 
tm
 *
__»¡riù
 
__
è
__THROW
;

254 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

255 
tm
 *
__»¡riù
 
__
è
__THROW
;

258 
__BEGIN_NAMESPACE_STD


261 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

264 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

265 
__END_NAMESPACE_STD


267 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


272 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

273 *
__»¡riù
 
__buf
è
__THROW
;

276 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

277 *
__»¡riù
 
__buf
è
__THROW
;

282 *
__tzÇme
[2];

283 
__daylight
;

284 
__timezÚe
;

287 #ifdef 
__USE_POSIX


289 *
tzÇme
[2];

293 
	$tz£t
 (è
__THROW
;

296 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


297 
daylight
;

298 
timezÚe
;

301 #ifdeà
__USE_SVID


304 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

310 
	#__i¦—p
(
y—r
) \

311 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

314 #ifdeà
__USE_MISC


319 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

322 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

325 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

329 #ifdeà
__USE_POSIX199309


334 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

335 
time¥ec
 *
__»maššg
);

339 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

342 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

345 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

346 
__THROW
;

348 #ifdeà
__USE_XOPEN2K


353 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

354 cÚ¡ 
time¥ec
 *
__»q
,

355 
time¥ec
 *
__»m
);

358 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

363 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

364 
sigev’t
 *
__»¡riù
 
__evp
,

365 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

368 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

371 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

372 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

373 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

376 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

377 
__THROW
;

380 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

384 #ifdeà
__USE_ISOC11


386 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

387 
__THROW
 
	`__nÚnuÎ
 ((1));

391 #ifdeà
__USE_XOPEN_EXTENDED


403 
g‘d©e_”r
;

412 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

415 #ifdeà
__USE_GNU


426 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

427 
tm
 *
__»¡riù
 
__»sbuå
);

430 
__END_DECLS


	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

104 
__BEGIN_NAMESPACE_STD


110 
__exùy³
 (
i§Êum
);

111 
__exùy³
 (
i§Íha
);

112 
__exùy³
 (
isúŒl
);

113 
__exùy³
 (
isdig™
);

114 
__exùy³
 (
i¦ow”
);

115 
__exùy³
 (
isg¿ph
);

116 
__exùy³
 (
i¥ršt
);

117 
__exùy³
 (
i¥unù
);

118 
__exùy³
 (
is¥aû
);

119 
__exùy³
 (
isuµ”
);

120 
__exùy³
 (
isxdig™
);

124 
	$tŞow”
 (
__c
è
__THROW
;

127 
	$touµ”
 (
__c
è
__THROW
;

129 
__END_NAMESPACE_STD


133 #ifdef 
__USE_ISOC99


134 
__BEGIN_NAMESPACE_C99


136 
	`__exùy³
 (
isbÏnk
);

138 
__END_NAMESPACE_C99


141 #ifdeà
__USE_GNU


143 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

146 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


150 
	$i§scii
 (
__c
è
__THROW
;

154 
	$tßscii
 (
__c
è
__THROW
;

158 
	`__exùy³
 (
_touµ”
);

159 
	`__exùy³
 (
_tŞow”
);

163 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

164 (
__ex‹nsiÚ__
 \

165 ({ 
__»s
; \

166 ià( (
c
) > 1) \

168 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

170 
__c
 = (
c
); \

171 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

174 
__»s
 = 
f
 
¬gs
; \

177 
__»s
 = (
a
)[(è(
c
)]; \

178 
__»s
; 
	}
}))

	)

180 #ià!
defšed
 
__NO_CTYPE


181 #ifdeà
__isùy³_f


182 
	$__isùy³_f
 (
®num
)

183 
	$__isùy³_f
 (
®pha
)

184 
	$__isùy³_f
 (
úŒl
)

185 
	$__isùy³_f
 (
dig™
)

186 
	$__isùy³_f
 (
low”
)

187 
	$__isùy³_f
 (
g¿ph
)

188 
	$__isùy³_f
 (
´št
)

189 
	$__isùy³_f
 (
punù
)

190 
	$__isùy³_f
 (
¥aû
)

191 
	$__isùy³_f
 (
uµ”
)

192 
	$__isùy³_f
 (
xdig™
)

193 #ifdeà
__USE_ISOC99


194 
	$__isùy³_f
 (
bÏnk
)

196 #–ià
defšed
 
__isùy³


197 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

198 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

199 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

200 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

201 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

202 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

203 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

204 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

205 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

206 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

207 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

208 #ifdeà
__USE_ISOC99


209 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

213 #ifdeà
__USE_EXTERN_INLINES


214 
__ex‹º_šlše
 

215 
	`__NTH
 (
	$tŞow”
 (
__c
))

217  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

218 
	}
}

220 
__ex‹º_šlše
 

221 
__NTH
 (
	$touµ”
 (
__c
))

223  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

224 
	}
}

227 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


228 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

229 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

232 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


233 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

234 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

236 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

237 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

243 #ifdeà
__USE_XOPEN2K8


257 
	~<xloÿË.h
>

261 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

262 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

264 
	#__exùy³_l
(
Çme
) \

265 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

271 
__exùy³_l
 (
i§Êum_l
);

272 
__exùy³_l
 (
i§Íha_l
);

273 
__exùy³_l
 (
isúŒl_l
);

274 
__exùy³_l
 (
isdig™_l
);

275 
__exùy³_l
 (
i¦ow”_l
);

276 
__exùy³_l
 (
isg¿ph_l
);

277 
__exùy³_l
 (
i¥ršt_l
);

278 
__exùy³_l
 (
i¥unù_l
);

279 
__exùy³_l
 (
is¥aû_l
);

280 
__exùy³_l
 (
isuµ”_l
);

281 
__exùy³_l
 (
isxdig™_l
);

283 
__exùy³_l
 (
isbÏnk_l
);

287 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

288 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

291 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

292 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

294 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


295 
	#__tŞow”_l
(
c
, 
loÿË
) \

296 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

297 
	#__touµ”_l
(
c
, 
loÿË
) \

298 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

299 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

300 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

304 #iâdeà
__NO_CTYPE


305 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

306 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

307 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

308 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

309 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

310 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

311 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

312 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

313 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

314 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

315 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

317 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

319 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


320 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

321 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

324 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

325 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

326 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

327 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

328 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

329 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

330 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

331 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

332 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

333 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

334 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

336 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

338 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


339 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

340 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

347 
__END_DECLS


	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

54 
	#__STDC_ISO_10646__
 201103L

	)

57 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tŞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_BSD


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_BSD
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

62 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


63 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

64 
	#htŞe16
(
x
è(x)

	)

65 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

66 
	#Ë16toh
(
x
è(x)

	)

68 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

69 
	#htŞe32
(
x
è(x)

	)

70 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

71 
	#Ë32toh
(
x
è(x)

	)

73 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

74 
	#htŞe64
(
x
è(x)

	)

75 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

76 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@
1
.
1
/usr/include
277
7286
abstract_mem.cc
abstract_mem.hh
addr_mapper.cc
addr_mapper.hh
bridge.cc
bridge.hh
cache/base.cc
cache/base.hh
cache/blk.cc
cache/blk.hh
cache/cache.cc
cache/cache.hh
cache/mshr.cc
cache/mshr.hh
cache/mshr_queue.cc
cache/mshr_queue.hh
cache/prefetch/base.cc
cache/prefetch/base.hh
cache/prefetch/queued.cc
cache/prefetch/queued.hh
cache/prefetch/stride.cc
cache/prefetch/stride.hh
cache/prefetch/tagged.cc
cache/prefetch/tagged.hh
cache/queue.hh
cache/queue_entry.hh
cache/tags/base.cc
cache/tags/base.hh
cache/tags/base_set_assoc.cc
cache/tags/base_set_assoc.hh
cache/tags/cacheset.hh
cache/tags/fa_lru.cc
cache/tags/fa_lru.hh
cache/tags/lru.cc
cache/tags/lru.hh
cache/tags/random_repl.cc
cache/tags/random_repl.hh
cache/write_queue.cc
cache/write_queue.hh
cache/write_queue_entry.cc
cache/write_queue_entry.hh
coherent_xbar.cc
coherent_xbar.hh
comm_monitor.cc
comm_monitor.hh
dram_ctrl.cc
dram_ctrl.hh
drampower.cc
drampower.hh
dramsim2.cc
dramsim2.hh
dramsim2_wrapper.cc
dramsim2_wrapper.hh
external_master.cc
external_master.hh
external_slave.cc
external_slave.hh
fs_translating_port_proxy.cc
fs_translating_port_proxy.hh
hmc_controller.cc
hmc_controller.hh
mem_checker.cc
mem_checker.hh
mem_checker_monitor.cc
mem_checker_monitor.hh
mem_object.cc
mem_object.hh
mport.cc
mport.hh
multi_level_page_table.cc
multi_level_page_table.hh
multi_level_page_table_impl.hh
noncoherent_xbar.cc
noncoherent_xbar.hh
packet.cc
packet.hh
packet_access.hh
packet_queue.cc
packet_queue.hh
page_table.cc
page_table.hh
physical.cc
physical.hh
port.cc
port.hh
port_proxy.cc
port_proxy.hh
probes/base.cc
probes/base.hh
probes/mem_trace.cc
probes/mem_trace.hh
probes/stack_dist.cc
probes/stack_dist.hh
qport.hh
request.hh
ruby/common/Address.cc
ruby/common/Address.hh
ruby/common/BoolVec.cc
ruby/common/BoolVec.hh
ruby/common/Consumer.cc
ruby/common/Consumer.hh
ruby/common/DataBlock.cc
ruby/common/DataBlock.hh
ruby/common/Histogram.cc
ruby/common/Histogram.hh
ruby/common/IntVec.cc
ruby/common/IntVec.hh
ruby/common/MachineID.hh
ruby/common/NetDest.cc
ruby/common/NetDest.hh
ruby/common/Set.hh
ruby/common/SubBlock.cc
ruby/common/SubBlock.hh
ruby/common/TypeDefines.hh
ruby/common/WriteMask.cc
ruby/common/WriteMask.hh
ruby/filters/AbstractBloomFilter.hh
ruby/filters/BlockBloomFilter.cc
ruby/filters/BlockBloomFilter.hh
ruby/filters/BulkBloomFilter.cc
ruby/filters/BulkBloomFilter.hh
ruby/filters/H3BloomFilter.cc
ruby/filters/H3BloomFilter.hh
ruby/filters/LSB_CountingBloomFilter.cc
ruby/filters/LSB_CountingBloomFilter.hh
ruby/filters/MultiBitSelBloomFilter.cc
ruby/filters/MultiBitSelBloomFilter.hh
ruby/filters/MultiGrainBloomFilter.cc
ruby/filters/MultiGrainBloomFilter.hh
ruby/filters/NonCountingBloomFilter.cc
ruby/filters/NonCountingBloomFilter.hh
ruby/network/BasicLink.cc
ruby/network/BasicLink.hh
ruby/network/BasicRouter.cc
ruby/network/BasicRouter.hh
ruby/network/MessageBuffer.cc
ruby/network/MessageBuffer.hh
ruby/network/Network.cc
ruby/network/Network.hh
ruby/network/Topology.cc
ruby/network/Topology.hh
ruby/network/fault_model/FaultModel.cc
ruby/network/fault_model/FaultModel.hh
ruby/network/garnet2.0/CommonTypes.hh
ruby/network/garnet2.0/Credit.cc
ruby/network/garnet2.0/Credit.hh
ruby/network/garnet2.0/CreditLink.hh
ruby/network/garnet2.0/CrossbarSwitch.cc
ruby/network/garnet2.0/CrossbarSwitch.hh
ruby/network/garnet2.0/GarnetLink.cc
ruby/network/garnet2.0/GarnetLink.hh
ruby/network/garnet2.0/GarnetNetwork.cc
ruby/network/garnet2.0/GarnetNetwork.hh
ruby/network/garnet2.0/InputUnit.cc
ruby/network/garnet2.0/InputUnit.hh
ruby/network/garnet2.0/NetworkInterface.cc
ruby/network/garnet2.0/NetworkInterface.hh
ruby/network/garnet2.0/NetworkLink.cc
ruby/network/garnet2.0/NetworkLink.hh
ruby/network/garnet2.0/OutVcState.cc
ruby/network/garnet2.0/OutVcState.hh
ruby/network/garnet2.0/OutputUnit.cc
ruby/network/garnet2.0/OutputUnit.hh
ruby/network/garnet2.0/Router.cc
ruby/network/garnet2.0/Router.hh
ruby/network/garnet2.0/RoutingUnit.cc
ruby/network/garnet2.0/RoutingUnit.hh
ruby/network/garnet2.0/SwitchAllocator.cc
ruby/network/garnet2.0/SwitchAllocator.hh
ruby/network/garnet2.0/VirtualChannel.cc
ruby/network/garnet2.0/VirtualChannel.hh
ruby/network/garnet2.0/flit.cc
ruby/network/garnet2.0/flit.hh
ruby/network/garnet2.0/flitBuffer.cc
ruby/network/garnet2.0/flitBuffer.hh
ruby/network/simple/PerfectSwitch.cc
ruby/network/simple/PerfectSwitch.hh
ruby/network/simple/SimpleLink.cc
ruby/network/simple/SimpleLink.hh
ruby/network/simple/SimpleNetwork.cc
ruby/network/simple/SimpleNetwork.hh
ruby/network/simple/Switch.cc
ruby/network/simple/Switch.hh
ruby/network/simple/Throttle.cc
ruby/network/simple/Throttle.hh
ruby/profiler/AccessTraceForAddress.cc
ruby/profiler/AccessTraceForAddress.hh
ruby/profiler/AddressProfiler.cc
ruby/profiler/AddressProfiler.hh
ruby/profiler/MemCntrlProfiler.cc
ruby/profiler/MemCntrlProfiler.hh
ruby/profiler/Profiler.cc
ruby/profiler/Profiler.hh
ruby/profiler/StoreTrace.cc
ruby/profiler/StoreTrace.hh
ruby/slicc_interface/AbstractCacheEntry.cc
ruby/slicc_interface/AbstractCacheEntry.hh
ruby/slicc_interface/AbstractController.cc
ruby/slicc_interface/AbstractController.hh
ruby/slicc_interface/AbstractEntry.cc
ruby/slicc_interface/AbstractEntry.hh
ruby/slicc_interface/Message.hh
ruby/slicc_interface/RubyRequest.cc
ruby/slicc_interface/RubyRequest.hh
ruby/slicc_interface/RubySlicc_ComponentMapping.hh
ruby/slicc_interface/RubySlicc_Util.hh
ruby/slicc_interface/RubySlicc_includes.hh
ruby/structures/AbstractReplacementPolicy.cc
ruby/structures/AbstractReplacementPolicy.hh
ruby/structures/BankedArray.cc
ruby/structures/BankedArray.hh
ruby/structures/CacheMemory.cc
ruby/structures/CacheMemory.hh
ruby/structures/DirectoryMemory.cc
ruby/structures/DirectoryMemory.hh
ruby/structures/LRUPolicy.cc
ruby/structures/LRUPolicy.hh
ruby/structures/MemoryNode.cc
ruby/structures/MemoryNode.hh
ruby/structures/PerfectCacheMemory.hh
ruby/structures/PersistentTable.cc
ruby/structures/PersistentTable.hh
ruby/structures/Prefetcher.cc
ruby/structures/Prefetcher.hh
ruby/structures/PseudoLRUPolicy.cc
ruby/structures/PseudoLRUPolicy.hh
ruby/structures/RubyMemoryControl.cc
ruby/structures/RubyMemoryControl.hh
ruby/structures/TBETable.hh
ruby/structures/TimerTable.cc
ruby/structures/TimerTable.hh
ruby/structures/WireBuffer.cc
ruby/structures/WireBuffer.hh
ruby/system/CacheRecorder.cc
ruby/system/CacheRecorder.hh
ruby/system/DMASequencer.cc
ruby/system/DMASequencer.hh
ruby/system/GPUCoalescer.cc
ruby/system/GPUCoalescer.hh
ruby/system/RubyPort.cc
ruby/system/RubyPort.hh
ruby/system/RubyPortProxy.cc
ruby/system/RubyPortProxy.hh
ruby/system/RubySystem.cc
ruby/system/RubySystem.hh
ruby/system/Sequencer.cc
ruby/system/Sequencer.hh
ruby/system/VIPERCoalescer.cc
ruby/system/VIPERCoalescer.hh
ruby/system/WeightedLRUPolicy.cc
ruby/system/WeightedLRUPolicy.hh
se_translating_port_proxy.cc
se_translating_port_proxy.hh
serial_link.cc
serial_link.hh
simple_mem.cc
simple_mem.hh
snoop_filter.cc
snoop_filter.hh
stack_dist_calc.cc
stack_dist_calc.hh
tport.cc
tport.hh
xbar.cc
xbar.hh
/usr/include/fcntl.h
/usr/include/inttypes.h
/usr/include/unistd.h
/usr/include/zlib.h
/usr/include/features.h
/usr/include/getopt.h
/usr/include/stdint.h
/usr/include/time.h
/usr/include/ctype.h
/usr/include/stdc-predef.h
/usr/include/xlocale.h
/usr/include/endian.h
